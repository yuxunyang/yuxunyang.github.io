<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>分类: 后端开发 - 遇寻笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="遇寻笔记"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="遇寻笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:type" content="website"><meta property="og:title" content="遇寻笔记"><meta property="og:url" content="https://eucham.me/"><meta property="og:site_name" content="遇寻笔记"><meta property="og:description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/img/og_image.png"><meta property="article:author" content="遇寻"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://eucham.me/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me"},"headline":"遇寻笔记","image":["https://eucham.me/img/og_image.png"],"author":{"@type":"Person","name":"遇寻"},"publisher":{"@type":"Organization","name":"遇寻笔记","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"No. I&#39;ll bring me back a souvenir."}</script><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">分类</a></li><li class="is-active"><a href="#" aria-current="page">后端开发</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-26T02:00:51.000Z" title="3/26/2019, 10:00:51 AM">2019-03-26</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:01.990Z" title="2/9/2021, 11:03:01 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">8 分钟读完 (大约1180个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/26/945fdb518121.html">解决使用MyBatis处理含有$的变量时报IllegalArgumentException Illegal group reference</a></p><div class="content"><h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>在一个GET请求中，输入参数包含$符号，然后后台报错。</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl &#x27;http://localhost:9999/xxxx/drivers?page=1&amp;size=20&amp;realname=$&#x27; \</span><br><span class="line">-H &#x27;Accept-Encoding: gzip, deflate&#x27; \</span><br><span class="line">-H &#x27;Accept-Language: zh,en;q=0.9,ja;q=0.8,zh-TW;q=0.7,fr;q=0.6,zh-CN;q=0.5&#x27; \</span><br><span class="line">-H &#x27;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.75 Safari/537.36&#x27; \</span><br><span class="line">-H &#x27;Accept: application/json, text/plain, */*&#x27; \</span><br><span class="line">-H &#x27;userId: 453&#x27; \</span><br><span class="line">-H &#x27;Connection: keep-alive&#x27; \</span><br><span class="line">-H &#x27;token: 1e6966ec2fafdbbd53ef53124cc3e5ae&#x27; \</span><br><span class="line">--compressed</span><br></pre></td></tr></table></figure>

<h2 id="报错截图"><a href="#报错截图" class="headerlink" title="报错截图"></a>报错截图</h2><p><img src="/images/pics/820618bc0b05edc0c53b018552fd191f.png" alt="在这里插入图片描述"></p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>这个现象与mybatis无关，因为mybatis对$符号的操作主要集中在<code>GenericTokenParser.java</code>中，而这些操作都是以<code>\$&#123;</code>出现，因此可以认为mybatis不处理单独的<code>$</code>符号。如下：<br><img src="/images/pics/0f729d0c03b4812345637b862b991a4b.png" alt="在这里插入图片描述"><br>在interceptor中，有一段打印将要执行的sql语句相关信息，根据调试结果，锁定了这个方法出问题所在，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, getParameterValue(obj));</span><br></pre></td></tr></table></figure>

<p>因此问题转化成了下面的问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有问题的语句</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;er WHERE realname like ? AND deleted = ?&quot;</span>;</span><br><span class="line">sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, <span class="string">&quot;\\%$%&quot;</span>);</span><br><span class="line">System.out.println(sql);</span><br><span class="line"><span class="comment">// 修改</span></span><br><span class="line">sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(<span class="string">&quot;\\%$%&quot;</span>));</span><br></pre></td></tr></table></figure>
<h2 id="在replaceFirst-String-regex-String-replacement-中的使用"><a href="#在replaceFirst-String-regex-String-replacement-中的使用" class="headerlink" title="$在replaceFirst(String regex, String replacement)中的使用"></a>$在<code>replaceFirst(String regex, String replacement)</code>中的使用</h2><p>网上关于这个方法的使用，普遍停留在regex，对replacement的解释少之又少，基本上没有。因为$符号在replacement中导致操作报错，因此，这个$肯定是有某种特殊的意义的。打开源代码，一直跟踪到抛出错误的地方。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Processes replacement string to replace group references with</span></span><br><span class="line"><span class="comment"> * groups.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> StringBuilder <span class="title function_">appendExpandedReplacement</span><span class="params">(String replacement, StringBuilder result)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">cursor</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (cursor &lt; replacement.length()) &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">nextChar</span> <span class="operator">=</span> replacement.charAt(cursor);</span><br><span class="line">        <span class="comment">// 可以看出，转义符号使用起来也需要小心。如果在最后面，又会报错。</span></span><br><span class="line">        <span class="keyword">if</span> (nextChar == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">            cursor++;</span><br><span class="line">            <span class="keyword">if</span> (cursor == replacement.length())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                    <span class="string">&quot;character to be escaped is missing&quot;</span>);</span><br><span class="line">            <span class="comment">// 对转义符的操作比较简单，只是先跳过转义符，然后将下一个字符拷贝</span></span><br><span class="line">            nextChar = replacement.charAt(cursor);</span><br><span class="line">            result.append(nextChar);</span><br><span class="line">            cursor++;</span><br><span class="line">        <span class="comment">// 如果是$，那么后面要么是数字，要么是&#123;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextChar == <span class="string">&#x27;$&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// Skip past $</span></span><br><span class="line">            cursor++;</span><br><span class="line">            <span class="comment">// Throw IAE if this &quot;$&quot; is the last character in replacement</span></span><br><span class="line">            <span class="keyword">if</span> (cursor == replacement.length())</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                    <span class="string">&quot;Illegal group reference: group index is missing&quot;</span>);</span><br><span class="line">            nextChar = replacement.charAt(cursor);</span><br><span class="line">            <span class="type">int</span> <span class="variable">refNum</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (nextChar == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                cursor++;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">gsb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                <span class="comment">// 先读出&#123;&#125;中的内容</span></span><br><span class="line">                <span class="keyword">while</span> (cursor &lt; replacement.length()) &#123;</span><br><span class="line">                    nextChar = replacement.charAt(cursor);</span><br><span class="line">                    <span class="keyword">if</span> (ASCII.isLower(nextChar) ||</span><br><span class="line">                        ASCII.isUpper(nextChar) ||</span><br><span class="line">                        ASCII.isDigit(nextChar)) &#123;</span><br><span class="line">                        gsb.append(nextChar);</span><br><span class="line">                        cursor++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (gsb.length() == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                        <span class="string">&quot;named capturing group has 0 length name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (nextChar != <span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                        <span class="string">&quot;named capturing group is missing trailing &#x27;&#125;&#x27;&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">gname</span> <span class="operator">=</span> gsb.toString();</span><br><span class="line">                <span class="keyword">if</span> (ASCII.isDigit(gname.charAt(<span class="number">0</span>)))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                        <span class="string">&quot;capturing group name &#123;&quot;</span> + gname +</span><br><span class="line">                        <span class="string">&quot;&#125; starts with digit character&quot;</span>);</span><br><span class="line">                <span class="comment">//&#123;&#125;中包含的内容，是分组的名字，分组存在，直接拿来分组的值，不存在则报错</span></span><br><span class="line">                <span class="keyword">if</span> (!parentPattern.namedGroups().containsKey(gname))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                        <span class="string">&quot;No group with name &#123;&quot;</span> + gname + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">                refNum = parentPattern.namedGroups().get(gname);</span><br><span class="line">                cursor++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// The first number is always a group</span></span><br><span class="line">                refNum = nextChar - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                <span class="comment">// 只接受0-9的数字，也就是分组的序号</span></span><br><span class="line">                <span class="keyword">if</span> ((refNum &lt; <span class="number">0</span>) || (refNum &gt; <span class="number">9</span>))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                        <span class="string">&quot;Illegal group reference&quot;</span>);</span><br><span class="line">                cursor++;</span><br><span class="line">                <span class="comment">// Capture the largest legal group string</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">done</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cursor &gt;= replacement.length()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">nextDigit</span> <span class="operator">=</span> replacement.charAt(cursor) - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                    <span class="keyword">if</span> ((nextDigit &lt; <span class="number">0</span>) || (nextDigit &gt; <span class="number">9</span>)) &#123; <span class="comment">// not a number</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">newRefNum</span> <span class="operator">=</span> (refNum * <span class="number">10</span>) + nextDigit;</span><br><span class="line">                    <span class="keyword">if</span> (groupCount() &lt; newRefNum) &#123;</span><br><span class="line">                        done = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        refNum = newRefNum;</span><br><span class="line">                        cursor++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Append group</span></span><br><span class="line">            <span class="keyword">if</span> (start(refNum) != -<span class="number">1</span> &amp;&amp; end(refNum) != -<span class="number">1</span>)</span><br><span class="line">                result.append(text, start(refNum), end(refNum));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.append(nextChar);</span><br><span class="line">            cursor++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，<strong>转义符号使用起来也需要小心。如果在最后面，又会报错，对转义符的操作比较简单，只是先跳过转义符，然后将下一个字符拷贝；如果是<code>$</code>，那么后面要么是<code>数字</code>，要么是<code>&#123;</code>。对$符号的处理，如果后面是<code>&#123;</code>，则先读出<code>&#123;&#125;</code>中的内容，也就是分组的名字，然后查询分组是否存在，存在则直接拿来分组的值，不存在则报错，如果后面是数字，就去拿第n个分组的值。</strong></p>
<p>过程如上，但是网上基本上没有上述内容的示例，根据上面的简要分析，做出了下面简要的demo：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">Str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;Welcome to Tutoririalspoint.combb&quot;</span>);</span><br><span class="line">System.out.print(<span class="string">&quot;Return Value :&quot;</span> );</span><br><span class="line">System.out.println(Str.replaceFirst(<span class="string">&quot;Tuto(.*)als(?&lt;hi&gt;.*)(bb)&quot;</span>, <span class="string">&quot;$1AMROOD&#125;$2--$3--$&#123;hi&#125;--xx&quot;</span>));</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// Return Value :Welcome to ririAMROOD&#125;point.com--bb--point.com--xx</span></span><br></pre></td></tr></table></figure>
<p>给分组命名确实以前没尝试过，参考：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/415580/regex-named-groups-in-java%E3%80%82">https://stackoverflow.com/questions/415580/regex-named-groups-in-java。</a></p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>替换后的方法如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">showSql</span><span class="params">(Configuration configuration, BoundSql boundSql)</span> &#123;</span><br><span class="line">  <span class="type">Object</span> <span class="variable">parameterObject</span> <span class="operator">=</span> boundSql.getParameterObject();</span><br><span class="line">  List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">  <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql().replaceAll(<span class="string">&quot;[\\s]+&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (parameterMappings.size() &gt; <span class="number">0</span> &amp;&amp; parameterObject != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">TypeHandlerRegistry</span> <span class="variable">typeHandlerRegistry</span> <span class="operator">=</span> configuration.getTypeHandlerRegistry();</span><br><span class="line">    <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">      sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(getParameterValue(parameterObject)));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> configuration.newMetaObject(parameterObject);</span><br><span class="line">      <span class="keyword">for</span> (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> parameterMapping.getProperty();</span><br><span class="line">        <span class="keyword">if</span> (metaObject.hasGetter(propertyName)) &#123;</span><br><span class="line">          <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> metaObject.getValue(propertyName);</span><br><span class="line">          sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(getParameterValue(obj)));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">          <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">          sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(getParameterValue(obj)));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：<br><a target="_blank" rel="noopener" href="https://github.com/abel533/Mapper/issues/30">https://github.com/abel533/Mapper/issues/30</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-22T22:44:49.000Z" title="3/23/2019, 6:44:49 AM">2019-03-23</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:29.007Z" title="2/9/2021, 11:03:29 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">16 分钟读完 (大约2329个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/23/14909257ac39.html">MyBatis分页插件PageHelper封装以及遇到的bug</a></p><div class="content"><p>PageHelper链接：<a target="_blank" rel="noopener" href="https://github.com/pagehelper/Mybatis-PageHelper">https://github.com/pagehelper/Mybatis-PageHelper</a><br>项目中使用到了一个注解，叫做<code>PageAble</code>，这是一个对<code>PageHelper</code>的封装注解。这个注解有一个非常显著的问题就是，<strong>不能在这个方法里面执行两次SQL查询</strong>（原因将在后续中慢慢分析）。使用方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PageAble</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">method</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解的内容比较简单，就是定义了两个参数，分别为这两个参数设置了默认的名字、以及默认值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PageAble &#123;</span><br><span class="line">	 String <span class="title function_">pageSizeName</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;size&quot;</span>;</span><br><span class="line">	 String <span class="title function_">pageNumName</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;page&quot;</span>;</span><br><span class="line">	 <span class="type">int</span> <span class="title function_">pageSize</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">20</span>;</span><br><span class="line">	 <span class="type">int</span> <span class="title function_">pageNum</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后得到的返回值是一个叫做<code>ResultPageView</code>的类，是对分页情况的一个封装，其中的内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResultPageView</span>&lt;T&gt; &#123;</span><br><span class="line">	 <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0l</span>;</span><br><span class="line">	 <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">current</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">	 <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	 <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line">	 <span class="comment">// 省略一些构造方法、getter/setter方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，最重要的问题当然是<strong>被<code>@PageAble</code>注解的方法是怎样执行的</strong>。显然这里是利用了Spring AOP，在这个方法的前后，加上了自定义的处理方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAGE_ABLE</span> <span class="operator">=</span> <span class="string">&quot;@annotation(com.xxxxxo0o0.baseservice.annotation.PageAble)&quot;</span>;</span><br><span class="line"><span class="meta">@Around(PAGE_ABLE)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doAroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	logger.info(<span class="string">&quot;execute method : &quot;</span> + proceedingJoinPoint.getSignature().getName());</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 准备开始分页</span></span><br><span class="line">		prepare(proceedingJoinPoint);</span><br><span class="line">		<span class="comment">// 执行被注解的方法</span></span><br><span class="line">		<span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line">		<span class="comment">// 装饰被注解方法返回的值</span></span><br><span class="line">		<span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> after(obj);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">		logger.error(<span class="string">&quot;aspect execute error : &quot;</span>, throwable);</span><br><span class="line">		<span class="keyword">throw</span> throwable;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="comment">// 先忽略这个finally里面的内容</span></span><br><span class="line">		<span class="comment">//PageHelper.clearPage();</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在被注解方法执行前的准备活动中，执行了什么操作？代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> point.getSignature();</span><br><span class="line">	<span class="type">MethodSignature</span> <span class="variable">methodSignature</span> <span class="operator">=</span> (MethodSignature) signature;</span><br><span class="line">	<span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> methodSignature.getMethod();</span><br><span class="line">	<span class="type">PageAble</span> <span class="variable">pageAble</span> <span class="operator">=</span> targetMethod.getAnnotation(PageAble.class);</span><br><span class="line">	<span class="comment">// 获取参数名称</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">numName</span> <span class="operator">=</span> pageAble.pageNumName();</span><br><span class="line">	<span class="type">String</span> <span class="variable">sizeName</span> <span class="operator">=</span> pageAble.pageSizeName();</span><br><span class="line">	<span class="comment">// 先获取page和size的默认值</span></span><br><span class="line">	<span class="type">int</span> <span class="variable">pageNo</span> <span class="operator">=</span> pageAble.pageNum();</span><br><span class="line">	<span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> pageAble.pageSize();</span><br><span class="line">	<span class="comment">// 获取参数值列表</span></span><br><span class="line">	Object[] paramValues = point.getArgs();</span><br><span class="line">	<span class="comment">// 获取参数名列表</span></span><br><span class="line">	String[] paramNames = methodSignature.getParameterNames();</span><br><span class="line">	<span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> paramNames.length;</span><br><span class="line">	<span class="comment">// 对参数列表进行遍历</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">		<span class="comment">// 如果参数名 == 注解中写入的页数参数名</span></span><br><span class="line">		<span class="keyword">if</span> (paramNames[i].equals(numName)) &#123;</span><br><span class="line">			<span class="comment">// 从参数值列表中取出值，赋值给页数</span></span><br><span class="line">			pageNo = (Integer) paramValues[i];</span><br><span class="line">		<span class="comment">// 如果参数名 == 注解中写入的每页数量的参数名</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramNames[i].equals(sizeName)) &#123;</span><br><span class="line">			<span class="comment">// // 从参数值列表中取出值，赋值为每页尺寸</span></span><br><span class="line">			pageSize = (Integer) paramValues[i];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 调用PageHelper的分页</span></span><br><span class="line">	PageHelper.startPage(pageNo, pageSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先忽略其中的细节，看看被注解方法后面执行的方法做了什么事情，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">after</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span> obj <span class="keyword">instanceof</span> List;</span><br><span class="line">    PageInfo&lt;?&gt; pageInfo = <span class="keyword">new</span> <span class="title class_">PageInfo</span>((List&lt;?&gt;) obj);</span><br><span class="line">    <span class="comment">// 从某个地方获取的分页的信息。（其实是ThreadLocal，先忽略）</span></span><br><span class="line">    Page&lt;Object&gt; localPage = PageHelper.getLocalPage();</span><br><span class="line">    <span class="comment">// 获取分页参数</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> localPage.getTotal();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageNum</span> <span class="operator">=</span> localPage.getPageNum();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pages</span> <span class="operator">=</span> localPage.getPages();</span><br><span class="line">    List&lt;?&gt; list = (List&lt;?&gt;) obj;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	    List&lt;Map&gt; mapList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">	    <span class="keyword">for</span> (Object o : list) &#123;</span><br><span class="line">	    	<span class="comment">// 将一个对象按照原来的字段名转成map</span></span><br><span class="line">			HashMap&lt;String, Object&gt; map = MapUtil.convertObj2Map(o);</span><br><span class="line">			<span class="keyword">if</span> (o <span class="keyword">instanceof</span> BaseModel) &#123;</span><br><span class="line">				<span class="type">BaseModel</span> <span class="variable">baseModel</span> <span class="operator">=</span> (BaseModel) o;</span><br><span class="line">				map.put(<span class="string">&quot;id&quot;</span>, baseModel.getId());</span><br><span class="line">			&#125;</span><br><span class="line">			ReflectionUtils</span><br><span class="line">			    .doWithFields(o.getClass(), <span class="keyword">new</span> <span class="title class_">InnerFieldCallback</span>(map, o), <span class="keyword">new</span> <span class="title class_">InnerFieldFilter</span>());</span><br><span class="line">			mapList.add(map);</span><br><span class="line">	    &#125;</span><br><span class="line">	    list = mapList;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		logger.error(<span class="string">&quot;convert obj to map occurred error &quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    pageInfo = <span class="keyword">new</span> <span class="title class_">PageInfo</span>((list));</span><br><span class="line">    ResultPageView&lt;?&gt; resultPageView;</span><br><span class="line">    resultPageView = <span class="keyword">new</span> <span class="title class_">ResultPageView</span>&lt;&gt;(total, pageNum, pages, pageInfo.getList());</span><br><span class="line">    <span class="comment">// 清除分页信息</span></span><br><span class="line">    PageHelper.clearPage();</span><br><span class="line">    <span class="keyword">return</span> resultPageView;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="PageHelper-start-做了什么"><a href="#PageHelper-start-做了什么" class="headerlink" title="PageHelper.start()做了什么"></a>PageHelper.start()做了什么</h2><p>一路往父类翻到start()的实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开始分页</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageNum      页码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSize     每页显示数量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> count        是否进行count查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> reasonable   分页合理化,null时用默认配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSizeZero true且pageSize=0时返回全部结果，false时分页,null时用默认配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; Page&lt;E&gt; <span class="title function_">startPage</span><span class="params">(<span class="type">int</span> pageNum, <span class="type">int</span> pageSize, <span class="type">boolean</span> count, Boolean reasonable, Boolean pageSizeZero)</span> &#123;</span><br><span class="line">    Page&lt;E&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;E&gt;(pageNum, pageSize, count);</span><br><span class="line">    page.setReasonable(reasonable);</span><br><span class="line">    page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    <span class="comment">//当已经执行过orderBy的时候</span></span><br><span class="line">    Page&lt;E&gt; oldPage = getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (oldPage != <span class="literal">null</span> &amp;&amp; oldPage.isOrderByOnly()) &#123;</span><br><span class="line">        page.setOrderBy(oldPage.getOrderBy());</span><br><span class="line">    &#125;</span><br><span class="line">    setLocalPage(page);</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>setLocalPage()</code>与之前的<code>after()</code>中的<code>getLocalPage()</code>是一对get&#x2F;set方法，他们的目的是从当前线程中获取&#x2F;设置分页信息。其实现如下（关于ThreadLocal的具体实现，可以去参考其他博客）:<br><img src="/images/pics/b62b0868d8f630c716947cd56e737676.png" alt="在这里插入图片描述"><br>既然<code>startPage()</code>只是在线程中塞了一个关于分页的信息，那么真正读取这个分页信息的动作一定是在处理SQL语句的地方，也就是<code>Interceptor</code>。PageHelper的官方使用文档链接：<br><a target="_blank" rel="noopener" href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/HowToUse.md">https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/HowToUse.md</a><br>其中也有一块，是对不安全分页的说明：</p>
<blockquote>
<p><code>PageHelper</code> 方法使用了静态的 <code>ThreadLocal</code> 参数，分页参数和线程是绑定的。只要你可以保证在 <code>PageHelper</code> 方法调用后紧跟 MyBatis 查询方法，这就是安全的。因为 <code>PageHelper</code> 在 <code>finally</code> 代码段中自动清除了 <code>ThreadLocal</code> 存储的对象。如果代码在进入 <code>Executor</code> 前发生异常，就会导致线程不可用，这属于人为的 Bug（例如接口方法和 XML 中的不匹配，导致找不到 <code>MappedStatement</code> 时），这种情况由于线程不可用，也不会导致 <code>ThreadLocal</code> 参数被错误的使用。但是如果你写出下面这样的代码，就是不安全的用法：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PageHelper.startPage(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">List&lt;Country&gt; list;</span><br><span class="line"><span class="keyword">if</span>(param1 != <span class="literal">null</span>)&#123;</span><br><span class="line">    list = countryMapper.selectIf(param1);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Country&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这种情况下由于 param1 存在 null 的情况，就会导致 PageHelper 生产了一个分页参数，但是没有被消费，这个参数就会一直保留在这个线程上。当这个线程再次被使用时，就可能导致不该分页的方法去消费这个分页参数，这就产生了莫名其妙的分页。</p>
</blockquote>
<p>因此打开项目中的<code>MyPageInterceptor</code>，它的功能就是充当Mybatis的拦截器，还有一部分自定义的功能，比如说输出sql执行时间、打印sql语句。这个类与PageHelper的拦截器关键的代码基本一致，可以说是copy吧，其中关键的一个地方是<code>intercept()</code>方法中，有一个进行判断，是否需要分页的语句。<br><img src="/images/pics/59c3c19ef68fc581e6b02027a6a6f3a1.png" alt="在这里插入图片描述"><br>在查询完毕后，finally方法回执行一次清除动作：<br><img src="/images/pics/b31da2dfa6341acab5451c18e0e88645.png" alt="在这里插入图片描述"><br>这个dialect是一个本地的类，继承自PageHelper这个类，覆盖了其中的afterAll()方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPageHelper</span> <span class="keyword">extends</span> <span class="title class_">PageHelper</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterAll</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 获取分页信息</span></span><br><span class="line">		Page&lt;Object&gt; localPage = getLocalPage();</span><br><span class="line">		<span class="comment">// 调用父类方法，即清除分页信息</span></span><br><span class="line">		<span class="built_in">super</span>.afterAll();</span><br><span class="line">		<span class="comment">// 又将分页信息塞回线程中。</span></span><br><span class="line">		<span class="comment">// 为什么要这样做？为了让在切面中，加入分页的详细信息。</span></span><br><span class="line">		setLocalPage(localPage);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的代码执行完成后，不论查询的结果是成功还是失败，分页信息都会存在当前线程中（如果直接调用父类的方法，不自定义这个方法，就能保证执行完一次查询，分页信息不会保存在当前线程中）。问题就出在这里。因为<code>interceptor</code>处理过后，当前线程中还存在分页的信息，并且这个分页的信息需要以来切面的处理方法来完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">skip</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(ms.getId().endsWith(MSUtils.COUNT))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;在系统中发现了多个分页插件，请检查系统配置!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//设置默认的 count 列</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtil.isEmpty(page.getCountColumn()))&#123;</span><br><span class="line">            page.setCountColumn(pageParams.getCountColumn());</span><br><span class="line">        &#125;</span><br><span class="line">        autoDialect.initDelegateDialect(ms);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中获取Page的代码是这样的，说到底还是从当前线程中去取：<br><img src="/images/pics/64df87d52a0c862bddb99638c1dced69.png" alt="在这里插入图片描述"></p>
<h2 id="bug描述与分析"><a href="#bug描述与分析" class="headerlink" title="bug描述与分析"></a>bug描述与分析</h2><p><strong>执行一个分页查询，让查询故意报错，多执行几次，然后再进行一次普通查询，得到ClassCastException异常。</strong><br>因此，问题已经出来了。<br><img src="/images/pics/1ee8292005525f274ca585166dfe6f0b.png" alt="在这里插入图片描述"></p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>因此加上finally后，无论是否报错，那么分页信息都将会被在线程中清除。问题就解决了，所以把涂掉的finally加上清除分页信息的处理，即可解决此问题。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>批量发送请求的脚本，用来引发bug用：<br><strong>main.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">host1 = <span class="string">&#x27;localhost:9999&#x27;</span></span><br><span class="line">host2 = <span class="string">&#x27;xxxxxxxx&#x27;</span></span><br><span class="line">host = host1</span><br><span class="line">MAX = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vehicle</span>():</span><br><span class="line">    parse_response(send_get_req(<span class="string">&#x27;http://&#x27;</span>+host+<span class="string">&#x27;/nemt/driver/get&#x27;</span>))</span><br><span class="line">    parse_response(send_get_req(<span class="string">&#x27;http://&#x27;</span>+host+<span class="string">&#x27;/nemt/vehicles?page=1&amp;size=20&#x27;</span>))</span><br><span class="line">    parse_response(send_get_req(<span class="string">&#x27;http://&#x27;</span>+host+<span class="string">&#x27;/nemt/vehicleType/all&#x27;</span>))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_version</span>():</span><br><span class="line">    parse_response(send_get_req(<span class="string">&#x27;http://&#x27;</span>+host+<span class="string">&#x27;/nemt/driver-apps&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_response</span>(<span class="params">resp</span>):</span><br><span class="line">    s = json.loads(resp[<span class="number">0</span>].content)</span><br><span class="line">    <span class="keyword">if</span> s[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">        <span class="comment"># print()</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;x &quot;</span> + s[<span class="string">&#x27;message&#x27;</span>] + <span class="string">&#x27; --&gt; &#x27;</span> + resp[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;o&quot;</span>)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_get_req</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment"># print(&#x27;url --&gt; &#x27;+url)</span></span><br><span class="line">    <span class="keyword">return</span> requests.get(url), url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt;= MAX:</span><br><span class="line">        app_version()</span><br><span class="line">        vehicle()</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p><strong>crack.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/env bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="keyword">if</span> [<span class="variable">$1</span> -eq <span class="string">&quot;&quot;</span>]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   max=1</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="keyword">else</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   max=<span class="variable">$1</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="keyword">fi</span></span></span><br><span class="line">for i in $(seq 1 $1):</span><br><span class="line">do</span><br><span class="line">curl &#x27;http://localhost:9999/nemt/orders?page=1&amp;size=20&#x27; -H &#x27;Accept-Encoding: gzip, deflate&#x27; -H &#x27;Accept-Language: zh,en;q=0.9,ja;q=0.8,zh-TW;q=0.7,fr;q=0.6,zh-CN;q=0.5&#x27; -H &#x27;User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36&#x27; -H &#x27;Accept: application/json, text/plain, */*&#x27; -H &#x27;userId: 453&#x27; -H &#x27;Connection: keep-alive&#x27; -H &#x27;token: 48143d9154e7c42face53855826f5ffa&#x27; --compressed</span><br><span class="line">echo &#x27;&#x27;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-20T00:38:33.000Z" title="3/20/2019, 8:38:33 AM">2019-03-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:52.714Z" title="2/9/2021, 11:03:52 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span> / </span><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">5 分钟读完 (大约785个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/20/5156767b418e.html">解决web端登录时等待过久并偶尔抛出事务相关异常</a></p><div class="content"><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p><img src="/images/pics/b121bd559df52a004b45e06e2cc88495.png" alt="在这里插入图片描述"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>登录函数中有一个事务，如下：<br><img src="/images/pics/0608cdfe9b3f587c7bcf75a95a61f312.png" alt="在这里插入图片描述"><br>事务里面有一个有可能操作比较耗时的过程：<br><img src="/images/pics/c48cc071a374cc675606da7556e12130.png" alt="在这里插入图片描述"><br>在新增登录日志的时候，获取用户的ip。<br><img src="/images/pics/7eb2aaf28af964507dc55b2cb69d18a2.png" alt="在这里插入图片描述"><br>具体干了啥不重要，重要的是发了一个http请求，并且是串行的，所以这个请求比较耗时的可能是很大的，并且具备不确定性因素。<br><img src="/images/pics/30bb080b6e51b36241ad15dcc01c8ef4.png" alt="在这里插入图片描述"></p>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p><code>TransactionRollbackException</code>的文档注释为：</p>
<p><em>This exception indicates that the transaction associated with processing of the request has been rolled back, or marked to roll back. Thus the requested operation either could not be performed or was not performed because further computation on behalf of the transaction would be fruitless</em></p>
<p>可能的过程为：线程1进入事务、然后进行了一次update操作，获得了一个排他锁，然后被卡在了获取ip的那个地方，即此事务持有着排他锁，然后还长时间不结束（50s+），然后线程2也进入了事务，此时在进行update的时候，需要等待线程1释放排它锁，在50秒过后，仍未获取到锁，此时获取锁时间超过了预设，抛出上述异常。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>规避潜在的耗时操作。<strong>但是由于此服务没人维护，因此通过本地编译，然后拉包替换相应class文件，再上传到服务器的方式进行修改。</strong></p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>查看获取锁的超时阀值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%timeout%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name               <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> connect_timeout             <span class="operator">|</span> <span class="number">10</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> delayed_insert_timeout      <span class="operator">|</span> <span class="number">300</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> have_statement_timeout      <span class="operator">|</span> YES      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_flush_log_at_timeout <span class="operator">|</span> <span class="number">1</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_lock_wait_timeout    <span class="operator">|</span> <span class="number">50</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_rollback_on_timeout  <span class="operator">|</span> OFF      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> interactive_timeout         <span class="operator">|</span> <span class="number">28800</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> lock_wait_timeout           <span class="operator">|</span> <span class="number">31536000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> net_read_timeout            <span class="operator">|</span> <span class="number">30</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> net_write_timeout           <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> rpl_stop_slave_timeout      <span class="operator">|</span> <span class="number">31536000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slave_net_timeout           <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait_timeout                <span class="operator">|</span> <span class="number">28800</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+----------+</span></span><br><span class="line"><span class="number">13</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --------------------------Controller------------</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 测试web端登录锁表</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/hotline/test&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSomeThing</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    testService.doSomething();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ----------------------------Service----------------</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> BizConfMapper confMapper;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 共享锁</span></span><br><span class="line">    <span class="type">BizConf</span> <span class="variable">conf</span> <span class="operator">=</span> confMapper.selectByPrimaryKey(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 排它锁</span></span><br><span class="line">    confMapper.updateByPrimaryKey(conf);</span><br><span class="line">    <span class="comment">// 等待让下个线程超时，最起码要大于50</span></span><br><span class="line">    Thread.sleep(<span class="number">60000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>日志输出与项目中出现的错误信息基本一致，如下：<br><img src="/images/pics/3be7b45fa1d895fd19656ba7b1a932cd.png" alt="在这里插入图片描述"><br>在<code>@Transactional</code>注解中加入timeout后，报错不一样，但是阔以理解为spring框架为我们抛出了异常。如下：<br><img src="/images/pics/1cfe80e7355ec2e1ff68cb468b0c96bb.png" alt="在这里插入图片描述"></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>其中对我理解这种现象有很大帮助的资料为这一张图，它让我明白了锁与事务之间的关系。<br><img src="/images/pics/9bebe9ada738c3908c5baa7df6041ae8.png" alt="在这里插入图片描述"><br>参考：<br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014133576">https://segmentfault.com/a/1190000014133576</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-27T00:51:09.000Z" title="2/27/2019, 8:51:09 AM">2019-02-27</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:45.943Z" title="2/9/2021, 11:03:45 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span> / </span><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">5 分钟读完 (大约701个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/27/63bdd864316e.html">一种基于redis的分布式锁的实现（当前项目中在使用）</a></p><div class="content"><p>主要思想是利用redis执行命令时的单线程特性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分布式锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(DistributedLock.class);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁默认超时时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">DEFAULT_TIMEOUT_SECOND</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所等待的时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">DEFAULT_WAITE_TIMEOUT_SECOND</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁循环等待时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">LOOP_WAIT_TIME_MILLISECOND</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;redisCacheService&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BaseCacheService cacheService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有超时等待的加锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutSecond      如果为null,使用默认超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waiteTimeoutSecond 若果为null,使用默认超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加锁的值（超时时间：-1表示获取失败，超时）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">lock</span><span class="params">(String key, Long timeoutSecond, Long waiteTimeoutSecond)</span> &#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; start lock&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">beganTime</span> <span class="operator">=</span> System.currentTimeMillis() / <span class="number">1000</span>;</span><br><span class="line">        <span class="comment">//如果参数错误</span></span><br><span class="line">        <span class="keyword">if</span> (timeoutSecond != <span class="literal">null</span> &amp;&amp; timeoutSecond &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            timeoutSecond = DEFAULT_TIMEOUT_SECOND;</span><br><span class="line">        &#125;</span><br><span class="line">        timeoutSecond = timeoutSecond == <span class="literal">null</span> ? DEFAULT_TIMEOUT_SECOND : timeoutSecond;</span><br><span class="line">        <span class="keyword">if</span> (waiteTimeoutSecond != <span class="literal">null</span> &amp;&amp; waiteTimeoutSecond &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            waiteTimeoutSecond = DEFAULT_WAITE_TIMEOUT_SECOND;</span><br><span class="line">        &#125;</span><br><span class="line">        waiteTimeoutSecond =</span><br><span class="line">                waiteTimeoutSecond == <span class="literal">null</span> ? DEFAULT_WAITE_TIMEOUT_SECOND : waiteTimeoutSecond;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//等待超时判断</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis() / <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">if</span> ((endTime - beganTime) &gt;= waiteTimeoutSecond) &#123;</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1l</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//超时时间点</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">timeoutTimeMilli</span> <span class="operator">=</span> cacheService.getCurrentTimeMilliForCache() + timeoutSecond * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果设置成功</span></span><br><span class="line">            <span class="keyword">if</span> (cacheService.setIfAbsent(key, timeoutTimeMilli)) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果已经超时</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">value</span> <span class="operator">=</span> cacheService.getVal(key, Long.class);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; value.longValue() &lt; cacheService.getCurrentTimeMilliForCache()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//设置新的超时时间</span></span><br><span class="line">                <span class="type">Long</span> <span class="variable">oldValue</span> <span class="operator">=</span> cacheService.getAndSet(key, timeoutTimeMilli);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//多个线程同时getset，只有第一个才可以获取到锁</span></span><br><span class="line">                <span class="keyword">if</span> (value.equals(oldValue)) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//延迟一定毫秒，防止请求太频繁</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(LOOP_WAIT_TIME_MILLISECOND);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;DistributedLock lock sleep error&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 无超时等待的加锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutSecond 如果为null,使用默认超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加锁的值（超时时间）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">lock</span><span class="params">(String key, Long timeoutSecond)</span> &#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; start lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果参数错误</span></span><br><span class="line">        <span class="keyword">if</span> (timeoutSecond != <span class="literal">null</span> &amp;&amp; timeoutSecond &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            timeoutSecond = DEFAULT_TIMEOUT_SECOND;</span><br><span class="line">        &#125;</span><br><span class="line">        timeoutSecond = timeoutSecond == <span class="literal">null</span> ? DEFAULT_TIMEOUT_SECOND : timeoutSecond;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//超时时间点</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">timeoutTimeMilli</span> <span class="operator">=</span> cacheService.getCurrentTimeMilliForCache() + timeoutSecond * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果设置成功</span></span><br><span class="line">            <span class="comment">// 若在redis中、没有相应的key值，那么可以认为，当前线程即或得该锁。</span></span><br><span class="line">            <span class="keyword">if</span> (cacheService.setIfAbsent(key, timeoutTimeMilli)) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果已经超时</span></span><br><span class="line">            <span class="comment">// 此时该key在redis已存在，获取该key的值</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">value</span> <span class="operator">=</span> cacheService.getVal(key, Long.class);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; value.longValue() &lt; cacheService.getCurrentTimeMilliForCache()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//设置新的超时时间</span></span><br><span class="line">                <span class="comment">// 如果此时获取到的oldValue，与前面获取的value相同，则说明该线程可以获得锁</span></span><br><span class="line">                <span class="comment">// 获得锁后，set进新值。</span></span><br><span class="line">                <span class="type">Long</span> <span class="variable">oldValue</span> <span class="operator">=</span> cacheService.getAndSet(key, timeoutTimeMilli);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//多个线程同时getset，只有第一个才可以获取到锁</span></span><br><span class="line">                <span class="keyword">if</span> (value.equals(oldValue)) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//延迟一定毫秒，防止请求太频繁</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(LOOP_WAIT_TIME_MILLISECOND);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;DistributedLock lock sleep error&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unLock</span><span class="params">(String key, <span class="type">long</span> lockValue)</span> &#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; start unlock&quot;</span>);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">value</span> <span class="operator">=</span> cacheService.getVal(key, Long.class);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; value.equals(lockValue)) &#123;<span class="comment">//如果是本线程加锁</span></span><br><span class="line">            cacheService.deleteVal(key);</span><br><span class="line">            logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; unlock success&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-19T21:07:09.000Z" title="2/20/2019, 5:07:09 AM">2019-02-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:25.939Z" title="2/9/2021, 11:03:25 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span> / </span><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">3 分钟读完 (大约434个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/20/5ca02b540a6b.html">nginx中的root与alias的差别</a></p><div class="content"><h2 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h2><p>nginx指定文件路径有两种方式root和alias，指令的使用方法和作用域：<br>[root]<br>语法：root path<br>默认值：root html<br>配置段：http、server、location、if<br>[alias]<br>语法：alias path<br>配置段：location</p>
<h2 id="root与alias主要区别"><a href="#root与alias主要区别" class="headerlink" title="root与alias主要区别"></a>root与alias主要区别</h2><p>在于nginx如何解释location后面的uri，这会使两者分别以不同的方式将请求映射到服务器文件上。<br>root的处理结果是：<code>root路径 ＋ location路径</code><br>alias的处理结果是：使用alias路径替换location路径<br>alias是一个目录别名的定义，root则是最上层目录的定义。<br>还有一个重要的区别是<strong>alias后面必须要用“&#x2F;”结束</strong>，否则会找不到文件的，而root则可有可无。</p>
<p>例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 如果一个请求的URI是/t/a.html时，web服务器将会返回服务器上的/www/root/html/t/a.html的文件。</span><br><span class="line">location ^~ /t/ &#123;</span><br><span class="line">	root /www/root/html/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 如果一个请求的URI是/t/a.html时，web服务器将会返回服务器上的/www/root/html/new_t/a.html的文件。</span><br><span class="line"># 注意这里是new_t，因为alias会把location后面配置的路径丢弃掉，把当前匹配到的目录指向到指定的目录。</span><br><span class="line">location ^~ /t/ &#123;</span><br><span class="line">	alias /www/root/html/new_t/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>使用alias时，目录名后面一定要加”&#x2F;“。</li>
<li>alias在使用正则匹配时，必须捕捉要匹配的内容并在指定的内容处使用。</li>
<li>alias只能位于location块中。（root可以不放在location中）</li>
</ol>
<p>搬运工：<br>文章为: nginx.cn原创，转载请注明本文地址: <a target="_blank" rel="noopener" href="http://www.nginx.cn/4658.html">http://www.nginx.cn/4658.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-03T01:05:20.000Z" title="2/3/2019, 9:05:20 AM">2019-02-03</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:04:03.833Z" title="2/9/2021, 11:04:03 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">11 分钟读完 (大约1723个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/03/8d333a46d643.html">Java进程周期性自动退出的原因排查</a></p><div class="content"><blockquote>
<p>一个java -jar服务在被CI启动后，过一段时间，进程就被消失了，不见了。日志没有关于出错的相关信息。对日志中记录的最后一条请求，进行压力测试，但该进程却没有自己消失。个人觉得这个问题很有意思，但是我也明白，找到这其中的原因可能需要很长的时间。</p>
</blockquote>
<h2 id="Update-2019-3-15"><a href="#Update-2019-3-15" class="headerlink" title="Update(2019-3-15 )"></a>Update(2019-3-15 )</h2><p>最近公司的其他项目上，又遇到了一个进程老是无缘无故就挂的现象，按照之前的那种场景来排查，并没有发现有那种CI的出现。顿时又陷入了困境之中。不过我还是按部就班的做了三件事：</p>
<ul>
<li>用root权限启动改服务</li>
<li>做好对jvm的监控</li>
<li>用strace对进程做好监控<br>顺便了解了一下strace的含义，发现其中的字段确实是有很大的意义。<br>监控命令如下：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> strace -T -tt -e trace=all -p \`pgrep -f algorithm-work-1.0.0.jar\ ` &gt; trace.\`pgrep -f algorithm-work-1.0.0.jar\`.<span class="built_in">log</span> &amp;\</span><br></pre></td></tr></table></figure>
监控日志如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">webapp@ecs-f1c4-0003:/opt/webapp/logs$ cat trace.26077.log </span><br><span class="line">strace: Process 26077 attached</span><br><span class="line">11:22:43.117920 futex(0x7f631a5fb9d0, FUTEX_WAIT, 26078, NULL) = ? ERESTARTSYS (To be restarted if SA_RESTART is set) &lt;1238.653416&gt;</span><br><span class="line">11:43:21.776222 --- SIGTERM &#123;si_signo=SIGTERM, si_code=SI_USER, si_pid=26158, si_uid=0&#125; ---</span><br><span class="line">11:43:21.777278 futex(0x7f63199c0540, FUTEX_WAKE_PRIVATE, 1) = 1 &lt;0.004217&gt;</span><br><span class="line">11:43:21.786583 rt_sigreturn(&#123;mask=[]&#125;) = 202 &lt;0.005049&gt;</span><br><span class="line">11:43:21.796220 futex(0x7f631a5fb9d0, FUTEX_WAIT, 26078, NULL &lt;unfinished ...&gt;</span><br><span class="line">11:43:23.605244 +++ exited with 143 +++</span><br></pre></td></tr></table></figure>
从上面看来，uid&#x3D;0说明操作者是root，但是kill -9不一定有，不过至少是可以看出来是什么时候被干掉的。</li>
</ul>
<p><strong>转机</strong><br>发现是被别人用来挖矿了&#x3D;&#x3D;<br><img src="/images/pics/873a5c4a4b00e416b7f3de3d3dcbefb1.png" alt="在这里插入图片描述"><br>详细的情况与下面链接的描述一模一样。本来还有一个进程叫做<code>crond64</code>，在top中看到占用的CPU非常高，各个核的都占到了90%+。执行的挖矿脚本的目录在<code>~/.ttp</code>下，打包好了，准备研究研究。<br><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1115770/crond64-tsm-virus-in-ubuntu">https://askubuntu.com/questions/1115770/crond64-tsm-virus-in-ubuntu</a></p>
<h2 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h2><p>首先想到的是：是不是某一个接口出现了问题，所以根据日志中所记录的最后一条请求，对其进行压力测试。脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 获取工单详情</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100000&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	curl --header <span class="string">&quot;token:71e8e4dd40dd65f645ceb214397f578e&quot;</span> --url <span class="string">&quot;192.168.31.117:9997/workorder/mine/orders?id=79&quot;</span> &amp;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>结果被认为遭到了ddos攻击，囧！<br><img src="/images/pics/0e8763e10c388f133d9b06474c8da2ac.png" alt="在这里插入图片描述"><br>该服务进程扛过了这些请求，没有死亡。</p>
<h2 id="排查CI"><a href="#排查CI" class="headerlink" title="排查CI"></a>排查CI</h2><p>因为整个项目通过gitlab管理，而gitlab中有一项叫做CI，可以通过ci脚本来执行一些脚本达到发布、部署最新的服务到相应服务器上。这里面可能会存在问题，比如说，另外一个ci脚本在执行的时候，会把该服务的进程kill掉，只是会有这种可能，因为CI脚本大部分是通过copy的，但是可能性不高，因为所有的CI脚本都能够顺利执行，所以kill掉的肯定是自身服务的进程，不然CI脚本对应的服务可能起不来，但目前所有的CI脚本都能顺利执行完。但是还是去排查一下CI脚本，<strong>没毛病</strong>。</p>
<h2 id="是谁kill掉了该进程？"><a href="#是谁kill掉了该进程？" class="headerlink" title="是谁kill掉了该进程？"></a>是谁kill掉了该进程？</h2><p>这个进程消失的原因，可以想到的情况为：jvm崩溃、被操作系统的oom_killer杀掉、被某个脚本杀掉？</p>
<h3 id="是否为操作系统所终结？"><a href="#是否为操作系统所终结？" class="headerlink" title="是否为操作系统所终结？"></a>是否为操作系统所终结？</h3><p>由于outofmemory被kill掉的进程，会在&#x2F;var&#x2F;log下的某个文件中留下最终的遗迹。但是在整个&#x2F;var&#x2F;log下、都没有搜索kill的痕迹，如下：<br><img src="/images/pics/f37f30e11a704878f66e3f03f1146f88.png" alt="在这里插入图片描述"><br><img src="/images/pics/2c953ab6f8a5bac384c914a94f23f0ec.png" alt="在这里插入图片描述"><br>如果没有&#x2F;var&#x2F;log&#x2F;messages这个文件，可以通过设置，将这个log文件开启。</p>
<ol>
<li><p>root身份打开 <code>/etc/rsyslog.d/50-default.conf</code></p>
</li>
<li><p>把注释#去掉</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#*.=info;*.=notice;*.=warn;\</span></span><br><span class="line"><span class="comment">#    auth,authpriv.none;\</span></span><br><span class="line"><span class="comment">#    cron,daemon.none;\</span></span><br><span class="line"><span class="comment">#    mail,news.none        -/var/log/messages</span></span><br></pre></td></tr></table></figure></li>
<li><p>重启后ok<br><code>sudo restart rsyslog</code></p>
</li>
</ol>
<p><strong>并没有发现这个oom_killer的痕迹</strong></p>
<h3 id="JVM自己崩溃？"><a href="#JVM自己崩溃？" class="headerlink" title="JVM自己崩溃？"></a>JVM自己崩溃？</h3><p>在该服务的启动参数中加入了对崩溃日志的指定：<br><code>java  -jar  -Xms512m  -Xmx512m  -XX:MaxPermSize=126m  -XX:+HeapDumpOnOutOfMemoryError  -XX:HeapDumpPath=/opt/webapp/xxx-server/  -XX:ErrorFile=/opt/webapp/xxx-server/hs_err_pid_%p.log  xxx-server.jar</code><br>但是在该进程被终结后，并没有发现相应目录下的日志文件。所以这种情况下，同样也没有对其进行内存分析的先决条件、jdk自带的一系列工具并没有发挥出作用的余地。</p>
<h3 id="到底是谁杀掉了这个进程？"><a href="#到底是谁杀掉了这个进程？" class="headerlink" title="到底是谁杀掉了这个进程？"></a>到底是谁杀掉了这个进程？</h3><p>使用<code>nohup strace -T -tt -e trace=all -p 21715 &gt; trace.log &amp;</code>监控该pid的情况，如果是被<code>kill -9</code>，会出现一个log，大致如下：<br><img src="/images/pics/f067e8e0f2ededc4fe9487e82ae14a82.png" alt="在这里插入图片描述"></p>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>通过strace命令的跟踪、最终发现trace.log的内容如下所示：<br><img src="/images/pics/fb78b7e6dbfd98dfcb1119fe12191ecd.png" alt="在这里插入图片描述"><br>出现这个的原因基本上是两个、一个是人为的kill -9、或者就是被系统kill -9。系统杀掉该进程的原因、被逐一排除，结果只剩下人为的因素。关于人为的因素、首先查看命令，并没有相关的kill记录。然后发现开发环境与测试环境的该进程基本上同时挂掉、并且都点了这两个环境的某个CI，然后这两个环境上的该进程都挂掉了，因此基本断定是CI操作杀掉了该进程。<br>被杀掉的进程名字为：<code>java -jar workorder-server.jar</code>，通过CI发布&amp;启动的进程名字为：<code>java -jar order-server.jar</code>。然后在点击order相关的CI时会执行如下操作：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mvn</span> <span class="string">clean</span> <span class="string">package</span> <span class="string">-pl</span> <span class="string">order-server</span> <span class="string">-am</span> <span class="string">-Dmaven.test.skip=true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">scp</span> <span class="string">order-server/target/order-server.jar</span> <span class="string">$&#123;user_dev&#125;@$&#123;nemt_host_dev&#125;:/opt/webapp/order-server/.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ssh</span> <span class="string">$&#123;user_dev&#125;@$&#123;nemt_host_dev&#125;</span> <span class="string">&#x27;kill -9 `pgrep -f order-server\.jar` ; echo 1&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ssh</span> <span class="string">$&#123;user_dev&#125;@$&#123;nemt_host_dev&#125;</span> <span class="string">&#x27;. /etc/profile ; cd /opt/webapp/order-server/ ; nohup java  -jar order-server.jar &gt;&gt; /dev/null 2&gt;&amp;1 &amp;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>问题就在<code>kill -9</code>上面，pgrep查出来的进程号有两个，所以执行order相关的CI时，顺带也把workorder干掉了。<br><img src="/images/pics/da602a93d6164e0f29ef2c7fc98b8d7d.png" alt="在这里插入图片描述"></p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>修改shell语句，让pgrep order-server时，只显示出order-server的进程号即可。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-09-01T18:48:09.000Z" title="9/2/2018, 2:48:09 AM">2018-09-02</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:56.817Z" title="2/9/2021, 11:03:56 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span> / </span><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">3 分钟读完 (大约406个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/09/02/01736cc13255.html">CentOS服务器的简单配置</a></p><div class="content"><h2 id="修改软件源"><a href="#修改软件源" class="headerlink" title="修改软件源"></a>修改软件源</h2><p>这里使用阿里云的源，阿里云的镜像地址为：<a target="_blank" rel="noopener" href="https://opsx.alibaba.com/mirror">https://opsx.alibaba.com/mirror</a><br>1、备份<br><code>mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</code></p>
<p>2、下载新的<code>CentOS-Base.repo</code> 到<code>/etc/yum.repos.d/</code><br>CentOS 5<br><code>wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-5.repo</code><br>或者<br><code>curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-5.repo</code><br>CentOS 6<br><code>wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</code><br>或者<br><code>curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</code><br>CentOS 7<br><code>wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</code><br>或者<br><code>curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</code></p>
<p>3、之后运行<code>yum makecache</code>生成缓存</p>
<h2 id="安装以及配置JDK"><a href="#安装以及配置JDK" class="headerlink" title="安装以及配置JDK"></a>安装以及配置JDK</h2><p>1、卸载预装的OpenJDK</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep jdk</span><br><span class="line"><span class="built_in">sudo</span> yum remove ****（软件包名，上条命令的输出结果）</span><br></pre></td></tr></table></figure>

<p>2、从Oracle官网下载JDK</p>
<p><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">下载地址</a></p>
<p>3、下载完成后，进行安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">sudo</span> rpm -ivh jdk-8u181-linux-x64.rpm</span><br><span class="line"><span class="comment"># 验证安装是否成功</span></span><br><span class="line">java -version </span><br></pre></td></tr></table></figure>
<h2 id="安装-配置Tomcat"><a href="#安装-配置Tomcat" class="headerlink" title="安装&amp;配置Tomcat"></a>安装&amp;配置Tomcat</h2><h3 id="安装操作如下"><a href="#安装操作如下" class="headerlink" title="安装操作如下"></a>安装操作如下</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirrors.hust.edu.cn/apache/tomcat/tomcat-8/v8.5.33/bin/apache-tomcat-8.5.33.tar.gz</span><br><span class="line">tar -xzvf apache-tomcat-8.5.33.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> vim /etc/profile</span><br><span class="line"><span class="comment"># 添加CATALINA_HOME到最后一行</span></span><br><span class="line"><span class="comment"># export CATALINA_HOME=/home/asahi/devtools/apache-tomcat-8.5.33</span></span><br><span class="line"><span class="comment"># 保存-退出</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
<h3 id="配置UTF-8字符集"><a href="#配置UTF-8字符集" class="headerlink" title="配置UTF-8字符集"></a>配置UTF-8字符集</h3><p>因为默认不使用UTF-8，所以我们在web中使用中文时，会出现乱码。<br>所要修改文件的位置：<code>conf/server.xml</code><br>文件需要修改的地方：<br><img src="/images/pics/63eb8da5b6d27c606443211ec83ad4c1.png" alt="这里写图片描述"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-06-06T02:09:27.000Z" title="6/6/2018, 10:09:27 AM">2018-06-06</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:54.651Z" title="2/9/2021, 11:03:54 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">5 分钟读完 (大约714个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/06/06/cafe1207008b.html">通过HTTP包来再次理解重定向与转发</a></p><div class="content"><blockquote>
<p>之所以去看它们之间数据包的差异并不是好奇。我理解它们之间的差异，但是我不知道该如何证明它们之间的差异。想了很久，我觉得去抓包，看它们之间数据包之间的差异，就是一个有力的证据。</p>
</blockquote>
<h2 id="预设"><a href="#预设" class="headerlink" title="预设"></a>预设</h2><p>总共有三个<code>servlet</code>，即<code>/ddgg_ssm/loginre/</code>、<code>/ddgg_ssm/loginzf</code>、<code>/ddgg_ssm/user/</code>，它们的作用依次为重定向到<code>/ddgg_ssm/user/</code>、转发到<code>/ddgg_ssm/user/</code>、显示一串字符。简要代码如下：<br><strong>重定向</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;/loginre&quot;)</span><br><span class="line">public class LoginController &#123;</span><br><span class="line">	@RequestMapping(&quot;/*&quot;)</span><br><span class="line">	@ResponseBody</span><br><span class="line">	public void printMsg(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			response.sendRedirect(&quot;/ddgg_ssm/user/&quot;);</span><br><span class="line">		&#125; catch (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>转发</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123;</span><br><span class="line">    request.getRequestDispatcher(&quot;/user/&quot;).forward(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>先进行的是重定向，再接着的是转发。</p>
<h2 id="数据包抓取结果以及简要的分析"><a href="#数据包抓取结果以及简要的分析" class="headerlink" title="数据包抓取结果以及简要的分析"></a>数据包抓取结果以及简要的分析</h2><p>重定向与转发的数据包如下：<br><img src="/images/pics/cd51fc4c098f0fc35b5eb26d9c3f8401.png" alt="重定向与转发的HTTP数据包分析"></p>
<p>首先是第一个数据包，请求<code>loginre</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /ddgg_ssm/loginre/ HTTP/1.1</span><br><span class="line">Host: 172.10.1.39:8080</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Linux; U; Android 7.0; zh-cn; Redmi Note 4X Build/NRD90M) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/61.0.3163.128 Mobile Safari/537.36 XiaoMi/MiuiBrowser/9.7.2</span><br><span class="line">x-miorigin: b</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,en-US;q=0.8</span><br><span class="line">Cookie: JSESSIONID=3AFB73B954FEA21EA30E9F1D5ECF63A4</span><br></pre></td></tr></table></figure>
<p>得到服务器的302重定向响应</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 </span><br><span class="line">Location: /ddgg_ssm/user/</span><br><span class="line">Content-Length: 0</span><br><span class="line">Date: Tue, 05 Jun 2018 09:04:57 GMT</span><br></pre></td></tr></table></figure>
<p>浏览器得到重定向的响应后，再请求<code>Location</code>中的<code>Servlet</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /ddgg_ssm/user/ HTTP/1.1</span><br><span class="line">Host: 172.10.1.39:8080</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Linux; U; Android 7.0; zh-cn; Redmi Note 4X Build/NRD90M) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/61.0.3163.128 Mobile Safari/537.36 XiaoMi/MiuiBrowser/9.7.2</span><br><span class="line">x-miorigin: b</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,en-US;q=0.8</span><br><span class="line">Cookie: JSESSIONID=3AFB73B954FEA21EA30E9F1D5ECF63A4</span><br></pre></td></tr></table></figure>
<p>最后再得到服务器的响应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/html;charset=ISO-8859-1</span><br><span class="line">Content-Length: 12</span><br><span class="line">Date: Tue, 05 Jun 2018 09:04:57 GMT</span><br><span class="line"></span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>
<p>此时浏览器的地址栏已经变成了<code>/ddgg_ssm/user/</code>。</p>
<hr>
<p>而后续的转发，只有两个数据包，一个请求与一个响应。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /ddgg_ssm/loginzf HTTP/1.1</span><br><span class="line">Host: 172.10.1.39:8080</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Linux; U; Android 7.0; zh-cn; Redmi Note 4X Build/NRD90M) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/61.0.3163.128 Mobile Safari/537.36 XiaoMi/MiuiBrowser/9.7.2</span><br><span class="line">x-miorigin: b</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,en-US;q=0.8</span><br><span class="line">Cookie: JSESSIONID=3AFB73B954FEA21EA30E9F1D5ECF63A4</span><br></pre></td></tr></table></figure>
<p>得到的响应是<code>/ddgg_ssm/user/</code>所写入的内容<code>Hello world!</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/html;charset=ISO-8859-1</span><br><span class="line">Content-Length: 12</span><br><span class="line">Date: Tue, 05 Jun 2018 09:05:28 GMT</span><br><span class="line"></span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>
<h2 id="再贴一个结论吧"><a href="#再贴一个结论吧" class="headerlink" title="再贴一个结论吧"></a>再贴一个结论吧</h2><ul>
<li>转发在服务器端完成的；重定向在客户端完成</li>
<li>转发的是同一次请求；重定向是两次不同请求</li>
<li>转发地址栏没有变化；重定向地址栏有变化</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-05-07T07:06:56.000Z" title="5/7/2018, 3:06:56 PM">2018-05-07</time>发表</span><span class="level-item"><time dateTime="2022-01-01T07:39:24.942Z" title="1/1/2022, 3:39:24 PM">2022-01-01</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">17 分钟读完 (大约2480个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/07/1da1a35aca2b.html">JDBC的使用笔记</a></p><div class="content">下午花了三四个小时，在慕课网上看了看关于JDBC的两个系列的视频，跟着做了做。因为之前也看过，所以一直都记得有这么一个视频存在，但是唯一不足的是没写上一些笔记。写个简易的学习笔记，加深一下对其中一些知识的理解，以后翻起来就不用去看视频了，看这个就好。还记录下自己在学习过程中所遇到的一些疑问以及自己所</div><a class="article-more button is-small is-size-7" href="/2018/05/07/1da1a35aca2b.html#more">阅读更多</a></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">上一页</a></div><div class="pagination-next is-invisible is-hidden-mobile"><a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/page/3/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">1</a></li><li><a class="pagination-link is-current" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="M系列MacBook连接l2tp时失败的问题修复"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">M系列MacBook连接l2tp时失败的问题修复</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rust学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rust学习笔记</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/b0874d97f2ec.html"><img src="/images/pics/8a16be7bbc191e48a6e5b08755f591ec.png" alt="01.AI概览"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/b0874d97f2ec.html">01.AI概览</a></p><p class="categories"><a href="/categories/AI/">AI</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calico证书学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calico证书学习笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="如何在YAML文件中进行优雅地换行"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">如何在YAML文件中进行优雅地换行</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a><p class="is-size-7"><span>&copy; 2024 遇寻</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>