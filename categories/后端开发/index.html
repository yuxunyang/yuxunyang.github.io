<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>分类: 后端开发 - 遇寻笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="遇寻笔记"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="遇寻笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:type" content="website"><meta property="og:title" content="遇寻笔记"><meta property="og:url" content="https://eucham.me/"><meta property="og:site_name" content="遇寻笔记"><meta property="og:description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/img/og_image.png"><meta property="article:author" content="遇寻"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://eucham.me/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me"},"headline":"遇寻笔记","image":["https://eucham.me/img/og_image.png"],"author":{"@type":"Person","name":"遇寻"},"publisher":{"@type":"Organization","name":"遇寻笔记","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"No. I&#39;ll bring me back a souvenir."}</script><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">分类</a></li><li class="is-active"><a href="#" aria-current="page">后端开发</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-02-01T09:20:31.000Z" title="2/1/2020, 5:20:31 PM">2020-02-01</time>发表</span><span class="level-item"><time dateTime="2021-12-31T15:42:52.051Z" title="12/31/2021, 11:42:52 PM">2021-12-31</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">28 分钟读完 (大约4201个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/02/01/3831abf370d2.html">真实记录一次对项目中代码的重构过程</a></p><div class="content">这份记录来自对项目中下单接口重构，详细记录了每一步操作、以及运用到的一些方法。力求能够最大程度将当时的过程展现出来。准备重构中的每次修改都需要进行测试，用来验证修改是否正确，因此单元测试是一个非常好的选择。单元测试单元测试中可以进行mock操作，从烦人的token中摆脱出来，做到在任何人的IDE里面</div><a class="article-more button is-small is-size-7" href="/2020/02/01/3831abf370d2.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-02-01T09:17:09.000Z" title="2/1/2020, 5:17:09 PM">2020-02-01</time>发表</span><span class="level-item"><time dateTime="2021-12-31T15:45:00.381Z" title="12/31/2021, 11:45:00 PM">2021-12-31</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span> / </span><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">3 分钟读完 (大约389个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/02/01/ccf7f43b1e3f.html">云主机如何应对大批量的漏洞测试请求</a></p><div class="content">云主测试工具在做测试，通过日志发现，其搜寻的漏洞内容包括：SQL注入、XSS等。由于其请求的频率过高，以致于nginx做转发出现502错误，造成了宕机的假象。正对这种情况，想到了以下两种处理方式。wordpress拒绝请</div><a class="article-more button is-small is-size-7" href="/2020/02/01/ccf7f43b1e3f.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-12-18T10:46:17.000Z" title="12/18/2019, 6:46:17 PM">2019-12-18</time>发表</span><span class="level-item"><time dateTime="2021-12-31T16:36:34.867Z" title="1/1/2022, 12:36:34 AM">2022-01-01</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">11 分钟读完 (大约1702个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/12/18/16aa9f74bf70.html">理解Servlet与Filter的关系与设计思路</a></p><div class="content">什么是Servlet对一个HTTP请求的正常的处理流程是：发送HTTP请求服务端的HTTP服务器收到请求调用业务逻辑返回HTTP响应产生了下面3个问题：HTTP 服务器怎么知道要调用哪个业务逻辑，也就是 Java 类的哪个方法呢？HTTP服务器可以被设计成收到请求后，接续寻找该请求的处理逻辑，但是这</div><a class="article-more button is-small is-size-7" href="/2019/12/18/16aa9f74bf70.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-08-26T15:45:31.000Z" title="8/26/2019, 11:45:31 PM">2019-08-26</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:31.469Z" title="2/9/2021, 11:03:31 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">3 分钟读完 (大约375个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/08/26/505be8700b2a.html">处理后端与Android之间WebSocket连接经常断开的情况</a></p><div class="content"><h2 id="nginx配置ws转发"><a href="#nginx配置ws转发" class="headerlink" title="nginx配置ws转发"></a>nginx配置ws转发</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> <span class="regexp">~ /(mq|ws)/</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">600s</span>;</span><br><span class="line">    <span class="attribute">proxy_send_timeout</span> <span class="number">600s</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_pass</span> http://mq-service;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加头部信息，这两个字段表示请求服务器升级协议为WebSocket：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection $connection_upgrade;</span><br></pre></td></tr></table></figure>

<p>默认情况下，连接将会在无数据传输60秒后关闭，proxy_read_timeout参数可以延长这个时间。源站通过定期发送ping帧以保持连接并确认连接是否还在使用。</p>
<ul>
<li><p><code>proxy_read_timeout</code></p>
<p>  该指令设置与代理服务器的读超时时间。它决定了nginx会等待多长时间来获得请求的响应。 这个时间不是获得整个response的时间，而是两次reading操作的时间。</p>
</li>
<li><p><code>proxy_send_timeout</code></p>
<p>  这个指定设置了发送请求给upstream服务器的超时时间。超时设置不是为了整个发送期间，而是在两次write操作期间。 如果超时后，upstream没有收到新的数据，nginx会关闭连接</p>
</li>
</ul>
<h2 id="Android-微信小程序心跳机制"><a href="#Android-微信小程序心跳机制" class="headerlink" title="Android&#x2F;微信小程序心跳机制"></a>Android&#x2F;微信小程序心跳机制</h2><ol>
<li>定时发送心跳包。如果发送失败，就进行重连。</li>
<li>一些关键的操作，可以在重连后，根据实际情况，立刻进行调用</li>
</ol>
<p>参考：<br><a target="_blank" rel="noopener" href="https://www.xncoding.com/2018/03/12/fullstack/nginx-websocket.html">https://www.xncoding.com/2018/03/12/fullstack/nginx-websocket.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-08-19T23:52:47.000Z" title="8/20/2019, 7:52:47 AM">2019-08-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:00.617Z" title="2/9/2021, 11:03:00 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">6 分钟读完 (大约850个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/08/20/f51277d4e8ec.html">WebSocket多实例部署时的一种解决方案</a></p><div class="content"><blockquote>
<p>需要用到k8s进行扩展，在变更容器数量的时候，希望达到不改动代码。</p>
</blockquote>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><ol>
<li>Client与哪一个WS服务建立连接是不知道的</li>
<li>当需要发送WS消息时，使用URL发送给所有的WS模块不可取（一旦容器数量改变，还需要修改代码，即增加新的URL）</li>
</ol>
<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="/images/pics/d99a977ac93be52e808233ae11cbf26b.png"></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>建立连接部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ServerEndpoint(value = &quot;/ws/&#123;role&#125;/&#123;token&#125;&quot;, configurator = EndpointConf.class)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WsController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARAM_TOKEN</span> <span class="operator">=</span> <span class="string">&quot;token&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARAM_ROLE</span> <span class="operator">=</span> <span class="string">&quot;role&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; ROLE_SET = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(</span><br><span class="line">            Arrays.asList(AccountType.DRIVER.name().toLowerCase(), AccountType.PASSENGER.name().toLowerCase())</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WsService wsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(<span class="meta">@PathParam(PARAM_ROLE)</span> String role,</span></span><br><span class="line"><span class="params">                       <span class="meta">@PathParam(PARAM_TOKEN)</span> String token, Session session)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ROLE_SET.contains(role)) &#123;</span><br><span class="line">            <span class="comment">// 登陆类型不正确</span></span><br><span class="line">            log.warn(<span class="string">&quot;token:&#123;&#125; login role error, role:&#123;&#125;&quot;</span>, token, role);</span><br><span class="line">            wsService.sendMessage(session, wsService.authFailMsg());</span><br><span class="line">            session.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> wsService.getUserIdByToken(role, token);</span><br><span class="line">        <span class="keyword">if</span> (userId == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 根据token找不到userId</span></span><br><span class="line">            log.warn(<span class="string">&quot;token:&#123;&#125; login error, you are offline&quot;</span>, token);</span><br><span class="line">            wsService.sessionMap.remove(token);</span><br><span class="line">            wsService.sendMessage(session, wsService.authFailMsg());</span><br><span class="line">            session.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;【&#123;&#125;】, token : &#123;&#125; open websocket connect&quot;</span>, wsService.showInfoAboutToken(token), token);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除此token已有session</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">oldSession</span> <span class="operator">=</span> wsService.sessionMap.get(token);</span><br><span class="line">        <span class="keyword">if</span> (oldSession != <span class="literal">null</span>) &#123;</span><br><span class="line">            wsService.sessionMap.remove(token);</span><br><span class="line">            wsService.sendMessage(oldSession, wsService.duplicateLoginMsg());</span><br><span class="line">            oldSession.close();</span><br><span class="line">        &#125;</span><br><span class="line">        wsService.sessionMap.put(token, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(<span class="meta">@PathParam(PARAM_ROLE)</span> String role,</span></span><br><span class="line"><span class="params">                        <span class="meta">@PathParam(PARAM_TOKEN)</span> String token, Session session)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;close connection. 【&#123;&#125;】, token: &#123;&#125;&quot;</span>, wsService.showInfoAboutToken(token), token);</span><br><span class="line">        wsService.sessionMap.remove(token);</span><br><span class="line">        wsService.sendMessage(session, wsService.authFailMsg());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(<span class="meta">@PathParam(PARAM_ROLE)</span> String role,</span></span><br><span class="line"><span class="params">                        <span class="meta">@PathParam(PARAM_TOKEN)</span> String token, Session session, Throwable error)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;【&#123;&#125;】, token : &#123;&#125;, sessionId: &#123;&#125;, websocket error: &#123;&#125;&quot;</span>, wsService.showInfoAboutToken(token), token, session.getId(), error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(<span class="meta">@PathParam(PARAM_ROLE)</span> String role,</span></span><br><span class="line"><span class="params">                          <span class="meta">@PathParam(PARAM_TOKEN)</span> String token, String message, Session session)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;receive from 【&#123;&#125;】, token : &#123;&#125;, message: &#123;&#125;&quot;</span>,wsService.showInfoAboutToken(token), token, message);</span><br><span class="line">        <span class="keyword">if</span> (!ROLE_SET.contains(role)) &#123;</span><br><span class="line">            <span class="comment">// 登陆类型不正确</span></span><br><span class="line">            wsService.sendMessage(session, wsService.authFailMsg());</span><br><span class="line">            session.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//司机心跳缓存</span></span><br><span class="line">        <span class="keyword">if</span>(role.equals(AccountType.DRIVER.name().toLowerCase()))&#123;</span><br><span class="line">            wsService.updateHeartBeat(token);</span><br><span class="line">        &#125;</span><br><span class="line">        wsService.actionHandle(session, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接收各个模块发送WS的MQ消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WsMqMsgListener</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WsService wsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Action <span class="title function_">consume</span><span class="params">(Message message, ConsumeContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;receive tag:&#123;&#125;, body:&#123;&#125;&quot;</span>, message.getTag(), <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//消息体执行内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">bodyStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(bodyStr))</span><br><span class="line">                <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line"></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">body</span> <span class="operator">=</span> JSONObject.parseObject(bodyStr);</span><br><span class="line">            log.info(<span class="string">&quot;got a websocket mq msg&quot;</span>);</span><br><span class="line">            WebSocketMqMsg.<span class="type">Body</span> <span class="variable">wsMqBody</span> <span class="operator">=</span> JSON.toJavaObject(body, WebSocketMqMsg.Body.class);</span><br><span class="line">            wsService.sendMessage(wsMqBody);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">&quot;消费MQ消息失败，原因是：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="comment">//消费失败</span></span><br><span class="line">            <span class="keyword">return</span> Action.ReconsumeLater;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>收到各个模块的MQ消息后，提取出发送对象、发送内容，然后进行发送。如果没有找到对应客户端的连接，那么将抛弃掉该WS消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, Session&gt; sessionMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(WebSocketMqMsg.Body message)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (message.getIds().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Integer id : message.getIds()) &#123;</span><br><span class="line">            cachedThreadPool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">maxIdx</span> <span class="operator">=</span> message.getRole().equals(AccountType.PASSENGER.name()) ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= maxIdx; i++) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(Constants.CACHE_USER_TOKEN_LOGIN_PREFIX,</span><br><span class="line">                            message.getRole(),</span><br><span class="line">                            LoginType.valueOf((<span class="type">short</span>) i), id);</span><br><span class="line">                    log.info(<span class="string">&quot;key is &#123;&#125;&quot;</span>, key);</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> cacheService.getVal(key);</span><br><span class="line">                    log.info(<span class="string">&quot;token is &#123;&#125;&quot;</span>, token == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : token);</span><br><span class="line"></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">sendOfflineMsg</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.isEmpty(token)) &#123;</span><br><span class="line">                        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> sessionMap.get(token);</span><br><span class="line">                        log.info(<span class="string">&quot;session is &#123;&#125;&quot;</span>, session == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : <span class="string">&quot;not null&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (session == <span class="literal">null</span> || !sendMessage(session,</span><br><span class="line">                                message.getMsg().toString())) &#123;</span><br><span class="line">                            sendOfflineMsg = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        sendOfflineMsg = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    log.info(<span class="string">&quot;ws msg: role -&gt; 【&#123;&#125;】, id -&gt; 【&#123;&#125;】, terminal -&gt; 【&#123;&#125;】, status -&gt; 【&#123;&#125;】&quot;</span>,</span><br><span class="line">                            message.getRole(),</span><br><span class="line">                            id,</span><br><span class="line">                            i == <span class="number">1</span> ? LoginType.APP.name() : LoginType.WECHAT_APPLET.name(),</span><br><span class="line">                            sendOfflineMsg ? <span class="string">&quot;offline&quot;</span> : <span class="string">&quot;online&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(Session session, String message)</span> &#123;</span><br><span class="line">    session.getBasicRemote().sendPong();</span><br><span class="line">    <span class="keyword">if</span> (!session.isOpen()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        session.getBasicRemote().sendText(message);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;send message to &#123;&#125; error &#123;&#125;&quot;</span>, session.getId(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>按照上述架构完成的多实例WS服务部署，可以解决前面提到的两个问题。MQ作为一个中间这的角色，发挥出了它的作用。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-22T00:28:47.000Z" title="7/22/2019, 8:28:47 AM">2019-07-22</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:34.709Z" title="2/9/2021, 11:03:34 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">22 分钟读完 (大约3371个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/22/10be91c35e3d.html">PageAble分页注解在并发环境下遇到的bug</a></p><div class="content"><h2 id="数据库结构及数据说明"><a href="#数据库结构及数据说明" class="headerlink" title="数据库结构及数据说明"></a>数据库结构及数据说明</h2><p><strong>结构</strong></p>
<p><img src="/images/pics/070e2763bff41215ff130061df69651f.png" alt="结构"></p>
<p><strong>数据</strong></p>
<p><img src="/images/pics/8840ebe6eeaea53944a5914ba2e2a828.png" alt="数据"></p>
<p><strong>对应类</strong></p>
<p><img src="/images/pics/1b5e6cfda1f976486043e1c50bb9a6bc.png" alt="对应类"></p>
<h2 id="接口详细说明"><a href="#接口详细说明" class="headerlink" title="接口详细说明"></a>接口详细说明</h2><p><strong>获取分页数据接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;get-system-busy&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getPageableUsers</span><span class="params">(<span class="meta">@RequestParam</span> Integer page, <span class="meta">@RequestParam</span> Integer size)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> testService.getSystemBusy(page, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PageAble</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getSystemBusy</span><span class="params">(Integer page, Integer size)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> testMapper.getSystemBusy();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select gender from user&quot;)</span></span><br><span class="line">List&lt;User&gt; <span class="title function_">getSystemBusy</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>根据id获取用户详情</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;get-one-user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getOneUserById</span><span class="params">(<span class="meta">@RequestParam</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> testService.getOneUser(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getOneUser</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> testMapper.getOneUser(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from user where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">User <span class="title function_">getOneUser</span><span class="params">(Integer id)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>获取所有司机列表</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;get-all-drivers&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getAllDrivers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> testService.getAllDrivers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getAllDrivers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> testMapper.getAllDrivers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from driver&quot;)</span></span><br><span class="line">List&lt;Driver&gt; <span class="title function_">getAllDrivers</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>获取所有用户的名字</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;get-username-list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getUsernameList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> testService.getUsernameList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getUsernameList</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; users = testMapper.getAllUsers();</span><br><span class="line">    List&lt;String&gt; names = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">        names.add(user.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> names;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from user&quot;)</span></span><br><span class="line">List&lt;User&gt; <span class="title function_">getAllUsers</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h2 id="分页相关文件说明"><a href="#分页相关文件说明" class="headerlink" title="分页相关文件说明"></a>分页相关文件说明</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">base-service</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── com</span><br><span class="line">                └── haylion</span><br><span class="line">                    └── realTimeBus</span><br><span class="line">                        ├── advice</span><br><span class="line">                        │   └── SystemAdvice.java # 分页注解实现</span><br><span class="line">                        ├── annotation</span><br><span class="line">                        │   └── PageAble.java # 分页注解</span><br><span class="line">                        ├── bean</span><br><span class="line">                        │   ├── BaseModel.java # 含有id熟悉的基础bean</span><br><span class="line">                        │   ├── Condition.java # 条件查询时的条件</span><br><span class="line">                        │   ├── ResultPageView.java # 被分页注解标记后，改函数返回的对象，将被包装成该对象(一个普通的bean类)</span><br><span class="line">                        │   └── Sort.java # 查询时排序方式</span><br><span class="line">                        ├── interceptor</span><br><span class="line">                            └── sql</span><br><span class="line">                                ├── MyPageHelper.java # 覆盖afterAll后的PageHelper，在MyPageInterceptor中进行调用</span><br><span class="line">                                ├── MyPageInterceptor.java # PageHelper中拦截器PageInterceptor的源码，有自定义修改</span><br><span class="line">                                └── SqlLogHandler.java # 把将要执行的SQL打印出来，集成在MyPageInterceptor中</span><br></pre></td></tr></table></figure>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个注解主要是对<code>PageHelper</code>插件的封装，这个插件的工作流程可参考：<a target="_blank" rel="noopener" href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/en/HowToUse.md">此链接</a>。</p>
<p>需要做的是在mybatis的配置文件中加入一个拦截器（<a target="_blank" rel="noopener" href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/src/main/java/com/github/pagehelper/PageInterceptor.java">拦截器的源代码链接</a>）。MyBatis在执行query语句时，会触发该拦截器，然后得到的数据是处理过的分页后的数据。</p>
<p>在上述链接中有一个注意事项，如下：</p>
<blockquote>
<p><strong>什么时候会导致不安全的分页？</strong></p>
</blockquote>
<p><code>PageHelper</code> 方法使用了静态的 <code>ThreadLocal</code> 参数，分页参数和线程是绑定的。<br>只要你可以保证在 <code>PageHelper</code> 方法调用后紧跟 MyBatis 查询方法，这就是安全的。因为 <code>PageHelper</code> 在 <code>finally</code> 代码段中自动清除了 <code>ThreadLocal</code> 存储的对象。<br>如果代码在进入 <code>Executor</code> 前发生异常，就会导致线程不可用，这属于人为的 Bug（例如接口方法和 XML 中的不匹配，导致找不到 <code>MappedStatement</code> 时），<br>这种情况由于线程不可用，也不会导致 <code>ThreadLocal</code> 参数被错误的使用。<br>但是如果你写出下面这样的代码，就是不安全的用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PageHelper.startPage(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">List&lt;Country&gt; list;</span><br><span class="line"><span class="keyword">if</span>(param1 != <span class="literal">null</span>)&#123;</span><br><span class="line">    list = countryMapper.selectIf(param1);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Country&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种情况下由于 param1 存在 null 的情况，就会导致 PageHelper 生产了一个分页参数，但是没有被消费，这个参数就会一直保留在这个线程上。当这个线程再次被使用时，就可能导致不该分页的方法去消费这个分页参数，这就产生了莫名其妙的分页。<br>上面这个代码，应该写成下面这个样子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Country&gt; list;</span><br><span class="line"><span class="keyword">if</span>(param1 != <span class="literal">null</span>)&#123;</span><br><span class="line">    PageHelper.startPage(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">    list = countryMapper.selectIf(param1);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Country&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种写法就能保证安全。<br>如果你对此不放心，你可以手动清理 <code>ThreadLocal</code> 存储的分页参数，可以像下面这样使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Country&gt; list;</span><br><span class="line"><span class="keyword">if</span>(param1 != <span class="literal">null</span>)&#123;</span><br><span class="line">    PageHelper.startPage(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        list = countryMapper.selectAll();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        PageHelper.clearPage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Country&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这么写很不好看，而且没有必要。</p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>直接在方法上加上<code>@PageAble</code>注解，并在该方法中传入两个参数，分别为<code>page</code>和<code>size</code>，在该方法返回后，会得到一个<code>ResultPageView</code>封装对象，其中包含分页相关信息。</p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p><img src="/images/pics/145951cdde808632718a5ad9d28e2660.png" alt="流程图"><br> <code>SystemAdvice</code>定义一个切面，切点是<code>@annotation(com.haylion.realTimeBus.annotation.PageAble)</code>。也就是说，每个被<code>@PageAble</code>注解过的方法，都将执行下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAGE_ABLE</span> <span class="operator">=</span> <span class="string">&quot;@annotation(com.haylion.realTimeBus.annotation.PageAble)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Around(PAGE_ABLE)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doAroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;execute method : &quot;</span> + proceedingJoinPoint.getSignature().getName());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 进入被@PageAble注解的方法前的准备工作</span></span><br><span class="line">        prepare(proceedingJoinPoint);</span><br><span class="line">        <span class="comment">// 执行被@PageAble注解的方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line">        <span class="comment">// 执行被@PageAble注解的方法后，执行扫尾工作</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> after(obj);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;aspect execute error : &quot;</span>, throwable);</span><br><span class="line">        <span class="keyword">throw</span> throwable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>准备工作</strong>：主要是获取<code>page</code>和<code>size</code>的值，然后调用<code>PageHelper</code>的<code>startPage</code>方法，初始化分页信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PageAble中page和size的默认值分别是1和20</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PageAble &#123;</span><br><span class="line">    String <span class="title function_">pageSizeName</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;size&quot;</span>;</span><br><span class="line">    String <span class="title function_">pageNumName</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;page&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">pageSize</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">20</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">pageNum</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 准备分页</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> point.getSignature();</span><br><span class="line">    <span class="type">MethodSignature</span> <span class="variable">methodSignature</span> <span class="operator">=</span> (MethodSignature) signature;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> methodSignature.getMethod();</span><br><span class="line">    <span class="type">PageAble</span> <span class="variable">pageAble</span> <span class="operator">=</span> targetMethod.getAnnotation(PageAble.class);</span><br><span class="line">    <span class="type">String</span> <span class="variable">numName</span> <span class="operator">=</span> pageAble.pageNumName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">sizeName</span> <span class="operator">=</span> pageAble.pageSizeName();</span><br><span class="line">    <span class="comment">// 先获取默认的page和size值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pageNo</span> <span class="operator">=</span> pageAble.pageNum();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> pageAble.pageSize();</span><br><span class="line">    Object[] paramValues = point.getArgs();</span><br><span class="line">    String[] paramNames = methodSignature.getParameterNames();</span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> paramNames.length;</span><br><span class="line">    <span class="comment">// 遍历该方法中的所有参数，如果有page和size信息，那么就覆盖默认值为用户传入的值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (paramNames[i].equals(numName)) &#123;</span><br><span class="line">            pageNo = (Integer) paramValues[i];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramNames[i].equals(sizeName)) &#123;</span><br><span class="line">            pageSize = (Integer) paramValues[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 该方法利用ThreadLocal在本线程中插入一个分页信息的对象Page</span></span><br><span class="line">    PageHelper.startPage(pageNo, pageSize);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// startPage()方法的最终实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; Page&lt;E&gt; <span class="title function_">startPage</span><span class="params">(<span class="type">int</span> pageNum, <span class="type">int</span> pageSize, <span class="type">boolean</span> count, Boolean reasonable, Boolean pageSizeZero)</span> &#123;</span><br><span class="line">    Page&lt;E&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;E&gt;(pageNum, pageSize, count);</span><br><span class="line">    page.setReasonable(reasonable);</span><br><span class="line">    page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    <span class="comment">//当已经执行过orderBy的时候</span></span><br><span class="line">    Page&lt;E&gt; oldPage = getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (oldPage != <span class="literal">null</span> &amp;&amp; oldPage.isOrderByOnly()) &#123;</span><br><span class="line">      	page.setOrderBy(oldPage.getOrderBy());</span><br><span class="line">    &#125;</span><br><span class="line">    setLocalPage(page);</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setLocalPage</span><span class="params">(Page page)</span> &#123;</span><br><span class="line">  	LOCAL_PAGE.set(page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Page&gt; LOCAL_PAGE = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Page&gt;();</span><br></pre></td></tr></table></figure>

<p><strong>进入SQL拦截器（即<code>MyPageInterceptor</code>）</strong>：这个拦截器中主要是PageHelper执行分页的步骤，相关步骤可分为：</p>
<ul>
<li><p>判断是否需要进行分页。判断的条件为<code>!dialect.skip(ms, parameter, rowBounds)</code>，其实现为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">skip</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(ms.getId().endsWith(MSUtils.COUNT))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;在系统中发现了多个分页插件，请检查系统配置!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//设置默认的 count 列</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtil.isEmpty(page.getCountColumn()))&#123;</span><br><span class="line">            page.setCountColumn(pageParams.getCountColumn());</span><br><span class="line">        &#125;</span><br><span class="line">        autoDialect.initDelegateDialect(ms);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，通过判断<code>Page</code>是否为空来决定是否进行分页，<code>Page</code>则从本线程中获取，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PageHelper.java</span></span><br><span class="line"><span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line"></span><br><span class="line"><span class="comment">//PageParams.java</span></span><br><span class="line"><span class="keyword">public</span> Page <span class="title function_">getPage</span><span class="params">(Object parameterObject, RowBounds rowBounds)</span> &#123;</span><br><span class="line">		<span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> PageHelper.getLocalPage();</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PageMethod.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">getLocalPage</span><span class="params">()</span> &#123;</span><br><span class="line">  	<span class="keyword">return</span> LOCAL_PAGE.get();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Page&gt; LOCAL_PAGE = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Page&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取数据的总条数。在进入此项前，会进行判断是否需要进行总数查询。这里假设进行总数查询。从源SQL解析出获取数据总条数的代码调试如下：</p>
<p><img src="/images/pics/3ae925cf7c0ded7f9b2fe84c482cd58e.png" alt="调试"></p>
<p>log如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2019-06-14 09:37:31.475 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - ==&gt;  Preparing: SELECT count(0) FROM advertising </span><br><span class="line">2019-06-14 09:37:31.490 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - ==&gt; Parameters: </span><br><span class="line">2019-06-14 09:37:31.507 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &lt;==      Total: 1</span><br><span class="line">2019-06-14 09:37:31.508  INFO [http-nio-8880-exec-1] c.h.r.i.s.SqlLogHandler - com.haylion.realTimeBus.dao.AdvertisingMapper.getByConditionList_COUNT:</span><br><span class="line">select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising</span><br><span class="line">&lt;cost time is :45 ms &gt;</span><br><span class="line">2019-06-14 09:37:31.512 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - ==&gt;  Preparing: select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising LIMIT ? </span><br><span class="line">2019-06-14 09:37:31.512 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - ==&gt; Parameters: 1(Integer)</span><br><span class="line">2019-06-14 09:37:31.519 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &lt;==      Total: 1</span><br><span class="line">2019-06-14 09:37:31.520  INFO [http-nio-8880-exec-1] c.h.r.i.s.SqlLogHandler - com.haylion.realTimeBus.dao.AdvertisingMapper.getByConditionList:</span><br><span class="line">select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising LIMIT 1 </span><br><span class="line">&lt;cost time is :8 ms &gt;</span><br><span class="line">2019-06-14 09:37:31.591  INFO [http-nio-8880-exec-1] c.h.r.f.a.ResponseAdvice - Trace log is ====&gt;  &#123;&quot;url&quot;:&quot;/advertising/getAdvertisingList&quot;,&quot;httpMethod&quot;:&quot;GET&quot;,&quot;reqHeader&quot;:&#123;&quot;host&quot;:&quot;192.168.12.39:8880&quot;,&quot;content-type&quot;:&quot;application/json&quot;,&quot;user-agent&quot;:&quot;curl/7.54.0&quot;,&quot;accept&quot;:&quot;*/*&quot;,&quot;token&quot;:&quot;fe20027352f8250571436f471a988b4d&quot;&#125;,&quot;reqParams&quot;:&quot;page=1&amp;size=1&quot;,&quot;requestBody&quot;:&quot;&quot;,&quot;respParams&quot;:&quot;&#123;\&quot;code\&quot;:200,\&quot;message\&quot;:\&quot;success\&quot;,\&quot;data\&quot;:&#123;\&quot;total\&quot;:9,\&quot;current\&quot;:1,\&quot;pageCount\&quot;:9,\&quot;list\&quot;:[&#123;\&quot;settlementType\&quot;:0,\&quot;imagesUrl\&quot;:\&quot;xxxxxxx\&quot;,\&quot;advertisingName\&quot;:\&quot;hello kitty 111\&quot;,\&quot;advertiserName\&quot;:\&quot;暁\&quot;,\&quot;advertiserId\&quot;:0,\&quot;createTimeymdhm_Str\&quot;:\&quot;2019-06-10 17:27\&quot;,\&quot;advertisingType\&quot;:0,\&quot;createTime\&quot;:1560158854000,\&quot;advertisingPosition\&quot;:0,\&quot;auditStatus\&quot;:4,\&quot;createUser\&quot;:1,\&quot;id\&quot;:0,\&quot;advertiserUrl\&quot;:\&quot;xxxxx\&quot;,\&quot;createTimeStr\&quot;:\&quot;2019-06-10 17:27:34\&quot;&#125;]&#125;&#125;&quot;,&quot;startTime&quot;:1560476250978,&quot;spendTime&quot;:592&#125;</span><br></pre></td></tr></table></figure>

<p>获取完总数后，会进行判断是否有分页的必要。</p>
</li>
<li><p>分页查询。这里假设有分页的必要。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用方言获取分页 sql</span></span><br><span class="line"><span class="type">String</span> <span class="variable">pageSql</span> <span class="operator">=</span> dialect.getPageSql(ms, boundSql, parameter, rowBounds, pageKey);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPageSql</span><span class="params">(MappedStatement ms, BoundSql boundSql, Object parameterObject, RowBounds rowBounds, CacheKey pageKey)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql();</span><br><span class="line">    <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> getLocalPage();</span><br><span class="line">    <span class="comment">//支持 order by</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">orderBy</span> <span class="operator">=</span> page.getOrderBy();</span><br><span class="line">    <span class="keyword">if</span> (StringUtil.isNotEmpty(orderBy)) &#123;</span><br><span class="line">        pageKey.update(orderBy);</span><br><span class="line">        sql = OrderByParser.converToOrderBySql(sql, orderBy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (page.isOrderByOnly()) &#123;</span><br><span class="line">      	<span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// 这是一个抽象方法，会根据具体的数据库，调用不同的实现方法，来在原SQL语句上，加上对应的分页语句</span></span><br><span class="line">    <span class="keyword">return</span> getPageSql(sql, page, pageKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体支持的数据库如下：</p>
<p><img src="/images/pics/468ac30f9649c89d1fcd520080c4db7d.png"></p>
<p>Oracle的分页实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPageSql</span><span class="params">(String sql, Page page, CacheKey pageKey)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sqlBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(sql.length() + <span class="number">120</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot;SELECT * FROM ( &quot;</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; SELECT TMP_PAGE.*, ROWNUM ROW_ID FROM ( &quot;</span>);</span><br><span class="line">    sqlBuilder.append(sql);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; ) TMP_PAGE WHERE ROWNUM &lt;= ? &quot;</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; ) WHERE ROW_ID &gt; ? &quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> sqlBuilder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MySQL的分页实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPageSql</span><span class="params">(String sql, Page page, CacheKey pageKey)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sqlBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(sql.length() + <span class="number">14</span>);</span><br><span class="line">    sqlBuilder.append(sql);</span><br><span class="line">    <span class="keyword">if</span> (page.getStartRow() == <span class="number">0</span>) &#123;</span><br><span class="line">      	sqlBuilder.append(<span class="string">&quot; LIMIT ? &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	sqlBuilder.append(<span class="string">&quot; LIMIT ?, ? &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    pageKey.update(page.getPageSize());</span><br><span class="line">    <span class="keyword">return</span> sqlBuilder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>保存分页查询后的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// resultList是分页查询后的数据列表</span></span><br><span class="line"><span class="comment">// afterPage的返回值是有两种情况，但是都可以被转成List</span></span><br><span class="line"><span class="keyword">return</span> dialect.afterPage(resultList, parameter, rowBounds);</span><br><span class="line"></span><br><span class="line"><span class="comment">// dialect.afterPage()方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">afterPage</span><span class="params">(List pageList, Object parameterObject, RowBounds rowBounds)</span> &#123;</span><br><span class="line">    <span class="comment">//这个方法即使不分页也会被执行，所以要判断 null</span></span><br><span class="line">    <span class="type">AbstractHelperDialect</span> <span class="variable">delegate</span> <span class="operator">=</span> autoDialect.getDelegate();</span><br><span class="line">    <span class="keyword">if</span>(delegate != <span class="literal">null</span>)&#123;</span><br><span class="line">      	<span class="keyword">return</span> delegate.afterPage(pageList, parameterObject, rowBounds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pageList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// delegate.afterPage()方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">afterPage</span><span class="params">(List pageList, Object parameterObject, RowBounds rowBounds)</span> &#123;</span><br><span class="line">    <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="literal">null</span>) &#123;</span><br><span class="line">      	<span class="keyword">return</span> pageList;</span><br><span class="line">    &#125;</span><br><span class="line">    page.addAll(pageList);</span><br><span class="line">    <span class="keyword">if</span> (!page.isCount()) &#123;</span><br><span class="line">      	page.setTotal(-<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((page.getPageSizeZero() != <span class="literal">null</span> &amp;&amp; page.getPageSizeZero()) &amp;&amp; page.getPageSize() == <span class="number">0</span>) &#123;</span><br><span class="line">      	page.setTotal(pageList.size());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(page.isOrderByOnly())&#123;</span><br><span class="line">      	page.setTotal(pageList.size());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这里有一个问题是，如果delegate不为空，那么返回的是<code>Page</code>，但是我们在调用<code>xxxxxMapper</code>的查询方法之后，返回值基本上是<code>List</code>，与我们的常识并不符合。那<code>Page</code>是什么呢？它不只是包含分页信息的基本类，它继承自ArrayList。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Page</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">ArrayList</span>&lt;E&gt; <span class="keyword">implements</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在return后，还会执行finally中的处理代码，即<code>com.haylion.realTimeBus.interceptor.sql.MyPageHelper</code>的<code>afterAll()</code>方法。其中实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.haylion.realTimeBus.interceptor.sql.MyPageHelper.afterAll()</span></span><br><span class="line"><span class="comment">// 这个方法是我们自定义的方法，用来处理执行完前面所述的切点后，保留分页信息，进行再次封装</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterAll</span><span class="params">()</span> &#123;</span><br><span class="line">    Page&lt;Object&gt; localPage = getLocalPage();</span><br><span class="line">  	<span class="comment">// 删除分页信息</span></span><br><span class="line">    <span class="built_in">super</span>.afterAll();</span><br><span class="line">  	<span class="comment">// 设置回本线程中</span></span><br><span class="line">    setLocalPage(localPage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// super.afterAll()。这个方法可以简单理解成，清楚掉本线程中的分页信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterAll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//这个方法即使不分页也会被执行，所以要判断 null</span></span><br><span class="line">    <span class="type">AbstractHelperDialect</span> <span class="variable">delegate</span> <span class="operator">=</span> autoDialect.getDelegate();</span><br><span class="line">    <span class="keyword">if</span> (delegate != <span class="literal">null</span>) &#123;</span><br><span class="line">        delegate.afterAll();</span><br><span class="line">        autoDialect.clearDelegate();</span><br><span class="line">    &#125;</span><br><span class="line">    clearPage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除本地变量</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clearPage</span><span class="params">()</span> &#123;</span><br><span class="line">  	LOCAL_PAGE.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过上述的过程，<code>MyPageInterceptor</code>执行完毕，分页信息存储在本线程中，然后回到切面处理。</p>
</li>
</ul>
<p><strong>切面收尾工作（回到<code>SystemAdvice</code>）</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">after</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    PageInfo&lt;?&gt; pageInfo;</span><br><span class="line">    Page&lt;Object&gt; localPage = PageHelper.getLocalPage();</span><br><span class="line">    <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> localPage.getTotal();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageNum</span> <span class="operator">=</span> localPage.getPageNum();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pages</span> <span class="operator">=</span> localPage.getPages();</span><br><span class="line">    List&lt;?&gt; list = (List&lt;?&gt;) obj;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">    pageInfo = <span class="keyword">new</span> <span class="title class_">PageInfo</span>((list));</span><br><span class="line">    ResultPageView&lt;?&gt; resultPageView = <span class="keyword">new</span> <span class="title class_">ResultPageView</span>&lt;&gt;(total, pageNum, pages, pageInfo.getList());</span><br><span class="line">    <span class="keyword">return</span> resultPageView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，备注解方法将返回<code>ResultPageView</code>对象，经过包装后，也就是我们常看到的分页格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageCount&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="局限"><a href="#局限" class="headerlink" title="局限"></a>局限</h2><p>这就限定了在一个被<code>PageAble</code>注解了的方法上，只能执行一条查询。如果对于一个到来的请求，需要进行两次或以上的查询，并且某一条查询需要分页的情况，如果所有的查询都放在被<code>PageAble</code>注解的方法下，执行会出现问题（出现不必要的分页操作）。但是可以通过组装的形式，完成该项需求。</p>
<h2 id="bug说明"><a href="#bug说明" class="headerlink" title="bug说明"></a>bug说明</h2><ol>
<li><p>当一条线程，执行被PageAble注解过的方法时，线程中会保存Page信息。</p>
</li>
<li><p>如果切面没有执行完，会导致Page在处理完改请求后，继续留存在该线程中。<br><img src="/images/pics/b33b76b87aa31b8d97ffb13b8f2d4a3c.png"></p>
</li>
<li><p>当一条含有Page对象的线程，处理某个不分页、但需进行查询的请求时，会导致该查询进行分页，并且会将<strong>Page对象中的之前查询得到的数据</strong>一并返回。<br><img src="/images/pics/0178784fa6d228f45b6e01899a9fb754.png"></p>
</li>
</ol>
<h2 id="四个请求的各自功能"><a href="#四个请求的各自功能" class="headerlink" title="四个请求的各自功能"></a>四个请求的各自功能</h2><ol>
<li><p>在线程中留下分页标志。 <code>curl -s localhost:8880/test/get-system-busy\?page=1\&amp;size=2 | jq --indent 4</code></p>
</li>
<li><p>在分页后的数据列表中，加入数据。<code>curl -s localhost:8880/test/get-all-drivers | jq --indent 4</code></p>
</li>
<li><p>出错情况1：TooManyResultsException。<code>curl -s localhost:8880/test/get-one-user\?id=1 | jq --indent 4</code></p>
</li>
<li><p>出错情况2 &amp; 3：ClassCastException &amp; 数据累积。<code>curl -s localhost:8880/test/get-username-list | jq --indent 4</code></p>
</li>
</ol>
<h2 id="PPT内容"><a href="#PPT内容" class="headerlink" title="PPT内容"></a>PPT内容</h2><p>略</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-09T00:15:17.000Z" title="7/9/2019, 8:15:17 AM">2019-07-09</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:52.571Z" title="2/9/2021, 11:03:52 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">6 分钟读完 (大约937个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/09/37cf8e6d6448.html">百度地图墨卡托坐标转高德经纬度坐标（偏移小）</a></p><div class="content"><p>参考：<a target="_blank" rel="noopener" href="http://www.site-digger.com/tools/mct2latlng.html">http://www.site-digger.com/tools/mct2latlng.html</a></p>
<p>这里的转换是直接调用百度地图SDK中的API，通过对其中JavaScript源代码的执行跟踪，提取出其中的墨卡托坐标转百度经纬度坐标的代码如下：</p>
<p>Java版本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> lng, lat;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Point</span><span class="params">(<span class="type">double</span> lng, <span class="type">double</span> lat)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lng = lng;</span><br><span class="line">        <span class="built_in">this</span>.lat = lat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> lng + <span class="string">&quot;,&quot;</span> + lat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">double</span> <span class="variable">xPi</span> <span class="operator">=</span> <span class="number">3.14159265358979324</span> * <span class="number">3000.0</span> / <span class="number">180.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下参数来自百度地图的SDK</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">double</span>[] MCBAND = &#123;<span class="number">12890594.86</span>, <span class="number">8362377.87</span>, <span class="number">5591021</span>, <span class="number">3481989.83</span>, <span class="number">1678043.12</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">double</span>[][] MC2LL = &#123;</span><br><span class="line">        &#123;<span class="number">1.410526172116255e-8</span>, <span class="number">0.00000898305509648872</span>, -<span class="number">1.9939833816331</span>, <span class="number">200.9824383106796</span>, -<span class="number">187.2403703815547</span>, <span class="number">91.6087516669843</span>, -<span class="number">23.38765649603339</span>, <span class="number">2.57121317296198</span>, -<span class="number">0.03801003308653</span>, <span class="number">17337981.2</span>&#125;,</span><br><span class="line">        &#123;-<span class="number">7.435856389565537e-9</span>, <span class="number">0.000008983055097726239</span>, -<span class="number">0.78625201886289</span>, <span class="number">96.32687599759846</span>, -<span class="number">1.85204757529826</span>, -<span class="number">59.36935905485877</span>, <span class="number">47.40033549296737</span>, -<span class="number">16.50741931063887</span>, <span class="number">2.28786674699375</span>, <span class="number">10260144.86</span>&#125;,</span><br><span class="line">        &#123;-<span class="number">3.030883460898826e-8</span>, <span class="number">0.00000898305509983578</span>, <span class="number">0.30071316287616</span>, <span class="number">59.74293618442277</span>, <span class="number">7.357984074871</span>, -<span class="number">25.38371002664745</span>, <span class="number">13.45380521110908</span>, -<span class="number">3.29883767235584</span>, <span class="number">0.32710905363475</span>, <span class="number">6856817.37</span>&#125;,</span><br><span class="line">        &#123;-<span class="number">1.981981304930552e-8</span>, <span class="number">0.000008983055099779535</span>, <span class="number">0.03278182852591</span>, <span class="number">40.31678527705744</span>, <span class="number">0.65659298677277</span>, -<span class="number">4.44255534477492</span>, <span class="number">0.85341911805263</span>, <span class="number">0.12923347998204</span>, -<span class="number">0.04625736007561</span>, <span class="number">4482777.06</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3.09191371068437e-9</span>, <span class="number">0.000008983055096812155</span>, <span class="number">0.00006995724062</span>, <span class="number">23.10934304144901</span>, -<span class="number">0.00023663490511</span>, -<span class="number">0.6321817810242</span>, -<span class="number">0.00663494467273</span>, <span class="number">0.03430082397953</span>, -<span class="number">0.00466043876332</span>, <span class="number">2555164.4</span>&#125;,</span><br><span class="line">        &#123;<span class="number">2.890871144776878e-9</span>, <span class="number">0.000008983055095805407</span>, -<span class="number">3.068298e-8</span>, <span class="number">7.47137025468032</span>, -<span class="number">0.00000353937994</span>, -<span class="number">0.02145144861037</span>, -<span class="number">0.00001234426596</span>, <span class="number">0.00010322952773</span>, -<span class="number">0.00000323890364</span>, <span class="number">826088.5</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参考：http://www.site-digger.com/tools/mct2latlng.html</span></span><br><span class="line"><span class="comment"> * 对上述链接中的操作，找到百度地图的SDK的源代码，然后转换成Java</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Point <span class="title function_">convertMC2LL</span><span class="params">(Point mp)</span> &#123;</span><br><span class="line">    <span class="type">Point</span> <span class="variable">absPoint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(abs(mp.getLng()), abs(mp.getLat()));</span><br><span class="line">    <span class="type">double</span>[] paramArr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MCBAND.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (absPoint.getLat() &gt;= MCBAND[i]) &#123;</span><br><span class="line">            paramArr = MC2LL[i];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mp == <span class="literal">null</span> || paramArr == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;转换出错&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> <span class="variable">lng</span> <span class="operator">=</span> paramArr[<span class="number">0</span>] + paramArr[<span class="number">1</span>] * abs(mp.getLng());</span><br><span class="line">    <span class="type">double</span> <span class="variable">tlat</span> <span class="operator">=</span> abs(mp.getLat()) / paramArr[<span class="number">9</span>];</span><br><span class="line">    <span class="type">double</span> <span class="variable">lat</span> <span class="operator">=</span> paramArr[<span class="number">2</span>]</span><br><span class="line">            + paramArr[<span class="number">3</span>] * tlat</span><br><span class="line">            + paramArr[<span class="number">4</span>] * tlat * tlat</span><br><span class="line">            + paramArr[<span class="number">5</span>] * tlat * tlat * tlat</span><br><span class="line">            + paramArr[<span class="number">6</span>] * tlat * tlat * tlat * tlat</span><br><span class="line">            + paramArr[<span class="number">7</span>] * tlat * tlat * tlat * tlat * tlat</span><br><span class="line">            + paramArr[<span class="number">8</span>] * tlat * tlat * tlat * tlat * tlat * tlat;</span><br><span class="line">    lng *= mp.getLng() &lt; <span class="number">0</span> ? -<span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">    lat *= mp.getLat() &lt; <span class="number">0</span> ? -<span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Point</span>(lng, lat);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 百度经纬度坐标转高德经纬度坐标。网上很常见的一种方式。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Point <span class="title function_">BD09ToGCJ02</span><span class="params">(Point bdp)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">x</span> <span class="operator">=</span> bdp.getLng() - <span class="number">0.0065</span>, y = bdp.getLat() - <span class="number">0.006</span>;</span><br><span class="line">    <span class="type">double</span> <span class="variable">z</span> <span class="operator">=</span> sqrt(x * x + y * y) - <span class="number">0.00002</span> * sin(y * xPi);</span><br><span class="line">    <span class="type">double</span> <span class="variable">theta</span> <span class="operator">=</span> atan2(y, x) - <span class="number">0.000003</span> * cos(x * xPi);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Point</span>(z * cos(theta), z * sin(theta));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Python版本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">xPi = <span class="number">3.14159265358979324</span> * <span class="number">3000.0</span> / <span class="number">180.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下参数来自百度地图的SDK</span></span><br><span class="line">MCBAND = [<span class="number">12890594.86</span>, <span class="number">8362377.87</span>, <span class="number">5591021</span>, <span class="number">3481989.83</span>, <span class="number">1678043.12</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">MC2LL = [</span><br><span class="line">    [<span class="number">1.410526172116255e-8</span>, <span class="number">0.00000898305509648872</span>, -<span class="number">1.9939833816331</span>, <span class="number">200.9824383106796</span>, -<span class="number">187.2403703815547</span>, <span class="number">91.6087516669843</span>, -<span class="number">23.38765649603339</span>, <span class="number">2.57121317296198</span>, -<span class="number">0.03801003308653</span>, <span class="number">17337981.2</span>],</span><br><span class="line">    [-<span class="number">7.435856389565537e-9</span>, <span class="number">0.000008983055097726239</span>, -<span class="number">0.78625201886289</span>, <span class="number">96.32687599759846</span>, -<span class="number">1.85204757529826</span>, -<span class="number">59.36935905485877</span>, <span class="number">47.40033549296737</span>, -<span class="number">16.50741931063887</span>, <span class="number">2.28786674699375</span>, <span class="number">10260144.86</span>],</span><br><span class="line">    [-<span class="number">3.030883460898826e-8</span>, <span class="number">0.00000898305509983578</span>, <span class="number">0.30071316287616</span>, <span class="number">59.74293618442277</span>, <span class="number">7.357984074871</span>, -<span class="number">25.38371002664745</span>, <span class="number">13.45380521110908</span>, -<span class="number">3.29883767235584</span>, <span class="number">0.32710905363475</span>, <span class="number">6856817.37</span>],</span><br><span class="line">    [-<span class="number">1.981981304930552e-8</span>, <span class="number">0.000008983055099779535</span>, <span class="number">0.03278182852591</span>, <span class="number">40.31678527705744</span>, <span class="number">0.65659298677277</span>, -<span class="number">4.44255534477492</span>, <span class="number">0.85341911805263</span>, <span class="number">0.12923347998204</span>, -<span class="number">0.04625736007561</span>, <span class="number">4482777.06</span>],</span><br><span class="line">    [<span class="number">3.09191371068437e-9</span>, <span class="number">0.000008983055096812155</span>, <span class="number">0.00006995724062</span>, <span class="number">23.10934304144901</span>, -<span class="number">0.00023663490511</span>, -<span class="number">0.6321817810242</span>, -<span class="number">0.00663494467273</span>, <span class="number">0.03430082397953</span>, -<span class="number">0.00466043876332</span>, <span class="number">2555164.4</span>],</span><br><span class="line">    [<span class="number">2.890871144776878e-9</span>, <span class="number">0.000008983055095805407</span>, -<span class="number">3.068298e-8</span>, <span class="number">7.47137025468032</span>, -<span class="number">0.00000353937994</span>, -<span class="number">0.02145144861037</span>, -<span class="number">0.00001234426596</span>, <span class="number">0.00010322952773</span>, -<span class="number">0.00000323890364</span>, <span class="number">826088.5</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 百度经纬度坐标转高德经纬度坐标。网上很常见的一种方式。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bd09togcj02</span>(<span class="params">bd_lon, bd_lat</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    百度坐标系(BD-09)转火星坐标系(GCJ-02)</span></span><br><span class="line"><span class="string">    百度——&gt;谷歌、高德</span></span><br><span class="line"><span class="string">    :param bd_lat:百度坐标纬度</span></span><br><span class="line"><span class="string">    :param bd_lon:百度坐标经度</span></span><br><span class="line"><span class="string">    :return:转换后的坐标列表形式</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    x, y = bd_lon - <span class="number">0.0065</span>, bd_lat - <span class="number">0.006</span></span><br><span class="line">    z = math.sqrt(x * x + y * y) - <span class="number">0.00002</span> * math.sin(y * xPi)</span><br><span class="line">    theta = math.atan2(y, x) - <span class="number">0.000003</span> * math.cos(x * xPi)</span><br><span class="line">    <span class="keyword">return</span> z * math.cos(theta), z * math.sin(theta)</span><br><span class="line"></span><br><span class="line"> <span class="comment"># 参考：http://www.site-digger.com/tools/mct2latlng.html</span></span><br><span class="line"> <span class="comment"># 对上述链接中的操作，找到百度地图的SDK的源代码，然后转换成Java</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convertMC2LL</span>(<span class="params">ox, oy</span>) :</span><br><span class="line">    x, y = <span class="built_in">abs</span>(ox), <span class="built_in">abs</span>(oy)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(MCBAND)) :</span><br><span class="line">        <span class="keyword">if</span> y &gt;= MCBAND[i] :</span><br><span class="line">            paramArr = MC2LL[i]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> paramArr == <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;转换坐标失败&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    lng = paramArr[<span class="number">0</span>] + paramArr[<span class="number">1</span>] * <span class="built_in">abs</span>(ox)</span><br><span class="line">    tlat = <span class="built_in">abs</span>(oy) / paramArr[<span class="number">9</span>]</span><br><span class="line">    lat = paramArr[<span class="number">2</span>] + paramArr[<span class="number">3</span>] * tlat + paramArr[<span class="number">4</span>] * tlat * tlat + paramArr[<span class="number">5</span>] * tlat * tlat * tlat + paramArr[<span class="number">6</span>] * tlat * tlat * tlat * tlat + paramArr[<span class="number">7</span>] * tlat * tlat * tlat * tlat * tlat + paramArr[<span class="number">8</span>] * tlat * tlat * tlat * tlat * tlat * tlat</span><br><span class="line">    lng *= (-<span class="number">1</span> <span class="keyword">if</span> ox &lt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span>)</span><br><span class="line">    lat *= (-<span class="number">1</span> <span class="keyword">if</span> oy &lt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lng, lat</span><br></pre></td></tr></table></figure>

<p>效果展示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试代码</span></span><br><span class="line"><span class="type">String</span> <span class="variable">kejiyuan</span> <span class="operator">=</span> <span class="string">&quot;12682891.3894,2559542.0538,12682896.5467,2559793.62794,12682844.7433,2560206.11494,12682734.4366,2561087.88431,12682681.159,2562074.67985,12682831.1964,2562218.1177,12683623.9092,2562188.56753,12683732.2141,2562243.30281,12683877.4858,2562398.46172,12683916.3509,2562839.59511,12683912.6528,2563051.56215,12683997.6458,2563129.82525,12684148.9608,2563136.64739,12684423.9572,2563249.60486,12684687.41,2563412.50587,12685216.0839,2563387.9877,12686427.857,2563282.11338,12687017.2378,2563194.53233,12687547.0621,2563146.47597,12687711.6126,2563191.93924,12688072.3621,2563098.80984,12688551.9725,2562924.51818,12688595.2954,2562866.34103,12688581.4473,2562769.94654,12688592.8397,2562733.23579,12689180.0331,2562464.27042,12689211.9588,2562420.55064,12689195.8798,2562314.3281,12689168.3537,2562313.76442,12688839.1722,2562275.22138,12688521.5892,2562344.85031,12688215.549,2562370.2208,12687875.1633,2562296.16518,12687304.0261,2562224.77222,12686776.2826,2562209.27294,12686464.1449,2562201.14685,12686253.3935,2562183.17902,12686147.8737,2562159.13696,12686097.5228,2562114.03074,12686174.2562,2560903.22104,12686144.5094,2560727.85702,12686162.7094,2560701.00483,12686702.0782,2560744.58401,12686715.7214,2560727.54607,12686694.5355,2560518.79091,12686469.0556,2560122.34138,12686281.1211,2559770.33875,12686231.908,2559542.23454,12686214.5986,2559162.03758,12686197.169,2559118.19258,12685318.8834,2559094.19446,12685143.0646,2559094.6559,12684986.7893,2559013.13744,12684889.126,2558895.30627,12684835.3891,2558858.28003,12684600.8812,2558847.14735,12684139.8292,2558854.49449,12683748.6599,2558894.79101,12683582.3085,2558936.30384,12683435.5368,2559030.43944,12683260.9697,2559068.85924,12682852.8989,2559166.22101,12682834.3698,2559181.22174,12682891.3894,2559542.0538&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">pss</span> <span class="operator">=</span> kejiyuan;</span><br><span class="line">String[] points = pss.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (points.length % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; points.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">&quot;[&quot;</span> +</span><br><span class="line">                    BD09ToGCJ02(convertMC2LL(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Point</span>(</span><br><span class="line">                                Double.parseDouble(points[i]),</span><br><span class="line">                                Double.parseDouble(points[i + <span class="number">1</span>])</span><br><span class="line">                        )</span><br><span class="line">                    ))</span><br><span class="line">                    + <span class="string">&quot;],&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打开<a target="_blank" rel="noopener" href="https://lbs.amap.com/api/javascript-api/example/overlayers/polygon-draw-and-edit">高德地图多边形绘制DEMO示例</a>，然后将上述代码的对应执行结果，以正确的形式粘贴到DEMO代码的相应地方：<br><img src="/images/pics/d41ae3c6154da18285c64239d0326a56.png"><br>然后点击运行，查看结果：<br><strong>百度墨卡托坐标转成百度经纬度坐标后，在高德地图上展示情况</strong><br><img src="/images/pics/139713bdba2e334cb4a163c1b4a405fa.png" alt="百度墨卡托坐标转成百度经纬度坐标后在高德地图上展示情况"><br><strong>将百度坐标转换成高德地图坐标后在高德地图中的展示情况</strong><br><img src="/images/pics/6469b0d9cfe48070be8054c374c6be12.png" alt="将百度坐标转换成高德地图坐标后在高德地图中的展示情况"><br><strong>百度地图原始数据</strong><br><img src="/images/pics/43c75467ef4a45558d4fba06494e8b06.png" alt="百度地图原始数据"></p>
<p>后面经过尝试、发现差距并不是特别大，已使用这种方法进行坐标转换</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-06-17T22:48:47.000Z" title="6/18/2019, 6:48:47 AM">2019-06-18</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:41.041Z" title="2/9/2021, 11:03:41 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">35 分钟读完 (大约5285个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/06/18/a16a8d6e1474.html">项目架构解释说明</a></p><div class="content"><h2 id="模块概览"><a href="#模块概览" class="headerlink" title="模块概览"></a>模块概览</h2><h3 id="base-service"><a href="#base-service" class="headerlink" title="base-service"></a>base-service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">base-service</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── com</span><br><span class="line">                └── haylion</span><br><span class="line">                    └── realTimeBus</span><br><span class="line">                        ├── advice</span><br><span class="line">                        │   └── SystemAdvice.java # 分页注解实现</span><br><span class="line">                        ├── annotation</span><br><span class="line">                        │   └── PageAble.java # 分页注解</span><br><span class="line">                        ├── bean</span><br><span class="line">                        │   ├── BaseModel.java # 含有id熟悉的基础bean</span><br><span class="line">                        │   ├── Condition.java # 条件查询时的条件</span><br><span class="line">                        │   ├── ResultPageView.java # 被分页注解标记后，改函数返回的对象，将被包装成该对象(一个普通的bean类)</span><br><span class="line">                        │   ├── SMSConf.java # 将yaml文件中sms相关配置信息写入此类对象中</span><br><span class="line">                        │   └── Sort.java # 查询时排序方式</span><br><span class="line">                        ├── handler</span><br><span class="line">                        │   └── MySqlJsonHandler.java # MyBatis如何存储JSONObject、如何读取JSONObject</span><br><span class="line">                        ├── http</span><br><span class="line">                        │   └── HttpInvoker.java # RestTemplate单例容器</span><br><span class="line">                        ├── interceptor</span><br><span class="line">                        │   └── sql</span><br><span class="line">                        │       ├── MyPageHelper.java # 覆盖afterAll后的PageHelper，在MyPageInterceptor中进行调用</span><br><span class="line">                        │       ├── MyPageInterceptor.java # PageHelper中拦截器PageInterceptor的源码，有自定义修改</span><br><span class="line">                        │       └── SqlLogHandler.java # 把将要执行的SQL打印出来，集成在MyPageInterceptor中</span><br><span class="line">                        ├── mappers</span><br><span class="line">                        │   └── BaseMapper.java # 定义了访问数据库的一些基本接口</span><br><span class="line">                        ├── msg</span><br><span class="line">                        │   └── RetStubMsg.java # 自定义ApplicationException接收的参数</span><br><span class="line">                        └── service</span><br><span class="line">                            ├── BaseCacheService.java # 定义了一些基本的Redis访问接口</span><br><span class="line">                            ├── BaseService.java # 实现了service基础数据库操作的抽象类</span><br><span class="line">                            ├── CacheService.java # BaseCacheService的具体封装实现</span><br><span class="line">                            ├── DistributedLock.java # 通过redis实现的一种分布式锁</span><br><span class="line">                            ├── MQService.java # 阿里MQ操作封装</span><br><span class="line">                            ├── SMSService.java # 阿里短信操作封装</span><br><span class="line">                            ├── SysThreadPool.java # 自定义线程池</span><br><span class="line">                            ├── UploadService.java # 文件上传，有文件头部信息校验</span><br><span class="line">                            └── WXPayService.java # 微信支付相关操作封装</span><br></pre></td></tr></table></figure>

<h3 id="common-service"><a href="#common-service" class="headerlink" title="common-service"></a>common-service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">base-support/common-service</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── com</span><br><span class="line">                └── haylion</span><br><span class="line">                    └── realTimeBus</span><br><span class="line">                        └── common</span><br><span class="line">                            ├── code</span><br><span class="line">                            │   ├── RetStub.java # ApplicationException所依赖的对象，定义了业务逻辑错误的访问方法</span><br><span class="line">                            │   └── SysStubInfo.java # 系统默认的错误码信息</span><br><span class="line">                            ├── exception</span><br><span class="line">                                └── ApplicationException.java # 自定义异常，用来处理业务逻辑中出现的异常，其中依赖RetStub对象，来描述错误码、错误信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="facade-service"><a href="#facade-service" class="headerlink" title="facade-service"></a>facade-service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">base-support/facade-service</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── com</span><br><span class="line">                └── haylion</span><br><span class="line">                    └── realTimeBus</span><br><span class="line">                        └── facade</span><br><span class="line">                            ├── BaseInitializer.java # 自定义Server初始化类，其中加入了拦截器ActionInterceptor，并指定拦截所有的请求</span><br><span class="line">                            ├── advice</span><br><span class="line">                            │   └── ResponseAdvice.java # 将所有返回的body中的数据，转换成JsonView的形式</span><br><span class="line">                            ├── annotation</span><br><span class="line">                            │   └── AnonymousSupport.java # 跳过ActionInterceptor中的校验、塞入userId</span><br><span class="line">                            ├── exception</span><br><span class="line">                            │   └── ExceptionHandle.java # 在请求的处理过程中，出现任何异常，都会调用该类中的处理方法，将错误信息，以JsonView的形式返回。</span><br><span class="line">                            ├── filter</span><br><span class="line">                            │   ├── RequestWrapper.java # 将请求相关的数据，如headers、queryparams、requestbody、method、url保存到本线程的LogTrace中</span><br><span class="line">                            │   └── TraceCopyFilter.java # 拦截器，拦截所有的请求，并将请求转换成RequestWrapper</span><br><span class="line">                            ├── intercepter</span><br><span class="line">                            │   └── ActionInterceptor.java # 所有的请求都会经过该类处理，可以在此类中对类进行自定义操作，如按需鉴定权限、添加userId到header中</span><br><span class="line">                            ├── log</span><br><span class="line">                            │   ├── HttpTraceLog.java # HTTP请求log类</span><br><span class="line">                            │   └── LogTrace.java # 利用ThreadLocal获取、设置HttpTraceLog</span><br><span class="line">                            ├── validator</span><br><span class="line">                            │   └── ValidatorConfiguration.java # </span><br><span class="line">                            └── view</span><br><span class="line">                                └── JsonView.java # API统一响应模板</span><br></pre></td></tr></table></figure>

<h2 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h2><h3 id="拦截鉴权—-ActionInterceptor"><a href="#拦截鉴权—-ActionInterceptor" class="headerlink" title="拦截鉴权— ActionInterceptor"></a>拦截鉴权— <code>ActionInterceptor</code></h3><p>本项目中鉴定登录状态的方式为：在请求头部加入<code>token</code>，然后在拦截器<code>ActionInterceptor.java</code>中，从请求头部中取出<code>token</code>，并依据<code>token</code>来获取<code>userId</code>，然后将<code>userId</code>插入到头部中；如果上述过程，出现<code>token</code>是<code>null</code>、<code>userId</code>是<code>null</code>，那么该请求将被视为非登录状态，将不会传递到Controller层。</p>
<p><strong>如何跳过校验？</strong></p>
<p>在Controller的方法上，加上<code>@AnonymousSupport</code>注解，在<code>ActionInterceptor.java</code>中，会通过<code>Method</code>方法，获取<code>@AnonymousSupport</code>，如果存在就不进行后面的登录状态校验。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> (HandlerMethod) o;</span><br><span class="line"><span class="type">AnonymousSupport</span> <span class="variable">annotation</span> <span class="operator">=</span> handlerMethod.getMethod().getAnnotation(AnonymousSupport.class);</span><br><span class="line"><span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>如何将<code>userId</code>添加到请求的<code>headers</code>中？</strong></p>
<p>通过<code>token</code>在Redis中获取到<code>userId</code>后，如何在<code>headers</code>中添加<code>userId</code>键值对，略微繁杂，但是目的很单纯。设置值的代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MimeHeaders</span> <span class="variable">mimeHeaders</span> <span class="operator">=</span> (MimeHeaders) headers.get(coyoteRequest);</span><br><span class="line"><span class="comment">//in case of do not cover the specify key</span></span><br><span class="line"><span class="type">String</span> <span class="variable">header</span> <span class="operator">=</span> mimeHeaders.getHeader(key);</span><br><span class="line">logger.info(<span class="string">&quot;Original value of &lt;&quot;</span> + key + <span class="string">&quot;&gt; is &quot;</span> + header);</span><br><span class="line">mimeHeaders.removeHeader(key);</span><br><span class="line"><span class="comment">// key = &quot;userId&quot;, value即token值</span></span><br><span class="line">mimeHeaders.addValue(key).setString(value);</span><br></pre></td></tr></table></figure>

<p>在前面，有一个对<code>request</code>类型进行判断的语句，主要目的是为了避免<code>NullPointerException</code>，因为后面通过反射获取属性的时候，可能会由于<code>request</code>类型不同，而获取不到对应的<code>Field</code>，从而导致出现异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (request <span class="keyword">instanceof</span> StandardMultipartHttpServletRequest) &#123;</span><br><span class="line">    <span class="comment">// 文件上传时的类型是这个</span></span><br><span class="line">    <span class="type">StandardMultipartHttpServletRequest</span> <span class="variable">standardMultipartHttpServletRequest</span> <span class="operator">=</span> (StandardMultipartHttpServletRequest) request;</span><br><span class="line">    <span class="type">RequestWrapper</span> <span class="variable">requestWrapper</span> <span class="operator">=</span> (RequestWrapper) standardMultipartHttpServletRequest</span><br><span class="line">            .getRequest();</span><br><span class="line">    request = (HttpServletRequest) requestWrapper.getRequest();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (request <span class="keyword">instanceof</span> RequestWrapper) &#123; </span><br><span class="line">    <span class="comment">// 通常情况下是这个,因为我们在Filter中对request进行过包装，详情见下面请求日志部分</span></span><br><span class="line">    <span class="type">RequestWrapper</span> <span class="variable">requestWrapper</span> <span class="operator">=</span> (RequestWrapper) request;</span><br><span class="line">    request = (HttpServletRequest) requestWrapper.getRequest();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="请求日志"><a href="#请求日志" class="headerlink" title="请求日志"></a>请求日志</h3><p>主要的任务是将请求所有的参数(如：<u>url中的参数、方法、headers、requestBody</u>等)都以直观的方式打印出来。它的主要流程有两处：</p>
<ol>
<li><p>拦截器<code>TraceCopyFilter</code>初始化<code>RequestWrapper</code>时，将请求所有的信息都保存到<code>HttpTraceLog</code>中，并通过<code>LogTrace</code>保存在当前线程中(利用<code>ThreadLocal</code>)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LogTrace.get().setStartTime(System.currentTimeMillis());</span><br><span class="line">LogTrace.get().setHttpMethod(request.getMethod());</span><br><span class="line">LogTrace.get().setUrl(requestURI);</span><br><span class="line">LogTrace.get().setReqParams(request.getQueryString());</span><br><span class="line">LogTrace.get().setReqHeader(getHeaderMap(request));</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">LogTrace.get().setRequestBody(sb.toString());</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>ResponseAdvice</code>包装完返回信息之后，会在finally中将所有的请求信息，通过log的形式打印出来。打印完成后，会通过<code>LogTrace</code>将请求的信息从本线程中移除掉(利用<code>ThreadLocal</code>)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    LogTrace.get().setSpendTime(System.currentTimeMillis() - LogTrace.get().getStartTime());</span><br><span class="line">    LogTrace.get().setRespParams(objectMapper.writeValueAsString(result));</span><br><span class="line">    log.info(<span class="string">&quot;Trace log is ====&gt;  &quot;</span> + objectMapper.writeValueAsString(LogTrace.get()));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">  	log.error(<span class="string">&quot;Trace log error : &quot;</span>, e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  	LogTrace.clearAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>其中获取body时，直接使用IO流，把数据保存到变量<code>requestBody</code>中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request == null 是一个标志位</span></span><br><span class="line"><span class="built_in">this</span>.request = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// IO读取</span></span><br><span class="line"><span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> request.getInputStream();</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(inputStream)))&#123;</span><br><span class="line">    <span class="type">char</span>[] charBuffer = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">128</span>];</span><br><span class="line">    <span class="type">int</span> bytesRead;</span><br><span class="line">    <span class="keyword">while</span> ((bytesRead = bufferedReader.read(charBuffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      sb.append(charBuffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">  	ex.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 保存到内存中</span></span><br><span class="line">requestBody = sb.toString();</span><br></pre></td></tr></table></figure>

<p>但是收到POST请求时（参考<a target="_blank" rel="noopener" href="https://www.oschina.net/news/77354/http-get-post-different">链接</a>），会产生两个TCP数据包（并不是所有浏览器都会在POST中发送两次包，Firefox就只发送一次），即浏览器先发送header，服务器响应100 continue，浏览器再发送data，服务器响应200 ok（返回数据）。所以在拿POST请求中body时，如果直接读出来，可能导致后面框架再去读的时候，出现读不了的情况，所以在<code>RequestWrapper</code>中，重写了<code>getInputStream</code>方法，在<code>request</code>不为空，即没有读取过body(这种情况就是在上传文件的情况)，直接以<code>requestBody</code>作为输入流，提供给框架读取，上述问题便解决了。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServletInputStream <span class="title function_">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.request != <span class="literal">null</span>) &#123;</span><br><span class="line">      	<span class="comment">// 不为空，说明没有读取过body，即为文件上传请求，此时直接返回request.getInputStream()</span></span><br><span class="line">    		<span class="keyword">return</span> request.getInputStream();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 以requestBody作为输入流</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(requestBody.getBytes());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletInputStream</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isFinished</span><span class="params">()</span> &#123;</span><br><span class="line">        		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isReady</span><span class="params">()</span> &#123;</span><br><span class="line">        		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReadListener</span><span class="params">(ReadListener readListener)</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">// 以requestBody作为输入流</span></span><br><span class="line">        		<span class="keyword">return</span> byteArrayInputStream.read();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SQL日志"><a href="#SQL日志" class="headerlink" title="SQL日志"></a>SQL日志</h3><p><code>SqlLogHandler</code>在SQL拦截中进行调用，它主要做的工作是把SQL中的?替换成实际的值，并打印出执行时间。</p>
<h3 id="API统一的返回数据"><a href="#API统一的返回数据" class="headerlink" title="API统一的返回数据"></a>API统一的返回数据</h3><p>在<code>ResponseAdvice</code>中，会将数据都转化成<code>JsonView</code>的形式。</p>
<p>其中有一个问题，就是当返回的类型是<code>String</code>的时候，不能包装String类型，只能以String的形式返回。这是由于整个SpringMVC框架的设计问题。假设有如下业务代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;test&quot;)</span></span><br><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候的返回值如下：</p>
<p><img src="/images/pics/7738ff707213b6aec36eeb30f4eeeca9.jpg"></p>
<p>因为是以String的类型直接返回了，上述的返回格式也是理所当然。但是如果将String包装成<code>JsonView</code>，然后返回会怎么样？修改<code>ResponseAdvice</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (o <span class="keyword">instanceof</span> JsonView ) &#123;</span><br><span class="line">    result = o;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">    o = EMPTY_DATA;</span><br><span class="line">&#125;</span><br><span class="line">result = <span class="keyword">new</span> <span class="title class_">JsonView</span>&lt;&gt;(SysStubInfo.DEFAULT_SUCCESS, o);</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>

<p>这时候如果再次访问，程序会报错如下：</p>
<p><img src="/images/pics/88674b8ee761ad15c4951d1d96eb6145.jpg"></p>
<p>报错的堆栈信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassCastException: com.haylion.realTimeBus.facade.view.JsonView cannot be cast to java.base/java.lang.String</span><br><span class="line">	at org.springframework.http.converter.StringHttpMessageConverter.getContentLength(StringHttpMessageConverter.java:43)</span><br><span class="line">	at org.springframework.http.converter.AbstractHttpMessageConverter.addDefaultHeaders(AbstractHttpMessageConverter.java:259)</span><br><span class="line">	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:210)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:275)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor.handleReturnValue(RequestResponseBodyMethodProcessor.java:180)</span><br><span class="line">	at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:82)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:119)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:877)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:783)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:991)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:925)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:974)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:866)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:635)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:851)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:742)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">	at com.haylion.realTimeBus.facade.filter.TraceCopyFilter.doFilter(TraceCopyFilter.java:52)</span><br></pre></td></tr></table></figure>

<p>上面的错误简单理解，类型转换错误，也就是需要一个String，但是却收到了一个<code>JsonView</code>。需要的String是我们在Controller中返回的类型，然而实际收到的<code>JsonView</code>是在<code>ResponseAdvice</code>中包装后返回的。为什么这样的原因是：与<code>ResponseAdvice</code>执行的时机有关。在<code>AbstractMessageConverterMethodProcessor.java</code>文件的<code>writeWithMessageConverters()</code>方法中，调试数据如下：</p>
<p><strong>确定返回类型：</strong></p>
<p><img src="/images/pics/0fb94bb789767fae82ff374de97fc2e3.jpg"></p>
<p><strong>确定可用的转换器，然后执行<code>ResponseAdvice</code>：</strong></p>
<p>在<code>ResponseAdvice</code>执行前，SpringMVC会根据Controller的返回类型，确定一个<code>AbstractHttpMessageConverter</code>，由于在Controller中返回类型为String，所以这里为<code>StringHttpMessageConverter</code>，也就是说，它是用来转换一个String类型的转换器。等转换器确定好了之后，会执行ResponseAdvice中的处理方法，将String转换成<code>JsonView</code>。</p>
<p><img src="/images/pics/3ae224afd3cb3b6dce575d022fc236ba.jpg"></p>
<p><strong>写入返回数据：</strong></p>
<p>忽略掉其他代码，直接进入出现错误的代码，在<code>AbstractHttpMessageConverter</code>中的<code>addDefaultHeaders()</code>方法中，需要在头部获取整个请求的大小，即调用<code>getContentLength()</code>方法。</p>
<p><img src="/images/pics/403fa66dc7dc972222bd0c6a360ad0de.jpg"></p>
<p>它是一个期望被子类覆盖的方法，默认的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Long <span class="title function_">getContentLength</span><span class="params">(T t, <span class="meta">@Nullable</span> MediaType contentType)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候应该直接看<code>StringHttpMessageConverter</code>中的<code>getContentLength()</code>方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Long <span class="title function_">getContentLength</span><span class="params">(String str, <span class="meta">@Nullable</span> MediaType contentType)</span> &#123;</span><br><span class="line">   <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> getContentTypeCharset(contentType);</span><br><span class="line">   <span class="keyword">return</span> (<span class="type">long</span>) str.getBytes(charset).length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再将转换后的<code>JsonView</code>作为抽象函数<code>getContentLength()</code>(这时就是<code>StringHttpMessageConverter</code>的该函数)的第一个参数，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Long <span class="title function_">getContentLength</span><span class="params">(String str, <span class="meta">@Nullable</span> MediaType contentType)</span> &#123;</span><br><span class="line">   <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> getContentTypeCharset(contentType);</span><br><span class="line">   <span class="keyword">return</span> (<span class="type">long</span>) str.getBytes(charset).length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个参数为String，但是实际上是<code>JsonView</code>。因此，<code>ClassCastException</code>在所难免。在<code>ResponseAdvice</code>中，将String直接返回，可以避免出现这种不太好修复的错误。</p>
<p><strong>替代办法：</strong></p>
<p>但是如果非要返回String类型，并且需要包装成<code>JsonView</code>形式，可以考虑直接在Controller中将String包装成<code>JsonView</code>，然后返回，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;test&quot;)</span></span><br><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JsonView</span>&lt;&gt;(SysStubInfo.DEFAULT_SUCCESS, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="/images/pics/3d3a80941fb1c00e1485d7083b87f328.jpg"></p>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>参看<code>ExceptionHandle</code>具体实现及写法、以及相关源码注释。</p>
<h3 id="分页–PageHelper"><a href="#分页–PageHelper" class="headerlink" title="分页–PageHelper"></a>分页–<code>PageHelper</code></h3><h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p>直接在方法上加上<code>@PageAble</code>注解，并在该方法中传入两个参数，分别为<code>page</code>和<code>size</code>，在该方法返回后，会得到一个<code>ResultPageView</code>封装对象，其中包含分页相关信息。</p>
<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><p> <code>SystemAdvice</code>定义一个切面，切点是<code>@annotation(com.haylion.realTimeBus.annotation.PageAble)</code>。也就是说，每个被<code>@PageAble</code>注解过的方法，都将执行下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAGE_ABLE</span> <span class="operator">=</span> <span class="string">&quot;@annotation(com.haylion.realTimeBus.annotation.PageAble)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Around(PAGE_ABLE)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doAroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;execute method : &quot;</span> + proceedingJoinPoint.getSignature().getName());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 进入被@PageAble注解的方法前的准备工作</span></span><br><span class="line">        prepare(proceedingJoinPoint);</span><br><span class="line">        <span class="comment">// 执行被@PageAble注解的方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line">        <span class="comment">// 执行被@PageAble注解的方法后，执行扫尾工作</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> after(obj);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;aspect execute error : &quot;</span>, throwable);</span><br><span class="line">        <span class="keyword">throw</span> throwable;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        PageHelper.clearPage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>准备工作</strong>：主要是获取<code>page</code>和<code>size</code>的值，然后调用<code>PageHelper</code>的<code>startPage</code>方法，初始化分页信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PageAble中page和size的默认值分别是1和20</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PageAble &#123;</span><br><span class="line">    String <span class="title function_">pageSizeName</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;size&quot;</span>;</span><br><span class="line">    String <span class="title function_">pageNumName</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;page&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">pageSize</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">20</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">pageNum</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 准备分页</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> point.getSignature();</span><br><span class="line">    <span class="type">MethodSignature</span> <span class="variable">methodSignature</span> <span class="operator">=</span> (MethodSignature) signature;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> methodSignature.getMethod();</span><br><span class="line">    <span class="type">PageAble</span> <span class="variable">pageAble</span> <span class="operator">=</span> targetMethod.getAnnotation(PageAble.class);</span><br><span class="line">    <span class="type">String</span> <span class="variable">numName</span> <span class="operator">=</span> pageAble.pageNumName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">sizeName</span> <span class="operator">=</span> pageAble.pageSizeName();</span><br><span class="line">    <span class="comment">// 先获取默认的page和size值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pageNo</span> <span class="operator">=</span> pageAble.pageNum();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> pageAble.pageSize();</span><br><span class="line">    Object[] paramValues = point.getArgs();</span><br><span class="line">    String[] paramNames = methodSignature.getParameterNames();</span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> paramNames.length;</span><br><span class="line">    <span class="comment">// 遍历该方法中的所有参数，如果有page和size信息，那么就覆盖默认值为用户传入的值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (paramNames[i].equals(numName)) &#123;</span><br><span class="line">            pageNo = (Integer) paramValues[i];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramNames[i].equals(sizeName)) &#123;</span><br><span class="line">            pageSize = (Integer) paramValues[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 该方法利用ThreadLocal在本线程中插入一个分页信息的对象Page</span></span><br><span class="line">    PageHelper.startPage(pageNo, pageSize);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// startPage()方法的最终实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; Page&lt;E&gt; <span class="title function_">startPage</span><span class="params">(<span class="type">int</span> pageNum, <span class="type">int</span> pageSize, <span class="type">boolean</span> count, Boolean reasonable, Boolean pageSizeZero)</span> &#123;</span><br><span class="line">    Page&lt;E&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;E&gt;(pageNum, pageSize, count);</span><br><span class="line">    page.setReasonable(reasonable);</span><br><span class="line">    page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    <span class="comment">//当已经执行过orderBy的时候</span></span><br><span class="line">    Page&lt;E&gt; oldPage = getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (oldPage != <span class="literal">null</span> &amp;&amp; oldPage.isOrderByOnly()) &#123;</span><br><span class="line">      	page.setOrderBy(oldPage.getOrderBy());</span><br><span class="line">    &#125;</span><br><span class="line">    setLocalPage(page);</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setLocalPage</span><span class="params">(Page page)</span> &#123;</span><br><span class="line">  	LOCAL_PAGE.set(page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Page&gt; LOCAL_PAGE = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Page&gt;();</span><br></pre></td></tr></table></figure>

<p><strong>进入SQL拦截器（即<code>MyPageInterceptor</code>）</strong>：这个拦截器中主要是PageHelper执行分页的步骤，相关步骤可分为：</p>
<ul>
<li><p>判断是否需要进行分页。判断的条件为<code>!dialect.skip(ms, parameter, rowBounds)</code>，其实现为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">skip</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(ms.getId().endsWith(MSUtils.COUNT))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;在系统中发现了多个分页插件，请检查系统配置!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//设置默认的 count 列</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtil.isEmpty(page.getCountColumn()))&#123;</span><br><span class="line">            page.setCountColumn(pageParams.getCountColumn());</span><br><span class="line">        &#125;</span><br><span class="line">        autoDialect.initDelegateDialect(ms);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，通过判断<code>Page</code>是否为空来决定是否进行分页，<code>Page</code>则从本线程中获取，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PageHelper.java</span></span><br><span class="line"><span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line"></span><br><span class="line"><span class="comment">//PageParams.java</span></span><br><span class="line"><span class="keyword">public</span> Page <span class="title function_">getPage</span><span class="params">(Object parameterObject, RowBounds rowBounds)</span> &#123;</span><br><span class="line">		<span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> PageHelper.getLocalPage();</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PageMethod.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">getLocalPage</span><span class="params">()</span> &#123;</span><br><span class="line">  	<span class="keyword">return</span> LOCAL_PAGE.get();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Page&gt; LOCAL_PAGE = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Page&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取数据的总条数。在进入此项前，会进行判断是否需要进行总数查询。这里假设进行总数查询。从源SQL解析出获取数据总条数的代码调试如下：</p>
<p><img src="/images/pics/3ae925cf7c0ded7f9b2fe84c482cd58e.png" alt="调试"></p>
<p>log如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2019-06-14 09:37:31.475 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - ==&gt;  Preparing: SELECT count(0) FROM advertising </span><br><span class="line">2019-06-14 09:37:31.490 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - ==&gt; Parameters: </span><br><span class="line">2019-06-14 09:37:31.507 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &lt;==      Total: 1</span><br><span class="line">2019-06-14 09:37:31.508  INFO [http-nio-8880-exec-1] c.h.r.i.s.SqlLogHandler - com.haylion.realTimeBus.dao.AdvertisingMapper.getByConditionList_COUNT:</span><br><span class="line">select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising</span><br><span class="line">&lt;cost time is :45 ms &gt;</span><br><span class="line">2019-06-14 09:37:31.512 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - ==&gt;  Preparing: select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising LIMIT ? </span><br><span class="line">2019-06-14 09:37:31.512 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - ==&gt; Parameters: 1(Integer)</span><br><span class="line">2019-06-14 09:37:31.519 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &lt;==      Total: 1</span><br><span class="line">2019-06-14 09:37:31.520  INFO [http-nio-8880-exec-1] c.h.r.i.s.SqlLogHandler - com.haylion.realTimeBus.dao.AdvertisingMapper.getByConditionList:</span><br><span class="line">select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising LIMIT 1 </span><br><span class="line">&lt;cost time is :8 ms &gt;</span><br><span class="line">2019-06-14 09:37:31.591  INFO [http-nio-8880-exec-1] c.h.r.f.a.ResponseAdvice - Trace log is ====&gt;  &#123;&quot;url&quot;:&quot;/advertising/getAdvertisingList&quot;,&quot;httpMethod&quot;:&quot;GET&quot;,&quot;reqHeader&quot;:&#123;&quot;host&quot;:&quot;192.168.12.39:8880&quot;,&quot;content-type&quot;:&quot;application/json&quot;,&quot;user-agent&quot;:&quot;curl/7.54.0&quot;,&quot;accept&quot;:&quot;*/*&quot;,&quot;token&quot;:&quot;fe20027352f8250571436f471a988b4d&quot;&#125;,&quot;reqParams&quot;:&quot;page=1&amp;size=1&quot;,&quot;requestBody&quot;:&quot;&quot;,&quot;respParams&quot;:&quot;&#123;\&quot;code\&quot;:200,\&quot;message\&quot;:\&quot;success\&quot;,\&quot;data\&quot;:&#123;\&quot;total\&quot;:9,\&quot;current\&quot;:1,\&quot;pageCount\&quot;:9,\&quot;list\&quot;:[&#123;\&quot;settlementType\&quot;:0,\&quot;imagesUrl\&quot;:\&quot;xxxxxxx\&quot;,\&quot;advertisingName\&quot;:\&quot;hello kitty 111\&quot;,\&quot;advertiserName\&quot;:\&quot;暁\&quot;,\&quot;advertiserId\&quot;:0,\&quot;createTimeymdhm_Str\&quot;:\&quot;2019-06-10 17:27\&quot;,\&quot;advertisingType\&quot;:0,\&quot;createTime\&quot;:1560158854000,\&quot;advertisingPosition\&quot;:0,\&quot;auditStatus\&quot;:4,\&quot;createUser\&quot;:1,\&quot;id\&quot;:0,\&quot;advertiserUrl\&quot;:\&quot;xxxxx\&quot;,\&quot;createTimeStr\&quot;:\&quot;2019-06-10 17:27:34\&quot;&#125;]&#125;&#125;&quot;,&quot;startTime&quot;:1560476250978,&quot;spendTime&quot;:592&#125;</span><br></pre></td></tr></table></figure>

<p>获取完总数后，会进行判断是否有分页的必要。</p>
</li>
<li><p>分页查询。这里假设有分页的必要。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用方言获取分页 sql</span></span><br><span class="line"><span class="type">String</span> <span class="variable">pageSql</span> <span class="operator">=</span> dialect.getPageSql(ms, boundSql, parameter, rowBounds, pageKey);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPageSql</span><span class="params">(MappedStatement ms, BoundSql boundSql, Object parameterObject, RowBounds rowBounds, CacheKey pageKey)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql();</span><br><span class="line">    <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> getLocalPage();</span><br><span class="line">    <span class="comment">//支持 order by</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">orderBy</span> <span class="operator">=</span> page.getOrderBy();</span><br><span class="line">    <span class="keyword">if</span> (StringUtil.isNotEmpty(orderBy)) &#123;</span><br><span class="line">        pageKey.update(orderBy);</span><br><span class="line">        sql = OrderByParser.converToOrderBySql(sql, orderBy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (page.isOrderByOnly()) &#123;</span><br><span class="line">      	<span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// 这是一个抽象方法，会根据具体的数据库，调用不同的实现方法，来在原SQL语句上，加上对应的分页语句</span></span><br><span class="line">    <span class="keyword">return</span> getPageSql(sql, page, pageKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体支持的数据库如下：</p>
<p><img src="/images/pics/468ac30f9649c89d1fcd520080c4db7d.png"></p>
<p>Oracle的分页实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPageSql</span><span class="params">(String sql, Page page, CacheKey pageKey)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sqlBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(sql.length() + <span class="number">120</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot;SELECT * FROM ( &quot;</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; SELECT TMP_PAGE.*, ROWNUM ROW_ID FROM ( &quot;</span>);</span><br><span class="line">    sqlBuilder.append(sql);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; ) TMP_PAGE WHERE ROWNUM &lt;= ? &quot;</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; ) WHERE ROW_ID &gt; ? &quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> sqlBuilder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MySQL的分页实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPageSql</span><span class="params">(String sql, Page page, CacheKey pageKey)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sqlBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(sql.length() + <span class="number">14</span>);</span><br><span class="line">    sqlBuilder.append(sql);</span><br><span class="line">    <span class="keyword">if</span> (page.getStartRow() == <span class="number">0</span>) &#123;</span><br><span class="line">      	sqlBuilder.append(<span class="string">&quot; LIMIT ? &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	sqlBuilder.append(<span class="string">&quot; LIMIT ?, ? &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    pageKey.update(page.getPageSize());</span><br><span class="line">    <span class="keyword">return</span> sqlBuilder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>保存分页查询后的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// resultList是分页查询后的数据列表</span></span><br><span class="line"><span class="comment">// afterPage的返回值是有两种情况，但是都可以被转成List</span></span><br><span class="line"><span class="keyword">return</span> dialect.afterPage(resultList, parameter, rowBounds);</span><br><span class="line"></span><br><span class="line"><span class="comment">// dialect.afterPage()方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">afterPage</span><span class="params">(List pageList, Object parameterObject, RowBounds rowBounds)</span> &#123;</span><br><span class="line">    <span class="comment">//这个方法即使不分页也会被执行，所以要判断 null</span></span><br><span class="line">    <span class="type">AbstractHelperDialect</span> <span class="variable">delegate</span> <span class="operator">=</span> autoDialect.getDelegate();</span><br><span class="line">    <span class="keyword">if</span>(delegate != <span class="literal">null</span>)&#123;</span><br><span class="line">      	<span class="keyword">return</span> delegate.afterPage(pageList, parameterObject, rowBounds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pageList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// delegate.afterPage()方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">afterPage</span><span class="params">(List pageList, Object parameterObject, RowBounds rowBounds)</span> &#123;</span><br><span class="line">    <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="literal">null</span>) &#123;</span><br><span class="line">      	<span class="keyword">return</span> pageList;</span><br><span class="line">    &#125;</span><br><span class="line">    page.addAll(pageList);</span><br><span class="line">    <span class="keyword">if</span> (!page.isCount()) &#123;</span><br><span class="line">      	page.setTotal(-<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((page.getPageSizeZero() != <span class="literal">null</span> &amp;&amp; page.getPageSizeZero()) &amp;&amp; page.getPageSize() == <span class="number">0</span>) &#123;</span><br><span class="line">      	page.setTotal(pageList.size());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(page.isOrderByOnly())&#123;</span><br><span class="line">      	page.setTotal(pageList.size());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这里有一个问题是，如果delegate不为空，那么返回的是<code>Page</code>，但是我们在调用<code>xxxxxMapper</code>的查询方法之后，返回值基本上是<code>List</code>，与我们的常识并不符合。那<code>Page</code>是什么呢？它不只是包含分页信息的基本类，它继承自ArrayList。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Page</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">ArrayList</span>&lt;E&gt; <span class="keyword">implements</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在return后，还会执行finally中的处理代码，即<code>com.haylion.realTimeBus.interceptor.sql.MyPageHelper</code>的<code>afterAll()</code>方法。其中实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.haylion.realTimeBus.interceptor.sql.MyPageHelper.afterAll()</span></span><br><span class="line"><span class="comment">// 这个方法是我们自定义的方法，用来处理执行完前面所述的切点后，保留分页信息，进行再次封装</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterAll</span><span class="params">()</span> &#123;</span><br><span class="line">    Page&lt;Object&gt; localPage = getLocalPage();</span><br><span class="line">  	<span class="comment">// 删除分页信息</span></span><br><span class="line">    <span class="built_in">super</span>.afterAll();</span><br><span class="line">  	<span class="comment">// 设置回本线程中</span></span><br><span class="line">    setLocalPage(localPage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// super.afterAll()。这个方法可以简单理解成，清楚掉本线程中的分页信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterAll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//这个方法即使不分页也会被执行，所以要判断 null</span></span><br><span class="line">    <span class="type">AbstractHelperDialect</span> <span class="variable">delegate</span> <span class="operator">=</span> autoDialect.getDelegate();</span><br><span class="line">    <span class="keyword">if</span> (delegate != <span class="literal">null</span>) &#123;</span><br><span class="line">        delegate.afterAll();</span><br><span class="line">        autoDialect.clearDelegate();</span><br><span class="line">    &#125;</span><br><span class="line">    clearPage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除本地变量</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clearPage</span><span class="params">()</span> &#123;</span><br><span class="line">  	LOCAL_PAGE.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过上述的过程，<code>MyPageInterceptor</code>执行完毕，分页信息存储在本线程中，然后回到切面处理。</p>
</li>
</ul>
<p><strong>切面收尾工作（回到<code>SystemAdvice</code>）</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">after</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    PageInfo&lt;?&gt; pageInfo;</span><br><span class="line">    Page&lt;Object&gt; localPage = PageHelper.getLocalPage();</span><br><span class="line">    <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> localPage.getTotal();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageNum</span> <span class="operator">=</span> localPage.getPageNum();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pages</span> <span class="operator">=</span> localPage.getPages();</span><br><span class="line">    List&lt;?&gt; list = (List&lt;?&gt;) obj;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">    pageInfo = <span class="keyword">new</span> <span class="title class_">PageInfo</span>((list));</span><br><span class="line">    ResultPageView&lt;?&gt; resultPageView = <span class="keyword">new</span> <span class="title class_">ResultPageView</span>&lt;&gt;(total, pageNum, pages, pageInfo.getList());</span><br><span class="line">    <span class="keyword">return</span> resultPageView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，还有最重要的一个步骤，是在切面处理完成后，将分页信息从本线程中删除，没有此操作，后续操作会出现莫名其妙的错误。也就是finally语句中的<code>PageHelper.clearPage();</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    prepare(proceedingJoinPoint);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> after(obj);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">    logger.error(<span class="string">&quot;aspect execute error : &quot;</span>, throwable);</span><br><span class="line">    <span class="keyword">throw</span> throwable;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    PageHelper.clearPage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="局限"><a href="#局限" class="headerlink" title="局限"></a>局限</h4><p>这就限定了在一个被<code>PageAble</code>注解了的方法上，只能执行一条查询。如果对于一个到来的请求，需要进行两次或以上的查询，并且某一条查询需要分页的情况，如果所有的查询都放在被<code>PageAble</code>注解的方法下，执行会出现问题（出现不必要的分页操作）。但是可以通过组装的形式，完成该项需求。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-05-22T07:05:11.000Z" title="5/22/2019, 3:05:11 PM">2019-05-22</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:19.266Z" title="2/9/2021, 11:03:19 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">15 分钟读完 (大约2246个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/05/22/282f6dc55840.html">MyBatis中的#与$符号的区别</a></p><div class="content"><p>Mybatis中有很多可以学习的地方，#和$是两种常见的值替换方式，今天站在源码的角度去分析其解析过程。</p>
<h2 id="关键源码"><a href="#关键源码" class="headerlink" title="关键源码"></a>关键源码</h2><p>因为这段代码功能单一，对后续的流程影响不大，搞清楚这段代码的作用，基本上<code>#&#123;&#125;</code>和<code>$&#123;&#125;</code>的区别，在源代码上已经是清楚了。了解了这段代码之后，再进行后续的解析流程，就不会陷入这段代码的逻辑中，将整个视野投入到流程当中。</p>
<p>位置：<code>GenericTokenParser.java</code> –&gt; <code>parse()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String openToken;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String closeToken;</span><br><span class="line"><span class="comment">// 当匹配到#&#123;&#125;或$&#123;&#125;后，对其中的文本进行的操作。</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TokenHandler handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">GenericTokenParser</span><span class="params">(String openToken, String closeToken, TokenHandler handler)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.openToken = openToken;</span><br><span class="line">    <span class="built_in">this</span>.closeToken = closeToken;</span><br><span class="line">    <span class="built_in">this</span>.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先它有3个成员变量，可以理解成：当匹配到已<code>openToken</code>开头，<code>closeToken</code>结尾的字符串后，对其中的字符串执行<code>handler.handleToken()</code>方法。</p>
<p>这个handler就是一个典型的策略模式。它是一个只含有&#96;&#96;函数的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TokenHandler</span> &#123;</span><br><span class="line">    String <span class="title function_">handleToken</span><span class="params">(String content)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说<code>#&#123;&#125;</code>和<code>$&#123;&#125;</code>的处理逻辑都是封装到<code>handleToken</code>中。</p>
<p>寻找是否含有<code>#&#123;&#125;</code>和<code>$&#123;&#125;</code>的逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericTokenParser</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">parse</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="literal">null</span> || text.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// search open token</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> text.indexOf(openToken, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (start == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> text;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span>[] src = text.toCharArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">expression</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (start &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (start &gt; <span class="number">0</span> &amp;&amp; src[start - <span class="number">1</span>] == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// this open token is escaped. remove the backslash and continue.</span></span><br><span class="line">                builder.append(src, offset, start - offset - <span class="number">1</span>).append(openToken);</span><br><span class="line">                offset = start + openToken.length();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// found open token. let&#x27;s search close token.</span></span><br><span class="line">                <span class="keyword">if</span> (expression == <span class="literal">null</span>) &#123;</span><br><span class="line">                    expression = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    expression.setLength(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                builder.append(src, offset, start - offset);</span><br><span class="line">                offset = start + openToken.length();</span><br><span class="line">                <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> text.indexOf(closeToken, offset);</span><br><span class="line">                <span class="keyword">while</span> (end &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (end &gt; offset &amp;&amp; src[end - <span class="number">1</span>] == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">                        <span class="comment">// this close token is escaped. remove the backslash and continue.</span></span><br><span class="line">                        expression.append(src, offset, end - offset - <span class="number">1</span>).append(closeToken);</span><br><span class="line">                        offset = end + closeToken.length();</span><br><span class="line">                        end = text.indexOf(closeToken, offset);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        expression.append(src, offset, end - offset);</span><br><span class="line">                        offset = end + closeToken.length();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (end == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// close token was not found.</span></span><br><span class="line">                    builder.append(src, start, src.length - start);</span><br><span class="line">                    offset = src.length;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    builder.append(handler.handleToken(expression.toString()));</span><br><span class="line">                    offset = end + closeToken.length();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            start = text.indexOf(openToken, offset);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset &lt; src.length) &#123;</span><br><span class="line">            builder.append(src, offset, src.length - offset);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用到<code>GenericTokenParser</code>的地方如下图所示：</p>
<p><img src="/images/pics/64292a33b68aefdf93a9f2120f4a4df5.png" alt="用到的地方"></p>
<p>仔细看一看上面的图片，会有一个疑问，<strong>那就是为什么<code>#&#123;&#125;</code>和<code>$&#123;&#125;</code>分别有2种不同的解析方法</strong>？这个可以在后面的分析中得出答案。这里直接给出我们平常所认为的那种处理方式的源代码，即#变成？，然后$直接变成相应的值，如下：</p>
<ul>
<li><p><code>#&#123;&#125;</code>的处理方式</p>
<p>  位置：<code>SqlSourceBuidler.java</code> –&gt; <code>ParameterMappingTokenHandler</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handleToken</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    parameterMappings.add(buildParameterMapping(content));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;?&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>$&#123;&#125;</code>的处理方式</p>
<p>  位置：<code>PropertyParser.java</code> –&gt; <code>VariableTokenHandler</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handleToken</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (variables != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> content;</span><br><span class="line">        <span class="keyword">if</span> (enableDefaultValue) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">separatorIndex</span> <span class="operator">=</span> content.indexOf(defaultValueSeparator);</span><br><span class="line">            <span class="type">String</span> <span class="variable">defaultValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (separatorIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                key = content.substring(<span class="number">0</span>, separatorIndex);</span><br><span class="line">                defaultValue = content.substring(separatorIndex + defaultValueSeparator.length());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (defaultValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> variables.getProperty(key, defaultValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (variables.containsKey(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> variables.getProperty(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;$&#123;&quot;</span> + content + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>从上面的代码来看，基本上的问题已经解决了。下面是MyBatis对XML中SQL语句的解析流程的分析。</p>
<h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>));</span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">session</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">    <span class="type">BizDriverMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> session.getMapper(BizDriverMapper.class);</span><br><span class="line">    List&lt;BizDriver&gt; list = mapper.getByNameOrNumber(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    System.out.println(list.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="构建SqlSessionFactory阶段"><a href="#构建SqlSessionFactory阶段" class="headerlink" title="构建SqlSessionFactory阶段"></a>构建SqlSessionFactory阶段</h2><p><code>SqlSessionFactoryBuilder.java</code> –&gt; <code>build(InputStream, String, Properties)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">build</span><span class="params">(InputStream inputStream, String environment, Properties properties)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">XMLConfigBuilder</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLConfigBuilder</span>(inputStream, environment, properties);</span><br><span class="line">      <span class="keyword">return</span> build(parser.parse());</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>XMLConfigBuilder.java</code> –&gt; <code>parse()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Configuration <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (parsed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    parsed = <span class="literal">true</span>;</span><br><span class="line">    parseConfiguration(parser.evalNode(<span class="string">&quot;/configuration&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> configuration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>XMLConfigBuilder.java</code> –&gt; <code>parseConfiguration()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseConfiguration</span><span class="params">(XNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//issue #117 read properties first</span></span><br><span class="line">        propertiesElement(root.evalNode(<span class="string">&quot;properties&quot;</span>));</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">settings</span> <span class="operator">=</span> settingsAsProperties(root.evalNode(<span class="string">&quot;settings&quot;</span>));</span><br><span class="line">        loadCustomVfs(settings);</span><br><span class="line">        typeAliasesElement(root.evalNode(<span class="string">&quot;typeAliases&quot;</span>));</span><br><span class="line">        pluginElement(root.evalNode(<span class="string">&quot;plugins&quot;</span>));</span><br><span class="line">        objectFactoryElement(root.evalNode(<span class="string">&quot;objectFactory&quot;</span>));</span><br><span class="line">        objectWrapperFactoryElement(root.evalNode(<span class="string">&quot;objectWrapperFactory&quot;</span>));</span><br><span class="line">        reflectorFactoryElement(root.evalNode(<span class="string">&quot;reflectorFactory&quot;</span>));</span><br><span class="line">        settingsElement(settings);</span><br><span class="line">        <span class="comment">// read it after objectFactory and objectWrapperFactory issue #631</span></span><br><span class="line">        environmentsElement(root.evalNode(<span class="string">&quot;environments&quot;</span>));</span><br><span class="line">        databaseIdProviderElement(root.evalNode(<span class="string">&quot;databaseIdProvider&quot;</span>));</span><br><span class="line">        typeHandlerElement(root.evalNode(<span class="string">&quot;typeHandlers&quot;</span>));</span><br><span class="line">        mapperElement(root.evalNode(<span class="string">&quot;mappers&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>XMLConfigBuilder.java</code> –&gt; <code>mapperElement()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">mapperPackage</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                configuration.addMappers(mapperPackage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">mapperClass</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (resource != <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ErrorContext.instance().resource(resource);</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);</span><br><span class="line">                    <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">                    mapperParser.parse();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url != <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ErrorContext.instance().resource(url);</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getUrlAsStream(url);</span><br><span class="line">                    <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, url, configuration.getSqlFragments());</span><br><span class="line">                    mapperParser.parse();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass != <span class="literal">null</span>) &#123;</span><br><span class="line">                    Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">                    configuration.addMapper(mapperInterface);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>XMLMapperBuilder.java</code> –&gt; <code>parse()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">        configurationElement(parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));</span><br><span class="line">        configuration.addLoadedResource(resource);</span><br><span class="line">        bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    parsePendingStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>XMLMapperBuilder.java</code> –&gt; <code>configurationElement()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configurationElement</span><span class="params">(XNode context)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (namespace == <span class="literal">null</span> || namespace.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">        cacheRefElement(context.evalNode(<span class="string">&quot;cache-ref&quot;</span>));</span><br><span class="line">        cacheElement(context.evalNode(<span class="string">&quot;cache&quot;</span>));</span><br><span class="line">        parameterMapElement(context.evalNodes(<span class="string">&quot;/mapper/parameterMap&quot;</span>));</span><br><span class="line">        resultMapElements(context.evalNodes(<span class="string">&quot;/mapper/resultMap&quot;</span>));</span><br><span class="line">        sqlElement(context.evalNodes(<span class="string">&quot;/mapper/sql&quot;</span>));</span><br><span class="line">        <span class="comment">// 处理sql的入口</span></span><br><span class="line">        buildStatementFromContext(context.evalNodes(<span class="string">&quot;select|insert|update|delete&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error parsing Mapper XML. The XML location is &#x27;&quot;</span> + resource + <span class="string">&quot;&#x27;. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理sql的入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (configuration.getDatabaseId() != <span class="literal">null</span>) &#123;</span><br><span class="line">        buildStatementFromContext(list, configuration.getDatabaseId());</span><br><span class="line">    &#125;</span><br><span class="line">    buildStatementFromContext(list, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">XMLStatementBuilder</span> <span class="variable">statementParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            statementParser.parseStatementNode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">            configuration.addIncompleteStatement(statementParser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>XMLStatementBuilder.java</code> –&gt; <code>parseStatementNode()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseStatementNode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">databaseId</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="built_in">this</span>.requiredDatabaseId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">fetchSize</span> <span class="operator">=</span> context.getIntAttribute(<span class="string">&quot;fetchSize&quot;</span>);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">timeout</span> <span class="operator">=</span> context.getIntAttribute(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">parameterMap</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;parameterMap&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">parameterType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;parameterType&quot;</span>);</span><br><span class="line">    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultMap</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultType&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">lang</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;lang&quot;</span>);</span><br><span class="line">    <span class="type">LanguageDriver</span> <span class="variable">langDriver</span> <span class="operator">=</span> getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultSetType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultSetType&quot;</span>);</span><br><span class="line">    <span class="type">StatementType</span> <span class="variable">statementType</span> <span class="operator">=</span> StatementType.valueOf(context.getStringAttribute(<span class="string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));</span><br><span class="line">    <span class="type">ResultSetType</span> <span class="variable">resultSetTypeEnum</span> <span class="operator">=</span> resolveResultSetType(resultSetType);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">nodeName</span> <span class="operator">=</span> context.getNode().getNodeName();</span><br><span class="line">    <span class="type">SqlCommandType</span> <span class="variable">sqlCommandType</span> <span class="operator">=</span> SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSelect</span> <span class="operator">=</span> sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flushCache</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;flushCache&quot;</span>, !isSelect);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">useCache</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;useCache&quot;</span>, isSelect);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">resultOrdered</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;resultOrdered&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Include Fragments before parsing</span></span><br><span class="line">    <span class="type">XMLIncludeTransformer</span> <span class="variable">includeParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLIncludeTransformer</span>(configuration, builderAssistant);</span><br><span class="line">    includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse selectKey after includes and remove them.</span></span><br><span class="line">    processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span></span><br><span class="line">    <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultSets</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultSets&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">keyProperty</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;keyProperty&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">keyColumn</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;keyColumn&quot;</span>);</span><br><span class="line">    KeyGenerator keyGenerator;</span><br><span class="line">    <span class="type">String</span> <span class="variable">keyStatementId</span> <span class="operator">=</span> id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">        keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        keyGenerator = context.getBooleanAttribute(<span class="string">&quot;useGeneratedKeys&quot;</span>,</span><br><span class="line">                configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">                ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">            fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">            resultSetTypeEnum, flushCache, useCache, resultOrdered,</span><br><span class="line">            keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中createSqlSource()的对象langDriver来自<code>XMLLanguageDriver</code></p>
<p><code>XMLLanguageDriver.java</code> –&gt; <code>createSqlSource()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SqlSource <span class="title function_">createSqlSource</span><span class="params">(Configuration configuration, XNode script, Class&lt;?&gt; parameterType)</span> &#123;</span><br><span class="line">	<span class="type">XMLScriptBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLScriptBuilder</span>(configuration, script, parameterType);</span><br><span class="line">	<span class="keyword">return</span> builder.parseScriptNode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>关键步骤：</strong><code>XMLScriptBuilder.java</code> –&gt; <code>parseScriptNode()</code></p>
<p>这里面的每一行代码都可以仔细去看、并理解它的意思</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SqlSource <span class="title function_">parseScriptNode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 判定是否含有$&#123;&#125;,如果有，isDynamic--&gt;true</span></span><br><span class="line">    <span class="type">MixedSqlNode</span> <span class="variable">rootSqlNode</span> <span class="operator">=</span> parseDynamicTags(context);</span><br><span class="line">    <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isDynamic) &#123;</span><br><span class="line">        <span class="comment">// 有$&#123;&#125;不做任何处理</span></span><br><span class="line">        sqlSource = <span class="keyword">new</span> <span class="title class_">DynamicSqlSource</span>(configuration, rootSqlNode);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有$&#123;&#125;，把#&#123;&#125;都替换成?</span></span><br><span class="line">        sqlSource = <span class="keyword">new</span> <span class="title class_">RawSqlSource</span>(configuration, rootSqlNode, parameterType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sqlSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的分析可知，会有两种情况，即是否为动态。一条语句开始的时候都被包装成<code>MixedSqlNode</code>，然后再通过判断是否为动态，将其封装成<code>DynamicSqlSource</code>和<code>RawSqlSource</code>。这两种的含义是：<code>DynamicSqlSource</code>有<code>$&#123;&#125;</code>不做任何处理，<code>RawSqlSource</code>没有${}，把#{}都替换成?。是如何分配的呢？是通过<code>GenericTokenParser</code>来寻找<code>$</code>符号，然后在<code>handler</code>中，将<code>isDynamic</code>标记为true，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> MixedSqlNode <span class="title function_">parseDynamicTags</span><span class="params">(XNode node)</span> &#123;</span><br><span class="line">    List&lt;SqlNode&gt; contents = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SqlNode&gt;();</span><br><span class="line">    <span class="type">NodeList</span> <span class="variable">children</span> <span class="operator">=</span> node.getNode().getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">        <span class="type">XNode</span> <span class="variable">child</span> <span class="operator">=</span> node.newXNode(children.item(i));</span><br><span class="line">        <span class="keyword">if</span> (child.getNode().getNodeType() == Node.CDATA_SECTION_NODE || child.getNode().getNodeType() == Node.TEXT_NODE) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> child.getStringBody(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="type">TextSqlNode</span> <span class="variable">textSqlNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextSqlNode</span>(data);</span><br><span class="line">            <span class="comment">// isDynamic()中封装了对GenericTokenParser的调用</span></span><br><span class="line">            <span class="keyword">if</span> (textSqlNode.isDynamic()) &#123;</span><br><span class="line">                contents.add(textSqlNode);</span><br><span class="line">                isDynamic = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                contents.add(<span class="keyword">new</span> <span class="title class_">StaticTextSqlNode</span>(data));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getNode().getNodeType() == Node.ELEMENT_NODE) &#123; <span class="comment">// issue #628</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">nodeName</span> <span class="operator">=</span> child.getNode().getNodeName();</span><br><span class="line">            XMLScriptBuilder.<span class="type">NodeHandler</span> <span class="variable">handler</span> <span class="operator">=</span> nodeHandlerMap.get(nodeName);</span><br><span class="line">            <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Unknown element &lt;&quot;</span> + nodeName + <span class="string">&quot;&gt; in SQL statement.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            handler.handleNode(child, contents);</span><br><span class="line">            isDynamic = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MixedSqlNode</span>(contents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>isDynamic()</code>中封装了对<code>GenericTokenParser</code>的调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isDynamic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DynamicCheckerTokenParser</span> <span class="variable">checker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DynamicCheckerTokenParser</span>();</span><br><span class="line">    <span class="type">GenericTokenParser</span> <span class="variable">parser</span> <span class="operator">=</span> createParser(checker);</span><br><span class="line">    parser.parse(text);</span><br><span class="line">    <span class="keyword">return</span> checker.isDynamic();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DynamicCheckerTokenParser</span> <span class="keyword">implements</span> <span class="title class_">TokenHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isDynamic;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DynamicCheckerTokenParser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Prevent Synthetic Access</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isDynamic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> isDynamic;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将本对象的变量置为true</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleToken</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.isDynamic = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在处理<code>RawSqlSource</code>时的初始化过程如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">RawSqlSource</span><span class="params">(Configuration configuration, SqlNode rootSqlNode, Class&lt;?&gt; parameterType)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(configuration, getSql(configuration, rootSqlNode), parameterType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">RawSqlSource</span><span class="params">(Configuration configuration, String sql, Class&lt;?&gt; parameterType)</span> &#123;</span><br><span class="line">    <span class="type">SqlSourceBuilder</span> <span class="variable">sqlSourceParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSourceBuilder</span>(configuration);</span><br><span class="line">    Class&lt;?&gt; clazz = parameterType == <span class="literal">null</span> ? Object.class : parameterType;</span><br><span class="line">    <span class="comment">// 所有的#&#123;&#125;都将被替换成？</span></span><br><span class="line">    sqlSource = sqlSourceParser.parse(sql, clazz, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SqlSourceBuilder.java</span></span><br><span class="line"><span class="keyword">public</span> SqlSource <span class="title function_">parse</span><span class="params">(String originalSql, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters)</span> &#123;</span><br><span class="line">    <span class="type">ParameterMappingTokenHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParameterMappingTokenHandler</span>(configuration, parameterType, additionalParameters);</span><br><span class="line">    <span class="type">GenericTokenParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericTokenParser</span>(<span class="string">&quot;#&#123;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>, handler);</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> parser.parse(originalSql);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StaticSqlSource</span>(configuration, sql, handler.getParameterMappings());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>ParameterMappingTokenHandler</code>的<code>handleToken()</code>方法，也就是匹配成功后的回调，实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handleToken</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    parameterMappings.add(buildParameterMapping(content));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;?&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在处理<code>RawSqlSource</code>时，没有这方面的处理，因此在这里就不贴其代码流程。反思：<strong>因为这是初始化阶段，可以理解成开机启动脚本，所以<code>#&#123;&#125;</code>的值是确定的，也就是说要变成<code>？</code>，而<code>$&#123;&#125;</code>的值在这个阶段就是未知的，因为还没有具体的SQL语句要生成，直接替换的数据还不确定，所以含有<code>$&#123;&#125;</code>的语句，在初始化阶段是先不处理。</strong></p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/xu1916659422/article/details/77918175">https://blog.csdn.net/xu1916659422/article/details/77918175</a> 在此基础上进行了校正，并加入了自己的理解</li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/zh/getting-started.html">http://www.mybatis.org/mybatis-3/zh/getting-started.html</a> 进行基本的配置</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-04-20T00:27:58.000Z" title="4/20/2019, 8:27:58 AM">2019-04-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:44.146Z" title="2/9/2021, 11:03:44 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">5 分钟读完 (大约818个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/04/20/789be84ae481.html">Flask如何使用logging.FileHandler将日志保存到文件</a></p><div class="content"><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>将日志尽可能往文件中输，自带的默认只输出到屏幕上。</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>获取文件名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_custom_file_name</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_dir</span>(<span class="params">make_dir_path</span>):</span><br><span class="line">        path = make_dir_path.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            os.makedirs(path)</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line">    log_dir = <span class="string">&quot;ac_logs&quot;</span></span><br><span class="line">    file_name = <span class="string">&#x27;logger-&#x27;</span> + time.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>, time.localtime(time.time())) + <span class="string">&#x27;.log&#x27;</span></span><br><span class="line">    file_folder = os.path.abspath(os.path.dirname(__file__)) + os.sep + log_dir</span><br><span class="line">    make_dir(file_folder)</span><br><span class="line">    <span class="keyword">return</span> file_folder + os.sep + file_name</span><br></pre></td></tr></table></figure>
<p>配置logging</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dictConfig(&#123;</span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;formatters&#x27;</span>: &#123;<span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(asctime)s - %(levelname)s - %(filename)s - %(funcName)s - %(lineno)s - %(message)s&#x27;</span>,</span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;stream&#x27;</span>: <span class="string">&#x27;ext://flask.logging.wsgi_errors_stream&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;default&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;custom&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span> : <span class="string">&#x27;logging.FileHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;default&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span> : get_custom_file_name(),</span><br><span class="line">            <span class="string">&#x27;encoding&#x27;</span> : <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;root&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;custom&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>在官方文档中，有一个默认的handler，当我添加一个自定义的handler，名叫custom的时候，读取配置失败，程序中断，也就无法继续执行下去，提示说，<strong>少一个叫做filename的参数</strong>。</p>
<p>loggin.FileHandler的构造函数中，有一个必填的参数，叫做<code>filename</code>。如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileHandler</span>(<span class="title class_ inherited__">StreamHandler</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A handler class which writes formatted logging records to disk files.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, filename, mode=<span class="string">&#x27;a&#x27;</span>, encoding=<span class="literal">None</span>, delay=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Open the specified file and use it as the stream for logging.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Issue #27493: add support for Path objects to be passed in</span></span><br><span class="line">        filename = os.fspath(filename)</span><br><span class="line">        <span class="comment">#keep the absolute path, otherwise derived classes which use this</span></span><br><span class="line">        <span class="comment">#may come a cropper when the current directory changes</span></span><br><span class="line">        <span class="variable language_">self</span>.baseFilename = os.path.abspath(filename)</span><br><span class="line">        <span class="variable language_">self</span>.mode = mode</span><br><span class="line">        <span class="variable language_">self</span>.encoding = encoding</span><br><span class="line">        <span class="variable language_">self</span>.delay = delay</span><br></pre></td></tr></table></figure>

<p><strong>如何才能传入参数<code>filename</code>?</strong></p>
<p>①进入<code>dictConfig()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dictConfig</span>(<span class="params">config</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Configure logging using a dictionary.&quot;&quot;&quot;</span></span><br><span class="line">    dictConfigClass(config).configure()</span><br></pre></td></tr></table></figure>
<p>②进入<code>configure()</code>，找到对handler的处理逻辑，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前面的代码省略</span></span><br><span class="line"><span class="comment"># 获取handlers</span></span><br><span class="line">handlers = config.get(<span class="string">&#x27;handlers&#x27;</span>, EMPTY_DICT)</span><br><span class="line">deferred = []</span><br><span class="line"><span class="comment"># 遍历其中的每一个handler</span></span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> <span class="built_in">sorted</span>(handlers):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	<span class="comment"># 具体处理每一个handler</span></span><br><span class="line">        handler = <span class="variable language_">self</span>.configure_handler(handlers[name])</span><br><span class="line">        handler.name = name</span><br><span class="line">        handlers[name] = handler</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;target not configured yet&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(e.__cause__):</span><br><span class="line">            deferred.append(name)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Unable to configure handler &#x27;</span></span><br><span class="line">                             <span class="string">&#x27;%r&#x27;</span> % name) <span class="keyword">from</span> e</span><br><span class="line"><span class="comment"># 后面的代码省略</span></span><br></pre></td></tr></table></figure>
<p>③进入具体处理handler的逻辑，<code>self.configure_handler()</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">configure_handler</span>(<span class="params">self, config</span>):</span><br><span class="line">    <span class="comment"># 省略代码若干行 ...</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;()&#x27;</span> <span class="keyword">in</span> config:</span><br><span class="line">        c = config.pop(<span class="string">&#x27;()&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">callable</span>(c):</span><br><span class="line">            c = <span class="variable language_">self</span>.resolve(c)</span><br><span class="line">        factory = c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cname = config.pop(<span class="string">&#x27;class&#x27;</span>)</span><br><span class="line">        klass = <span class="variable language_">self</span>.resolve(cname)</span><br><span class="line">        <span class="comment"># 省略代码若干行 ...</span></span><br><span class="line">        <span class="comment"># 此处的kclass就是配置的class名所对应的类</span></span><br><span class="line">        factory = klass</span><br><span class="line">    props = config.pop(<span class="string">&#x27;.&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># 读取完类名，获取到该类、获取了formatter之后，接着读取conf里面的数据</span></span><br><span class="line">    <span class="comment"># 在这里将剩下所定义的参数，弄成dict类型的数据</span></span><br><span class="line">    kwargs = &#123;k: config[k] <span class="keyword">for</span> k <span class="keyword">in</span> config <span class="keyword">if</span> valid_ident(k)&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	<span class="comment"># 直接将dict类型的数据作为函数入参，实例化出一个FileHandler</span></span><br><span class="line">        result = factory(**kwargs)</span><br><span class="line">    <span class="keyword">except</span> TypeError <span class="keyword">as</span> te:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;&#x27;stream&#x27;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(te):</span><br><span class="line">            <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>
<p>其中的调试数据截图如下：<br><img src="/images/pics/e483f3a082e2bd8d0bee248c2f5e5e70.png" alt="在这里插入图片描述"><br>如果没有配置filename的信息，那么实例化类的时候就报错也是理所应当，因此还可以尝试性地配置encoding参数到其中，工作正常。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>虽然对这一块的整体了解还不够，但是对于能够参照官方文档，参考源代码实现，完成自己的想法，做到的那一刻还是有点成就感。</p>
<p><strong>【参考】</strong><br>官方文档：<a target="_blank" rel="noopener" href="http://flask.pocoo.org/docs/dev/logging">http://flask.pocoo.org/docs/dev/logging</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/page/0/">上一页</a></div><div class="pagination-next"><a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">1</a></li><li><a class="pagination-link" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="M系列MacBook连接l2tp时失败的问题修复"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">M系列MacBook连接l2tp时失败的问题修复</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rust学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rust学习笔记</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/b0874d97f2ec.html"><img src="/images/pics/8a16be7bbc191e48a6e5b08755f591ec.png" alt="01.AI概览"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/b0874d97f2ec.html">01.AI概览</a></p><p class="categories"><a href="/categories/AI/">AI</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calico证书学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calico证书学习笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="如何在YAML文件中进行优雅地换行"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">如何在YAML文件中进行优雅地换行</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a><p class="is-size-7"><span>&copy; 2024 遇寻</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>