<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>关于 kubectl apply 的流程分析 - 遇寻笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="遇寻笔记"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="遇寻笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Server Side Apply资源读取Patch 计算与 APIServer 交互"><meta property="og:type" content="article"><meta property="og:title" content="关于 kubectl apply 的流程分析"><meta property="og:url" content="https://eucham.me/2022/06/09/d092d4969a94.html"><meta property="og:site_name" content="遇寻笔记"><meta property="og:description" content="Server Side Apply资源读取Patch 计算与 APIServer 交互"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/images/pics/e9f22d889a230bfda8e24c0a981740a8.png"><meta property="article:published_time" content="2022-06-09T09:36:30.782Z"><meta property="article:modified_time" content="2022-06-13T15:25:25.545Z"><meta property="article:author" content="遇寻"><meta property="article:tag" content="kubernetes"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me/2022/06/09/d092d4969a94.html"},"headline":"关于 kubectl apply 的流程分析","image":["https://eucham.me/images/pics/e9f22d889a230bfda8e24c0a981740a8.png"],"datePublished":"2022-06-09T09:36:30.782Z","dateModified":"2022-06-13T15:25:25.545Z","author":{"@type":"Person","name":"遇寻"},"publisher":{"@type":"Organization","name":"遇寻笔记","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"Server Side Apply资源读取Patch 计算与 APIServer 交互"}</script><link rel="canonical" href="https://eucham.me/2022/06/09/d092d4969a94.html"><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-06-09T09:36:30.782Z" title="6/9/2022, 5:36:30 PM">2022-06-09</time>发表</span><span class="level-item"><time dateTime="2022-06-13T15:25:25.545Z" title="6/13/2022, 11:25:25 PM">2022-06-13</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">11 分钟读完 (大约1717个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">关于 kubectl apply 的流程分析</h1><div class="content"><blockquote>
<p>本文主要介绍与 <code>kubectl apply</code> 相关的几个概念、相关操作的主要逻辑，主要包括 <code>Server Side Apply</code>、<code>Client Side Apply</code>。</p>
</blockquote>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><blockquote>
<p>这里其实可以直接用 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes">kubernetes 仓库</a>，但它里面的内容太多，如果只用 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubectl.git">kubectl 仓库</a> 看起来会更简洁、纯粹。</p>
</blockquote>
<ul>
<li>Kubernetes 集群</li>
<li>克隆 <code>kubectl</code> 的源代码到本地用 GoLand 打开<ul>
<li><code>git clone https://github.com/kubernetes/kubectl.git</code></li>
</ul>
</li>
<li>将程序入口拷贝进 <code>kubectl</code> 中。<ul>
<li><code>cd kubectl</code></li>
<li><code>wget https://github.com/kubernetes/kubernetes/blob/master/cmd/kubectl/kubectl.go</code></li>
</ul>
</li>
<li>修改 <code>doc.go</code> 中包名为 <code>main</code></li>
<li>直接跑 <code>kubectl.go</code> 中的 <code>main</code> 方法来从源码编译、启动 <code>kubectl</code> 命令。<ul>
<li>添加如下命令参数：<code>apply -f testdata/apply/cm.yaml --field-manager=some-controller</code></li>
</ul>
</li>
</ul>
<h2 id="Client-Side-Apply"><a href="#Client-Side-Apply" class="headerlink" title="Client Side Apply"></a>Client Side Apply</h2><p>入口在 <code>pkg/cmd/apply/apply.go</code> 中的 <code>cmdutil.CheckErr(o.Run())</code>。</p>
<h3 id="①-资源读取"><a href="#①-资源读取" class="headerlink" title="① 资源读取"></a>① 资源读取</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">infos, err := o.GetObjects()</span><br></pre></td></tr></table></figure>

<p>这个方法会将 <code>kubectl apply</code> 命令将要操作的对象（通常是本地的文件、文件夹等）加载到到内存中，保存在 <code>info.Object</code> 中，并返回 <code>infos</code> 列表。当把所有需要 <code>apply</code> 的对象读出来后，会通过 <code>for</code> 循环去依次做 <code>apply</code> 操作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, info := <span class="keyword">range</span> infos &#123;</span><br><span class="line">	<span class="keyword">if</span> err := o.applyOneObject(info); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		errs = <span class="built_in">append</span>(errs, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，对每个资源的 <code>apply</code> 操作是分隔开来的，同时，处理的逻辑也进入到 <code>o.applyOneObject(info)</code> 中。</p>
<h3 id="②-处理第一次-apply-操作"><a href="#②-处理第一次-apply-操作" class="headerlink" title="② 处理第一次 apply 操作"></a>② 处理第一次 apply 操作</h3><blockquote>
<p>📢注意：此处的 <code>info.Object</code> 是刚从 kubectl client 端加载进来的内容。</p>
</blockquote>
<p>在从 k8s 集群中进行一次查询前，会先计算出一个 <code>modified</code>，它表示此次 <code>apply</code> 结束后，在目标集群中该资源的终态。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modified, err := util.GetModifiedConfiguration(info.Object, <span class="literal">true</span>, unstructured.UnstructuredJSONScheme)</span><br></pre></td></tr></table></figure>

<p><code>modified</code> 的计算逻辑是先从 <code>info.Object</code> 中删除 <code>kubectl.kubernetes.io/last-applied-configuration</code>，然后将 <code>info.Object</code> 本身作为 <code>kubectl.kubernetes.io/last-applied-configuration</code> 的值塞进去。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetModifiedConfiguration</span><span class="params">(obj runtime.Object, annotate <span class="keyword">bool</span>, codec runtime.Encoder)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> modified []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line">	annots, err := metadataAccessor.Annotations(obj)</span><br><span class="line"></span><br><span class="line">	original := annots[v1.LastAppliedConfigAnnotation]</span><br><span class="line">	<span class="built_in">delete</span>(annots, v1.LastAppliedConfigAnnotation)</span><br><span class="line">	<span class="keyword">if</span> err := metadataAccessor.SetAnnotations(obj, annots); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 此时 modified 等于 info.Object 的 Annotation 减去 kubectl.kubernetes.io/last-applied-configuration</span></span><br><span class="line">	modified, err = runtime.Encode(codec, obj)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> annotate &#123;</span><br><span class="line">    <span class="comment">// 将此时的 modified 作为 kubectl.kubernetes.io/last-applied-configuration 塞进 Annotation 中</span></span><br><span class="line">		annots[v1.LastAppliedConfigAnnotation] = <span class="keyword">string</span>(modified)</span><br><span class="line">		<span class="keyword">if</span> err := metadataAccessor.SetAnnotations(obj, annots); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 重新生成 modified</span></span><br><span class="line">		modified, err = runtime.Encode(codec, obj)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	annots[v1.LastAppliedConfigAnnotation] = original</span><br><span class="line">	<span class="keyword">if</span> err := metadataAccessor.SetAnnotations(obj, annots); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> modified, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当第一次 <code>apply</code> 某个资源到 k8s 集群中时，会显式地执行创建逻辑。对于是否执行创建逻辑，则通过一次对该资源的查询操作来确定。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := info.Get(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !errors.IsNotFound(err) &#123;</span><br><span class="line">		<span class="keyword">return</span> ...</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> o.DryRunStrategy != cmdutil.DryRunClient &#123;</span><br><span class="line">		<span class="comment">// Then create the resource and skip the three-way merge</span></span><br><span class="line">		obj, err := helper.Create(info.Namespace, <span class="literal">true</span>, info.Object)</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		info.Refresh(obj, <span class="literal">true</span>)</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果资源存在，则不会进入该 if 语句，且能够<strong>获取到集群中该资源的定义</strong>，并覆盖 <code>info.Object</code> 字段。</p>
<blockquote>
<p>📢注意：此时的 <code>info.Object</code> 就变成了资源在 k8s 集群中的定义。</p>
</blockquote>
<h3 id="③-客户端重试机制"><a href="#③-客户端重试机制" class="headerlink" title="③ 客户端重试机制"></a>③ 客户端重试机制</h3><p>当 <code>apply</code> 的资源在 k8s 集群中已存在时，会先创建 <code>Patcher</code>，然后调用 <code>patcher.Patch()</code> 方法来完成 patch 操作。其中该函数的入参注释如下：</p>
<ul>
<li><code>current runtime.Object</code>: 当前集群中该资源的定义。</li>
<li><code>modified []byte</code>: 参照第②步中的解释</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化入参</span></span><br><span class="line">helper := resource.NewHelper(info.Client, info.Mapping).</span><br><span class="line">		DryRun(o.DryRunStrategy == cmdutil.DryRunServer).</span><br><span class="line">		WithFieldManager(o.FieldManager).</span><br><span class="line">		WithFieldValidation(o.ValidationDirective)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 patcher</span></span><br><span class="line">patcher, err := newPatcher(o, info, helper)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 Patch 操作</span></span><br><span class="line">patchBytes, patchedObject, err := </span><br><span class="line">	patcher.Patch(info.Object, modified, info.Source, info.Namespace, info.Name, o.ErrOut)</span><br><span class="line">		</span><br></pre></td></tr></table></figure>

<p>进入 <code>patcher.Patch()</code> 之后，是一个特别熟悉的 <code>for</code> 循环。目的是当遇到<strong>冲突</strong>时，（默认5次）进行 <code>maxPatchRetry</code> 重试。执行的主体函数是 <code>p.patchSimple()</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">patchBytes, patchObject, err := p.patchSimple(current, modified, source, namespace, name, errOut)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= p.Retries &amp;&amp; errors.IsConflict(err); i++ &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	current, getErr = p.Helper.Get(namespace, name)</span><br><span class="line">	patchBytes, patchObject, err = p.patchSimple(current, modified, source, namespace, name, errOut)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析下 <code>p.patchSimple()</code> 的入参：</p>
<ul>
<li><code>current -&gt; obj </code>: 当前集群中该资源的定义。</li>
<li><code>modified</code>: 参照第②步中的解释。</li>
</ul>
<h3 id="④-计算-Patch"><a href="#④-计算-Patch" class="headerlink" title="④ 计算 Patch"></a>④ 计算 Patch</h3><p>进入 <code>patchSimple()</code> 后，主要做的操作就是先计算 patch 的内容，这个内容是指<strong>客户端</strong>通过计算，得出来<strong>发生变更的字段</strong>。而计算的方式是 <code>ThreeWayMerge</code>。该函数的定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateThreeWayMergePatch</span><span class="params">(original, modified, current []<span class="keyword">byte</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">	schema LookupPatchMeta, </span></span></span><br><span class="line"><span class="function"><span class="params">	overwrite <span class="keyword">bool</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">	fns ...mergepatch.PreconditionFunc)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>前3个入参对应的含义如下（因为后面 patch 的计算，需要用到此3个入参，搞清楚他们的含义特别重要）：</p>
<ul>
<li><p><code>original</code>: 当前集群中该资源的定义中 Annotations 中 <code>kubectl.kubernetes.io/last-applied-configuration</code> 对应的内容。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">original, err := util.GetOriginalConfiguration(obj)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>modified</code>: 参照第②步中的解释。</p>
</li>
<li><p><code>current</code>: 当前集群中该资源的定义。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">current, err := runtime.Encode(unstructured.UnstructuredJSONScheme, obj)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p> 基于对上面 3 个入参的认知，开始进入 patch 计算的过程，其中的 <code>ThreeWay</code> 应该就是指通过上面的 3 个入参。</p>
</blockquote>
<p>先将 <code>original</code>,<code>modified</code>,<code>current</code> 三个变量转成 <code>map[string]interface&#123;&#125;</code>类型为 <code>originalMap</code>、<code>modifiedMap</code> 、<code>currentMap</code>，以便于后面计算：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">originalMap := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(original) &gt; <span class="number">0</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> err := json.Unmarshal(original, &amp;originalMap); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, mergepatch.ErrBadJSONDoc</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>接下来会计算 3 组数据，分别为</p>
<ul>
<li><p><code>deltaMap</code>: <code>current</code> 与 <code>modified</code> 之间的差异（除去 <code>deletion</code> 操作）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deltaMapDiffOptions := DiffOptions&#123;</span><br><span class="line">  IgnoreDeletions: <span class="literal">true</span>,</span><br><span class="line">  SetElementOrder: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line">deltaMap, err := diffMaps(currentMap, modifiedMap, schema, deltaMapDiffOptions)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>deletionsMap</code>: <code>originalMap</code> 与 <code>modifiedMap</code> 之间的 <code>deletions</code> 操作</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deletionsMapDiffOptions := DiffOptions&#123;</span><br><span class="line">  SetElementOrder:           <span class="literal">true</span>,</span><br><span class="line">  IgnoreChangesAndAdditions: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line">deletionsMap, err := diffMaps(originalMap, modifiedMap, schema, deletionsMapDiffOptions)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>patchMap</code>: <code>deltaMap</code> 和 <code>deletionsMap</code> 执行 <code>merge</code> 操作后得到 <code>patchMap</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mergeOptions := MergeOptions&#123;&#125;</span><br><span class="line">patchMap, err := mergeMap(deletionsMap, deltaMap, schema, mergeOptions)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>最终返回 <code>json.Marshal(patchMap)</code>。至此计算 <code>patch</code> 结束。</p>
<blockquote>
<p>❓为什么 patch 的计算方法是这样的呢？</p>
</blockquote>
<p><img src="/images/pics/XLW8qA.png" alt="XLW8qA"></p>
<h3 id="⑤-发送-PATCH-请求给-api-server"><a href="#⑤-发送-PATCH-请求给-api-server" class="headerlink" title="⑤ 发送 PATCH 请求给 api-server"></a>⑤ 发送 PATCH 请求给 api-server</h3><p>在 <code> strategicpatch.CreateThreeWayMergePatch()</code> 函数执行完后，得到 <code>patch</code> 的结果，然后调用 client 发送 PATCH 请求给到 api-server，如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此种情形得到的 apply 结果是 unchanged。</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">string</span>(patch) == <span class="string">&quot;&#123;&#125;&quot;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> patch, obj, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 client 发送 PATCH 请求</span></span><br><span class="line">patchedObj, err := p.Helper.Patch(namespace, name, patchType, patch, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> patch, patchedObj, err</span><br></pre></td></tr></table></figure>

<h2 id="Server-Side-Apply"><a href="#Server-Side-Apply" class="headerlink" title="Server Side Apply"></a>Server Side Apply</h2><p>官网文档说明见<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/using-api/server-side-apply/">链接</a>。</p>
<p>启用 Server Side Apply 需要添加 <code>--server-side</code> 参数、以及通过 <code>--field-manager=some-controller</code> 来指定 manager（可选）。如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply --server-side --field-manager=some-controller -f testdata/apply/cm.yaml</span><br></pre></td></tr></table></figure>

<p>运行完成后，可以在获取该 ConfigMap 时，添加 <code>--show-managed-fields</code> 参数以展示 <code>managedFields</code> 字段。如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cm test1 -o json --show-managed-fields</span><br></pre></td></tr></table></figure>

<h3 id="冲突"><a href="#冲突" class="headerlink" title="冲突"></a>冲突</h3><p>当本次 apply 操作中想要修改的值，已经被<strong>其它 manager</strong> 管理后，出现的一种状态。主要是为了避免字段被别的用户修改。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>关于 kubectl apply 的流程分析</p><p><a href="https://eucham.me/2022/06/09/d092d4969a94.html">https://eucham.me/2022/06/09/d092d4969a94.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>遇寻</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-06-09</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-06-13</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/kubernetes/">kubernetes</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5f548d5caad6e60013d63db8&amp;product=inline-share-buttons" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/07/14/7a73b54f4876.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Kubernetes 中 apiserver 加载 schema 流程</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/06/01/5c4e354e0c1f.html"><span class="level-item">Go与C、汇编之间的调用</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://eucham.me/2022/06/09/d092d4969a94.html';
            this.page.identifier = '2022/06/09/d092d4969a94.html';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'eucham' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="M系列MacBook连接l2tp时失败的问题修复"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">M系列MacBook连接l2tp时失败的问题修复</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rust学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rust学习笔记</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calico证书学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calico证书学习笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="如何在YAML文件中进行优雅地换行"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">如何在YAML文件中进行优雅地换行</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/25470f32f4bb.html"><img src="/images/pics/kubernetes-cka-color.svg" alt="CKS证书学习资料汇编"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/25470f32f4bb.html">CKS证书学习资料汇编</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a><p class="is-size-7"><span>&copy; 2024 遇寻</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>