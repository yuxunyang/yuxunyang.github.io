<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>3 | Spinnaker 如何执行 pipeline - 遇寻笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="遇寻笔记"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="遇寻笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="本篇文章记录以发布单的形式启动的一个流水线的执行过程，并对相关敏感信息做了删除，但不影响对整体流程的介绍。通过 POST 调用 gate 服务的 pipelines&amp;#x2F;v2&amp;#x2F;{application}&amp;#x2F;{pipeline}@POST(&amp;quot;pipelines&amp;#x2F;v2&amp;#x2F;{application}&amp;#x2F;{"><meta property="og:type" content="article"><meta property="og:title" content="3 | Spinnaker 如何执行 pipeline"><meta property="og:url" content="https://eucham.me/2020/10/31/6ce2d2364228.html"><meta property="og:site_name" content="遇寻笔记"><meta property="og:description" content="本篇文章记录以发布单的形式启动的一个流水线的执行过程，并对相关敏感信息做了删除，但不影响对整体流程的介绍。通过 POST 调用 gate 服务的 pipelines&amp;#x2F;v2&amp;#x2F;{application}&amp;#x2F;{pipeline}@POST(&amp;quot;pipelines&amp;#x2F;v2&amp;#x2F;{application}&amp;#x2F;{"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/images/pics/a742e046f7b6b08ba478978897e970f1.png"><meta property="article:published_time" content="2020-10-31T14:57:46.000Z"><meta property="article:modified_time" content="2022-04-20T15:43:02.679Z"><meta property="article:author" content="遇寻"><meta property="article:tag" content="orca"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://eucham.me/images/pics/a742e046f7b6b08ba478978897e970f1.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me/2020/10/31/6ce2d2364228.html"},"headline":"3 | Spinnaker 如何执行 pipeline","image":["https://eucham.me/images/pics/a742e046f7b6b08ba478978897e970f1.png"],"datePublished":"2020-10-31T14:57:46.000Z","dateModified":"2022-04-20T15:43:02.679Z","author":{"@type":"Person","name":"遇寻"},"publisher":{"@type":"Organization","name":"遇寻笔记","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"本篇文章记录以发布单的形式启动的一个流水线的执行过程，并对相关敏感信息做了删除，但不影响对整体流程的介绍。通过 POST 调用 gate 服务的 pipelines&#x2F;v2&#x2F;{application}&#x2F;{pipeline}@POST(&quot;pipelines&#x2F;v2&#x2F;{application}&#x2F;{"}</script><link rel="canonical" href="https://eucham.me/2020/10/31/6ce2d2364228.html"><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-10-31T14:57:46.000Z" title="10/31/2020, 10:57:46 PM">2020-10-31</time>发表</span><span class="level-item"><time dateTime="2022-04-20T15:43:02.679Z" title="4/20/2022, 11:43:02 PM">2022-04-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Spinnaker/">Spinnaker</a></span><span class="level-item">17 分钟读完 (大约2611个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">3 | Spinnaker 如何执行 pipeline</h1><div class="content"><p>本篇文章记录以发布单的形式启动的一个流水线的执行过程，并对<strong>相关敏感信息做了删除</strong>，但不影响对整体流程的介绍。</p>
<p>通过 POST 调用 gate 服务的 <code>pipelines/v2/&#123;application&#125;/&#123;pipeline&#125;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@POST(&quot;pipelines/v2/&#123;application&#125;/&#123;pipeline&#125;&quot;)</span></span><br><span class="line">Call&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">postPipeline</span><span class="params">(<span class="meta">@Path(&quot;application&quot;)</span> String application,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Path(&quot;pipeline&quot;)</span> String pipeline,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Body</span> TaskPipeline taskPipeline)</span>;</span><br></pre></td></tr></table></figure>
<!-- more -->
<p>进入 gate</p>
<h2 id="gate"><a href="#gate" class="headerlink" title="gate"></a>gate</h2><p>请求：<code>/v2/&#123;application&#125;/&#123;pipelineNameOrId:.+&#125;</code></p>
<p>位置：<code>gate-web/src/main/groovy/com/netflix/spinnaker/gate/controllers/PipelineController.groovy</code></p>
<p>请求进入 gate 之后，会先校验当前用户是否有此流水线的执行权限，然后调用 echo 触发流水线。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@POST</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">String postEvent(<span class="meta">@Body</span> Map event)</span><br></pre></td></tr></table></figure>

<p>此时的参数 eventMap 为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;application&quot;</span><span class="punctuation">:</span> <span class="string">&quot;artifacturlteam1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pipelineNameOrId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ccbae2c9-ba68-43f3-87ba-669b1bb27831&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;trigger&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;buildNumber&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;manual&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;dryRun&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vskycorpltd&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;artifacts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;artifactAccount&quot;</span><span class="punctuation">:</span> <span class="string">&quot;generic-repo::1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;customKind&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;94141c3b-1f0f-4674-99e1-cb138905ac25&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vskycorpltdcorp-generic.pkg.vskycorpltd.com/vsky/generic-repo/abc/efg.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;parentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;generic&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pkgId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;projectId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;projectName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vsky&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;reference&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;repoName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;generic-repo&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vskycorpltd_artifact/generic&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;uriName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vsky&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;customName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20201016-artifacturl-p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;customDescription&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;projectUrlName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vsky&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;vskycorpltdNickname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vskycorpltd&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;eventId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2796229f-fbea-4da8-a8af-fd3de334f765&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;executionId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01EN7GSM1KA2XHV9SX956YGKCD&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vskycorpltd&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;details&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;manual&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>进入 echo</p>
<h2 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h2><p>位置：<code>echo-web/src/main/java/com/netflix/spinnaker/echo/history/HistoryController.java</code></p>
<p>在 echo 中，上面的参数被转换成一个 echoEvent，然后将此事件，交给事件监听者来处理，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveHistory</span><span class="params">(<span class="meta">@RequestBody</span> Event event)</span> &#123;</span><br><span class="line">  propagator.processEvent(event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">  Observable.from(listeners)</span><br><span class="line">      .map(</span><br><span class="line">          listener -&gt;</span><br><span class="line">              AuthenticatedRequest.propagate(</span><br><span class="line">                  () -&gt; &#123;</span><br><span class="line">                    listener.processEvent(event);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                  &#125;))</span><br><span class="line">      .observeOn(scheduler)</span><br><span class="line">      .subscribe(</span><br><span class="line">          callable -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              callable.call();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              log.error(<span class="string">&quot;failed processing event: &#123;&#125;&quot;</span>, event.content, e);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>listeners 来在容器中所有的 EchoEventListener bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> EventPropagator <span class="title function_">propagator</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">EventPropagator</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventPropagator</span>();</span><br><span class="line">  <span class="keyword">for</span> (EchoEventListener e : context.getBeansOfType(EchoEventListener.class).values()) &#123;</span><br><span class="line">    instance.addListener(e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处有 5 个监听者，他们的继承关系如下（观察者模式）：</p>
<p><img src="/images/pics/26f8c8c470ea834196ecce569fbf3659.png" alt="监听者继承关系"></p>
<p>此处仅关注 <code>TriggerEventListener</code>，它将是触发流水线的入口。随后 <code>TriggerEventListener</code> 会将事件交给 所有注册进来的 <code>triggerMonitors</code> 处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (TriggerMonitor triggerMonitor : triggerMonitors) &#123;</span><br><span class="line">    triggerMonitor.processEvent(event);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个 <code>TriggerMonitor</code> 包含一个 <code>TriggerEventHandler</code>，并且在初始化 <code>TriggerEventListener</code> 时，从容器中将所有的 <code>TriggerEventHandler</code> 都捞出来，用 <code>TriggerMonitor</code> 包裹一层，放入 <code>triggerMonitors</code> 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TriggerEventListener</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> PipelineCache pipelineCache,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> PipelineInitiator pipelineInitiator,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> Registry registry,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> PipelinePostProcessorHandler pipelinePostProcessorHandler,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> List&lt;TriggerEventHandler&lt;?&gt;&gt; eventHandlers)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.triggerMonitors =</span><br><span class="line">      eventHandlers.stream()</span><br><span class="line">          .map(</span><br><span class="line">              e -&gt;</span><br><span class="line">                  <span class="keyword">new</span> <span class="title class_">TriggerMonitor</span>&lt;&gt;(</span><br><span class="line">                      pipelineCache,</span><br><span class="line">                      pipelineInitiator,</span><br><span class="line">                      registry,</span><br><span class="line">                      pipelinePostProcessorHandler,</span><br><span class="line">                      e))</span><br><span class="line">          .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>但是</strong>并不是所有的 triggerMonitor 都处理这个事件，他们只负责处理各自能处理的事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">  validateEvent(event);</span><br><span class="line">  <span class="keyword">if</span> (eventHandler.handleEventType(event.getDetails().getType())) &#123;</span><br><span class="line">    recordMetrics();</span><br><span class="line">    <span class="type">T</span> <span class="variable">triggerEvent</span> <span class="operator">=</span> eventHandler.convertEvent(event);</span><br><span class="line">    triggerMatchingPipelines(triggerEvent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此有若干个 <code>TriggerEventHandler</code> ，他们分别对应若干触发方式，如下：</p>
<p><img src="/images/pics/53471f6fca9bf0fac5d447181176c7a9.png"></p>
<p>此处我们是以手动的方式启动的，在 Event 的 detail 中，type 记录为 manual。</p>
<p><img src="/images/pics/10cc2fddac0b17b229f0301ff12bd08f.png"></p>
<p>并且判断一个 <code>TriggerEventHandler</code> 能否处理某个事件的方式为：子类覆盖 <code>handleEventType()</code> 方法，并将相应能处理的事件的类型与当前 event.detail.type 对比，以 <code>DockerEventHandler</code> 为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handleEventType</span><span class="params">(String eventType)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> eventType.equalsIgnoreCase(DockerEvent.TYPE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DockerEvent</span> <span class="keyword">extends</span> <span class="title class_">TriggerEvent</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TYPE</span> <span class="operator">=</span> <span class="string">&quot;DOCKER&quot;</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，我们最终的入口便是 <code>ManualEventHandler</code> 。开始触发流水线。最终在 echo  <code>PipelineInitiator</code> 的</p>
<p><code>triggerPipelineImpl()</code> 方法中，通过 <code>triggerWithRetries()</code> 实现对 orca 的 HTTP 调用。</p>
<h2 id="orca"><a href="#orca" class="headerlink" title="orca"></a>orca</h2><p>接口：<code>/orchestrate</code></p>
<p>位置：<code>OperationsController</code></p>
<p>经过一番折腾后，边开始执行 pipeline，并返回一个 id 给到 echo。其间有几个比较重要的步骤：</p>
<ol>
<li>执行<code>parseAndValidatePipeline(pipeline)</code>，解决制品问题。最终调用的是：<code>ArtifactResolver.resolveArtifacts()</code>。</li>
<li>进行了一次 <code> contextParameterProcessor.process()</code> ，对 pipeline 中的表达式进行计算。</li>
<li>将 pipeline 信息转化成 <code>Execution</code>，然后再将其转化成一个 <code>StartExecution</code> 后，存入到一个 Queue 里面。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">(execution: <span class="type">Execution</span>)</span></span> = queue.push(StartExecution(execution))</span><br><span class="line">    </span><br><span class="line"><span class="meta">@JsonTypeName(<span class="string">&quot;startExecution&quot;</span>)</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">StartExecution</span>(</span><br><span class="line"><span class="keyword">override</span> <span class="keyword">val</span> executionType: ExecutionType,</span><br><span class="line"><span class="keyword">override</span> <span class="keyword">val</span> executionId: String,</span><br><span class="line"><span class="keyword">override</span> <span class="keyword">val</span> application: String</span><br><span class="line">) : Message(), ExecutionLevel &#123;</span><br><span class="line"><span class="keyword">constructor</span>(source: Execution) :</span><br><span class="line">  <span class="keyword">this</span>(source.type, source.id, source.application)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，StartExecution 的值如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;startExecution&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ackTimeoutMs&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;executionType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PIPELINE&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;executionId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01ENCS32B8B8AP83FAHYTCCKHN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;application&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asgteam1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="发布-获取事件"><a href="#发布-获取事件" class="headerlink" title="发布&amp;获取事件"></a>发布&amp;获取事件</h3><p>Queue 的实现为 RedisQueue，它 push 的代码逻辑如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">push</span><span class="params">(message: <span class="type">Message</span>, delay: <span class="type">TemporalAmount</span>)</span></span> &#123;</span><br><span class="line">  pool.resource.use &#123; redis -&gt;</span><br><span class="line">    redis.firstFingerprint(queueKey, message.fingerprint()).also &#123; fingerprint -&gt;</span><br><span class="line">      <span class="keyword">if</span> (fingerprint != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        redis.zadd(queueKey, score(delay), fingerprint, zAddParams().xx())</span><br><span class="line">        fire(MessageDuplicate(message))</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        redis.queueMessage(message, delay)</span><br><span class="line">        fire(MessagePushed(message))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先将 message 即 StartExecution 的摘要信息存入到一个有序集合中，集合的键为 <code>orca.task.queue.queue</code>，可以查看 redis 中相应的值，结果如下：</p>
<p><img src="/images/pics/4402fa063d49af70c81450b0ea8086e4.png" alt="ZznQhe"></p>
<p>然后通过 fire 函数，发布一个事件，这里应该是利用了 spring 的事件发布机制。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">queueEventPublisher</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  applicationEventPublisher: <span class="type">ApplicationEventPublisher</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> = <span class="keyword">object</span> : EventPublisher &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">publishEvent</span><span class="params">(event: <span class="type">QueueEvent</span>)</span></span> &#123;</span><br><span class="line">    applicationEventPublisher.publishEvent(event)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ApplicationEventPublisher 是 spring-context 包下的一个接口。它是一个<code>AnnotationConfigServletWebServerApplicationContext</code> 的实例，且继承自<code>AbstractApplicationContext</code> ，它有一个  <code>publishEvent()</code> 方法。</p>
<p><strong>获取消息</strong></p>
<p>位置：<code>com/netflix/spinnaker/q/QueueProcessor.kt</code></p>
<p>可以参考：<a target="_blank" rel="noopener" href="https://spinnaker.io/guides/developer/service-overviews/orca/">https://spinnaker.io/guides/developer/service-overviews/orca/</a></p>
<p>简而言之：不同的消息类型，对应不同的 handler。例如：StartExecution 消息，对应 StartExecutionHandler。</p>
<h3 id="StartExecutionHandler"><a href="#StartExecutionHandler" class="headerlink" title="StartExecutionHandler"></a>StartExecutionHandler</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">initialStages.forEach &#123; queue.push(StartStage(it)) &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Execution.<span class="title">initialStages</span><span class="params">()</span></span> =</span><br><span class="line">  stages</span><br><span class="line">    .filter &#123; it.isInitial() &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Stage.<span class="title">isInitial</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> =</span><br><span class="line">  requisiteStageRefIds.isEmpty()</span><br></pre></td></tr></table></figure>

<p>往 Queue 中塞若干个 StartStage，这些 Stage 必须不依赖其他 stage (配置除外)，这里是并行执行多个 Stage 的入口。</p>
<h3 id="StartStageHandler"><a href="#StartStageHandler" class="headerlink" title="StartStageHandler"></a>StartStageHandler</h3><p><code>stage.plan()</code> 函数执行逻辑：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> Stage.<span class="title">plan</span><span class="params">()</span></span> &#123;</span><br><span class="line">  builder().let &#123; builder -&gt;</span><br><span class="line">    <span class="comment">// if we have a top level stage, ensure that context expressions are processed</span></span><br><span class="line">    <span class="keyword">val</span> mergedStage = <span class="keyword">if</span> (<span class="keyword">this</span>.parentStageId == <span class="literal">null</span>) <span class="keyword">this</span>.withMergedContext() <span class="keyword">else</span> <span class="keyword">this</span></span><br><span class="line">    builder.addContextFlags(mergedStage)</span><br><span class="line">    builder.buildTasks(mergedStage)</span><br><span class="line">    builder.buildBeforeStages(mergedStage) &#123; it: Stage -&gt;</span><br><span class="line">      repository.addStage(it.withMergedContext())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>根据 stage 的定义将 Task 加入到 stage 的 tasks 列表中。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> StageDefinitionBuilder.<span class="title">buildTasks</span><span class="params">(stage: <span class="type">Stage</span>)</span></span> &#123;</span><br><span class="line">  buildTaskGraph(stage)</span><br><span class="line">    .listIterator()</span><br><span class="line">    .forEachWithMetadata &#123; processTaskNode(stage, it) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">default <span class="meta">@Nonnull</span> TaskGraph buildTaskGraph(<span class="meta">@Nonnull</span> Stage stage) &#123;</span><br><span class="line">  Builder graphBuilder = Builder(FULL);</span><br><span class="line">  taskGraph(stage, graphBuilder);</span><br><span class="line">  <span class="keyword">return</span> graphBuilder.build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 Stage 中自定义的 taskGraph()</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">void taskGraph(Stage stage, TaskNode.Builder builder) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isTopLevelStage(stage)) &#123;</span><br><span class="line">    builder</span><br><span class="line">      .withTask(<span class="string">&quot;completeParallel&quot;</span>, CompleteParallelBakeTask)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    builder</span><br><span class="line">      .withTask(<span class="string">&quot;createBake&quot;</span>, CreateBakeTask)</span><br><span class="line">      .withTask(<span class="string">&quot;monitorBake&quot;</span>, MonitorBakeTask)</span><br><span class="line">      .withTask(<span class="string">&quot;completedBake&quot;</span>, CompletedBakeTask)</span><br><span class="line">      .withTask(<span class="string">&quot;bindProducedArtifacts&quot;</span>, BindProducedArtifactsTask)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>withTask() 方法将会将 taskName，taskImp类，封装到  TaskDefinition 中，并保存在 builder 的 graph 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Builder <span class="title function_">withTask</span><span class="params">(</span></span><br><span class="line"><span class="params">    String name, Class&lt;? extends com.netflix.spinnaker.orca.Task&gt; implementingClass)</span> &#123;</span><br><span class="line">  graph.add(<span class="keyword">new</span> <span class="title class_">TaskDefinition</span>(name, implementingClass));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过 processTaskNode() 将所有的 task 保存到 stage 的 tasks 中。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">processTaskNode</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  stage: <span class="type">Stage</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  element: <span class="type">IteratorElement</span>&lt;<span class="type">TaskNode</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSubGraph: <span class="type">Boolean</span> = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">  element.apply &#123;</span><br><span class="line">    <span class="keyword">when</span> (value) &#123;</span><br><span class="line">      <span class="keyword">is</span> TaskDefinition -&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> task = Task()</span><br><span class="line">        task.id = (stage.tasks.size + <span class="number">1</span>).toString()</span><br><span class="line">        task.name = value.name</span><br><span class="line">        task.implementingClass = value.implementingClass.name</span><br><span class="line">        <span class="keyword">if</span> (isSubGraph) &#123;</span><br><span class="line">          task.isLoopStart = isFirst</span><br><span class="line">          task.isLoopEnd = isLast</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          task.isStageStart = isFirst</span><br><span class="line">          task.isStageEnd = isLast</span><br><span class="line">        &#125;</span><br><span class="line">        stage.tasks.add(task)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">is</span> TaskGraph -&gt; &#123;</span><br><span class="line">        <span class="comment">// 递归执行...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>让一个 Stage 包含两个 Stage</li>
</ul>
<p>简单说就是<strong>在一个 Bake 阶段，似乎产生了两个 Bake，并且每个 Bake 的 task 还不一样，但他们都在一个 Bake 阶段里面</strong>，如下：</p>
<p><img src="/images/pics/7af693ce8e766b307c7b8108ae8c23e6.png" alt="zn6xx5"></p>
<p>它的实现只需要在自定义 Stage 中实现 <code>buildBeforeStage()</code> 方法，并在这个方法中，在 graph 中，添加一个新的 Stage，它的本质是为 <code>Bake A</code> 阶段，添加了一个前置阶段 <code>Bake in ap-beijing</code>。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">void</span> beforeStages(<span class="meta">@Nonnull</span> Stage parent, <span class="meta">@Nonnull</span> StageGraphBuilder graph) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isTopLevelStage(parent)) &#123;</span><br><span class="line">    parallelContexts(parent)</span><br><span class="line">      .collect(&#123; context -&gt;</span><br><span class="line">        newStage(parent.execution, type, <span class="string">&quot;Bake in $&#123;context.region&#125;&quot;</span>, context, parent, STAGE_BEFORE)</span><br><span class="line">      &#125;)</span><br><span class="line">      .forEach(&#123;Stage s -&gt; graph.add(s) &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在搞定整个 Stage 的构造之后，开始 <code>stage.start()</code>，此处，会将上面创建的两个 Stage 分开运行。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> Stage.<span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> beforeStages = firstBeforeStages()</span><br><span class="line">  <span class="keyword">if</span> (beforeStages.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">val</span> task = firstTask()</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> after stages are no longer planned at this point. We could skip this</span></span><br><span class="line">      <span class="keyword">val</span> afterStages = firstAfterStages()</span><br><span class="line">      <span class="keyword">if</span> (afterStages.isEmpty()) &#123;</span><br><span class="line">        queue.push(CompleteStage(<span class="keyword">this</span>))</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        afterStages.forEach &#123;</span><br><span class="line">          queue.push(StartStage(it))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      queue.push(StartTask(<span class="keyword">this</span>, task.id))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    beforeStages.forEach &#123;</span><br><span class="line">      queue.push(StartStage(it))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一步的 <code>val beforeStages = firstBeforeStages()</code> 会先获取到创建的 <code>Bake in ap-beijing</code> 阶段，并通过 <code>queue.push(StartStage(it))</code> 先执行 <code>Bake in ap-beijing</code> 。所以，只执行完 <code>queue.push(StartStage(it))</code> ,代码的处理逻辑，又会进入 <code>StartStageHandler</code>中，如下：</p>
<p><img src="/images/pics/45f9b97a62759580db715a2cc1a1a97e.png" alt="2PjQP0"></p>
<p>接着通过 <code>queue.push(StartTask(this, task.id))</code>，开始执行第一个 Task，即 createBake。</p>
<p><img src="/images/pics/2bbb93481a93f84ec95a5a2e19eb5810.png" alt="V66UMR"></p>
<h3 id="StartTaskHandler"><a href="#StartTaskHandler" class="headerlink" title="StartTaskHandler"></a>StartTaskHandler</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">message.withTask &#123; stage, task -&gt;</span><br><span class="line">  task.status = RUNNING</span><br><span class="line">  task.startTime = clock.millis()</span><br><span class="line">  <span class="keyword">val</span> mergedContextStage = stage.withMergedContext()</span><br><span class="line">  repository.storeStage(mergedContextStage)</span><br><span class="line"></span><br><span class="line">  queue.push(RunTask(message, task.id, task.type))</span><br><span class="line"></span><br><span class="line">  publisher.publishEvent(TaskStarted(<span class="keyword">this</span>, mergedContextStage, task))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里记录了 task 的开始时间、并保存到数据库中，同时通过 <code>queue.push(RunTask(message, task.id, task.type))</code> 开启 task。</p>
<p>这里的 <code>message.withTask</code> 里面的套了好几层逻辑，与后续的 RunTask 有类似之处。</p>
<h3 id="RunTaskHandler"><a href="#RunTaskHandler" class="headerlink" title="RunTaskHandler"></a>RunTaskHandler</h3><p>在 handle() 方法中，通过解析，最终得到了实际的 task，即 CreateBakeTask。</p>
<p><img src="/images/pics/612a5cb15b06c07a8a95da41f4b9cbfd.png" alt="vKZN8f"></p>
<h4 id="CreateBakeTask"><a href="#CreateBakeTask" class="headerlink" title="CreateBakeTask"></a>CreateBakeTask</h4><p>在此 Task 中，主要是对 bake 所需参数进行拼凑，主要步骤如下：</p>
<ol>
<li><p>根据 account 获取 secret_id 和 secret_key。</p>
</li>
<li><p>根据 pipeline 中的设置，整理出 packer 使用的配置。</p>
</li>
<li><p>调用 rosco，并等待请求返回。</p>
</li>
<li><p>返回 task 执行成功。</p>
<p> <img src="/images/pics/a39e4aa926a721897a7da009a9ed5578.png" alt="NLtcbu"></p>
</li>
</ol>
<h4 id="task-执行完成"><a href="#task-执行完成" class="headerlink" title="task 执行完成"></a>task 执行完成</h4><p>当 CreateBakeTask 返回的状态为成功时，后续会触发 CompleteTask 事件，也就是对应 CompleteTaskHandler。</p>
<p><img src="/images/pics/335f66267dfbac9aae178366062f73c7.png" alt="wDuUiF"></p>
<h3 id="CompleteTaskHandler"><a href="#CompleteTaskHandler" class="headerlink" title="CompleteTaskHandler"></a>CompleteTaskHandler</h3><p>当一个 task 结束时，会判断 task 所属 stage 是否结束、是否已被手动跳过、已经进行触发下个 task。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mergedContextStage.nextTask(task).let &#123;</span><br><span class="line">  <span class="keyword">if</span> (it == <span class="literal">null</span>) &#123;</span><br><span class="line">    queue.push(NoDownstreamTasks(message))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    queue.push(StartTask(message, it.id))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中查找下一个 task 的逻辑只是将下标 +1</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Stage.<span class="title">nextTask</span><span class="params">(task: <span class="type">Task</span>)</span></span>: Task? =</span><br><span class="line">  <span class="keyword">if</span> (task.isStageEnd) &#123;</span><br><span class="line">    <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> index = tasks.indexOf(task)</span><br><span class="line">    tasks[index + <span class="number">1</span>]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>接着，便开始了一个新的循环，分别开始 MonitorBakeTask、CompletedBakeTask、BindProducedArtifactsTask。每个 task 都会像 CreateBakeTask 一样，经历下面的 3 个阶段：</p>
<ul>
<li>StartTaskHandler </li>
<li>RunTaskHandler</li>
<li>CompleteTaskHandler</li>
</ul>
<p>当最后一个 task 执行完了之后，仍然会到达 CompleteTaskHandler 的 handle() 方法，此时会触发 CompleteStage。</p>
<h3 id="CompleteStageHandler"><a href="#CompleteStageHandler" class="headerlink" title="CompleteStageHandler"></a>CompleteStageHandler</h3><p>主要逻辑分两个，一个是对 afterStage 的处理，一个是对 nextStage 的处理。</p>
<ol>
<li>与前面的 beforeStage 对应，还有一个 <strong>afterStage</strong>，逻辑应该与 beforeStage 类似，当执行完一个 stage 之后，再执行它的 afterStage。</li>
<li><code>stage.startNext()</code></li>
</ol>
<p><strong>获取接下来的 stages 的逻辑</strong>：并发执行所有接下来的 stage</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Stage.<span class="title">startNext</span><span class="params">()</span></span> &#123;</span><br><span class="line">  execution.let &#123; execution -&gt;</span><br><span class="line">    <span class="keyword">val</span> downstreamStages = downstreamStages()</span><br><span class="line">    <span class="keyword">val</span> phase = syntheticStageOwner</span><br><span class="line">    <span class="keyword">if</span> (downstreamStages.isNotEmpty()) &#123;</span><br><span class="line">      downstreamStages.forEach &#123;</span><br><span class="line">        queue.push(StartStage(it))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (phase != <span class="literal">null</span>) &#123;</span><br><span class="line">      queue.ensure(ContinueParentStage(parent(), phase), Duration.ZERO)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      queue.push(CompleteExecution(execution))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>如何确定接下来的 stages</strong></p>
<p>根据当前 stage 的 refId，到 pipeline 中去遍历所有的 stage，只要该 stage 的 requisiteStageRefIds 里面有当前 stage 的 refId，那么它就将要被执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonIgnore</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Stage&gt; <span class="title function_">downstreamStages</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> getExecution().getStages().stream()</span><br><span class="line">      .filter(it -&gt; it.getRequisiteStageRefIds().contains(getRefId()))</span><br><span class="line">      .collect(toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>3 | Spinnaker 如何执行 pipeline</p><p><a href="https://eucham.me/2020/10/31/6ce2d2364228.html">https://eucham.me/2020/10/31/6ce2d2364228.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>遇寻</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-10-31</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-04-20</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/orca/">orca</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5f548d5caad6e60013d63db8&amp;product=inline-share-buttons" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/10/31/f223bee55ee4.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">4 | Spinnaker orca 如何处理 pipeline 中的制品</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/10/31/60b943d025b2.html"><span class="level-item">2 | Spinnaker orca 如何找到对应的 stage</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://eucham.me/2020/10/31/6ce2d2364228.html';
            this.page.identifier = '2020/10/31/6ce2d2364228.html';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'eucham' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="M系列MacBook连接l2tp时失败的问题修复"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">M系列MacBook连接l2tp时失败的问题修复</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rust学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rust学习笔记</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/b0874d97f2ec.html"><img src="/images/pics/8a16be7bbc191e48a6e5b08755f591ec.png" alt="01.AI概览"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/b0874d97f2ec.html">01.AI概览</a></p><p class="categories"><a href="/categories/AI/">AI</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calico证书学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calico证书学习笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="如何在YAML文件中进行优雅地换行"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">如何在YAML文件中进行优雅地换行</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a><p class="is-size-7"><span>&copy; 2024 遇寻</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>