<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>遇寻笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="遇寻笔记"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="遇寻笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:type" content="website"><meta property="og:title" content="遇寻笔记"><meta property="og:url" content="https://eucham.me/"><meta property="og:site_name" content="遇寻笔记"><meta property="og:description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/img/og_image.png"><meta property="article:author" content="遇寻"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me"},"headline":"遇寻笔记","image":["https://eucham.me/img/og_image.png"],"author":{"@type":"Person","name":"遇寻"},"publisher":{"@type":"Organization","name":"遇寻笔记","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"No. I&#39;ll bring me back a souvenir."}</script><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-22T05:13:11.000Z" title="3/22/2019, 1:13:11 PM">2019-03-22</time>发表</span><span class="level-item"><time dateTime="2022-04-20T16:46:51.815Z" title="4/21/2022, 12:46:51 AM">2022-04-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Linux/">Linux</a></span><span class="level-item">9 分钟读完 (大约1341个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/22/22c744900f73.html">Linux中的特殊符号以及特殊语法</a></h1><div class="content">辨别||、&amp;&amp;、;、$*等符号在linux中的含义与或# 将&amp;&amp;前后的两个命令当做一个表达式，如果表达式出错，那么可以认为该表达式为false➜  ~ ls / &amp;&amp; datebin  boot  dev  etc  home  initrd.img </div><a class="article-more button is-small is-size-7" href="/2019/03/22/22c744900f73.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-20T00:38:33.000Z" title="3/20/2019, 8:38:33 AM">2019-03-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:52.714Z" title="2/9/2021, 11:03:52 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span> / </span><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">5 分钟读完 (大约785个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/20/5156767b418e.html">解决web端登录时等待过久并偶尔抛出事务相关异常</a></h1><div class="content"><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p><img src="/images/pics/b121bd559df52a004b45e06e2cc88495.png" alt="在这里插入图片描述"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>登录函数中有一个事务，如下：<br><img src="/images/pics/0608cdfe9b3f587c7bcf75a95a61f312.png" alt="在这里插入图片描述"><br>事务里面有一个有可能操作比较耗时的过程：<br><img src="/images/pics/c48cc071a374cc675606da7556e12130.png" alt="在这里插入图片描述"><br>在新增登录日志的时候，获取用户的ip。<br><img src="/images/pics/7eb2aaf28af964507dc55b2cb69d18a2.png" alt="在这里插入图片描述"><br>具体干了啥不重要，重要的是发了一个http请求，并且是串行的，所以这个请求比较耗时的可能是很大的，并且具备不确定性因素。<br><img src="/images/pics/30bb080b6e51b36241ad15dcc01c8ef4.png" alt="在这里插入图片描述"></p>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p><code>TransactionRollbackException</code>的文档注释为：</p>
<p><em>This exception indicates that the transaction associated with processing of the request has been rolled back, or marked to roll back. Thus the requested operation either could not be performed or was not performed because further computation on behalf of the transaction would be fruitless</em></p>
<p>可能的过程为：线程1进入事务、然后进行了一次update操作，获得了一个排他锁，然后被卡在了获取ip的那个地方，即此事务持有着排他锁，然后还长时间不结束（50s+），然后线程2也进入了事务，此时在进行update的时候，需要等待线程1释放排它锁，在50秒过后，仍未获取到锁，此时获取锁时间超过了预设，抛出上述异常。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>规避潜在的耗时操作。<strong>但是由于此服务没人维护，因此通过本地编译，然后拉包替换相应class文件，再上传到服务器的方式进行修改。</strong></p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>查看获取锁的超时阀值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%timeout%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----------------------------+----------+</span></span><br><span class="line">| Variable_name               | Value    |</span><br><span class="line">+<span class="comment">-----------------------------+----------+</span></span><br><span class="line">| connect_timeout             | 10       |</span><br><span class="line">| delayed_insert_timeout      | 300      |</span><br><span class="line">| have_statement_timeout      | YES      |</span><br><span class="line">| innodb_flush_log_at_timeout | 1        |</span><br><span class="line">| innodb_lock_wait_timeout    | 50       |</span><br><span class="line">| innodb_rollback_on_timeout  | OFF      |</span><br><span class="line">| interactive_timeout         | 28800    |</span><br><span class="line">| lock_wait_timeout           | 31536000 |</span><br><span class="line">| net_read_timeout            | 30       |</span><br><span class="line">| net_write_timeout           | 60       |</span><br><span class="line">| rpl_stop_slave_timeout      | 31536000 |</span><br><span class="line">| slave_net_timeout           | 60       |</span><br><span class="line">| wait_timeout                | 28800    |</span><br><span class="line">+<span class="comment">-----------------------------+----------+</span></span><br><span class="line">13 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --------------------------Controller------------</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 测试web端登录锁表</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/hotline/test&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSomeThing</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    testService.doSomething();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ----------------------------Service----------------</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> BizConfMapper confMapper;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 共享锁</span></span><br><span class="line">    BizConf conf = confMapper.selectByPrimaryKey(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 排它锁</span></span><br><span class="line">    confMapper.updateByPrimaryKey(conf);</span><br><span class="line">    <span class="comment">// 等待让下个线程超时，最起码要大于50</span></span><br><span class="line">    Thread.sleep(<span class="number">60000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>日志输出与项目中出现的错误信息基本一致，如下：<br><img src="/images/pics/3be7b45fa1d895fd19656ba7b1a932cd.png" alt="在这里插入图片描述"><br>在<code>@Transactional</code>注解中加入timeout后，报错不一样，但是阔以理解为spring框架为我们抛出了异常。如下：<br><img src="/images/pics/1cfe80e7355ec2e1ff68cb468b0c96bb.png" alt="在这里插入图片描述"></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>其中对我理解这种现象有很大帮助的资料为这一张图，它让我明白了锁与事务之间的关系。<br><img src="/images/pics/9bebe9ada738c3908c5baa7df6041ae8.png" alt="在这里插入图片描述"><br>参考：<br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014133576">https://segmentfault.com/a/1190000014133576</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-03-19T22:55:56.000Z" title="3/20/2019, 6:55:56 AM">2019-03-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:24.643Z" title="2/9/2021, 11:03:24 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></span><span class="level-item">8 分钟读完 (大约1212个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/03/20/67f245149110.html">【转载-摘要】彻底搞懂 Git-Rebase</a></h1><div class="content"><p>原文链接：<a target="_blank" rel="noopener" href="http://jartto.wang/2018/12/11/git-rebase/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io">http://jartto.wang/2018/12/11/git-rebase/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</a></p>
<blockquote>
<p>rebase的主要功能就是改变commit历史，在这篇文章中，场景一是改变未push的commit历史，场景二是在合并分支时，改变当前分支的历史，从而达到简化commit历史的目的，让历史一目了然。对强迫症患者来说简直就是福音。</p>
</blockquote>
<h2 id="Rebase-场景一：如何合并多次提交纪录？"><a href="#Rebase-场景一：如何合并多次提交纪录？" class="headerlink" title="Rebase 场景一：如何合并多次提交纪录？"></a>Rebase 场景一：如何合并多次提交纪录？</h2><p>1.我们来合并最近的 4 次提交纪录，执行：<br><code>git rebase -i HEAD~4</code><br>2.这时候，会自动进入 vi 编辑模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">s cacc52da add: qrcode</span><br><span class="line">s f072ef48 update: indexeddb hack</span><br><span class="line">s 4e84901a feat: add indexedDB floder</span><br><span class="line">s 8f33126c feat: add test2.js</span><br><span class="line"># Rebase 5f2452b2..8f33126c onto 5f2452b2 (4 commands)</span><br><span class="line">#</span><br><span class="line"># Commands:</span><br><span class="line"># p, pick &#x3D; use commit</span><br><span class="line"># r, reword &#x3D; use commit, but edit the commit message</span><br><span class="line"># e, edit &#x3D; use commit, but stop for amending</span><br><span class="line"># s, squash &#x3D; use commit, but meld into previous commit</span><br><span class="line"># f, fixup &#x3D; like &quot;squash&quot;, but discard this commit&#39;s log message</span><br><span class="line"># x, exec &#x3D; run command (the rest of the line) using shell</span><br><span class="line"># d, drop &#x3D; remove commit</span><br><span class="line">#</span><br><span class="line"># These lines can be re-ordered; they are executed from top to bottom.</span><br><span class="line">#</span><br><span class="line"># If you remove a line here THAT COMMIT WILL BE LOST.</span><br><span class="line">#</span><br><span class="line"># However, if you remove everything, the rebase will be aborted.</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>有几个命令需要注意一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p, pick &#x3D; use commit</span><br><span class="line">r, reword &#x3D; use commit, but edit the commit message</span><br><span class="line">e, edit &#x3D; use commit, but stop for amending</span><br><span class="line">s, squash &#x3D; use commit, but meld into previous commit</span><br><span class="line">f, fixup &#x3D; like “squash”, but discard this commit’s log message</span><br><span class="line">x, exec &#x3D; run command (the rest of the line) using shell</span><br><span class="line">d, drop &#x3D; remove commit</span><br></pre></td></tr></table></figure>
<p>按照如上命令来修改你的提交纪录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s cacc52da add: qrcode</span><br><span class="line">s f072ef48 update: indexeddb hack</span><br><span class="line">s 4e84901a feat: add indexedDB floder</span><br><span class="line">p 8f33126c feat: add test2.js</span><br></pre></td></tr></table></figure>
<p>3.如果保存的时候，你碰到了这个错误：<br><code>error: cannot &#39;squash&#39; without a previous commit</code><br>注意不要合并先前提交的东西，也就是已经提交远程分支的纪录。</p>
<p>4.如果你异常退出了 vi 窗口，不要紧张：</p>
<p><code>git rebase --edit-todo</code><br>这时候会一直处在这个编辑的模式里，我们可以回去继续编辑，修改完保存一下：</p>
<p><code>git rebase --continue</code><br>5.查看结果</p>
<p><code>git log</code><br><img src="/images/pics/fb33ecfed184aa1e8eb0ff37342d2365.png" alt="在这里插入图片描述"><br>三次提交合并成了一次，减少了无用的提交信息。</p>
<h2 id="Rebase-场景二：分支合并"><a href="#Rebase-场景二：分支合并" class="headerlink" title="Rebase 场景二：分支合并"></a>Rebase 场景二：分支合并</h2><p>1.我们先从 <code>master</code> 分支切出一个 <code>dev</code> 分支，进行开发：</p>
<p><code>git:(master) git checkout -b feature1</code><img src="/images/pics/34ab1852ac35e18f3cff7d1a6a957445.png" alt="git1"><br>2.这时候，你的同事完成了一次 <code>hotfix</code>，并合并入了 <code>master</code> 分支，此时 <code>master</code> 已经领先于你的 <code>feature1</code> 分支了：<br><img src="/images/pics/80e9026f136aa5977c154f591e4c9f06.png" alt="git2"><br>3.恰巧，我们想要同步 master 分支的改动，首先想到了 merge，执行：</p>
<p><code>git:(feature1) git merge master</code><br><img src="/images/pics/8ad11677746f10dc8b13a62048fc47e0.png" alt="git3"><br>图中绿色的点就是我们合并之后的结果，执行：</p>
<p><code>git:(feature1) git log</code><br>就会在记录里发现一些 merge 的信息，但是我们觉得这样污染了 commit 记录，想要保持一份干净的 commit，怎么办呢？这时候，git rebase 就派上用场了。</p>
<p>4.让我们来试试 git rebase ，先回退到同事 hotfix 后合并 master 的步骤：<br><img src="/images/pics/1453ae33d7a5325ab8334ae4e1583987.png" alt="git4"><br>5.使用 <code>rebase</code> 后来看看结果：</p>
<p><code>git:(feature1) git rebase master</code><br>这里补充一点：<code>rebase</code> 做了什么操作呢？</p>
<p>首先，git 会把 <code>feature1</code> 分支里面的每个 <code>commit</code> 取消掉；<br>其次，把上面的操作临时保存成 <code>patch</code> 文件，存在 <code>.git/rebase</code> 目录下；<br>然后，把 <code>feature1</code> 分支更新到最新的 <code>master</code> 分支；<br>最后，把上面保存的 <code>patch</code> 文件应用到 <code>feature1</code> 分支上；<br><img src="/images/pics/14e012b09e59970e733b4c6681bf0279.png" alt="git5"><br>从 <code>commit</code> 记录我们可以看出来，<code>feature1</code> 分支是基于 <code>hotfix</code> 合并后的 <code>master</code> ，自然而然的成为了最领先的分支，而且没有 <code>merge</code> 的 <code>commit</code> 记录，是不是感觉很舒服了。</p>
<p>6.在 <code>rebase</code> 的过程中，也许会出现冲突 conflict。在这种情况，git 会停止 <code>rebase</code> 并会让你去解决冲突。在解决完冲突后，用 <code>git add</code> 命令去更新这些内容。</p>
<p>注意，你无需执行 <code>git-commit</code>，只要执行 continue</p>
<p><code>git rebase --continue</code><br>这样 git 会继续应用余下的 patch 补丁文件。</p>
<p>7.在任何时候，我们都可以用 –abort 参数来终止 rebase 的行动，并且分支会回到 rebase 开始前的状态。</p>
<p><code>git rebase —abort</code></p>
<h2 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h2><p>只要你的分支上需要 <code>rebase</code> 的所有 commits 历史还没有被 <code>push</code> 过，就可以安全地使用 <code>git-rebase</code>来操作。</p>
<p>因为push到远程仓库后，你再次提交时，git对比会发现两个仓库的历史不一致。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-27T00:51:09.000Z" title="2/27/2019, 8:51:09 AM">2019-02-27</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:45.943Z" title="2/9/2021, 11:03:45 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span> / </span><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">5 分钟读完 (大约701个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/27/63bdd864316e.html">一种基于redis的分布式锁的实现（当前项目中在使用）</a></h1><div class="content"><p>主要思想是利用redis执行命令时的单线程特性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分布式锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedLock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DistributedLock.class);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁默认超时时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_TIMEOUT_SECOND = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所等待的时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_WAITE_TIMEOUT_SECOND = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁循环等待时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> LOOP_WAIT_TIME_MILLISECOND = <span class="number">30</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;redisCacheService&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BaseCacheService cacheService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有超时等待的加锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutSecond      如果为null,使用默认超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waiteTimeoutSecond 若果为null,使用默认超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加锁的值（超时时间：-1表示获取失败，超时）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lock</span><span class="params">(String key, Long timeoutSecond, Long waiteTimeoutSecond)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; start lock&quot;</span>);</span><br><span class="line">        <span class="keyword">long</span> beganTime = System.currentTimeMillis() / <span class="number">1000</span>;</span><br><span class="line">        <span class="comment">//如果参数错误</span></span><br><span class="line">        <span class="keyword">if</span> (timeoutSecond != <span class="keyword">null</span> &amp;&amp; timeoutSecond &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            timeoutSecond = DEFAULT_TIMEOUT_SECOND;</span><br><span class="line">        &#125;</span><br><span class="line">        timeoutSecond = timeoutSecond == <span class="keyword">null</span> ? DEFAULT_TIMEOUT_SECOND : timeoutSecond;</span><br><span class="line">        <span class="keyword">if</span> (waiteTimeoutSecond != <span class="keyword">null</span> &amp;&amp; waiteTimeoutSecond &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            waiteTimeoutSecond = DEFAULT_WAITE_TIMEOUT_SECOND;</span><br><span class="line">        &#125;</span><br><span class="line">        waiteTimeoutSecond =</span><br><span class="line">                waiteTimeoutSecond == <span class="keyword">null</span> ? DEFAULT_WAITE_TIMEOUT_SECOND : waiteTimeoutSecond;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//等待超时判断</span></span><br><span class="line">            <span class="keyword">long</span> endTime = System.currentTimeMillis() / <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">if</span> ((endTime - beganTime) &gt;= waiteTimeoutSecond) &#123;</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1l</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//超时时间点</span></span><br><span class="line">            <span class="keyword">long</span> timeoutTimeMilli = cacheService.getCurrentTimeMilliForCache() + timeoutSecond * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果设置成功</span></span><br><span class="line">            <span class="keyword">if</span> (cacheService.setIfAbsent(key, timeoutTimeMilli)) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果已经超时</span></span><br><span class="line">            Long value = cacheService.getVal(key, Long.class);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.longValue() &lt; cacheService.getCurrentTimeMilliForCache()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//设置新的超时时间</span></span><br><span class="line">                Long oldValue = cacheService.getAndSet(key, timeoutTimeMilli);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//多个线程同时getset，只有第一个才可以获取到锁</span></span><br><span class="line">                <span class="keyword">if</span> (value.equals(oldValue)) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//延迟一定毫秒，防止请求太频繁</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(LOOP_WAIT_TIME_MILLISECOND);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;DistributedLock lock sleep error&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 无超时等待的加锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutSecond 如果为null,使用默认超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加锁的值（超时时间）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lock</span><span class="params">(String key, Long timeoutSecond)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; start lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果参数错误</span></span><br><span class="line">        <span class="keyword">if</span> (timeoutSecond != <span class="keyword">null</span> &amp;&amp; timeoutSecond &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            timeoutSecond = DEFAULT_TIMEOUT_SECOND;</span><br><span class="line">        &#125;</span><br><span class="line">        timeoutSecond = timeoutSecond == <span class="keyword">null</span> ? DEFAULT_TIMEOUT_SECOND : timeoutSecond;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//超时时间点</span></span><br><span class="line">            <span class="keyword">long</span> timeoutTimeMilli = cacheService.getCurrentTimeMilliForCache() + timeoutSecond * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果设置成功</span></span><br><span class="line">            <span class="comment">// 若在redis中、没有相应的key值，那么可以认为，当前线程即或得该锁。</span></span><br><span class="line">            <span class="keyword">if</span> (cacheService.setIfAbsent(key, timeoutTimeMilli)) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果已经超时</span></span><br><span class="line">            <span class="comment">// 此时该key在redis已存在，获取该key的值</span></span><br><span class="line">            Long value = cacheService.getVal(key, Long.class);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.longValue() &lt; cacheService.getCurrentTimeMilliForCache()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//设置新的超时时间</span></span><br><span class="line">                <span class="comment">// 如果此时获取到的oldValue，与前面获取的value相同，则说明该线程可以获得锁</span></span><br><span class="line">                <span class="comment">// 获得锁后，set进新值。</span></span><br><span class="line">                Long oldValue = cacheService.getAndSet(key, timeoutTimeMilli);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//多个线程同时getset，只有第一个才可以获取到锁</span></span><br><span class="line">                <span class="keyword">if</span> (value.equals(oldValue)) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; lock success&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> timeoutTimeMilli;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//延迟一定毫秒，防止请求太频繁</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(LOOP_WAIT_TIME_MILLISECOND);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;DistributedLock lock sleep error&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">(String key, <span class="keyword">long</span> lockValue)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; start unlock&quot;</span>);</span><br><span class="line">        Long value = cacheService.getVal(key, Long.class);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.equals(lockValue)) &#123;<span class="comment">//如果是本线程加锁</span></span><br><span class="line">            cacheService.deleteVal(key);</span><br><span class="line">            logger.info(<span class="string">&quot;Thread：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; unlock success&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-27T00:30:20.000Z" title="2/27/2019, 8:30:20 AM">2019-02-27</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:18.649Z" title="2/9/2021, 11:03:18 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a></span><span class="level-item">2 分钟读完 (大约302个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/27/5ba82e56096a.html">LeetCode 罗马字相关</a></h1><div class="content"><p><a target="_blank" rel="noopener" href="https://leetcode.com/problems/integer-to-roman/">https://leetcode.com/problems/integer-to-roman/</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> ONE[<span class="number">5</span>] = &#123;<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;M&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> FIVE[<span class="number">4</span>] =  &#123;<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;D&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> strr[<span class="number">100</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">judgeByte</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">int</span> * byte)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ten = <span class="number">10</span>, tmp = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (num / ten == <span class="number">0</span>) &#123;</span><br><span class="line">			*byte = tmp;</span><br><span class="line">			<span class="keyword">return</span> ten;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ten *= <span class="number">10</span>;</span><br><span class="line">			tmp ++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">produceRomanSymbol</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">int</span> ten, <span class="keyword">int</span> byte, <span class="keyword">char</span> * result)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (byte == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//sprintf(result + strlen(result), &quot;\n&quot;);</span></span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> target = num / (ten/<span class="number">10</span>);</span><br><span class="line">	<span class="comment">//printf(&quot;num = %d, ten = %d, target = %d, byte = %d\n&quot;, num, ten, target, byte);</span></span><br><span class="line">	<span class="keyword">if</span> (target == <span class="number">5</span>) &#123;</span><br><span class="line">		<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c&quot;</span>, FIVE[byte]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (target &gt; <span class="number">5</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (target == <span class="number">9</span>) &#123;</span><br><span class="line">			<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c%c&quot;</span>, ONE[byte], ONE[byte + <span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">			<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c&quot;</span>, FIVE[byte]);</span><br><span class="line">			<span class="keyword">for</span> (; i &lt;= (target - <span class="number">5</span>); i ++) &#123;</span><br><span class="line">				<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c&quot;</span>,  ONE[byte]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (target == <span class="number">4</span>) &#123;</span><br><span class="line">			<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c%c&quot;</span>, ONE[byte], FIVE[byte]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">for</span> (; i &lt;= target; i ++) &#123;</span><br><span class="line">				<span class="built_in">sprintf</span>(result + <span class="built_in">strlen</span>(result), <span class="string">&quot;%c&quot;</span>, ONE[byte]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	produceRomanSymbol(num % (ten/<span class="number">10</span>), ten / <span class="number">10</span>, byte - <span class="number">1</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">intToRoman</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> byte;</span><br><span class="line">	<span class="keyword">int</span> ten = judgeByte(num, &amp;byte);</span><br><span class="line">	<span class="built_in">memset</span>(strr, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	produceRomanSymbol(num, ten, byte, strr);</span><br><span class="line">	<span class="keyword">return</span> strr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://leetcode.com/problems/roman-to-integer/">https://leetcode.com/problems/roman-to-integer/</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getRomanValue</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;I&#x27;</span>: <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>: <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;X&#x27;</span>: <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>: <span class="keyword">return</span> <span class="number">50</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>: <span class="keyword">return</span> <span class="number">500</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: <span class="keyword">return</span> <span class="number">1000</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">romanToInt</span><span class="params">(<span class="keyword">char</span>* s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>, tmp = <span class="number">0</span>, i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(s); i ++) &#123;</span><br><span class="line"><span class="comment">//		printf(&quot;i = %d, &quot;, i);</span></span><br><span class="line">		<span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">			tmp = getRomanValue(s[i]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> diff = getRomanValue(s[i]) - getRomanValue(s[i - <span class="number">1</span>]);</span><br><span class="line">			<span class="keyword">if</span> (diff == <span class="number">0</span>) &#123;</span><br><span class="line">				tmp += getRomanValue(s[i]);</span><br><span class="line"><span class="comment">//				printf(&quot;** tmp = %d, pos = %c\n&quot;, tmp, s[i]);</span></span><br><span class="line">				<span class="comment">//cnt += tmp;</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span>(diff &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				cnt += (getRomanValue(s[i]) - tmp);</span><br><span class="line"><span class="comment">//				printf(&quot;cnt = %d, pos = %c\n&quot;, cnt, s[i]);</span></span><br><span class="line">				tmp = <span class="number">0</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				cnt += tmp;</span><br><span class="line">				tmp = <span class="number">0</span>;</span><br><span class="line">				tmp += getRomanValue(s[i]);</span><br><span class="line"><span class="comment">//				printf(&quot;tmp = %d, pos = %c\n&quot;, tmp, s[i]);</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (tmp != <span class="number">0</span>)</span><br><span class="line">		cnt += tmp;</span><br><span class="line">	<span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-19T21:07:09.000Z" title="2/20/2019, 5:07:09 AM">2019-02-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:25.939Z" title="2/9/2021, 11:03:25 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span> / </span><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">3 分钟读完 (大约434个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/20/5ca02b540a6b.html">nginx中的root与alias的差别</a></h1><div class="content"><h2 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h2><p>nginx指定文件路径有两种方式root和alias，指令的使用方法和作用域：<br>[root]<br>语法：root path<br>默认值：root html<br>配置段：http、server、location、if<br>[alias]<br>语法：alias path<br>配置段：location</p>
<h2 id="root与alias主要区别"><a href="#root与alias主要区别" class="headerlink" title="root与alias主要区别"></a>root与alias主要区别</h2><p>在于nginx如何解释location后面的uri，这会使两者分别以不同的方式将请求映射到服务器文件上。<br>root的处理结果是：<code>root路径 ＋ location路径</code><br>alias的处理结果是：使用alias路径替换location路径<br>alias是一个目录别名的定义，root则是最上层目录的定义。<br>还有一个重要的区别是<strong>alias后面必须要用“/”结束</strong>，否则会找不到文件的，而root则可有可无。</p>
<p>例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 如果一个请求的URI是&#x2F;t&#x2F;a.html时，web服务器将会返回服务器上的&#x2F;www&#x2F;root&#x2F;html&#x2F;t&#x2F;a.html的文件。</span><br><span class="line">location ^~ &#x2F;t&#x2F; &#123;</span><br><span class="line">	root &#x2F;www&#x2F;root&#x2F;html&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 如果一个请求的URI是&#x2F;t&#x2F;a.html时，web服务器将会返回服务器上的&#x2F;www&#x2F;root&#x2F;html&#x2F;new_t&#x2F;a.html的文件。</span><br><span class="line"># 注意这里是new_t，因为alias会把location后面配置的路径丢弃掉，把当前匹配到的目录指向到指定的目录。</span><br><span class="line">location ^~ &#x2F;t&#x2F; &#123;</span><br><span class="line">	alias &#x2F;www&#x2F;root&#x2F;html&#x2F;new_t&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>使用alias时，目录名后面一定要加”/“。</li>
<li>alias在使用正则匹配时，必须捕捉要匹配的内容并在指定的内容处使用。</li>
<li>alias只能位于location块中。（root可以不放在location中）</li>
</ol>
<p>搬运工：<br>文章为: nginx.cn原创，转载请注明本文地址: <a target="_blank" rel="noopener" href="http://www.nginx.cn/4658.html">http://www.nginx.cn/4658.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-19T20:58:07.000Z" title="2/20/2019, 4:58:07 AM">2019-02-20</time>发表</span><span class="level-item"><time dateTime="2022-04-20T16:47:14.060Z" title="4/21/2022, 12:47:14 AM">2022-04-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Linux/">Linux</a></span><span class="level-item">2 分钟读完 (大约303个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/20/75be99f318f6.html">EXT4中的inode的简易再理解</a></h1><div class="content">之前在鸟哥的linux上面，了解过inode相关的内容。最近被要求出一个面试题，想到了这个，然后自己复习了一下inode相关的内容，简短地描述如下认识文件系统是数据组织方式，定义数据在磁盘上的保存、读取和更新方法。不同的文件系统可以根据存储设备的不同进行优化，提高效率。可以为每个磁盘分区设置一个或多</div><a class="article-more button is-small is-size-7" href="/2019/02/20/75be99f318f6.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-19T20:45:02.000Z" title="2/20/2019, 4:45:02 AM">2019-02-20</time>发表</span><span class="level-item"><time dateTime="2022-04-20T16:47:03.721Z" title="4/21/2022, 12:47:03 AM">2022-04-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Linux/">Linux</a></span><span class="level-item">1 分钟读完 (大约169个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/20/a27177743283.html">linux中free命令背后的故事</a></h1><div class="content">available当应用程序需要内存时，如果没有足够的 free 内存可以用，内核就会从 buffer 和 cache 中回收内存来满足应用程序的请求。所以从应用程序的角度来说，available  = free + buffer + cache。请注意，这只是一个很理想的计算方式，实际中的数据往往</div><a class="article-more button is-small is-size-7" href="/2019/02/20/a27177743283.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-02-03T01:05:20.000Z" title="2/3/2019, 9:05:20 AM">2019-02-03</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:04:03.833Z" title="2/9/2021, 11:04:03 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">11 分钟读完 (大约1723个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/02/03/8d333a46d643.html">Java进程周期性自动退出的原因排查</a></h1><div class="content"><blockquote>
<p>一个java -jar服务在被CI启动后，过一段时间，进程就被消失了，不见了。日志没有关于出错的相关信息。对日志中记录的最后一条请求，进行压力测试，但该进程却没有自己消失。个人觉得这个问题很有意思，但是我也明白，找到这其中的原因可能需要很长的时间。</p>
</blockquote>
<h2 id="Update-2019-3-15"><a href="#Update-2019-3-15" class="headerlink" title="Update(2019-3-15 )"></a>Update(2019-3-15 )</h2><p>最近公司的其他项目上，又遇到了一个进程老是无缘无故就挂的现象，按照之前的那种场景来排查，并没有发现有那种CI的出现。顿时又陷入了困境之中。不过我还是按部就班的做了三件事：</p>
<ul>
<li>用root权限启动改服务</li>
<li>做好对jvm的监控</li>
<li>用strace对进程做好监控<br>顺便了解了一下strace的含义，发现其中的字段确实是有很大的意义。<br>监控命令如下：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup strace -T -tt -e trace=all -p \`pgrep -f algorithm-work-1.0.0.jar\ ` &gt; trace.\`pgrep -f algorithm-work-1.0.0.jar\`.<span class="built_in">log</span> &amp;\</span><br></pre></td></tr></table></figure>
监控日志如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">webapp@ecs-f1c4-0003:&#x2F;opt&#x2F;webapp&#x2F;logs$ cat trace.26077.log </span><br><span class="line">strace: Process 26077 attached</span><br><span class="line">11:22:43.117920 futex(0x7f631a5fb9d0, FUTEX_WAIT, 26078, NULL) &#x3D; ? ERESTARTSYS (To be restarted if SA_RESTART is set) &lt;1238.653416&gt;</span><br><span class="line">11:43:21.776222 --- SIGTERM &#123;si_signo&#x3D;SIGTERM, si_code&#x3D;SI_USER, si_pid&#x3D;26158, si_uid&#x3D;0&#125; ---</span><br><span class="line">11:43:21.777278 futex(0x7f63199c0540, FUTEX_WAKE_PRIVATE, 1) &#x3D; 1 &lt;0.004217&gt;</span><br><span class="line">11:43:21.786583 rt_sigreturn(&#123;mask&#x3D;[]&#125;) &#x3D; 202 &lt;0.005049&gt;</span><br><span class="line">11:43:21.796220 futex(0x7f631a5fb9d0, FUTEX_WAIT, 26078, NULL &lt;unfinished ...&gt;</span><br><span class="line">11:43:23.605244 +++ exited with 143 +++</span><br></pre></td></tr></table></figure>
从上面看来，uid=0说明操作者是root，但是kill -9不一定有，不过至少是可以看出来是什么时候被干掉的。</li>
</ul>
<p><strong>转机</strong><br>发现是被别人用来挖矿了==<br><img src="/images/pics/873a5c4a4b00e416b7f3de3d3dcbefb1.png" alt="在这里插入图片描述"><br>详细的情况与下面链接的描述一模一样。本来还有一个进程叫做<code>crond64</code>，在top中看到占用的CPU非常高，各个核的都占到了90%+。执行的挖矿脚本的目录在<code>~/.ttp</code>下，打包好了，准备研究研究。<br><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1115770/crond64-tsm-virus-in-ubuntu">https://askubuntu.com/questions/1115770/crond64-tsm-virus-in-ubuntu</a></p>
<h2 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h2><p>首先想到的是：是不是某一个接口出现了问题，所以根据日志中所记录的最后一条请求，对其进行压力测试。脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 获取工单详情</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100000&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	curl --header <span class="string">&quot;token:71e8e4dd40dd65f645ceb214397f578e&quot;</span> --url <span class="string">&quot;192.168.31.117:9997/workorder/mine/orders?id=79&quot;</span> &amp;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>结果被认为遭到了ddos攻击，囧！<br><img src="/images/pics/0e8763e10c388f133d9b06474c8da2ac.png" alt="在这里插入图片描述"><br>该服务进程扛过了这些请求，没有死亡。</p>
<h2 id="排查CI"><a href="#排查CI" class="headerlink" title="排查CI"></a>排查CI</h2><p>因为整个项目通过gitlab管理，而gitlab中有一项叫做CI，可以通过ci脚本来执行一些脚本达到发布、部署最新的服务到相应服务器上。这里面可能会存在问题，比如说，另外一个ci脚本在执行的时候，会把该服务的进程kill掉，只是会有这种可能，因为CI脚本大部分是通过copy的，但是可能性不高，因为所有的CI脚本都能够顺利执行，所以kill掉的肯定是自身服务的进程，不然CI脚本对应的服务可能起不来，但目前所有的CI脚本都能顺利执行完。但是还是去排查一下CI脚本，<strong>没毛病</strong>。</p>
<h2 id="是谁kill掉了该进程？"><a href="#是谁kill掉了该进程？" class="headerlink" title="是谁kill掉了该进程？"></a>是谁kill掉了该进程？</h2><p>这个进程消失的原因，可以想到的情况为：jvm崩溃、被操作系统的oom_killer杀掉、被某个脚本杀掉？</p>
<h3 id="是否为操作系统所终结？"><a href="#是否为操作系统所终结？" class="headerlink" title="是否为操作系统所终结？"></a>是否为操作系统所终结？</h3><p>由于outofmemory被kill掉的进程，会在/var/log下的某个文件中留下最终的遗迹。但是在整个/var/log下、都没有搜索kill的痕迹，如下：<br><img src="/images/pics/f37f30e11a704878f66e3f03f1146f88.png" alt="在这里插入图片描述"><br><img src="/images/pics/2c953ab6f8a5bac384c914a94f23f0ec.png" alt="在这里插入图片描述"><br>如果没有/var/log/messages这个文件，可以通过设置，将这个log文件开启。</p>
<ol>
<li><p>root身份打开 <code>/etc/rsyslog.d/50-default.conf</code></p>
</li>
<li><p>把注释#去掉</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#*.=info;*.=notice;*.=warn;\</span></span><br><span class="line"><span class="comment">#    auth,authpriv.none;\</span></span><br><span class="line"><span class="comment">#    cron,daemon.none;\</span></span><br><span class="line"><span class="comment">#    mail,news.none        -/var/log/messages</span></span><br></pre></td></tr></table></figure></li>
<li><p> 重启后ok<br><code>sudo restart rsyslog</code></p>
</li>
</ol>
<p><strong>并没有发现这个oom_killer的痕迹</strong></p>
<h3 id="JVM自己崩溃？"><a href="#JVM自己崩溃？" class="headerlink" title="JVM自己崩溃？"></a>JVM自己崩溃？</h3><p>在该服务的启动参数中加入了对崩溃日志的指定：<br><code>java  -jar  -Xms512m  -Xmx512m  -XX:MaxPermSize=126m  -XX:+HeapDumpOnOutOfMemoryError  -XX:HeapDumpPath=/opt/webapp/xxx-server/  -XX:ErrorFile=/opt/webapp/xxx-server/hs_err_pid_%p.log  xxx-server.jar</code><br>但是在该进程被终结后，并没有发现相应目录下的日志文件。所以这种情况下，同样也没有对其进行内存分析的先决条件、jdk自带的一系列工具并没有发挥出作用的余地。</p>
<h3 id="到底是谁杀掉了这个进程？"><a href="#到底是谁杀掉了这个进程？" class="headerlink" title="到底是谁杀掉了这个进程？"></a>到底是谁杀掉了这个进程？</h3><p>使用<code>nohup strace -T -tt -e trace=all -p 21715 &gt; trace.log &amp;</code>监控该pid的情况，如果是被<code>kill -9</code>，会出现一个log，大致如下：<br><img src="/images/pics/f067e8e0f2ededc4fe9487e82ae14a82.png" alt="在这里插入图片描述"></p>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>通过strace命令的跟踪、最终发现trace.log的内容如下所示：<br><img src="/images/pics/fb78b7e6dbfd98dfcb1119fe12191ecd.png" alt="在这里插入图片描述"><br>出现这个的原因基本上是两个、一个是人为的kill -9、或者就是被系统kill -9。系统杀掉该进程的原因、被逐一排除，结果只剩下人为的因素。关于人为的因素、首先查看命令，并没有相关的kill记录。然后发现开发环境与测试环境的该进程基本上同时挂掉、并且都点了这两个环境的某个CI，然后这两个环境上的该进程都挂掉了，因此基本断定是CI操作杀掉了该进程。<br>被杀掉的进程名字为：<code>java -jar workorder-server.jar</code>，通过CI发布&amp;启动的进程名字为：<code>java -jar order-server.jar</code>。然后在点击order相关的CI时会执行如下操作：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mvn</span> <span class="string">clean</span> <span class="string">package</span> <span class="string">-pl</span> <span class="string">order-server</span> <span class="string">-am</span> <span class="string">-Dmaven.test.skip=true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">scp</span> <span class="string">order-server/target/order-server.jar</span> <span class="string">$&#123;user_dev&#125;@$&#123;nemt_host_dev&#125;:/opt/webapp/order-server/.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ssh</span> <span class="string">$&#123;user_dev&#125;@$&#123;nemt_host_dev&#125;</span> <span class="string">&#x27;kill -9 `pgrep -f order-server\.jar` ; echo 1&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ssh</span> <span class="string">$&#123;user_dev&#125;@$&#123;nemt_host_dev&#125;</span> <span class="string">&#x27;. /etc/profile ; cd /opt/webapp/order-server/ ; nohup java  -jar order-server.jar &gt;&gt; /dev/null 2&gt;&amp;1 &amp;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>问题就在<code>kill -9</code>上面，pgrep查出来的进程号有两个，所以执行order相关的CI时，顺带也把workorder干掉了。<br><img src="/images/pics/da602a93d6164e0f29ef2c7fc98b8d7d.png" alt="在这里插入图片描述"></p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>修改shell语句，让pgrep order-server时，只显示出order-server的进程号即可。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-01-31T08:52:24.000Z" title="1/31/2019, 4:52:24 PM">2019-01-31</time>发表</span><span class="level-item"><time dateTime="2022-04-20T16:28:36.955Z" title="4/21/2022, 12:28:36 AM">2022-04-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Spring%E7%B3%BB%E5%88%97/">Spring系列</a></span><span class="level-item">9 分钟读完 (大约1309个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/31/10076998b027.html">SpringMVC源码探索之RequestBody的工作原理</a></h1><div class="content">遇到一个很奇怪的问题，后面发现了问题所在，原因是自己太过匆忙、连快捷键都被复制粘贴省略了。虽然出现问题的原因有点傻逼，但是之所以出现这种问题的原因却更加引人入胜。问题现象描述Controller中没有逻辑，只有一个@RequestBody注释的form表单然而这个TestBean有点特殊，非一般的g</div><a class="article-more button is-small is-size-7" href="/2019/01/31/10076998b027.html#more">阅读更多</a></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/14/">上一页</a></div><div class="pagination-next"><a href="/page/16/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/14/">14</a></li><li><a class="pagination-link is-current" href="/page/15/">15</a></li><li><a class="pagination-link" href="/page/16/">16</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/26/">26</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="M系列MacBook连接l2tp时失败的问题修复"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">M系列MacBook连接l2tp时失败的问题修复</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rust学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rust学习笔记</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calico证书学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calico证书学习笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="如何在YAML文件中进行优雅地换行"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">如何在YAML文件中进行优雅地换行</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/25470f32f4bb.html"><img src="/images/pics/kubernetes-cka-color.svg" alt="CKS证书学习资料汇编"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/25470f32f4bb.html">CKS证书学习资料汇编</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a><p class="is-size-7"><span>&copy; 2024 遇寻</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>