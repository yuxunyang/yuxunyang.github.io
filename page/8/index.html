<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>遇寻笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="遇寻笔记"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="遇寻笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:type" content="website"><meta property="og:title" content="遇寻笔记"><meta property="og:url" content="https://eucham.me/"><meta property="og:site_name" content="遇寻笔记"><meta property="og:description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/img/og_image.png"><meta property="article:author" content="遇寻"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me"},"headline":"遇寻笔记","image":["https://eucham.me/img/og_image.png"],"author":{"@type":"Person","name":"遇寻"},"publisher":{"@type":"Organization","name":"遇寻笔记","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"No. I&#39;ll bring me back a souvenir."}</script><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-29T13:03:27.000Z" title="9/29/2020, 9:03:27 PM">2020-09-29</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:40.125Z" title="2/9/2021, 11:03:40 AM">2021-02-09</time>更新</span><span class="level-item">38 分钟读完 (大约5663个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/29/7df9f6ffa556.html">Ansible playbook 执行流程</a></h1><div class="content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>超时主要分两个场景，一个是建立 SSH 连接时，另外一个为通过 SSH 执行命令时的超时。前者主要依靠 SSH 命令的自带参数 <code>ConnectTimeout</code>，后者则有一套 Ansible 自己的实现。</p>
<!-- more -->
<h3 id="建立连接超时"><a href="#建立连接超时" class="headerlink" title="建立连接超时"></a>建立连接超时</h3><p><code>ansible 2 -u root -m ping -T 30</code>。底层实现使用 <code>ssh -o ConnectTimeout=30</code>。<br><img src="/images/pics/213f95716da78ce89f13acadb03d990d.png"></p>
<h3 id="执行命令超时（playbook）"><a href="#执行命令超时（playbook）" class="headerlink" title="执行命令超时（playbook）"></a>执行命令超时（playbook）</h3><p>在 playbook 的 task 中加入 <code>async</code> 和 <code>poll</code> 属性。</p>
<ul>
<li><code>async</code> 表示这个step的最长等待时长,  如果设置为0, 表示一直等待下去直到动作完成；</li>
<li><code>poll</code> 表示检查step操作结果的间隔时长，poll 设置为0, 表示不用等待执行结果, 该step执行成功。</li>
</ul>
<p>测试用的 playbook 如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">http_port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">max_clients:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">tasks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Sleep30s</span></span><br><span class="line">        <span class="attr">shell:</span></span><br><span class="line">          <span class="string">&quot;sleep 30s&quot;</span></span><br><span class="line">        <span class="attr">async:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">poll:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>启动命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook pb.yml</span><br></pre></td></tr></table></figure>
<p>效果：<br><img src="/images/pics/222f279dc0ef7a5bf713b9eb6c54cda6.png"></p>
<h2 id="执行命令超时（playbook）的流程"><a href="#执行命令超时（playbook）的流程" class="headerlink" title="执行命令超时（playbook）的流程"></a>执行命令超时（playbook）的流程</h2><p>在此 playbook 中，有一个 task，但是在执行上面定义的 task 之前，会执行一个 <code>Gathering Facts</code> 的 task，这里将此不太相干的 task 去掉了。task <code>Sleep30s</code> 的执行日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">TASK [Sleep30s] ****************************************************************</span><br><span class="line">task path: &#x2F;Users&#x2F;yangyu&#x2F;pb.yml:8</span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;echo ~root &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#x2F;root\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;( umask 77 &amp;&amp; mkdir -p &quot;&#96; echo &#x2F;root&#x2F;.ansible&#x2F;tmp &#96;&quot;&amp;&amp; mkdir &quot;&#96; echo &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145 &#96;&quot; &amp;&amp; echo ansible-tmp-1600333356.414965-42861-191307013081145&#x3D;&quot;&#96; echo &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145 &#96;&quot; ) &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;ansible-tmp-1600333356.414965-42861-191307013081145&#x3D;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;command.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp_66m3nen TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145&#x2F;AnsiballZ_command.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp_66m3nen &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145&#x2F;AnsiballZ_command.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmplmizhdvg TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145&#x2F;async_wrapper.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmplmizhdvg &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145&#x2F;async_wrapper.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145&#x2F;AnsiballZ_command.py &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145&#x2F;async_wrapper.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;ANSIBLE_ASYNC_DIR&#x3D;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;~&#x2F;.ansible_async&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39; &#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145&#x2F;async_wrapper.py 48991476669 10 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333356.414965-42861-191307013081145&#x2F;AnsiballZ_command.py _ &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#123;&quot;started&quot;: 1, &quot;_ansible_suppress_tmpdir_delete&quot;: true, &quot;finished&quot;: 0, &quot;results_file&quot;: &quot;&#x2F;root&#x2F;.ansible_async&#x2F;48991476669.20840&quot;, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;echo ~root &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#x2F;root\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;( umask 77 &amp;&amp; mkdir -p &quot;&#96; echo &#x2F;root&#x2F;.ansible&#x2F;tmp &#96;&quot;&amp;&amp; mkdir &quot;&#96; echo &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103 &#96;&quot; &amp;&amp; echo ansible-tmp-1600333358.847193-42861-146017266031103&#x3D;&quot;&#96; echo &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103 &#96;&quot; ) &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;ansible-tmp-1600333358.847193-42861-146017266031103&#x3D;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpgapz8kyp TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpgapz8kyp &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpph94rjs7 TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpph94rjs7 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpia9_huhw TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpia9_huhw &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp0dw1l581 TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp0dw1l581 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp640778bz TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp640778bz &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp_snd1eu9 TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp_snd1eu9 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpk13c6mm6 TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpk13c6mm6 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpfjdhm2l7 TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpfjdhm2l7 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpzqpsa6hl TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmpzqpsa6hl &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Using module file &#x2F;Users&#x2F;yangyu&#x2F;projects&#x2F;ansible&#x2F;lib&#x2F;ansible&#x2F;modules&#x2F;async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp_66e23_9 TO &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 &#39;[9.134.124.159]&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;sftp&gt; put &#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;tmp&#x2F;ansible-local-42839upbl7lkg&#x2F;tmp_66e23_9 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py\n&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;chmod u+x &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F; &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;&#39;, b&#39;&#39;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster&#x3D;auto -o ControlPersist&#x3D;60s -o Port&#x3D;36000 -o KbdInteractiveAuthentication&#x3D;no -o PreferredAuthentications&#x3D;gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication&#x3D;no -o &#39;User&#x3D;&quot;root&quot;&#39; -o ConnectTimeout&#x3D;10 -o ControlPath&#x3D;&#x2F;Users&#x2F;yangyu&#x2F;.ansible&#x2F;cp&#x2F;4846fe66a5 -tt 9.134.124.159 &#39;&#x2F;bin&#x2F;sh -c &#39;&quot;&#39;&quot;&#39;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1600333358.847193-42861-146017266031103&#x2F;AnsiballZ_async_status.py &amp;&amp; sleep 0&#39;&quot;&#39;&quot;&#39;&#39;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#39;\r\n&#123;&quot;started&quot;: 1, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;jid&quot;: &quot;48991476669.20840&quot;, &quot;mode&quot;: &quot;status&quot;, &quot;_async_dir&quot;: &quot;&#x2F;root&#x2F;.ansible_async&quot;&#125;&#125;, &quot;finished&quot;: 0, &quot;ansible_job_id&quot;: &quot;48991476669.20840&quot;&#125;\r\n&#39;, b&#39;Shared connection to 9.134.124.159 closed.\r\n&#39;)</span><br><span class="line">ASYNC POLL on 9.134.124.159: jid&#x3D;48991476669.20840 started&#x3D;1 finished&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fatal: [9.134.124.159]: FAILED! &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;msg&quot;: &quot;async task did not complete within the requested time - 10s&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">9.134.124.159              : ok&#x3D;1    changed&#x3D;0    unreachable&#x3D;0    failed&#x3D;1    skipped&#x3D;0    rescued&#x3D;0    ignored&#x3D;0   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Process finished with exit code 2</span><br></pre></td></tr></table></figure>

<p>主要分两个步骤，先将任务在被控端跑起来，再在主控端定时轮训任务状态。第一个步骤与前文所述内容差不多，多了一份 py 代码 async_wrapper.py。</p>
<p>task Sleep30s 入口：<br><img src="/images/pics/16da437d1b160418c9a12981191b39f5.png"></p>
<p>从 debug 数据可以看出，在 playbook 中设置的 async 和 poll 是作为是否开启等待与轮训任务状态的开关。</p>
<h2 id="完整流程"><a href="#完整流程" class="headerlink" title="完整流程"></a>完整流程</h2><blockquote>
<p>此部分的流程只包含 <code>Sleep30s</code> Task，无 <code>Gathering facts</code> Task。</p>
</blockquote>
<h3 id="lib-ansible-plugins-action-command-py"><a href="#lib-ansible-plugins-action-command-py" class="headerlink" title="lib/ansible/plugins/action/command.py"></a><code>lib/ansible/plugins/action/command.py</code></h3><p><img src="/images/pics/e559a6d1ce0944a81afe9a003ae37810.png"><br>此处通过判断 task 的 async 的值来判断是否进行 async 操作，此处为 10，即 playbook 中定义的 async 值为 10。</p>
<h3 id="lib-ansible-plugins-action-init-py"><a href="#lib-ansible-plugins-action-init-py" class="headerlink" title="lib/ansible/plugins/action/__init__.py"></a><code>lib/ansible/plugins/action/__init__.py</code></h3><blockquote>
<p>_execute_module 方法</p>
</blockquote>
<ol>
<li><p>self._make_tmp_path() 创建临时目录</p>
<ul>
<li>获取当前用户的家目录：<code>echo ~root &amp;&amp; sleep 0</code></li>
<li>创建临时目录：<code>( umask 77 &amp;&amp; mkdir -p &quot;</code> echo /root/.ansible/tmp <code>&quot;&amp;&amp; mkdir &quot;</code> echo /root/.ansible/tmp/ansible-tmp-1600668712.8156748-24387-134124052814278 <code>&quot; &amp;&amp; echo ansible-tmp-1600668712.8156748-24387-134124052814278=&quot;</code> echo /root/.ansible/tmp/ansible-tmp-1600668712.8156748-24387-134124052814278 <code>&quot; ) &amp;&amp; sleep 0</code><br>至此，完成临时目录的创建。<br><img src="/images/pics/2551558e127d6a02faf90df8dd671f75.png"></li>
</ul>
</li>
<li><p>拷贝 <code>AnsiballZ_command.py</code> 到 <code>/root/.ansible/tmp/ansible-tmp-1600668712.8156748-24387-134124052814278/</code> 目录下。其功能如前文所述 wiki: #3685<br><img src="/images/pics/a22075f35e5dc4ee8d0cbda0af98e1ad.png"></p>
</li>
<li><p><strong>定时轮训逻辑</strong>（这是相比 #3685 多出来的流程）<br>这里多出来的逻辑是拷贝了一个 async_wrapper.py 文件到目标主机<br><img src="/images/pics/6d0871979af53ae5ef96e894028c4a2b.png"><br>其中 async_limit 为 task 中定义的 async 值，async_jid 为随机数。<br><img src="/images/pics/9e493158add0672d3a6c75fc848dc3f6.png"><br>接着生成了一个 async_cmd，也就是通过 ssh 命令，调用目标主机上的 async_wrapper.py 文件的命令。最终生成的命令为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;ANSIBLE_ASYNC_DIR=\&#x27;~/.ansible_async\&#x27; /usr/bin/python /root/.ansible/tmp/ansible-tmp-1600668712.8156748-24387-134124052814278/async_wrapper.py 586569230138 10 /root/.ansible/tmp/ansible-tmp-1600668712.8156748-24387-134124052814278/AnsiballZ_command.py _&#x27;</span><br></pre></td></tr></table></figure>
<p>其中 async_wrapper.py 文件的内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">_ANSIBALLZ_WRAPPER = <span class="literal">True</span> <span class="comment"># For test-module.py script to tell this is a ANSIBALLZ_WRAPPER</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_ansiballz_main</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="keyword">import</span> os.path</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="keyword">import</span> __main__</span><br><span class="line">    scriptdir = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        scriptdir = os.path.dirname(os.path.realpath(__main__.__file__))</span><br><span class="line">    <span class="keyword">except</span> (AttributeError, OSError):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    excludes = <span class="built_in">set</span>((<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, scriptdir))</span><br><span class="line">    sys.path = [p <span class="keyword">for</span> p <span class="keyword">in</span> sys.path <span class="keyword">if</span> p <span class="keyword">not</span> <span class="keyword">in</span> excludes]</span><br><span class="line">    <span class="keyword">import</span> base64</span><br><span class="line">    <span class="keyword">import</span> runpy</span><br><span class="line">    <span class="keyword">import</span> shutil</span><br><span class="line">    <span class="keyword">import</span> tempfile</span><br><span class="line">    <span class="keyword">import</span> zipfile</span><br><span class="line">    <span class="keyword">if</span> sys.version_info &lt; (<span class="number">3</span>,):</span><br><span class="line">        PY3 = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        PY3 = <span class="literal">True</span></span><br><span class="line">    ZIPDATA = <span class="string">&quot;&quot;&quot;omitted...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">invoke_module</span>(<span class="params">modlib_path, temp_path, json_params</span>):</span></span><br><span class="line">        z = zipfile.ZipFile(modlib_path, mode=<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        sitecustomize = <span class="string">u&#x27;import sys\nsys.path.insert(0,&quot;%s&quot;)\n&#x27;</span> %  modlib_path</span><br><span class="line">        sitecustomize = sitecustomize.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        zinfo = zipfile.ZipInfo()</span><br><span class="line">        zinfo.filename = <span class="string">&#x27;sitecustomize.py&#x27;</span></span><br><span class="line">        zinfo.date_time = ( <span class="number">2020</span>, <span class="number">9</span>, <span class="number">21</span>, <span class="number">6</span>, <span class="number">26</span>, <span class="number">19</span>)</span><br><span class="line">        z.writestr(zinfo, sitecustomize)</span><br><span class="line">        z.close()</span><br><span class="line">        sys.path.insert(<span class="number">0</span>, modlib_path)</span><br><span class="line">        <span class="keyword">from</span> ansible.module_utils <span class="keyword">import</span> basic</span><br><span class="line">        basic._ANSIBLE_ARGS = json_params</span><br><span class="line"></span><br><span class="line">        runpy.run_module(mod_name=<span class="string">&#x27;ansible.modules.async_wrapper&#x27;</span>, init_globals=<span class="literal">None</span>, run_name=<span class="string">&#x27;__main__&#x27;</span>, alter_sys=<span class="literal">True</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#123;&quot;msg&quot;: &quot;New-style module did not handle its own exit&quot;, &quot;failed&quot;: true&#125;&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">debug</span>(<span class="params">command, zipped_mod, json_params</span>):</span></span><br><span class="line">        basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), <span class="string">&#x27;debug_dir&#x27;</span>)</span><br><span class="line">        args_path = os.path.join(basedir, <span class="string">&#x27;args&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> command == <span class="string">&#x27;explode&#x27;</span>:</span><br><span class="line">            z = zipfile.ZipFile(zipped_mod)</span><br><span class="line">            <span class="keyword">for</span> filename <span class="keyword">in</span> z.namelist():</span><br><span class="line">                <span class="keyword">if</span> filename.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Something wrong with this module zip file: should not contain absolute paths&#x27;</span>)</span><br><span class="line">                dest_filename = os.path.join(basedir, filename)</span><br><span class="line">                <span class="keyword">if</span> dest_filename.endswith(os.path.sep) <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(dest_filename):</span><br><span class="line">                    os.makedirs(dest_filename)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    directory = os.path.dirname(dest_filename)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">                        os.makedirs(directory)</span><br><span class="line">                    f = <span class="built_in">open</span>(dest_filename, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">                    f.write(z.read(filename))</span><br><span class="line">                    f.close()</span><br><span class="line">            f = <span class="built_in">open</span>(args_path, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">            f.write(json_params)</span><br><span class="line">            f.close()</span><br><span class="line">            print(<span class="string">&#x27;Module expanded into:&#x27;</span>)</span><br><span class="line">            print(<span class="string">&#x27;%s&#x27;</span> % basedir)</span><br><span class="line">            exitcode = <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;execute&#x27;</span>:</span><br><span class="line">            sys.path.insert(<span class="number">0</span>, basedir)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(args_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                json_params = f.read()</span><br><span class="line">            <span class="keyword">from</span> ansible.module_utils <span class="keyword">import</span> basic</span><br><span class="line">            basic._ANSIBLE_ARGS = json_params</span><br><span class="line">            runpy.run_module(mod_name=<span class="string">&#x27;ansible.modules.async_wrapper&#x27;</span>, init_globals=<span class="literal">None</span>, run_name=<span class="string">&#x27;__main__&#x27;</span>, alter_sys=<span class="literal">True</span>)</span><br><span class="line">            print(<span class="string">&#x27;&#123;&quot;msg&quot;: &quot;New-style module did not handle its own exit&quot;, &quot;failed&quot;: true&#125;&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&#x27;WARNING: Unknown debug command.  Doing nothing.&#x27;</span>)</span><br><span class="line">            exitcode = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> exitcode</span><br><span class="line">    ANSIBALLZ_PARAMS = <span class="string">&#x27;&#123;&quot;ANSIBLE_MODULE_ARGS&quot;: &#123;&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> PY3:</span><br><span class="line">        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        temp_path = tempfile.mkdtemp(prefix=<span class="string">&#x27;ansible_ansible.legacy.async_wrapper_payload_&#x27;</span>)</span><br><span class="line">        zipped_mod = os.path.join(temp_path, <span class="string">&#x27;ansible_ansible.legacy.async_wrapper_payload.zip&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(zipped_mod, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> modlib:</span><br><span class="line">            modlib.write(base64.b64decode(ZIPDATA))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">2</span>:</span><br><span class="line">            exitcode = debug(sys.argv[<span class="number">1</span>], zipped_mod, ANSIBALLZ_PARAMS)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            invoke_module(zipped_mod, temp_path, ANSIBALLZ_PARAMS)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            shutil.rmtree(temp_path)</span><br><span class="line">        <span class="keyword">except</span> (NameError, OSError):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    sys.exit(exitcode)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    _ansiballz_main()</span><br></pre></td></tr></table></figure>
<p>与 AnsiballZ_command.py 中的逻辑类似，最终执行的代码来自 ZIP_DATA 中的数据，此处为 <code>ansible.modules.async_wrapper</code> 中的 <strong>main</strong> 函数，同理，此函数也可以在 ansible 的源代码中找到，其内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">➜  tree ansible</span><br><span class="line">.</span><br><span class="line">├── __init__.py</span><br><span class="line">├── module_utils</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── _text.py</span><br><span class="line">│   ├── basic.py</span><br><span class="line">│   ├── common</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── _collections_compat.py</span><br><span class="line">│   │   ├── _json_compat.py</span><br><span class="line">│   │   ├── _utils.py</span><br><span class="line">│   │   ├── collections.py</span><br><span class="line">│   │   ├── file.py</span><br><span class="line">│   │   ├── parameters.py</span><br><span class="line">│   │   ├── process.py</span><br><span class="line">│   │   ├── sys_info.py</span><br><span class="line">│   │   ├── text</span><br><span class="line">│   │   │   ├── __init__.py</span><br><span class="line">│   │   │   ├── converters.py</span><br><span class="line">│   │   │   └── formatters.py</span><br><span class="line">│   │   ├── validation.py</span><br><span class="line">│   │   └── warnings.py</span><br><span class="line">│   ├── compat</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── _selectors2.py</span><br><span class="line">│   │   └── selectors.py</span><br><span class="line">│   ├── distro</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   └── _distro.py</span><br><span class="line">│   ├── parsing</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   └── convert_bool.py</span><br><span class="line">│   ├── pycompat24.py</span><br><span class="line">│   └── six</span><br><span class="line">│       └── __init__.py</span><br><span class="line">└── modules</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    └── async_wrapper.py</span><br><span class="line">8 directories, 29 files</span><br></pre></td></tr></table></figure>
<p>其中 async_wrapper.py 在 ansible 中的位置为：<code>lib/ansible/modules/async_wrapper.py</code>。</p>
</li>
<li><p>实际执行任务。这里执行的其实是 async_wrapper.py，通过 async_wrapper.py 来调用 AnsiballZ_command.py。<br><img src="/images/pics/f58d5bfdab5a6d86b2b1279a871192a2.png"><br>此处总共分成两个步骤：</p>
</li>
</ol>
<ul>
<li>加权限：<code>chmod u+x ~/.ansible/tmp/ansible-tmp-1600668712.8156748-24387-134124052814278/ ...AnsiballZ_command.py ...async_wrapper.py &amp;&amp; sleep 0</code>（路径有省略）</li>
<li>执行 async_wrapper.py：<code>python ...async_wrapper.py 586569230138 10 ...AnsiballZ_command.py _ &amp;&amp; sleep 0</code>（路径有省略）</li>
</ul>
<p>承接第3小点，此处最终执行的是 ansible/modules/async_wrapper.py 的代码逻辑</p>
<h3 id="ansible-modules-async-wrapper-py"><a href="#ansible-modules-async-wrapper-py" class="headerlink" title="ansible/modules/async_wrapper.py"></a><code>ansible/modules/async_wrapper.py</code></h3><ol>
<li>取出传入的参数，即 async、command.py 等<br><img src="/images/pics/75b60f1578b4e82ece0d63cbaa4157a5.png"></li>
<li>确定实际要执行的命令（业务命令，也就是对用户来说，相在目标机上执行的命令）<br><img src="/images/pics/38359e4cbc8026562baa28ef77c5fdc5.png"></li>
<li>通过 os.fork() 剥离主进程与子进程，子进程执行 XXX_command.py，主进程返回结束。此处涉及大量的进程间通信（IPC），代码逻辑有点绕，但是有如下几点可以确认：</li>
</ol>
<ul>
<li>父（主）进程提前返回，也就是 ssh 命令执行完毕。<br><img src="/images/pics/e973a18702702e92e7aefd333c96d8d3.png"></li>
<li>子进程在父进程退出后，变成孤儿进程，然后通过 <code>daemonize_self()</code> 函数，将自己变成一个脱离父进程的<strong>新进程</strong>。<br><img src="/images/pics/5e2cbf8067f32e998e2747d751f938cd.png"></li>
<li><strong>新进程</strong>会再次 fork，创建一个<strong>新子进程</strong>，并在<strong>新子进程</strong>中执行 XXX_command.py ，<strong>新进程</strong>会一直等待<strong>新子进程</strong>执行完毕。<br><img src="/images/pics/077ca14c8393ee547c056d53fdc2a475.png"></li>
</ul>
<p>经过上述步骤，ssh 命令已返回。</p>
<h3 id="轮训执行结果"><a href="#轮训执行结果" class="headerlink" title="轮训执行结果"></a>轮训执行结果</h3><p>执行完上述流程后，会返回一个 result，内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;started&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;finished&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;results_file&quot;</span>: <span class="string">&quot;/root/.ansible_async/732064027558.2514&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ansible_job_id&quot;</span>: <span class="string">&quot;732064027558.2514&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_ansible_parsed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;_ansible_no_log&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，结果是存放在被控端的某个目录下，并在 <code>lib/ansible/executor/task_executor.py</code> 中，通过对 task 中的 async 和 poll 值的判断，来决定是否进行结果轮询：<br><img src="/images/pics/c244a4bf6cae739204fc3ec36a86420d.png"></p>
<p>轮训的流程与执行一条 ansible 命令类似，详见 #3685 ，此处不再赘述，不同的地方在于：</p>
<ol>
<li><p>上传的文件是 <code>AnsiballZ_async_status.py</code></p>
</li>
<li><p>通过 ssh 开始执行的文件是 <code>AnsiballZ_async_status.py</code>，最终执行的是： <code>lib/ansible/modules/async_status.py</code>。<br><img src="/images/pics/9fefd43616cc32dee273cdea5070465c.png"></p>
</li>
</ol>
<p>拿到被控机上面的 task log 后，会对 task 的执行状态进行判断：<br><img src="/images/pics/6dc8e8f63b7e346096ee8f0a3d74732b.png"></p>
<p>如果在 async 秒内，没有完成 task，此 task 将直接返回超时；<br><img src="/images/pics/69e4c0f9764ace652b52086c5cf52841.png"></p>
<p> <em>不过从此处来看，当 task 执行完毕后，可能还存在主控端去被控端轮询 task 的情况。</em></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-29T12:49:10.000Z" title="9/29/2020, 8:49:10 PM">2020-09-29</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:59.561Z" title="2/9/2021, 11:03:59 AM">2021-02-09</time>更新</span><span class="level-item">21 分钟读完 (大约3222个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/29/9c1a666f4592.html">Ansible ad-hoc 执行流程</a></h1><div class="content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>Ansible 封装了很多脚本，以 Module、Play 的形式呈现，这里以一条简单的 shell 命令作为切入点。<br>在开始前，将目标机的信息，先写入 <code>cat /etc/ansible/hosts</code> 中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">9.134.124.159:36000</span><br></pre></td></tr></table></figure>
<p>所用到的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -vvv -a &quot;ls /root&quot; -u root</span><br></pre></td></tr></table></figure>
<p>通过打开一些 debug 日志，可以确定执行连接操作时，一定会执行 <code>ansible/lib/ansible/plugins/connection/ssh.py</code> 中的代码。</p>
<!-- more -->
<h2 id="执行步骤"><a href="#执行步骤" class="headerlink" title="执行步骤"></a>执行步骤</h2><p>完整的日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">META: ran handlers</span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;echo ~root &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#x27;/root\n&#x27;, b&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;( umask 77 &amp;&amp; mkdir -p &quot;` echo /root/.ansible/tmp `&quot;&amp;&amp; mkdir &quot;` echo /root/.ansible/tmp/ansible-tmp-1599536717.558343-92837-98923700243036 `&quot; &amp;&amp; echo ansible-tmp-1599536717.558343-92837-98923700243036=&quot;` echo /root/.ansible/tmp/ansible-tmp-1599536717.558343-92837-98923700243036 `&quot; ) &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#x27;ansible-tmp-1599536717.558343-92837-98923700243036=/root/.ansible/tmp/ansible-tmp-1599536717.558343-92837-98923700243036\n&#x27;, b&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; Attempting python interpreter discovery</span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;echo PLATFORM; uname; echo FOUND; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;/usr/bin/python&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python3.7&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python3.6&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python3.5&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python2.7&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python2.6&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;/usr/libexec/platform-python&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;/usr/bin/python3&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; echo ENDFOUND &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#x27;PLATFORM\nLinux\nFOUND\n/usr/bin/python\n/usr/bin/python3.6\n/usr/bin/python2.7\n/usr/bin/python2.6\n/usr/libexec/platform-python\n/usr/bin/python3\n/usr/bin/python\nENDFOUND\n&#x27;, b&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;/usr/bin/python &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#x27;&#123;&quot;osrelease_content&quot;: &quot;NAME=\\&quot;Tencent tlinux\\&quot;\\nVERSION=\\&quot;2.2 (Final)\\&quot;\\nID=\\&quot;tlinux\\&quot;\\nID_LIKE=\\&quot;rhel fedora centos\\&quot;\\nVERSION_ID=\\&quot;2.2\\&quot;\\nPRETTY_NAME=\\&quot;Tencent tlinux 2.2 (Final)\\&quot;\\nANSI_COLOR=\\&quot;0;31\\&quot;\\nCPE_NAME=\\&quot;cpe:/o:tlinux:linux:2\\&quot;\\nHOME_URL=\\&quot;http://tlinux.oa.com/\\&quot;\\nBUG_REPORT_URL=\\&quot;http://tapd.oa.com/tlinux/bugtrace/bugreports/my_view/\\&quot;\\n\\n&quot;, &quot;platform_dist_result&quot;: [&quot;centos&quot;, &quot;7.2&quot;, &quot;Final&quot;]&#125;\n&#x27;, b&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">Using module file /Users/yangyu/projects/ansible/lib/ansible/modules/command.py</span><br><span class="line">&lt;9.134.124.159&gt; PUT /Users/yangyu/.ansible/tmp/ansible-local-9283485g9ot9_/tmpkr7p4e1t TO /root/.ansible/tmp/ansible-tmp-1599536717.558343-92837-98923700243036/AnsiballZ_command.py</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC sftp -b - -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 &#x27;[9.134.124.159]&#x27;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#x27;sftp&gt; put /Users/yangyu/.ansible/tmp/ansible-local-9283485g9ot9_/tmpkr7p4e1t /root/.ansible/tmp/ansible-tmp-1599536717.558343-92837-98923700243036/AnsiballZ_command.py\n&#x27;, b&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;chmod u+x /root/.ansible/tmp/ansible-tmp-1599536717.558343-92837-98923700243036/ /root/.ansible/tmp/ansible-tmp-1599536717.558343-92837-98923700243036/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#x27;&#x27;, b&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 -tt 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;/usr/bin/python /root/.ansible/tmp/ansible-tmp-1599536717.558343-92837-98923700243036/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#x27;\r\n&#123;&quot;changed&quot;: true, &quot;end&quot;: &quot;2020-09-08 11:45:53.183432&quot;, &quot;stdout&quot;: &quot;11.sh\\n11.zip\\nInstallHalyard.sh\\n[\\nabc.txt\\nagent.zip\\nbefore.txt\\ncloud-agent.log\\nclouddriver-prome.yaml\\nclouddriver.git?token=bd40137b365a6a789b7f5904cff87958ba5b158b\\nclouddriver.log\\ncoding-cd\\ncoding-cd-grpc.yaml\\nconfig_hub_oa_com.sh\\nconfig_vscode_server.sh\\ndemo\\ndemo.yaml\\ndev\\ndevopsAgent\\ndevopsDaemon\\nenable_internet_proxy.sh\\nfile.txt\\nfix_devcloud.logs\\ngeneric-aloe.txt\\nhi.db\\niProxy.sh\\nindex.html\\ninit_data_disk.sh\\ninit_devcloud_remote.sh\\ninstall.sh\\ninstallAgent.sh\\ninstall_ift.sh\\njre\\njre.zip\\nlog.txt\\nlogs\\npost-script.text\\nprome.yaml\\npush_master\\nrevert_image_source.sh\\nruntime\\nset_linux_welcome.sh\\nstart.sh\\nstop.sh\\nszx\\ntelegraf.conf\\nuninstall.sh\\nworker-agent.jar\\nworkspace&quot;, &quot;cmd&quot;: [&quot;ls&quot;, &quot;/root&quot;], &quot;rc&quot;: 0, &quot;start&quot;: &quot;2020-09-08 11:45:53.178756&quot;, &quot;stderr&quot;: &quot;&quot;, &quot;delta&quot;: &quot;0:00:00.004676&quot;, &quot;invocation&quot;: &#123;&quot;module_args&quot;: &#123;&quot;creates&quot;: null, &quot;executable&quot;: null, &quot;_uses_shell&quot;: false, &quot;strip_empty_ends&quot;: true, &quot;_raw_params&quot;: &quot;ls /root&quot;, &quot;removes&quot;: null, &quot;argv&quot;: null, &quot;warn&quot;: false, &quot;chdir&quot;: null, &quot;stdin_add_newline&quot;: true, &quot;stdin&quot;: null&#125;&#125;&#125;\r\n&#x27;, b&#x27;Shared connection to 9.134.124.159 closed.\r\n&#x27;)</span><br><span class="line"></span><br><span class="line">&lt;9.134.124.159&gt; ESTABLISH SSH CONNECTION FOR USER: root</span><br><span class="line">&lt;9.134.124.159&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;rm -f -r /root/.ansible/tmp/ansible-tmp-1599536717.558343-92837-98923700243036/ &gt; /dev/null 2&gt;&amp;1 &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">&lt;9.134.124.159&gt; (0, b&#x27;&#x27;, b&#x27;&#x27;)</span><br><span class="line">9.134.124.159 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">11.sh</span><br><span class="line">11.zip</span><br><span class="line">InstallHalyard.sh</span><br><span class="line">[</span><br><span class="line">abc.txt</span><br><span class="line">...</span><br><span class="line">META: ran handlers</span><br><span class="line">META: ran handlers</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对上述日志进行简化，可知其大致有 7 个步骤，分别如下：<br><img src="/images/pics/99c2a85f949ca5071d9c9be83abb8f1b.png"><br>简化后，其所执行的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;echo ~root &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;( umask 77 &amp;&amp; mkdir -p &quot;` echo /root/.ansible/tmp `&quot;&amp;&amp; mkdir &quot;` echo /root/.ansible/tmp/ansible-tmp-1599546740.791937-1678-254955456024140 `&quot; &amp;&amp; echo ansible-tmp-1599546740.791937-1678-254955456024140=&quot;` echo /root/.ansible/tmp/ansible-tmp-1599546740.791937-1678-254955456024140 `&quot; ) &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;echo PLATFORM; uname; echo FOUND; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;/usr/bin/python&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python3.7&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python3.6&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python3.5&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python2.7&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python2.6&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;/usr/libexec/platform-python&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;/usr/bin/python3&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; command -v &#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;python&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;&quot;&#x27;; echo ENDFOUND &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;/usr/bin/python &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">sftp -b - -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 &#x27;[9.134.124.159]&#x27;</span><br><span class="line">ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;chmod u+x /root/.ansible/tmp/ansible-tmp-1599546740.791937-1678-254955456024140/ /root/.ansible/tmp/ansible-tmp-1599546740.791937-1678-254955456024140/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 -tt 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;/usr/bin/python /root/.ansible/tmp/ansible-tmp-1599546740.791937-1678-254955456024140/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line">ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=36000 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o &#x27;User=&quot;root&quot;&#x27; -o ConnectTimeout=10 -o ControlPath=/Users/yangyu/.ansible/cp/4846fe66a5 9.134.124.159 &#x27;/bin/sh -c &#x27;&quot;&#x27;&quot;&#x27;rm -f -r /root/.ansible/tmp/ansible-tmp-1599546740.791937-1678-254955456024140/ &gt; /dev/null 2&gt;&amp;1 &amp;&amp; sleep 0&#x27;&quot;&#x27;&quot;&#x27;&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="上传到被控端的文件"><a href="#上传到被控端的文件" class="headerlink" title="上传到被控端的文件"></a>上传到被控端的文件</h3><p>上传到被控制的文件，在 <code>~/.ansible/tmp/xxx</code> 下，是一个 Python 脚本，名称为：<code>AnsiballZ_command.py</code>，里面还包含一段压缩文件的 base64。代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">_ANSIBALLZ_WRAPPER = <span class="literal">True</span> <span class="comment"># For test-module.py script to tell this is a ANSIBALLZ_WRAPPER</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_ansiballz_main</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="keyword">import</span> os.path</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="keyword">import</span> __main__</span><br><span class="line">    scriptdir = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        scriptdir = os.path.dirname(os.path.realpath(__main__.__file__))</span><br><span class="line">    <span class="keyword">except</span> (AttributeError, OSError):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    excludes = <span class="built_in">set</span>((<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, scriptdir))</span><br><span class="line">    sys.path = [p <span class="keyword">for</span> p <span class="keyword">in</span> sys.path <span class="keyword">if</span> p <span class="keyword">not</span> <span class="keyword">in</span> excludes]</span><br><span class="line">    <span class="keyword">import</span> base64</span><br><span class="line">    <span class="keyword">import</span> runpy</span><br><span class="line">    <span class="keyword">import</span> shutil</span><br><span class="line">    <span class="keyword">import</span> tempfile</span><br><span class="line">    <span class="keyword">import</span> zipfile</span><br><span class="line">    <span class="keyword">if</span> sys.version_info &lt; (<span class="number">3</span>,):</span><br><span class="line">        PY3 = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        PY3 = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># ZIPDATA 的值已经省略</span></span><br><span class="line">    ZIPDATA = <span class="string">&quot;&quot;&quot;xxxxxxxxxxx&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">invoke_module</span>(<span class="params">modlib_path, temp_path, json_params</span>):</span></span><br><span class="line">        z = zipfile.ZipFile(modlib_path, mode=<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        sitecustomize = <span class="string">u&#x27;import sys\nsys.path.insert(0,&quot;%s&quot;)\n&#x27;</span> %  modlib_path</span><br><span class="line">        sitecustomize = sitecustomize.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        zinfo = zipfile.ZipInfo()</span><br><span class="line">        zinfo.filename = <span class="string">&#x27;sitecustomize.py&#x27;</span></span><br><span class="line">        zinfo.date_time = ( <span class="number">2020</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">54</span>, <span class="number">28</span>)</span><br><span class="line">        z.writestr(zinfo, sitecustomize)</span><br><span class="line">        z.close()</span><br><span class="line">        sys.path.insert(<span class="number">0</span>, modlib_path)</span><br><span class="line">        <span class="keyword">from</span> ansible.module_utils <span class="keyword">import</span> basic</span><br><span class="line">        basic._ANSIBLE_ARGS = json_params</span><br><span class="line"></span><br><span class="line">        runpy.run_module(mod_name=<span class="string">&#x27;ansible.modules.command&#x27;</span>, init_globals=<span class="literal">None</span>, run_name=<span class="string">&#x27;__main__&#x27;</span>, alter_sys=<span class="literal">True</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#123;&quot;msg&quot;: &quot;New-style module did not handle its own exit&quot;, &quot;failed&quot;: true&#125;&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">debug</span>(<span class="params">command, zipped_mod, json_params</span>):</span></span><br><span class="line">        basedir = os.path.join(os.path.abspath(os.path.dirname(__file__)), <span class="string">&#x27;debug_dir&#x27;</span>)</span><br><span class="line">        args_path = os.path.join(basedir, <span class="string">&#x27;args&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> command == <span class="string">&#x27;explode&#x27;</span>:</span><br><span class="line">            z = zipfile.ZipFile(zipped_mod)</span><br><span class="line">            <span class="keyword">for</span> filename <span class="keyword">in</span> z.namelist():</span><br><span class="line">                <span class="keyword">if</span> filename.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Something wrong with this module zip file: should not contain absolute paths&#x27;</span>)</span><br><span class="line">                dest_filename = os.path.join(basedir, filename)</span><br><span class="line">                <span class="keyword">if</span> dest_filename.endswith(os.path.sep) <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(dest_filename):</span><br><span class="line">                    os.makedirs(dest_filename)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    directory = os.path.dirname(dest_filename)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">                        os.makedirs(directory)</span><br><span class="line">                    f = <span class="built_in">open</span>(dest_filename, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">                    f.write(z.read(filename))</span><br><span class="line">                    f.close()</span><br><span class="line">            f = <span class="built_in">open</span>(args_path, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">            f.write(json_params)</span><br><span class="line">            f.close()</span><br><span class="line">            print(<span class="string">&#x27;Module expanded into:&#x27;</span>)</span><br><span class="line">            print(<span class="string">&#x27;%s&#x27;</span> % basedir)</span><br><span class="line">            exitcode = <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;execute&#x27;</span>:</span><br><span class="line">            sys.path.insert(<span class="number">0</span>, basedir)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(args_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                json_params = f.read()</span><br><span class="line">            <span class="keyword">from</span> ansible.module_utils <span class="keyword">import</span> basic</span><br><span class="line">            basic._ANSIBLE_ARGS = json_params</span><br><span class="line">            runpy.run_module(mod_name=<span class="string">&#x27;ansible.modules.command&#x27;</span>, init_globals=<span class="literal">None</span>, run_name=<span class="string">&#x27;__main__&#x27;</span>, alter_sys=<span class="literal">True</span>)</span><br><span class="line">            print(<span class="string">&#x27;&#123;&quot;msg&quot;: &quot;New-style module did not handle its own exit&quot;, &quot;failed&quot;: true&#125;&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&#x27;WARNING: Unknown debug command.  Doing nothing.&#x27;</span>)</span><br><span class="line">            exitcode = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> exitcode</span><br><span class="line">    ANSIBALLZ_PARAMS = <span class="string">&#x27;&#123;&quot;ANSIBLE_MODULE_ARGS&quot;: &#123;&quot;_raw_params&quot;: &quot;ls /root&quot;, &quot;_ansible_check_mode&quot;: false, &quot;_ansible_no_log&quot;: false, &quot;_ansible_debug&quot;: false, &quot;_ansible_diff&quot;: false, &quot;_ansible_verbosity&quot;: 3, &quot;_ansible_version&quot;: &quot;2.11.0.dev0&quot;, &quot;_ansible_module_name&quot;: &quot;ansible.legacy.command&quot;, &quot;_ansible_syslog_facility&quot;: &quot;LOG_USER&quot;, &quot;_ansible_selinux_special_fs&quot;: [&quot;fuse&quot;, &quot;nfs&quot;, &quot;vboxsf&quot;, &quot;ramfs&quot;, &quot;9p&quot;, &quot;vfat&quot;], &quot;_ansible_string_conversion_action&quot;: &quot;warn&quot;, &quot;_ansible_socket&quot;: null, &quot;_ansible_shell_executable&quot;: &quot;/bin/sh&quot;, &quot;_ansible_keep_remote_files&quot;: false, &quot;_ansible_tmpdir&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1599457948.85933-15430-201759115318770/&quot;, &quot;_ansible_remote_tmp&quot;: &quot;~/.ansible/tmp&quot;&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> PY3:</span><br><span class="line">        ANSIBALLZ_PARAMS = ANSIBALLZ_PARAMS.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        temp_path = tempfile.mkdtemp(prefix=<span class="string">&#x27;ansible_ansible.legacy.command_payload_&#x27;</span>)</span><br><span class="line">        zipped_mod = os.path.join(temp_path, <span class="string">&#x27;ansible_ansible.legacy.command_payload.zip&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(zipped_mod, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> modlib:</span><br><span class="line">            modlib.write(base64.b64decode(ZIPDATA))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">2</span>:</span><br><span class="line">            exitcode = debug(sys.argv[<span class="number">1</span>], zipped_mod, ANSIBALLZ_PARAMS)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            invoke_module(zipped_mod, temp_path, ANSIBALLZ_PARAMS)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            shutil.rmtree(temp_path)</span><br><span class="line">        <span class="keyword">except</span> (NameError, OSError):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    sys.exit(exitcode)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    _ansiballz_main()</span><br></pre></td></tr></table></figure>
<p>当 <code>AnsiballZ_command.py</code> 执行时，会首先将 <code>ZIPDATA</code> 还原成一个压缩文件，然后在压缩文件中加入一个 <code>sitecustomize.py</code>。准备完成后，将以 <code>runpy.run_module()</code> 的方式，执行压缩文件中的 Python 代码。可以看出，我们所需要执行的命令，储存在 <code>ANSIBALLZ_PARAMS</code> 变量中，并赋值给了 <code>basic._ANSIBLE_ARGS</code>。</p>
<h3 id="ZIPDATA-压缩包"><a href="#ZIPDATA-压缩包" class="headerlink" title="ZIPDATA 压缩包"></a>ZIPDATA 压缩包</h3><p>首先，压缩文件中的内容如下。此压缩包通过手段获取到后，解压后，名称为 <code>ansible</code>，里面的文件如 basic.py、command.py 来自所执行命令 ansible 所在的包下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">╰─$ tree ansible</span><br><span class="line">ansible</span><br><span class="line">├── __init__.py</span><br><span class="line">├── module_utils</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── _text.py</span><br><span class="line">│   ├── basic.py</span><br><span class="line">│   ├── common</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── _collections_compat.py</span><br><span class="line">│   │   ├── _json_compat.py</span><br><span class="line">│   │   ├── _utils.py</span><br><span class="line">│   │   ├── collections.py</span><br><span class="line">│   │   ├── file.py</span><br><span class="line">│   │   ├── parameters.py</span><br><span class="line">│   │   ├── process.py</span><br><span class="line">│   │   ├── sys_info.py</span><br><span class="line">│   │   ├── text</span><br><span class="line">│   │   │   ├── __init__.py</span><br><span class="line">│   │   │   ├── converters.py</span><br><span class="line">│   │   │   └── formatters.py</span><br><span class="line">│   │   ├── validation.py</span><br><span class="line">│   │   └── warnings.py</span><br><span class="line">│   ├── compat</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── _selectors2.py</span><br><span class="line">│   │   └── selectors.py</span><br><span class="line">│   ├── distro</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   └── _distro.py</span><br><span class="line">│   ├── parsing</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   └── convert_bool.py</span><br><span class="line">│   ├── pycompat24.py</span><br><span class="line">│   └── six</span><br><span class="line">│       └── __init__.py</span><br><span class="line">└── modules</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    └── command.py</span><br></pre></td></tr></table></figure>
<p>其次，压缩文件中代码的执行。从 <code>runpy.run_module</code> 中的 <code>mod_name=&#39;ansible.modules.command&#39;</code> 猜测，是要执行压缩包下的 <code>modules/command.py</code>。此文件的执行，包括了一个 <code>AnsibleModule</code> 的初始化，在它的构造函数中，可以看出来，获取了 <code>basic._ANSIBLE_ARGS</code> 的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnsibleModule</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, argument_spec, bypass_checks=<span class="literal">False</span>, no_log=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 mutually_exclusive=<span class="literal">None</span>, required_together=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 required_one_of=<span class="literal">None</span>, add_file_common_args=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 supports_check_mode=<span class="literal">False</span>, required_if=<span class="literal">None</span>, required_by=<span class="literal">None</span></span>):</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        self._load_params()</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"><span class="comment">##############################basic.py##############################</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_load_params</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.params = _load_params()</span><br><span class="line"><span class="comment">##############################basic.py##############################</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_load_params</span>():</span></span><br><span class="line">    <span class="keyword">global</span> _ANSIBLE_ARGS</span><br><span class="line">    <span class="keyword">if</span> _ANSIBLE_ARGS <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        buffer = _ANSIBLE_ARGS</span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>
<p>最终，从 command.py 执行到 basic.py，以开启执行系统命令，作为我们所要脚本（即：<code>ls /root</code>）执行的开始</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd = subprocess.Popen(args, **kwargs)</span><br></pre></td></tr></table></figure>

<h3 id="等待-shell-命令执行完毕"><a href="#等待-shell-命令执行完毕" class="headerlink" title="等待 shell 命令执行完毕"></a>等待 shell 命令执行完毕</h3><p>在此处，为 cmd 的 stdout、stderr 注册了可读事件到 selector，并在一个死循环中轮训 selector，如果有 cmd.stdout、cmd.stderr 可读事件，就将对应的数据，追加到相应的变量上。当 cmd 执行完成后，退出死循环，并返回 cmd 执行后的 stdout、stderr。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">selector.register(cmd.stdout, selectors.EVENT_READ)</span><br><span class="line">selector.register(cmd.stderr, selectors.EVENT_READ)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    events = selector.select(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> key, event <span class="keyword">in</span> events:</span><br><span class="line">        b_chunk = key.fileobj.read()</span><br><span class="line">        <span class="keyword">if</span> b_chunk == b(<span class="string">&#x27;&#x27;</span>):</span><br><span class="line">            selector.unregister(key.fileobj)</span><br><span class="line">        <span class="keyword">if</span> key.fileobj == cmd.stdout:</span><br><span class="line">            stdout += b_chunk</span><br><span class="line">        <span class="keyword">elif</span> key.fileobj == cmd.stderr:</span><br><span class="line">            stderr += b_chunk</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># only break out if no pipes are left to read or</span></span><br><span class="line">    <span class="comment"># the pipes are completely read and</span></span><br><span class="line">    <span class="comment"># the process is terminated</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> events <span class="keyword">or</span> <span class="keyword">not</span> selector.get_map()) <span class="keyword">and</span> cmd.poll() <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># No pipes are left to read but process is not yet terminated</span></span><br><span class="line">    <span class="comment"># Only then it is safe to wait for the process to be finished</span></span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> Actually cmd.poll() is always None here if no selectors are left</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> selector.get_map() <span class="keyword">and</span> cmd.poll() <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        cmd.wait()</span><br><span class="line">        <span class="comment"># The process is terminated. Since no pipes to read from are</span></span><br><span class="line">        <span class="comment"># left, there is no need to call select() again.</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> (rc, stdout, stderr)</span><br></pre></td></tr></table></figure>

<h2 id="控制中心"><a href="#控制中心" class="headerlink" title="控制中心"></a>控制中心</h2><p>是什么地方定义上上面这 8 个步骤？产生上面 8 个步骤的地方，开始于：<code>ansible/plugins/action/command.py</code>，其中 <code>self._execute_module()</code> 完成了前面的 7 个操作，<code>self._remove_tmp_path()</code> 完成了删除 <code>~/.ansible/tmp/xxxxx</code> 的任务。</p>
<h3 id="重试机制"><a href="#重试机制" class="headerlink" title="重试机制"></a>重试机制</h3><ol>
<li>什么时候进行重试</li>
</ol>
<ul>
<li>an exception is caught</li>
<li>ssh returns 255（ControlPersist 超时不能用或者远程主机连不上）</li>
</ul>
<ol start="2">
<li>什么时候不进行重试。</li>
</ol>
<ul>
<li>sshpass returns 5 (invalid password, to prevent account lockouts)</li>
<li>remaining_tries is &lt; 2</li>
<li>retries limit reached</li>
</ul>
<p>重试的方式，是通过一个对连接函数的闭包操作完成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_ssh_retry</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">    @wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        remaining_tries = <span class="built_in">int</span>(C.ANSIBLE_SSH_RETRIES) + <span class="number">1</span></span><br><span class="line">        cmd_summary = <span class="string">u&quot;%s...&quot;</span> % to_text(args[<span class="number">0</span>])</span><br><span class="line">        conn_password = self.get_option(<span class="string">&#x27;password&#x27;</span>) <span class="keyword">or</span> self._play_context.password</span><br><span class="line">        <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(remaining_tries):</span><br><span class="line">            ...</span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="meta">@_ssh_retry</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_run</span>(<span class="params">self, cmd, in_data, sudoable=<span class="literal">True</span>, checkrc=<span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Wrapper around _bare_run that retries the connection</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> self._bare_run(cmd, in_data, sudoable=sudoable, checkrc=checkrc)</span><br></pre></td></tr></table></figure>

<h2 id="可借鉴点"><a href="#可借鉴点" class="headerlink" title="可借鉴点"></a>可借鉴点</h2><ul>
<li>复用已有链接：<a target="_blank" rel="noopener" href="https://ldpreload.com/blog/ssh-control">https://ldpreload.com/blog/ssh-control</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-28T14:56:55.000Z" title="9/28/2020, 10:56:55 PM">2020-09-28</time>发表</span><span class="level-item"><time dateTime="2022-04-20T15:45:20.050Z" title="4/20/2022, 11:45:20 PM">2022-04-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Golang/">Golang</a></span><span class="level-item">5 分钟读完 (大约772个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/28/622379f83330.html">2 | Golang： 笔记</a></h1><div class="content">Go语言允许用户定义类型。当用户声明一个新类型时，这个声明就给编译器提供了一个框架，告知必要的内存大小和表示信息。声明后的类型与内置类型的运作方式类似。Go语言里声明用户定义的类型有两种方法。最常用的方法是使用关键字struct，它可以让用户创建一个结构类型。零值：当声明变量时，这个变量对应的值总是</div><a class="article-more button is-small is-size-7" href="/2020/09/28/622379f83330.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-23T06:46:17.000Z" title="9/23/2020, 2:46:17 PM">2020-09-23</time>发表</span><span class="level-item"><time dateTime="2022-04-20T15:45:51.204Z" title="4/20/2022, 11:45:51 PM">2022-04-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Golang/">Golang</a></span><span class="level-item">6 分钟读完 (大约968个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/23/fb0ee74ab711.html">1 | Golang：基础数据结构</a></h1><div class="content">三个常用的数据类型的大致实现，有点绕，但是很有收获！切片 Slice数据结构在64位架构的机器上，一个切片需要24字节的内存：指针字段需要8字节，长度和容量字段分别需要8字节。var slice []int 创建的数据结构如下：使用对新切片的长度与容量的计算规则如下：对底层数组容量是k的切片slic</div><a class="article-more button is-small is-size-7" href="/2020/09/23/fb0ee74ab711.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-08T10:05:41.000Z" title="9/8/2020, 6:05:41 PM">2020-09-08</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:30.281Z" title="2/9/2021, 11:03:30 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Docker/">Docker</a></span><span class="level-item">21 分钟读完 (大约3159个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/08/172fdf84bb45.html">Dockerfiles 官网 doc 笔记</a></h1><div class="content"><p>Docker 通过 Dockerfile 中的指令来构建镜像。<br>Docker 镜像由很多镜像构成，每一层对应一个 Dockerfile 里面的指令。<br>一个运行中的容器，由镜像的<strong>所有层</strong>加上<strong>可写层</strong>构成，所有的读写都在最上面的可写层。<br>容器应该是无状态的，销毁、重建应该花费最小的配置。</p>
<!--more-->

<h2 id="（build-context）构建上下文"><a href="#（build-context）构建上下文" class="headerlink" title="（build context）构建上下文"></a>（build context）构建上下文</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -f ~/Dockerfile.hi context-dir</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过 -f 指定 Dockerfile 的路径</p>
</li>
<li><p><code>context-dir</code> 即为构建上下文，该文件夹下面所有的内容都会被传递给 Docker daemon，用来构建镜像。构建上下文包含不相关的内容，会影响构建速度、镜像大小。</p>
</li>
</ul>
<p>可通过编写 <code>.dockerignore</code> 文件，并放置在构建上下文的目录下，达到类似于 <code>.gitignore</code> 的效果，将不必要的文件（夹）不发送给 Docker Daemon。</p>
<p>有如下几种从 <code>stdin</code> 构建镜像的方式：</p>
<blockquote>
<p><code>-</code> 表是占位，从 <code>stdin</code> 读取</p>
</blockquote>
<ol>
<li>无构建上下文（不需要拷贝文件到镜像中）</li>
</ol>
<p>模板</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build [OPTIONS] -</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -e &#x27;FROM busybox\nRUN echo &quot;hello world&quot;&#x27; | docker build -</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -&lt;&lt;EOF</span><br><span class="line">FROM busybox</span><br><span class="line">RUN echo &quot;hello world&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>上述两种方式，都不会给 Docker Daemon 发送构建上下文，但是注意不要在 Dockerfile 中使用 <code>COPY</code> 、 <code>ADD</code> ，这样会导致构建失败。</p>
<ol start="2">
<li>传递本地构建上下文</li>
</ol>
<p>模板</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build [OPTIONS] -f- PATH</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> create a directory to work <span class="keyword">in</span></span></span><br><span class="line">mkdir example</span><br><span class="line">cd example</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> create an example file</span></span><br><span class="line">touch somefile.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> build an image using the current directory as context, and a Dockerfile passed through stdin</span></span><br><span class="line">docker build -t myimage:latest -f- . &lt;&lt;EOF</span><br><span class="line">FROM busybox</span><br><span class="line">COPY somefile.txt .</span><br><span class="line">RUN cat /somefile.txt</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>传递<strong>远程</strong>构建上下文</li>
</ol>
<p>模板</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build [OPTIONS] -f- PATH</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -t myimage:latest -f- https://github.com/docker-library/hello-world.git &lt;&lt;EOF</span><br><span class="line">FROM busybox</span><br><span class="line">COPY hello.c .</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="多阶段构建"><a href="#多阶段构建" class="headerlink" title="多阶段构建"></a>多阶段构建</h2><p>使 Dockerfile 在容易维护、阅读的基础上，减少镜像的大小</p>
<h3 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h3><p>在一个 Dockerfile 中使用多个 FROM，每个 FROM 构建一个镜像，在镜像之间的拷贝操作变得容易。如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.7</span>.<span class="number">3</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /go/src/github.com/alexellis/href-counter/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go get -d -v golang.org/x/net/html  </span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> app.go .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest  </span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk --no-cache add ca-certificates</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /root/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=0 /go/src/github.com/alexellis/href-counter/app .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;./app&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>对 <code>--from=0</code> ，按照数组下标从 0 开始，第一个 FROM 构建的镜像为0，依次类推。当然也可以给 FROM 构建的镜像命名：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.7</span>.<span class="number">3</span> AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /go/src/github.com/alexellis/href-counter/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go get -d -v golang.org/x/net/html  </span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> app.go    .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest  </span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk --no-cache add ca-certificates</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /root/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /go/src/github.com/alexellis/href-counter/app .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;./app&quot;</span>]  </span></span><br></pre></td></tr></table></figure>

<p>其实 <code>--from=xxx</code> 中的 xxx 也可以为其它的、不在此 Dockerfile 中产生的镜像</p>
<h3 id="其它用法"><a href="#其它用法" class="headerlink" title="其它用法"></a>其它用法</h3><ol>
<li>只构建指定的构建阶段，即某特定 <code>FROM</code> 所代表的镜像。沿用前面的例子，可以只构建 <code>builder</code> 阶段的镜像。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build --target builder -t alexellis2/href-counter:latest .</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>后续的 <code>FROM</code> 可以以前面的 <code>FROM</code> 构建的镜像做为 base。</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest as builder</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk --no-cache add build-base</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> builder as build1</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> source1.cpp source.cpp</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> g++ -o /binary source.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> builder as build2</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> source2.cpp source.cpp</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> g++ -o /binary source.cpp</span></span><br></pre></td></tr></table></figure>

<h2 id="构建缓存"><a href="#构建缓存" class="headerlink" title="构建缓存"></a>构建缓存</h2><p>显式声明不使用缓存： <code>docker build --no-cache=true ...</code> 。不做显式声明，默认可能会利用构建缓存，能成功利用构建缓存的情况：</p>
<ol>
<li>如果从缓存中存在的一个镜像开始构建，那么会将基于此父镜像的所有子镜像的 Dockerfile 拉出来做一个对比，看下一条指令是否相同，如果不相同，缓存失效。</li>
<li>对比 Dockerfile 内容是否相同。一些特殊命令，需要更多检测。</li>
<li>对 <code>ADD</code> 和 <code>COPY</code> ，它们操作的文件对象都会被作为 checksum 的一部分，不一致则缓存失效。</li>
<li>除了 <code>ADD</code> 和 <code>COPY</code> ，其他命令带来的文件改变，不会被计入 checksum，也就是在匹配镜像时，会忽略此部分的文件的不同。</li>
</ol>
<h2 id="其他建议写法"><a href="#其他建议写法" class="headerlink" title="其他建议写法"></a>其他建议写法</h2><ol>
<li><p>不安装多余的包。降低复杂度、依赖性、镜像大小和构建时间。</p>
</li>
<li><p>解耦应用，一个容器只关心一件事情，以达到水平扩展和容器的复用。但是并意味着一个容器一个进程一成不变。</p>
</li>
<li><p>减少镜像的层数。只有 <code>RUN</code> , <code>COPY</code> , <code>ADD</code> 三个指令添加层数，其他的指令只会创建临时的层，并不会增加镜像大小。所以，分多个阶段来构建镜像，只拷贝需要的文件到镜像中，能有效减少镜像的大小。</p>
</li>
<li><p>为多行参数排序。按字母顺序排序。避免包重复。如下：</p>
</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="bash">  bzr \</span></span><br><span class="line"><span class="bash">  cvs \</span></span><br><span class="line"><span class="bash">  git \</span></span><br><span class="line"><span class="bash">  mercurial \</span></span><br><span class="line"><span class="bash">  subversion</span></span><br></pre></td></tr></table></figure>

<h2 id="Dockerfile-指令"><a href="#Dockerfile-指令" class="headerlink" title="Dockerfile 指令"></a>Dockerfile 指令</h2><h3 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h3><p>三种方式</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> [--platform=&lt;platform&gt;] &lt;image&gt; [AS &lt;name&gt;]</span><br><span class="line"><span class="keyword">FROM</span> [--platform=&lt;platform&gt;] &lt;image&gt;[:&lt;tag&gt;] [AS &lt;name&gt;]</span><br><span class="line"><span class="keyword">FROM</span> [--platform=&lt;platform&gt;] &lt;image&gt;[@&lt;digest&gt;] [AS &lt;name&gt;]</span><br></pre></td></tr></table></figure>

<p>几个要点</p>
<ul>
<li><code>FROM</code> 开启一个构建</li>
<li><code>Dockerfile</code> 的第一个必须是 <code>FROM</code> ，但是 <code>FROM</code> 前面可以有 <code>ARG</code> 来声明变量</li>
<li><code>Dockerfile</code> 中可以出现多个 <code>FROM</code> 来实现多阶段构建</li>
<li>可以为构建阶段添加别名，在后续 <code>FROM</code> 和 <code>COPY --from=&lt;name|index&gt;</code> 中使用</li>
</ul>
<p><code>ARG</code> 的使用样例</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span>  CODE_VERSION=latest</span><br><span class="line"><span class="keyword">FROM</span> base:$&#123;CODE_VERSION&#125;</span><br><span class="line"><span class="keyword">CMD</span><span class="bash">  /code/run-app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> extras:$&#123;CODE_VERSION&#125;</span><br><span class="line"><span class="keyword">CMD</span><span class="bash">  /code/run-extras</span></span><br></pre></td></tr></table></figure>

<h3 id="LABEL"><a href="#LABEL" class="headerlink" title="LABEL"></a>LABEL</h3><p>注意事项</p>
<ul>
<li>字符串中含有空格，必须<strong>转义</strong>或使用 <code>&quot;&quot;</code></li>
<li>字符串中含有 <code>&quot;</code> ，必须转义</li>
<li>用自己的反转域名作为 label 前缀，必须对域名有权限</li>
<li><code>Docker</code> 保留的前缀： <code>com.docker.*</code> , <code>io.docker.*</code> , <code>org.dockerproject.*</code></li>
<li>key 应该使用小写字母数字、 <code>.</code> 、 <code>-</code></li>
</ul>
<ul>
<li><p>示例</p>
</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set one or more individual labels</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> com.example.version=<span class="string">&quot;0.0.1-beta&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> vendor1=<span class="string">&quot;ACME Incorporated&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> vendor2=ZENITH\ Incorporated</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> com.example.release-date=<span class="string">&quot;2015-02-12&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> com.example.version.is-production=<span class="string">&quot;&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set multiple labels on one line</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> com.example.version=<span class="string">&quot;0.0.1-beta&quot;</span> com.example.release-date=<span class="string">&quot;2015-02-12&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set multiple labels at once, using line-continuation characters to break long lines</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> vendor=ACME\ Incorporated \</span></span><br><span class="line"><span class="bash">      com.example.is-beta= \</span></span><br><span class="line"><span class="bash">      com.example.is-production=<span class="string">&quot;&quot;</span> \</span></span><br><span class="line"><span class="bash">      com.example.version=<span class="string">&quot;0.0.1-beta&quot;</span> \</span></span><br><span class="line"><span class="bash">      com.example.release-date=<span class="string">&quot;2015-02-12&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>查看 label</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image inspect</span><br></pre></td></tr></table></figure>

<h3 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h3><p>两种形式</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shell form</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> &lt;<span class="built_in">command</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># exec form</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">&quot;executable&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p><strong>shell form</strong> 将会在 shell 中运行，Linux 默认为 <code>/bin/sh -C</code> ，Windows 默认为 <code>cmd /S /C</code> ，默认 shell 可以通过 <code>SHELL</code> 指令进行指定。</p>
<p><strong>exec form</strong> 会被解析成 JSON 数组，因此需要用 <code>&quot;</code> 扩起来。</p>
<p> 注： <code>RUN [ &quot;echo&quot;, &quot;$HOME&quot; ]</code> 无法读取变量，要用 <code>RUN [ &quot;sh&quot;, &quot;-c&quot;, &quot;echo $HOME&quot; ]</code> 才行。</p>
<p>在镜像顶层之上，创建新的镜像层，然后运行命令，结束后，持久化为一个只读镜像层。</p>
<h4 id="apt-get"><a href="#apt-get" class="headerlink" title="apt-get"></a>apt-get</h4><p>使用 <code>RUN</code> 指令，最多的就是执行 <code>apt-get</code> 之类的代码，来安装依赖。有如下注意点：</p>
<ul>
<li>避免运行 <code>apt-get upgrade</code> 和 <code>dist-upgrade</code></li>
<li>使用 <code>apt-get install -y foo</code> 来自动升级一个依赖包</li>
<li>将 <code>RUN apt-get update</code> 和 <code>apt-get install</code> 包含在同一个 <code>RUN</code> 指令中</li>
</ul>
<p>一个比较推荐的写法</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="bash">    aufs-tools \</span></span><br><span class="line"><span class="bash">    automake \</span></span><br><span class="line"><span class="bash">    build-essential \</span></span><br><span class="line"><span class="bash">    curl \</span></span><br><span class="line"><span class="bash">    dpkg-sig \</span></span><br><span class="line"><span class="bash">    libcap-dev \</span></span><br><span class="line"><span class="bash">    libsqlite3-dev \</span></span><br><span class="line"><span class="bash">    mercurial \</span></span><br><span class="line"><span class="bash">    reprepro \</span></span><br><span class="line"><span class="bash">    ruby1.9.1 \</span></span><br><span class="line"><span class="bash">    ruby1.9.1-dev \</span></span><br><span class="line"><span class="bash">    s3cmd=1.1.* \</span></span><br><span class="line"><span class="bash"> &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br></pre></td></tr></table></figure>

<p>Debian 和 Ubuntu 会自动运行 <code>apt-get clean</code></p>
<h4 id="管道符"><a href="#管道符" class="headerlink" title="管道符"></a>管道符</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> wget -O - https://some.site | wc -l &gt; /number</span></span><br></pre></td></tr></table></figure>

<p>默认只以最后一个命令 <code>wc</code> 的状态作为整个 <code>RUN</code> 指令的成功或失败，即使 <code>wget</code> 失败了。但可以通过设置 <code>set -o pipefail</code> 避免失败被忽略。如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -o pipefail &amp;&amp; wget -O - https://some.site | wc -l &gt; /number</span></span><br></pre></td></tr></table></figure>

<h3 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h3><blockquote>
<p>CMD 指令和我印象中的不太一样。</p>
</blockquote>
<p>三种形式</p>
<ul>
<li>CMD [“executable”,”param1”,”param2”] (exec form, 首推)</li>
<li>CMD [“param1”,”param2”] (作为 ENTRYPOINT 的默认参数， <strong>不推荐使用，除非很了解 ENTRYPOINT</strong>)</li>
<li>CMD command param1 param2 (shell form)</li>
</ul>
<p>只能有一个 CMD 指令，多个 CMD 指令的情况，最后一个 CMD 指令生效。目的是提供可执行命令或参数（此时必须指定 ENTRYPOINT）。<br>exec form 不提供变量替换。<br>shell form 默认使用 <code>/bin/sh -c</code> 执行；当执行命令不需要 shell 时，可以使用 exec shell。</p>
<p>在构建期间：RUN 会执行，并将结果作为镜像层进行提交；CMD 则不会执行。</p>
<p>CMD 的使用示例（以 nginx 为例）：</p>
<ul>
<li>错误❌ ： <code>CMD service nginx start</code></li>
<li>正确✅ ： <code>CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</code><br>对于容器而言，其启动程序就是容器应用进程，容器就是为了主进程而存在的，主进程退出，容器就失去了存在的意义，从而退出，其它辅助进程不是它需要关心的东西。 <code>CMD service nginx start</code> 会被理解为 <code>CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;service nginx start&quot;]</code> ，因此主进程实际上是 sh。那么当 <code>service nginx start</code> 命令结束后，sh 也就结束了，sh 作为主进程退出了，自然就会令容器退出。</li>
</ul>
<h3 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h3><blockquote>
<p>这个指令印象中是暴露一个容器的端口，但仔细想了想这个指令，对它的作用产生了怀疑。如果这个指令能暴露端口的话，那么和 <code>docker run -p</code> 是什么关系。</p>
</blockquote>
<p>EXPOSE 声明运行时容器提供服务端口，<strong>这只是一个声明</strong>，在运行时并不会因为这个声明应用就会开启这个端口的服务。这个指令的好处为：</p>
<ol>
<li>方便镜像使用者理解以配置端口映射</li>
<li>运行时，使用 <code>docker run -P</code> 为被 EXPOSE 声明过的容器的端口，随机映射一个宿主机端口。</li>
</ol>
<h3 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h3><blockquote>
<p>单纯设置环境变量</p>
</blockquote>
<p>格式有两种：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> &lt;key&gt; &lt;value&gt;</span><br><span class="line"><span class="keyword">ENV</span> &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt;...</span><br></pre></td></tr></table></figure>

<p>在 ENV 后面的指令/运行时，能访问该环境变量。</p>
<h3 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h3><blockquote>
<p>从宿主机，拷贝文件到镜像中</p>
</blockquote>
<p>如果源路径为文件夹，复制的时候<strong>不是直接复制该文件夹</strong>，而是将<strong>文件夹中的内容</strong>复制到目标路径。</p>
<p>权限问题：默认情况下，新拷贝的文件的 UID 和 GID 都是 0，即归属 root 用户。可以通过 <code>--chown USER:GROUP</code> 来修改文件所属（仅适合用于创建 Linux 容器）。</p>
<p>从 STDIN 构建的话，没有构建上下文，不能使用 COPY。</p>
<p>COPY 还可以接受 <code>--from=&lt;name|index&gt;</code> 从镜像中拷贝文件。</p>
<h3 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h3><blockquote>
<p>之前没见过</p>
</blockquote>
<p>与 COPY 类似，但是会自动将压缩包解压到目标文件夹。如下： <code>ADD rootfs.tar.xz /</code> 。</p>
<p>一般情况用 COPY，需要自动解压压缩包的情景再用 ADD。</p>
<h3 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h3><blockquote>
<p>这部分内容之前并没仔细了解过，觉得就是简单的容器的启动命令，填上就行，但是看完这部分的文档后，刷新了认知。</p>
</blockquote>
<p>两种启动模式：</p>
<ul>
<li>exec form (<strong>preferred form</strong>)： <code>ENTRYPOINT [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</code></li>
<li>shell form： <code>ENTRYPOINT command param1 param2</code></li>
</ul>
<h4 id="PID-1-进程"><a href="#PID-1-进程" class="headerlink" title="PID 1 进程"></a><code>PID 1</code> 进程</h4><p>顾名思义，进程号为 1 的进程。特殊的地方在于，<strong>PID 1 进程可以接收发给容器的 UNIX 信号</strong>。</p>
<p><img src="/images/pics/f5e605f6f1f99f4cc6ac0b03686c722b.png" alt="有什么用？"></p>
<p>PID 1 进程的用处，可以通过下面的 Dockerfile 来展示：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> top -b</span></span><br></pre></td></tr></table></figure>

<p>构建完成后，执行下面的命令，可以看到关闭容器花费了非常长的时间：</p>
<p><img src="/images/pics/60f98b0e933ed1ae2fba87d4c332c976.png" alt="非 PID 1"></p>
<p>当执行 <code>docker stop</code> 时，容器并未完全退出， <code>docker stop</code> 会在超时后，发送 <code>SIGKILL</code> 关闭容器中的其他进程。</p>
<p>如果 <code>top -b</code> 是 PID 1 进程呢？修改一下 Dockerfile 如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> <span class="built_in">exec</span> top -b</span></span><br></pre></td></tr></table></figure>

<p>可以很明显看出，很顺畅地就完成了 <code>docker stop</code></p>
<p><img src="/images/pics/780bca2b070b3960789bb44818c2b5ee.png" alt="PID 1"></p>
<h4 id="exec-form"><a href="#exec-form" class="headerlink" title="exec form"></a>exec form</h4><p>ENTRYPOINT 中的命令默认 PID 为 1，即不会通过某种 shell 来启动（也就无法进行变量替换）。<br>如果是以一个脚本来启动服务，需要在脚本中使用 exec 或 gosu 来执行。</p>
<ol>
<li>什么是 gosu?</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/tianon/gosu">https://github.com/tianon/gosu</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000004527476">https://segmentfault.com/a/1190000004527476</a></li>
</ul>
<ol start="2">
<li>什么是 exec?</li>
</ol>
<h4 id="shell-form"><a href="#shell-form" class="headerlink" title="shell form"></a>shell form</h4><ul>
<li>CMD、 <code>docker run</code> 命令行参数都会被忽略掉。</li>
<li>ENTRYPOINT 会以 <code>/bin/sh -c</code> 的子进程运行，即非 PID 1 进程，无法接收 UNIX 信号。</li>
<li>可以通过 exec 达到让 ENTRYPOINT 指定的服务 PID 为 1。</li>
</ul>
<h4 id="ENTRYPOINT-amp-CMD"><a href="#ENTRYPOINT-amp-CMD" class="headerlink" title="ENTRYPOINT &amp; CMD"></a>ENTRYPOINT &amp; CMD</h4><p>两者之间的规定：</p>
<ol>
<li>Dockerfile 中至少有一个 ENTRYPOINT 或 CMD。<em>也就说可以有多个，但是最后一个才会生效</em>。</li>
<li>ENTRYPOINT should be defined when using the container as an executable.<em>Why？</em></li>
<li>CMD 可以用作 ENTRYPOINT 的默认参数 或 <em>for executing an ad-hoc command in a container</em>.</li>
<li>CMD will be overridden when running the container with alternative arguments.<em>What?</em></li>
</ol>
<p>两者之间的协同关系：</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">No ENTRYPOINT</th>
<th align="left">ENTRYPOINT exec_entry p1_entry (shell form)</th>
<th align="left">ENTRYPOINT [“exec_entry”, “p1_entry”]（exec form）</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>No CMD</strong></td>
<td align="left"><strong>error, not allowed</strong></td>
<td align="left"><em>/bin/sh -c exec_entry p1_entry</em></td>
<td align="left">exec_entry p1_entry</td>
</tr>
<tr>
<td align="left"><strong>CMD [“exec_cmd”, “p1_cmd”]</strong></td>
<td align="left">exec_cmd p1_cmd</td>
<td align="left"><em>/bin/sh -c exec_entry p1_entry</em></td>
<td align="left">exec_entry p1_entry <strong>exec_cmd p1_cmd</strong></td>
</tr>
<tr>
<td align="left"><strong>CMD [“p1_cmd”, “p2_cmd”]</strong></td>
<td align="left">p1_cmd p2_cmd</td>
<td align="left"><em>/bin/sh -c exec_entry p1_entry</em></td>
<td align="left">exec_entry p1_entry <strong>p1_cmd p2_cmd</strong></td>
</tr>
<tr>
<td align="left"><strong>CMD exec_cmd p1_cmd</strong></td>
<td align="left">/bin/sh -c exec_cmd p1_cmd</td>
<td align="left"><em>/bin/sh -c exec_entry p1_entry</em></td>
<td align="left">exec_entry p1_entry <strong>/bin/sh -c exec_cmd p1_cmd</strong></td>
</tr>
</tbody></table>
<h3 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h3><p>含义：直接设置镜像的一个挂载点<br>用途：存放镜像创建的文件、配置、数据库的数据文件。易变、镜像中的用户数据。<br>方式：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">&quot;/data&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /var/<span class="built_in">log</span></span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /var/<span class="built_in">log</span> /var/db</span></span><br></pre></td></tr></table></figure>

<h3 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h3><p>含义：指定镜像运行时的用户和用户组（不指定默认为 root）。<code>USER</code> 指令之后的 <code>CMD</code>、<code>RUN</code>、<code>ENTRYPOINT</code> 都将以 <code>USER</code> 指定的用户和用户组运行。<br>方式：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USER</span> &lt;<span class="keyword">user</span>&gt;[:&lt;group&gt;]</span><br><span class="line"><span class="keyword">USER</span> &lt;UID&gt;[:&lt;GID&gt;]</span><br></pre></td></tr></table></figure>
<p>避免使用 <code>sudo</code>，它会有一定的问题。确有需要考虑使用 <code>gosu</code>。</p>
<h3 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h3><p>含义：指定工作目录，建议使用绝对路径（使用相对路径时，会以当前目录中的文件夹为工作目录）。可以根据需要多次指定，避免使用 cd。此指令对后续的 Dockerfile 指令生效，如：RUN, CMD, ENTRYPOINT, COPY, ADD<br>方式：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /path/to/workdir</span></span><br></pre></td></tr></table></figure>

<h3 id="ONBUILD"><a href="#ONBUILD" class="headerlink" title="ONBUILD"></a>ONBUILD</h3><p>含义：构建 <em>BaseImage</em> 时，加入 ONBUILD 指令，会在使用（FROM <em>BaseImage</em>）的构建中，执行 ONBUILD 指令后，才执行此构建的构建指令。<br>方式：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">ADD</span><span class="bash"> . /app/src</span></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="bash"> /usr/<span class="built_in">local</span>/bin/python-build --dir /app/src</span></span><br></pre></td></tr></table></figure>
<p>使用场景：使用 maven 编译 jar 包，并构建我们自己的业务镜像。所以我们的 Dockerfile 可以如下编写：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.3</span>-jdk-<span class="number">8</span>-<span class="keyword">onbuild</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/usr/src/app/target/demo-1.0-SNAPSHOT-jar-with-dependencies.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>为啥可以这样？这是因为在 maven:3.3-jdk-8-onbuild 这个镜像中，有 ONBUILD 指令，如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3</span>-jdk-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /usr/src/app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /usr/src/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">ADD</span><span class="bash"> . /usr/src/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="bash"> mvn install</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/34865361/8437428">Example Link</a></p>
<p>工作流程：</p>
<ol>
<li>遇到 ONBUILD 指令，添加触发器到镜像的 metadata 中，所以 ONBUILD 不影响当前构建的镜像。</li>
<li>在构建完成后，触发器会被添加到镜像的 manifest 中，可以通过 <code>docker inspect</code> 进行查看。</li>
<li>当被用作基础镜像（FROM xxx）后，新构建执行触发器，即 ONBUILD 指令，全部成功执行完后，才开始新镜像的构建。</li>
<li>触发器在执行后会被清除。</li>
</ol>
<h3 id="HEALTHCHECK"><a href="#HEALTHCHECK" class="headerlink" title="HEALTHCHECK"></a>HEALTHCHECK</h3><p>方式：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check container health by running a command inside the container</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="bash"> [OPTIONS] CMD <span class="built_in">command</span></span></span><br><span class="line"><span class="comment"># disable any healthcheck inherited from the base image</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="bash"> NONE</span></span><br></pre></td></tr></table></figure>
<p>其中 OPTIONS 可以做如下设置：</p>
<ul>
<li><code>--interval=DURATION</code> (default: 30s)</li>
<li><code>--timeout=DURATION</code> (default: 30s)</li>
<li><code>--start-period=DURATION</code> (default: 0s)</li>
<li><code>--retries=N</code> (default: 3)</li>
</ul>
<p>docker 容器的健康状况：</p>
<ul>
<li><code>starting</code>：初始状态。</li>
<li><code>healthy</code>：当有任何一次健康检查通过时</li>
<li><code>unhealthy</code>：当连续 <strong>retries</strong> 次健康检查都失败时</li>
<li><code>failed</code>：单次检查时间超过 <strong>timeout</strong></li>
</ul>
<p>如何写一条 HEALTHCHECK 指令？<br>本质上是执行一条 shell 命令，不同的返回值，表示不同的含义。</p>
<ul>
<li>0：成功</li>
<li>1：失败</li>
<li>2：预留，勿用</li>
</ul>
<p>示例：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">HEALTHCHECK</span><span class="bash"> --interval=5m --timeout=3s \</span></span><br><span class="line"><span class="bash">  CMD curl -f http://localhost/ || <span class="built_in">exit</span> 1</span></span><br></pre></td></tr></table></figure>
<p>针对此容器的健康检查，只检查 80 端口的服务，是否能正常返回。</p>
<p>Reference:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">https://docs.docker.com/develop/develop-images/dockerfile_best-practices/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-07T13:00:00.000Z" title="9/7/2020, 9:00:00 PM">2020-09-07</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:08.075Z" title="2/9/2021, 11:03:08 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Golang/">Golang</a></span><span class="level-item">21 分钟读完 (大约3200个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/07/bcbf447aaf6e.html">Golang面试题库</a></h1><div class="content"><h2 id="Goalng"><a href="#Goalng" class="headerlink" title="Goalng"></a>Goalng</h2><ol>
<li><p><strong>context作用，原理，超时控制</strong><br>golang context的理解，context主要用于父子任务之间的同步取消信号，本质上是一种协程调度的方式。另外在使用context时有两点值得注意：上游任务仅仅使用context通知下游任务不再需要，但不会直接干涉和中断下游任务的执行，由下游任务自行决定后续的处理操作，也就是说context的取消操作是无侵入的；context是线程安全的，因为context本身是不可变的（immutable），因此可以放心地在多个协程中传递使用。</p>
</li>
<li><p><strong>切片和数组区别</strong><br>基础问题。</p>
</li>
<li><p><strong>channel关闭阻塞问题，goroutine如何调度，gopark是怎么回事？PMG模型描述，谁创建的PMG,runtime是怎么个东西，怎么启动第一个goroutine</strong><br>golang CPS并发模型和PMG模型的理解。</p>
</li>
<li><p><strong>go逃逸分析怎么回事，内存什么时候栈分配什么时候堆分配</strong><br>内存方面问题，这个网上很多，自己理解完整正确。</p>
</li>
<li><p><strong>sync.Map实现原理，适用的场景</strong><br>go 1.9 官方提供sync.Map 来优化线程安全的并发读写的map。该实现也是基于内置map关键字来实现的。<br>这个实现类似于一个线程安全的 map[interface{}]interface{} . 这个map的优化主要适用了以下场景：<br>（1）给定key的键值对只写了一次，但是读了很多次，比如在只增长的缓存中；<br>（2）当多个goroutine读取、写入和覆盖的key值不相交时。<br>更进一步，可看sync.Map源码。</p>
</li>
<li><p><strong>go语言有什么优点和缺点</strong><br>优势：容易学习，生产力，并发，动态语法。劣势：包管理，错误处理，缺乏框架。</p>
</li>
<li><p><strong>Go框架用过哪些，有看源码吗</strong><br>优势：beego，go-micro，gin等</p>
</li>
<li><p><strong>Go GC算法，三色标记法描述</strong><br>自己找，网上有</p>
</li>
<li><p><strong>Go内存模型(tcmalloc)</strong><br>tcmalloc是线程缓存的malloc，实现了高效的多线程内存管理，用于替代系统的内存分配相关的函数</p>
</li>
</ol>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><ol>
<li><p>行列都是有序的二维数组，查找k是否存在,时间复杂度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 3 5 7 9</span><br><span class="line"></span><br><span class="line">3 5 7 9 11</span><br><span class="line"></span><br><span class="line">4 6 8 10 12</span><br></pre></td></tr></table></figure>
<p>二分查找：O(log2（max(m,n)))</p>
</li>
<li><p>有序数组，有2N+1个数，其中N个数成对出现，仅1个数单独出现，找出那个单独出现的数.,时间复杂度<br>1，1，2，2，3，4，4，5，5，6，6，7，7<br>答案为3</p>
</li>
<li><p>O(log2（2N))二分查找，查找中间位置的数相等值是在左边还是右边？左边则再左子数组继续查找，右边则在右子数组继续查找。</p>
</li>
<li><p>100亿个数求top100,时间复杂度<br>分组查找或bitmap</p>
</li>
<li><p>100亿个数和100亿个数求交集，时间复杂度<br>全排列问题，自己找去</p>
</li>
<li><p>hash算法实现(类似crc32或者murmur)，保证随机性和均匀性，减少哈希冲突<br>考的是hash算法的了解，需要知道一些经典哈希算法实现。</p>
</li>
<li><p>100个球，一次只能拿2-5个，你先拿，我后拿，怎么保证你能拿到最后一个球<br>一次2-5，去掉先手，最后回合剩余7个即可保证拿到最后一个球。因此，先手拿2个，每一回合保证拿掉球的总数为7，即可。（100-2）/7=14回合。</p>
</li>
<li><p>正整数数组，求和为sum的组合 换零钱，1,5,10元都很充足，给你N元去换零钱，多少种换法<br>算法题给定一个有n个正整数的数组A和一个整数sum,求选择数组A中部分数字和为sum的方案数，动态规划法。</p>
</li>
<li><p>图的最短路径</p>
</li>
</ol>
<h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><ol>
<li><p>Select/epoll，IO多路复用，底层数据结构，epoll的几个函数，两种模式<br>Select/epoll 问题，网上很多</p>
</li>
<li><p>抢占式调度是什么回事<br>进程优先级和时间分片等方面理解</p>
</li>
<li><p>用户态和内核态<br>系统态(内核态)，操作系统在系统态运行——运行操作系统程序<br>用户态(也称为目态)，应用程序只能在用户态运行——运行用户程序</p>
</li>
</ol>
<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><ol>
<li><p>innodb和myisam区别(事务，索引，锁。。。)</p>
</li>
<li><p><strong>B+树和B树区别，优缺点</strong><br>B树每个节点都存储key和data，所有节点组成这棵树，并且叶子节点指针为null。只有叶子节点存储data，叶子节点包含了这棵树的所有键值，叶子节点不存储指针，顺序访问指针，也就是每个叶子节点增加一个指向相邻叶子节点的指针。</p>
</li>
<li><p><strong>B树和二叉查找树或者红黑色区别</strong></p>
</li>
<li><p><strong>聚簇索引什么特点，为什么这样，顺序查询的实现，回表查询，联合索引特性</strong><br>聚簇索引：将数据存储与索引放到了一块，找到索引也就找到了数据<br>非聚簇索引：将数据存储于索引分开结构，索引结构的叶子节点指向了数据的对应行，myisam通过key_buffer把索引先缓存到内存中，当需要访问数据时（通过索引访问数据），在内存中直接搜索索引，然后通过索引找到磁盘相应数据，这也就是为什么索引不在key buffer命中时，速度慢的原因</p>
</li>
<li><p><strong>大表分页查询,10亿行数据，查找第N页数据，怎么优化</strong><br>根据查询的页数和查询的记录数可以算出查询的id的范围，可以使用 id between and 来查询。</p>
</li>
<li><p><strong>悲观锁和乐观锁，mysql相关锁说一下</strong><br>说下概念，其他网上找：<br>乐观锁（ Optimistic Locking）：对加锁持有一种乐观的态度，即先进行业务操作，不到最后一步不进行加锁，”乐观”的认为加锁一定会成功的，在最后一步更新数据的时候再进行加锁。<br>悲观锁（Pessimistic Lock）：悲观锁对数据加锁持有一种悲观的态度。因此，在整个数据处理过程中，将数据处于锁定状态。悲观锁的实现，往往依靠数据库提供的锁机制（也只有数据库层提供的锁机制才能真正保证数据访问的排他性，否则，即使在本系统中实现了加锁机制，也无法保证外部系统不会修改数据）。</p>
</li>
<li><p><strong>如何分库分表</strong><br>1）垂直分表<br>也就是“大表拆小表”，基于列字段进行的。一般是表中的字段较多，将不常用的， 数据较大，长度较长（比如text类型字段）的拆分到“扩展表“。一般是针对那种几百列的大表，也避免查询时，数据量太大造成的“跨页”问题。<br>2）垂直分库<br>垂直分库针对的是一个系统中的不同业务进行拆分，比如用户User一个库，商品Producet一个库，订单Order一个库。切分后，要放在多个服务器上，提高性能。<br>3）水平分库分表<br>将单张表的数据切分到多个服务器上去，每个服务器具有相应的库与表，只是表中数据集合不同。水平分库分表能够有效的缓解单机和单库的性能瓶颈和压力，突破IO、连接数、硬件资源等的瓶颈。</p>
</li>
</ol>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><ol>
<li><p>几种数据结构(list,set,zset,geohash,bitmap)实现原理</p>
</li>
<li><p>pipline用来干嘛<br>pipeline的作用是将一批命令进行打包，然后发送给服务器，服务器执行完按顺序打包返回。</p>
</li>
<li><p>事务<br>redis事务就是一次性、顺序性、排他性的执行一个队列中的一系列命令。　</p>
</li>
<li><p>备份(aof/rdb)原理，哪些参数可调<br>RDB是根据指定的规则定时将内存中的数据备份到硬盘上，AOF是在每次执行命令后命令本身记录下来，所以RDB的备份文件是一个二进制文件，而AOF的备份文件是一个文本文件。至于调参，网上可找。</p>
</li>
<li><p>网络模型<br>redis网络模型，网上找，需要理解。</p>
</li>
<li><p>为什么单线程就能hold住几万qps<br>I/O复用，Reactor 设计模式</p>
</li>
<li><p>热点key怎么处理</p>
</li>
</ol>
<ul>
<li>热key加载到系统内存中，直接从系统内存中取，而不走到redis层。</li>
<li>redis集群，热点备份分布到集群中，避免单台redis集中访问。</li>
</ul>
<ol start="8">
<li><p>一致性hash解决什么问题<br>redis集群和负载均衡</p>
</li>
<li><p>redis集群(主从，高可用，扩展节点)</p>
</li>
</ol>
<h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><ol>
<li><p>消息是否按照时间有序，kafka分区的数据是否有序，如何保证有序<br>不保证按时间有序，主题在单个分区是有序的。</p>
</li>
<li><p>如何保证有序？<br>kafka topic 只设置一个分区，或者producer将消息发送到指定分区</p>
</li>
<li><p>Kafka为什么吞吐量高<br>1）顺序读写<br>kafka的消息是不断追加到文件中的，这个特性使kafka可以充分利用磁盘的顺序读写性能，顺序读写不需要硬盘磁头的寻道时间，只需很少的扇区旋转时间，所以速度远快于随机读写。<br>2）零拷贝<br>利用Linux kernel”零拷贝(zero-copy)”系统调用机制，就是跳过“用户缓冲区”的拷贝，建立一个磁盘空间和内存的直接映射，数据不再复制到“用户态缓冲区”。<br>3）分区<br>kafka中的topic中的内容可以被分为多分区存在，每个分区又分为多个段，所以每次操作都是针对一小部分做操作，很轻便，并且增加并行操作的能力。<br>4）批量发送<br>kafka允许进行批量发送消息，producter发送消息的时候，可以将消息缓存在本地,等到了固定条件发送到kafka等消息条数到固定条数，一段时间发送一次。<br>5）数据压缩<br>Kafka还支持对消息集合进行压缩，Producer可以通过GZIP或Snappy格式对消息集合进行压缩。压缩的好处就是减少传输的数据量，减轻对网络传输的压力</p>
</li>
<li><p>kafka的存储模型</p>
</li>
<li><p>Kafka消费者多个group消费同一个topic,会重复消费吗？</p>
</li>
</ol>
<h2 id="项目问题"><a href="#项目问题" class="headerlink" title="项目问题"></a>项目问题</h2><ol>
<li><p>遇到过内存溢出吗？怎么解决<br>主要了解有没有处理过内存泄漏导致的问题，C/C++定位内存泄漏问题；Golang和JAVA主要与GC的工作机制有关，堆内存一直增长，导致应用内存溢出等。</p>
</li>
<li><p>布隆过滤器怎么设置m,n,k的值，怎么合理安排key(用户和item越来越多，怎么保证内存不会爆)<br>m,n,k 网上有实践经验，可参考。item越来越多的话，进行item的拆分，拆分本质是不要将 Hash(Key) 之后的请求分散在多个节点的多个小 bitmap 上，而是应该拆分成多个小 bitmap 之后，对一个 Key 的所有哈希函数都落在这一个小 bitmap 上。</p>
</li>
<li><p>服务雪崩怎么处理，怎么解决保证不影响线上<br>限流，降级，熔断方面措施，结合后端系统架构阐述，如网关的限流和快速失败。</p>
</li>
<li><p>redis和mysql数据一致性怎么保证<br>重点考虑业务逻辑上写和数据的流程（异常和错误处理等），结合MQ做异步重试处理。</p>
</li>
<li><p>分布式锁应用场景，哪些坑<br>锁过期了，业务还没执行完；分布式锁，redis主从同步的坑；获取到锁后，线程异常。</p>
</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-05T07:27:30.000Z" title="9/5/2020, 3:27:30 PM">2020-09-05</time>发表</span><span class="level-item"><time dateTime="2021-12-31T07:31:15.596Z" title="12/31/2021, 3:31:15 PM">2021-12-31</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></span><span class="level-item">35 分钟读完 (大约5186个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/05/795d32ee2085.html">折腾自建博客系列</a></h1><div class="content">今年年初由 wordpress 迁移到 halo，主要是觉得懂点 Java，有什么定制化的需求，自己改代码会方便一些。但是也没有什么特别的需求需要定制，反而被这种东西折腾得忘记了写博客的初心。技术博客就应该简简单单，只写技术，博客怎么好看、怎么炫酷，都不重要。配置说明&amp;前置条件在 Halo </div><a class="article-more button is-small is-size-7" href="/2020/09/05/795d32ee2085.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-08-20T08:27:30.000Z" title="8/20/2020, 4:27:30 PM">2020-08-20</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:26.827Z" title="2/9/2021, 11:03:26 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Golang/">Golang</a></span><span class="level-item">12 分钟读完 (大约1789个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/08/20/6ec2646852dc.html">0 | Golang：基础构建工具使用</a></h1><div class="content"><p>Golang 里面有一堆看起来很高大上的名词，以及一些自带的工具链。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install golang</span><br></pre></td></tr></table></figure>
<p>安装完之后，有一堆默认的配置信息，可以通过 <code>go env</code> 来进行查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">╰─$ go env</span><br><span class="line">GO111MODULE=&quot;&quot;</span><br><span class="line">GOARCH=&quot;amd64&quot;</span><br><span class="line">GOBIN=&quot;&quot;</span><br><span class="line">GOCACHE=&quot;/Users/akina/Library/Caches/go-build&quot;</span><br><span class="line">GOENV=&quot;/Users/akina/Library/Application Support/go/env&quot;</span><br><span class="line">GOEXE=&quot;&quot;</span><br><span class="line">GOFLAGS=&quot;&quot;</span><br><span class="line">GOHOSTARCH=&quot;amd64&quot;</span><br><span class="line">GOHOSTOS=&quot;darwin&quot;</span><br><span class="line">GOINSECURE=&quot;&quot;</span><br><span class="line">GONOPROXY=&quot;&quot;</span><br><span class="line">GONOSUMDB=&quot;&quot;</span><br><span class="line">GOOS=&quot;darwin&quot;</span><br><span class="line">GOPATH=&quot;/Users/akina/go&quot;</span><br><span class="line">GOPRIVATE=&quot;&quot;</span><br><span class="line">GOPROXY=&quot;https://proxy.golang.org,direct&quot;</span><br><span class="line">GOROOT=&quot;/usr/local/Cellar/go/1.14.6/libexec&quot;</span><br><span class="line">GOSUMDB=&quot;sum.golang.org&quot;</span><br><span class="line">GOTMPDIR=&quot;&quot;</span><br><span class="line">GOTOOLDIR=&quot;/usr/local/Cellar/go/1.14.6/libexec/pkg/tool/darwin_amd64&quot;</span><br><span class="line">GCCGO=&quot;gccgo&quot;</span><br><span class="line">AR=&quot;ar&quot;</span><br><span class="line">CC=&quot;clang&quot;</span><br><span class="line">CXX=&quot;clang++&quot;</span><br><span class="line">CGO_ENABLED=&quot;1&quot;</span><br><span class="line">GOMOD=&quot;&quot;</span><br><span class="line">CGO_CFLAGS=&quot;-g -O2&quot;</span><br><span class="line">CGO_CPPFLAGS=&quot;&quot;</span><br><span class="line">CGO_CXXFLAGS=&quot;-g -O2&quot;</span><br><span class="line">CGO_FFLAGS=&quot;-g -O2&quot;</span><br><span class="line">CGO_LDFLAGS=&quot;-g -O2&quot;</span><br><span class="line">PKG_CONFIG=&quot;pkg-config&quot;</span><br><span class="line">GOGCCFLAGS=&quot;-fPIC -m64 -pthread -fno-caret-diagnostics -Qunused-arguments -fmessage-length=0 -fdebug-prefix-map=/var/folders/km/t6kk56y13ns2yf91lwq58gbh0000gn/T/go-build924722399=/tmp/go-build -gno-record-gcc-switches -fno-common&quot;</span><br></pre></td></tr></table></figure>
<p>其中有几个比较重要的变量，需要注意。</p>
<h2 id="GOROOT"><a href="#GOROOT" class="headerlink" title="GOROOT"></a>GOROOT</h2><p>Golang 的安装目录。本机上的 GOROOT 为：<code>/usr/local/Cellar/go/1.14.6/libexec</code>，它的目录结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">╰─$ tree -L 1 /usr/local/Cellar/go/1.14.6/libexec</span><br><span class="line">/usr/local/Cellar/go/1.14.6/libexec</span><br><span class="line">├── CONTRIBUTING.md</span><br><span class="line">├── CONTRIBUTORS</span><br><span class="line">├── PATENTS</span><br><span class="line">├── SECURITY.md</span><br><span class="line">├── VERSION</span><br><span class="line">├── api</span><br><span class="line">├── bin</span><br><span class="line">├── doc</span><br><span class="line">├── favicon.ico</span><br><span class="line">├── lib</span><br><span class="line">├── misc</span><br><span class="line">├── pkg</span><br><span class="line">├── robots.txt</span><br><span class="line">├── src</span><br><span class="line">└── test</span><br></pre></td></tr></table></figure>

<h2 id="GOPATH"><a href="#GOPATH" class="headerlink" title="GOPATH"></a>GOPATH</h2><p>同样是一个变量，且变量值的内容是一个目录，那 Golang 拿着这个变量来做什么呢？它的作用用文字说明可能比较苍白无力、甚至有点抽象，用亲手实践来看看它到底有什么用处。在本机中，GOPATH 的值（默认值：<code>$HOME/go</code>）为：<code>/Users/akina/go</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">╰─$ tree -L 1 /Users/akina/go</span><br><span class="line">/Users/akina/go</span><br><span class="line">├── bin</span><br><span class="line">├── pkg</span><br><span class="line">└── src</span><br></pre></td></tr></table></figure>
<p>其中会自动生成三个文件夹，它们的作用分别为：</p>
<table>
<thead>
<tr>
<th>文件夹</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>bin</td>
<td>golang 编译可执行文件存放路径，可自动生成。</td>
</tr>
<tr>
<td>pkg</td>
<td>golang编译的.a中间文件存放路径，可自动生成。</td>
</tr>
<tr>
<td>src</td>
<td>源码路径。按照golang默认约定，go run，go install等命令的当前工作路径（即在此路径下执行上述命令）</td>
</tr>
</tbody></table>
<p>暂时将其视为一个普通的目录，拥有三个普通的文件夹。先看后面的 <code>go build</code>、<code>go install</code>、<code>go run</code>。</p>
<h2 id="GOBIN"><a href="#GOBIN" class="headerlink" title="GOBIN"></a>GOBIN</h2><p>go install 编译存放路径。为空时则遵循“约定优于配置”原则，可执行文件放在各自 GOPATH 目录的 bin 文件夹中，即 <code>$GOPATH/bin</code>。</p>
<p>有两种情况下，bin 目录会变得没有意义。</p>
<ul>
<li>当设置了有效的 GOBIN 环境变量以后，bin 目录就变得没有意义。</li>
<li>如果 GOPATH 里面包含多个工作区路径的时候，必须设置 GOBIN 环境变量，否则就无法安装 Go 程序的可执行文件。</li>
</ul>
<h2 id="GOPROXY"><a href="#GOPROXY" class="headerlink" title="GOPROXY"></a>GOPROXY</h2><p>如果遇到下载不下来包的情况，可以考虑尝试设置 GOPROXY 。如下（&gt;=1.13）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go env -w GO111MODULE=on</span><br><span class="line">go env -w GOPROXY=https://goproxy.io,direct</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置不走 proxy 的私有仓库，多个用逗号相隔（可选）</span></span><br><span class="line">go env -w GOPRIVATE=*.corp.example.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置不走 proxy 的私有组织（可选）</span></span><br><span class="line">go env -w GOPRIVATE=example.com/org_name</span><br></pre></td></tr></table></figure>

<h2 id="go-build"><a href="#go-build" class="headerlink" title="go build"></a>go build</h2><p>usage: go build [-o output] [-i] [build flags] [packages]</p>
<blockquote>
<p>Build compiles the packages named by the <strong>import paths</strong>, along with their dependencies, but it does not install the results.</p>
<p>If the arguments to build are a list of .go files from a single directory, build treats them as a list of source files specifying a single package.</p>
<p>When compiling packages, build ignores files that end in ‘_test.go’.</p>
<p>When compiling a single main package, build writes the resulting executable to an output file named after the first source file (‘go build ed.go rx.go’ writes ‘ed’ or ‘ed.exe’) or the source code directory (‘go build unix/sam’ writes ‘sam’ or ‘sam.exe’).</p>
<p>The ‘.exe’ suffix is added when writing a Windows executable.</p>
<p>When compiling multiple packages or a single non-main package, build compiles the packages but discards the resulting object, serving only as a check that the packages can be built.</p>
</blockquote>
<ul>
<li><code>go build</code> 命令默认编译当前目录下的所有 go 文件</li>
<li><code>go build a.go</code> 只编译 a.go 文件<br><img src="/images/pics/5ecb65d7afd25c0e2d2995bc33cc640a.png" alt="缺省编译 &amp; 编译某个文件"><br>如果将编译对象换成不含有 main 函数的代码，没有任何输出<br><img src="/images/pics/61fe093196090faa774fddecf7c0316a.png" alt="编译 non-main 代码"></li>
<li><code>go build IMPORT-PATH</code> 编译在 <code>$GOPATH/src</code> 下面的 <code>IMPORT-PATH</code> 包，并在当前目录 （pwd）下，生成可执行文件（对含有 main 函数的代码来说）<br><img src="/images/pics/daabf112e15b7f1ef3f9b6e4a94c6b08.png" alt="编译 GOPATH 下的包"></li>
</ul>
<h2 id="go-install"><a href="#go-install" class="headerlink" title="go install"></a>go install</h2><p>它在 <code>go build</code> 的基础上，将编译后的<strong>可执行文件</strong>或<strong>中间文件</strong>，移动到 $GOPATH 的 bin 或 pkg 目录下。</p>
<p><img src="/images/pics/94a41681190f4614f58e17c0c81d3556.png" alt="install"></p>
<h2 id="go-run"><a href="#go-run" class="headerlink" title="go run"></a>go run</h2><p>类似于 <code>go build</code>，可以在其它目录，仅指定在 $GOPATH 下的包名，即可运行该包内容；也可以指定一个含有 main 函数的文件。如下：</p>
<p><img src="/images/pics/6b1ca443224dc7ea0be5777676c5fb0c.png" alt="run"></p>
<h2 id="go-get"><a href="#go-get" class="headerlink" title="go get"></a>go get</h2><p>用于从远程代码仓库（比如 Github 等 ）上<strong>下载并安装</strong>代码包。下载源码包的go工具会自动根据不同的域名调用不同的源码工具，对应关系如下：<br>|仓库|源码工具|<br>|——-|——-|<br>|BitBucket|Mercurial Git|<br>|GitHub|Git|<br>|Google Code Project Hosting|Git, Mercurial, Subversion|<br>|Launchpad|Bazaar|</p>
<p>它会把当前的代码包下载到 $GOPATH 中的第一个工作区的 src 目录中，并安装。</p>
<ul>
<li><code>-d</code>：只下载不安装</li>
<li><code>-u</code>：更新已下载的代码包</li>
</ul>
<p><img src="/images/pics/35b1b019be8fd8dbabcbf27ada41e646.png" alt="执行 go get 后所安装的内容"></p>
<p>GoLand 中打开的 terminal 会自动将 $GOPATH/bin 添加到 PATH 变量中，导致在 GoLand 的 terminal 上可以使用通过 go get 安装的命令，在 iTerm2 上面就不行。只要在 .bashrc/.zshrc 中，将 $GOPATH/bin 添加到 PATH 变量中就可以在 iTerm2 中使用。</p>
<h2 id="go-fmt"><a href="#go-fmt" class="headerlink" title="go fmt"></a>go fmt</h2><p>将代码整理成 Golang 风格。</p>
<p>usage: go fmt [-n] [-x] [packages]</p>
<blockquote>
<p>Fmt runs the command ‘gofmt -l -w’ on the packages named by the import paths. It prints the names of the files that are modified.</p>
<p>For more about gofmt, see ‘go doc cmd/gofmt’.<br>For more about specifying packages, see ‘go help packages’.</p>
<p>The -n flag <strong>prints commands that would be executed</strong>.<br>The -x flag <strong>prints commands as they are executed</strong>.</p>
<p>The -mod flag’s value sets which module download mode to use: readonly or vendor. See ‘go help modules’ for more.</p>
<p>To run gofmt with specific options, run gofmt itself.</p>
</blockquote>
<p>go fmt 实际调用的是 <code>gofmt -l -w</code>，而 gofmt 的使用如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">usage: gofmt [flags] [path ...]</span><br><span class="line">  -cpuprofile string</span><br><span class="line">    	write cpu profile to this file</span><br><span class="line">  -d	display diffs instead of rewriting files</span><br><span class="line">  -e	report all errors (not just the first 10 on different lines)</span><br><span class="line">  -l	list files whose formatting differs from gofmt&#x27;s</span><br><span class="line">  -r string</span><br><span class="line">    	rewrite rule (e.g., &#x27;a[b:len(a)] -&gt; a[b:]&#x27;)</span><br><span class="line">  -s	simplify code</span><br><span class="line">  -w	write result to (source) file instead of stdout</span><br></pre></td></tr></table></figure>
<p>gofmt 与 go 在同一级目录，都在 <code>$GOROOT/bin</code> 下：<br><img src="/images/pics/bf67cdf5d11c58a33b8a51fb17fbf8a1.png"><br>看看效果：</p>
<p>初始样式</p>
<p><img src="/images/pics/070bcdbe0948e2f0ae444d3074d49f8c.png" alt="Before go fmt"></p>
<p>执行 go fmt，可以明显看出，代码变整齐了。</p>
<p><img src="/images/pics/c3868946c108b2480ce2610273190b45.png"></p>
<h2 id="go-test"><a href="#go-test" class="headerlink" title="go test"></a>go test</h2><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://halfrost.com/go_command/">https://halfrost.com/go_command/</a></li>
<li><a target="_blank" rel="noopener" href="https://astaxie.gitbooks.io/build-web-application-with-golang/content/zh/01.3.html">https://astaxie.gitbooks.io/build-web-application-with-golang/content/zh/01.3.html</a></li>
<li><a target="_blank" rel="noopener" href="https://goproxy.io/zh/">https://goproxy.io/zh/</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-08-18T06:08:25.000Z" title="8/18/2020, 2:08:25 PM">2020-08-18</time>发表</span><span class="level-item"><time dateTime="2022-04-20T16:35:49.898Z" title="4/21/2022, 12:35:49 AM">2022-04-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Linux/">Linux</a></span><span class="level-item">几秒读完 (大约57个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/08/18/763356a713b2.html">Linux修改hostname和用户名</a></h1><div class="content">ReferenceSSH允许root远程登录Linux：修改HostnameLinux 下如何修改用户名（同时修改用户组名和家目录）</div><a class="article-more button is-small is-size-7" href="/2020/08/18/763356a713b2.html#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-08-16T15:05:41.000Z" title="8/16/2020, 11:05:41 PM">2020-08-16</time>发表</span><span class="level-item"><time dateTime="2021-12-31T07:58:37.786Z" title="12/31/2021, 3:58:37 PM">2021-12-31</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">20 分钟读完 (大约3028个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/08/16/b84b0ed4d8b2.html">1.2 | Kubernetes：容器技术</a></h1><div class="content">此文是一篇大杂烩，记录一些对我很有用处的新知识。主要包括容器相关概念、实现原理、相关标准等。最大的感触就是 Golang 才是云时代的语言，很多容器相关软件的开发语言是用的 Golang。Let's go!什么是容器容器就是将软件打包成标准化单元，以用于开发、交付和部署。简单说就是：容器可以被当做一</div><a class="article-more button is-small is-size-7" href="/2020/08/16/b84b0ed4d8b2.html#more">阅读更多</a></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/7/">上一页</a></div><div class="pagination-next"><a href="/page/9/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/7/">7</a></li><li><a class="pagination-link is-current" href="/page/8/">8</a></li><li><a class="pagination-link" href="/page/9/">9</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/26/">26</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="M系列MacBook连接l2tp时失败的问题修复"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">M系列MacBook连接l2tp时失败的问题修复</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rust学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rust学习笔记</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calico证书学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calico证书学习笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="如何在YAML文件中进行优雅地换行"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">如何在YAML文件中进行优雅地换行</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/25470f32f4bb.html"><img src="/images/pics/kubernetes-cka-color.svg" alt="CKS证书学习资料汇编"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/25470f32f4bb.html">CKS证书学习资料汇编</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a><p class="is-size-7"><span>&copy; 2024 遇寻</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>