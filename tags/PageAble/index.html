<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>标签: PageAble - 遇寻笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="遇寻笔记"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="遇寻笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:type" content="website"><meta property="og:title" content="遇寻笔记"><meta property="og:url" content="https://eucham.me/"><meta property="og:site_name" content="遇寻笔记"><meta property="og:description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/img/og_image.png"><meta property="article:author" content="遇寻"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me"},"headline":"遇寻笔记","image":["https://eucham.me/img/og_image.png"],"author":{"@type":"Person","name":"遇寻"},"publisher":{"@type":"Organization","name":"遇寻笔记","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"No. I&#39;ll bring me back a souvenir."}</script><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">标签</a></li><li class="is-active"><a href="#" aria-current="page">PageAble</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-22T00:28:47.000Z" title="7/22/2019, 8:28:47 AM">2019-07-22</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:34.709Z" title="2/9/2021, 11:03:34 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">22 分钟读完 (大约3371个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/22/10be91c35e3d.html">PageAble分页注解在并发环境下遇到的bug</a></h1><div class="content"><h2 id="数据库结构及数据说明"><a href="#数据库结构及数据说明" class="headerlink" title="数据库结构及数据说明"></a>数据库结构及数据说明</h2><p><strong>结构</strong></p>
<p><img src="/images/pics/070e2763bff41215ff130061df69651f.png" alt="结构"></p>
<p><strong>数据</strong></p>
<p><img src="/images/pics/8840ebe6eeaea53944a5914ba2e2a828.png" alt="数据"></p>
<p><strong>对应类</strong></p>
<p><img src="/images/pics/1b5e6cfda1f976486043e1c50bb9a6bc.png" alt="对应类"></p>
<h2 id="接口详细说明"><a href="#接口详细说明" class="headerlink" title="接口详细说明"></a>接口详细说明</h2><p><strong>获取分页数据接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;get-system-busy&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getPageableUsers</span><span class="params">(<span class="meta">@RequestParam</span> Integer page, <span class="meta">@RequestParam</span> Integer size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> testService.getSystemBusy(page, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PageAble</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemBusy</span><span class="params">(Integer page, Integer size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> testMapper.getSystemBusy();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select gender from user&quot;)</span></span><br><span class="line"><span class="function">List&lt;User&gt; <span class="title">getSystemBusy</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>根据id获取用户详情</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;get-one-user&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getOneUserById</span><span class="params">(<span class="meta">@RequestParam</span> Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> testService.getOneUser(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getOneUser</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> testMapper.getOneUser(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from user where id = #&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function">User <span class="title">getOneUser</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>获取所有司机列表</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;get-all-drivers&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getAllDrivers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> testService.getAllDrivers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getAllDrivers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> testMapper.getAllDrivers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from driver&quot;)</span></span><br><span class="line"><span class="function">List&lt;Driver&gt; <span class="title">getAllDrivers</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>获取所有用户的名字</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;get-username-list&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getUsernameList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> testService.getUsernameList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getUsernameList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;User&gt; users = testMapper.getAllUsers();</span><br><span class="line">    List&lt;String&gt; names = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">        names.add(user.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> names;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from user&quot;)</span></span><br><span class="line"><span class="function">List&lt;User&gt; <span class="title">getAllUsers</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="分页相关文件说明"><a href="#分页相关文件说明" class="headerlink" title="分页相关文件说明"></a>分页相关文件说明</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">base-service</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── com</span><br><span class="line">                └── haylion</span><br><span class="line">                    └── realTimeBus</span><br><span class="line">                        ├── advice</span><br><span class="line">                        │   └── SystemAdvice.java # 分页注解实现</span><br><span class="line">                        ├── annotation</span><br><span class="line">                        │   └── PageAble.java # 分页注解</span><br><span class="line">                        ├── bean</span><br><span class="line">                        │   ├── BaseModel.java # 含有id熟悉的基础bean</span><br><span class="line">                        │   ├── Condition.java # 条件查询时的条件</span><br><span class="line">                        │   ├── ResultPageView.java # 被分页注解标记后，改函数返回的对象，将被包装成该对象(一个普通的bean类)</span><br><span class="line">                        │   └── Sort.java # 查询时排序方式</span><br><span class="line">                        ├── interceptor</span><br><span class="line">                            └── sql</span><br><span class="line">                                ├── MyPageHelper.java # 覆盖afterAll后的PageHelper，在MyPageInterceptor中进行调用</span><br><span class="line">                                ├── MyPageInterceptor.java # PageHelper中拦截器PageInterceptor的源码，有自定义修改</span><br><span class="line">                                └── SqlLogHandler.java # 把将要执行的SQL打印出来，集成在MyPageInterceptor中</span><br></pre></td></tr></table></figure>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个注解主要是对<code>PageHelper</code>插件的封装，这个插件的工作流程可参考：<a target="_blank" rel="noopener" href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/en/HowToUse.md">此链接</a>。</p>
<p>需要做的是在mybatis的配置文件中加入一个拦截器（<a target="_blank" rel="noopener" href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/src/main/java/com/github/pagehelper/PageInterceptor.java">拦截器的源代码链接</a>）。MyBatis在执行query语句时，会触发该拦截器，然后得到的数据是处理过的分页后的数据。</p>
<p>在上述链接中有一个注意事项，如下：</p>
<blockquote>
<p><strong>什么时候会导致不安全的分页？</strong></p>
</blockquote>
<p><code>PageHelper</code> 方法使用了静态的 <code>ThreadLocal</code> 参数，分页参数和线程是绑定的。<br>只要你可以保证在 <code>PageHelper</code> 方法调用后紧跟 MyBatis 查询方法，这就是安全的。因为 <code>PageHelper</code> 在 <code>finally</code> 代码段中自动清除了 <code>ThreadLocal</code> 存储的对象。<br>如果代码在进入 <code>Executor</code> 前发生异常，就会导致线程不可用，这属于人为的 Bug（例如接口方法和 XML 中的不匹配，导致找不到 <code>MappedStatement</code> 时），<br>这种情况由于线程不可用，也不会导致 <code>ThreadLocal</code> 参数被错误的使用。<br>但是如果你写出下面这样的代码，就是不安全的用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PageHelper.startPage(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">List&lt;Country&gt; list;</span><br><span class="line"><span class="keyword">if</span>(param1 != <span class="keyword">null</span>)&#123;</span><br><span class="line">    list = countryMapper.selectIf(param1);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    list = <span class="keyword">new</span> ArrayList&lt;Country&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种情况下由于 param1 存在 null 的情况，就会导致 PageHelper 生产了一个分页参数，但是没有被消费，这个参数就会一直保留在这个线程上。当这个线程再次被使用时，就可能导致不该分页的方法去消费这个分页参数，这就产生了莫名其妙的分页。<br>上面这个代码，应该写成下面这个样子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Country&gt; list;</span><br><span class="line"><span class="keyword">if</span>(param1 != <span class="keyword">null</span>)&#123;</span><br><span class="line">    PageHelper.startPage(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">    list = countryMapper.selectIf(param1);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    list = <span class="keyword">new</span> ArrayList&lt;Country&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种写法就能保证安全。<br>如果你对此不放心，你可以手动清理 <code>ThreadLocal</code> 存储的分页参数，可以像下面这样使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Country&gt; list;</span><br><span class="line"><span class="keyword">if</span>(param1 != <span class="keyword">null</span>)&#123;</span><br><span class="line">    PageHelper.startPage(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        list = countryMapper.selectAll();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        PageHelper.clearPage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    list = <span class="keyword">new</span> ArrayList&lt;Country&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这么写很不好看，而且没有必要。</p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>直接在方法上加上<code>@PageAble</code>注解，并在该方法中传入两个参数，分别为<code>page</code>和<code>size</code>，在该方法返回后，会得到一个<code>ResultPageView</code>封装对象，其中包含分页相关信息。</p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p><img src="/images/pics/145951cdde808632718a5ad9d28e2660.png" alt="流程图"><br> <code>SystemAdvice</code>定义一个切面，切点是<code>@annotation(com.haylion.realTimeBus.annotation.PageAble)</code>。也就是说，每个被<code>@PageAble</code>注解过的方法，都将执行下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PAGE_ABLE = <span class="string">&quot;@annotation(com.haylion.realTimeBus.annotation.PageAble)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Around(PAGE_ABLE)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">doAroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    logger.info(<span class="string">&quot;execute method : &quot;</span> + proceedingJoinPoint.getSignature().getName());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 进入被@PageAble注解的方法前的准备工作</span></span><br><span class="line">        prepare(proceedingJoinPoint);</span><br><span class="line">        <span class="comment">// 执行被@PageAble注解的方法</span></span><br><span class="line">        Object obj = proceedingJoinPoint.proceed();</span><br><span class="line">        <span class="comment">// 执行被@PageAble注解的方法后，执行扫尾工作</span></span><br><span class="line">        Object result = after(obj);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;aspect execute error : &quot;</span>, throwable);</span><br><span class="line">        <span class="keyword">throw</span> throwable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>准备工作</strong>：主要是获取<code>page</code>和<code>size</code>的值，然后调用<code>PageHelper</code>的<code>startPage</code>方法，初始化分页信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PageAble中page和size的默认值分别是1和20</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PageAble &#123;</span><br><span class="line">    <span class="function">String <span class="title">pageSizeName</span><span class="params">()</span> <span class="keyword">default</span> &quot;size&quot;</span>;</span><br><span class="line">    <span class="function">String <span class="title">pageNumName</span><span class="params">()</span> <span class="keyword">default</span> &quot;page&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">pageSize</span><span class="params">()</span> <span class="keyword">default</span> 20</span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">pageNum</span><span class="params">()</span> <span class="keyword">default</span> 1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 准备分页</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Signature signature = point.getSignature();</span><br><span class="line">    MethodSignature methodSignature = (MethodSignature) signature;</span><br><span class="line">    Method targetMethod = methodSignature.getMethod();</span><br><span class="line">    PageAble pageAble = targetMethod.getAnnotation(PageAble.class);</span><br><span class="line">    String numName = pageAble.pageNumName();</span><br><span class="line">    String sizeName = pageAble.pageSizeName();</span><br><span class="line">    <span class="comment">// 先获取默认的page和size值</span></span><br><span class="line">    <span class="keyword">int</span> pageNo = pageAble.pageNum();</span><br><span class="line">    <span class="keyword">int</span> pageSize = pageAble.pageSize();</span><br><span class="line">    Object[] paramValues = point.getArgs();</span><br><span class="line">    String[] paramNames = methodSignature.getParameterNames();</span><br><span class="line">    <span class="keyword">int</span> length = paramNames.length;</span><br><span class="line">    <span class="comment">// 遍历该方法中的所有参数，如果有page和size信息，那么就覆盖默认值为用户传入的值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (paramNames[i].equals(numName)) &#123;</span><br><span class="line">            pageNo = (Integer) paramValues[i];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramNames[i].equals(sizeName)) &#123;</span><br><span class="line">            pageSize = (Integer) paramValues[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 该方法利用ThreadLocal在本线程中插入一个分页信息的对象Page</span></span><br><span class="line">    PageHelper.startPage(pageNo, pageSize);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// startPage()方法的最终实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; <span class="function">Page&lt;E&gt; <span class="title">startPage</span><span class="params">(<span class="keyword">int</span> pageNum, <span class="keyword">int</span> pageSize, <span class="keyword">boolean</span> count, Boolean reasonable, Boolean pageSizeZero)</span> </span>&#123;</span><br><span class="line">    Page&lt;E&gt; page = <span class="keyword">new</span> Page&lt;E&gt;(pageNum, pageSize, count);</span><br><span class="line">    page.setReasonable(reasonable);</span><br><span class="line">    page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    <span class="comment">//当已经执行过orderBy的时候</span></span><br><span class="line">    Page&lt;E&gt; oldPage = getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (oldPage != <span class="keyword">null</span> &amp;&amp; oldPage.isOrderByOnly()) &#123;</span><br><span class="line">      	page.setOrderBy(oldPage.getOrderBy());</span><br><span class="line">    &#125;</span><br><span class="line">    setLocalPage(page);</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setLocalPage</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">  	LOCAL_PAGE.set(page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Page&gt; LOCAL_PAGE = <span class="keyword">new</span> ThreadLocal&lt;Page&gt;();</span><br></pre></td></tr></table></figure>

<p><strong>进入SQL拦截器（即<code>MyPageInterceptor</code>）</strong>：这个拦截器中主要是PageHelper执行分页的步骤，相关步骤可分为：</p>
<ul>
<li><p>判断是否需要进行分页。判断的条件为<code>!dialect.skip(ms, parameter, rowBounds)</code>，其实现为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">skip</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ms.getId().endsWith(MSUtils.COUNT))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;在系统中发现了多个分页插件，请检查系统配置!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Page page = pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//设置默认的 count 列</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtil.isEmpty(page.getCountColumn()))&#123;</span><br><span class="line">            page.setCountColumn(pageParams.getCountColumn());</span><br><span class="line">        &#125;</span><br><span class="line">        autoDialect.initDelegateDialect(ms);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，通过判断<code>Page</code>是否为空来决定是否进行分页，<code>Page</code>则从本线程中获取，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PageHelper.java</span></span><br><span class="line">Page page = pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line"></span><br><span class="line"><span class="comment">//PageParams.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page <span class="title">getPage</span><span class="params">(Object parameterObject, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">		Page page = PageHelper.getLocalPage();</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PageMethod.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Page&lt;T&gt; <span class="title">getLocalPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> LOCAL_PAGE.get();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Page&gt; LOCAL_PAGE = <span class="keyword">new</span> ThreadLocal&lt;Page&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取数据的总条数。在进入此项前，会进行判断是否需要进行总数查询。这里假设进行总数查询。从源SQL解析出获取数据总条数的代码调试如下：</p>
<p><img src="/images/pics/3ae925cf7c0ded7f9b2fe84c482cd58e.png" alt="调试"></p>
<p>log如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2019-06-14 09:37:31.475 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &#x3D;&#x3D;&gt;  Preparing: SELECT count(0) FROM advertising </span><br><span class="line">2019-06-14 09:37:31.490 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &#x3D;&#x3D;&gt; Parameters: </span><br><span class="line">2019-06-14 09:37:31.507 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">2019-06-14 09:37:31.508  INFO [http-nio-8880-exec-1] c.h.r.i.s.SqlLogHandler - com.haylion.realTimeBus.dao.AdvertisingMapper.getByConditionList_COUNT:</span><br><span class="line">select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising</span><br><span class="line">&lt;cost time is :45 ms &gt;</span><br><span class="line">2019-06-14 09:37:31.512 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &#x3D;&#x3D;&gt;  Preparing: select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising LIMIT ? </span><br><span class="line">2019-06-14 09:37:31.512 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">2019-06-14 09:37:31.519 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">2019-06-14 09:37:31.520  INFO [http-nio-8880-exec-1] c.h.r.i.s.SqlLogHandler - com.haylion.realTimeBus.dao.AdvertisingMapper.getByConditionList:</span><br><span class="line">select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising LIMIT 1 </span><br><span class="line">&lt;cost time is :8 ms &gt;</span><br><span class="line">2019-06-14 09:37:31.591  INFO [http-nio-8880-exec-1] c.h.r.f.a.ResponseAdvice - Trace log is &#x3D;&#x3D;&#x3D;&#x3D;&gt;  &#123;&quot;url&quot;:&quot;&#x2F;advertising&#x2F;getAdvertisingList&quot;,&quot;httpMethod&quot;:&quot;GET&quot;,&quot;reqHeader&quot;:&#123;&quot;host&quot;:&quot;192.168.12.39:8880&quot;,&quot;content-type&quot;:&quot;application&#x2F;json&quot;,&quot;user-agent&quot;:&quot;curl&#x2F;7.54.0&quot;,&quot;accept&quot;:&quot;*&#x2F;*&quot;,&quot;token&quot;:&quot;fe20027352f8250571436f471a988b4d&quot;&#125;,&quot;reqParams&quot;:&quot;page&#x3D;1&amp;size&#x3D;1&quot;,&quot;requestBody&quot;:&quot;&quot;,&quot;respParams&quot;:&quot;&#123;\&quot;code\&quot;:200,\&quot;message\&quot;:\&quot;success\&quot;,\&quot;data\&quot;:&#123;\&quot;total\&quot;:9,\&quot;current\&quot;:1,\&quot;pageCount\&quot;:9,\&quot;list\&quot;:[&#123;\&quot;settlementType\&quot;:0,\&quot;imagesUrl\&quot;:\&quot;xxxxxxx\&quot;,\&quot;advertisingName\&quot;:\&quot;hello kitty 111\&quot;,\&quot;advertiserName\&quot;:\&quot;暁\&quot;,\&quot;advertiserId\&quot;:0,\&quot;createTimeymdhm_Str\&quot;:\&quot;2019-06-10 17:27\&quot;,\&quot;advertisingType\&quot;:0,\&quot;createTime\&quot;:1560158854000,\&quot;advertisingPosition\&quot;:0,\&quot;auditStatus\&quot;:4,\&quot;createUser\&quot;:1,\&quot;id\&quot;:0,\&quot;advertiserUrl\&quot;:\&quot;xxxxx\&quot;,\&quot;createTimeStr\&quot;:\&quot;2019-06-10 17:27:34\&quot;&#125;]&#125;&#125;&quot;,&quot;startTime&quot;:1560476250978,&quot;spendTime&quot;:592&#125;</span><br></pre></td></tr></table></figure>

<p>获取完总数后，会进行判断是否有分页的必要。</p>
</li>
<li><p>分页查询。这里假设有分页的必要。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用方言获取分页 sql</span></span><br><span class="line">String pageSql = dialect.getPageSql(ms, boundSql, parameter, rowBounds, pageKey);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPageSql</span><span class="params">(MappedStatement ms, BoundSql boundSql, Object parameterObject, RowBounds rowBounds, CacheKey pageKey)</span> </span>&#123;</span><br><span class="line">    String sql = boundSql.getSql();</span><br><span class="line">    Page page = getLocalPage();</span><br><span class="line">    <span class="comment">//支持 order by</span></span><br><span class="line">    String orderBy = page.getOrderBy();</span><br><span class="line">    <span class="keyword">if</span> (StringUtil.isNotEmpty(orderBy)) &#123;</span><br><span class="line">        pageKey.update(orderBy);</span><br><span class="line">        sql = OrderByParser.converToOrderBySql(sql, orderBy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (page.isOrderByOnly()) &#123;</span><br><span class="line">      	<span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// 这是一个抽象方法，会根据具体的数据库，调用不同的实现方法，来在原SQL语句上，加上对应的分页语句</span></span><br><span class="line">    <span class="keyword">return</span> getPageSql(sql, page, pageKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体支持的数据库如下：</p>
<p><img src="/images/pics/468ac30f9649c89d1fcd520080c4db7d.png"></p>
<p>Oracle的分页实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPageSql</span><span class="params">(String sql, Page page, CacheKey pageKey)</span> </span>&#123;</span><br><span class="line">    StringBuilder sqlBuilder = <span class="keyword">new</span> StringBuilder(sql.length() + <span class="number">120</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot;SELECT * FROM ( &quot;</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; SELECT TMP_PAGE.*, ROWNUM ROW_ID FROM ( &quot;</span>);</span><br><span class="line">    sqlBuilder.append(sql);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; ) TMP_PAGE WHERE ROWNUM &lt;= ? &quot;</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; ) WHERE ROW_ID &gt; ? &quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> sqlBuilder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MySQL的分页实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPageSql</span><span class="params">(String sql, Page page, CacheKey pageKey)</span> </span>&#123;</span><br><span class="line">    StringBuilder sqlBuilder = <span class="keyword">new</span> StringBuilder(sql.length() + <span class="number">14</span>);</span><br><span class="line">    sqlBuilder.append(sql);</span><br><span class="line">    <span class="keyword">if</span> (page.getStartRow() == <span class="number">0</span>) &#123;</span><br><span class="line">      	sqlBuilder.append(<span class="string">&quot; LIMIT ? &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	sqlBuilder.append(<span class="string">&quot; LIMIT ?, ? &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    pageKey.update(page.getPageSize());</span><br><span class="line">    <span class="keyword">return</span> sqlBuilder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>保存分页查询后的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// resultList是分页查询后的数据列表</span></span><br><span class="line"><span class="comment">// afterPage的返回值是有两种情况，但是都可以被转成List</span></span><br><span class="line"><span class="keyword">return</span> dialect.afterPage(resultList, parameter, rowBounds);</span><br><span class="line"></span><br><span class="line"><span class="comment">// dialect.afterPage()方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">afterPage</span><span class="params">(List pageList, Object parameterObject, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这个方法即使不分页也会被执行，所以要判断 null</span></span><br><span class="line">    AbstractHelperDialect delegate = autoDialect.getDelegate();</span><br><span class="line">    <span class="keyword">if</span>(delegate != <span class="keyword">null</span>)&#123;</span><br><span class="line">      	<span class="keyword">return</span> delegate.afterPage(pageList, parameterObject, rowBounds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pageList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// delegate.afterPage()方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">afterPage</span><span class="params">(List pageList, Object parameterObject, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">    Page page = getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="keyword">null</span>) &#123;</span><br><span class="line">      	<span class="keyword">return</span> pageList;</span><br><span class="line">    &#125;</span><br><span class="line">    page.addAll(pageList);</span><br><span class="line">    <span class="keyword">if</span> (!page.isCount()) &#123;</span><br><span class="line">      	page.setTotal(-<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((page.getPageSizeZero() != <span class="keyword">null</span> &amp;&amp; page.getPageSizeZero()) &amp;&amp; page.getPageSize() == <span class="number">0</span>) &#123;</span><br><span class="line">      	page.setTotal(pageList.size());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(page.isOrderByOnly())&#123;</span><br><span class="line">      	page.setTotal(pageList.size());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这里有一个问题是，如果delegate不为空，那么返回的是<code>Page</code>，但是我们在调用<code>xxxxxMapper</code>的查询方法之后，返回值基本上是<code>List</code>，与我们的常识并不符合。那<code>Page</code>是什么呢？它不只是包含分页信息的基本类，它继承自ArrayList。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Page</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在return后，还会执行finally中的处理代码，即<code>com.haylion.realTimeBus.interceptor.sql.MyPageHelper</code>的<code>afterAll()</code>方法。其中实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.haylion.realTimeBus.interceptor.sql.MyPageHelper.afterAll()</span></span><br><span class="line"><span class="comment">// 这个方法是我们自定义的方法，用来处理执行完前面所述的切点后，保留分页信息，进行再次封装</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Page&lt;Object&gt; localPage = getLocalPage();</span><br><span class="line">  	<span class="comment">// 删除分页信息</span></span><br><span class="line">    <span class="keyword">super</span>.afterAll();</span><br><span class="line">  	<span class="comment">// 设置回本线程中</span></span><br><span class="line">    setLocalPage(localPage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// super.afterAll()。这个方法可以简单理解成，清楚掉本线程中的分页信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这个方法即使不分页也会被执行，所以要判断 null</span></span><br><span class="line">    AbstractHelperDialect delegate = autoDialect.getDelegate();</span><br><span class="line">    <span class="keyword">if</span> (delegate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        delegate.afterAll();</span><br><span class="line">        autoDialect.clearDelegate();</span><br><span class="line">    &#125;</span><br><span class="line">    clearPage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除本地变量</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clearPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	LOCAL_PAGE.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过上述的过程，<code>MyPageInterceptor</code>执行完毕，分页信息存储在本线程中，然后回到切面处理。</p>
</li>
</ul>
<p><strong>切面收尾工作（回到<code>SystemAdvice</code>）</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">after</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    PageInfo&lt;?&gt; pageInfo;</span><br><span class="line">    Page&lt;Object&gt; localPage = PageHelper.getLocalPage();</span><br><span class="line">    <span class="keyword">long</span> total = localPage.getTotal();</span><br><span class="line">    <span class="keyword">int</span> pageNum = localPage.getPageNum();</span><br><span class="line">    <span class="keyword">int</span> pages = localPage.getPages();</span><br><span class="line">    List&lt;?&gt; list = (List&lt;?&gt;) obj;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">    pageInfo = <span class="keyword">new</span> PageInfo((list));</span><br><span class="line">    ResultPageView&lt;?&gt; resultPageView = <span class="keyword">new</span> ResultPageView&lt;&gt;(total, pageNum, pages, pageInfo.getList());</span><br><span class="line">    <span class="keyword">return</span> resultPageView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，备注解方法将返回<code>ResultPageView</code>对象，经过包装后，也就是我们常看到的分页格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">17</span>,</span><br><span class="line">        <span class="attr">&quot;current&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;pageCount&quot;</span>: <span class="number">9</span>,</span><br><span class="line">        <span class="attr">&quot;list&quot;</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="局限"><a href="#局限" class="headerlink" title="局限"></a>局限</h2><p>这就限定了在一个被<code>PageAble</code>注解了的方法上，只能执行一条查询。如果对于一个到来的请求，需要进行两次或以上的查询，并且某一条查询需要分页的情况，如果所有的查询都放在被<code>PageAble</code>注解的方法下，执行会出现问题（出现不必要的分页操作）。但是可以通过组装的形式，完成该项需求。</p>
<h2 id="bug说明"><a href="#bug说明" class="headerlink" title="bug说明"></a>bug说明</h2><ol>
<li><p>当一条线程，执行被PageAble注解过的方法时，线程中会保存Page信息。</p>
</li>
<li><p>如果切面没有执行完，会导致Page在处理完改请求后，继续留存在该线程中。<br><img src="/images/pics/b33b76b87aa31b8d97ffb13b8f2d4a3c.png"></p>
</li>
<li><p>当一条含有Page对象的线程，处理某个不分页、但需进行查询的请求时，会导致该查询进行分页，并且会将<strong>Page对象中的之前查询得到的数据</strong>一并返回。<br><img src="/images/pics/0178784fa6d228f45b6e01899a9fb754.png"></p>
</li>
</ol>
<h2 id="四个请求的各自功能"><a href="#四个请求的各自功能" class="headerlink" title="四个请求的各自功能"></a>四个请求的各自功能</h2><ol>
<li><p>在线程中留下分页标志。 <code>curl -s localhost:8880/test/get-system-busy\?page=1\&amp;size=2 | jq --indent 4</code></p>
</li>
<li><p>在分页后的数据列表中，加入数据。<code>curl -s localhost:8880/test/get-all-drivers | jq --indent 4</code></p>
</li>
<li><p>出错情况1：TooManyResultsException。<code>curl -s localhost:8880/test/get-one-user\?id=1 | jq --indent 4</code></p>
</li>
<li><p>出错情况2 &amp; 3：ClassCastException &amp; 数据累积。<code>curl -s localhost:8880/test/get-username-list | jq --indent 4</code></p>
</li>
</ol>
<h2 id="PPT内容"><a href="#PPT内容" class="headerlink" title="PPT内容"></a>PPT内容</h2><p>略</p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="M系列MacBook连接l2tp时失败的问题修复"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">M系列MacBook连接l2tp时失败的问题修复</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rust学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rust学习笔记</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calico证书学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calico证书学习笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="如何在YAML文件中进行优雅地换行"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">如何在YAML文件中进行优雅地换行</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/25470f32f4bb.html"><img src="/images/pics/kubernetes-cka-color.svg" alt="CKS证书学习资料汇编"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/25470f32f4bb.html">CKS证书学习资料汇编</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a><p class="is-size-7"><span>&copy; 2024 遇寻</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>