<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>标签: CKA - 遇寻笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="遇寻笔记"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="遇寻笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:type" content="website"><meta property="og:title" content="遇寻笔记"><meta property="og:url" content="https://eucham.me/"><meta property="og:site_name" content="遇寻笔记"><meta property="og:description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/img/og_image.png"><meta property="article:author" content="遇寻"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me"},"headline":"遇寻笔记","image":["https://eucham.me/img/og_image.png"],"author":{"@type":"Person","name":"遇寻"},"publisher":{"@type":"Organization","name":"遇寻笔记","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"No. I&#39;ll bring me back a souvenir."}</script><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">标签</a></li><li class="is-active"><a href="#" aria-current="page">CKA</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>发表</span><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">1 小时读完 (大约11730个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/12/09/25470f32f4bb.html">CKS证书学习资料汇编</a></h1><div class="content"><h1 id="真题①基于1-22版本"><a href="#真题①基于1-22版本" class="headerlink" title="真题①基于1.22版本"></a>真题①基于1.22版本</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>CKA 和 CKS 是 LINUX 基金会联合 CNCF社区组织的云原生技术领域权威认证，考试采用实操方式进行。CKS全称是Kubernetes安全专家认证，它在一个模拟真实的环境中测试考生对Kubernetes和云安全的知识。在参加CKS考试之前，必须已经通过CKA(Kubernetes管理员认证)，在获得CKA认证之后才可以预约CKS考试。CKS 的考试难度相对于 CKA 提高了很多，2个小时的考试时间很紧张，因为考试是在外网上进行，这两个考试又是实操考试，网络条件不好，很影响效率，如果不抓紧的话，很可能做不完所有实操题。提醒备考的同学善用考试软件提供的 notepad 功能，先把 yaml 文件或命令写到notepad里，再粘贴到 terminal里。</p>
<p>我因为上次 CKA 考试还是比较顺利，94 高分通过，所以这次的 CKS 考试有点疏忽了，搞忘带身份证和护照，CKA/CKS 考试需要身份证+护照/信用卡，因此跟监考老师沟通了很久时间，最后修改了考试人姓名为中文，是用驾驶证完成的考试。意外之喜是 CKS 给我的证书是中文名的。</p>
<p>我这次考试的 kubernetes 版本是 1.22，特意记录了一下考试会考到的知识点，分享给需要的同学。</p>
<h2 id="1-NetworkPolicy"><a href="#1-NetworkPolicy" class="headerlink" title="1. NetworkPolicy"></a>1. NetworkPolicy</h2><p>通常使用标签选择器来选择pod，控制流量。所以要对 kubectl label的使用方法熟悉起来。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label [--<span class="type">overwrite</span>] (<span class="operator">-f</span> FILENAME | <span class="built_in">TYPE</span> NAME) KEY_1=VAL_1 ... KEY_N=VAL_N </span><br><span class="line">  [--<span class="type">resource</span>-<span class="type">version</span>=<span class="type">version</span>] [<span class="type">options</span>]</span><br></pre></td></tr></table></figure>

<p>网络策略的实用方法见注释</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># podSelector: &#123;&#125; 表示选择所有 pod 应用 NetworkPolicy</span></span><br><span class="line">  <span class="attr">podSelector:</span> <span class="comment"># 表示选择包含标签 role=db 的 pod 应用下面的 NetworkPolicy</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">policyTypes:</span> <span class="comment"># 表示 NetworkPolicy 包含 ingress 和 egress 流量规则</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">ingress:</span> <span class="comment"># ingress 规则白名单列表，每条规则允许同时匹配 from 和 ports  流，可以有条个规则。</span></span><br><span class="line">  <span class="comment"># 第1条白名单，允许以下pod访问（限 tcp 6379 端口），包含 </span></span><br><span class="line">  <span class="comment"># 1. from + ports 的组合规则，允许来自172.17网段(172.17.1除外)；</span></span><br><span class="line">  <span class="comment"># 2. 标签 project=myproject 的命名空间的所有 pod；</span></span><br><span class="line">  <span class="comment"># 3. default 命名空间下标签 role=frontend 的 pod；</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">        <span class="attr">except:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">172.17</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">project:</span> <span class="string">myproject</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">role:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="comment"># 第二条白名单，只包含 from 规则，允许</span></span><br><span class="line">  <span class="comment"># 1. 来自所有命名空间包含 environment=testing 标签的 pod 访问（不限端口）</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="string">testing</span></span><br><span class="line">  <span class="attr">egress:</span> <span class="comment"># egress 规则白名单列表，同 ingress 规则一样，每条规则包含 to+ports，可以有多条规则。</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5978</span></span><br></pre></td></tr></table></figure>

<h2 id="2-Apparmor"><a href="#2-Apparmor" class="headerlink" title="2. Apparmor"></a>2. Apparmor</h2><p>查看当前节点加载的 apparmor profile ，如果没有加载，要手工加载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apparmor_status | grep nginx</span><br><span class="line">apparmor_parser /etc/apparmor.d/nginx_apparmor</span><br></pre></td></tr></table></figure>

<p>cks 考试的 apparmor profile 文件内容：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tunables/global&gt;</span></span></span><br><span class="line"><span class="meta">#nginx-profile-3  </span></span><br><span class="line">profile nginx-profile<span class="number">-3</span> flags=(attach_disconnected) &#123;</span><br><span class="line">  <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;abstractions/base&gt;</span></span></span><br><span class="line">  file,</span><br><span class="line">  # Deny all file writes.</span><br><span class="line">  deny <span class="comment">/** w,</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure>

<p>注意： nginx-profile-3 这一行要确保注释掉，考试环境提供的可能没有注释，加载配置文件按时会报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@node01:~# apparmor_parser /etc/apparmor.d/nginx_apparmor</span><br><span class="line">AppArmor parser error <span class="keyword">for</span> /etc/apparmor.d/nginx_apparmor <span class="keyword">in</span> /etc/apparmor.d/ninx_apparmor at line 2: Found unexpected character: <span class="string">&#x27;-&#x27;</span></span><br></pre></td></tr></table></figure>

<p>修改 pod yaml 文件，在注释里设置为 podx 加载 apparmor profile</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">container.apparmor.security.beta.kubernetes.io/podx:</span> <span class="string">localhost/nginx-profile-3</span></span><br></pre></td></tr></table></figure>

<p>yaml 文件内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">container.apparmor.security.beta.kubernetes.io/podx:</span> <span class="string">localhost/nginx-profile-3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podx</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo &#x27;Hello AppArmor!&#x27; &amp;&amp; sleep 1h&quot;</span> ]</span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node01</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<h2 id="3-修复kube-bench发现的安全问题"><a href="#3-修复kube-bench发现的安全问题" class="headerlink" title="3. 修复kube-bench发现的安全问题"></a>3. 修复kube-bench发现的安全问题</h2><p>kube-bench 是一个 CIS 评估工具，扫描 kubernetes 集群存在的安全问题，基本上按照 扫描结果的修复建议进行修复就可以了，系统会给出很具体的修复措施。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修复 kube-apiserver 安全问题</span></span><br><span class="line"><span class="string">vi</span> <span class="string">/etc/kubernetes/manifests/kube-apiserver</span></span><br><span class="line"><span class="comment">#修改：</span></span><br><span class="line"><span class="string">--authorization-mode=Node,RBAC</span></span><br><span class="line"><span class="comment">#添加</span></span><br><span class="line"><span class="string">--insecure-port=0</span></span><br><span class="line"><span class="comment">#删除</span></span><br><span class="line"><span class="comment"># --insecure-bind-address=0.0.0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修复 kubelet 安全问题</span></span><br><span class="line"><span class="string">vi</span> <span class="string">/var/lib/kubelet/config.yaml</span></span><br><span class="line"><span class="comment"># 将authentication.anonymous.enabled 设置为 false</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line">  <span class="attr">anonymous:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># authorization.mode 设置为 Webhook</span></span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">Webhook</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 修复 etcd 安全问题</span></span><br><span class="line"><span class="string">vi</span> <span class="string">/etc/kubernetes/manifests/etcd.yaml</span></span><br><span class="line"><span class="comment"># 修改为true：</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--client-cert-auth=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以上修复完成后 重新加载配置文件并重启kubelet</span></span><br><span class="line"></span><br><span class="line"><span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">restart</span> <span class="string">kubelet</span></span><br></pre></td></tr></table></figure>

<h2 id="4-解决-pod-的-serviceaccount-设置错误问题"><a href="#4-解决-pod-的-serviceaccount-设置错误问题" class="headerlink" title="4. 解决 pod 的 serviceaccount 设置错误问题"></a>4. 解决 pod 的 serviceaccount 设置错误问题</h2><p>这个题要注意 serviceaccount 有个选项 automountServiceAccountToken, 这个选项决定是否自动挂载 secret 到 pod。<br>有这个选项，我们可以控制 pod 创建并绑定 serviceaccount 时，不自动挂载对应的 secret，这样 pod 就没有权限访问 apiserver，提高了业务 pod 的安全性。</p>
<p>可以在 serviceaccount 和 pod 的 spec 里设置，pod的设置优先于 serviceaccount 里的设置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backend-sa</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">qa</span> </span><br><span class="line"><span class="attr">automountServiceAccountToken:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">qa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">backend-sa</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.9</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">backend</span></span><br></pre></td></tr></table></figure>

<p>删除未使用的 serviceaccount</p>
<h2 id="5-设置默认网络策略"><a href="#5-设置默认网络策略" class="headerlink" title="5. 设置默认网络策略"></a>5. 设置默认网络策略</h2><p>这道题是送分题，设置默认拒绝所有出站和入站的 pod 流量，基本上可以参考官网的案例直接改一下名字就可以了<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#%E9%BB%98%E8%AE%A4%E6%8B%92%E7%BB%9D%E6%89%80%E6%9C%89%E5%85%A5%E5%8F%A3%E5%92%8C%E6%89%80%E6%9C%89%E5%87%BA%E7%AB%99%E6%B5%81%E9%87%8F">默认网络策略</a></p>
<h2 id="6-RBAC"><a href="#6-RBAC" class="headerlink" title="6. RBAC"></a>6. RBAC</h2><p>这道题也基本是送分题，参考官网文档，根据题目要求，设置 role 的 资源访问权限，绑定到 serviceaccount 就可以了。<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#role-and-clusterole">RBAC</a></p>
<h2 id="7-日志审计"><a href="#7-日志审计" class="headerlink" title="7. 日志审计"></a>7. 日志审计</h2><p>这道题稍复杂，需要按照要求启动日志审计，包括两个步骤：<br>(1) 编写日志审计策略文件<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#audit-policy">日志审计策略</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">omitStages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">RequestResponse</span>   </span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;namespaces&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>] </span><br><span class="line">    <span class="attr">namespaces:</span> [<span class="string">&quot;front-apps&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>, <span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">    <span class="attr">omitStages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span></span><br></pre></td></tr></table></figure>

<p>(2) 修改 kube-apiserver.yaml配置文件，启用日志审计策略，日志策略配置文件位置、日志文件存储位置、循环周期。<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#log-%E5%90%8E%E7%AB%AF">启动日志配置</a></p>
<p>vi /etc/kubernetes/manifests/kube-apiserver.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置日志审计策略文件在 pod 里的 mount 位置</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--audit-policy-file=/etc/kubernetes/logpolicy/sample-policy.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置日志文件存储位置</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--audit-log-path=/var/log/kubernetes/audit-logs.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置日志文件循环</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--audit-log-maxage=10</span>    </span><br><span class="line"><span class="bullet">-</span> <span class="string">--audit-log-maxbackup=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mount 日志策略和日志文件的</span></span><br><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/logpolicy/sample-policy.yaml</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">audit</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/kubernetes/audit-logs.txt</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">audit-log</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">audit</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/logpolicy/sample-policy.yaml</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">File</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">audit-log</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/log/kubernetes/audit-logs.txt</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br></pre></td></tr></table></figure>

<p>重启 kubelet</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h2 id="8-创建-secret"><a href="#8-创建-secret" class="headerlink" title="8. 创建 secret"></a>8. 创建 secret</h2><p>这道题考解码 secret 的 base64 编码信息，创建新的 secret 并 mount 到 pod 的特定位置。<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret">解码 secret</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets -n istio-system db1-test -o jsonpath=&#123;.<span class="property">data</span>.<span class="property">username</span>&#125; | base64 -d &gt;  <span class="regexp">/cks/</span>sec/user.<span class="property">txt</span></span><br><span class="line">kubectl get secrets -n istio-system db1-test -o jsonpath=&#123;.<span class="property">data</span>.<span class="property">password</span>&#125; | base64 -d &gt;  <span class="regexp">/cks/</span>sec/pass.<span class="property">txt</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#create-a-secret">创建secret</a></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="keyword">create</span> secret generic db2<span class="operator">-</span>test <span class="operator">-</span>n istio<span class="operator">-</span><span class="keyword">system</span> <span class="comment">--from-literal=username=production-instance --from-literal=password=KvLftKgs4aVH</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets">使用secret</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/secret</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">db2-test</span></span><br></pre></td></tr></table></figure>

<h2 id="9-检测-dockerfile-的不安全指令"><a href="#9-检测-dockerfile-的不安全指令" class="headerlink" title="9. 检测 dockerfile 的不安全指令"></a>9. 检测 dockerfile 的不安全指令</h2><p>这道题也是送分题，主要是把 dockerfile里两个 使用了 root 用户的指令删除，把添加特定能力的 securityContext 安全上下文注释掉。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除两处</span></span><br><span class="line">USER root</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注释 securityContext</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">securityContext:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  &#123;<span class="string">&quot;Capabilities&quot;</span>: &#123;<span class="string">&#x27;add&#x27;</span>:&#123;NET_BIND_SERVICE&#125;, <span class="string">&#x27;drop: []&#x27;</span>&#125;, <span class="string">&#x27;privileged&#x27;</span>: TRUE&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="10-运行沙箱容器"><a href="#10-运行沙箱容器" class="headerlink" title="10. 运行沙箱容器"></a>10. 运行沙箱容器</h2><p>给出了 支持安全沙箱容器运行时 handler <code>runsc</code>， 我们需要创建一个 RuntimeClass 并在 pod spec里指定是用该 RuntimeClass<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/containers/runtime-class/#2-%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%BA%94%E7%9A%84-runtimeclass-%E8%B5%84%E6%BA%90">参考资料</a></p>
<ul>
<li>创建 RuntimeClass</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">untrusted</span> </span><br><span class="line"><span class="attr">handler:</span> <span class="string">runsc</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改 server 命名空间 所有 pod，设置 runtimeClassName</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">注意：运行中的 pod 只能修改有限的几个属性，不支持修改 RuntimeClass，需要将所有 pod 的 yaml 解析出来，修改 yaml 后，再重新创建 pod</span><br><span class="line">还需要修改deployment</span><br><span class="line">    spec:。</span><br><span class="line">      runtimeClassName: untrusted </span><br><span class="line">      containers:</span><br><span class="line">      - image: vicuu/nginx:host</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: nginx-host</span><br></pre></td></tr></table></figure>

<h2 id="11-删除-不符合最佳实践的-pod"><a href="#11-删除-不符合最佳实践的-pod" class="headerlink" title="11. 删除 不符合最佳实践的 pod"></a>11. 删除 不符合最佳实践的 pod</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">参考链接</a></p>
<ul>
<li>删除启用了特权的 pod<br>主要是检查 pod 是否含 privileged: true<br>kubectl get po xxx -n production -o yaml| grep -i “privileged: true”</li>
<li>删除有状态 pod<br>kubectl get pods XXXX -n production -o jsonpath={.spec.volumes} | jq</li>
</ul>
<h2 id="12-扫描镜像安全漏洞并删除使用有安全漏洞镜像的pod"><a href="#12-扫描镜像安全漏洞并删除使用有安全漏洞镜像的pod" class="headerlink" title="12. 扫描镜像安全漏洞并删除使用有安全漏洞镜像的pod"></a>12. 扫描镜像安全漏洞并删除使用有安全漏洞镜像的pod</h2><p>这道题考察对于镜像扫描工具 trivy 的使用</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 获取镜像名</span></span><br><span class="line">kubect <span class="keyword">get</span> pod XXXX -n kamino -o yaml | grep image</span><br><span class="line"><span class="meta"># 扫描镜像</span></span><br><span class="line">trivy image -s HIGH,CRITICAL imagename</span><br><span class="line"><span class="meta"># kubectl delete po xxx</span></span><br></pre></td></tr></table></figure>

<h2 id="13-使用-sysdig-检查容器里里的异常进程"><a href="#13-使用-sysdig-检查容器里里的异常进程" class="headerlink" title="13. 使用 sysdig 检查容器里里的异常进程"></a>13. 使用 sysdig 检查容器里里的异常进程</h2><p>本体考察是否掌握 sysdig 的基本用法，记住两个帮助命令：</p>
<ul>
<li>sysdig -h 查看 sysdig 帮助</li>
<li>sysdig -l 查看 sysdig 支持的元数据</li>
</ul>
<p>另外 sysdig 支持指定 containerid 分析特定容器</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容器id</span></span><br><span class="line">docker ps |<span class="keyword">grep</span> tomcat</span><br><span class="line">sysdig -M <span class="number">30</span> -p <span class="string">&quot;*<span class="variable">%evt</span>.time,<span class="variable">%user</span>.uid,<span class="variable">%proc</span>.name&quot;</span> container.id=xxxx&gt;opt/DFA/incidents/summary</span><br></pre></td></tr></table></figure>

<h2 id="14-PodSecurityPolicy"><a href="#14-PodSecurityPolicy" class="headerlink" title="14. PodSecurityPolicy"></a>14. PodSecurityPolicy</h2><p>这道题考察是否掌握 psp 的用法，包括5步骤<br>(1) 创建 psp<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#example">参考链接</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">restrict-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span> </span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>(2) 创建 clusterrole，使用 psp</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrole <span class="keyword">restrict</span>-<span class="keyword">access</span>-role <span class="comment">--verb=use --resource=psp --resource-name=restrict-policy</span></span><br></pre></td></tr></table></figure>

<p>(3) 创建 serviceaccount</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">create</span> sa psp-denial-sa -n staging</span><br></pre></td></tr></table></figure>

<p>(4) 绑定 clusterrole 到 serviceaccount</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">create</span> clusterrolebinding dany-access-bind <span class="comment">--clusterrole=restrict-access-role --serviceaccount=staging:psp-denial-sa</span></span><br></pre></td></tr></table></figure>

<p>(5) 启用 PodSecurityPolicy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/kubernetes/manifests/kube-apiserver.yaml </span><br><span class="line"><span class="comment">#确保有以下内容：</span></span><br><span class="line">- --enable-admission-plugins=NodeRestriction,PodSecurityPolicy</span><br></pre></td></tr></table></figure>

<h2 id="15-启用-API-server认证"><a href="#15-启用-API-server认证" class="headerlink" title="15. 启用 API server认证"></a>15. 启用 API server认证</h2><p>这道题同前面 kube-bench 的考核内容有点重合，题目中是用 kubeamd创建的 kubernetes服务器权限设置有问题，允许未经授权的访问。<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">参考链接</a><br>需要进行以下修改：</p>
<ul>
<li>使用 Node,RBAC 授权模式和 NodeRestriction 准入控制器</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"><span class="section"># 确保以下内容</span></span><br><span class="line"><span class="bullet">-</span> --authorization-mode=Node,RBAC</span><br><span class="line"><span class="bullet">-</span> --enable-admission-plugins=NodeRestriction</span><br><span class="line"><span class="bullet">-</span> --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line"><span class="bullet">-</span> --enable-bootstrap-token-auth=true</span><br></pre></td></tr></table></figure>

<ul>
<li>删除 system:anonymous 的 ClusterRolebinding角色绑定，取消匿名用户的集群管理员权限</li>
</ul>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="keyword">delete</span> clusterrolebinding <span class="keyword">system</span>:anonymous</span><br></pre></td></tr></table></figure>

<h2 id="16-ImagePolicyWebhook"><a href="#16-ImagePolicyWebhook" class="headerlink" title="16. ImagePolicyWebhook"></a>16. ImagePolicyWebhook</h2><p>这道题考察 ImagePolicyWebhook 准入控制器的使用，分4个步骤</p>
<ul>
<li>修改控制器配置文件，将未找到有效后端时的默认拒绝改为默认不拒绝<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook">参考链接
</a></li>
</ul>
<p>vi /etc/kubernetes/epconfig/admission_configuration.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;imagePolicy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;kubeConfigFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/kubernetes/epconfig/kubeconfig.yaml&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;allowTTL&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;denyTTL&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;retryBackoff&quot;</span><span class="punctuation">:</span> <span class="number">500</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;defaultAllow&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改 控制器访问 webhook server 的 kubeconfig</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vi</span> <span class="string">/etc/kubernetes/epconfig/kubeconfig.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">修改如下内容</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority:</span> <span class="string">/etc/kubernetes/epconfig/webhook.pem</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://acme.local:8082/image_policy</span>  <span class="comment"># web hook server 的地址</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bouncer_webhook</span></span><br><span class="line"><span class="comment"># 以下省略</span></span><br></pre></td></tr></table></figure>

<ul>
<li>启用ImagePolicyWebhook<br>vi /etc/kubernetes/manifests/kube-apiserver.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用 ImagePolicyWebhook</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--enable-admission-plugins=NodeRestriction,ImagePolicyWebhook</span></span><br><span class="line"><span class="comment"># 指定准入控制器配置文件</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--admission-control-config-file=/etc/kubernetes/epconfig/admission_configuration.json</span></span><br><span class="line"><span class="comment"># mount</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/epconfig</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">epconfig</span></span><br><span class="line"><span class="comment"># 映射 volumes      </span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">epconfig</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/epconfig</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试是否生效</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">kubectl apply -f /cks/img/web1.yaml</span><br></pre></td></tr></table></figure>

<p>From: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/myocp/p/15915123.html">2022年2月我的CKS备考记录 - scwang18 - 博客园 (cnblogs.com)</a></p>
<hr>
<h1 id="真题②基于1-26版本"><a href="#真题②基于1-26版本" class="headerlink" title="真题②基于1.26版本"></a>真题②基于1.26版本</h1><h2 id="考试内容"><a href="#考试内容" class="headerlink" title="考试内容"></a>考试内容</h2><p><a target="_blank" rel="noopener" href="https://training.linuxfoundation.org/certification/certified-kubernetes-security-specialist/#">CKS 考试链接</a><br><a target="_blank" rel="noopener" href="https://docs.linuxfoundation.org/tc-docs/certification/important-instructions-cks">Important Instructions: CKS</a></p>
<ul>
<li>考试包括 15-20 项performance-based tasks。<ul>
<li>2023.1 实测是16道题</li>
</ul>
</li>
<li>考生有 2 小时的时间完成 CKS 考试。<ul>
<li>因为从06/2022开始环境升级（贬义），考试环境更难用了，变的很卡，所以时间变得比较紧张。容易做不完题，建议先把有把握的，花费时间不多的题先做掉<ul>
<li><a target="_blank" rel="noopener" href="https://itnext.io/cks-cka-ckad-changed-terminal-to-remote-desktop-157a26c1d5e">CKS CKA CKAD changed Terminal to Remote Desktop</a></li>
</ul>
</li>
</ul>
</li>
<li>CKS考试67分以上即可通过，考试不通过有一次补考机会。</li>
</ul>
<p>Certifications- expire 36 months from the date that the Program certification requirements are met by a candidate.</p>
<h3 id="Certified-Kubernetes-Security-Specialist-CKS"><a href="#Certified-Kubernetes-Security-Specialist-CKS" class="headerlink" title="Certified Kubernetes Security Specialist (CKS)"></a>Certified Kubernetes Security Specialist (CKS)</h3><p>The following tools and resources are allowed during the exam as long as they are used by candidates to work independently on exam tasks (i.e. not used for 3rd party assistance or research) and are accessed from within the Linux server terminal on which the Exam is delivered.<br>During the exam, candidates may:</p>
<ul>
<li>review the Exam content instructions that are presented in the command line terminal.</li>
<li>review Documents installed by the distribution (i.e. /usr/share and its subdirectories)</li>
<li>use the search function provided on <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/">https://kubernetes.io/docs/</a> however, they may only open search results that have a domain matching the sites listed below</li>
<li>use the browser within the VM to access the following documentation:<ul>
<li>Kubernetes Documentation:<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/">https://kubernetes.io/docs/</a> and their subdomains</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/blog/">https://kubernetes.io/blog/</a> and their subdomains<br>This includes all available language translations of these pages (e.g. <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/">https://kubernetes.io/zh/docs/</a>)</li>
</ul>
</li>
<li>Tools:<ul>
<li>Trivy documentation <a target="_blank" rel="noopener" href="https://aquasecurity.github.io/trivy/">https://aquasecurity.github.io/trivy/</a></li>
<li>Falco documentation <a target="_blank" rel="noopener" href="https://falco.org/docs/">https://falco.org/docs/</a><br>This includes all available language translations of these pages (e.g. <a target="_blank" rel="noopener" href="https://falco.org/zh/docs/">https://falco.org/zh/docs/</a>)</li>
</ul>
</li>
<li>App Armor:<ul>
<li>Documentation <a target="_blank" rel="noopener" href="https://gitlab.com/apparmor/apparmor/-/wikis/Documentation">https://gitlab.com/apparmor/apparmor/-/wikis/Documentation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>You’re only allowed to have one other browser tab open with:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs">https://kubernetes.io/docs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes">https://github.com/kubernetes</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/blog">https://kubernetes.io/blog</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/trivy">https://github.com/aquasecurity/trivy</a></li>
<li><a target="_blank" rel="noopener" href="https://falco.org/docs">https://falco.org/docs</a></li>
<li><a target="_blank" rel="noopener" href="https://gitlab.com/apparmor/apparmor/-/wikis/Documentation">https://gitlab.com/apparmor/apparmor/-/wikis/Documentation</a></li>
</ul>
<h3 id="CKS-Environment"><a href="#CKS-Environment" class="headerlink" title="CKS Environment"></a>CKS Environment</h3><ul>
<li>Each task on this exam must be completed on a designated cluster/configuration context.</li>
<li>Sixteen clusters comprise the exam environment, one for each task. Each cluster is made up of one master node and one worker node.</li>
<li>An infobox at the start of each task provides you with the cluster name/context and the hostname of the master and worker node.</li>
<li>You can switch the cluster/configuration context using a command such as the following:</li>
<li><code>kubectl config use-context &lt;cluster/context name&gt;</code></li>
<li>Nodes making up each cluster can be reached via ssh, using a command such as the following:</li>
<li><code>ssh &lt;nodename&gt;</code></li>
<li>You have elevated privileges on any node by default, so there is no need to assume elevated privileges.</li>
<li>You must return to the base node (hostname cli) after completing each task.</li>
<li>Nested <code>−ssh</code> is not supported.</li>
<li>You can use <code>kubectl</code> and the appropriate context to work on any cluster from the base node. When connected to a cluster member via ssh, you will only be able to work on that particular cluster via kubectl.</li>
<li>For your convenience, all environments, in other words, the base system and the cluster nodes, have the following additional command-line tools pre-installed and pre-configured:<ul>
<li><code>kubectl</code> with kalias and Bash autocompletion</li>
<li><code>yq</code> and <code>jq</code> for YAML/JSON processing</li>
<li><code>tmux</code> for terminal multiplexing</li>
<li><code>curl</code> and <code>wget</code> for testing web services</li>
<li><code>man</code> and man pages for further documentation</li>
</ul>
</li>
<li>Further instructions for connecting to cluster nodes will be provided in the appropriate tasks</li>
<li>The CKS environment is currently running etcd v3.5</li>
<li>The CKS environment is currently running Kubernetes v1.26</li>
<li>The CKS exam environment will be aligned with the most recent K8s minor version within approximately 4 to 8 weeks of the K8s release date.</li>
</ul>
<h3 id="More-items-for-CKS-than-CKA-and-CKAD"><a href="#More-items-for-CKS-than-CKA-and-CKAD" class="headerlink" title="More items for CKS than CKA and CKAD"></a>More items for CKS than CKA and CKAD</h3><ul>
<li>Pod Security Policies(PSP) - removed from Kubernetes in <code>v1.25</code></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/security/apparmor/">AppArmor</a></li>
<li>Apiserver<ul>
<li>Apiserver Crash</li>
<li>Apiserver NodeRestriction</li>
</ul>
</li>
<li>ImagePolicyWebhook</li>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-bench">kube-bench</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/trivy">Trivy</a></li>
</ul>
<h3 id="CKS-知识点-amp-练习题总结"><a href="#CKS-知识点-amp-练习题总结" class="headerlink" title="CKS 知识点&amp;练习题总结"></a><a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernetes-CKS-%E7%9F%A5%E8%AF%86%E7%82%B9-%E7%BB%83%E4%B9%A0%E9%A2%98.html">CKS 知识点&amp;练习题总结</a></h3><h2 id="如何备考"><a href="#如何备考" class="headerlink" title="如何备考"></a>如何备考</h2><h3 id="k8s练习环境-同CKA"><a href="#k8s练习环境-同CKA" class="headerlink" title="k8s练习环境(同CKA)"></a><a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernates-Certified-Kubernetes-Administrator-CKA.html#k8s%E7%BB%83%E4%B9%A0%E7%8E%AF%E5%A2%83">k8s练习环境</a>(同CKA)</h3><h3 id="CKS练习题"><a href="#CKS练习题" class="headerlink" title="CKS练习题"></a>CKS练习题</h3><p>有几个练习库，建议将每个题目都自己亲自操作一遍，一定要操作。</p>
<ul>
<li>CKS在线练习环境：<a target="_blank" rel="noopener" href="https://killercoda.com/killer-shell-cks">https://killercoda.com/killer-shell-cks</a></li>
<li><a target="_blank" rel="noopener" href="https://killer.sh/attendee/f65d95f1-170b-444d-8af0-bbf302f8c796/content">CKS Simulator Kubernetes 1.26</a></li>
<li><a target="_blank" rel="noopener" href="https://killercoda.com/killer-shell-ckad/scenario/admission-controllers">Adminission pligin/Pod Security Policies 练习</a></li>
</ul>
<h3 id="CKS课程"><a href="#CKS课程" class="headerlink" title="CKS课程"></a>CKS课程</h3><ul>
<li>【需付费】CKS考试-对应官方课程<a target="_blank" rel="noopener" href="https://training.linuxfoundation.org/training/kubernetes-security-essentials-lfs260/">Kubernetes for Developers (LFS260)</a> 感觉没必要买，只看官方文档就足够了。</li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"># 不熟</span><br><span class="line">## 输出pod status</span><br><span class="line">kubectl -n default describe pod pod1 | grep -i status:</span><br><span class="line">kubectl -n default get pod pod1 -o jsonpath=&quot;&#123;.status.phase&#125;&quot;</span><br><span class="line">## Check the pod for error</span><br><span class="line">kubectl describe pod podname | grep -i error</span><br><span class="line">... Error: ImagePullBackOff</span><br><span class="line">## a fast way to get an overview of the ReplicaSets of a Deployment and their images could be done with:</span><br><span class="line">kubectl -n neptune get rs -o wide | grep deployname</span><br><span class="line">NAME         DESIRED   CURRENT   READY   AGE    CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">deployname   3         3         3       9m6s   httpd        httpd:alpine   app=wonderful</span><br><span class="line"></span><br><span class="line">## 创建job</span><br><span class="line">kubectl -n neptune create job neb-new-job --image=busybox:1.31.0 $do &gt; /opt/course/3/job.yaml -- sh -c &quot;sleep 2 &amp;&amp; echo done&quot;</span><br><span class="line">## If a Secret bolongs to a serviceaccount, it&#x27;ll have the annotation kubernetes.io/service-account.name</span><br><span class="line">kubectl get secrets -oyaml | grep annotations -A 1 # shows secrets with first annotation</span><br><span class="line">## log</span><br><span class="line">kubectl logs podname &gt; /opt/test.log</span><br><span class="line">## decode base64</span><br><span class="line">base64 -d filename</span><br><span class="line">## check service connection using a temporary Pod</span><br><span class="line">## k run tmp --restart=Never --rm --image=nginx:alpine -i -- curl http://svcname.namespace:svcport</span><br><span class="line">kubectl run tmp --restart=Never --rm --image=nginx:alpine -i -- curl http://svcname.namespace:80</span><br><span class="line">## check that both PV and PVC have the status Bound:</span><br><span class="line">k -n earth get pv,pvc</span><br><span class="line">NAME                                            CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                 STORAGECLASS   REASON   AGE</span><br><span class="line">persistentvolume/earth-project-earthflower-pv   2Gi        RWO            Retain           Bound    earth/earth-project-earthflower-pvc                           8m4s</span><br><span class="line"></span><br><span class="line">NAME                                                  STATUS   VOLUME                         CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">persistentvolumeclaim/earth-project-earthflower-pvc   Bound    earth-project-earthflower-pv   2Gi        RWO                           7m38s</span><br><span class="line"></span><br><span class="line">## We can confirm the pod of deployment with PVC mounting correctly:</span><br><span class="line">k describe pod project-earthflower-586758cc49-hb87f -n earth | grep -A2 Mount:</span><br><span class="line">    Mounts:</span><br><span class="line">      /tmp/project-data from task-pv-storage (rw)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-jj2t2 (ro)</span><br><span class="line"></span><br><span class="line">## Verify everything using kubectl auth can-i</span><br><span class="line">kubectl auth can-i create deployments --as system:serviceaccount:app-team1:cicd-token -n app-team1 # YES</span><br><span class="line"># 常用</span><br><span class="line">## 创建pod</span><br><span class="line">kubectl run pod1 --image=httpd:2.4.41-alpine $do &gt; 2.yaml</span><br><span class="line">kubectl get pod sat-003 -o yaml &gt; 7-sat-003.yaml # export</span><br><span class="line">kubectl delete pod pod1 --force --grace-period=0</span><br><span class="line">## 创建service</span><br><span class="line">kubectl expose deployment d1 --name=服务名 --port=服务端口 --target-port=pod运行端口 --type=类型</span><br><span class="line">kubectl expose pod pod名 --name=服务名 --port=服务端口 --target-port=pod运行端口 --type=类型</span><br><span class="line"># CKS</span><br><span class="line">## 创建secret</span><br><span class="line">kubectl create secret generic db-credentials --from-literal db-password=passwd</span><br><span class="line">## modify a pod yaml to deployment yaml</span><br><span class="line">### put the Pod&#x27;s metadata: and spec: into the Deployment&#x27;s template: section:</span><br><span class="line"></span><br><span class="line">## To verify that the token hasn&#x27;t been mounted run the following commands:</span><br><span class="line">kubectl -n one exec -it pod-name -- mount | grep serviceaccount</span><br><span class="line">kubectl -n one exec -it pod-name -- cat /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br><span class="line">### 创建 clusterrole，使用 psp</span><br><span class="line">kubectl create clusterrole restrict-access-role --verb=use --resource=psp --resource-name=restrict-policy</span><br><span class="line"></span><br><span class="line">## after modify /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line">### 查询 sa 对应的 role 名称（假设是 role-1）</span><br><span class="line">kubectl get rolebinding -n db -oyaml | grep &#x27;service-account-web&#x27; -B 10</span><br><span class="line"></span><br><span class="line">### grep</span><br><span class="line">grep apple -A 10 # apple之后10行</span><br><span class="line"></span><br><span class="line">grep apple -B 10 # apple之前10行</span><br><span class="line"></span><br><span class="line">### secret used by pod</span><br><span class="line">kubectl exec pod1 -- env</span><br><span class="line">kubectl exec pod1 -- cat /etc/diver/hosts</span><br></pre></td></tr></table></figure>

<ul>
<li><p><a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernates-Certified-Kubernetes-Administrator-CKA.html#%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93">经验总结</a>(同CKA)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernates-Certified-Kubernetes-Administrator-CKA.html#pre-setup">Pre Setup</a>(同CKA)</p>
</li>
</ul>
<h2 id="CKS-2023-真题-1-26"><a href="#CKS-2023-真题-1-26" class="headerlink" title="CKS 2023 真题 1.26"></a>CKS 2023 真题 1.26</h2><h3 id="考题1-AppArmor-访问控制"><a href="#考题1-AppArmor-访问控制" class="headerlink" title="考题1 - AppArmor 访问控制"></a>考题1 - AppArmor 访问控制</h3><h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><p>AppArmor is enabled on the cluster’s worker node. An AppArmor profile is prepared, but not enforced yet.<br>You may use your browser to open one additional tab to access the AppArmor documentation.</p>
<p>AppArmor 已在 cluster 的工作节点上被启用。一个 AppArmor 配置文件已存在，但尚未被实施。</p>
<h4 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h4><p>On the cluster’s worker node, enforce the prepared AppArmor profile located at <code>/etc/apparmor.d/nginx_apparmor</code> .<br>Edit the prepared manifest file located at <code>/home/candidate/KSSH00401/nginx-deploy.yaml</code> to apply the AppArmor profile.<br>Finally, apply the manifest file and create the pod specified in it.</p>
<p>在 cluster 的工作节点上，实施位于 <code>/etc/apparmor.d/nginx_apparmor</code> 的现有 AppArmor 配置文件。<br>编辑位于 <code>/home/candidate/KSSH00401/nginx-deploy.yaml</code> 的现有清单文件以应用 AppArmor 配置文件。<br>最后，应用清单文件并创建其中指定的 Pod 。</p>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>搜索 apparmor（使用 AppArmor 限制容器对资源的访问），接着再搜索字符串 “parser”<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tutorials/security/apparmor/">https://kubernetes.io/zh/docs/tutorials/security/apparmor/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## 远程登录到指定工作节点</span></span></span><br><span class="line">ssh cka-node01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## 从profile文件查看策略名称</span></span></span><br><span class="line">cat /etc/apparmor.d/nginx_apparmor</span><br><span class="line"></span><br><span class="line">    profile nginx-profile flags=(attach_disconnected) &#123;</span><br><span class="line">    ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## 加载 apparmor 配置文件</span></span></span><br><span class="line">apparmor_parser /etc/apparmor.d/nginx_apparmor</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## 查看策略名称，结果是 nginx-profile</span></span></span><br><span class="line">apparmor_status | grep nginx-profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## 回到控制节点，并更新 Pod 的注解</span></span></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">vim /home/candidate/KSSH00401/nginx-deploy.yaml</span><br><span class="line">    annotations:</span><br><span class="line">      ### hello 是 Pod 里容器名称，nginx-profile 则是 apparmor_status 解析出来的结果</span><br><span class="line">      container.apparmor.security.beta.kubernetes.io/hello: localhost/nginx-profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## 如果 apply 后报错，则先删除保存并删除旧 Pod，改完后再创建新的</span></span></span><br><span class="line">kubectl apply -f /home/candidate/KSSH00401/nginx-deploy.yaml</span><br></pre></td></tr></table></figure>

<h3 id="考题2-Kube-Bench-基准测试"><a href="#考题2-Kube-Bench-基准测试" class="headerlink" title="考题2 - Kube-Bench 基准测试"></a>考题2 - Kube-Bench 基准测试</h3><h4 id="Context-1"><a href="#Context-1" class="headerlink" title="Context"></a>Context</h4><p>A CIS Benchmark tool was run against the kubeadm-created cluster and found multiple issues that must be addressed immediately.</p>
<p>针对 kubeadm 创建的 cluster 运行 CIS 基准测试工具时， 发现了多个必须立即解决的问题。</p>
<h4 id="Task-1"><a href="#Task-1" class="headerlink" title="Task"></a>Task</h4><p>Fix all issues via configuration and restart theaffected components to ensure the new settings take effect.<br>通过配置修复所有问题并重新启动受影响的组件以确保新的设置生效。</p>
<p>Fix all of the following violations that were found against the API server:<br>修复针对 API 服务器发现的所有以下违规行为：<br>Ensure that the 1.2.7 –authorization-mode FAIL argument is not set to AlwaysAllow<br>Ensure that the 1.2.8 –authorization-mode FAIL argument includes Node<br>Ensure that the 1.2.9 –authorization-mode FAIL argument includes RBAC<br>Ensure that the 1.2.18 –insecure-bind-address FAIL argument is not set<br>Ensure that the 1.2.19 –insecure-port FAIL argument is set to 0</p>
<p>Fix all of the following violations that were found against the kubelet:<br>修复针对 kubelet 发现的所有以下违规行为：<br>Ensure that the 4.2.1 –anonymous-auth FAIL argument is set to false<br>Ensure that the 4.2.2 –authorization-mode FAIL argument is not set to AlwaysAllow<br>Use <code>Webhook</code> authn/authz where possible. 注意：尽可能使用 Webhook authn/authz。</p>
<p>Fix all of the following violations that were found against etcd:<br>修复针对 etcd 发现的所有以下违规行为：<br>Ensure that the 4.2.1 –client-cert-auth FAIL argument is set to true</p>
<h4 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ ssh root@vms65.rhce.cc</span><br><span class="line"></span><br><span class="line"># kube-bench run --target=master --check=1.2.7</span><br><span class="line">kube-bench run --target=master | grep FAIL</span><br><span class="line"></span><br><span class="line">### 修复针对 APIserver 发现的以下所有问题：</span><br><span class="line">### 确保 1.2.7 --authorization-mode 参数不能设置为 AlwaysAllow</span><br><span class="line">### 确保 1.2.8 --authorization-mode 参数包含 Node</span><br><span class="line">### 确保 1.2.9 --authorization-mode 参数包含 RBAC</span><br><span class="line">### 确保 1.2.18 --insecure-bind-address 参数不能设置</span><br><span class="line">### 确保 1.2.19 --insecure-port 参数设置为 0</span><br><span class="line">### 注意：修改 master 节点！</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">    #- --authorization-mode=AlwaysAllow 删除AlwaysAllow，加Node,RBAC</span><br><span class="line">    - --authorization-mode=Node,RBAC</span><br><span class="line">    #- --insecure-bind-address=0.0.0.0</span><br><span class="line">    - --insecure-port=0</span><br><span class="line"></span><br><span class="line">### 修复针对 kubelet 发现的以下所有问题：</span><br><span class="line">### 确保 4.2.1 anonymous-auth 参数设置为 false</span><br><span class="line">### 确保 4.2.2 --authorization-mode 参数不能设置为 AlwaysAllow，尽可能使用 Webhook authn/authz</span><br><span class="line">### 注意：master 和 node 节点都要修改！</span><br><span class="line">vim /var/lib/kubelet/config.yaml</span><br><span class="line">    authentication:</span><br><span class="line">      anonymous:</span><br><span class="line">        enabled: false</span><br><span class="line">    authorization:</span><br><span class="line">      mode: Webhook</span><br><span class="line"></span><br><span class="line">### 修复针对 etcd 发现的以下所有问题：</span><br><span class="line">### 确保 4.2.--client-cert-auth 参数设置为 true</span><br><span class="line">### 注意：修改 master 节点！</span><br><span class="line">vim /etc/kubernetes/manifests/etcd.yaml</span><br><span class="line">    - --client-cert-auth=true</span><br><span class="line"></span><br><span class="line">### 加载并重启 kubelet 服务</span><br><span class="line">### 注意：master 和 node 节点都要重启！</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h3 id="考题3-Trivy-镜像扫描"><a href="#考题3-Trivy-镜像扫描" class="headerlink" title="考题3 - Trivy 镜像扫描"></a>考题3 - Trivy 镜像扫描</h3><h4 id="Task-2"><a href="#Task-2" class="headerlink" title="Task"></a>Task</h4><p>使用 Trivy 开源容器扫描器检测 namespace kamino 中 Pod 使用的具有严重漏洞的镜像。<br>查找具有 High 或 Critical 严重性漏洞的镜像，并删除使用这些镜像的 Pod。<br>注意：Trivy 仅安装在 cluster 的 master 节点上，在工作节点上不可使用。你必须切换到 cluster 的 master 节点才能使用 Trivy 。</p>
<p>Use the Trivy open-source container scanner to detect images with severe vulnerabilities used by Pods in the namespace <code>kamino</code>.<br>Look for images with <code>High</code> or <code>Critical</code> severity vulnerabilities, and delete the Pods that use those images.</p>
<p>Trivy is pre-installed on the cluster’s <code>master</code> node only; it is not available on the base system or the worker nodes. You’ll have to connect to the cluster’s master node to use <code>Trivy</code>.</p>
<h4 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution"></a>Solution</h4><p>搜索 kubectl images（列出集群中所有运行容器的镜像）<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/list-all-running-container-images/">https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/list-all-running-container-images/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">### 需登录到控制节点操作</span><br><span class="line">ssh cka-master01</span><br><span class="line"></span><br><span class="line">### 查询命名空间 kamino 中 pod 使用的镜像</span><br><span class="line">kubectl get pod -n kamino -o yaml | grep image:</span><br><span class="line"># 或者</span><br><span class="line">kubectl get pods -n kamino -o jsonpath=&#x27;&#123;range .items[*]&#125;&#123;&quot;\n&quot;&#125;&#123;.metadata.name&#125;&#123;&quot;:\t&quot;&#125;&#123;range .spec.containers[*]&#125;&#123;.image&#125;&#123;&quot;, &quot;&#125;&#123;end&#125;&#123;end&#125;&#x27; | sort</span><br><span class="line"></span><br><span class="line">### 假设镜像是 registry.aliyuncs.com/google_containers/coredns:1.7.0</span><br><span class="line">### 使用 trivy 工具查询具有 HIGH 或 CRITICAL 漏洞的镜像</span><br><span class="line">trivy --help</span><br><span class="line">trivy image --severity HIGH,CRITICAL &#x27;registry.aliyuncs.com/google_containers/coredns:1.7.0&#x27;</span><br><span class="line"></span><br><span class="line">### 删除检测到的漏洞镜像对应的 pod（如果有控制器，得删除控制器）</span><br><span class="line">kubectl delete pod -n kamino pod名称</span><br></pre></td></tr></table></figure>

<h3 id="考题4-Sysdig-amp-Falco"><a href="#考题4-Sysdig-amp-Falco" class="headerlink" title="考题4 - Sysdig &amp; Falco"></a>考题4 - Sysdig &amp; Falco</h3><p>you may use you brower to open one additonal tab to access sysdig’s documentation or Falco’s documentaion</p>
<h4 id="Task-3"><a href="#Task-3" class="headerlink" title="Task"></a>Task</h4><p>Use runtime detection tools to detect anomalous processes spawning and executing frequently in the sigle container belonging to Pod <code>redis</code>. Two tools are avaliable to use:<br>使用运行时检测工具来检测 Pod tomcat 单个容器中频发生成和执行的异常进程。有两种工具可供使用：</p>
<ul>
<li>sysdig</li>
<li>falco</li>
</ul>
<p>The tools are pre-installed on the cluster’s worker node only, they are not avaliable on the base system or the master node.<br>Using the tool of you choice (including any non pre-install tool) analyse the container’s behavior for at least <code>30</code> seconds, using filers that detect newly spawing and executing processes, store an incident file at <code>/opt/KSR00101/incidents/summary</code>, containing the detected incidents one per line in the follwing format:<br>注：这些工具只预装在 cluster 的工作节点，不在 master 节点。<br>使用工具至少分析 30 秒，使用过滤器检查生成和执行的进程，将事件写到 <code>/opt/KSR00101/incidents/summary</code> 文件中，其中包含检测的事件, 每个单独一行<br>格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[timestamp],[uid],[processName]</span><br></pre></td></tr></table></figure>

<p>保持工具的原始时间戳格式不变。<br>注：确保事件文件存储在集群的工作节点上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># 方法一 sysdig</span><br><span class="line">### 需登录到工作节点操作</span><br><span class="line">ssh cka-node01</span><br><span class="line"></span><br><span class="line">### 查看 sysdig 帮助</span><br><span class="line">sysdig -h</span><br><span class="line"></span><br><span class="line">### 查看 sysdig 支持的元数据</span><br><span class="line">sysdig -l</span><br><span class="line"></span><br><span class="line">### 查看指定容器ID</span><br><span class="line">crictl ps | grep redis</span><br><span class="line"></span><br><span class="line">### -M 分析容器30秒，-p 指定事件保存格式，--cri 指定容器运行时，并且保存到指定文件路径中</span><br><span class="line">sysdig -M 30 -p &quot;*%evt.time,%user.uid,%proc.name&quot; --cri /run/containerd/containerd.sock container.id=xxxxx &gt; /opt/KSR00101/incidents/summary</span><br><span class="line"># 方法二 falco</span><br><span class="line">### 需登录到工作节点操作</span><br><span class="line">ssh cka-node01</span><br><span class="line"></span><br><span class="line">### </span><br><span class="line">cd /etc/falco</span><br><span class="line">ls</span><br><span class="line"></span><br><span class="line">### </span><br><span class="line">vim /etc/falco/falco_rules.yaml</span><br><span class="line"># Container is supposed to be immutable. Package management should be done in building the image.</span><br><span class="line">- rule: Launch Package Management Process in Container</span><br><span class="line">  desc: Package management process ran inside container</span><br><span class="line">  condition: &gt;</span><br><span class="line">    spawned_process</span><br><span class="line">    and container</span><br><span class="line">    and user.name != &quot;_apt&quot;</span><br><span class="line">    and package_mgmt_procs</span><br><span class="line">    and not package_mgmt_ancestor_procs</span><br><span class="line">    and not user_known_package_manager_in_container</span><br><span class="line">  output: &gt;</span><br><span class="line">    Package management process launched in container %evt.time,%user.uid,%proc.name</span><br><span class="line"></span><br><span class="line">### 查看指定容器ID</span><br><span class="line">cat /var/log/sysdig | grep falco | grep &quot;Package management&quot; -i</span><br><span class="line"></span><br><span class="line"># </span><br><span class="line">vim /opt/KSR00101/incidents/summary</span><br></pre></td></tr></table></figure>

<h3 id="考题5-ServiceAccount"><a href="#考题5-ServiceAccount" class="headerlink" title="考题5 - ServiceAccount"></a>考题5 - ServiceAccount</h3><p>Context<br>A Pod fails to run because of an incorrectly specified ServiceAcccount.</p>
<h4 id="Task-4"><a href="#Task-4" class="headerlink" title="Task"></a>Task</h4><p>create a new ServiceAccount named <code>backend-sa</code> in the existing namespace <code>qa</code>, which must <strong>not have access to any secrets</strong>.</p>
<ul>
<li><p>Inspect the Pods in the namespace</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qa</span><br></pre></td></tr></table></figure>

<p>.</p>
<ul>
<li>Edit the Pod to use the newly created serviceAccount <code>backend-sa</code>.</li>
<li>Ensure that the modified specification is applied and the Pod is running.</li>
</ul>
</li>
<li><p>Finally, clean-up and delete the now unused serviceAccount in the namespace <code>qa</code>.<br>在现有 namespace <code>qa</code> 中创建一个名为 <code>backend-sa</code> 的新 ServiceAccount， 确保此 ServiceAccount 不自动挂载secrets。<br>使用 <code>/cks/9/pod9.yaml</code> 中的清单文件来创建一个 Pod。<br>最后，清理 namespace <code>qa</code> 中任何未使用的 ServiceAccount。</p>
</li>
</ul>
<h4 id="Solution-3"><a href="#Solution-3" class="headerlink" title="Solution"></a>Solution</h4><p>搜索 serviceaccount（为Pod配置服务账号），接着再搜索字符串 “automount”<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-service-account/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-service-account/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">### 创建 ServiceAccount</span><br><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: backend-sa</span><br><span class="line">  namespace: qa</span><br><span class="line">automountServiceAccountToken: false</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">### </span><br><span class="line">k get pods -n qa</span><br><span class="line">  web1-xxx1</span><br><span class="line">  web2-xwx2</span><br><span class="line">  web3-xwx3</span><br><span class="line">k get deployment -n qa</span><br><span class="line">  web1</span><br><span class="line">  web2</span><br><span class="line">  web3</span><br><span class="line"># 发现这些pod都属于deployment</span><br><span class="line"></span><br><span class="line">### 编辑 Pod 使用新创建的 serviceaccount</span><br><span class="line">k edit deployment/web1 -n qa</span><br><span class="line">k edit deployment/web2 -n qa</span><br><span class="line">k edit deployment/web3 -n qa</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">template:</span><br><span class="line">  spec:</span><br><span class="line">    serviceAccountName: backend-sa # add</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">### 应用清单文件</span><br><span class="line">kubectl apply -f /cks/9/pod9.yaml</span><br><span class="line"></span><br><span class="line">### 把除了 backend-sa, 并且没有被使用的 serviceaccount 都删除</span><br><span class="line">kubectl get serviceaccount -n qa</span><br><span class="line">    backend-sa</span><br><span class="line">    default</span><br><span class="line">    contentsa</span><br><span class="line"></span><br><span class="line">kubectl get rolebinding -n qa -o wide</span><br><span class="line">kubectl get clustorrolebinding -n qa -o wide</span><br><span class="line"></span><br><span class="line">kubectl delete -n qa serviceaccount contentsa</span><br></pre></td></tr></table></figure>

<h3 id="考题6-2022真题v1-20-Pod-安全策略-PodSecurityPolicy"><a href="#考题6-2022真题v1-20-Pod-安全策略-PodSecurityPolicy" class="headerlink" title="考题6 - 2022真题v1.20 Pod 安全策略-PodSecurityPolicy"></a>考题6 - 2022真题v1.20 Pod 安全策略-PodSecurityPolicy</h3><p>2023的最新考试已经没有这道题了，替代的是Pod Security Standard</p>
<h4 id="Context6"><a href="#Context6" class="headerlink" title="Context6"></a>Context6</h4><p>A PodsecurityPolicy shall prevent the creation on of privileged Pods in a specific namespace.<br>PodSecurityPolicy 应防止在特定 namespace 中特权 Pod 的创建。</p>
<h4 id="Task6"><a href="#Task6" class="headerlink" title="Task6"></a>Task6</h4><p>Create a new <code>PodSecurityPolicy</code> named <code>restrict-policy</code>, which prevents the creation of privileged Pods.</p>
<p>Create a new <code>ClusterRole</code> named <code>restrict-access-role</code>, which uses the newly created PodSecurityPolicy <code>restrict-policy</code>.<br>Create a new <code>serviceAccount</code> named <code>psp-denial-sa</code> in the existing namespace <code>staging</code>.</p>
<p>Finally, create a new <code>clusterRoleBinding</code> named <code>dany-access-bind</code>, which binds the newly created ClusterRole <code>restrict-access-role</code> to the newly created serviceAccount <code>psp-denial-sa</code>.</p>
<p>创建一个名为 <code>restrict-policy</code> 的新的 PodSecurityPolicy，以防止特权 Pod 的创建。<br>创建一个名为 <code>restrict-access-role</code> 并使用新创建的 PodSecurityPolicy <code>restrict-policy</code> 的 ClusterRole。<br>在现有的 namespace <code>staging</code> 中创建一个名为 <code>psp-denial-sa</code> 的新 ServiceAccount 。<br>最后，创建一个名为 <code>dany-access-bind</code> 的 ClusterRoleBinding，将新创建的 ClusterRole <code>restrict-access-role</code> 绑定到新创建的 ServiceAccount <code>psp-denial-sa</code>。<br>你可以在一下位置找到模版清单文件： <code>/cks/psp/psp.yaml</code></p>
<h4 id="Solution6"><a href="#Solution6" class="headerlink" title="Solution6"></a>Solution6</h4><p>搜索 runasany（Pod Security Policy）<br><a target="_blank" rel="noopener" href="https://kubernetes.io/id/docs/concepts/policy/pod-security-policy/">https://kubernetes.io/id/docs/concepts/policy/pod-security-policy/</a><br>搜索 clusterrole（使用RBAC鉴权）<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">### (1)创建 psp</span><br><span class="line">vim /cks/psp/psp.yaml</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodSecurityPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: restrict-policy</span><br><span class="line">spec:</span><br><span class="line">  privileged: false</span><br><span class="line">  seLinux:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  supplementalGroups:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  runAsUser:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  fsGroup:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  volumes:</span><br><span class="line">  - &#x27;*&#x27;</span><br><span class="line"></span><br><span class="line">kubectl apply -f /cks/psp/psp.yaml</span><br><span class="line"></span><br><span class="line">### (2)创建 clusterrole，使用 psp</span><br><span class="line">kubectl create clusterrole restrict-access-role --verb=use --resource=psp --resource-name=restrict-policy</span><br><span class="line"></span><br><span class="line">### (3)创建 serviceaccount</span><br><span class="line">kubectl create serviceaccount psp-denial-sa -n staging </span><br><span class="line"></span><br><span class="line">### (4)创建 clusterrolebinding</span><br><span class="line">kubectl create clusterrolebinding dany-access-bind --clusterrole=restrict-access-role --serviceaccount=staging:psp-denial-sa</span><br><span class="line"></span><br><span class="line">### (5)启用 PodSecurityPolicy（在控制节点上修改 apiserver 配置）</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">    - --enable-admission-plugins=NodeRestriction,PodSecurityPolicy</span><br><span class="line"></span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h3 id="考题6-2023真题V1-26-Pod-Security-Standard"><a href="#考题6-2023真题V1-26-Pod-Security-Standard" class="headerlink" title="考题6 - 2023真题V1.26 Pod Security Standard"></a>考题6 - 2023真题V1.26 Pod Security Standard</h3><p>Task weight: 8%<br>Use context: <code>kubectl config use-context workload-prod</code></p>
<p>There is Deployment <code>container-host-hacker</code> in Namespace <code>team-red</code> which mounts <code>/run/containerd</code> as a hostPath volume on the Node where it’s running. This means that the Pod can access various data about other containers running on the same Node.</p>
<p>To prevent this configure Namespace <code>team-red</code> to <code>enforce</code> the <code>baseline</code> Pod Security Standard. Once completed, delete the Pod of the Deployment mentioned above.</p>
<p>Check the <code>ReplicaSet</code> events and write the event/log lines containing the reason why the Pod isn’t recreated into <code>/opt/course/4/logs</code>.</p>
<h4 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h4><p>Making Namespaces use Pod Security Standards works via labels. We can simply edit it:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k edit ns team-red</span><br></pre></td></tr></table></figure>

<p>Now we configure the requested label:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># kubectl edit namespace team-red</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/metadata.name: team-red</span><br><span class="line">    pod-security.kubernetes.io/enforce: baseline # add</span><br><span class="line">  name: team-red</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>This should already be enough for the default Pod Security Admission Controller to pick up on that change. Let’s test it and delete the Pod to see if it’ll be recreated or fails, it should fail!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ k -n team-red get pod</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">container-host-hacker-dbf989777-wm8fc   1/1     Running   0          115s</span><br><span class="line"></span><br><span class="line">➜ k -n team-red delete pod container-host-hacker-dbf989777-wm8fc </span><br><span class="line">pod &quot;container-host-hacker-dbf989777-wm8fc&quot; deleted</span><br><span class="line"></span><br><span class="line">➜ k -n team-red get pod</span><br><span class="line">No resources found in team-red namespace.</span><br></pre></td></tr></table></figure>

<p>Usually the ReplicaSet of a Deployment would recreate the Pod if deleted, here we see this doesn’t happen. Let’s check why:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜ k -n team-red get rs</span><br><span class="line">NAME                              DESIRED   CURRENT   READY   AGE</span><br><span class="line">container-host-hacker-dbf989777   1         0         0       5m25s</span><br><span class="line"></span><br><span class="line">➜ k -n team-red describe rs container-host-hacker-dbf989777</span><br><span class="line">Name:           container-host-hacker-dbf989777</span><br><span class="line">Namespace:      team-red</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                   From                   Message</span><br><span class="line">  ----     ------            ----                  ----                   -------</span><br><span class="line">...</span><br><span class="line">  Warning  FailedCreate      2m41s                 replicaset-controller  Error creating: pods &quot;container-host-hacker-dbf989777-bjwgv&quot; is forbidden: violates PodSecurity &quot;baseline:latest&quot;: hostPath volumes (volume &quot;containerdata&quot;)</span><br><span class="line">  Warning  FailedCreate      2m2s (x9 over 2m40s)  replicaset-controller  (combined from similar events): Error creating: pods &quot;container-host-hacker-dbf989777-kjfpn&quot; is forbidden: violates PodSecurity &quot;baseline:latest&quot;: hostPath volumes (volume &quot;containerdata&quot;)</span><br></pre></td></tr></table></figure>

<p>There we go! Finally we write the reason into the requested file so that Mr Scoring will be happy too!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># /opt/course/4/logs</span><br><span class="line">Warning  FailedCreate      2m2s (x9 over 2m40s)  replicaset-controller  (combined from similar events): Error creating: pods &quot;container-host-hacker-dbf989777-kjfpn&quot; is forbidden: violates PodSecurity &quot;baseline:latest&quot;: hostPath volumes (volume &quot;containerdata&quot;)</span><br></pre></td></tr></table></figure>

<p>Pod Security Standards can give a great base level of security! But when one finds themselves wanting to deeper adjust the levels like <code>baseline</code> or <code>restricted</code>… this isn’t possible and 3rd party solutions like OPA could be looked at.</p>
<h3 id="考题7-NetworkPolicy-default-deny"><a href="#考题7-NetworkPolicy-default-deny" class="headerlink" title="考题7 - NetworkPolicy - default-deny"></a>考题7 - NetworkPolicy - default-deny</h3><h4 id="Context-2"><a href="#Context-2" class="headerlink" title="Context"></a>Context</h4><p>A default-deny NetworkPolicy avoids to accidentally expose a Pod in a namespace that doesn’t have any other NetworkPolicy defined.<br>一个默认拒绝（default-deny）的 NetworkPolicy 可避免在未定义任何其他 NetworkPolicy 的 namespace 中意外公开 Pod。</p>
<h4 id="Task-5"><a href="#Task-5" class="headerlink" title="Task"></a>Task</h4><p>Create a new default-deny NetworkPolicy named <code>denynetwork</code> in the namespace <code>development</code> for all traffic of type <code>Ingress</code>.<br>The new NetworkPolicy must deny all ingress traffic in the namespace <code>development</code>.</p>
<p>Apply the newly created <code>default-deny</code> NetworkPolicy to all Pods running in namespace <code>development</code>.<br>You can find a skeleton manifest file at <code>/cks/15/p1.yaml</code></p>
<p>为所有类型为 Ingress+Egress 的流量在 namespace testing 中创建一个名为 <code>denynetwork</code> 的新默认拒绝 NetworkPolicy。 此新的 NetworkPolicy 必须拒绝 namespace testng 中的所有的 Ingress + Egress 流量。<br>将新创建的默认拒绝 NetworkPolicy 应用与在 namespace testing 中运行的所有 Pod。<br>你可以在 <code>/cks/15/p1.yaml</code> 找到一个模板清单文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">### 修改模板清单文件</span><br><span class="line">vim /cks/15/p1.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: denynetwork</span><br><span class="line">  namespace: testing</span><br><span class="line">spec:</span><br><span class="line">  podSelector: &#123;&#125;</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line"></span><br><span class="line">### 应用清单文件</span><br><span class="line">kubectl apply -f /cks/15/p1.yaml</span><br></pre></td></tr></table></figure>

<h3 id="考题8-NetworkPolicy"><a href="#考题8-NetworkPolicy" class="headerlink" title="考题8 - NetworkPolicy"></a>考题8 - NetworkPolicy</h3><h4 id="Task-6"><a href="#Task-6" class="headerlink" title="Task"></a>Task</h4><p>create a NetworkPolicy named <code>pod-restriction</code> to restrict access to Pod <code>products-service</code> running in namespace <code>dev-team</code>.<br>Only allow the following Pods to connect to Pod <code>products-service</code>:</p>
<ul>
<li>Pods in the namespace <code>qa</code></li>
<li>Pods with label <code>environment: testing</code>, in any namespace</li>
</ul>
<p>Make sure to apply the NetworkPolicy.<br>You can find a skelet on manifest file at <code>/cks/6/p1.yaml</code></p>
<p>创建一个名为 <code>pod-restriction</code> 的 NetworkPolicy 来限制对在 namespace <code>dev-team</code> 中运行的 Pod <code>products-service</code> 的访问。只允许以下 Pod 连接到 Pod <code>products-service</code>：</p>
<ul>
<li>namespace <code>qa</code> 中的 Pod</li>
<li>位于任何 namespace，带有标签 <code>environment: testing</code> 的 Pod</li>
</ul>
<p>注意：确保应用 NetworkPolicy。<br>你可以在<code>/cks/net/po.yaml</code> 找到一个模板清单文件。</p>
<h4 id="Solution-4"><a href="#Solution-4" class="headerlink" title="Solution"></a>Solution</h4><p>搜索 networkpolicy（网络策略）<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">### (1)查看命名空间 qa 具有的标签</span><br><span class="line">kubectl get namespace qa --show-labels</span><br><span class="line"></span><br><span class="line">### (2)查看 pod 具有的标签</span><br><span class="line">kubectl get pod products-service -n dev-team --show-labels</span><br><span class="line"></span><br><span class="line">### 修改模板清单文件</span><br><span class="line">vim /cks/net/po.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-restriction  # name</span><br><span class="line">  namespace: dev-team  # namespace</span><br><span class="line">spec:</span><br><span class="line">  podSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: products-service  # (2)</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line">  ingress:</span><br><span class="line">  - from:</span><br><span class="line">    - namespaceSelector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          name: qa  # (1)</span><br><span class="line">    - podSelector:  # 注意带 - ，表示或的关系</span><br><span class="line">        matchLabels:</span><br><span class="line">          environment: testing</span><br><span class="line">      namespaceSelector: &#123;&#125;    ## 任何命名空间, 不带 - ，且的关系</span><br><span class="line">### 应用清单文件</span><br><span class="line">kubectl apply -f /cks/net/po.yaml</span><br></pre></td></tr></table></figure>

<h3 id="考题9-RBAC"><a href="#考题9-RBAC" class="headerlink" title="考题9 - RBAC"></a>考题9 - RBAC</h3><h4 id="Context-3"><a href="#Context-3" class="headerlink" title="Context"></a>Context</h4><p>绑定到 Pod 的 ServiceAccount 的 Role 授予过度宽松的权限。完成以下项目以减少权限集。<br>A Role bound to a Pod’s serviceAccount grants overly permissive permissions.<br>Complete the following tasks to reduce the set of permissions.</p>
<h4 id="Task-7"><a href="#Task-7" class="headerlink" title="Task"></a>Task</h4><p>一个名为 <code>web-pod</code> 的现有 Pod 已在 namespace <code>db</code> 中运行。编辑绑定到 Pod 的 ServiceAccount <code>service-account-web</code> 的现有 Role， 仅允许只对 services 类型的资源执行 <code>get</code> 操作。</p>
<ul>
<li>在 namespace <code>db</code> 中创建一个名为 <code>role-2</code> ，并仅允许只对 <code>namespaces</code> 类型的资源执行 <code>delete</code> 操作的新 Role。</li>
<li>创建一个名为 <code>role-2-binding</code> 的新 RoleBinding，将新创建的 Role 绑定到 Pod 的 ServiceAccount。<br>注意：请勿删除现有的 RoleBinding。</li>
</ul>
<p>Given an existing Pod named <code>web-pod</code> running in the namespace <code>db</code>. Edit the existing Role bound to the Pod’s serviceAccount <code>sa-dev-1</code> to only allow performing <code>list</code> operations, only on resources of type <code>Endpoints</code>.</p>
<ul>
<li>create a new Role named <code>role-2</code> in the namespace <code>db</code>, which only allows performing <code>update</code> operations, only on resources of type <code>persistentvolumeclaims</code></li>
<li>create a new RoleBinding named <code>role-2-binding</code> binding the newly created Role to the Pod’s serviceAccount.</li>
</ul>
<p>Don’t delete the existing RoleBinding</p>
<h4 id="solution"><a href="#solution" class="headerlink" title="solution"></a>solution</h4><p>搜索 clusterrole（使用RBAC鉴权）<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">### 查询 sa 对应的 role 名称（假设是 role-1）</span><br><span class="line">kubectl get rolebinding -n db -oyaml | grep &#x27;service-account-web&#x27; -B 10</span><br><span class="line"></span><br><span class="line">### 修改 role 清单文件（仅允许对 services 类型的资源执行 get 操作）</span><br><span class="line">kubectl edit role -n db role-1</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: role-1</span><br><span class="line">  namespace: db</span><br><span class="line">  resourceVersion: &quot;9528&quot;</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">    - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">    - services</span><br><span class="line">  verbs:</span><br><span class="line">    - get</span><br><span class="line"></span><br><span class="line">### 创建新角色 role-2（仅允许只对 namespaces 类型的资源执行 delete 操作）</span><br><span class="line">kubectl create role role-2 -n db --verb=delete --resource=namespaces</span><br><span class="line"></span><br><span class="line">### 创建 rolebinding，并绑定到 sa 上</span><br><span class="line">kubectl create rolebinding role-2-binding --role=role-2 --serviceaccount=db:service-account-web</span><br></pre></td></tr></table></figure>

<h3 id="考题10-kube-apiserver-审计日志记录和采集"><a href="#考题10-kube-apiserver-审计日志记录和采集" class="headerlink" title="考题10 - kube-apiserver 审计日志记录和采集"></a>考题10 - kube-apiserver 审计日志记录和采集</h3><h4 id="Task-8"><a href="#Task-8" class="headerlink" title="Task"></a>Task</h4><p>Enable audit logs in the cluster.<br>To do so, enable the log backend, and ensure that:</p>
<ul>
<li>logs are stored at <code>/var/log/kubernetes/audit-logs.txt</code></li>
<li>log files are retained for <code>10</code> days</li>
<li>at maximum, a number of <code>2</code> auditlog files are retained<br>A basic policy is provided at <code>/etc/kubernetes/logpolicy/sample-policy.yaml</code>. it only specifies what not to log. The base policy is located on the cluster’s <code>master</code> node.</li>
</ul>
<p>Edit and extend the basic policy to log:</p>
<ul>
<li><code>namespaces</code> changes at <code>RequestResponse</code> level</li>
<li>the request body of pods changes in the namespace <code>front-apps</code></li>
<li><code>configMap</code> and <code>secret</code> changes in all namespaces at the <code>Metadata</code> level</li>
<li>Also, add a <code>catch-all</code> ruie to log all other requests at the <code>Metadata</code> level.</li>
</ul>
<p>Don’t forget to apply the modifiedpolicy.<br><code>/etc/kubernetes/logpolicy/sample-policy.yaml</code></p>
<p>在 cluster 中启用审计日志。为此，请启用日志后端，并确保：</p>
<ul>
<li>日志存储在 <code>/var/log/kubernetes/audit-logs.txt</code></li>
<li>日志文件能保留 <code>10</code> 天</li>
<li>最多保留 <code>2</code> 个旧审计日志文件<br>/etc/kubernetes/logpolicy/sample-policy.yaml 提供了基本策略。它仅指定不记录的内容。<br>注意：基本策略位于 cluster 的 master 节点上。</li>
</ul>
<p>编辑和扩展基本策略以记录：</p>
<ul>
<li>RequestResponse 级别的 cronjobs 更改</li>
<li>namespace front-apps 中 deployment 更改的请求体</li>
<li>Metadata 级别的所有 namespace 中的 ConfigMap 和 Secret 的更改</li>
<li>此外，添加一个全方位的规则以在 Metadata 级别记录所有其他请求。<br>注意：不要忘记应用修改后的策略</li>
</ul>
<h4 id="Solution-5"><a href="#Solution-5" class="headerlink" title="Solution"></a>Solution</h4><p>搜索 audit（审计）<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/audit/">https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/audit/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">### 如果没有 /var/log/kubernetes/，则创建目录</span><br><span class="line">mkdir /var/log/kubernetes/</span><br><span class="line"></span><br><span class="line">### 修改 audit 模板文件</span><br><span class="line">vim /etc/kubernetes/logpolicy/sample-policy.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">omitStages:</span><br><span class="line">  - &quot;RequestReceived&quot;</span><br><span class="line">rules:</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;cronjobs&quot;]</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;deployments&quot;]</span><br><span class="line">    namespaces: [&quot;front-apps&quot;]</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - &quot;RequestReceived&quot;</span><br><span class="line"></span><br><span class="line">### 修改 apiserver 配置文件，启用审计日志</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">--audit-policy-file=/etc/kubernetes/logpolicy/sample-policy.yaml</span><br><span class="line">--audit-log-path=/var/log/kubernetes/audit-logs.txt</span><br><span class="line">--audit-log-maxage=10</span><br><span class="line">--audit-log-maxbackup=2</span><br><span class="line"></span><br><span class="line">### 在 apiserver 的 Pod 上挂载策略文件和日志文件所在的目录（考试时可能已经挂载好）</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">volumeMounts:</span><br><span class="line">  - mountPath: /var/log/kubernetes</span><br><span class="line">    name: kubernetes-logs</span><br><span class="line">  - mountPath: /etc/kubernetes/logpolicy</span><br><span class="line">    name: kubernetes-policy</span><br><span class="line">volumes:</span><br><span class="line">- name: kubernetes-logs</span><br><span class="line">  hostPath:</span><br><span class="line">    path: /var/log/kubernetes</span><br><span class="line">- name: kubernetes-policy</span><br><span class="line">  hostPath:</span><br><span class="line">    path: /etc/kubernetes/logpolicy</span><br><span class="line"></span><br><span class="line">### 重载生效配置</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h3 id="考题11-Secret"><a href="#考题11-Secret" class="headerlink" title="考题11 - Secret"></a>考题11 - Secret</h3><h4 id="Task-9"><a href="#Task-9" class="headerlink" title="Task"></a>Task</h4><p>Retrieve the content of the existing secret named <code>db1-test</code> in the <code>istio-system</code> namespace.<br>store the username field in a file named <code>/home/candidate/user.txt</code>, and the password field in a file named <code>/home/candidate/pass</code>.txt.</p>
<p>You must create both files; they don’t exist yet.<br>Do not use/modify the created files in the following steps, create new temporary files if needed.</p>
<p>Create a new secret named <code>db2-test</code> in the <code>istio-system</code> namespace, with the following</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username : production-instance</span><br><span class="line">password : KvLftKgs4aVH</span><br></pre></td></tr></table></figure>

<p>Finally, create a new Pod that has access to the secret db2-test via a volume:</p>
<ul>
<li>Pod name <code>secret-pod</code></li>
<li>Namespace <code>istio-system</code></li>
<li>container name <code>dev-container</code></li>
<li>image <code>nginx</code></li>
<li>volume name <code>secret-volume</code></li>
<li>mount path <code>/etc/secret</code></li>
</ul>
<p>在 namespace <code>istio-system</code> 中获取名为 <code>db1-test</code> 的现有 secret 的内容.<br>将 username 字段存储在名为 <code>/cks/sec/user.txt</code> 的文件中，并将 password 字段存储在名为 <code>/cks/sec/pass.txt</code> 的文件中。</p>
<p>注意：你必须创建以上两个文件，他们还不存在。<br>注意：不要在以下步骤中使用/修改先前创建的文件，如果需要，可以创建新的临时文件。</p>
<p>在 <code>istio-system</code> namespace 中创建一个名为 <code>db2-test</code> 的新 secret，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username : production-instance</span><br><span class="line">password : KvLftKgs4aVH</span><br></pre></td></tr></table></figure>

<p>最后，创建一个新的 Pod，它可以通过卷访问 secret <code>db2-test</code> ：</p>
<ul>
<li>Pod 名称 <code>secret-pod</code></li>
<li>Namespace <code>istio-system</code></li>
<li>容器名 <code>dev-container</code></li>
<li>镜像 <code>nginx</code></li>
<li>卷名 <code>secret-volume</code></li>
<li>挂载路径 <code>/etc/secret</code></li>
</ul>
<h4 id="Solution-6"><a href="#Solution-6" class="headerlink" title="Solution"></a>Solution</h4><p>搜索 secret（使用 kubectl 管理 Secret）<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/">https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/</a><br>搜索 secret（Secret）<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/">https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">### 检索已存在的 secret，将获取到的用户名和密码字段存储到指定文件</span><br><span class="line">kubectl get secrets db2-test -o jsonpath=&#x27;&#123;.data.username&#125;&#x27; | base64 -d &gt; /home/candidate/user.txt</span><br><span class="line">kubectl get secrets db2-test -o jsonpath=&#x27;&#123;.data.password&#125;&#x27; | base64 -d &gt; /home/candidate/pass.txt</span><br><span class="line"></span><br><span class="line">### 创建 secret</span><br><span class="line">kubectl -n istio-system create secret generic db2-test --from-literal=username=production-instance --from-literal=password=KvLftKgs4aVH </span><br><span class="line"># kubectl create secret generic db2-test -n istio-system --from-literal username=production-instance --from-literal password=KvLftKgs4aVH</span><br><span class="line"># error: exactly one NAME is required, got 2</span><br><span class="line"></span><br><span class="line">### 在 Pod 中以文件形式使用 Secret</span><br><span class="line">vim k8s-secret.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: secret-pod</span><br><span class="line">  namespace: istio-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: dev-container</span><br><span class="line">    image: nginx</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: secret-volume</span><br><span class="line">      mountPath: &quot;/etc/secret&quot;</span><br><span class="line">      readOnly: true</span><br><span class="line">  volumes:</span><br><span class="line">  - name: secret-volume</span><br><span class="line">    secret:</span><br><span class="line">      secretName: db2-test</span><br><span class="line">      optional: false</span><br><span class="line"></span><br><span class="line">### 应用清单文件</span><br><span class="line">kubectl apply -f k8s-secret.yaml</span><br><span class="line"></span><br><span class="line">### 验证 pod</span><br><span class="line">kubectl get pods -n istio-system dev-pod</span><br></pre></td></tr></table></figure>

<h3 id="考题12-dockerfile-和-deployment-安全优化"><a href="#考题12-dockerfile-和-deployment-安全优化" class="headerlink" title="考题12 - dockerfile 和 deployment 安全优化"></a>考题12 - dockerfile 和 deployment 安全优化</h3><h4 id="Task-10"><a href="#Task-10" class="headerlink" title="Task"></a>Task</h4><ul>
<li>Analyze and edit the given Dockerfile (based on the ubuntu:16.04 image) <code>/cks/docker/Dockerfile</code> fixing two instructions present in the file being prominent security/best-practice issues.</li>
<li>Analyze and edit the given manifest file <code>/cks/docker/deployment.yaml</code> fixing two fields present in the file being prominent security/best-practice issues.</li>
</ul>
<p>Don’t add or remove configuration settings; only modify the existing configuration settings, so that two configuration settings each are no longer security/best-practice concerns.</p>
<p>Should you need an unprivileged user for any of the tasks, use user <code>nobody</code> with user id <code>65535</code>.</p>
<blockquote>
<ul>
<li>分析和编辑给定的 Dockerfile <code>/cks/docker/Dockerfile</code>（基于 ubuntu:16.04 镜像），并修复在文件中拥有的突出的安全/最佳实践问题的两个指令。</li>
<li>分析和编辑给定的清单文件 <code>/cks/docker/deployment.yaml</code>，并修复在文件中拥有突出的安全/最佳实践问题的两个字段。</li>
</ul>
<p>注意：请勿添加或删除配置设置；只需修改现有的配置设置让以上两个配置设置都不再有安全/最佳实践问题。<br>注意：如果您需要非特权用户来执行任何项目，请使用用户 ID 65535 的用户 nobody 。<br>答题： 注意，本次的 Dockerfile 和 deployment.yaml 仅修改即可，无需部署。</p>
</blockquote>
<h4 id="Solution-12"><a href="#Solution-12" class="headerlink" title="Solution 12"></a>Solution 12</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">### 修复 dockerfile 文件中存在的两个安全/最佳实践指令</span><br><span class="line">### (1)把ubuntu:latest改为ubuntu:16.04 (2)将 root 注释掉；增加 nobody</span><br><span class="line">vim /cks/docker/Dockerfile</span><br><span class="line"># FROM ubuntu:latest  1 修改</span><br><span class="line">FROM ubuntu:16.04</span><br><span class="line">#USER root </span><br><span class="line">USER nobody # 2</span><br><span class="line"></span><br><span class="line">### 修复 deployment 文件中存在的两个安全/最佳实践问题字段</span><br><span class="line">### (1)将 privileged 变为 False；(2)将 readOnlyRootFilesystem 变为 True 3 check runAsUser 65535</span><br><span class="line">vim /cks/docker/deployment.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: dev</span><br><span class="line">  name: dev</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: dev</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: dev</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: mysql</span><br><span class="line">        name: mysql</span><br><span class="line">        securityContext: &#123;&#x27;capabilities&#x27;:&#123;&#x27;add&#x27;:[&#x27;NET_ADMIN&#x27;],&#x27;drop&#x27;:[&#x27;all&#x27;]&#125;,&#x27;privileged&#x27;: False,&#x27;readOnlyRootFilesystem&#x27;: True, &#x27;runAsUser&#x27;: 65535&#125;</span><br></pre></td></tr></table></figure>

<h3 id="考题13-admission-controllers-ImagePolicyWebhook"><a href="#考题13-admission-controllers-ImagePolicyWebhook" class="headerlink" title="考题13 - admission-controllers - ImagePolicyWebhook"></a>考题13 - admission-controllers - ImagePolicyWebhook</h3><h4 id="Context-4"><a href="#Context-4" class="headerlink" title="Context"></a>Context</h4><p>A container image scanner is set up on the cluster, but it’s not yet fully integrated into the cluster’s configuration. When complete, the container image scanner shall scan for and reject the use of vulnerable images.</p>
<p>cluster 上设置了容器镜像扫描器，但尚未完全集成到 cluster 的配置中。完成后，容器镜像扫描器应扫描并拒绝易受攻击的镜像的使用。</p>
<h4 id="Task-11"><a href="#Task-11" class="headerlink" title="Task"></a>Task</h4><p>You have to complete the entire task on the cluster’s <code>master</code> node, where all services and files have been prepared and placed.<br>Given an incomplete configuration in directory <code>/etc/kubernetes/epconfig</code> and a functional container image scanner with HTTPS endpoint <code>https://acme.local:8082/image_policy</code>:</p>
<ol>
<li>Enable the necessary plugins to create an image policy</li>
<li>validate the control configuration and change it to an implicit deny</li>
<li>Edit the configuration to point to the provided HTTPS endpoint correctly.</li>
<li>Finally , test if the configuration is working by trying to deploy the vulnerable resource <code>/cks/1/web1.yaml</code></li>
</ol>
<p>You can find the container image scanner’s log file at <code>/var/loglimagepolicyiacme.log</code></p>
<p>注意：你必须在 cluster 的 master 节点上完成整个考题，所有服务和文件都已被准备好并放置在该节点上。 给定一个目录 <code>/etc/kubernetes/epconfig</code> 中不完整的配置以及具有 HTTPS 端点 <code>https://acme.local:8082/image_policy</code> 的功能性容器镜像扫描器：</p>
<ol>
<li>启用必要的插件来创建镜像策略</li>
<li>校验控制配置并将其更改为隐式拒绝（implicit deny）</li>
<li>编辑配置以正确指向提供的 HTTPS 端点</li>
<li>最后，通过尝试部署易受攻击的资源 <code>/cks/img/web1.yaml</code> 来测试配置是否有效。</li>
</ol>
<p>你可以在 <code>/var/log/imagepolicy/roadrunner.log</code> 找到容器镜像扫描仪的日志文件。</p>
<h4 id="Solution-7"><a href="#Solution-7" class="headerlink" title="Solution"></a>Solution</h4><p>搜索 imagepolicywebhook（使用准入控制器），接着再搜索字符串”imagepolicywebhook”<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># 0 master node</span><br><span class="line">ssh masterNode</span><br><span class="line"></span><br><span class="line">cd /etc/kubernetes/epconfig</span><br><span class="line">ls</span><br><span class="line">  admission_configuration.json kubeconfig.yaml</span><br><span class="line"></span><br><span class="line">###  查看config-file路径</span><br><span class="line">cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep --admission-control-config-file</span><br><span class="line">    - --admission-control-config-file=/etc/kubernetes/epconfig/admission_configuration.json </span><br><span class="line"></span><br><span class="line">### 1 验证控制平面的配置并将其更改为拒绝</span><br><span class="line">vim /etc/kubernetes/epconfig/admission_configuration.json</span><br><span class="line">&#123;</span><br><span class="line">   &quot;apiVersion&quot;: &quot;apiserver.config.k8s.io/v1&quot;,</span><br><span class="line">   &quot;kind&quot;: &quot;AdmissionConfiguration&quot;,</span><br><span class="line">   &quot;plugins&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;name&quot;: &quot;ImagePolicyWebhook&quot;,</span><br><span class="line">         &quot;configuration&quot;: &#123;</span><br><span class="line">            &quot;imagePolicy&quot;: &#123;</span><br><span class="line">               &quot;kubeConfigFile&quot;: &quot;/etc/kubernetes/epconfig/kubeconfig.yaml&quot;, // 1.1 kubeconfig</span><br><span class="line">               &quot;allowTTL&quot;: 100,</span><br><span class="line">               &quot;denyTTL&quot;: 50,</span><br><span class="line">               &quot;retryBackoff&quot;: 500,</span><br><span class="line">               &quot;defaultAllow&quot;: false   // 1.2 modify from true to false</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">### 2 编辑配置以正确指向提供的 HTTPS 端点</span><br><span class="line">vim kubeconfig.yaml</span><br><span class="line">    apiVersion: v1</span><br><span class="line">    kind: Config</span><br><span class="line">    clusters:</span><br><span class="line">    - cluster:</span><br><span class="line">        certificate-authority: /etc/kubernetes/epconfig/webhook.pem</span><br><span class="line">        server: https://acme.local:8082/image_policy   # 2 配置此步</span><br><span class="line">    name: bouncer_webhook</span><br><span class="line"></span><br><span class="line">### 3 启用必要的插件以创建镜像策略</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line">    - --enable-admission-plugins=NodeRestriction,ImagePolicyWebhook  # 3.1 Add ImagePolicyWebhook</span><br><span class="line">    - --admission-control-config-file=/etc/kubernetes/epconfig/admission_configuration.json  # 3.2 Check config-file path</span><br><span class="line">    ......</span><br><span class="line">    volumeMounts:                         # 3.3 Check Mount, can search audit log in kubernetes.io</span><br><span class="line">    - mountPath: /etc/kubernetes/epconfig</span><br><span class="line">      name: config</span><br><span class="line">      readyOnly: false</span><br><span class="line">  volumes:</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/kubernetes/epconfig</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: config</span><br><span class="line"></span><br><span class="line">### 4 加载生效配置</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line">### 5 通过部署易受攻击的资源来测试配置是否有效</span><br><span class="line">kubectl apply -f /cks/img/web1.yaml</span><br></pre></td></tr></table></figure>

<h3 id="考题14-删除非无状态或非不可变的-pod"><a href="#考题14-删除非无状态或非不可变的-pod" class="headerlink" title="考题14 - 删除非无状态或非不可变的 pod"></a>考题14 - 删除非无状态或非不可变的 pod</h3><p>Context: it is best-practice to design containers to be stateless and immutable</p>
<h4 id="Task-12"><a href="#Task-12" class="headerlink" title="Task"></a>Task</h4><p>Inspect Pods runnings in namespace <code>production</code> and delete any Pod that is either not stateless or not immutable.</p>
<p>Use the following strict interpretation of stateless and immutable:</p>
<ul>
<li>Pod being able to store data inside containers must be treated as not stateless. You don’t have to worry whether data is actually stored inside containers or not already.</li>
<li>Pod being configured to be <code>privileged</code> in any way must be treated as potentially not stateless and not immutable.</li>
</ul>
<p>检查在 namespace production 中运行的 Pod，并删除任何非无状态或非不可变的 Pod。<br>使用以下对无状态和不可变的严格解释：</p>
<ul>
<li>能够在容器内存储数据的 Pod 的容器必须被视为非无状态的。</li>
<li>被配置为任何形式的特权 Pod 必须被视为可能是非无状态和非不可变的。<br>注意：你不必担心数据是否实际上已经存储在容器中。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">### 在命名空间 dev 中检查 running 状态的 pod</span><br><span class="line">kubectl get pods -n production | grep running -i</span><br><span class="line"></span><br><span class="line">### 查看具有特权的 pod</span><br><span class="line">kubectl get pods -n production -oyaml | grep -i &quot;privileged: true&quot;</span><br><span class="line"></span><br><span class="line">### 查看具有 volume 的 pod</span><br><span class="line"># jq 用于处理JSON输入，将给定过滤器应用于其JSON文本输入并在标准输出上将过滤器的结果生成为JSON。</span><br><span class="line">kubectl get pods -n production -o jsonpath=&#123;.spec.volumes&#125; | jq</span><br><span class="line"></span><br><span class="line">### 将查询到的具有特权和 volume 的 pod 都删除</span><br><span class="line">kubectl delete pods -n production pod名称</span><br></pre></td></tr></table></figure>

<h3 id="考题15-gVisor-runtimeclass"><a href="#考题15-gVisor-runtimeclass" class="headerlink" title="考题15 - gVisor/runtimeclass"></a>考题15 - gVisor/runtimeclass</h3><h4 id="Context-5"><a href="#Context-5" class="headerlink" title="Context"></a>Context</h4><p>This cluster uses containerd as CRI runtime.<br>Containerd’s default runtime handler is <code>runc</code> . Containerd has been prepared to support an additional runtime handler , <code>runsc</code> (gVisor).</p>
<blockquote>
<p>该 cluster 使用 containerd 作为 CRI 运行时。<br>containerd 的默认运行时处理程序是 <code>runc</code>。 containerd 已准备好支持额外的运行时处理程序 <code>runsc</code> (gVisor)。</p>
</blockquote>
<h4 id="Task-13"><a href="#Task-13" class="headerlink" title="Task"></a>Task</h4><p>Create a RuntimeClass named <code>untrusted</code> using the prepared runtime handler named <code>runsc</code>.<br>Update all Pods in the namespace <code>server</code> to run on gvisor, unless they are already running on <code>anon-default</code> runtime handler.<br>You can find a skeleton manifest file at <code>/cks/13/rc.yaml</code></p>
<blockquote>
<p>使用名为 <code>runsc</code> 的现有运行时处理程序，创建一个名为 <code>untrusted</code> 的 RuntimeClass。<br>更新 namespace <code>server</code> 中的所有 Pod 以在 gVisor 上运行。<br>您可以在 <code>/cks/gVisor/rc.yaml</code> 中找到一个模版清单</p>
</blockquote>
<h4 id="Solution-8"><a href="#Solution-8" class="headerlink" title="Solution"></a>Solution</h4><p>搜索 runtimeclass（容器运行时类）<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/containers/runtime-class/">https://kubernetes.io/zh-cn/docs/concepts/containers/runtime-class/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">### 修改模板清单文件</span><br><span class="line">vim /cks/gVisor/rc.yaml</span><br><span class="line">    apiVersion: node.k8s.io/v1</span><br><span class="line">    kind: RuntimeClass</span><br><span class="line">    metadata:</span><br><span class="line">      name: untrusted</span><br><span class="line">    handler: runsc</span><br><span class="line"></span><br><span class="line">### 应用清单文件</span><br><span class="line">kubectl apply -f /cks/gVisor/rc.yaml</span><br><span class="line"></span><br><span class="line">### 修改 server 命名空间下的所有 pod（还需要修改deployment）</span><br><span class="line">kubectl get pods -n server</span><br><span class="line">kubectl get deployments -n server</span><br><span class="line"></span><br><span class="line">kubectl get pods -n server -oyaml &gt; myrc.yaml</span><br><span class="line">vim myrc.yaml</span><br><span class="line">spec:</span><br><span class="line">  ......</span><br><span class="line">  runtimeClassName: untrusted</span><br><span class="line"></span><br><span class="line">### 更新清单文件</span><br><span class="line">kubectl delete -f myrc.yaml</span><br><span class="line">kubectl apply -f myrc.yaml</span><br></pre></td></tr></table></figure>

<h3 id="考题16-启用-API-Server-认证"><a href="#考题16-启用-API-Server-认证" class="headerlink" title="考题16 - 启用 API Server 认证"></a>考题16 - 启用 API Server 认证</h3><h4 id="Context-6"><a href="#Context-6" class="headerlink" title="Context"></a>Context</h4><p>由 kubeadm 创建的 cluster 的 Kubernetes API 服务器，出于测试目的，临时配置允许未经身份验证和未经授权的访问，授予匿名用户 <code>cluster-admin</code> 的访问权限。</p>
<h4 id="Task-14"><a href="#Task-14" class="headerlink" title="Task"></a>Task</h4><p>重新配置 cluster 的 Kubernetes API 服务器，以确保<strong>只允许经过身份验证和授权</strong>的 REST 请求。<br>使用授权模式 <code>Node</code>,<code>RBAC</code> 和准入控制器 <code>NodeRestriction。</code><br>删除用户 <code>system:anonymous</code> 的 ClusterRoleBinding 来进行清理。<br>注意：所有 kubectl 配置环境/文件也被配置使用未经身份验证和未经授权的访问。 你不必更改它，但请注意，一旦完成 cluster 的安全加固， kubectl 的配置将无法工作。 您可以使用位于 cluster 的 master 节点上，cluster 原本的 kubectl 配置文件 /etc/kubernetes/admin.conf ，以确保经过身份验证的授权的请求仍然被允许。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">k get nodes</span><br><span class="line"></span><br><span class="line">### 注意：修改 master 节点！</span><br><span class="line">ssh masterNode</span><br><span class="line"></span><br><span class="line">### (1)使用授权模式 Node,RBAC 和准入控制器 NodeRestriction</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">    - --authorization-mode=Node,RBAC              # modify  Node,RBAC </span><br><span class="line">    - --enable-admission-plugins=NodeRestriction  # modify  NodeRestriction</span><br><span class="line">    - --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --enable-bootstrap-token-auth=true</span><br><span class="line"></span><br><span class="line">### (2)删除 system:anonymous 的 ClusterRolebinding 角色绑定（取消匿名用户的集群管理员权限）</span><br><span class="line">k get clusterrolebinding -A | grep system:anonymous</span><br><span class="line">kubectl delete clusterrolebinding system:anonymous</span><br></pre></td></tr></table></figure>

<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li>CKS 真题<ul>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/638db1b2dacf622b8df8c678.html">2022年11月最新CKS认证题库</a></li>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/638db1a8dacf622b8df8c643.html?spm=1001.2101.3001.6650.5&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~activity-5-126962402-blog-123994683.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~activity-5-126962402-blog-123994683.pc_relevant_default&utm_relevant_index=6">2022.10 CKS考试题库v1.24</a></li>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/638db200dacf622b8df8c7f0.html?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2~default~YuanLiJiHua~activity-3-127131284-blog-123994683.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~YuanLiJiHua~activity-3-127131284-blog-123994683.pc_relevant_default&utm_relevant_index=4">2022.10 CKS 1.24真题解析</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/cloud_engineer/article/details/125709403?spm=1001.2101.3001.6650.7&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-7-125709403-blog-123994683.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-7-125709403-blog-123994683.pc_relevant_default&utm_relevant_index=8">2022.8 kubernets CKS内容及题库</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zfw_666666/article/details/125185751">2022.6 CKS认证考题+解析</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/april_4?type=blog">2022.3 CKS 1.23 真题</a></li>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/63311d5fd3efff3090b52a1e.html?spm=1001.2101.3001.6650.9&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~activity-9-122525427-blog-123994683.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~activity-9-122525427-blog-123994683.pc_relevant_default&utm_relevant_index=10">2022.1 cks 试题</a></li>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/638db4efdacf622b8df8cc95.html">2021.12 Kubernetes CKS 1.20 - 真题 15道题</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/itsaka/category_11111851.html">2021 Kubernetes CKS 1.20 - 真题 15道题</a></li>
</ul>
</li>
<li>CKS其他<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011127242/article/details/125822057">CKS考试知识点链接</a></li>
</ul>
</li>
</ul>
<p>From: <a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernates-Certified%20Kubernetes%20Security%20Specialist-CKS.html">http://liyuankun.top/Kubernates-Certified%20Kubernetes%20Security%20Specialist-CKS.html</a></p>
<hr>
<h1 id="真题③基于1-22版本"><a href="#真题③基于1-22版本" class="headerlink" title="真题③基于1.22版本"></a>真题③基于1.22版本</h1><p>1、Pod 指定 ServiceAccount</p>
<p>Task </p>
<ol>
<li>在现有 namespace qa 中创建一个名为 backend-sa 的新 ServiceAccount， 确保此<br>ServiceAccount 不自动挂载 API 凭据。 </li>
<li>使用 /cks/sa/pod1.yaml 中的清单文件来创建一个 Pod。</li>
<li>最后，清理 namespace qa 中任何未使用的 ServiceAccount。</li>
</ol>
<p>2、RBAC - RoleBinding<br>Context 绑定到 Pod 的 ServiceAccount 的 Role 授予过度宽松的权限。完成以下项目以减少权限集。 </p>
<p>Task</p>
<p>一个名为 web-pod 的现有 Pod 已在 namespace db 中运行。 编辑绑定到 Pod 的 ServiceAccount service-account-web 的现有 Role， 仅允许只对 services 类型的资源 执行 get 操作。 在namespace db 中创建一个名为 role-2 ，并仅允许只对 namespaces 类型的资源执行 delete 操作的新Role。 创建一个名为 role-2-binding 的新 RoleBinding，将新创建的 Role 绑定到 Pod 的ServiceAccount。 注意：请勿删除现有的 RoleBinding。</p>
<p>3、启用 API server 认证<br>Context 由 kubeadm 创建的 cluster 的 Kubernetes API 服务器，出于测试目的，临时配置允许未经身份验证和未经授权的访问，授予匿名用户 cluster-admin 的访问权限. </p>
<p>Task </p>
<p>重新配置 cluster 的Kubernetes APl 服务器，以确保只允许经过身份验证和授权的 REST 请求。 使用授权模式 Node,RBAC 和准入控制器<br>NodeRestriction。 删除用户 system:anonymous 的 ClusterRoleBinding 来进行清理。</p>
<p>注意：所有 kubectl 配置环境/文件也被配置使用未经身份验证和未经授权的访问。 你不必更改它，但请注意，一旦完成 cluster<br>的安全加固， kubectl 的配置将无法工作。 您可以使用位于 cluster 的 master 节点上，cluster 原本的kubectl 配置文件 /etc/kubernetes/admin.conf ，以确保经过身份验证的授权的请求仍然被允许。</p>
<p>4、Sysdig &amp; falco<br>Task： </p>
<p>使用运行时检测工具来检测 Pod tomcat 单个容器中频发生成和执行的异常进程。 有两种工具可供使用：</p>
<p>⚫ sysdig<br>⚫ falco </p>
<p>注： 这些工具只预装在 cluster 的工作节点，不在 master 节点。 使用工具至少分析 30 秒，使用过滤器检查生成和执行的进程，将事件写到 /opt/KSR00101/incidents/summary 文件中，其中包含检测的事件， 格式如下： [timestamp],[uid],[processName] 保持工具的原始时间戳格式不变。 </p>
<p>注：确保事件文件存储在集群的工作节点上。</p>
<p>5、 容器安全，删除特权 Pod<br>Task</p>
<p>检查在 namespace production 中运行的 Pod，并删除任何非无状态或非不可变的 Pod。<br>使用以下对无状态和不可变的严格解释： </p>
<p>⚫ 能够在容器内存储数据的 Pod 的容器必须被视为非无状态的。<br>注意：你不必担心数据是否实际上已经存储在容器中。 </p>
<p>⚫ 被配置为任何形式的特权 Pod 必须被视为可能是非无状态和非不可变的。</p>
<p>6、沙箱运行容器 gVisor<br>Context 该 cluster 使用 containerd 作为 CRI 运行时。containerd 的默认运行时处理程序是runc。 containerd 已准备好支持额外的运行时处理程序 runsc (gVisor)。 Task 使用名为 runsc的现有运行时处理程序，创建一个名为 untrusted 的 RuntimeClass。 更新 namespace server 中的所有Pod 以在 gVisor 上运行。 </p>
<p>您可以在 /cks/gVisor/rc.yaml 中找到一个模版清单</p>
<p>7、Pod 安全策略-PSP<br>Context PodSecurityPolicy 应防在特定 namespace 中特权 Pod 的创建。 Task 创建一个名为restrict-policy 的新的PodSecurityPolicy，以防止特权 Pod 的创建。 创建一个名为restrict-access-role 并使用新创建的 PodSecurityPolicy restrict-policy 的ClusterRole。 在现有的 namespace staging 中创建一个名为 psp-denial-sa 的新ServiceAccount 。最后，创建一个名为 dany-access-bind 的 ClusterRoleBinding ，将新创建的 ClusterRole restrict-access-role 绑定到新创建的 ServiceAccount psp-denial-sa。 </p>
<p>你可以在一下位置找到模版清单文件： /cks/psp/psp.yaml</p>
<p>8、创建 Secret<br>Task</p>
<p>在 namespace istio-system 中获取名为 db1-test 的现有 secret 的内容 将 username字段存储在名为 /cks/sec/user.txt 的文件中，并将 password 字段存储在名为 /cks/sec/pass.txt 的文件 中。注意：你必须创建以上两个文件，他们还不存在。 注意：不要在以下步骤中使用/修改先前创建的文件，如果需要，可以创建新的临时文件。</p>
<p>在 istio-system namespace 中创建一个名为 db2-test 的新 secret，内容如下： </p>
<p>username : production-instance</p>
<p>password : KvLftKgs4aVH</p>
<p>最后，创建一个新的 Pod，它可以通过卷访问 secret db2-test ： </p>
<p>Pod 名称 secret-pod </p>
<p>Namespace istio-system </p>
<p>容器名 dev-container</p>
<p>镜像 nginx </p>
<p>卷名 secret-volume </p>
<p>挂载路径 /etc/secret</p>
<p>9、AppArmor<br>Context</p>
<p>APPArmor 已在 cluster 的工作节点上被启用。一个 APPArmor 配置文件已存在，但尚未被实施</p>
<p>Task<br>在 cluster 的工作节点上，实施位于 /etc/apparmor.d/nginx_apparmor 的现有 APPArmor配置文件。 编辑位于 /home/candidate/KSSH00401/nginx-deploy.yaml 的现有清单文件以应用 AppArmor 配置文件。 最后，应用清单文件并创建其中指定的 Pod 。</p>
<p>10、kube-bench 修复不安全项<br>Context 针对 kubeadm 创建的 cluster 运行 CIS 基准测试工具时， 发现了多个必须立即解决的问题。 </p>
<p>Task<br>通过配置修复所有问题并重新启动受影响的组件以确保新的设置生效。 </p>
<p>修复针对 API 服务器发现的所有以下违规行为： </p>
<p>1.2.7 Ensure that the –authorization-mode argument is not set to AlwaysAllow </p>
<p>1.2.8 Ensure that the –authorization-mode argument includes Node</p>
<p>1.2.9 Ensure that the –authorization-mode argument includes RBAC</p>
<p>1.2.18 Ensure that the –insecure-bind-address argument is not set </p>
<p>1.2.19 Ensure that the –insecure-port argument is set to 0 </p>
<p>FAIL FAIL FAIL FAIL FAIL </p>
<p>修复针对 kubelet 发现的所有以下违规行为： </p>
<p>Fix all of the following violations that were found against the kubelet: 4.2.1 </p>
<p>Ensure that the anonymous-auth argument is set to false 4.2.2 </p>
<p>Ensure that the –authorization-mode argument is not set to AlwaysAllow </p>
<p>FAIL FAIL</p>
<p>注意：尽可能使用 Webhook 身份验证/授权。 </p>
<p>修复针对 etcd 发现的所有以下违规行为： </p>
<p>Fix all of the following violations that were found against etcd: </p>
<p>2.2 Ensure that the –client-cert-auth argument is set to true FAIL</p>
<p>11、网络策略 NetworkPolicy<br>Task</p>
<p>创建一个名为 pod-restriction 的 NetworkPolicy 来限制对在 namespace dev-team 中运行的 Pod products-service 的访问。 只允许以下 Pod 连接到 Pod products-service </p>
<p>⚫ namespace qa 中的 Pod </p>
<p>⚫ 位于任何 namespace，带有标签 environment: testing 的 Pod</p>
<p>注意：确保应用 NetworkPolicy。 你可以在/cks/net/po.yaml 找到一个模板清单文件。</p>
<p>12、Dockerfile 检测<br>Task </p>
<p>分析和编辑给定的 Dockerfile /cks/docker/Dockerfile（基于 ubuntu:16.04 镜像），<br>并修复在文件中拥有的突出的安全/最佳实践问题的两个指令。 分析和编辑给定的清单文件 /cks/docker/deployment.yaml<br>， 并修复在文件中拥有突出的安全/最佳实践问题的两个字段。<br>注意：请勿添加或删除配置设置；只需修改现有的配置设置让以上两个配置设置都不再有安全/最佳实践问题。<br>注意：如果您需要非特权用户来执行任何项目，请使用用户 ID 65535 的用户 nobody 。 答题： 注意，本次的 Dockerfile<br>和 deployment.yaml 仅修改即可，无需部署。</p>
<p>13、ImagePolicyWebhook 容器镜像扫描<br>Context</p>
<p>cluster 上设置了容器镜像扫描器，但尚未完全集成到 cluster 的配置中。完成后，容器镜像扫描器应扫描并拒绝易受攻击的镜像的使用。 </p>
<p>Task</p>
<p>注意：你必须在 cluster 的 master 节点上完成整个考题，所有服务和文件都已被准备好并放置在该节点上。 </p>
<p>给定一个目录 /etc/kubernetes/epconfig 中不完整的配置以及具有 HTTPS 端点 <a target="_blank" rel="noopener" href="https://acme.local:8082/image_policy">https://acme.local:8082/image_policy</a> 的功能性容器镜像扫描器：</p>
<ol>
<li><p>启用必要的插件来创建镜像策略 </p>
</li>
<li><p>校验控制配置并将其更改为隐式拒绝（implicit deny）</p>
</li>
<li><p>编辑配置以正确指向提供的 HTTPS 端点</p>
</li>
<li><p>最后，通过尝试部署易受攻击的资源 /cks/img/web1.yaml 来测试配置是否有效。 </p>
</li>
</ol>
<p>你可以在 /var/log/imagepolicy/roadrunner.log 找到容器镜像扫描仪的日志文件。</p>
<p>14、Trivy 扫描镜像安全漏洞<br>Task</p>
<p>使用 Trivy 开源容器扫描器检测 namespace kamino 中 Pod 使用的具有严重漏洞的镜像。 查找具有 High 或 Critical 严重性漏洞的镜像，并删除使用这些镜像的 Pod。 </p>
<p>注意：Trivy 仅安装在 cluster 的 master 节点上， 在工作节点上不可使用。 你必须切换到 cluster 的 master 节点才能使用 Trivy</p>
<p>15、默认网络策略<br>Context </p>
<p>一个默认拒绝（default-deny）的 NetworkPolicy 可避免在未定义任何其他 NetworkPolicy 的 namespace 中 意外公开 Pod。</p>
<p> Task</p>
<p>为所有类型为 Ingress+Egress 的流量在 namespace testing 中创建一个名为 denypolicy 的新默认拒绝 NetworkPolicy。 此新的 NetworkPolicy 必须拒绝 namespace testing 中的所有的 Ingress + Egress 流量。 将新创建的默认拒绝 NetworkPolicy 应用与在 namespace testing 中运行的所有 Pod。 </p>
<p>你可以在 /cks/net/p1.yaml 找到一个模板清单文件。</p>
<p>16、日志审计 log audit<br>Task</p>
<p>在 cluster 中启用审计日志。为此，请启用日志后端，并确保：<br>⚫ 日志存储在 <code>/var/log/kubernetes/audit-logs.txt</code><br>⚫ 日志文件能保留 10 天<br>⚫ 最多保留 2 个旧审计日志文件<br>/etc/kubernetes/logpolicy/sample-policy.yaml 提供了基本策略。它仅指定不记录的内容。<br>注意：基本策略位于 cluster 的 master 节点上。 编辑和扩展基本策略以记录：<br>⚫ RequestResponse 级别的<br>cronjobs 更改<br>⚫ namespace front-apps 中 deployment 更改的请求体<br>⚫ Metadata级别的所有 namespace 中的 ConfigMap 和 Secret 的更改 此外，添加一个全方位的规则以在 Metadata<br>级别记录所有其他请求。 注意：不要忘记应用修改后的策略</p>
<hr>
<h1 id="真题④基于1-22版本"><a href="#真题④基于1-22版本" class="headerlink" title="真题④基于1.22版本"></a>真题④基于1.22版本</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/alwaysbefine/article/details/128689488">云原生|kubernetes|2022年底cks真题解析（1-10）_cks试题_晚风_END的博客-CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/alwaysbefine/article/details/128717226">云原生|kubernetes|2022年底cks真题解析（11-16）_晚风_END的博客-CSDN博客</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-07-30T15:01:25.578Z" title="7/30/2022, 11:01:25 PM">2022-07-30</time>发表</span><span class="level-item"><time dateTime="2022-07-30T15:01:25.578Z" title="7/30/2022, 11:01:25 PM">2022-07-30</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">12 分钟读完 (大约1846个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/30/ceffd765678b.html">CKA备考心得！这证没有值不值，想拿就拿就完了！</a></h1><div class="content"><blockquote>
<p>如果拿到证后，能报销考试费，或者有补贴，上车就完事了</p>
</blockquote>
<h2 id="报考"><a href="#报考" class="headerlink" title="报考"></a>报考</h2><h3 id="CKA-or-CKA-CN"><a href="#CKA-or-CKA-CN" class="headerlink" title="CKA or CKA-CN"></a>CKA or CKA-CN</h3><ul>
<li>CKA 英文试题、监考官和你用英文和你聊天、考试时出示证件为护照；</li>
<li>CKA-CN 中文试题、监考官用中文和你聊天、考试时出示证件为身份证。</li>
</ul>
<h3 id="报名"><a href="#报名" class="headerlink" title="报名"></a>报名</h3><ul>
<li>地址：<a target="_blank" rel="noopener" href="https://training.linuxfoundation.cn/certificates/1">CKA (Certified Kubernetes Administrator) (linuxfoundation.cn)</a></li>
<li><a target="_blank" rel="noopener" href="https://training.linuxfoundation.cn/certificates/1">考试大纲</a></li>
</ul>
<p>报完名交完钱后，后续的操作基本不在 <code>linuxfoundation.cn</code>。</p>
<h3 id="选考试时间"><a href="#选考试时间" class="headerlink" title="选考试时间"></a>选考试时间</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://training.linuxfoundation.cn/help/10">Linux Foundation帮助文档-如何注册考试码及预约考试</a></p>
<blockquote>
<p>建议注册 Linux Foundation ID（LFID） 时，不要选用 Google、FaceBook 之类明显需要翻墙的账号创建。</p>
</blockquote>
<p><img src="/images/pics/tL1qR2.jpg" alt="选择考试时间界面"></p>
</li>
</ul>
<h2 id="报考到考试期间的准备"><a href="#报考到考试期间的准备" class="headerlink" title="报考到考试期间的准备"></a>报考到考试期间的准备</h2><h3 id="Vim"><a href="#Vim" class="headerlink" title="Vim"></a>Vim</h3><blockquote>
<p>或者其他在服务器 Terminal 中可以进行编辑的工具</p>
</blockquote>
<p>Vim 用得越溜，编辑得越快，考试时做题的速度也就越快。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://linux.cn/article-8144-1.html">技术|Vim 快捷键速查表 (linux.cn)</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016056004">Vim (vi) 编辑器快捷键大全【图解】- SegmentFault 思否</a></li>
</ul>
<h3 id="刷题"><a href="#刷题" class="headerlink" title="刷题"></a>刷题</h3><ul>
<li><a target="_blank" rel="noopener" href="https://killer.sh/">Killer Shell - CKS CKA CKAD Simulator</a><ul>
<li>这个是报完名/确定完考试时间后，官方赠送的一次模拟考试的机会。</li>
<li>这个题一定要做，和考试题型基本一样，<strong>难度比考试题略高</strong>。</li>
<li>找个拥有较长空闲时间的时间段，争取<strong>一次性/尽快</strong>做完，因为一旦开始这个模拟考试，有效期只有1天（又好像是2天，具体可以到时候关注一下时间）。</li>
<li>模拟题目可以导出，有两次模拟的机会，但两次模拟的题目是一样的==。</li>
<li>刷了两遍</li>
</ul>
</li>
<li>按照<a target="_blank" rel="noopener" href="https://training.linuxfoundation.cn/certificates/1">考纲</a>，看官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/">kubernetes.io</a> </li>
<li>模拟题：<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/385910633">Kubernetes CKA 证书备考笔记 - 知乎 (zhihu.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fengdejiyixx/p/15602074.html">2021年12月cka考题总结及考试注意事项 - 记忆流年 - 博客园 (cnblogs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/cl18707602767/article/details/125558716">2022 年 CKA 考题 2022.06.31 刚过_cl18707602767的博客-CSDN博客</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alijahnas/CKA-practice-exercises">alijahnas/CKA-practice-exercises: This is a guide for passing the CNCF Certified Kubernetes Administrator (CKA) with practice exercises. Good luck! (github.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/chadmcrowell/CKA-Exercises">chadmcrowell/CKA-Exercises: Practice for the Certified Kubernetes Administrator (CKA) Exam (github.com)</a></li>
</ul>
</li>
</ul>
<h3 id="其他资料"><a href="#其他资料" class="headerlink" title="其他资料"></a>其他资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/walidshaari/Kubernetes-Certified-Administrator">walidshaari/Kubernetes-Certified-Administrator</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=9UqkWcdy140&ab_channel=TheLinuxFoundation">CKA考试环境预览</a></li>
<li>花钱课程（不建议）</li>
</ul>
<h2 id="考试开始前15分钟-Tips"><a href="#考试开始前15分钟-Tips" class="headerlink" title="考试开始前15分钟 Tips"></a>考试开始前15分钟 Tips</h2><ul>
<li>提前检查考试电脑的兼容性 <a target="_blank" rel="noopener" href="https://www.examslocal.com/ScheduleExam/Home/CompatibilityCheck">WebDelivery Compatibility Check (examslocal.com)</a></li>
<li>考试全程需要录屏、录音；需要一个无人的房间；桌子上面、下面不能出现纸质、电子资料；考试前会让你拿着电脑，转动摄像头，展示桌子上面、下面以及整个房间；</li>
<li>不要说话、不要交谈；</li>
<li>考试时使用<strong>插电源的笔记本电脑</strong>；</li>
<li>考试前会让你将其他进程都关掉（<code>macOS</code> 上就只剩下 <code>Finder</code> 和 <code>浏览器</code>两个进程）；</li>
<li>准备好、调试好<strong>梯子</strong>以备不时之需（考试时没有使用梯子，但刚进入考试界面时，页面载入特别慢）；</li>
<li>考官的作用：<ul>
<li>给你下发指令，做考试前准备；</li>
<li>当你有问题时，和你网聊；</li>
<li>当时间快到时，给你提醒。</li>
</ul>
</li>
</ul>
<h2 id="考试开始后"><a href="#考试开始后" class="headerlink" title="考试开始后"></a>考试开始后</h2><blockquote>
<p>进入考试界面后，先简单设置一下 vim、bash，方便在后面答题中的使用。</p>
</blockquote>
<h3 id="Vim-1"><a href="#Vim-1" class="headerlink" title="Vim"></a>Vim</h3><p>简略的 Vim 常用配置 <code>~/.vimrc</code>，可以提高 Vim 的使用幸福感（考试时需要凭记忆手动配置）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示行号，方便移动</span></span><br><span class="line"><span class="built_in">set</span> nu</span><br><span class="line"><span class="comment"># 上色，不上色可能看不清</span></span><br><span class="line">syntax on</span><br><span class="line"><span class="comment"># 按下 Tab 键时，Vim 显示的空格数。</span></span><br><span class="line"><span class="built_in">set</span> tabstop=2</span><br><span class="line"><span class="comment"># 在文本上按下&gt;&gt;（增加一级缩进）、&lt;&lt;（取消一级缩进）或者==（取消全部缩进）时，每一级的字符数。</span></span><br><span class="line"><span class="built_in">set</span> shiftwidth=2</span><br><span class="line"><span class="comment"># 由于 Tab 键在不同的编辑器缩进不一致，该设置自动将 Tab 转为空格。</span></span><br><span class="line"><span class="built_in">set</span> expandtab</span><br></pre></td></tr></table></figure>

<h3 id="快捷命令"><a href="#快捷命令" class="headerlink" title="快捷命令"></a>快捷命令</h3><ol>
<li>检查是否配置了 <code>kubectl</code> 命令补全（按 tab 是否有提示）或通过 <code>source &lt;(kubectl completion bash)</code> 来设置命令补全；</li>
<li>为 <code>kubectl</code> 创建别名 <code>alias k=kubectl</code>。</li>
</ol>
<h2 id="考试中"><a href="#考试中" class="headerlink" title="考试中"></a>考试中</h2><p>开始每一道题目之前，需要注意一下3点是否符合题意：</p>
<ul>
<li>context</li>
<li>namespace</li>
<li>node</li>
</ul>
<p>操作完了之后记得 <code>k describe/get</code> 相应的资源看看，检查一下。</p>
<h3 id="快速命令"><a href="#快速命令" class="headerlink" title="快速命令"></a>快速命令</h3><ol>
<li><p>使用 <code>kubectl create/run</code> 来创建资源；</p>
<blockquote>
<p>当其创建的资源不满足要求时，可以考虑使用下面的模式答题</p>
<p><code>k create/run xxxxxx --dry-run=client -o yaml &gt; 1.yaml</code> </p>
<p>将生成好的 yaml 保存到本地</p>
<p><code>vim 1.yaml</code></p>
<p>然后用 vim 之类的工具编辑</p>
<p><code>k apply -f 1.yaml</code></p>
<p>再提交给 k8s</p>
</blockquote>
</li>
<li><p>使用 <code>kubectl expose</code> 来暴露服务；</p>
</li>
<li><p><code>k edit</code> 直接修改资源；</p>
</li>
<li><p><code>--all-namespace</code> =&gt; <code>-A</code>；</p>
</li>
<li><p><code>--namesapce</code> =&gt; <code>-n</code>；</p>
</li>
</ol>
<h3 id="救命命令"><a href="#救命命令" class="headerlink" title="救命命令"></a>救命命令</h3><ul>
<li><code>--help/-h </code> </li>
<li><code>k explain pods.spec.containers</code> 查看某个资源有哪些具体字段及说明</li>
</ul>
<h3 id="最后的倔强"><a href="#最后的倔强" class="headerlink" title="最后的倔强"></a>最后的倔强</h3><p>在 <a target="_blank" rel="noopener" href="https://kubernetes.io/">kubernetes.io</a> 中使用搜索功能<strong>搜索关键字</strong>。只要在文档中找到了相应的关键字，基本上就能获取到题目相关的 yaml。将 yaml 粘贴保存到本地后，用 Vim 编辑，然后 apply。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li>不是越往后越难，该跳就跳，不要浪费时间；</li>
<li>没搞定的题可以打标签，做完一遍后，在下拉菜单回顾时，可以很清楚的看到；</li>
<li>考试界面有个做笔记的 Web 应用，可以用来暂存一些信息。</li>
</ul>
<h2 id="印象比较深刻的题"><a href="#印象比较深刻的题" class="headerlink" title="印象比较深刻的题"></a>印象比较深刻的题</h2><h3 id="k8s-故障恢复"><a href="#k8s-故障恢复" class="headerlink" title="k8s 故障恢复"></a>k8s 故障恢复</h3><blockquote>
<p>印象中是使用 kubeadm 安装的 k8s 集群，所以得熟悉一下用 kubeadm 搭建 k8s 集群。</p>
</blockquote>
<ul>
<li><p>Master 节点问题</p>
<ul>
<li><p>看 kube-system 命名空间下的 pod 是否正常。可考虑看异常 pod 的日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k -n kube-system logs xxxx</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Node 节点 kubelet 启动（由 systemd 托管）问题</p>
<ul>
<li>看 kubelet 进程状态 <code>systemctl status kubelet</code></li>
<li>看 kubelet 日志 <code>journalctl -xefu kubelet</code></li>
<li>看 kubelet 命令是否存在(<code>xxx.service</code> 中定义的 kubelet 路径是否存在)；</li>
</ul>
</li>
<li><p>Node 节点 join 问题</p>
<ul>
<li><p>当修复好 Node 节点上面的 kubelet 问题后，在 Master 节点上面，通过 kubeadm 重新生成 <code>bootstrap-token</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li>再使用 <code>kubeadm join xxxxx</code>，将 Node 节点加入集群。</li>
</ul>
</li>
</ul>
<h3 id="记录某个操作"><a href="#记录某个操作" class="headerlink" title="记录某个操作"></a>记录某个操作</h3><p>命令行里面加 <code>--record</code> 参数</p>
<h3 id="etcd-的备份与恢复"><a href="#etcd-的备份与恢复" class="headerlink" title="etcd 的备份与恢复"></a>etcd 的备份与恢复</h3><p>基本会考，但是不难，就两条命令记下就好。证书路径别记错了。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster">Operating etcd clusters for Kubernetes | Kubernetes</a></li>
</ul>
<h3 id="ingress-amp-egress（网络策略）"><a href="#ingress-amp-egress（网络策略）" class="headerlink" title="ingress &amp; egress（网络策略）"></a>ingress &amp; egress（网络策略）</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">Network Policies | Kubernetes</a></li>
</ul>
<h3 id="多容器Pod与sidecar"><a href="#多容器Pod与sidecar" class="headerlink" title="多容器Pod与sidecar"></a>多容器Pod与sidecar</h3><ul>
<li>多个容器共享同一个目录</li>
</ul>
<blockquote>
<p>印象中这道题我没做完，错误理解题意了，修改 yaml 贼慢，并且时间来不及了。</p>
</blockquote>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>祝愿各位明天拿证！！！</p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="M系列MacBook连接l2tp时失败的问题修复"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">M系列MacBook连接l2tp时失败的问题修复</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rust学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rust学习笔记</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calico证书学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calico证书学习笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="如何在YAML文件中进行优雅地换行"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">如何在YAML文件中进行优雅地换行</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/25470f32f4bb.html"><img src="/images/pics/kubernetes-cka-color.svg" alt="CKS证书学习资料汇编"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/25470f32f4bb.html">CKS证书学习资料汇编</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a><p class="is-size-7"><span>&copy; 2024 遇寻</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>