<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>项目架构解释说明 - 遇寻笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="遇寻笔记"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="遇寻笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="模块概览base-service1234567891011121314151617181920212223242526272829303132333435363738394041base-service├── pom.xml└── src    └── main        └── java            └── com                └── haylion"><meta property="og:type" content="article"><meta property="og:title" content="项目架构解释说明"><meta property="og:url" content="https://eucham.me/2019/06/18/a16a8d6e1474.html"><meta property="og:site_name" content="遇寻笔记"><meta property="og:description" content="模块概览base-service1234567891011121314151617181920212223242526272829303132333435363738394041base-service├── pom.xml└── src    └── main        └── java            └── com                └── haylion"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/images/pics/7738ff707213b6aec36eeb30f4eeeca9.jpg"><meta property="article:published_time" content="2019-06-17T22:48:47.000Z"><meta property="article:modified_time" content="2021-02-09T03:03:41.041Z"><meta property="article:author" content="遇寻"><meta property="article:tag" content="项目架构"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/pics/7738ff707213b6aec36eeb30f4eeeca9.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me/2019/06/18/a16a8d6e1474.html"},"headline":"项目架构解释说明","image":["https://eucham.me/images/pics/7738ff707213b6aec36eeb30f4eeeca9.jpg"],"datePublished":"2019-06-17T22:48:47.000Z","dateModified":"2021-02-09T03:03:41.041Z","author":{"@type":"Person","name":"遇寻"},"publisher":{"@type":"Organization","name":"遇寻笔记","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"模块概览base-service1234567891011121314151617181920212223242526272829303132333435363738394041base-service├── pom.xml└── src    └── main        └── java            └── com                └── haylion"}</script><link rel="canonical" href="https://eucham.me/2019/06/18/a16a8d6e1474.html"><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-06-17T22:48:47.000Z" title="6/18/2019, 6:48:47 AM">2019-06-18</time>发表</span><span class="level-item"><time dateTime="2021-02-09T03:03:41.041Z" title="2/9/2021, 11:03:41 AM">2021-02-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span><span class="level-item">35 分钟读完 (大约5285个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">项目架构解释说明</h1><div class="content"><h2 id="模块概览"><a href="#模块概览" class="headerlink" title="模块概览"></a>模块概览</h2><h3 id="base-service"><a href="#base-service" class="headerlink" title="base-service"></a>base-service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">base-service</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── com</span><br><span class="line">                └── haylion</span><br><span class="line">                    └── realTimeBus</span><br><span class="line">                        ├── advice</span><br><span class="line">                        │   └── SystemAdvice.java # 分页注解实现</span><br><span class="line">                        ├── annotation</span><br><span class="line">                        │   └── PageAble.java # 分页注解</span><br><span class="line">                        ├── bean</span><br><span class="line">                        │   ├── BaseModel.java # 含有id熟悉的基础bean</span><br><span class="line">                        │   ├── Condition.java # 条件查询时的条件</span><br><span class="line">                        │   ├── ResultPageView.java # 被分页注解标记后，改函数返回的对象，将被包装成该对象(一个普通的bean类)</span><br><span class="line">                        │   ├── SMSConf.java # 将yaml文件中sms相关配置信息写入此类对象中</span><br><span class="line">                        │   └── Sort.java # 查询时排序方式</span><br><span class="line">                        ├── handler</span><br><span class="line">                        │   └── MySqlJsonHandler.java # MyBatis如何存储JSONObject、如何读取JSONObject</span><br><span class="line">                        ├── http</span><br><span class="line">                        │   └── HttpInvoker.java # RestTemplate单例容器</span><br><span class="line">                        ├── interceptor</span><br><span class="line">                        │   └── sql</span><br><span class="line">                        │       ├── MyPageHelper.java # 覆盖afterAll后的PageHelper，在MyPageInterceptor中进行调用</span><br><span class="line">                        │       ├── MyPageInterceptor.java # PageHelper中拦截器PageInterceptor的源码，有自定义修改</span><br><span class="line">                        │       └── SqlLogHandler.java # 把将要执行的SQL打印出来，集成在MyPageInterceptor中</span><br><span class="line">                        ├── mappers</span><br><span class="line">                        │   └── BaseMapper.java # 定义了访问数据库的一些基本接口</span><br><span class="line">                        ├── msg</span><br><span class="line">                        │   └── RetStubMsg.java # 自定义ApplicationException接收的参数</span><br><span class="line">                        └── service</span><br><span class="line">                            ├── BaseCacheService.java # 定义了一些基本的Redis访问接口</span><br><span class="line">                            ├── BaseService.java # 实现了service基础数据库操作的抽象类</span><br><span class="line">                            ├── CacheService.java # BaseCacheService的具体封装实现</span><br><span class="line">                            ├── DistributedLock.java # 通过redis实现的一种分布式锁</span><br><span class="line">                            ├── MQService.java # 阿里MQ操作封装</span><br><span class="line">                            ├── SMSService.java # 阿里短信操作封装</span><br><span class="line">                            ├── SysThreadPool.java # 自定义线程池</span><br><span class="line">                            ├── UploadService.java # 文件上传，有文件头部信息校验</span><br><span class="line">                            └── WXPayService.java # 微信支付相关操作封装</span><br></pre></td></tr></table></figure>

<h3 id="common-service"><a href="#common-service" class="headerlink" title="common-service"></a>common-service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">base-support/common-service</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── com</span><br><span class="line">                └── haylion</span><br><span class="line">                    └── realTimeBus</span><br><span class="line">                        └── common</span><br><span class="line">                            ├── code</span><br><span class="line">                            │   ├── RetStub.java # ApplicationException所依赖的对象，定义了业务逻辑错误的访问方法</span><br><span class="line">                            │   └── SysStubInfo.java # 系统默认的错误码信息</span><br><span class="line">                            ├── exception</span><br><span class="line">                                └── ApplicationException.java # 自定义异常，用来处理业务逻辑中出现的异常，其中依赖RetStub对象，来描述错误码、错误信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="facade-service"><a href="#facade-service" class="headerlink" title="facade-service"></a>facade-service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">base-support/facade-service</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── com</span><br><span class="line">                └── haylion</span><br><span class="line">                    └── realTimeBus</span><br><span class="line">                        └── facade</span><br><span class="line">                            ├── BaseInitializer.java # 自定义Server初始化类，其中加入了拦截器ActionInterceptor，并指定拦截所有的请求</span><br><span class="line">                            ├── advice</span><br><span class="line">                            │   └── ResponseAdvice.java # 将所有返回的body中的数据，转换成JsonView的形式</span><br><span class="line">                            ├── annotation</span><br><span class="line">                            │   └── AnonymousSupport.java # 跳过ActionInterceptor中的校验、塞入userId</span><br><span class="line">                            ├── exception</span><br><span class="line">                            │   └── ExceptionHandle.java # 在请求的处理过程中，出现任何异常，都会调用该类中的处理方法，将错误信息，以JsonView的形式返回。</span><br><span class="line">                            ├── filter</span><br><span class="line">                            │   ├── RequestWrapper.java # 将请求相关的数据，如headers、queryparams、requestbody、method、url保存到本线程的LogTrace中</span><br><span class="line">                            │   └── TraceCopyFilter.java # 拦截器，拦截所有的请求，并将请求转换成RequestWrapper</span><br><span class="line">                            ├── intercepter</span><br><span class="line">                            │   └── ActionInterceptor.java # 所有的请求都会经过该类处理，可以在此类中对类进行自定义操作，如按需鉴定权限、添加userId到header中</span><br><span class="line">                            ├── log</span><br><span class="line">                            │   ├── HttpTraceLog.java # HTTP请求log类</span><br><span class="line">                            │   └── LogTrace.java # 利用ThreadLocal获取、设置HttpTraceLog</span><br><span class="line">                            ├── validator</span><br><span class="line">                            │   └── ValidatorConfiguration.java # </span><br><span class="line">                            └── view</span><br><span class="line">                                └── JsonView.java # API统一响应模板</span><br></pre></td></tr></table></figure>

<h2 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h2><h3 id="拦截鉴权—-ActionInterceptor"><a href="#拦截鉴权—-ActionInterceptor" class="headerlink" title="拦截鉴权— ActionInterceptor"></a>拦截鉴权— <code>ActionInterceptor</code></h3><p>本项目中鉴定登录状态的方式为：在请求头部加入<code>token</code>，然后在拦截器<code>ActionInterceptor.java</code>中，从请求头部中取出<code>token</code>，并依据<code>token</code>来获取<code>userId</code>，然后将<code>userId</code>插入到头部中；如果上述过程，出现<code>token</code>是<code>null</code>、<code>userId</code>是<code>null</code>，那么该请求将被视为非登录状态，将不会传递到Controller层。</p>
<p><strong>如何跳过校验？</strong></p>
<p>在Controller的方法上，加上<code>@AnonymousSupport</code>注解，在<code>ActionInterceptor.java</code>中，会通过<code>Method</code>方法，获取<code>@AnonymousSupport</code>，如果存在就不进行后面的登录状态校验。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HandlerMethod handlerMethod = (HandlerMethod) o;</span><br><span class="line">AnonymousSupport annotation = handlerMethod.getMethod().getAnnotation(AnonymousSupport.class);</span><br><span class="line"><span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>如何将<code>userId</code>添加到请求的<code>headers</code>中？</strong></p>
<p>通过<code>token</code>在Redis中获取到<code>userId</code>后，如何在<code>headers</code>中添加<code>userId</code>键值对，略微繁杂，但是目的很单纯。设置值的代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MimeHeaders mimeHeaders = (MimeHeaders) headers.get(coyoteRequest);</span><br><span class="line"><span class="comment">//in case of do not cover the specify key</span></span><br><span class="line">String header = mimeHeaders.getHeader(key);</span><br><span class="line">logger.info(<span class="string">&quot;Original value of &lt;&quot;</span> + key + <span class="string">&quot;&gt; is &quot;</span> + header);</span><br><span class="line">mimeHeaders.removeHeader(key);</span><br><span class="line"><span class="comment">// key = &quot;userId&quot;, value即token值</span></span><br><span class="line">mimeHeaders.addValue(key).setString(value);</span><br></pre></td></tr></table></figure>

<p>在前面，有一个对<code>request</code>类型进行判断的语句，主要目的是为了避免<code>NullPointerException</code>，因为后面通过反射获取属性的时候，可能会由于<code>request</code>类型不同，而获取不到对应的<code>Field</code>，从而导致出现异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (request <span class="keyword">instanceof</span> StandardMultipartHttpServletRequest) &#123;</span><br><span class="line">    <span class="comment">// 文件上传时的类型是这个</span></span><br><span class="line">    StandardMultipartHttpServletRequest standardMultipartHttpServletRequest = (StandardMultipartHttpServletRequest) request;</span><br><span class="line">    RequestWrapper requestWrapper = (RequestWrapper) standardMultipartHttpServletRequest</span><br><span class="line">            .getRequest();</span><br><span class="line">    request = (HttpServletRequest) requestWrapper.getRequest();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (request <span class="keyword">instanceof</span> RequestWrapper) &#123; </span><br><span class="line">    <span class="comment">// 通常情况下是这个,因为我们在Filter中对request进行过包装，详情见下面请求日志部分</span></span><br><span class="line">    RequestWrapper requestWrapper = (RequestWrapper) request;</span><br><span class="line">    request = (HttpServletRequest) requestWrapper.getRequest();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="请求日志"><a href="#请求日志" class="headerlink" title="请求日志"></a>请求日志</h3><p>主要的任务是将请求所有的参数(如：<u>url中的参数、方法、headers、requestBody</u>等)都以直观的方式打印出来。它的主要流程有两处：</p>
<ol>
<li><p>拦截器<code>TraceCopyFilter</code>初始化<code>RequestWrapper</code>时，将请求所有的信息都保存到<code>HttpTraceLog</code>中，并通过<code>LogTrace</code>保存在当前线程中(利用<code>ThreadLocal</code>)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LogTrace.get().setStartTime(System.currentTimeMillis());</span><br><span class="line">LogTrace.get().setHttpMethod(request.getMethod());</span><br><span class="line">LogTrace.get().setUrl(requestURI);</span><br><span class="line">LogTrace.get().setReqParams(request.getQueryString());</span><br><span class="line">LogTrace.get().setReqHeader(getHeaderMap(request));</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">LogTrace.get().setRequestBody(sb.toString());</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>ResponseAdvice</code>包装完返回信息之后，会在finally中将所有的请求信息，通过log的形式打印出来。打印完成后，会通过<code>LogTrace</code>将请求的信息从本线程中移除掉(利用<code>ThreadLocal</code>)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    LogTrace.get().setSpendTime(System.currentTimeMillis() - LogTrace.get().getStartTime());</span><br><span class="line">    LogTrace.get().setRespParams(objectMapper.writeValueAsString(result));</span><br><span class="line">    log.info(<span class="string">&quot;Trace log is ====&gt;  &quot;</span> + objectMapper.writeValueAsString(LogTrace.get()));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">  	log.error(<span class="string">&quot;Trace log error : &quot;</span>, e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  	LogTrace.clearAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>其中获取body时，直接使用IO流，把数据保存到变量<code>requestBody</code>中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request == null 是一个标志位</span></span><br><span class="line"><span class="keyword">this</span>.request = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// IO读取</span></span><br><span class="line"><span class="keyword">try</span> (InputStream inputStream = request.getInputStream();</span><br><span class="line">    BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream)))&#123;</span><br><span class="line">    <span class="keyword">char</span>[] charBuffer = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">int</span> bytesRead;</span><br><span class="line">    <span class="keyword">while</span> ((bytesRead = bufferedReader.read(charBuffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      sb.append(charBuffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">  	ex.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 保存到内存中</span></span><br><span class="line">requestBody = sb.toString();</span><br></pre></td></tr></table></figure>

<p>但是收到POST请求时（参考<a target="_blank" rel="noopener" href="https://www.oschina.net/news/77354/http-get-post-different">链接</a>），会产生两个TCP数据包（并不是所有浏览器都会在POST中发送两次包，Firefox就只发送一次），即浏览器先发送header，服务器响应100 continue，浏览器再发送data，服务器响应200 ok（返回数据）。所以在拿POST请求中body时，如果直接读出来，可能导致后面框架再去读的时候，出现读不了的情况，所以在<code>RequestWrapper</code>中，重写了<code>getInputStream</code>方法，在<code>request</code>不为空，即没有读取过body(这种情况就是在上传文件的情况)，直接以<code>requestBody</code>作为输入流，提供给框架读取，上述问题便解决了。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.request != <span class="keyword">null</span>) &#123;</span><br><span class="line">      	<span class="comment">// 不为空，说明没有读取过body，即为文件上传请求，此时直接返回request.getInputStream()</span></span><br><span class="line">    		<span class="keyword">return</span> request.getInputStream();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 以requestBody作为输入流</span></span><br><span class="line">    <span class="keyword">final</span> ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(requestBody.getBytes());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadListener</span><span class="params">(ReadListener readListener)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="comment">// 以requestBody作为输入流</span></span><br><span class="line">        		<span class="keyword">return</span> byteArrayInputStream.read();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SQL日志"><a href="#SQL日志" class="headerlink" title="SQL日志"></a>SQL日志</h3><p><code>SqlLogHandler</code>在SQL拦截中进行调用，它主要做的工作是把SQL中的?替换成实际的值，并打印出执行时间。</p>
<h3 id="API统一的返回数据"><a href="#API统一的返回数据" class="headerlink" title="API统一的返回数据"></a>API统一的返回数据</h3><p>在<code>ResponseAdvice</code>中，会将数据都转化成<code>JsonView</code>的形式。</p>
<p>其中有一个问题，就是当返回的类型是<code>String</code>的时候，不能包装String类型，只能以String的形式返回。这是由于整个SpringMVC框架的设计问题。假设有如下业务代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;test&quot;)</span></span><br><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候的返回值如下：</p>
<p><img src="/images/pics/7738ff707213b6aec36eeb30f4eeeca9.jpg"></p>
<p>因为是以String的类型直接返回了，上述的返回格式也是理所当然。但是如果将String包装成<code>JsonView</code>，然后返回会怎么样？修改<code>ResponseAdvice</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (o <span class="keyword">instanceof</span> JsonView ) &#123;</span><br><span class="line">    result = o;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</span><br><span class="line">    o = EMPTY_DATA;</span><br><span class="line">&#125;</span><br><span class="line">result = <span class="keyword">new</span> JsonView&lt;&gt;(SysStubInfo.DEFAULT_SUCCESS, o);</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>

<p>这时候如果再次访问，程序会报错如下：</p>
<p><img src="/images/pics/88674b8ee761ad15c4951d1d96eb6145.jpg"></p>
<p>报错的堆栈信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassCastException: com.haylion.realTimeBus.facade.view.JsonView cannot be cast to java.base&#x2F;java.lang.String</span><br><span class="line">	at org.springframework.http.converter.StringHttpMessageConverter.getContentLength(StringHttpMessageConverter.java:43)</span><br><span class="line">	at org.springframework.http.converter.AbstractHttpMessageConverter.addDefaultHeaders(AbstractHttpMessageConverter.java:259)</span><br><span class="line">	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:210)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:275)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor.handleReturnValue(RequestResponseBodyMethodProcessor.java:180)</span><br><span class="line">	at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:82)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:119)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:877)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:783)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:991)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:925)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:974)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:866)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:635)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:851)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:742)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">	at com.haylion.realTimeBus.facade.filter.TraceCopyFilter.doFilter(TraceCopyFilter.java:52)</span><br></pre></td></tr></table></figure>

<p>上面的错误简单理解，类型转换错误，也就是需要一个String，但是却收到了一个<code>JsonView</code>。需要的String是我们在Controller中返回的类型，然而实际收到的<code>JsonView</code>是在<code>ResponseAdvice</code>中包装后返回的。为什么这样的原因是：与<code>ResponseAdvice</code>执行的时机有关。在<code>AbstractMessageConverterMethodProcessor.java</code>文件的<code>writeWithMessageConverters()</code>方法中，调试数据如下：</p>
<p><strong>确定返回类型：</strong></p>
<p><img src="/images/pics/0fb94bb789767fae82ff374de97fc2e3.jpg"></p>
<p><strong>确定可用的转换器，然后执行<code>ResponseAdvice</code>：</strong></p>
<p>在<code>ResponseAdvice</code>执行前，SpringMVC会根据Controller的返回类型，确定一个<code>AbstractHttpMessageConverter</code>，由于在Controller中返回类型为String，所以这里为<code>StringHttpMessageConverter</code>，也就是说，它是用来转换一个String类型的转换器。等转换器确定好了之后，会执行ResponseAdvice中的处理方法，将String转换成<code>JsonView</code>。</p>
<p><img src="/images/pics/3ae224afd3cb3b6dce575d022fc236ba.jpg"></p>
<p><strong>写入返回数据：</strong></p>
<p>忽略掉其他代码，直接进入出现错误的代码，在<code>AbstractHttpMessageConverter</code>中的<code>addDefaultHeaders()</code>方法中，需要在头部获取整个请求的大小，即调用<code>getContentLength()</code>方法。</p>
<p><img src="/images/pics/403fa66dc7dc972222bd0c6a360ad0de.jpg"></p>
<p>它是一个期望被子类覆盖的方法，默认的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Long <span class="title">getContentLength</span><span class="params">(T t, <span class="meta">@Nullable</span> MediaType contentType)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候应该直接看<code>StringHttpMessageConverter</code>中的<code>getContentLength()</code>方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Long <span class="title">getContentLength</span><span class="params">(String str, <span class="meta">@Nullable</span> MediaType contentType)</span> </span>&#123;</span><br><span class="line">   Charset charset = getContentTypeCharset(contentType);</span><br><span class="line">   <span class="keyword">return</span> (<span class="keyword">long</span>) str.getBytes(charset).length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再将转换后的<code>JsonView</code>作为抽象函数<code>getContentLength()</code>(这时就是<code>StringHttpMessageConverter</code>的该函数)的第一个参数，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Long <span class="title">getContentLength</span><span class="params">(String str, <span class="meta">@Nullable</span> MediaType contentType)</span> </span>&#123;</span><br><span class="line">   Charset charset = getContentTypeCharset(contentType);</span><br><span class="line">   <span class="keyword">return</span> (<span class="keyword">long</span>) str.getBytes(charset).length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个参数为String，但是实际上是<code>JsonView</code>。因此，<code>ClassCastException</code>在所难免。在<code>ResponseAdvice</code>中，将String直接返回，可以避免出现这种不太好修复的错误。</p>
<p><strong>替代办法：</strong></p>
<p>但是如果非要返回String类型，并且需要包装成<code>JsonView</code>形式，可以考虑直接在Controller中将String包装成<code>JsonView</code>，然后返回，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;test&quot;)</span></span><br><span class="line"><span class="meta">@AnonymousSupport</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JsonView&lt;&gt;(SysStubInfo.DEFAULT_SUCCESS, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="/images/pics/3d3a80941fb1c00e1485d7083b87f328.jpg"></p>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>参看<code>ExceptionHandle</code>具体实现及写法、以及相关源码注释。</p>
<h3 id="分页–PageHelper"><a href="#分页–PageHelper" class="headerlink" title="分页–PageHelper"></a>分页–<code>PageHelper</code></h3><h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p>直接在方法上加上<code>@PageAble</code>注解，并在该方法中传入两个参数，分别为<code>page</code>和<code>size</code>，在该方法返回后，会得到一个<code>ResultPageView</code>封装对象，其中包含分页相关信息。</p>
<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><p> <code>SystemAdvice</code>定义一个切面，切点是<code>@annotation(com.haylion.realTimeBus.annotation.PageAble)</code>。也就是说，每个被<code>@PageAble</code>注解过的方法，都将执行下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PAGE_ABLE = <span class="string">&quot;@annotation(com.haylion.realTimeBus.annotation.PageAble)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Around(PAGE_ABLE)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">doAroundAdvice</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    logger.info(<span class="string">&quot;execute method : &quot;</span> + proceedingJoinPoint.getSignature().getName());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 进入被@PageAble注解的方法前的准备工作</span></span><br><span class="line">        prepare(proceedingJoinPoint);</span><br><span class="line">        <span class="comment">// 执行被@PageAble注解的方法</span></span><br><span class="line">        Object obj = proceedingJoinPoint.proceed();</span><br><span class="line">        <span class="comment">// 执行被@PageAble注解的方法后，执行扫尾工作</span></span><br><span class="line">        Object result = after(obj);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;aspect execute error : &quot;</span>, throwable);</span><br><span class="line">        <span class="keyword">throw</span> throwable;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        PageHelper.clearPage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>准备工作</strong>：主要是获取<code>page</code>和<code>size</code>的值，然后调用<code>PageHelper</code>的<code>startPage</code>方法，初始化分页信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PageAble中page和size的默认值分别是1和20</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PageAble &#123;</span><br><span class="line">    <span class="function">String <span class="title">pageSizeName</span><span class="params">()</span> <span class="keyword">default</span> &quot;size&quot;</span>;</span><br><span class="line">    <span class="function">String <span class="title">pageNumName</span><span class="params">()</span> <span class="keyword">default</span> &quot;page&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">pageSize</span><span class="params">()</span> <span class="keyword">default</span> 20</span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">pageNum</span><span class="params">()</span> <span class="keyword">default</span> 1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 准备分页</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Signature signature = point.getSignature();</span><br><span class="line">    MethodSignature methodSignature = (MethodSignature) signature;</span><br><span class="line">    Method targetMethod = methodSignature.getMethod();</span><br><span class="line">    PageAble pageAble = targetMethod.getAnnotation(PageAble.class);</span><br><span class="line">    String numName = pageAble.pageNumName();</span><br><span class="line">    String sizeName = pageAble.pageSizeName();</span><br><span class="line">    <span class="comment">// 先获取默认的page和size值</span></span><br><span class="line">    <span class="keyword">int</span> pageNo = pageAble.pageNum();</span><br><span class="line">    <span class="keyword">int</span> pageSize = pageAble.pageSize();</span><br><span class="line">    Object[] paramValues = point.getArgs();</span><br><span class="line">    String[] paramNames = methodSignature.getParameterNames();</span><br><span class="line">    <span class="keyword">int</span> length = paramNames.length;</span><br><span class="line">    <span class="comment">// 遍历该方法中的所有参数，如果有page和size信息，那么就覆盖默认值为用户传入的值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (paramNames[i].equals(numName)) &#123;</span><br><span class="line">            pageNo = (Integer) paramValues[i];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramNames[i].equals(sizeName)) &#123;</span><br><span class="line">            pageSize = (Integer) paramValues[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 该方法利用ThreadLocal在本线程中插入一个分页信息的对象Page</span></span><br><span class="line">    PageHelper.startPage(pageNo, pageSize);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// startPage()方法的最终实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; <span class="function">Page&lt;E&gt; <span class="title">startPage</span><span class="params">(<span class="keyword">int</span> pageNum, <span class="keyword">int</span> pageSize, <span class="keyword">boolean</span> count, Boolean reasonable, Boolean pageSizeZero)</span> </span>&#123;</span><br><span class="line">    Page&lt;E&gt; page = <span class="keyword">new</span> Page&lt;E&gt;(pageNum, pageSize, count);</span><br><span class="line">    page.setReasonable(reasonable);</span><br><span class="line">    page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    <span class="comment">//当已经执行过orderBy的时候</span></span><br><span class="line">    Page&lt;E&gt; oldPage = getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (oldPage != <span class="keyword">null</span> &amp;&amp; oldPage.isOrderByOnly()) &#123;</span><br><span class="line">      	page.setOrderBy(oldPage.getOrderBy());</span><br><span class="line">    &#125;</span><br><span class="line">    setLocalPage(page);</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setLocalPage</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">  	LOCAL_PAGE.set(page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Page&gt; LOCAL_PAGE = <span class="keyword">new</span> ThreadLocal&lt;Page&gt;();</span><br></pre></td></tr></table></figure>

<p><strong>进入SQL拦截器（即<code>MyPageInterceptor</code>）</strong>：这个拦截器中主要是PageHelper执行分页的步骤，相关步骤可分为：</p>
<ul>
<li><p>判断是否需要进行分页。判断的条件为<code>!dialect.skip(ms, parameter, rowBounds)</code>，其实现为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">skip</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ms.getId().endsWith(MSUtils.COUNT))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;在系统中发现了多个分页插件，请检查系统配置!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Page page = pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//设置默认的 count 列</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtil.isEmpty(page.getCountColumn()))&#123;</span><br><span class="line">            page.setCountColumn(pageParams.getCountColumn());</span><br><span class="line">        &#125;</span><br><span class="line">        autoDialect.initDelegateDialect(ms);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，通过判断<code>Page</code>是否为空来决定是否进行分页，<code>Page</code>则从本线程中获取，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PageHelper.java</span></span><br><span class="line">Page page = pageParams.getPage(parameterObject, rowBounds);</span><br><span class="line"></span><br><span class="line"><span class="comment">//PageParams.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page <span class="title">getPage</span><span class="params">(Object parameterObject, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">		Page page = PageHelper.getLocalPage();</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PageMethod.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Page&lt;T&gt; <span class="title">getLocalPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> LOCAL_PAGE.get();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Page&gt; LOCAL_PAGE = <span class="keyword">new</span> ThreadLocal&lt;Page&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取数据的总条数。在进入此项前，会进行判断是否需要进行总数查询。这里假设进行总数查询。从源SQL解析出获取数据总条数的代码调试如下：</p>
<p><img src="/images/pics/3ae925cf7c0ded7f9b2fe84c482cd58e.png" alt="调试"></p>
<p>log如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2019-06-14 09:37:31.475 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &#x3D;&#x3D;&gt;  Preparing: SELECT count(0) FROM advertising </span><br><span class="line">2019-06-14 09:37:31.490 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &#x3D;&#x3D;&gt; Parameters: </span><br><span class="line">2019-06-14 09:37:31.507 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">2019-06-14 09:37:31.508  INFO [http-nio-8880-exec-1] c.h.r.i.s.SqlLogHandler - com.haylion.realTimeBus.dao.AdvertisingMapper.getByConditionList_COUNT:</span><br><span class="line">select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising</span><br><span class="line">&lt;cost time is :45 ms &gt;</span><br><span class="line">2019-06-14 09:37:31.512 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &#x3D;&#x3D;&gt;  Preparing: select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising LIMIT ? </span><br><span class="line">2019-06-14 09:37:31.512 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">2019-06-14 09:37:31.519 DEBUG [http-nio-8880-exec-1] o.a.i.l.j.BaseJdbcLogger - &lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">2019-06-14 09:37:31.520  INFO [http-nio-8880-exec-1] c.h.r.i.s.SqlLogHandler - com.haylion.realTimeBus.dao.AdvertisingMapper.getByConditionList:</span><br><span class="line">select id, advertising_name, advertising_start_time, advertising_end_time, advertising_position, images_url, advertiser_url, advertiser_name, advertiser_id, settlement_type, settlement_price, create_time, create_user, audit_status, audit_opinion, audit_time, advertising_type from advertising LIMIT 1 </span><br><span class="line">&lt;cost time is :8 ms &gt;</span><br><span class="line">2019-06-14 09:37:31.591  INFO [http-nio-8880-exec-1] c.h.r.f.a.ResponseAdvice - Trace log is &#x3D;&#x3D;&#x3D;&#x3D;&gt;  &#123;&quot;url&quot;:&quot;&#x2F;advertising&#x2F;getAdvertisingList&quot;,&quot;httpMethod&quot;:&quot;GET&quot;,&quot;reqHeader&quot;:&#123;&quot;host&quot;:&quot;192.168.12.39:8880&quot;,&quot;content-type&quot;:&quot;application&#x2F;json&quot;,&quot;user-agent&quot;:&quot;curl&#x2F;7.54.0&quot;,&quot;accept&quot;:&quot;*&#x2F;*&quot;,&quot;token&quot;:&quot;fe20027352f8250571436f471a988b4d&quot;&#125;,&quot;reqParams&quot;:&quot;page&#x3D;1&amp;size&#x3D;1&quot;,&quot;requestBody&quot;:&quot;&quot;,&quot;respParams&quot;:&quot;&#123;\&quot;code\&quot;:200,\&quot;message\&quot;:\&quot;success\&quot;,\&quot;data\&quot;:&#123;\&quot;total\&quot;:9,\&quot;current\&quot;:1,\&quot;pageCount\&quot;:9,\&quot;list\&quot;:[&#123;\&quot;settlementType\&quot;:0,\&quot;imagesUrl\&quot;:\&quot;xxxxxxx\&quot;,\&quot;advertisingName\&quot;:\&quot;hello kitty 111\&quot;,\&quot;advertiserName\&quot;:\&quot;暁\&quot;,\&quot;advertiserId\&quot;:0,\&quot;createTimeymdhm_Str\&quot;:\&quot;2019-06-10 17:27\&quot;,\&quot;advertisingType\&quot;:0,\&quot;createTime\&quot;:1560158854000,\&quot;advertisingPosition\&quot;:0,\&quot;auditStatus\&quot;:4,\&quot;createUser\&quot;:1,\&quot;id\&quot;:0,\&quot;advertiserUrl\&quot;:\&quot;xxxxx\&quot;,\&quot;createTimeStr\&quot;:\&quot;2019-06-10 17:27:34\&quot;&#125;]&#125;&#125;&quot;,&quot;startTime&quot;:1560476250978,&quot;spendTime&quot;:592&#125;</span><br></pre></td></tr></table></figure>

<p>获取完总数后，会进行判断是否有分页的必要。</p>
</li>
<li><p>分页查询。这里假设有分页的必要。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用方言获取分页 sql</span></span><br><span class="line">String pageSql = dialect.getPageSql(ms, boundSql, parameter, rowBounds, pageKey);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPageSql</span><span class="params">(MappedStatement ms, BoundSql boundSql, Object parameterObject, RowBounds rowBounds, CacheKey pageKey)</span> </span>&#123;</span><br><span class="line">    String sql = boundSql.getSql();</span><br><span class="line">    Page page = getLocalPage();</span><br><span class="line">    <span class="comment">//支持 order by</span></span><br><span class="line">    String orderBy = page.getOrderBy();</span><br><span class="line">    <span class="keyword">if</span> (StringUtil.isNotEmpty(orderBy)) &#123;</span><br><span class="line">        pageKey.update(orderBy);</span><br><span class="line">        sql = OrderByParser.converToOrderBySql(sql, orderBy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (page.isOrderByOnly()) &#123;</span><br><span class="line">      	<span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// 这是一个抽象方法，会根据具体的数据库，调用不同的实现方法，来在原SQL语句上，加上对应的分页语句</span></span><br><span class="line">    <span class="keyword">return</span> getPageSql(sql, page, pageKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体支持的数据库如下：</p>
<p><img src="/images/pics/468ac30f9649c89d1fcd520080c4db7d.png"></p>
<p>Oracle的分页实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPageSql</span><span class="params">(String sql, Page page, CacheKey pageKey)</span> </span>&#123;</span><br><span class="line">    StringBuilder sqlBuilder = <span class="keyword">new</span> StringBuilder(sql.length() + <span class="number">120</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot;SELECT * FROM ( &quot;</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; SELECT TMP_PAGE.*, ROWNUM ROW_ID FROM ( &quot;</span>);</span><br><span class="line">    sqlBuilder.append(sql);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; ) TMP_PAGE WHERE ROWNUM &lt;= ? &quot;</span>);</span><br><span class="line">    sqlBuilder.append(<span class="string">&quot; ) WHERE ROW_ID &gt; ? &quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> sqlBuilder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MySQL的分页实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPageSql</span><span class="params">(String sql, Page page, CacheKey pageKey)</span> </span>&#123;</span><br><span class="line">    StringBuilder sqlBuilder = <span class="keyword">new</span> StringBuilder(sql.length() + <span class="number">14</span>);</span><br><span class="line">    sqlBuilder.append(sql);</span><br><span class="line">    <span class="keyword">if</span> (page.getStartRow() == <span class="number">0</span>) &#123;</span><br><span class="line">      	sqlBuilder.append(<span class="string">&quot; LIMIT ? &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	sqlBuilder.append(<span class="string">&quot; LIMIT ?, ? &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    pageKey.update(page.getPageSize());</span><br><span class="line">    <span class="keyword">return</span> sqlBuilder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>保存分页查询后的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// resultList是分页查询后的数据列表</span></span><br><span class="line"><span class="comment">// afterPage的返回值是有两种情况，但是都可以被转成List</span></span><br><span class="line"><span class="keyword">return</span> dialect.afterPage(resultList, parameter, rowBounds);</span><br><span class="line"></span><br><span class="line"><span class="comment">// dialect.afterPage()方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">afterPage</span><span class="params">(List pageList, Object parameterObject, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这个方法即使不分页也会被执行，所以要判断 null</span></span><br><span class="line">    AbstractHelperDialect delegate = autoDialect.getDelegate();</span><br><span class="line">    <span class="keyword">if</span>(delegate != <span class="keyword">null</span>)&#123;</span><br><span class="line">      	<span class="keyword">return</span> delegate.afterPage(pageList, parameterObject, rowBounds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pageList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// delegate.afterPage()方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">afterPage</span><span class="params">(List pageList, Object parameterObject, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">    Page page = getLocalPage();</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="keyword">null</span>) &#123;</span><br><span class="line">      	<span class="keyword">return</span> pageList;</span><br><span class="line">    &#125;</span><br><span class="line">    page.addAll(pageList);</span><br><span class="line">    <span class="keyword">if</span> (!page.isCount()) &#123;</span><br><span class="line">      	page.setTotal(-<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((page.getPageSizeZero() != <span class="keyword">null</span> &amp;&amp; page.getPageSizeZero()) &amp;&amp; page.getPageSize() == <span class="number">0</span>) &#123;</span><br><span class="line">      	page.setTotal(pageList.size());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(page.isOrderByOnly())&#123;</span><br><span class="line">      	page.setTotal(pageList.size());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这里有一个问题是，如果delegate不为空，那么返回的是<code>Page</code>，但是我们在调用<code>xxxxxMapper</code>的查询方法之后，返回值基本上是<code>List</code>，与我们的常识并不符合。那<code>Page</code>是什么呢？它不只是包含分页信息的基本类，它继承自ArrayList。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Page</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在return后，还会执行finally中的处理代码，即<code>com.haylion.realTimeBus.interceptor.sql.MyPageHelper</code>的<code>afterAll()</code>方法。其中实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.haylion.realTimeBus.interceptor.sql.MyPageHelper.afterAll()</span></span><br><span class="line"><span class="comment">// 这个方法是我们自定义的方法，用来处理执行完前面所述的切点后，保留分页信息，进行再次封装</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Page&lt;Object&gt; localPage = getLocalPage();</span><br><span class="line">  	<span class="comment">// 删除分页信息</span></span><br><span class="line">    <span class="keyword">super</span>.afterAll();</span><br><span class="line">  	<span class="comment">// 设置回本线程中</span></span><br><span class="line">    setLocalPage(localPage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// super.afterAll()。这个方法可以简单理解成，清楚掉本线程中的分页信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这个方法即使不分页也会被执行，所以要判断 null</span></span><br><span class="line">    AbstractHelperDialect delegate = autoDialect.getDelegate();</span><br><span class="line">    <span class="keyword">if</span> (delegate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        delegate.afterAll();</span><br><span class="line">        autoDialect.clearDelegate();</span><br><span class="line">    &#125;</span><br><span class="line">    clearPage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除本地变量</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clearPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	LOCAL_PAGE.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过上述的过程，<code>MyPageInterceptor</code>执行完毕，分页信息存储在本线程中，然后回到切面处理。</p>
</li>
</ul>
<p><strong>切面收尾工作（回到<code>SystemAdvice</code>）</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">after</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    PageInfo&lt;?&gt; pageInfo;</span><br><span class="line">    Page&lt;Object&gt; localPage = PageHelper.getLocalPage();</span><br><span class="line">    <span class="keyword">long</span> total = localPage.getTotal();</span><br><span class="line">    <span class="keyword">int</span> pageNum = localPage.getPageNum();</span><br><span class="line">    <span class="keyword">int</span> pages = localPage.getPages();</span><br><span class="line">    List&lt;?&gt; list = (List&lt;?&gt;) obj;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">    pageInfo = <span class="keyword">new</span> PageInfo((list));</span><br><span class="line">    ResultPageView&lt;?&gt; resultPageView = <span class="keyword">new</span> ResultPageView&lt;&gt;(total, pageNum, pages, pageInfo.getList());</span><br><span class="line">    <span class="keyword">return</span> resultPageView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，还有最重要的一个步骤，是在切面处理完成后，将分页信息从本线程中删除，没有此操作，后续操作会出现莫名其妙的错误。也就是finally语句中的<code>PageHelper.clearPage();</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    prepare(proceedingJoinPoint);</span><br><span class="line">    Object obj = proceedingJoinPoint.proceed();</span><br><span class="line">    Object result = after(obj);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">    logger.error(<span class="string">&quot;aspect execute error : &quot;</span>, throwable);</span><br><span class="line">    <span class="keyword">throw</span> throwable;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    PageHelper.clearPage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="局限"><a href="#局限" class="headerlink" title="局限"></a>局限</h4><p>这就限定了在一个被<code>PageAble</code>注解了的方法上，只能执行一条查询。如果对于一个到来的请求，需要进行两次或以上的查询，并且某一条查询需要分页的情况，如果所有的查询都放在被<code>PageAble</code>注解的方法下，执行会出现问题（出现不必要的分页操作）。但是可以通过组装的形式，完成该项需求。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>项目架构解释说明</p><p><a href="https://eucham.me/2019/06/18/a16a8d6e1474.html">https://eucham.me/2019/06/18/a16a8d6e1474.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>遇寻</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2019-06-18</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-02-09</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84/">项目架构</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5f548d5caad6e60013d63db8&amp;product=inline-share-buttons" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/07/01/268ad906f8cb.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">SpringBoot配置双数据库源</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/06/10/6528e594295b.html"><span class="level-item">【leetcode】21. Merge Two Sorted Lists</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://eucham.me/2019/06/18/a16a8d6e1474.html';
            this.page.identifier = '2019/06/18/a16a8d6e1474.html';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'eucham' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">三月 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">五月 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">十二月 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="M系列MacBook连接l2tp时失败的问题修复"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">M系列MacBook连接l2tp时失败的问题修复</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rust学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rust学习笔记</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calico证书学习笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calico证书学习笔记</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="如何在YAML文件中进行优雅地换行"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">如何在YAML文件中进行优雅地换行</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/25470f32f4bb.html"><img src="/images/pics/kubernetes-cka-color.svg" alt="CKS证书学习资料汇编"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/25470f32f4bb.html">CKS证书学习资料汇编</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">三月沙</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="遇寻笔记" height="28"></a><p class="is-size-7"><span>&copy; 2024 遇寻</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>