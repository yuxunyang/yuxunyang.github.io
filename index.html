<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>é‡å¯»ç¬”è®°</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="é‡å¯»ç¬”è®°"><meta name="msapplication-TileImage" content="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="é‡å¯»ç¬”è®°"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:type" content="website"><meta property="og:title" content="é‡å¯»ç¬”è®°"><meta property="og:url" content="https://eucham.me/"><meta property="og:site_name" content="é‡å¯»ç¬”è®°"><meta property="og:description" content="No. I&amp;#39;ll bring me back a souvenir."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://eucham.me/img/og_image.png"><meta property="article:author" content="é‡å¯»"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://eucham.me"},"headline":"é‡å¯»ç¬”è®°","image":["https://eucham.me/img/og_image.png"],"author":{"@type":"Person","name":"é‡å¯»"},"publisher":{"@type":"Organization","name":"é‡å¯»ç¬”è®°","logo":{"@type":"ImageObject","url":"https://eucham.me/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"}},"description":"No. I&#39;ll bring me back a souvenir."}</script><link rel="icon" href="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?7d79380bb26079f6dd33da78e83cf2ab";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="é‡å¯»ç¬”è®°" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/categories/AI">AI</a><a class="navbar-item" href="/categories/Kubernetes">Kubernetes</a><a class="navbar-item" href="/categories/Openstack">Openstack</a><a class="navbar-item" href="/categories/Docker">Container</a><a class="navbar-item" href="/categories/Golang">Golang</a><a class="navbar-item" href="/categories/Rust">Rust</a><a class="navbar-item" href="/about.html">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a><a class="navbar-item search" title="æœç´¢" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>å‘è¡¨</span><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/macOS/">macOS</a></span><span class="level-item">1 åˆ†é’Ÿè¯»å®Œ (å¤§çº¦193ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/12/09/249b2dc63505.html">Mç³»åˆ—MacBookè¿æ¥l2tpæ—¶å¤±è´¥çš„é—®é¢˜ä¿®å¤</a></h1><div class="content"><ol>
<li><p>å¯ç”¨åŸºäºé¢„å…±äº«ç§˜é’¥çš„l2tpè¿æ¥åŠŸèƒ½</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">[ -d /etc/ppp ] || mkdir /etc/ppp</span><br><span class="line">echo &#x27;&#x27;&#x27;plugin L2TP.ppp</span><br><span class="line">l2tpnoipsec&#x27;&#x27;&#x27; &gt; /etc/ppp/options</span><br><span class="line">chmod 777 /etc/ppp/options</span><br></pre></td></tr></table></figure>
</li>
<li><p>è§£å†³è¿æ¥lt2påèƒ½pingä½†æ˜¯æ‰€æœ‰ç«¯å£éƒ½æ— æ³•è®¿é—®çš„é—®é¢˜ï¼Œå…³é—­ç½‘ç»œchecksumåŠŸèƒ½ã€‚ip-upæ˜¯ä¼šåœ¨lt2pè¿æ¥å»ºç«‹æ—¶è‡ªåŠ¨è¿è¡Œçš„è„šæœ¬</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#x27;&#x27;#!/bin/sh</span><br><span class="line">/usr/sbin/sysctl net.link.generic.system.hwcksum_tx=0</span><br><span class="line">/usr/sbin/sysctl net.link.generic.system.hwcksum_rx=0&#x27;&#x27;&#x27; &gt; /etc/ppp/ip-up</span><br><span class="line">chmod 755 /etc/ppp/ip-up</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨æ–­å¼€l2tpè¿æ¥åä¼šå°†ç›¸å…³é…ç½®è¿˜åŸä¸ºç³»ç»Ÿé»˜è®¤ã€‚ip-downæ˜¯ä¼šåœ¨l2tpè¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨è¿è¡Œçš„è„šæœ¬</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#x27;&#x27;#!/bin/sh</span><br><span class="line">/usr/sbin/sysctl net.link.generic.system.hwcksum_tx=1</span><br><span class="line">/usr/sbin/sysctl net.link.generic.system.hwcksum_rx=1&#x27;&#x27;&#x27; &gt; /etc/ppp/ip-down</span><br><span class="line">chmod 755 /etc/ppp/ip-down</span><br></pre></td></tr></table></figure></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>å‘è¡¨</span><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/Rust/">Rust</a></span><span class="level-item">2 åˆ†é’Ÿè¯»å®Œ (å¤§çº¦322ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/12/09/e9036e8500f6.html">Rustå­¦ä¹ ç¬”è®°</a></h1><div class="content"><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><h3 id="ğŸ“šä¹¦å•"><a href="#ğŸ“šä¹¦å•" class="headerlink" title="ğŸ“šä¹¦å•"></a>ğŸ“šä¹¦å•</h3><p><img src="https://eucham.me/images/pics/Gj6LAyGj6LAy.png" alt="GZtZbEGZtZbE"></p>
<ul>
<li><em><a target="_blank" rel="noopener" href="https://nostarch.com/rust-rustaceans">Rust For Rustaceans</a></em></li>
<li><em><a target="_blank" rel="noopener" href="https://nostarch.com/rust-programming-language-2nd-edition">The Rust Programming Language, 2nd Edition</a></em></li>
<li><em><a target="_blank" rel="noopener" href="https://www.oreilly.com/library/view/programming-rust-2nd/9781492052586/">Programming Rust, 2nd Edition</a></em></li>
<li><em><a target="_blank" rel="noopener" href="https://www.oreilly.com/library/view/creative-projects-for/9781789346220/">Creative Projects for Rust Programmers</a></em></li>
</ul>
<h3 id="å®˜æ–¹èµ„æ–™"><a href="#å®˜æ–¹èµ„æ–™" class="headerlink" title="å®˜æ–¹èµ„æ–™"></a>å®˜æ–¹èµ„æ–™</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/book/title-page.html">The Rust Programming Language - The Rust Programming Language (rust-lang.org)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://course.rs/about-book.html">Rust è¯­è¨€åœ£ç» - Rustè¯­è¨€åœ£ç»(Rust Course)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zh.practice.rs/why-exercise.html">å…³äº pracitce.rs - Rust By Practice( Rust ç»ƒä¹ å®è·µ )</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://nomicon.purewhite.io/intro.html">è¿›é˜¶ - Rust ç§˜å…¸ï¼ˆæ­»çµä¹¦ï¼‰ (purewhite.io)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/stable/std/">std - Rust</a></p>
</li>
</ul>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><ul>
<li><a target="_blank" rel="noopener" href="https://play.rust-lang.org/">Rust Playground</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/rust-lang/rustlings">rust-lang/rustlings: Small exercises to get you used to reading and writing Rust code! (github.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.rs/async-task/latest/async_task/">async_task - Rust (docs.rs)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/smol-rs/smol/tree/master/examples">smol/examples at master Â· smol-rs/smol (github.com)</a></li>
</ul>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl  https://sh.rustup.rs -sSf | sh</span><br><span class="line">rustc</span><br></pre></td></tr></table></figure>

<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>Tabï¼šç”¨4ä¸ªç©ºæ ¼æ›¿æ¢ï¼›</p>
<p>åˆ†å·ï¼šå¯è¦å¯ä¸è¦ï¼Œä½† Rust é£æ ¼æ˜¯éœ€è¦ï¼›</p>
<p>ä»£ç æ–‡ä»¶å‘½åï¼šç”¨ä¸‹åˆ’çº¿åˆ†å‰²ä¸åŒå•è¯ï¼›</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;hello world!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘ä¸è¿è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rustc main.rs</span><br><span class="line">./main </span><br></pre></td></tr></table></figure>

<h2 id="cargo"><a href="#cargo" class="headerlink" title="cargo"></a>cargo</h2><p>ä½¿ç”¨cargoæ¯”rustcçš„ä¼˜åŠ¿</p>
<ul>
<li>  ä¾èµ–ç®¡ç†</li>
<li>  ç¼–è¯‘å¤§å‹é¡¹ç›®</li>
</ul>
<p>å¸¸ç”¨å‘½ä»¤</p>
<ul>
<li>  cargo new</li>
<li>  cargo build</li>
<li>  cargo run</li>
<li>  cargo check</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>å‘è¡¨</span><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">4 åˆ†é’Ÿè¯»å®Œ (å¤§çº¦545ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/12/09/4948e86c1262.html">Calicoè¯ä¹¦å­¦ä¹ ç¬”è®°</a></h1><div class="content"><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p>å®‰è£…æµ‹è¯•é›†ç¾¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl https://raw.githubusercontent.com/tigera/ccol1/main/control-init.yaml | multipass launch -n control -m 2048M 20.04 --cloud-init -</span><br><span class="line">curl https://raw.githubusercontent.com/tigera/ccol1/main/node1-init.yaml | multipass launch -n node1 20.04 --cloud-init -</span><br><span class="line">curl https://raw.githubusercontent.com/tigera/ccol1/main/node2-init.yaml | multipass launch -n node2 20.04 --cloud-init -</span><br><span class="line">curl https://raw.githubusercontent.com/tigera/ccol1/main/host1-init.yaml | multipass launch -n host1 20.04 --cloud-init -</span><br></pre></td></tr></table></figure>

<p>calico çš„å››ç§å®‰è£…æ–¹å¼</p>
<ul>
<li>  Manifest</li>
<li>  Operator</li>
<li>  Managed Kubernetes Service(EKSã€GKEã€AKS)</li>
<li>  Kubernetes Distro(MicroK8s)</li>
</ul>
<p>ä»¥Operatorçš„æ–¹å¼æ¥å®‰è£…calico</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">multipass shell host1</span><br><span class="line">kubectl create -f https://docs.projectcalico.org/archive/v3.21/manifests/tigera-operator.yaml</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: operator.tigera.io/v1</span></span><br><span class="line"><span class="string">kind: Installation</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  calicoNetwork:</span></span><br><span class="line"><span class="string">    containerIPForwarding: Enabled</span></span><br><span class="line"><span class="string">    ipPools:</span></span><br><span class="line"><span class="string">    - cidr: 198.19.16.0/21</span></span><br><span class="line"><span class="string">      natOutgoing: Enabled</span></span><br><span class="line"><span class="string">      encapsulation: None</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>å®‰è£…æµ‹è¯•æ‰€éœ€çš„æ¨¡æ‹Ÿä¸šåŠ¡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multipass shell host1</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/tigera/ccol1/main/yaobank.yaml</span><br></pre></td></tr></table></figure>

<h2 id="ç½‘ç»œç­–ç•¥"><a href="#ç½‘ç»œç­–ç•¥" class="headerlink" title="ç½‘ç»œç­–ç•¥"></a>ç½‘ç»œç­–ç•¥</h2><p>åŸç”Ÿç½‘ç»œç­–ç•¥</p>
<ul>
<li>  è¦æƒ³ NetworkPolicy ç”Ÿæ•ˆï¼Œå¿…é¡»ä½¿ç”¨å®ç°äº†æ­¤çš„ CNI æ’ä»¶ï¼Œå¦‚ calicoã€‚</li>
<li>  ingress è¿› pod æµé‡ é»˜è®¤å…¨éƒ¨æ‰“å¼€ï¼Œå½“è¢«åº”ç”¨è§„åˆ™åï¼Œpod æ‰€åœ¨ node ä¸Šã€ingress è§„åˆ™åˆ—è¡¨ä¸­å…è®¸çš„æµé‡å¯ä»¥è¿›å…¥ podï¼›</li>
<li>  egress å‡º pod æµé‡ï¼Œé»˜è®¤å…¨éƒ¨å¯ä»¥å‡ºï¼Œå½“è¢«åº”ç”¨è§„åˆ™åï¼Œåªæœ‰è§„åˆ™ä¸­å…è®¸çš„æµé‡å¯ä»¥å‡º podï¼›</li>
<li>  ç™½åå•æœºåˆ¶ï¼Œå³åœ¨ rules ä¸­é…ç½®äº†ï¼Œæ‰èƒ½é€šè¡Œï¼ˆåŒ…æ‹¬è¿›å’Œå‡ºï¼‰ï¼Œè§„åˆ™å¯ä»¥å åŠ ï¼Œä½†èƒ½åšåˆ°åªè¦é…ç½®äº†å°±èƒ½é€šè¡Œï¼›</li>
</ul>
<p>é»˜è®¤é…ç½®</p>
<ul>
<li><p>  å‘½åç©ºé—´ä¸­æ²¡æœ‰ policy æ—¶ï¼Œå…¨éƒ¨å¼€æ”¾ï¼›</p>
</li>
<li><p>æ‹’ç»/å…è®¸æ‰€æœ‰æµé‡</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-all-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-all-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>é€‰æ‹©æµé‡çš„3ç§æ–¹å¼</p>
<ul>
<li>  podSelector</li>
<li>  namespaceSelector</li>
<li>  ipBlock</li>
</ul>
<p>DNS è®°å½•</p>
<ul>
<li>Service<ul>
<li>  shs-8080.tcp.shs-svc.default.svc.cluster.local</li>
<li>  shs-svc.default.svc.cluster.local</li>
</ul>
</li>
<li>Pod<ul>
<li>  10-244-0-8.default.pod.cluster.local</li>
</ul>
</li>
</ul>
<p>Calico Network Policy</p>
<p>æ¯”åŸç”Ÿç½‘ç»œç­–ç•¥çš„ä¼˜åŠ¿</p>
<ol>
<li>  åŸç”Ÿç­–ç•¥ä¸ºç™½åå•æœºåˆ¶ï¼Œå³åªæœ‰ allow è¿™ä¸€ä¸ªåŠ¨ä½œï¼Œcalico è¿˜æœ‰ denyï¼Œlog ç­‰æ“ä½œã€‚</li>
<li>  åŸç”Ÿç­–ç•¥èµ„æºæ˜¯nsçº§åˆ«çš„ï¼Œcalico å³æ”¯æŒnsçº§åˆ«ã€ä¹Ÿæ”¯æŒclusterçº§åˆ«ã€‚</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>å‘è¡¨</span><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/Golang/">Golang</a></span><span class="level-item">å‡ ç§’è¯»å®Œ (å¤§çº¦88ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/12/09/6dae87e31dc3.html">å¦‚ä½•åœ¨YAMLæ–‡ä»¶ä¸­è¿›è¡Œä¼˜é›…åœ°æ¢è¡Œ</a></h1><div class="content"><p>æ ·å¼å¯¹æ¯”</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">a:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">    hiello</span></span><br><span class="line"><span class="string">    jasdf</span></span><br><span class="line"><span class="string"></span><span class="attr">b:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">    hiello</span></span><br><span class="line"><span class="string">    jasdf</span></span><br><span class="line"><span class="string"></span><span class="attr">c:</span> <span class="string">&gt;+</span></span><br><span class="line"><span class="string">    hiello</span></span><br><span class="line"><span class="string">    jasdf</span></span><br><span class="line"><span class="string"></span><span class="attr">A:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    hiello</span></span><br><span class="line"><span class="string">    jasdf</span></span><br><span class="line"><span class="string"></span><span class="attr">B:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    hiello</span></span><br><span class="line"><span class="string">    jasdf</span></span><br><span class="line"><span class="string"></span><span class="attr">C:</span> <span class="string">|+</span></span><br><span class="line"><span class="string">    hiello</span></span><br><span class="line"><span class="string">    jasdf</span></span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li>  <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3790454/how-do-i-break-a-string-in-yaml-over-multiple-lines">syntax - How do I break a string in YAML over multiple lines? - Stack Overflow</a></li>
<li>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1985817">ã€Œè¯‘æ–‡ã€å¦‚ä½•åœ¨YAMLä¸­è¾“å…¥å¤šè¡Œå­—ç¬¦ä¸²? - è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>å‘è¡¨</span><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/Kubernetes/">Kubernetes</a></span><span class="level-item">1 å°æ—¶è¯»å®Œ (å¤§çº¦11730ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/12/09/25470f32f4bb.html">CKSè¯ä¹¦å­¦ä¹ èµ„æ–™æ±‡ç¼–</a></h1><div class="content"><h1 id="çœŸé¢˜â‘ åŸºäº1-22ç‰ˆæœ¬"><a href="#çœŸé¢˜â‘ åŸºäº1-22ç‰ˆæœ¬" class="headerlink" title="çœŸé¢˜â‘ åŸºäº1.22ç‰ˆæœ¬"></a>çœŸé¢˜â‘ åŸºäº1.22ç‰ˆæœ¬</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CKA å’Œ CKS æ˜¯ LINUX åŸºé‡‘ä¼šè”åˆ CNCFç¤¾åŒºç»„ç»‡çš„äº‘åŸç”ŸæŠ€æœ¯é¢†åŸŸæƒå¨è®¤è¯ï¼Œè€ƒè¯•é‡‡ç”¨å®æ“æ–¹å¼è¿›è¡Œã€‚CKSå…¨ç§°æ˜¯Kuberneteså®‰å…¨ä¸“å®¶è®¤è¯ï¼Œå®ƒåœ¨ä¸€ä¸ªæ¨¡æ‹ŸçœŸå®çš„ç¯å¢ƒä¸­æµ‹è¯•è€ƒç”Ÿå¯¹Kuberneteså’Œäº‘å®‰å…¨çš„çŸ¥è¯†ã€‚åœ¨å‚åŠ CKSè€ƒè¯•ä¹‹å‰ï¼Œå¿…é¡»å·²ç»é€šè¿‡CKA(Kubernetesç®¡ç†å‘˜è®¤è¯)ï¼Œåœ¨è·å¾—CKAè®¤è¯ä¹‹åæ‰å¯ä»¥é¢„çº¦CKSè€ƒè¯•ã€‚CKS çš„è€ƒè¯•éš¾åº¦ç›¸å¯¹äº CKA æé«˜äº†å¾ˆå¤šï¼Œ2ä¸ªå°æ—¶çš„è€ƒè¯•æ—¶é—´å¾ˆç´§å¼ ï¼Œå› ä¸ºè€ƒè¯•æ˜¯åœ¨å¤–ç½‘ä¸Šè¿›è¡Œï¼Œè¿™ä¸¤ä¸ªè€ƒè¯•åˆæ˜¯å®æ“è€ƒè¯•ï¼Œç½‘ç»œæ¡ä»¶ä¸å¥½ï¼Œå¾ˆå½±å“æ•ˆç‡ï¼Œå¦‚æœä¸æŠ“ç´§çš„è¯ï¼Œå¾ˆå¯èƒ½åšä¸å®Œæ‰€æœ‰å®æ“é¢˜ã€‚æé†’å¤‡è€ƒçš„åŒå­¦å–„ç”¨è€ƒè¯•è½¯ä»¶æä¾›çš„ notepad åŠŸèƒ½ï¼Œå…ˆæŠŠ yaml æ–‡ä»¶æˆ–å‘½ä»¤å†™åˆ°notepadé‡Œï¼Œå†ç²˜è´´åˆ° terminalé‡Œã€‚</p>
<p>æˆ‘å› ä¸ºä¸Šæ¬¡ CKA è€ƒè¯•è¿˜æ˜¯æ¯”è¾ƒé¡ºåˆ©ï¼Œ94 é«˜åˆ†é€šè¿‡ï¼Œæ‰€ä»¥è¿™æ¬¡çš„ CKS è€ƒè¯•æœ‰ç‚¹ç–å¿½äº†ï¼Œæå¿˜å¸¦èº«ä»½è¯å’ŒæŠ¤ç…§ï¼ŒCKA/CKS è€ƒè¯•éœ€è¦èº«ä»½è¯+æŠ¤ç…§/ä¿¡ç”¨å¡ï¼Œå› æ­¤è·Ÿç›‘è€ƒè€å¸ˆæ²Ÿé€šäº†å¾ˆä¹…æ—¶é—´ï¼Œæœ€åä¿®æ”¹äº†è€ƒè¯•äººå§“åä¸ºä¸­æ–‡ï¼Œæ˜¯ç”¨é©¾é©¶è¯å®Œæˆçš„è€ƒè¯•ã€‚æ„å¤–ä¹‹å–œæ˜¯ CKS ç»™æˆ‘çš„è¯ä¹¦æ˜¯ä¸­æ–‡åçš„ã€‚</p>
<p>æˆ‘è¿™æ¬¡è€ƒè¯•çš„ kubernetes ç‰ˆæœ¬æ˜¯ 1.22ï¼Œç‰¹æ„è®°å½•äº†ä¸€ä¸‹è€ƒè¯•ä¼šè€ƒåˆ°çš„çŸ¥è¯†ç‚¹ï¼Œåˆ†äº«ç»™éœ€è¦çš„åŒå­¦ã€‚</p>
<h2 id="1-NetworkPolicy"><a href="#1-NetworkPolicy" class="headerlink" title="1. NetworkPolicy"></a>1. NetworkPolicy</h2><p>é€šå¸¸ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨æ¥é€‰æ‹©podï¼Œæ§åˆ¶æµé‡ã€‚æ‰€ä»¥è¦å¯¹ kubectl labelçš„ä½¿ç”¨æ–¹æ³•ç†Ÿæ‚‰èµ·æ¥ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label [--<span class="type">overwrite</span>] (<span class="operator">-f</span> FILENAME | <span class="built_in">TYPE</span> NAME) KEY_1=VAL_1 ... KEY_N=VAL_N </span><br><span class="line">  [--<span class="type">resource</span>-<span class="type">version</span>=<span class="type">version</span>] [<span class="type">options</span>]</span><br></pre></td></tr></table></figure>

<p>ç½‘ç»œç­–ç•¥çš„å®ç”¨æ–¹æ³•è§æ³¨é‡Š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># podSelector: &#123;&#125; è¡¨ç¤ºé€‰æ‹©æ‰€æœ‰ pod åº”ç”¨ NetworkPolicy</span></span><br><span class="line">  <span class="attr">podSelector:</span> <span class="comment"># è¡¨ç¤ºé€‰æ‹©åŒ…å«æ ‡ç­¾ role=db çš„ pod åº”ç”¨ä¸‹é¢çš„ NetworkPolicy</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">policyTypes:</span> <span class="comment"># è¡¨ç¤º NetworkPolicy åŒ…å« ingress å’Œ egress æµé‡è§„åˆ™</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">ingress:</span> <span class="comment"># ingress è§„åˆ™ç™½åå•åˆ—è¡¨ï¼Œæ¯æ¡è§„åˆ™å…è®¸åŒæ—¶åŒ¹é… from å’Œ ports  æµï¼Œå¯ä»¥æœ‰æ¡ä¸ªè§„åˆ™ã€‚</span></span><br><span class="line">  <span class="comment"># ç¬¬1æ¡ç™½åå•ï¼Œå…è®¸ä»¥ä¸‹podè®¿é—®ï¼ˆé™ tcp 6379 ç«¯å£ï¼‰ï¼ŒåŒ…å« </span></span><br><span class="line">  <span class="comment"># 1. from + ports çš„ç»„åˆè§„åˆ™ï¼Œå…è®¸æ¥è‡ª172.17ç½‘æ®µ(172.17.1é™¤å¤–)ï¼›</span></span><br><span class="line">  <span class="comment"># 2. æ ‡ç­¾ project=myproject çš„å‘½åç©ºé—´çš„æ‰€æœ‰ podï¼›</span></span><br><span class="line">  <span class="comment"># 3. default å‘½åç©ºé—´ä¸‹æ ‡ç­¾ role=frontend çš„ podï¼›</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">        <span class="attr">except:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">172.17</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">project:</span> <span class="string">myproject</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">role:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="comment"># ç¬¬äºŒæ¡ç™½åå•ï¼ŒåªåŒ…å« from è§„åˆ™ï¼Œå…è®¸</span></span><br><span class="line">  <span class="comment"># 1. æ¥è‡ªæ‰€æœ‰å‘½åç©ºé—´åŒ…å« environment=testing æ ‡ç­¾çš„ pod è®¿é—®ï¼ˆä¸é™ç«¯å£ï¼‰</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="string">testing</span></span><br><span class="line">  <span class="attr">egress:</span> <span class="comment"># egress è§„åˆ™ç™½åå•åˆ—è¡¨ï¼ŒåŒ ingress è§„åˆ™ä¸€æ ·ï¼Œæ¯æ¡è§„åˆ™åŒ…å« to+portsï¼Œå¯ä»¥æœ‰å¤šæ¡è§„åˆ™ã€‚</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5978</span></span><br></pre></td></tr></table></figure>

<h2 id="2-Apparmor"><a href="#2-Apparmor" class="headerlink" title="2. Apparmor"></a>2. Apparmor</h2><p>æŸ¥çœ‹å½“å‰èŠ‚ç‚¹åŠ è½½çš„ apparmor profile ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½ï¼Œè¦æ‰‹å·¥åŠ è½½</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apparmor_status | grep nginx</span><br><span class="line">apparmor_parser /etc/apparmor.d/nginx_apparmor</span><br></pre></td></tr></table></figure>

<p>cks è€ƒè¯•çš„ apparmor profile æ–‡ä»¶å†…å®¹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tunables/global&gt;</span></span></span><br><span class="line"><span class="meta">#nginx-profile-3  </span></span><br><span class="line">profile nginx-profile<span class="number">-3</span> flags=(attach_disconnected) &#123;</span><br><span class="line">  <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;abstractions/base&gt;</span></span></span><br><span class="line">  file,</span><br><span class="line">  # Deny all file writes.</span><br><span class="line">  deny <span class="comment">/** w,</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼š nginx-profile-3 è¿™ä¸€è¡Œè¦ç¡®ä¿æ³¨é‡Šæ‰ï¼Œè€ƒè¯•ç¯å¢ƒæä¾›çš„å¯èƒ½æ²¡æœ‰æ³¨é‡Šï¼ŒåŠ è½½é…ç½®æ–‡ä»¶æŒ‰æ—¶ä¼šæŠ¥é”™</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@node01:~# apparmor_parser /etc/apparmor.d/nginx_apparmor</span><br><span class="line">AppArmor parser error <span class="keyword">for</span> /etc/apparmor.d/nginx_apparmor <span class="keyword">in</span> /etc/apparmor.d/ninx_apparmor at line 2: Found unexpected character: <span class="string">&#x27;-&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ pod yaml æ–‡ä»¶ï¼Œåœ¨æ³¨é‡Šé‡Œè®¾ç½®ä¸º podx åŠ è½½ apparmor profile</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">container.apparmor.security.beta.kubernetes.io/podx:</span> <span class="string">localhost/nginx-profile-3</span></span><br></pre></td></tr></table></figure>

<p>yaml æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">container.apparmor.security.beta.kubernetes.io/podx:</span> <span class="string">localhost/nginx-profile-3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podx</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo &#x27;Hello AppArmor!&#x27; &amp;&amp; sleep 1h&quot;</span> ]</span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node01</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<h2 id="3-ä¿®å¤kube-benchå‘ç°çš„å®‰å…¨é—®é¢˜"><a href="#3-ä¿®å¤kube-benchå‘ç°çš„å®‰å…¨é—®é¢˜" class="headerlink" title="3. ä¿®å¤kube-benchå‘ç°çš„å®‰å…¨é—®é¢˜"></a>3. ä¿®å¤kube-benchå‘ç°çš„å®‰å…¨é—®é¢˜</h2><p>kube-bench æ˜¯ä¸€ä¸ª CIS è¯„ä¼°å·¥å…·ï¼Œæ‰«æ kubernetes é›†ç¾¤å­˜åœ¨çš„å®‰å…¨é—®é¢˜ï¼ŒåŸºæœ¬ä¸ŠæŒ‰ç…§ æ‰«æç»“æœçš„ä¿®å¤å»ºè®®è¿›è¡Œä¿®å¤å°±å¯ä»¥äº†ï¼Œç³»ç»Ÿä¼šç»™å‡ºå¾ˆå…·ä½“çš„ä¿®å¤æªæ–½ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®å¤ kube-apiserver å®‰å…¨é—®é¢˜</span></span><br><span class="line"><span class="string">vi</span> <span class="string">/etc/kubernetes/manifests/kube-apiserver</span></span><br><span class="line"><span class="comment">#ä¿®æ”¹ï¼š</span></span><br><span class="line"><span class="string">--authorization-mode=Node,RBAC</span></span><br><span class="line"><span class="comment">#æ·»åŠ </span></span><br><span class="line"><span class="string">--insecure-port=0</span></span><br><span class="line"><span class="comment">#åˆ é™¤</span></span><br><span class="line"><span class="comment"># --insecure-bind-address=0.0.0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®å¤ kubelet å®‰å…¨é—®é¢˜</span></span><br><span class="line"><span class="string">vi</span> <span class="string">/var/lib/kubelet/config.yaml</span></span><br><span class="line"><span class="comment"># å°†authentication.anonymous.enabled è®¾ç½®ä¸º false</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line">  <span class="attr">anonymous:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># authorization.mode è®¾ç½®ä¸º Webhook</span></span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">Webhook</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># ä¿®å¤ etcd å®‰å…¨é—®é¢˜</span></span><br><span class="line"><span class="string">vi</span> <span class="string">/etc/kubernetes/manifests/etcd.yaml</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹ä¸ºtrueï¼š</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--client-cert-auth=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸Šä¿®å¤å®Œæˆå é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶å¹¶é‡å¯kubelet</span></span><br><span class="line"></span><br><span class="line"><span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">restart</span> <span class="string">kubelet</span></span><br></pre></td></tr></table></figure>

<h2 id="4-è§£å†³-pod-çš„-serviceaccount-è®¾ç½®é”™è¯¯é—®é¢˜"><a href="#4-è§£å†³-pod-çš„-serviceaccount-è®¾ç½®é”™è¯¯é—®é¢˜" class="headerlink" title="4. è§£å†³ pod çš„ serviceaccount è®¾ç½®é”™è¯¯é—®é¢˜"></a>4. è§£å†³ pod çš„ serviceaccount è®¾ç½®é”™è¯¯é—®é¢˜</h2><p>è¿™ä¸ªé¢˜è¦æ³¨æ„ serviceaccount æœ‰ä¸ªé€‰é¡¹ automountServiceAccountToken, è¿™ä¸ªé€‰é¡¹å†³å®šæ˜¯å¦è‡ªåŠ¨æŒ‚è½½ secret åˆ° podã€‚<br>æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ pod åˆ›å»ºå¹¶ç»‘å®š serviceaccount æ—¶ï¼Œä¸è‡ªåŠ¨æŒ‚è½½å¯¹åº”çš„ secretï¼Œè¿™æ · pod å°±æ²¡æœ‰æƒé™è®¿é—® apiserverï¼Œæé«˜äº†ä¸šåŠ¡ pod çš„å®‰å…¨æ€§ã€‚</p>
<p>å¯ä»¥åœ¨ serviceaccount å’Œ pod çš„ spec é‡Œè®¾ç½®ï¼Œpodçš„è®¾ç½®ä¼˜å…ˆäº serviceaccount é‡Œçš„è®¾ç½®ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backend-sa</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">qa</span> </span><br><span class="line"><span class="attr">automountServiceAccountToken:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">qa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">backend-sa</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.9</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">backend</span></span><br></pre></td></tr></table></figure>

<p>åˆ é™¤æœªä½¿ç”¨çš„ serviceaccount</p>
<h2 id="5-è®¾ç½®é»˜è®¤ç½‘ç»œç­–ç•¥"><a href="#5-è®¾ç½®é»˜è®¤ç½‘ç»œç­–ç•¥" class="headerlink" title="5. è®¾ç½®é»˜è®¤ç½‘ç»œç­–ç•¥"></a>5. è®¾ç½®é»˜è®¤ç½‘ç»œç­–ç•¥</h2><p>è¿™é“é¢˜æ˜¯é€åˆ†é¢˜ï¼Œè®¾ç½®é»˜è®¤æ‹’ç»æ‰€æœ‰å‡ºç«™å’Œå…¥ç«™çš„ pod æµé‡ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥å‚è€ƒå®˜ç½‘çš„æ¡ˆä¾‹ç›´æ¥æ”¹ä¸€ä¸‹åå­—å°±å¯ä»¥äº†<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#%E9%BB%98%E8%AE%A4%E6%8B%92%E7%BB%9D%E6%89%80%E6%9C%89%E5%85%A5%E5%8F%A3%E5%92%8C%E6%89%80%E6%9C%89%E5%87%BA%E7%AB%99%E6%B5%81%E9%87%8F">é»˜è®¤ç½‘ç»œç­–ç•¥</a></p>
<h2 id="6-RBAC"><a href="#6-RBAC" class="headerlink" title="6. RBAC"></a>6. RBAC</h2><p>è¿™é“é¢˜ä¹ŸåŸºæœ¬æ˜¯é€åˆ†é¢˜ï¼Œå‚è€ƒå®˜ç½‘æ–‡æ¡£ï¼Œæ ¹æ®é¢˜ç›®è¦æ±‚ï¼Œè®¾ç½® role çš„ èµ„æºè®¿é—®æƒé™ï¼Œç»‘å®šåˆ° serviceaccount å°±å¯ä»¥äº†ã€‚<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#role-and-clusterole">RBAC</a></p>
<h2 id="7-æ—¥å¿—å®¡è®¡"><a href="#7-æ—¥å¿—å®¡è®¡" class="headerlink" title="7. æ—¥å¿—å®¡è®¡"></a>7. æ—¥å¿—å®¡è®¡</h2><p>è¿™é“é¢˜ç¨å¤æ‚ï¼Œéœ€è¦æŒ‰ç…§è¦æ±‚å¯åŠ¨æ—¥å¿—å®¡è®¡ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼š<br>(1) ç¼–å†™æ—¥å¿—å®¡è®¡ç­–ç•¥æ–‡ä»¶<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#audit-policy">æ—¥å¿—å®¡è®¡ç­–ç•¥</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">omitStages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">RequestResponse</span>   </span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;namespaces&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>] </span><br><span class="line">    <span class="attr">namespaces:</span> [<span class="string">&quot;front-apps&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>, <span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">    <span class="attr">omitStages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span></span><br></pre></td></tr></table></figure>

<p>(2) ä¿®æ”¹ kube-apiserver.yamlé…ç½®æ–‡ä»¶ï¼Œå¯ç”¨æ—¥å¿—å®¡è®¡ç­–ç•¥ï¼Œæ—¥å¿—ç­–ç•¥é…ç½®æ–‡ä»¶ä½ç½®ã€æ—¥å¿—æ–‡ä»¶å­˜å‚¨ä½ç½®ã€å¾ªç¯å‘¨æœŸã€‚<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#log-%E5%90%8E%E7%AB%AF">å¯åŠ¨æ—¥å¿—é…ç½®</a></p>
<p>vi /etc/kubernetes/manifests/kube-apiserver.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®æ—¥å¿—å®¡è®¡ç­–ç•¥æ–‡ä»¶åœ¨ pod é‡Œçš„ mount ä½ç½®</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--audit-policy-file=/etc/kubernetes/logpolicy/sample-policy.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ—¥å¿—æ–‡ä»¶å­˜å‚¨ä½ç½®</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--audit-log-path=/var/log/kubernetes/audit-logs.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ—¥å¿—æ–‡ä»¶å¾ªç¯</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--audit-log-maxage=10</span>    </span><br><span class="line"><span class="bullet">-</span> <span class="string">--audit-log-maxbackup=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mount æ—¥å¿—ç­–ç•¥å’Œæ—¥å¿—æ–‡ä»¶çš„</span></span><br><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/logpolicy/sample-policy.yaml</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">audit</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/kubernetes/audit-logs.txt</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">audit-log</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">audit</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/logpolicy/sample-policy.yaml</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">File</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">audit-log</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/log/kubernetes/audit-logs.txt</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br></pre></td></tr></table></figure>

<p>é‡å¯ kubelet</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h2 id="8-åˆ›å»º-secret"><a href="#8-åˆ›å»º-secret" class="headerlink" title="8. åˆ›å»º secret"></a>8. åˆ›å»º secret</h2><p>è¿™é“é¢˜è€ƒè§£ç  secret çš„ base64 ç¼–ç ä¿¡æ¯ï¼Œåˆ›å»ºæ–°çš„ secret å¹¶ mount åˆ° pod çš„ç‰¹å®šä½ç½®ã€‚<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret">è§£ç  secret</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets -n istio-system db1-test -o jsonpath=&#123;.<span class="property">data</span>.<span class="property">username</span>&#125; | base64 -d &gt;  <span class="regexp">/cks/</span>sec/user.<span class="property">txt</span></span><br><span class="line">kubectl get secrets -n istio-system db1-test -o jsonpath=&#123;.<span class="property">data</span>.<span class="property">password</span>&#125; | base64 -d &gt;  <span class="regexp">/cks/</span>sec/pass.<span class="property">txt</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#create-a-secret">åˆ›å»ºsecret</a></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="keyword">create</span> secret generic db2<span class="operator">-</span>test <span class="operator">-</span>n istio<span class="operator">-</span><span class="keyword">system</span> <span class="comment">--from-literal=username=production-instance --from-literal=password=KvLftKgs4aVH</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets">ä½¿ç”¨secret</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/secret</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">db2-test</span></span><br></pre></td></tr></table></figure>

<h2 id="9-æ£€æµ‹-dockerfile-çš„ä¸å®‰å…¨æŒ‡ä»¤"><a href="#9-æ£€æµ‹-dockerfile-çš„ä¸å®‰å…¨æŒ‡ä»¤" class="headerlink" title="9. æ£€æµ‹ dockerfile çš„ä¸å®‰å…¨æŒ‡ä»¤"></a>9. æ£€æµ‹ dockerfile çš„ä¸å®‰å…¨æŒ‡ä»¤</h2><p>è¿™é“é¢˜ä¹Ÿæ˜¯é€åˆ†é¢˜ï¼Œä¸»è¦æ˜¯æŠŠ dockerfileé‡Œä¸¤ä¸ª ä½¿ç”¨äº† root ç”¨æˆ·çš„æŒ‡ä»¤åˆ é™¤ï¼ŒæŠŠæ·»åŠ ç‰¹å®šèƒ½åŠ›çš„ securityContext å®‰å…¨ä¸Šä¸‹æ–‡æ³¨é‡Šæ‰ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤ä¸¤å¤„</span></span><br><span class="line">USER root</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ³¨é‡Š securityContext</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">securityContext:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  &#123;<span class="string">&quot;Capabilities&quot;</span>: &#123;<span class="string">&#x27;add&#x27;</span>:&#123;NET_BIND_SERVICE&#125;, <span class="string">&#x27;drop: []&#x27;</span>&#125;, <span class="string">&#x27;privileged&#x27;</span>: TRUE&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="10-è¿è¡Œæ²™ç®±å®¹å™¨"><a href="#10-è¿è¡Œæ²™ç®±å®¹å™¨" class="headerlink" title="10. è¿è¡Œæ²™ç®±å®¹å™¨"></a>10. è¿è¡Œæ²™ç®±å®¹å™¨</h2><p>ç»™å‡ºäº† æ”¯æŒå®‰å…¨æ²™ç®±å®¹å™¨è¿è¡Œæ—¶ handler <code>runsc</code>ï¼Œ æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª RuntimeClass å¹¶åœ¨ pod specé‡ŒæŒ‡å®šæ˜¯ç”¨è¯¥ RuntimeClass<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/containers/runtime-class/#2-%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%BA%94%E7%9A%84-runtimeclass-%E8%B5%84%E6%BA%90">å‚è€ƒèµ„æ–™</a></p>
<ul>
<li>åˆ›å»º RuntimeClass</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">untrusted</span> </span><br><span class="line"><span class="attr">handler:</span> <span class="string">runsc</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹ server å‘½åç©ºé—´ æ‰€æœ‰ podï¼Œè®¾ç½® runtimeClassName</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æ³¨æ„ï¼šè¿è¡Œä¸­çš„ pod åªèƒ½ä¿®æ”¹æœ‰é™çš„å‡ ä¸ªå±æ€§ï¼Œä¸æ”¯æŒä¿®æ”¹ RuntimeClassï¼Œéœ€è¦å°†æ‰€æœ‰ pod çš„ yaml è§£æå‡ºæ¥ï¼Œä¿®æ”¹ yaml åï¼Œå†é‡æ–°åˆ›å»º pod</span><br><span class="line">è¿˜éœ€è¦ä¿®æ”¹deployment</span><br><span class="line">    spec:ã€‚</span><br><span class="line">      runtimeClassName: untrusted </span><br><span class="line">      containers:</span><br><span class="line">      - image: vicuu/nginx:host</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: nginx-host</span><br></pre></td></tr></table></figure>

<h2 id="11-åˆ é™¤-ä¸ç¬¦åˆæœ€ä½³å®è·µçš„-pod"><a href="#11-åˆ é™¤-ä¸ç¬¦åˆæœ€ä½³å®è·µçš„-pod" class="headerlink" title="11. åˆ é™¤ ä¸ç¬¦åˆæœ€ä½³å®è·µçš„ pod"></a>11. åˆ é™¤ ä¸ç¬¦åˆæœ€ä½³å®è·µçš„ pod</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">å‚è€ƒé“¾æ¥</a></p>
<ul>
<li>åˆ é™¤å¯ç”¨äº†ç‰¹æƒçš„ pod<br>ä¸»è¦æ˜¯æ£€æŸ¥ pod æ˜¯å¦å« privileged: true<br>kubectl get po xxx -n production -o yaml| grep -i â€œprivileged: trueâ€</li>
<li>åˆ é™¤æœ‰çŠ¶æ€ pod<br>kubectl get pods XXXX -n production -o jsonpath={.spec.volumes} | jq</li>
</ul>
<h2 id="12-æ‰«æé•œåƒå®‰å…¨æ¼æ´å¹¶åˆ é™¤ä½¿ç”¨æœ‰å®‰å…¨æ¼æ´é•œåƒçš„pod"><a href="#12-æ‰«æé•œåƒå®‰å…¨æ¼æ´å¹¶åˆ é™¤ä½¿ç”¨æœ‰å®‰å…¨æ¼æ´é•œåƒçš„pod" class="headerlink" title="12. æ‰«æé•œåƒå®‰å…¨æ¼æ´å¹¶åˆ é™¤ä½¿ç”¨æœ‰å®‰å…¨æ¼æ´é•œåƒçš„pod"></a>12. æ‰«æé•œåƒå®‰å…¨æ¼æ´å¹¶åˆ é™¤ä½¿ç”¨æœ‰å®‰å…¨æ¼æ´é•œåƒçš„pod</h2><p>è¿™é“é¢˜è€ƒå¯Ÿå¯¹äºé•œåƒæ‰«æå·¥å…· trivy çš„ä½¿ç”¨</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># è·å–é•œåƒå</span></span><br><span class="line">kubect <span class="keyword">get</span> pod XXXX -n kamino -o yaml | grep image</span><br><span class="line"><span class="meta"># æ‰«æé•œåƒ</span></span><br><span class="line">trivy image -s HIGH,CRITICAL imagename</span><br><span class="line"><span class="meta"># kubectl delete po xxx</span></span><br></pre></td></tr></table></figure>

<h2 id="13-ä½¿ç”¨-sysdig-æ£€æŸ¥å®¹å™¨é‡Œé‡Œçš„å¼‚å¸¸è¿›ç¨‹"><a href="#13-ä½¿ç”¨-sysdig-æ£€æŸ¥å®¹å™¨é‡Œé‡Œçš„å¼‚å¸¸è¿›ç¨‹" class="headerlink" title="13. ä½¿ç”¨ sysdig æ£€æŸ¥å®¹å™¨é‡Œé‡Œçš„å¼‚å¸¸è¿›ç¨‹"></a>13. ä½¿ç”¨ sysdig æ£€æŸ¥å®¹å™¨é‡Œé‡Œçš„å¼‚å¸¸è¿›ç¨‹</h2><p>æœ¬ä½“è€ƒå¯Ÿæ˜¯å¦æŒæ¡ sysdig çš„åŸºæœ¬ç”¨æ³•ï¼Œè®°ä½ä¸¤ä¸ªå¸®åŠ©å‘½ä»¤ï¼š</p>
<ul>
<li>sysdig -h æŸ¥çœ‹ sysdig å¸®åŠ©</li>
<li>sysdig -l æŸ¥çœ‹ sysdig æ”¯æŒçš„å…ƒæ•°æ®</li>
</ul>
<p>å¦å¤– sysdig æ”¯æŒæŒ‡å®š containerid åˆ†æç‰¹å®šå®¹å™¨</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å®¹å™¨id</span></span><br><span class="line">docker ps |<span class="keyword">grep</span> tomcat</span><br><span class="line">sysdig -M <span class="number">30</span> -p <span class="string">&quot;*<span class="variable">%evt</span>.time,<span class="variable">%user</span>.uid,<span class="variable">%proc</span>.name&quot;</span> container.id=xxxx&gt;opt/DFA/incidents/summary</span><br></pre></td></tr></table></figure>

<h2 id="14-PodSecurityPolicy"><a href="#14-PodSecurityPolicy" class="headerlink" title="14. PodSecurityPolicy"></a>14. PodSecurityPolicy</h2><p>è¿™é“é¢˜è€ƒå¯Ÿæ˜¯å¦æŒæ¡ psp çš„ç”¨æ³•ï¼ŒåŒ…æ‹¬5æ­¥éª¤<br>(1) åˆ›å»º psp<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#example">å‚è€ƒé“¾æ¥</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">restrict-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span> </span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>(2) åˆ›å»º clusterroleï¼Œä½¿ç”¨ psp</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrole <span class="keyword">restrict</span>-<span class="keyword">access</span>-role <span class="comment">--verb=use --resource=psp --resource-name=restrict-policy</span></span><br></pre></td></tr></table></figure>

<p>(3) åˆ›å»º serviceaccount</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">create</span> sa psp-denial-sa -n staging</span><br></pre></td></tr></table></figure>

<p>(4) ç»‘å®š clusterrole åˆ° serviceaccount</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">create</span> clusterrolebinding dany-access-bind <span class="comment">--clusterrole=restrict-access-role --serviceaccount=staging:psp-denial-sa</span></span><br></pre></td></tr></table></figure>

<p>(5) å¯ç”¨ PodSecurityPolicy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/kubernetes/manifests/kube-apiserver.yaml </span><br><span class="line"><span class="comment">#ç¡®ä¿æœ‰ä»¥ä¸‹å†…å®¹ï¼š</span></span><br><span class="line">- --enable-admission-plugins=NodeRestriction,PodSecurityPolicy</span><br></pre></td></tr></table></figure>

<h2 id="15-å¯ç”¨-API-serverè®¤è¯"><a href="#15-å¯ç”¨-API-serverè®¤è¯" class="headerlink" title="15. å¯ç”¨ API serverè®¤è¯"></a>15. å¯ç”¨ API serverè®¤è¯</h2><p>è¿™é“é¢˜åŒå‰é¢ kube-bench çš„è€ƒæ ¸å†…å®¹æœ‰ç‚¹é‡åˆï¼Œé¢˜ç›®ä¸­æ˜¯ç”¨ kubeamdåˆ›å»ºçš„ kubernetesæœåŠ¡å™¨æƒé™è®¾ç½®æœ‰é—®é¢˜ï¼Œå…è®¸æœªç»æˆæƒçš„è®¿é—®ã€‚<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">å‚è€ƒé“¾æ¥</a><br>éœ€è¦è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š</p>
<ul>
<li>ä½¿ç”¨ Node,RBAC æˆæƒæ¨¡å¼å’Œ NodeRestriction å‡†å…¥æ§åˆ¶å™¨</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"><span class="section"># ç¡®ä¿ä»¥ä¸‹å†…å®¹</span></span><br><span class="line"><span class="bullet">-</span> --authorization-mode=Node,RBAC</span><br><span class="line"><span class="bullet">-</span> --enable-admission-plugins=NodeRestriction</span><br><span class="line"><span class="bullet">-</span> --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line"><span class="bullet">-</span> --enable-bootstrap-token-auth=true</span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ é™¤ system:anonymous çš„ ClusterRolebindingè§’è‰²ç»‘å®šï¼Œå–æ¶ˆåŒ¿åç”¨æˆ·çš„é›†ç¾¤ç®¡ç†å‘˜æƒé™</li>
</ul>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="keyword">delete</span> clusterrolebinding <span class="keyword">system</span>:anonymous</span><br></pre></td></tr></table></figure>

<h2 id="16-ImagePolicyWebhook"><a href="#16-ImagePolicyWebhook" class="headerlink" title="16. ImagePolicyWebhook"></a>16. ImagePolicyWebhook</h2><p>è¿™é“é¢˜è€ƒå¯Ÿ ImagePolicyWebhook å‡†å…¥æ§åˆ¶å™¨çš„ä½¿ç”¨ï¼Œåˆ†4ä¸ªæ­¥éª¤</p>
<ul>
<li>ä¿®æ”¹æ§åˆ¶å™¨é…ç½®æ–‡ä»¶ï¼Œå°†æœªæ‰¾åˆ°æœ‰æ•ˆåç«¯æ—¶çš„é»˜è®¤æ‹’ç»æ”¹ä¸ºé»˜è®¤ä¸æ‹’ç»<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook">å‚è€ƒé“¾æ¥
</a></li>
</ul>
<p>vi /etc/kubernetes/epconfig/admission_configuration.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;imagePolicy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;kubeConfigFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/kubernetes/epconfig/kubeconfig.yaml&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;allowTTL&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;denyTTL&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;retryBackoff&quot;</span><span class="punctuation">:</span> <span class="number">500</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;defaultAllow&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹ æ§åˆ¶å™¨è®¿é—® webhook server çš„ kubeconfig</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vi</span> <span class="string">/etc/kubernetes/epconfig/kubeconfig.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">ä¿®æ”¹å¦‚ä¸‹å†…å®¹</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority:</span> <span class="string">/etc/kubernetes/epconfig/webhook.pem</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://acme.local:8082/image_policy</span>  <span class="comment"># web hook server çš„åœ°å€</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bouncer_webhook</span></span><br><span class="line"><span class="comment"># ä»¥ä¸‹çœç•¥</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å¯ç”¨ImagePolicyWebhook<br>vi /etc/kubernetes/manifests/kube-apiserver.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨ ImagePolicyWebhook</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--enable-admission-plugins=NodeRestriction,ImagePolicyWebhook</span></span><br><span class="line"><span class="comment"># æŒ‡å®šå‡†å…¥æ§åˆ¶å™¨é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--admission-control-config-file=/etc/kubernetes/epconfig/admission_configuration.json</span></span><br><span class="line"><span class="comment"># mount</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/epconfig</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">epconfig</span></span><br><span class="line"><span class="comment"># æ˜ å°„ volumes      </span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">epconfig</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/epconfig</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æµ‹è¯•æ˜¯å¦ç”Ÿæ•ˆ</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">kubectl apply -f /cks/img/web1.yaml</span><br></pre></td></tr></table></figure>

<p>From: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/myocp/p/15915123.html">2022å¹´2æœˆæˆ‘çš„CKSå¤‡è€ƒè®°å½• - scwang18 - åšå®¢å›­ (cnblogs.com)</a></p>
<hr>
<h1 id="çœŸé¢˜â‘¡åŸºäº1-26ç‰ˆæœ¬"><a href="#çœŸé¢˜â‘¡åŸºäº1-26ç‰ˆæœ¬" class="headerlink" title="çœŸé¢˜â‘¡åŸºäº1.26ç‰ˆæœ¬"></a>çœŸé¢˜â‘¡åŸºäº1.26ç‰ˆæœ¬</h1><h2 id="è€ƒè¯•å†…å®¹"><a href="#è€ƒè¯•å†…å®¹" class="headerlink" title="è€ƒè¯•å†…å®¹"></a>è€ƒè¯•å†…å®¹</h2><p><a target="_blank" rel="noopener" href="https://training.linuxfoundation.org/certification/certified-kubernetes-security-specialist/#">CKS è€ƒè¯•é“¾æ¥</a><br><a target="_blank" rel="noopener" href="https://docs.linuxfoundation.org/tc-docs/certification/important-instructions-cks">Important Instructions: CKS</a></p>
<ul>
<li>è€ƒè¯•åŒ…æ‹¬ 15-20 é¡¹performance-based tasksã€‚<ul>
<li>2023.1 å®æµ‹æ˜¯16é“é¢˜</li>
</ul>
</li>
<li>è€ƒç”Ÿæœ‰ 2 å°æ—¶çš„æ—¶é—´å®Œæˆ CKS è€ƒè¯•ã€‚<ul>
<li>å› ä¸ºä»06/2022å¼€å§‹ç¯å¢ƒå‡çº§ï¼ˆè´¬ä¹‰ï¼‰ï¼Œè€ƒè¯•ç¯å¢ƒæ›´éš¾ç”¨äº†ï¼Œå˜çš„å¾ˆå¡ï¼Œæ‰€ä»¥æ—¶é—´å˜å¾—æ¯”è¾ƒç´§å¼ ã€‚å®¹æ˜“åšä¸å®Œé¢˜ï¼Œå»ºè®®å…ˆæŠŠæœ‰æŠŠæ¡çš„ï¼ŒèŠ±è´¹æ—¶é—´ä¸å¤šçš„é¢˜å…ˆåšæ‰<ul>
<li><a target="_blank" rel="noopener" href="https://itnext.io/cks-cka-ckad-changed-terminal-to-remote-desktop-157a26c1d5e">CKS CKA CKAD changed Terminal to Remote Desktop</a></li>
</ul>
</li>
</ul>
</li>
<li>CKSè€ƒè¯•67åˆ†ä»¥ä¸Šå³å¯é€šè¿‡ï¼Œè€ƒè¯•ä¸é€šè¿‡æœ‰ä¸€æ¬¡è¡¥è€ƒæœºä¼šã€‚</li>
</ul>
<p>Certifications- expire 36 months from the date that the Program certification requirements are met by a candidate.</p>
<h3 id="Certified-Kubernetes-Security-Specialist-CKS"><a href="#Certified-Kubernetes-Security-Specialist-CKS" class="headerlink" title="Certified Kubernetes Security Specialist (CKS)"></a>Certified Kubernetes Security Specialist (CKS)</h3><p>The following tools and resources are allowed during the exam as long as they are used by candidates to work independently on exam tasks (i.e. not used for 3rd party assistance or research) and are accessed from within the Linux server terminal on which the Exam is delivered.<br>During the exam, candidates may:</p>
<ul>
<li>review the Exam content instructions that are presented in the command line terminal.</li>
<li>review Documents installed by the distribution (i.e. /usr/share and its subdirectories)</li>
<li>use the search function provided on <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/">https://kubernetes.io/docs/</a> however, they may only open search results that have a domain matching the sites listed below</li>
<li>use the browser within the VM to access the following documentation:<ul>
<li>Kubernetes Documentation:<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/">https://kubernetes.io/docs/</a> and their subdomains</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/blog/">https://kubernetes.io/blog/</a> and their subdomains<br>This includes all available language translations of these pages (e.g. <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/">https://kubernetes.io/zh/docs/</a>)</li>
</ul>
</li>
<li>Tools:<ul>
<li>Trivy documentation <a target="_blank" rel="noopener" href="https://aquasecurity.github.io/trivy/">https://aquasecurity.github.io/trivy/</a></li>
<li>Falco documentation <a target="_blank" rel="noopener" href="https://falco.org/docs/">https://falco.org/docs/</a><br>This includes all available language translations of these pages (e.g. <a target="_blank" rel="noopener" href="https://falco.org/zh/docs/">https://falco.org/zh/docs/</a>)</li>
</ul>
</li>
<li>App Armor:<ul>
<li>Documentation <a target="_blank" rel="noopener" href="https://gitlab.com/apparmor/apparmor/-/wikis/Documentation">https://gitlab.com/apparmor/apparmor/-/wikis/Documentation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Youâ€™re only allowed to have one other browser tab open with:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs">https://kubernetes.io/docs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes">https://github.com/kubernetes</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/blog">https://kubernetes.io/blog</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/trivy">https://github.com/aquasecurity/trivy</a></li>
<li><a target="_blank" rel="noopener" href="https://falco.org/docs">https://falco.org/docs</a></li>
<li><a target="_blank" rel="noopener" href="https://gitlab.com/apparmor/apparmor/-/wikis/Documentation">https://gitlab.com/apparmor/apparmor/-/wikis/Documentation</a></li>
</ul>
<h3 id="CKS-Environment"><a href="#CKS-Environment" class="headerlink" title="CKS Environment"></a>CKS Environment</h3><ul>
<li>Each task on this exam must be completed on a designated cluster/configuration context.</li>
<li>Sixteen clusters comprise the exam environment, one for each task. Each cluster is made up of one master node and one worker node.</li>
<li>An infobox at the start of each task provides you with the cluster name/context and the hostname of the master and worker node.</li>
<li>You can switch the cluster/configuration context using a command such as the following:</li>
<li><code>kubectl config use-context &lt;cluster/context name&gt;</code></li>
<li>Nodes making up each cluster can be reached via ssh, using a command such as the following:</li>
<li><code>ssh &lt;nodename&gt;</code></li>
<li>You have elevated privileges on any node by default, so there is no need to assume elevated privileges.</li>
<li>You must return to the base node (hostname cli) after completing each task.</li>
<li>Nested <code>âˆ’ssh</code> is not supported.</li>
<li>You can use <code>kubectl</code> and the appropriate context to work on any cluster from the base node. When connected to a cluster member via ssh, you will only be able to work on that particular cluster via kubectl.</li>
<li>For your convenience, all environments, in other words, the base system and the cluster nodes, have the following additional command-line tools pre-installed and pre-configured:<ul>
<li><code>kubectl</code> with kalias and Bash autocompletion</li>
<li><code>yq</code> and <code>jq</code> for YAML/JSON processing</li>
<li><code>tmux</code> for terminal multiplexing</li>
<li><code>curl</code> and <code>wget</code> for testing web services</li>
<li><code>man</code> and man pages for further documentation</li>
</ul>
</li>
<li>Further instructions for connecting to cluster nodes will be provided in the appropriate tasks</li>
<li>The CKS environment is currently running etcd v3.5</li>
<li>The CKS environment is currently running Kubernetes v1.26</li>
<li>The CKS exam environment will be aligned with the most recent K8s minor version within approximately 4 to 8 weeks of the K8s release date.</li>
</ul>
<h3 id="More-items-for-CKS-than-CKA-and-CKAD"><a href="#More-items-for-CKS-than-CKA-and-CKAD" class="headerlink" title="More items for CKS than CKA and CKAD"></a>More items for CKS than CKA and CKAD</h3><ul>
<li>Pod Security Policies(PSP) - removed from Kubernetes in <code>v1.25</code></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/security/apparmor/">AppArmor</a></li>
<li>Apiserver<ul>
<li>Apiserver Crash</li>
<li>Apiserver NodeRestriction</li>
</ul>
</li>
<li>ImagePolicyWebhook</li>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-bench">kube-bench</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/trivy">Trivy</a></li>
</ul>
<h3 id="CKS-çŸ¥è¯†ç‚¹-amp-ç»ƒä¹ é¢˜æ€»ç»“"><a href="#CKS-çŸ¥è¯†ç‚¹-amp-ç»ƒä¹ é¢˜æ€»ç»“" class="headerlink" title="CKS çŸ¥è¯†ç‚¹&amp;ç»ƒä¹ é¢˜æ€»ç»“"></a><a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernetes-CKS-%E7%9F%A5%E8%AF%86%E7%82%B9-%E7%BB%83%E4%B9%A0%E9%A2%98.html">CKS çŸ¥è¯†ç‚¹&amp;ç»ƒä¹ é¢˜æ€»ç»“</a></h3><h2 id="å¦‚ä½•å¤‡è€ƒ"><a href="#å¦‚ä½•å¤‡è€ƒ" class="headerlink" title="å¦‚ä½•å¤‡è€ƒ"></a>å¦‚ä½•å¤‡è€ƒ</h2><h3 id="k8sç»ƒä¹ ç¯å¢ƒ-åŒCKA"><a href="#k8sç»ƒä¹ ç¯å¢ƒ-åŒCKA" class="headerlink" title="k8sç»ƒä¹ ç¯å¢ƒ(åŒCKA)"></a><a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernates-Certified-Kubernetes-Administrator-CKA.html#k8s%E7%BB%83%E4%B9%A0%E7%8E%AF%E5%A2%83">k8sç»ƒä¹ ç¯å¢ƒ</a>(åŒCKA)</h3><h3 id="CKSç»ƒä¹ é¢˜"><a href="#CKSç»ƒä¹ é¢˜" class="headerlink" title="CKSç»ƒä¹ é¢˜"></a>CKSç»ƒä¹ é¢˜</h3><p>æœ‰å‡ ä¸ªç»ƒä¹ åº“ï¼Œå»ºè®®å°†æ¯ä¸ªé¢˜ç›®éƒ½è‡ªå·±äº²è‡ªæ“ä½œä¸€éï¼Œä¸€å®šè¦æ“ä½œã€‚</p>
<ul>
<li>CKSåœ¨çº¿ç»ƒä¹ ç¯å¢ƒï¼š<a target="_blank" rel="noopener" href="https://killercoda.com/killer-shell-cks">https://killercoda.com/killer-shell-cks</a></li>
<li><a target="_blank" rel="noopener" href="https://killer.sh/attendee/f65d95f1-170b-444d-8af0-bbf302f8c796/content">CKS Simulator Kubernetes 1.26</a></li>
<li><a target="_blank" rel="noopener" href="https://killercoda.com/killer-shell-ckad/scenario/admission-controllers">Adminission pligin/Pod Security Policies ç»ƒä¹ </a></li>
</ul>
<h3 id="CKSè¯¾ç¨‹"><a href="#CKSè¯¾ç¨‹" class="headerlink" title="CKSè¯¾ç¨‹"></a>CKSè¯¾ç¨‹</h3><ul>
<li>ã€éœ€ä»˜è´¹ã€‘CKSè€ƒè¯•-å¯¹åº”å®˜æ–¹è¯¾ç¨‹<a target="_blank" rel="noopener" href="https://training.linuxfoundation.org/training/kubernetes-security-essentials-lfs260/">Kubernetes for Developers (LFS260)</a> æ„Ÿè§‰æ²¡å¿…è¦ä¹°ï¼Œåªçœ‹å®˜æ–¹æ–‡æ¡£å°±è¶³å¤Ÿäº†ã€‚</li>
</ul>
<h3 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"># ä¸ç†Ÿ</span><br><span class="line">## è¾“å‡ºpod status</span><br><span class="line">kubectl -n default describe pod pod1 | grep -i status:</span><br><span class="line">kubectl -n default get pod pod1 -o jsonpath=&quot;&#123;.status.phase&#125;&quot;</span><br><span class="line">## Check the pod for error</span><br><span class="line">kubectl describe pod podname | grep -i error</span><br><span class="line">... Error: ImagePullBackOff</span><br><span class="line">## a fast way to get an overview of the ReplicaSets of a Deployment and their images could be done with:</span><br><span class="line">kubectl -n neptune get rs -o wide | grep deployname</span><br><span class="line">NAME         DESIRED   CURRENT   READY   AGE    CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">deployname   3         3         3       9m6s   httpd        httpd:alpine   app=wonderful</span><br><span class="line"></span><br><span class="line">## åˆ›å»ºjob</span><br><span class="line">kubectl -n neptune create job neb-new-job --image=busybox:1.31.0 $do &gt; /opt/course/3/job.yaml -- sh -c &quot;sleep 2 &amp;&amp; echo done&quot;</span><br><span class="line">## If a Secret bolongs to a serviceaccount, it&#x27;ll have the annotation kubernetes.io/service-account.name</span><br><span class="line">kubectl get secrets -oyaml | grep annotations -A 1 # shows secrets with first annotation</span><br><span class="line">## log</span><br><span class="line">kubectl logs podname &gt; /opt/test.log</span><br><span class="line">## decode base64</span><br><span class="line">base64 -d filename</span><br><span class="line">## check service connection using a temporary Pod</span><br><span class="line">## k run tmp --restart=Never --rm --image=nginx:alpine -i -- curl http://svcname.namespace:svcport</span><br><span class="line">kubectl run tmp --restart=Never --rm --image=nginx:alpine -i -- curl http://svcname.namespace:80</span><br><span class="line">## check that both PV and PVC have the status Bound:</span><br><span class="line">k -n earth get pv,pvc</span><br><span class="line">NAME                                            CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                 STORAGECLASS   REASON   AGE</span><br><span class="line">persistentvolume/earth-project-earthflower-pv   2Gi        RWO            Retain           Bound    earth/earth-project-earthflower-pvc                           8m4s</span><br><span class="line"></span><br><span class="line">NAME                                                  STATUS   VOLUME                         CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">persistentvolumeclaim/earth-project-earthflower-pvc   Bound    earth-project-earthflower-pv   2Gi        RWO                           7m38s</span><br><span class="line"></span><br><span class="line">## We can confirm the pod of deployment with PVC mounting correctly:</span><br><span class="line">k describe pod project-earthflower-586758cc49-hb87f -n earth | grep -A2 Mount:</span><br><span class="line">    Mounts:</span><br><span class="line">      /tmp/project-data from task-pv-storage (rw)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-jj2t2 (ro)</span><br><span class="line"></span><br><span class="line">## Verify everything using kubectl auth can-i</span><br><span class="line">kubectl auth can-i create deployments --as system:serviceaccount:app-team1:cicd-token -n app-team1 # YES</span><br><span class="line"># å¸¸ç”¨</span><br><span class="line">## åˆ›å»ºpod</span><br><span class="line">kubectl run pod1 --image=httpd:2.4.41-alpine $do &gt; 2.yaml</span><br><span class="line">kubectl get pod sat-003 -o yaml &gt; 7-sat-003.yaml # export</span><br><span class="line">kubectl delete pod pod1 --force --grace-period=0</span><br><span class="line">## åˆ›å»ºservice</span><br><span class="line">kubectl expose deployment d1 --name=æœåŠ¡å --port=æœåŠ¡ç«¯å£ --target-port=podè¿è¡Œç«¯å£ --type=ç±»å‹</span><br><span class="line">kubectl expose pod podå --name=æœåŠ¡å --port=æœåŠ¡ç«¯å£ --target-port=podè¿è¡Œç«¯å£ --type=ç±»å‹</span><br><span class="line"># CKS</span><br><span class="line">## åˆ›å»ºsecret</span><br><span class="line">kubectl create secret generic db-credentials --from-literal db-password=passwd</span><br><span class="line">## modify a pod yaml to deployment yaml</span><br><span class="line">### put the Pod&#x27;s metadata: and spec: into the Deployment&#x27;s template: section:</span><br><span class="line"></span><br><span class="line">## To verify that the token hasn&#x27;t been mounted run the following commands:</span><br><span class="line">kubectl -n one exec -it pod-name -- mount | grep serviceaccount</span><br><span class="line">kubectl -n one exec -it pod-name -- cat /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br><span class="line">### åˆ›å»º clusterroleï¼Œä½¿ç”¨ psp</span><br><span class="line">kubectl create clusterrole restrict-access-role --verb=use --resource=psp --resource-name=restrict-policy</span><br><span class="line"></span><br><span class="line">## after modify /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line">### æŸ¥è¯¢ sa å¯¹åº”çš„ role åç§°ï¼ˆå‡è®¾æ˜¯ role-1ï¼‰</span><br><span class="line">kubectl get rolebinding -n db -oyaml | grep &#x27;service-account-web&#x27; -B 10</span><br><span class="line"></span><br><span class="line">### grep</span><br><span class="line">grep apple -A 10 # appleä¹‹å10è¡Œ</span><br><span class="line"></span><br><span class="line">grep apple -B 10 # appleä¹‹å‰10è¡Œ</span><br><span class="line"></span><br><span class="line">### secret used by pod</span><br><span class="line">kubectl exec pod1 -- env</span><br><span class="line">kubectl exec pod1 -- cat /etc/diver/hosts</span><br></pre></td></tr></table></figure>

<ul>
<li><p><a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernates-Certified-Kubernetes-Administrator-CKA.html#%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93">ç»éªŒæ€»ç»“</a>(åŒCKA)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernates-Certified-Kubernetes-Administrator-CKA.html#pre-setup">Pre Setup</a>(åŒCKA)</p>
</li>
</ul>
<h2 id="CKS-2023-çœŸé¢˜-1-26"><a href="#CKS-2023-çœŸé¢˜-1-26" class="headerlink" title="CKS 2023 çœŸé¢˜ 1.26"></a>CKS 2023 çœŸé¢˜ 1.26</h2><h3 id="è€ƒé¢˜1-AppArmor-è®¿é—®æ§åˆ¶"><a href="#è€ƒé¢˜1-AppArmor-è®¿é—®æ§åˆ¶" class="headerlink" title="è€ƒé¢˜1 - AppArmor è®¿é—®æ§åˆ¶"></a>è€ƒé¢˜1 - AppArmor è®¿é—®æ§åˆ¶</h3><h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><p>AppArmor is enabled on the clusterâ€™s worker node. An AppArmor profile is prepared, but not enforced yet.<br>You may use your browser to open one additional tab to access the AppArmor documentation.</p>
<p>AppArmor å·²åœ¨ cluster çš„å·¥ä½œèŠ‚ç‚¹ä¸Šè¢«å¯ç”¨ã€‚ä¸€ä¸ª AppArmor é…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œä½†å°šæœªè¢«å®æ–½ã€‚</p>
<h4 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h4><p>On the clusterâ€™s worker node, enforce the prepared AppArmor profile located at <code>/etc/apparmor.d/nginx_apparmor</code> .<br>Edit the prepared manifest file located at <code>/home/candidate/KSSH00401/nginx-deploy.yaml</code> to apply the AppArmor profile.<br>Finally, apply the manifest file and create the pod specified in it.</p>
<p>åœ¨ cluster çš„å·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œå®æ–½ä½äº <code>/etc/apparmor.d/nginx_apparmor</code> çš„ç°æœ‰ AppArmor é…ç½®æ–‡ä»¶ã€‚<br>ç¼–è¾‘ä½äº <code>/home/candidate/KSSH00401/nginx-deploy.yaml</code> çš„ç°æœ‰æ¸…å•æ–‡ä»¶ä»¥åº”ç”¨ AppArmor é…ç½®æ–‡ä»¶ã€‚<br>æœ€åï¼Œåº”ç”¨æ¸…å•æ–‡ä»¶å¹¶åˆ›å»ºå…¶ä¸­æŒ‡å®šçš„ Pod ã€‚</p>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>æœç´¢ apparmorï¼ˆä½¿ç”¨ AppArmor é™åˆ¶å®¹å™¨å¯¹èµ„æºçš„è®¿é—®ï¼‰ï¼Œæ¥ç€å†æœç´¢å­—ç¬¦ä¸² â€œparserâ€<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tutorials/security/apparmor/">https://kubernetes.io/zh/docs/tutorials/security/apparmor/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## è¿œç¨‹ç™»å½•åˆ°æŒ‡å®šå·¥ä½œèŠ‚ç‚¹</span></span></span><br><span class="line">ssh cka-node01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## ä»profileæ–‡ä»¶æŸ¥çœ‹ç­–ç•¥åç§°</span></span></span><br><span class="line">cat /etc/apparmor.d/nginx_apparmor</span><br><span class="line"></span><br><span class="line">    profile nginx-profile flags=(attach_disconnected) &#123;</span><br><span class="line">    ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## åŠ è½½ apparmor é…ç½®æ–‡ä»¶</span></span></span><br><span class="line">apparmor_parser /etc/apparmor.d/nginx_apparmor</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## æŸ¥çœ‹ç­–ç•¥åç§°ï¼Œç»“æœæ˜¯ nginx-profile</span></span></span><br><span class="line">apparmor_status | grep nginx-profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## å›åˆ°æ§åˆ¶èŠ‚ç‚¹ï¼Œå¹¶æ›´æ–° Pod çš„æ³¨è§£</span></span></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">vim /home/candidate/KSSH00401/nginx-deploy.yaml</span><br><span class="line">    annotations:</span><br><span class="line">      ### hello æ˜¯ Pod é‡Œå®¹å™¨åç§°ï¼Œnginx-profile åˆ™æ˜¯ apparmor_status è§£æå‡ºæ¥çš„ç»“æœ</span><br><span class="line">      container.apparmor.security.beta.kubernetes.io/hello: localhost/nginx-profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## å¦‚æœ apply åæŠ¥é”™ï¼Œåˆ™å…ˆåˆ é™¤ä¿å­˜å¹¶åˆ é™¤æ—§ Podï¼Œæ”¹å®Œåå†åˆ›å»ºæ–°çš„</span></span></span><br><span class="line">kubectl apply -f /home/candidate/KSSH00401/nginx-deploy.yaml</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜2-Kube-Bench-åŸºå‡†æµ‹è¯•"><a href="#è€ƒé¢˜2-Kube-Bench-åŸºå‡†æµ‹è¯•" class="headerlink" title="è€ƒé¢˜2 - Kube-Bench åŸºå‡†æµ‹è¯•"></a>è€ƒé¢˜2 - Kube-Bench åŸºå‡†æµ‹è¯•</h3><h4 id="Context-1"><a href="#Context-1" class="headerlink" title="Context"></a>Context</h4><p>A CIS Benchmark tool was run against the kubeadm-created cluster and found multiple issues that must be addressed immediately.</p>
<p>é’ˆå¯¹ kubeadm åˆ›å»ºçš„ cluster è¿è¡Œ CIS åŸºå‡†æµ‹è¯•å·¥å…·æ—¶ï¼Œ å‘ç°äº†å¤šä¸ªå¿…é¡»ç«‹å³è§£å†³çš„é—®é¢˜ã€‚</p>
<h4 id="Task-1"><a href="#Task-1" class="headerlink" title="Task"></a>Task</h4><p>Fix all issues via configuration and restart theaffected components to ensure the new settings take effect.<br>é€šè¿‡é…ç½®ä¿®å¤æ‰€æœ‰é—®é¢˜å¹¶é‡æ–°å¯åŠ¨å—å½±å“çš„ç»„ä»¶ä»¥ç¡®ä¿æ–°çš„è®¾ç½®ç”Ÿæ•ˆã€‚</p>
<p>Fix all of the following violations that were found against the API server:<br>ä¿®å¤é’ˆå¯¹ API æœåŠ¡å™¨å‘ç°çš„æ‰€æœ‰ä»¥ä¸‹è¿è§„è¡Œä¸ºï¼š<br>Ensure that the 1.2.7 â€“authorization-mode FAIL argument is not set to AlwaysAllow<br>Ensure that the 1.2.8 â€“authorization-mode FAIL argument includes Node<br>Ensure that the 1.2.9 â€“authorization-mode FAIL argument includes RBAC<br>Ensure that the 1.2.18 â€“insecure-bind-address FAIL argument is not set<br>Ensure that the 1.2.19 â€“insecure-port FAIL argument is set to 0</p>
<p>Fix all of the following violations that were found against the kubelet:<br>ä¿®å¤é’ˆå¯¹ kubelet å‘ç°çš„æ‰€æœ‰ä»¥ä¸‹è¿è§„è¡Œä¸ºï¼š<br>Ensure that the 4.2.1 â€“anonymous-auth FAIL argument is set to false<br>Ensure that the 4.2.2 â€“authorization-mode FAIL argument is not set to AlwaysAllow<br>Use <code>Webhook</code> authn/authz where possible. æ³¨æ„ï¼šå°½å¯èƒ½ä½¿ç”¨ Webhook authn/authzã€‚</p>
<p>Fix all of the following violations that were found against etcd:<br>ä¿®å¤é’ˆå¯¹ etcd å‘ç°çš„æ‰€æœ‰ä»¥ä¸‹è¿è§„è¡Œä¸ºï¼š<br>Ensure that the 4.2.1 â€“client-cert-auth FAIL argument is set to true</p>
<h4 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ ssh root@vms65.rhce.cc</span><br><span class="line"></span><br><span class="line"># kube-bench run --target=master --check=1.2.7</span><br><span class="line">kube-bench run --target=master | grep FAIL</span><br><span class="line"></span><br><span class="line">### ä¿®å¤é’ˆå¯¹ APIserver å‘ç°çš„ä»¥ä¸‹æ‰€æœ‰é—®é¢˜ï¼š</span><br><span class="line">### ç¡®ä¿ 1.2.7 --authorization-mode å‚æ•°ä¸èƒ½è®¾ç½®ä¸º AlwaysAllow</span><br><span class="line">### ç¡®ä¿ 1.2.8 --authorization-mode å‚æ•°åŒ…å« Node</span><br><span class="line">### ç¡®ä¿ 1.2.9 --authorization-mode å‚æ•°åŒ…å« RBAC</span><br><span class="line">### ç¡®ä¿ 1.2.18 --insecure-bind-address å‚æ•°ä¸èƒ½è®¾ç½®</span><br><span class="line">### ç¡®ä¿ 1.2.19 --insecure-port å‚æ•°è®¾ç½®ä¸º 0</span><br><span class="line">### æ³¨æ„ï¼šä¿®æ”¹ master èŠ‚ç‚¹ï¼</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">    #- --authorization-mode=AlwaysAllow åˆ é™¤AlwaysAllowï¼ŒåŠ Node,RBAC</span><br><span class="line">    - --authorization-mode=Node,RBAC</span><br><span class="line">    #- --insecure-bind-address=0.0.0.0</span><br><span class="line">    - --insecure-port=0</span><br><span class="line"></span><br><span class="line">### ä¿®å¤é’ˆå¯¹ kubelet å‘ç°çš„ä»¥ä¸‹æ‰€æœ‰é—®é¢˜ï¼š</span><br><span class="line">### ç¡®ä¿ 4.2.1 anonymous-auth å‚æ•°è®¾ç½®ä¸º false</span><br><span class="line">### ç¡®ä¿ 4.2.2 --authorization-mode å‚æ•°ä¸èƒ½è®¾ç½®ä¸º AlwaysAllowï¼Œå°½å¯èƒ½ä½¿ç”¨ Webhook authn/authz</span><br><span class="line">### æ³¨æ„ï¼šmaster å’Œ node èŠ‚ç‚¹éƒ½è¦ä¿®æ”¹ï¼</span><br><span class="line">vim /var/lib/kubelet/config.yaml</span><br><span class="line">    authentication:</span><br><span class="line">      anonymous:</span><br><span class="line">        enabled: false</span><br><span class="line">    authorization:</span><br><span class="line">      mode: Webhook</span><br><span class="line"></span><br><span class="line">### ä¿®å¤é’ˆå¯¹ etcd å‘ç°çš„ä»¥ä¸‹æ‰€æœ‰é—®é¢˜ï¼š</span><br><span class="line">### ç¡®ä¿ 4.2.--client-cert-auth å‚æ•°è®¾ç½®ä¸º true</span><br><span class="line">### æ³¨æ„ï¼šä¿®æ”¹ master èŠ‚ç‚¹ï¼</span><br><span class="line">vim /etc/kubernetes/manifests/etcd.yaml</span><br><span class="line">    - --client-cert-auth=true</span><br><span class="line"></span><br><span class="line">### åŠ è½½å¹¶é‡å¯ kubelet æœåŠ¡</span><br><span class="line">### æ³¨æ„ï¼šmaster å’Œ node èŠ‚ç‚¹éƒ½è¦é‡å¯ï¼</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜3-Trivy-é•œåƒæ‰«æ"><a href="#è€ƒé¢˜3-Trivy-é•œåƒæ‰«æ" class="headerlink" title="è€ƒé¢˜3 - Trivy é•œåƒæ‰«æ"></a>è€ƒé¢˜3 - Trivy é•œåƒæ‰«æ</h3><h4 id="Task-2"><a href="#Task-2" class="headerlink" title="Task"></a>Task</h4><p>ä½¿ç”¨ Trivy å¼€æºå®¹å™¨æ‰«æå™¨æ£€æµ‹ namespace kamino ä¸­ Pod ä½¿ç”¨çš„å…·æœ‰ä¸¥é‡æ¼æ´çš„é•œåƒã€‚<br>æŸ¥æ‰¾å…·æœ‰ High æˆ– Critical ä¸¥é‡æ€§æ¼æ´çš„é•œåƒï¼Œå¹¶åˆ é™¤ä½¿ç”¨è¿™äº›é•œåƒçš„ Podã€‚<br>æ³¨æ„ï¼šTrivy ä»…å®‰è£…åœ¨ cluster çš„ master èŠ‚ç‚¹ä¸Šï¼Œåœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šä¸å¯ä½¿ç”¨ã€‚ä½ å¿…é¡»åˆ‡æ¢åˆ° cluster çš„ master èŠ‚ç‚¹æ‰èƒ½ä½¿ç”¨ Trivy ã€‚</p>
<p>Use the Trivy open-source container scanner to detect images with severe vulnerabilities used by Pods in the namespace <code>kamino</code>.<br>Look for images with <code>High</code> or <code>Critical</code> severity vulnerabilities, and delete the Pods that use those images.</p>
<p>Trivy is pre-installed on the clusterâ€™s <code>master</code> node only; it is not available on the base system or the worker nodes. Youâ€™ll have to connect to the clusterâ€™s master node to use <code>Trivy</code>.</p>
<h4 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution"></a>Solution</h4><p>æœç´¢ kubectl imagesï¼ˆåˆ—å‡ºé›†ç¾¤ä¸­æ‰€æœ‰è¿è¡Œå®¹å™¨çš„é•œåƒï¼‰<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/list-all-running-container-images/">https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/list-all-running-container-images/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">### éœ€ç™»å½•åˆ°æ§åˆ¶èŠ‚ç‚¹æ“ä½œ</span><br><span class="line">ssh cka-master01</span><br><span class="line"></span><br><span class="line">### æŸ¥è¯¢å‘½åç©ºé—´ kamino ä¸­ pod ä½¿ç”¨çš„é•œåƒ</span><br><span class="line">kubectl get pod -n kamino -o yaml | grep image:</span><br><span class="line"># æˆ–è€…</span><br><span class="line">kubectl get pods -n kamino -o jsonpath=&#x27;&#123;range .items[*]&#125;&#123;&quot;\n&quot;&#125;&#123;.metadata.name&#125;&#123;&quot;:\t&quot;&#125;&#123;range .spec.containers[*]&#125;&#123;.image&#125;&#123;&quot;, &quot;&#125;&#123;end&#125;&#123;end&#125;&#x27; | sort</span><br><span class="line"></span><br><span class="line">### å‡è®¾é•œåƒæ˜¯ registry.aliyuncs.com/google_containers/coredns:1.7.0</span><br><span class="line">### ä½¿ç”¨ trivy å·¥å…·æŸ¥è¯¢å…·æœ‰ HIGH æˆ– CRITICAL æ¼æ´çš„é•œåƒ</span><br><span class="line">trivy --help</span><br><span class="line">trivy image --severity HIGH,CRITICAL &#x27;registry.aliyuncs.com/google_containers/coredns:1.7.0&#x27;</span><br><span class="line"></span><br><span class="line">### åˆ é™¤æ£€æµ‹åˆ°çš„æ¼æ´é•œåƒå¯¹åº”çš„ podï¼ˆå¦‚æœæœ‰æ§åˆ¶å™¨ï¼Œå¾—åˆ é™¤æ§åˆ¶å™¨ï¼‰</span><br><span class="line">kubectl delete pod -n kamino podåç§°</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜4-Sysdig-amp-Falco"><a href="#è€ƒé¢˜4-Sysdig-amp-Falco" class="headerlink" title="è€ƒé¢˜4 - Sysdig &amp; Falco"></a>è€ƒé¢˜4 - Sysdig &amp; Falco</h3><p>you may use you brower to open one additonal tab to access sysdigâ€™s documentation or Falcoâ€™s documentaion</p>
<h4 id="Task-3"><a href="#Task-3" class="headerlink" title="Task"></a>Task</h4><p>Use runtime detection tools to detect anomalous processes spawning and executing frequently in the sigle container belonging to Pod <code>redis</code>. Two tools are avaliable to use:<br>ä½¿ç”¨è¿è¡Œæ—¶æ£€æµ‹å·¥å…·æ¥æ£€æµ‹ Pod tomcat å•ä¸ªå®¹å™¨ä¸­é¢‘å‘ç”Ÿæˆå’Œæ‰§è¡Œçš„å¼‚å¸¸è¿›ç¨‹ã€‚æœ‰ä¸¤ç§å·¥å…·å¯ä¾›ä½¿ç”¨ï¼š</p>
<ul>
<li>sysdig</li>
<li>falco</li>
</ul>
<p>The tools are pre-installed on the clusterâ€™s worker node only, they are not avaliable on the base system or the master node.<br>Using the tool of you choice (including any non pre-install tool) analyse the containerâ€™s behavior for at least <code>30</code> seconds, using filers that detect newly spawing and executing processes, store an incident file at <code>/opt/KSR00101/incidents/summary</code>, containing the detected incidents one per line in the follwing format:<br>æ³¨ï¼šè¿™äº›å·¥å…·åªé¢„è£…åœ¨ cluster çš„å·¥ä½œèŠ‚ç‚¹ï¼Œä¸åœ¨ master èŠ‚ç‚¹ã€‚<br>ä½¿ç”¨å·¥å…·è‡³å°‘åˆ†æ 30 ç§’ï¼Œä½¿ç”¨è¿‡æ»¤å™¨æ£€æŸ¥ç”Ÿæˆå’Œæ‰§è¡Œçš„è¿›ç¨‹ï¼Œå°†äº‹ä»¶å†™åˆ° <code>/opt/KSR00101/incidents/summary</code> æ–‡ä»¶ä¸­ï¼Œå…¶ä¸­åŒ…å«æ£€æµ‹çš„äº‹ä»¶, æ¯ä¸ªå•ç‹¬ä¸€è¡Œ<br>æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[timestamp],[uid],[processName]</span><br></pre></td></tr></table></figure>

<p>ä¿æŒå·¥å…·çš„åŸå§‹æ—¶é—´æˆ³æ ¼å¼ä¸å˜ã€‚<br>æ³¨ï¼šç¡®ä¿äº‹ä»¶æ–‡ä»¶å­˜å‚¨åœ¨é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ä¸Šã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹æ³•ä¸€ sysdig</span><br><span class="line">### éœ€ç™»å½•åˆ°å·¥ä½œèŠ‚ç‚¹æ“ä½œ</span><br><span class="line">ssh cka-node01</span><br><span class="line"></span><br><span class="line">### æŸ¥çœ‹ sysdig å¸®åŠ©</span><br><span class="line">sysdig -h</span><br><span class="line"></span><br><span class="line">### æŸ¥çœ‹ sysdig æ”¯æŒçš„å…ƒæ•°æ®</span><br><span class="line">sysdig -l</span><br><span class="line"></span><br><span class="line">### æŸ¥çœ‹æŒ‡å®šå®¹å™¨ID</span><br><span class="line">crictl ps | grep redis</span><br><span class="line"></span><br><span class="line">### -M åˆ†æå®¹å™¨30ç§’ï¼Œ-p æŒ‡å®šäº‹ä»¶ä¿å­˜æ ¼å¼ï¼Œ--cri æŒ‡å®šå®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶ä¸”ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶è·¯å¾„ä¸­</span><br><span class="line">sysdig -M 30 -p &quot;*%evt.time,%user.uid,%proc.name&quot; --cri /run/containerd/containerd.sock container.id=xxxxx &gt; /opt/KSR00101/incidents/summary</span><br><span class="line"># æ–¹æ³•äºŒ falco</span><br><span class="line">### éœ€ç™»å½•åˆ°å·¥ä½œèŠ‚ç‚¹æ“ä½œ</span><br><span class="line">ssh cka-node01</span><br><span class="line"></span><br><span class="line">### </span><br><span class="line">cd /etc/falco</span><br><span class="line">ls</span><br><span class="line"></span><br><span class="line">### </span><br><span class="line">vim /etc/falco/falco_rules.yaml</span><br><span class="line"># Container is supposed to be immutable. Package management should be done in building the image.</span><br><span class="line">- rule: Launch Package Management Process in Container</span><br><span class="line">  desc: Package management process ran inside container</span><br><span class="line">  condition: &gt;</span><br><span class="line">    spawned_process</span><br><span class="line">    and container</span><br><span class="line">    and user.name != &quot;_apt&quot;</span><br><span class="line">    and package_mgmt_procs</span><br><span class="line">    and not package_mgmt_ancestor_procs</span><br><span class="line">    and not user_known_package_manager_in_container</span><br><span class="line">  output: &gt;</span><br><span class="line">    Package management process launched in container %evt.time,%user.uid,%proc.name</span><br><span class="line"></span><br><span class="line">### æŸ¥çœ‹æŒ‡å®šå®¹å™¨ID</span><br><span class="line">cat /var/log/sysdig | grep falco | grep &quot;Package management&quot; -i</span><br><span class="line"></span><br><span class="line"># </span><br><span class="line">vim /opt/KSR00101/incidents/summary</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜5-ServiceAccount"><a href="#è€ƒé¢˜5-ServiceAccount" class="headerlink" title="è€ƒé¢˜5 - ServiceAccount"></a>è€ƒé¢˜5 - ServiceAccount</h3><p>Context<br>A Pod fails to run because of an incorrectly specified ServiceAcccount.</p>
<h4 id="Task-4"><a href="#Task-4" class="headerlink" title="Task"></a>Task</h4><p>create a new ServiceAccount named <code>backend-sa</code> in the existing namespace <code>qa</code>, which must <strong>not have access to any secrets</strong>.</p>
<ul>
<li><p>Inspect the Pods in the namespace</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qa</span><br></pre></td></tr></table></figure>

<p>.</p>
<ul>
<li>Edit the Pod to use the newly created serviceAccount <code>backend-sa</code>.</li>
<li>Ensure that the modified specification is applied and the Pod is running.</li>
</ul>
</li>
<li><p>Finally, clean-up and delete the now unused serviceAccount in the namespace <code>qa</code>.<br>åœ¨ç°æœ‰ namespace <code>qa</code> ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <code>backend-sa</code> çš„æ–° ServiceAccountï¼Œ ç¡®ä¿æ­¤ ServiceAccount ä¸è‡ªåŠ¨æŒ‚è½½secretsã€‚<br>ä½¿ç”¨ <code>/cks/9/pod9.yaml</code> ä¸­çš„æ¸…å•æ–‡ä»¶æ¥åˆ›å»ºä¸€ä¸ª Podã€‚<br>æœ€åï¼Œæ¸…ç† namespace <code>qa</code> ä¸­ä»»ä½•æœªä½¿ç”¨çš„ ServiceAccountã€‚</p>
</li>
</ul>
<h4 id="Solution-3"><a href="#Solution-3" class="headerlink" title="Solution"></a>Solution</h4><p>æœç´¢ serviceaccountï¼ˆä¸ºPodé…ç½®æœåŠ¡è´¦å·ï¼‰ï¼Œæ¥ç€å†æœç´¢å­—ç¬¦ä¸² â€œautomountâ€<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-service-account/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-service-account/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">### åˆ›å»º ServiceAccount</span><br><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: backend-sa</span><br><span class="line">  namespace: qa</span><br><span class="line">automountServiceAccountToken: false</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">### </span><br><span class="line">k get pods -n qa</span><br><span class="line">  web1-xxx1</span><br><span class="line">  web2-xwx2</span><br><span class="line">  web3-xwx3</span><br><span class="line">k get deployment -n qa</span><br><span class="line">  web1</span><br><span class="line">  web2</span><br><span class="line">  web3</span><br><span class="line"># å‘ç°è¿™äº›podéƒ½å±äºdeployment</span><br><span class="line"></span><br><span class="line">### ç¼–è¾‘ Pod ä½¿ç”¨æ–°åˆ›å»ºçš„ serviceaccount</span><br><span class="line">k edit deployment/web1 -n qa</span><br><span class="line">k edit deployment/web2 -n qa</span><br><span class="line">k edit deployment/web3 -n qa</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">template:</span><br><span class="line">  spec:</span><br><span class="line">    serviceAccountName: backend-sa # add</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">### åº”ç”¨æ¸…å•æ–‡ä»¶</span><br><span class="line">kubectl apply -f /cks/9/pod9.yaml</span><br><span class="line"></span><br><span class="line">### æŠŠé™¤äº† backend-sa, å¹¶ä¸”æ²¡æœ‰è¢«ä½¿ç”¨çš„ serviceaccount éƒ½åˆ é™¤</span><br><span class="line">kubectl get serviceaccount -n qa</span><br><span class="line">    backend-sa</span><br><span class="line">    default</span><br><span class="line">    contentsa</span><br><span class="line"></span><br><span class="line">kubectl get rolebinding -n qa -o wide</span><br><span class="line">kubectl get clustorrolebinding -n qa -o wide</span><br><span class="line"></span><br><span class="line">kubectl delete -n qa serviceaccount contentsa</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜6-2022çœŸé¢˜v1-20-Pod-å®‰å…¨ç­–ç•¥-PodSecurityPolicy"><a href="#è€ƒé¢˜6-2022çœŸé¢˜v1-20-Pod-å®‰å…¨ç­–ç•¥-PodSecurityPolicy" class="headerlink" title="è€ƒé¢˜6 - 2022çœŸé¢˜v1.20 Pod å®‰å…¨ç­–ç•¥-PodSecurityPolicy"></a>è€ƒé¢˜6 - 2022çœŸé¢˜v1.20 Pod å®‰å…¨ç­–ç•¥-PodSecurityPolicy</h3><p>2023çš„æœ€æ–°è€ƒè¯•å·²ç»æ²¡æœ‰è¿™é“é¢˜äº†ï¼Œæ›¿ä»£çš„æ˜¯Pod Security Standard</p>
<h4 id="Context6"><a href="#Context6" class="headerlink" title="Context6"></a>Context6</h4><p>A PodsecurityPolicy shall prevent the creation on of privileged Pods in a specific namespace.<br>PodSecurityPolicy åº”é˜²æ­¢åœ¨ç‰¹å®š namespace ä¸­ç‰¹æƒ Pod çš„åˆ›å»ºã€‚</p>
<h4 id="Task6"><a href="#Task6" class="headerlink" title="Task6"></a>Task6</h4><p>Create a new <code>PodSecurityPolicy</code> named <code>restrict-policy</code>, which prevents the creation of privileged Pods.</p>
<p>Create a new <code>ClusterRole</code> named <code>restrict-access-role</code>, which uses the newly created PodSecurityPolicy <code>restrict-policy</code>.<br>Create a new <code>serviceAccount</code> named <code>psp-denial-sa</code> in the existing namespace <code>staging</code>.</p>
<p>Finally, create a new <code>clusterRoleBinding</code> named <code>dany-access-bind</code>, which binds the newly created ClusterRole <code>restrict-access-role</code> to the newly created serviceAccount <code>psp-denial-sa</code>.</p>
<p>åˆ›å»ºä¸€ä¸ªåä¸º <code>restrict-policy</code> çš„æ–°çš„ PodSecurityPolicyï¼Œä»¥é˜²æ­¢ç‰¹æƒ Pod çš„åˆ›å»ºã€‚<br>åˆ›å»ºä¸€ä¸ªåä¸º <code>restrict-access-role</code> å¹¶ä½¿ç”¨æ–°åˆ›å»ºçš„ PodSecurityPolicy <code>restrict-policy</code> çš„ ClusterRoleã€‚<br>åœ¨ç°æœ‰çš„ namespace <code>staging</code> ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <code>psp-denial-sa</code> çš„æ–° ServiceAccount ã€‚<br>æœ€åï¼Œåˆ›å»ºä¸€ä¸ªåä¸º <code>dany-access-bind</code> çš„ ClusterRoleBindingï¼Œå°†æ–°åˆ›å»ºçš„ ClusterRole <code>restrict-access-role</code> ç»‘å®šåˆ°æ–°åˆ›å»ºçš„ ServiceAccount <code>psp-denial-sa</code>ã€‚<br>ä½ å¯ä»¥åœ¨ä¸€ä¸‹ä½ç½®æ‰¾åˆ°æ¨¡ç‰ˆæ¸…å•æ–‡ä»¶ï¼š <code>/cks/psp/psp.yaml</code></p>
<h4 id="Solution6"><a href="#Solution6" class="headerlink" title="Solution6"></a>Solution6</h4><p>æœç´¢ runasanyï¼ˆPod Security Policyï¼‰<br><a target="_blank" rel="noopener" href="https://kubernetes.io/id/docs/concepts/policy/pod-security-policy/">https://kubernetes.io/id/docs/concepts/policy/pod-security-policy/</a><br>æœç´¢ clusterroleï¼ˆä½¿ç”¨RBACé‰´æƒï¼‰<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">### (1)åˆ›å»º psp</span><br><span class="line">vim /cks/psp/psp.yaml</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodSecurityPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: restrict-policy</span><br><span class="line">spec:</span><br><span class="line">  privileged: false</span><br><span class="line">  seLinux:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  supplementalGroups:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  runAsUser:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  fsGroup:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  volumes:</span><br><span class="line">  - &#x27;*&#x27;</span><br><span class="line"></span><br><span class="line">kubectl apply -f /cks/psp/psp.yaml</span><br><span class="line"></span><br><span class="line">### (2)åˆ›å»º clusterroleï¼Œä½¿ç”¨ psp</span><br><span class="line">kubectl create clusterrole restrict-access-role --verb=use --resource=psp --resource-name=restrict-policy</span><br><span class="line"></span><br><span class="line">### (3)åˆ›å»º serviceaccount</span><br><span class="line">kubectl create serviceaccount psp-denial-sa -n staging </span><br><span class="line"></span><br><span class="line">### (4)åˆ›å»º clusterrolebinding</span><br><span class="line">kubectl create clusterrolebinding dany-access-bind --clusterrole=restrict-access-role --serviceaccount=staging:psp-denial-sa</span><br><span class="line"></span><br><span class="line">### (5)å¯ç”¨ PodSecurityPolicyï¼ˆåœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šä¿®æ”¹ apiserver é…ç½®ï¼‰</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">    - --enable-admission-plugins=NodeRestriction,PodSecurityPolicy</span><br><span class="line"></span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜6-2023çœŸé¢˜V1-26-Pod-Security-Standard"><a href="#è€ƒé¢˜6-2023çœŸé¢˜V1-26-Pod-Security-Standard" class="headerlink" title="è€ƒé¢˜6 - 2023çœŸé¢˜V1.26 Pod Security Standard"></a>è€ƒé¢˜6 - 2023çœŸé¢˜V1.26 Pod Security Standard</h3><p>Task weight: 8%<br>Use context: <code>kubectl config use-context workload-prod</code></p>
<p>There is Deployment <code>container-host-hacker</code> in Namespace <code>team-red</code> which mounts <code>/run/containerd</code> as a hostPath volume on the Node where itâ€™s running. This means that the Pod can access various data about other containers running on the same Node.</p>
<p>To prevent this configure Namespace <code>team-red</code> to <code>enforce</code> the <code>baseline</code> Pod Security Standard. Once completed, delete the Pod of the Deployment mentioned above.</p>
<p>Check the <code>ReplicaSet</code> events and write the event/log lines containing the reason why the Pod isnâ€™t recreated into <code>/opt/course/4/logs</code>.</p>
<h4 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h4><p>Making Namespaces use Pod Security Standards works via labels. We can simply edit it:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k edit ns team-red</span><br></pre></td></tr></table></figure>

<p>Now we configure the requested label:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># kubectl edit namespace team-red</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/metadata.name: team-red</span><br><span class="line">    pod-security.kubernetes.io/enforce: baseline # add</span><br><span class="line">  name: team-red</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>This should already be enough for the default Pod Security Admission Controller to pick up on that change. Letâ€™s test it and delete the Pod to see if itâ€™ll be recreated or fails, it should fail!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">âœ k -n team-red get pod</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">container-host-hacker-dbf989777-wm8fc   1/1     Running   0          115s</span><br><span class="line"></span><br><span class="line">âœ k -n team-red delete pod container-host-hacker-dbf989777-wm8fc </span><br><span class="line">pod &quot;container-host-hacker-dbf989777-wm8fc&quot; deleted</span><br><span class="line"></span><br><span class="line">âœ k -n team-red get pod</span><br><span class="line">No resources found in team-red namespace.</span><br></pre></td></tr></table></figure>

<p>Usually the ReplicaSet of a Deployment would recreate the Pod if deleted, here we see this doesnâ€™t happen. Letâ€™s check why:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">âœ k -n team-red get rs</span><br><span class="line">NAME                              DESIRED   CURRENT   READY   AGE</span><br><span class="line">container-host-hacker-dbf989777   1         0         0       5m25s</span><br><span class="line"></span><br><span class="line">âœ k -n team-red describe rs container-host-hacker-dbf989777</span><br><span class="line">Name:           container-host-hacker-dbf989777</span><br><span class="line">Namespace:      team-red</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                   From                   Message</span><br><span class="line">  ----     ------            ----                  ----                   -------</span><br><span class="line">...</span><br><span class="line">  Warning  FailedCreate      2m41s                 replicaset-controller  Error creating: pods &quot;container-host-hacker-dbf989777-bjwgv&quot; is forbidden: violates PodSecurity &quot;baseline:latest&quot;: hostPath volumes (volume &quot;containerdata&quot;)</span><br><span class="line">  Warning  FailedCreate      2m2s (x9 over 2m40s)  replicaset-controller  (combined from similar events): Error creating: pods &quot;container-host-hacker-dbf989777-kjfpn&quot; is forbidden: violates PodSecurity &quot;baseline:latest&quot;: hostPath volumes (volume &quot;containerdata&quot;)</span><br></pre></td></tr></table></figure>

<p>There we go! Finally we write the reason into the requested file so that Mr Scoring will be happy too!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># /opt/course/4/logs</span><br><span class="line">Warning  FailedCreate      2m2s (x9 over 2m40s)  replicaset-controller  (combined from similar events): Error creating: pods &quot;container-host-hacker-dbf989777-kjfpn&quot; is forbidden: violates PodSecurity &quot;baseline:latest&quot;: hostPath volumes (volume &quot;containerdata&quot;)</span><br></pre></td></tr></table></figure>

<p>Pod Security Standards can give a great base level of security! But when one finds themselves wanting to deeper adjust the levels like <code>baseline</code> or <code>restricted</code>â€¦ this isnâ€™t possible and 3rd party solutions like OPA could be looked at.</p>
<h3 id="è€ƒé¢˜7-NetworkPolicy-default-deny"><a href="#è€ƒé¢˜7-NetworkPolicy-default-deny" class="headerlink" title="è€ƒé¢˜7 - NetworkPolicy - default-deny"></a>è€ƒé¢˜7 - NetworkPolicy - default-deny</h3><h4 id="Context-2"><a href="#Context-2" class="headerlink" title="Context"></a>Context</h4><p>A default-deny NetworkPolicy avoids to accidentally expose a Pod in a namespace that doesnâ€™t have any other NetworkPolicy defined.<br>ä¸€ä¸ªé»˜è®¤æ‹’ç»ï¼ˆdefault-denyï¼‰çš„ NetworkPolicy å¯é¿å…åœ¨æœªå®šä¹‰ä»»ä½•å…¶ä»– NetworkPolicy çš„ namespace ä¸­æ„å¤–å…¬å¼€ Podã€‚</p>
<h4 id="Task-5"><a href="#Task-5" class="headerlink" title="Task"></a>Task</h4><p>Create a new default-deny NetworkPolicy named <code>denynetwork</code> in the namespace <code>development</code> for all traffic of type <code>Ingress</code>.<br>The new NetworkPolicy must deny all ingress traffic in the namespace <code>development</code>.</p>
<p>Apply the newly created <code>default-deny</code> NetworkPolicy to all Pods running in namespace <code>development</code>.<br>You can find a skeleton manifest file at <code>/cks/15/p1.yaml</code></p>
<p>ä¸ºæ‰€æœ‰ç±»å‹ä¸º Ingress+Egress çš„æµé‡åœ¨ namespace testing ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <code>denynetwork</code> çš„æ–°é»˜è®¤æ‹’ç» NetworkPolicyã€‚ æ­¤æ–°çš„ NetworkPolicy å¿…é¡»æ‹’ç» namespace testng ä¸­çš„æ‰€æœ‰çš„ Ingress + Egress æµé‡ã€‚<br>å°†æ–°åˆ›å»ºçš„é»˜è®¤æ‹’ç» NetworkPolicy åº”ç”¨ä¸åœ¨ namespace testing ä¸­è¿è¡Œçš„æ‰€æœ‰ Podã€‚<br>ä½ å¯ä»¥åœ¨ <code>/cks/15/p1.yaml</code> æ‰¾åˆ°ä¸€ä¸ªæ¨¡æ¿æ¸…å•æ–‡ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">### ä¿®æ”¹æ¨¡æ¿æ¸…å•æ–‡ä»¶</span><br><span class="line">vim /cks/15/p1.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: denynetwork</span><br><span class="line">  namespace: testing</span><br><span class="line">spec:</span><br><span class="line">  podSelector: &#123;&#125;</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line"></span><br><span class="line">### åº”ç”¨æ¸…å•æ–‡ä»¶</span><br><span class="line">kubectl apply -f /cks/15/p1.yaml</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜8-NetworkPolicy"><a href="#è€ƒé¢˜8-NetworkPolicy" class="headerlink" title="è€ƒé¢˜8 - NetworkPolicy"></a>è€ƒé¢˜8 - NetworkPolicy</h3><h4 id="Task-6"><a href="#Task-6" class="headerlink" title="Task"></a>Task</h4><p>create a NetworkPolicy named <code>pod-restriction</code> to restrict access to Pod <code>products-service</code> running in namespace <code>dev-team</code>.<br>Only allow the following Pods to connect to Pod <code>products-service</code>:</p>
<ul>
<li>Pods in the namespace <code>qa</code></li>
<li>Pods with label <code>environment: testing</code>, in any namespace</li>
</ul>
<p>Make sure to apply the NetworkPolicy.<br>You can find a skelet on manifest file at <code>/cks/6/p1.yaml</code></p>
<p>åˆ›å»ºä¸€ä¸ªåä¸º <code>pod-restriction</code> çš„ NetworkPolicy æ¥é™åˆ¶å¯¹åœ¨ namespace <code>dev-team</code> ä¸­è¿è¡Œçš„ Pod <code>products-service</code> çš„è®¿é—®ã€‚åªå…è®¸ä»¥ä¸‹ Pod è¿æ¥åˆ° Pod <code>products-service</code>ï¼š</p>
<ul>
<li>namespace <code>qa</code> ä¸­çš„ Pod</li>
<li>ä½äºä»»ä½• namespaceï¼Œå¸¦æœ‰æ ‡ç­¾ <code>environment: testing</code> çš„ Pod</li>
</ul>
<p>æ³¨æ„ï¼šç¡®ä¿åº”ç”¨ NetworkPolicyã€‚<br>ä½ å¯ä»¥åœ¨<code>/cks/net/po.yaml</code> æ‰¾åˆ°ä¸€ä¸ªæ¨¡æ¿æ¸…å•æ–‡ä»¶ã€‚</p>
<h4 id="Solution-4"><a href="#Solution-4" class="headerlink" title="Solution"></a>Solution</h4><p>æœç´¢ networkpolicyï¼ˆç½‘ç»œç­–ç•¥ï¼‰<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/">https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">### (1)æŸ¥çœ‹å‘½åç©ºé—´ qa å…·æœ‰çš„æ ‡ç­¾</span><br><span class="line">kubectl get namespace qa --show-labels</span><br><span class="line"></span><br><span class="line">### (2)æŸ¥çœ‹ pod å…·æœ‰çš„æ ‡ç­¾</span><br><span class="line">kubectl get pod products-service -n dev-team --show-labels</span><br><span class="line"></span><br><span class="line">### ä¿®æ”¹æ¨¡æ¿æ¸…å•æ–‡ä»¶</span><br><span class="line">vim /cks/net/po.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-restriction  # name</span><br><span class="line">  namespace: dev-team  # namespace</span><br><span class="line">spec:</span><br><span class="line">  podSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: products-service  # (2)</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line">  ingress:</span><br><span class="line">  - from:</span><br><span class="line">    - namespaceSelector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          name: qa  # (1)</span><br><span class="line">    - podSelector:  # æ³¨æ„å¸¦ - ï¼Œè¡¨ç¤ºæˆ–çš„å…³ç³»</span><br><span class="line">        matchLabels:</span><br><span class="line">          environment: testing</span><br><span class="line">      namespaceSelector: &#123;&#125;    ## ä»»ä½•å‘½åç©ºé—´, ä¸å¸¦ - ï¼Œä¸”çš„å…³ç³»</span><br><span class="line">### åº”ç”¨æ¸…å•æ–‡ä»¶</span><br><span class="line">kubectl apply -f /cks/net/po.yaml</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜9-RBAC"><a href="#è€ƒé¢˜9-RBAC" class="headerlink" title="è€ƒé¢˜9 - RBAC"></a>è€ƒé¢˜9 - RBAC</h3><h4 id="Context-3"><a href="#Context-3" class="headerlink" title="Context"></a>Context</h4><p>ç»‘å®šåˆ° Pod çš„ ServiceAccount çš„ Role æˆäºˆè¿‡åº¦å®½æ¾çš„æƒé™ã€‚å®Œæˆä»¥ä¸‹é¡¹ç›®ä»¥å‡å°‘æƒé™é›†ã€‚<br>A Role bound to a Podâ€™s serviceAccount grants overly permissive permissions.<br>Complete the following tasks to reduce the set of permissions.</p>
<h4 id="Task-7"><a href="#Task-7" class="headerlink" title="Task"></a>Task</h4><p>ä¸€ä¸ªåä¸º <code>web-pod</code> çš„ç°æœ‰ Pod å·²åœ¨ namespace <code>db</code> ä¸­è¿è¡Œã€‚ç¼–è¾‘ç»‘å®šåˆ° Pod çš„ ServiceAccount <code>service-account-web</code> çš„ç°æœ‰ Roleï¼Œ ä»…å…è®¸åªå¯¹ services ç±»å‹çš„èµ„æºæ‰§è¡Œ <code>get</code> æ“ä½œã€‚</p>
<ul>
<li>åœ¨ namespace <code>db</code> ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <code>role-2</code> ï¼Œå¹¶ä»…å…è®¸åªå¯¹ <code>namespaces</code> ç±»å‹çš„èµ„æºæ‰§è¡Œ <code>delete</code> æ“ä½œçš„æ–° Roleã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªåä¸º <code>role-2-binding</code> çš„æ–° RoleBindingï¼Œå°†æ–°åˆ›å»ºçš„ Role ç»‘å®šåˆ° Pod çš„ ServiceAccountã€‚<br>æ³¨æ„ï¼šè¯·å‹¿åˆ é™¤ç°æœ‰çš„ RoleBindingã€‚</li>
</ul>
<p>Given an existing Pod named <code>web-pod</code> running in the namespace <code>db</code>. Edit the existing Role bound to the Podâ€™s serviceAccount <code>sa-dev-1</code> to only allow performing <code>list</code> operations, only on resources of type <code>Endpoints</code>.</p>
<ul>
<li>create a new Role named <code>role-2</code> in the namespace <code>db</code>, which only allows performing <code>update</code> operations, only on resources of type <code>persistentvolumeclaims</code></li>
<li>create a new RoleBinding named <code>role-2-binding</code> binding the newly created Role to the Podâ€™s serviceAccount.</li>
</ul>
<p>Donâ€™t delete the existing RoleBinding</p>
<h4 id="solution"><a href="#solution" class="headerlink" title="solution"></a>solution</h4><p>æœç´¢ clusterroleï¼ˆä½¿ç”¨RBACé‰´æƒï¼‰<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">### æŸ¥è¯¢ sa å¯¹åº”çš„ role åç§°ï¼ˆå‡è®¾æ˜¯ role-1ï¼‰</span><br><span class="line">kubectl get rolebinding -n db -oyaml | grep &#x27;service-account-web&#x27; -B 10</span><br><span class="line"></span><br><span class="line">### ä¿®æ”¹ role æ¸…å•æ–‡ä»¶ï¼ˆä»…å…è®¸å¯¹ services ç±»å‹çš„èµ„æºæ‰§è¡Œ get æ“ä½œï¼‰</span><br><span class="line">kubectl edit role -n db role-1</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: role-1</span><br><span class="line">  namespace: db</span><br><span class="line">  resourceVersion: &quot;9528&quot;</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">    - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">    - services</span><br><span class="line">  verbs:</span><br><span class="line">    - get</span><br><span class="line"></span><br><span class="line">### åˆ›å»ºæ–°è§’è‰² role-2ï¼ˆä»…å…è®¸åªå¯¹ namespaces ç±»å‹çš„èµ„æºæ‰§è¡Œ delete æ“ä½œï¼‰</span><br><span class="line">kubectl create role role-2 -n db --verb=delete --resource=namespaces</span><br><span class="line"></span><br><span class="line">### åˆ›å»º rolebindingï¼Œå¹¶ç»‘å®šåˆ° sa ä¸Š</span><br><span class="line">kubectl create rolebinding role-2-binding --role=role-2 --serviceaccount=db:service-account-web</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜10-kube-apiserver-å®¡è®¡æ—¥å¿—è®°å½•å’Œé‡‡é›†"><a href="#è€ƒé¢˜10-kube-apiserver-å®¡è®¡æ—¥å¿—è®°å½•å’Œé‡‡é›†" class="headerlink" title="è€ƒé¢˜10 - kube-apiserver å®¡è®¡æ—¥å¿—è®°å½•å’Œé‡‡é›†"></a>è€ƒé¢˜10 - kube-apiserver å®¡è®¡æ—¥å¿—è®°å½•å’Œé‡‡é›†</h3><h4 id="Task-8"><a href="#Task-8" class="headerlink" title="Task"></a>Task</h4><p>Enable audit logs in the cluster.<br>To do so, enable the log backend, and ensure that:</p>
<ul>
<li>logs are stored at <code>/var/log/kubernetes/audit-logs.txt</code></li>
<li>log files are retained for <code>10</code> days</li>
<li>at maximum, a number of <code>2</code> auditlog files are retained<br>A basic policy is provided at <code>/etc/kubernetes/logpolicy/sample-policy.yaml</code>. it only specifies what not to log. The base policy is located on the clusterâ€™s <code>master</code> node.</li>
</ul>
<p>Edit and extend the basic policy to log:</p>
<ul>
<li><code>namespaces</code> changes at <code>RequestResponse</code> level</li>
<li>the request body of pods changes in the namespace <code>front-apps</code></li>
<li><code>configMap</code> and <code>secret</code> changes in all namespaces at the <code>Metadata</code> level</li>
<li>Also, add a <code>catch-all</code> ruie to log all other requests at the <code>Metadata</code> level.</li>
</ul>
<p>Donâ€™t forget to apply the modifiedpolicy.<br><code>/etc/kubernetes/logpolicy/sample-policy.yaml</code></p>
<p>åœ¨ cluster ä¸­å¯ç”¨å®¡è®¡æ—¥å¿—ã€‚ä¸ºæ­¤ï¼Œè¯·å¯ç”¨æ—¥å¿—åç«¯ï¼Œå¹¶ç¡®ä¿ï¼š</p>
<ul>
<li>æ—¥å¿—å­˜å‚¨åœ¨ <code>/var/log/kubernetes/audit-logs.txt</code></li>
<li>æ—¥å¿—æ–‡ä»¶èƒ½ä¿ç•™ <code>10</code> å¤©</li>
<li>æœ€å¤šä¿ç•™ <code>2</code> ä¸ªæ—§å®¡è®¡æ—¥å¿—æ–‡ä»¶<br>/etc/kubernetes/logpolicy/sample-policy.yaml æä¾›äº†åŸºæœ¬ç­–ç•¥ã€‚å®ƒä»…æŒ‡å®šä¸è®°å½•çš„å†…å®¹ã€‚<br>æ³¨æ„ï¼šåŸºæœ¬ç­–ç•¥ä½äº cluster çš„ master èŠ‚ç‚¹ä¸Šã€‚</li>
</ul>
<p>ç¼–è¾‘å’Œæ‰©å±•åŸºæœ¬ç­–ç•¥ä»¥è®°å½•ï¼š</p>
<ul>
<li>RequestResponse çº§åˆ«çš„ cronjobs æ›´æ”¹</li>
<li>namespace front-apps ä¸­ deployment æ›´æ”¹çš„è¯·æ±‚ä½“</li>
<li>Metadata çº§åˆ«çš„æ‰€æœ‰ namespace ä¸­çš„ ConfigMap å’Œ Secret çš„æ›´æ”¹</li>
<li>æ­¤å¤–ï¼Œæ·»åŠ ä¸€ä¸ªå…¨æ–¹ä½çš„è§„åˆ™ä»¥åœ¨ Metadata çº§åˆ«è®°å½•æ‰€æœ‰å…¶ä»–è¯·æ±‚ã€‚<br>æ³¨æ„ï¼šä¸è¦å¿˜è®°åº”ç”¨ä¿®æ”¹åçš„ç­–ç•¥</li>
</ul>
<h4 id="Solution-5"><a href="#Solution-5" class="headerlink" title="Solution"></a>Solution</h4><p>æœç´¢ auditï¼ˆå®¡è®¡ï¼‰<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/audit/">https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/audit/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">### å¦‚æœæ²¡æœ‰ /var/log/kubernetes/ï¼Œåˆ™åˆ›å»ºç›®å½•</span><br><span class="line">mkdir /var/log/kubernetes/</span><br><span class="line"></span><br><span class="line">### ä¿®æ”¹ audit æ¨¡æ¿æ–‡ä»¶</span><br><span class="line">vim /etc/kubernetes/logpolicy/sample-policy.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">omitStages:</span><br><span class="line">  - &quot;RequestReceived&quot;</span><br><span class="line">rules:</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;cronjobs&quot;]</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;deployments&quot;]</span><br><span class="line">    namespaces: [&quot;front-apps&quot;]</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - &quot;RequestReceived&quot;</span><br><span class="line"></span><br><span class="line">### ä¿®æ”¹ apiserver é…ç½®æ–‡ä»¶ï¼Œå¯ç”¨å®¡è®¡æ—¥å¿—</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">--audit-policy-file=/etc/kubernetes/logpolicy/sample-policy.yaml</span><br><span class="line">--audit-log-path=/var/log/kubernetes/audit-logs.txt</span><br><span class="line">--audit-log-maxage=10</span><br><span class="line">--audit-log-maxbackup=2</span><br><span class="line"></span><br><span class="line">### åœ¨ apiserver çš„ Pod ä¸ŠæŒ‚è½½ç­–ç•¥æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼ˆè€ƒè¯•æ—¶å¯èƒ½å·²ç»æŒ‚è½½å¥½ï¼‰</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">volumeMounts:</span><br><span class="line">  - mountPath: /var/log/kubernetes</span><br><span class="line">    name: kubernetes-logs</span><br><span class="line">  - mountPath: /etc/kubernetes/logpolicy</span><br><span class="line">    name: kubernetes-policy</span><br><span class="line">volumes:</span><br><span class="line">- name: kubernetes-logs</span><br><span class="line">  hostPath:</span><br><span class="line">    path: /var/log/kubernetes</span><br><span class="line">- name: kubernetes-policy</span><br><span class="line">  hostPath:</span><br><span class="line">    path: /etc/kubernetes/logpolicy</span><br><span class="line"></span><br><span class="line">### é‡è½½ç”Ÿæ•ˆé…ç½®</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜11-Secret"><a href="#è€ƒé¢˜11-Secret" class="headerlink" title="è€ƒé¢˜11 - Secret"></a>è€ƒé¢˜11 - Secret</h3><h4 id="Task-9"><a href="#Task-9" class="headerlink" title="Task"></a>Task</h4><p>Retrieve the content of the existing secret named <code>db1-test</code> in the <code>istio-system</code> namespace.<br>store the username field in a file named <code>/home/candidate/user.txt</code>, and the password field in a file named <code>/home/candidate/pass</code>.txt.</p>
<p>You must create both files; they donâ€™t exist yet.<br>Do not use/modify the created files in the following steps, create new temporary files if needed.</p>
<p>Create a new secret named <code>db2-test</code> in the <code>istio-system</code> namespace, with the following</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username : production-instance</span><br><span class="line">password : KvLftKgs4aVH</span><br></pre></td></tr></table></figure>

<p>Finally, create a new Pod that has access to the secret db2-test via a volume:</p>
<ul>
<li>Pod name <code>secret-pod</code></li>
<li>Namespace <code>istio-system</code></li>
<li>container name <code>dev-container</code></li>
<li>image <code>nginx</code></li>
<li>volume name <code>secret-volume</code></li>
<li>mount path <code>/etc/secret</code></li>
</ul>
<p>åœ¨ namespace <code>istio-system</code> ä¸­è·å–åä¸º <code>db1-test</code> çš„ç°æœ‰ secret çš„å†…å®¹.<br>å°† username å­—æ®µå­˜å‚¨åœ¨åä¸º <code>/cks/sec/user.txt</code> çš„æ–‡ä»¶ä¸­ï¼Œå¹¶å°† password å­—æ®µå­˜å‚¨åœ¨åä¸º <code>/cks/sec/pass.txt</code> çš„æ–‡ä»¶ä¸­ã€‚</p>
<p>æ³¨æ„ï¼šä½ å¿…é¡»åˆ›å»ºä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶ï¼Œä»–ä»¬è¿˜ä¸å­˜åœ¨ã€‚<br>æ³¨æ„ï¼šä¸è¦åœ¨ä»¥ä¸‹æ­¥éª¤ä¸­ä½¿ç”¨/ä¿®æ”¹å…ˆå‰åˆ›å»ºçš„æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„ä¸´æ—¶æ–‡ä»¶ã€‚</p>
<p>åœ¨ <code>istio-system</code> namespace ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <code>db2-test</code> çš„æ–° secretï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username : production-instance</span><br><span class="line">password : KvLftKgs4aVH</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Podï¼Œå®ƒå¯ä»¥é€šè¿‡å·è®¿é—® secret <code>db2-test</code> ï¼š</p>
<ul>
<li>Pod åç§° <code>secret-pod</code></li>
<li>Namespace <code>istio-system</code></li>
<li>å®¹å™¨å <code>dev-container</code></li>
<li>é•œåƒ <code>nginx</code></li>
<li>å·å <code>secret-volume</code></li>
<li>æŒ‚è½½è·¯å¾„ <code>/etc/secret</code></li>
</ul>
<h4 id="Solution-6"><a href="#Solution-6" class="headerlink" title="Solution"></a>Solution</h4><p>æœç´¢ secretï¼ˆä½¿ç”¨ kubectl ç®¡ç† Secretï¼‰<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/">https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/</a><br>æœç´¢ secretï¼ˆSecretï¼‰<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/">https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">### æ£€ç´¢å·²å­˜åœ¨çš„ secretï¼Œå°†è·å–åˆ°çš„ç”¨æˆ·åå’Œå¯†ç å­—æ®µå­˜å‚¨åˆ°æŒ‡å®šæ–‡ä»¶</span><br><span class="line">kubectl get secrets db2-test -o jsonpath=&#x27;&#123;.data.username&#125;&#x27; | base64 -d &gt; /home/candidate/user.txt</span><br><span class="line">kubectl get secrets db2-test -o jsonpath=&#x27;&#123;.data.password&#125;&#x27; | base64 -d &gt; /home/candidate/pass.txt</span><br><span class="line"></span><br><span class="line">### åˆ›å»º secret</span><br><span class="line">kubectl -n istio-system create secret generic db2-test --from-literal=username=production-instance --from-literal=password=KvLftKgs4aVH </span><br><span class="line"># kubectl create secret generic db2-test -n istio-system --from-literal username=production-instance --from-literal password=KvLftKgs4aVH</span><br><span class="line"># error: exactly one NAME is required, got 2</span><br><span class="line"></span><br><span class="line">### åœ¨ Pod ä¸­ä»¥æ–‡ä»¶å½¢å¼ä½¿ç”¨ Secret</span><br><span class="line">vim k8s-secret.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: secret-pod</span><br><span class="line">  namespace: istio-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: dev-container</span><br><span class="line">    image: nginx</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: secret-volume</span><br><span class="line">      mountPath: &quot;/etc/secret&quot;</span><br><span class="line">      readOnly: true</span><br><span class="line">  volumes:</span><br><span class="line">  - name: secret-volume</span><br><span class="line">    secret:</span><br><span class="line">      secretName: db2-test</span><br><span class="line">      optional: false</span><br><span class="line"></span><br><span class="line">### åº”ç”¨æ¸…å•æ–‡ä»¶</span><br><span class="line">kubectl apply -f k8s-secret.yaml</span><br><span class="line"></span><br><span class="line">### éªŒè¯ pod</span><br><span class="line">kubectl get pods -n istio-system dev-pod</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜12-dockerfile-å’Œ-deployment-å®‰å…¨ä¼˜åŒ–"><a href="#è€ƒé¢˜12-dockerfile-å’Œ-deployment-å®‰å…¨ä¼˜åŒ–" class="headerlink" title="è€ƒé¢˜12 - dockerfile å’Œ deployment å®‰å…¨ä¼˜åŒ–"></a>è€ƒé¢˜12 - dockerfile å’Œ deployment å®‰å…¨ä¼˜åŒ–</h3><h4 id="Task-10"><a href="#Task-10" class="headerlink" title="Task"></a>Task</h4><ul>
<li>Analyze and edit the given Dockerfile (based on the ubuntu:16.04 image) <code>/cks/docker/Dockerfile</code> fixing two instructions present in the file being prominent security/best-practice issues.</li>
<li>Analyze and edit the given manifest file <code>/cks/docker/deployment.yaml</code> fixing two fields present in the file being prominent security/best-practice issues.</li>
</ul>
<p>Donâ€™t add or remove configuration settings; only modify the existing configuration settings, so that two configuration settings each are no longer security/best-practice concerns.</p>
<p>Should you need an unprivileged user for any of the tasks, use user <code>nobody</code> with user id <code>65535</code>.</p>
<blockquote>
<ul>
<li>åˆ†æå’Œç¼–è¾‘ç»™å®šçš„ Dockerfile <code>/cks/docker/Dockerfile</code>ï¼ˆåŸºäº ubuntu:16.04 é•œåƒï¼‰ï¼Œå¹¶ä¿®å¤åœ¨æ–‡ä»¶ä¸­æ‹¥æœ‰çš„çªå‡ºçš„å®‰å…¨/æœ€ä½³å®è·µé—®é¢˜çš„ä¸¤ä¸ªæŒ‡ä»¤ã€‚</li>
<li>åˆ†æå’Œç¼–è¾‘ç»™å®šçš„æ¸…å•æ–‡ä»¶ <code>/cks/docker/deployment.yaml</code>ï¼Œå¹¶ä¿®å¤åœ¨æ–‡ä»¶ä¸­æ‹¥æœ‰çªå‡ºçš„å®‰å…¨/æœ€ä½³å®è·µé—®é¢˜çš„ä¸¤ä¸ªå­—æ®µã€‚</li>
</ul>
<p>æ³¨æ„ï¼šè¯·å‹¿æ·»åŠ æˆ–åˆ é™¤é…ç½®è®¾ç½®ï¼›åªéœ€ä¿®æ”¹ç°æœ‰çš„é…ç½®è®¾ç½®è®©ä»¥ä¸Šä¸¤ä¸ªé…ç½®è®¾ç½®éƒ½ä¸å†æœ‰å®‰å…¨/æœ€ä½³å®è·µé—®é¢˜ã€‚<br>æ³¨æ„ï¼šå¦‚æœæ‚¨éœ€è¦éç‰¹æƒç”¨æˆ·æ¥æ‰§è¡Œä»»ä½•é¡¹ç›®ï¼Œè¯·ä½¿ç”¨ç”¨æˆ· ID 65535 çš„ç”¨æˆ· nobody ã€‚<br>ç­”é¢˜ï¼š æ³¨æ„ï¼Œæœ¬æ¬¡çš„ Dockerfile å’Œ deployment.yaml ä»…ä¿®æ”¹å³å¯ï¼Œæ— éœ€éƒ¨ç½²ã€‚</p>
</blockquote>
<h4 id="Solution-12"><a href="#Solution-12" class="headerlink" title="Solution 12"></a>Solution 12</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">### ä¿®å¤ dockerfile æ–‡ä»¶ä¸­å­˜åœ¨çš„ä¸¤ä¸ªå®‰å…¨/æœ€ä½³å®è·µæŒ‡ä»¤</span><br><span class="line">### (1)æŠŠubuntu:latestæ”¹ä¸ºubuntu:16.04 (2)å°† root æ³¨é‡Šæ‰ï¼›å¢åŠ  nobody</span><br><span class="line">vim /cks/docker/Dockerfile</span><br><span class="line"># FROM ubuntu:latest  1 ä¿®æ”¹</span><br><span class="line">FROM ubuntu:16.04</span><br><span class="line">#USER root </span><br><span class="line">USER nobody # 2</span><br><span class="line"></span><br><span class="line">### ä¿®å¤ deployment æ–‡ä»¶ä¸­å­˜åœ¨çš„ä¸¤ä¸ªå®‰å…¨/æœ€ä½³å®è·µé—®é¢˜å­—æ®µ</span><br><span class="line">### (1)å°† privileged å˜ä¸º Falseï¼›(2)å°† readOnlyRootFilesystem å˜ä¸º True 3 check runAsUser 65535</span><br><span class="line">vim /cks/docker/deployment.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: dev</span><br><span class="line">  name: dev</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: dev</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: dev</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: mysql</span><br><span class="line">        name: mysql</span><br><span class="line">        securityContext: &#123;&#x27;capabilities&#x27;:&#123;&#x27;add&#x27;:[&#x27;NET_ADMIN&#x27;],&#x27;drop&#x27;:[&#x27;all&#x27;]&#125;,&#x27;privileged&#x27;: False,&#x27;readOnlyRootFilesystem&#x27;: True, &#x27;runAsUser&#x27;: 65535&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜13-admission-controllers-ImagePolicyWebhook"><a href="#è€ƒé¢˜13-admission-controllers-ImagePolicyWebhook" class="headerlink" title="è€ƒé¢˜13 - admission-controllers - ImagePolicyWebhook"></a>è€ƒé¢˜13 - admission-controllers - ImagePolicyWebhook</h3><h4 id="Context-4"><a href="#Context-4" class="headerlink" title="Context"></a>Context</h4><p>A container image scanner is set up on the cluster, but itâ€™s not yet fully integrated into the clusterâ€™s configuration. When complete, the container image scanner shall scan for and reject the use of vulnerable images.</p>
<p>cluster ä¸Šè®¾ç½®äº†å®¹å™¨é•œåƒæ‰«æå™¨ï¼Œä½†å°šæœªå®Œå…¨é›†æˆåˆ° cluster çš„é…ç½®ä¸­ã€‚å®Œæˆåï¼Œå®¹å™¨é•œåƒæ‰«æå™¨åº”æ‰«æå¹¶æ‹’ç»æ˜“å—æ”»å‡»çš„é•œåƒçš„ä½¿ç”¨ã€‚</p>
<h4 id="Task-11"><a href="#Task-11" class="headerlink" title="Task"></a>Task</h4><p>You have to complete the entire task on the clusterâ€™s <code>master</code> node, where all services and files have been prepared and placed.<br>Given an incomplete configuration in directory <code>/etc/kubernetes/epconfig</code> and a functional container image scanner with HTTPS endpoint <code>https://acme.local:8082/image_policy</code>:</p>
<ol>
<li>Enable the necessary plugins to create an image policy</li>
<li>validate the control configuration and change it to an implicit deny</li>
<li>Edit the configuration to point to the provided HTTPS endpoint correctly.</li>
<li>Finally , test if the configuration is working by trying to deploy the vulnerable resource <code>/cks/1/web1.yaml</code></li>
</ol>
<p>You can find the container image scannerâ€™s log file at <code>/var/loglimagepolicyiacme.log</code></p>
<p>æ³¨æ„ï¼šä½ å¿…é¡»åœ¨ cluster çš„ master èŠ‚ç‚¹ä¸Šå®Œæˆæ•´ä¸ªè€ƒé¢˜ï¼Œæ‰€æœ‰æœåŠ¡å’Œæ–‡ä»¶éƒ½å·²è¢«å‡†å¤‡å¥½å¹¶æ”¾ç½®åœ¨è¯¥èŠ‚ç‚¹ä¸Šã€‚ ç»™å®šä¸€ä¸ªç›®å½• <code>/etc/kubernetes/epconfig</code> ä¸­ä¸å®Œæ•´çš„é…ç½®ä»¥åŠå…·æœ‰ HTTPS ç«¯ç‚¹ <code>https://acme.local:8082/image_policy</code> çš„åŠŸèƒ½æ€§å®¹å™¨é•œåƒæ‰«æå™¨ï¼š</p>
<ol>
<li>å¯ç”¨å¿…è¦çš„æ’ä»¶æ¥åˆ›å»ºé•œåƒç­–ç•¥</li>
<li>æ ¡éªŒæ§åˆ¶é…ç½®å¹¶å°†å…¶æ›´æ”¹ä¸ºéšå¼æ‹’ç»ï¼ˆimplicit denyï¼‰</li>
<li>ç¼–è¾‘é…ç½®ä»¥æ­£ç¡®æŒ‡å‘æä¾›çš„ HTTPS ç«¯ç‚¹</li>
<li>æœ€åï¼Œé€šè¿‡å°è¯•éƒ¨ç½²æ˜“å—æ”»å‡»çš„èµ„æº <code>/cks/img/web1.yaml</code> æ¥æµ‹è¯•é…ç½®æ˜¯å¦æœ‰æ•ˆã€‚</li>
</ol>
<p>ä½ å¯ä»¥åœ¨ <code>/var/log/imagepolicy/roadrunner.log</code> æ‰¾åˆ°å®¹å™¨é•œåƒæ‰«æä»ªçš„æ—¥å¿—æ–‡ä»¶ã€‚</p>
<h4 id="Solution-7"><a href="#Solution-7" class="headerlink" title="Solution"></a>Solution</h4><p>æœç´¢ imagepolicywebhookï¼ˆä½¿ç”¨å‡†å…¥æ§åˆ¶å™¨ï¼‰ï¼Œæ¥ç€å†æœç´¢å­—ç¬¦ä¸²â€imagepolicywebhookâ€<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># 0 master node</span><br><span class="line">ssh masterNode</span><br><span class="line"></span><br><span class="line">cd /etc/kubernetes/epconfig</span><br><span class="line">ls</span><br><span class="line">  admission_configuration.json kubeconfig.yaml</span><br><span class="line"></span><br><span class="line">###  æŸ¥çœ‹config-fileè·¯å¾„</span><br><span class="line">cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep --admission-control-config-file</span><br><span class="line">    - --admission-control-config-file=/etc/kubernetes/epconfig/admission_configuration.json </span><br><span class="line"></span><br><span class="line">### 1 éªŒè¯æ§åˆ¶å¹³é¢çš„é…ç½®å¹¶å°†å…¶æ›´æ”¹ä¸ºæ‹’ç»</span><br><span class="line">vim /etc/kubernetes/epconfig/admission_configuration.json</span><br><span class="line">&#123;</span><br><span class="line">   &quot;apiVersion&quot;: &quot;apiserver.config.k8s.io/v1&quot;,</span><br><span class="line">   &quot;kind&quot;: &quot;AdmissionConfiguration&quot;,</span><br><span class="line">   &quot;plugins&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;name&quot;: &quot;ImagePolicyWebhook&quot;,</span><br><span class="line">         &quot;configuration&quot;: &#123;</span><br><span class="line">            &quot;imagePolicy&quot;: &#123;</span><br><span class="line">               &quot;kubeConfigFile&quot;: &quot;/etc/kubernetes/epconfig/kubeconfig.yaml&quot;, // 1.1 kubeconfig</span><br><span class="line">               &quot;allowTTL&quot;: 100,</span><br><span class="line">               &quot;denyTTL&quot;: 50,</span><br><span class="line">               &quot;retryBackoff&quot;: 500,</span><br><span class="line">               &quot;defaultAllow&quot;: false   // 1.2 modify from true to false</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">### 2 ç¼–è¾‘é…ç½®ä»¥æ­£ç¡®æŒ‡å‘æä¾›çš„ HTTPS ç«¯ç‚¹</span><br><span class="line">vim kubeconfig.yaml</span><br><span class="line">    apiVersion: v1</span><br><span class="line">    kind: Config</span><br><span class="line">    clusters:</span><br><span class="line">    - cluster:</span><br><span class="line">        certificate-authority: /etc/kubernetes/epconfig/webhook.pem</span><br><span class="line">        server: https://acme.local:8082/image_policy   # 2 é…ç½®æ­¤æ­¥</span><br><span class="line">    name: bouncer_webhook</span><br><span class="line"></span><br><span class="line">### 3 å¯ç”¨å¿…è¦çš„æ’ä»¶ä»¥åˆ›å»ºé•œåƒç­–ç•¥</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line">    - --enable-admission-plugins=NodeRestriction,ImagePolicyWebhook  # 3.1 Add ImagePolicyWebhook</span><br><span class="line">    - --admission-control-config-file=/etc/kubernetes/epconfig/admission_configuration.json  # 3.2 Check config-file path</span><br><span class="line">    ......</span><br><span class="line">    volumeMounts:                         # 3.3 Check Mount, can search audit log in kubernetes.io</span><br><span class="line">    - mountPath: /etc/kubernetes/epconfig</span><br><span class="line">      name: config</span><br><span class="line">      readyOnly: false</span><br><span class="line">  volumes:</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/kubernetes/epconfig</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: config</span><br><span class="line"></span><br><span class="line">### 4 åŠ è½½ç”Ÿæ•ˆé…ç½®</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line">### 5 é€šè¿‡éƒ¨ç½²æ˜“å—æ”»å‡»çš„èµ„æºæ¥æµ‹è¯•é…ç½®æ˜¯å¦æœ‰æ•ˆ</span><br><span class="line">kubectl apply -f /cks/img/web1.yaml</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜14-åˆ é™¤éæ— çŠ¶æ€æˆ–éä¸å¯å˜çš„-pod"><a href="#è€ƒé¢˜14-åˆ é™¤éæ— çŠ¶æ€æˆ–éä¸å¯å˜çš„-pod" class="headerlink" title="è€ƒé¢˜14 - åˆ é™¤éæ— çŠ¶æ€æˆ–éä¸å¯å˜çš„ pod"></a>è€ƒé¢˜14 - åˆ é™¤éæ— çŠ¶æ€æˆ–éä¸å¯å˜çš„ pod</h3><p>Context: it is best-practice to design containers to be stateless and immutable</p>
<h4 id="Task-12"><a href="#Task-12" class="headerlink" title="Task"></a>Task</h4><p>Inspect Pods runnings in namespace <code>production</code> and delete any Pod that is either not stateless or not immutable.</p>
<p>Use the following strict interpretation of stateless and immutable:</p>
<ul>
<li>Pod being able to store data inside containers must be treated as not stateless. You donâ€™t have to worry whether data is actually stored inside containers or not already.</li>
<li>Pod being configured to be <code>privileged</code> in any way must be treated as potentially not stateless and not immutable.</li>
</ul>
<p>æ£€æŸ¥åœ¨ namespace production ä¸­è¿è¡Œçš„ Podï¼Œå¹¶åˆ é™¤ä»»ä½•éæ— çŠ¶æ€æˆ–éä¸å¯å˜çš„ Podã€‚<br>ä½¿ç”¨ä»¥ä¸‹å¯¹æ— çŠ¶æ€å’Œä¸å¯å˜çš„ä¸¥æ ¼è§£é‡Šï¼š</p>
<ul>
<li>èƒ½å¤Ÿåœ¨å®¹å™¨å†…å­˜å‚¨æ•°æ®çš„ Pod çš„å®¹å™¨å¿…é¡»è¢«è§†ä¸ºéæ— çŠ¶æ€çš„ã€‚</li>
<li>è¢«é…ç½®ä¸ºä»»ä½•å½¢å¼çš„ç‰¹æƒ Pod å¿…é¡»è¢«è§†ä¸ºå¯èƒ½æ˜¯éæ— çŠ¶æ€å’Œéä¸å¯å˜çš„ã€‚<br>æ³¨æ„ï¼šä½ ä¸å¿…æ‹…å¿ƒæ•°æ®æ˜¯å¦å®é™…ä¸Šå·²ç»å­˜å‚¨åœ¨å®¹å™¨ä¸­ã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">### åœ¨å‘½åç©ºé—´ dev ä¸­æ£€æŸ¥ running çŠ¶æ€çš„ pod</span><br><span class="line">kubectl get pods -n production | grep running -i</span><br><span class="line"></span><br><span class="line">### æŸ¥çœ‹å…·æœ‰ç‰¹æƒçš„ pod</span><br><span class="line">kubectl get pods -n production -oyaml | grep -i &quot;privileged: true&quot;</span><br><span class="line"></span><br><span class="line">### æŸ¥çœ‹å…·æœ‰ volume çš„ pod</span><br><span class="line"># jq ç”¨äºå¤„ç†JSONè¾“å…¥ï¼Œå°†ç»™å®šè¿‡æ»¤å™¨åº”ç”¨äºå…¶JSONæ–‡æœ¬è¾“å…¥å¹¶åœ¨æ ‡å‡†è¾“å‡ºä¸Šå°†è¿‡æ»¤å™¨çš„ç»“æœç”Ÿæˆä¸ºJSONã€‚</span><br><span class="line">kubectl get pods -n production -o jsonpath=&#123;.spec.volumes&#125; | jq</span><br><span class="line"></span><br><span class="line">### å°†æŸ¥è¯¢åˆ°çš„å…·æœ‰ç‰¹æƒå’Œ volume çš„ pod éƒ½åˆ é™¤</span><br><span class="line">kubectl delete pods -n production podåç§°</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜15-gVisor-runtimeclass"><a href="#è€ƒé¢˜15-gVisor-runtimeclass" class="headerlink" title="è€ƒé¢˜15 - gVisor/runtimeclass"></a>è€ƒé¢˜15 - gVisor/runtimeclass</h3><h4 id="Context-5"><a href="#Context-5" class="headerlink" title="Context"></a>Context</h4><p>This cluster uses containerd as CRI runtime.<br>Containerdâ€™s default runtime handler is <code>runc</code> . Containerd has been prepared to support an additional runtime handler , <code>runsc</code> (gVisor).</p>
<blockquote>
<p>è¯¥ cluster ä½¿ç”¨ containerd ä½œä¸º CRI è¿è¡Œæ—¶ã€‚<br>containerd çš„é»˜è®¤è¿è¡Œæ—¶å¤„ç†ç¨‹åºæ˜¯ <code>runc</code>ã€‚ containerd å·²å‡†å¤‡å¥½æ”¯æŒé¢å¤–çš„è¿è¡Œæ—¶å¤„ç†ç¨‹åº <code>runsc</code> (gVisor)ã€‚</p>
</blockquote>
<h4 id="Task-13"><a href="#Task-13" class="headerlink" title="Task"></a>Task</h4><p>Create a RuntimeClass named <code>untrusted</code> using the prepared runtime handler named <code>runsc</code>.<br>Update all Pods in the namespace <code>server</code> to run on gvisor, unless they are already running on <code>anon-default</code> runtime handler.<br>You can find a skeleton manifest file at <code>/cks/13/rc.yaml</code></p>
<blockquote>
<p>ä½¿ç”¨åä¸º <code>runsc</code> çš„ç°æœ‰è¿è¡Œæ—¶å¤„ç†ç¨‹åºï¼Œåˆ›å»ºä¸€ä¸ªåä¸º <code>untrusted</code> çš„ RuntimeClassã€‚<br>æ›´æ–° namespace <code>server</code> ä¸­çš„æ‰€æœ‰ Pod ä»¥åœ¨ gVisor ä¸Šè¿è¡Œã€‚<br>æ‚¨å¯ä»¥åœ¨ <code>/cks/gVisor/rc.yaml</code> ä¸­æ‰¾åˆ°ä¸€ä¸ªæ¨¡ç‰ˆæ¸…å•</p>
</blockquote>
<h4 id="Solution-8"><a href="#Solution-8" class="headerlink" title="Solution"></a>Solution</h4><p>æœç´¢ runtimeclassï¼ˆå®¹å™¨è¿è¡Œæ—¶ç±»ï¼‰<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/containers/runtime-class/">https://kubernetes.io/zh-cn/docs/concepts/containers/runtime-class/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">### ä¿®æ”¹æ¨¡æ¿æ¸…å•æ–‡ä»¶</span><br><span class="line">vim /cks/gVisor/rc.yaml</span><br><span class="line">    apiVersion: node.k8s.io/v1</span><br><span class="line">    kind: RuntimeClass</span><br><span class="line">    metadata:</span><br><span class="line">      name: untrusted</span><br><span class="line">    handler: runsc</span><br><span class="line"></span><br><span class="line">### åº”ç”¨æ¸…å•æ–‡ä»¶</span><br><span class="line">kubectl apply -f /cks/gVisor/rc.yaml</span><br><span class="line"></span><br><span class="line">### ä¿®æ”¹ server å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ podï¼ˆè¿˜éœ€è¦ä¿®æ”¹deploymentï¼‰</span><br><span class="line">kubectl get pods -n server</span><br><span class="line">kubectl get deployments -n server</span><br><span class="line"></span><br><span class="line">kubectl get pods -n server -oyaml &gt; myrc.yaml</span><br><span class="line">vim myrc.yaml</span><br><span class="line">spec:</span><br><span class="line">  ......</span><br><span class="line">  runtimeClassName: untrusted</span><br><span class="line"></span><br><span class="line">### æ›´æ–°æ¸…å•æ–‡ä»¶</span><br><span class="line">kubectl delete -f myrc.yaml</span><br><span class="line">kubectl apply -f myrc.yaml</span><br></pre></td></tr></table></figure>

<h3 id="è€ƒé¢˜16-å¯ç”¨-API-Server-è®¤è¯"><a href="#è€ƒé¢˜16-å¯ç”¨-API-Server-è®¤è¯" class="headerlink" title="è€ƒé¢˜16 - å¯ç”¨ API Server è®¤è¯"></a>è€ƒé¢˜16 - å¯ç”¨ API Server è®¤è¯</h3><h4 id="Context-6"><a href="#Context-6" class="headerlink" title="Context"></a>Context</h4><p>ç”± kubeadm åˆ›å»ºçš„ cluster çš„ Kubernetes API æœåŠ¡å™¨ï¼Œå‡ºäºæµ‹è¯•ç›®çš„ï¼Œä¸´æ—¶é…ç½®å…è®¸æœªç»èº«ä»½éªŒè¯å’Œæœªç»æˆæƒçš„è®¿é—®ï¼ŒæˆäºˆåŒ¿åç”¨æˆ· <code>cluster-admin</code> çš„è®¿é—®æƒé™ã€‚</p>
<h4 id="Task-14"><a href="#Task-14" class="headerlink" title="Task"></a>Task</h4><p>é‡æ–°é…ç½® cluster çš„ Kubernetes API æœåŠ¡å™¨ï¼Œä»¥ç¡®ä¿<strong>åªå…è®¸ç»è¿‡èº«ä»½éªŒè¯å’Œæˆæƒ</strong>çš„ REST è¯·æ±‚ã€‚<br>ä½¿ç”¨æˆæƒæ¨¡å¼ <code>Node</code>,<code>RBAC</code> å’Œå‡†å…¥æ§åˆ¶å™¨ <code>NodeRestrictionã€‚</code><br>åˆ é™¤ç”¨æˆ· <code>system:anonymous</code> çš„ ClusterRoleBinding æ¥è¿›è¡Œæ¸…ç†ã€‚<br>æ³¨æ„ï¼šæ‰€æœ‰ kubectl é…ç½®ç¯å¢ƒ/æ–‡ä»¶ä¹Ÿè¢«é…ç½®ä½¿ç”¨æœªç»èº«ä»½éªŒè¯å’Œæœªç»æˆæƒçš„è®¿é—®ã€‚ ä½ ä¸å¿…æ›´æ”¹å®ƒï¼Œä½†è¯·æ³¨æ„ï¼Œä¸€æ—¦å®Œæˆ cluster çš„å®‰å…¨åŠ å›ºï¼Œ kubectl çš„é…ç½®å°†æ— æ³•å·¥ä½œã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ä½äº cluster çš„ master èŠ‚ç‚¹ä¸Šï¼Œcluster åŸæœ¬çš„ kubectl é…ç½®æ–‡ä»¶ /etc/kubernetes/admin.conf ï¼Œä»¥ç¡®ä¿ç»è¿‡èº«ä»½éªŒè¯çš„æˆæƒçš„è¯·æ±‚ä»ç„¶è¢«å…è®¸ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">k get nodes</span><br><span class="line"></span><br><span class="line">### æ³¨æ„ï¼šä¿®æ”¹ master èŠ‚ç‚¹ï¼</span><br><span class="line">ssh masterNode</span><br><span class="line"></span><br><span class="line">### (1)ä½¿ç”¨æˆæƒæ¨¡å¼ Node,RBAC å’Œå‡†å…¥æ§åˆ¶å™¨ NodeRestriction</span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">    - --authorization-mode=Node,RBAC              # modify  Node,RBAC </span><br><span class="line">    - --enable-admission-plugins=NodeRestriction  # modify  NodeRestriction</span><br><span class="line">    - --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --enable-bootstrap-token-auth=true</span><br><span class="line"></span><br><span class="line">### (2)åˆ é™¤ system:anonymous çš„ ClusterRolebinding è§’è‰²ç»‘å®šï¼ˆå–æ¶ˆåŒ¿åç”¨æˆ·çš„é›†ç¾¤ç®¡ç†å‘˜æƒé™ï¼‰</span><br><span class="line">k get clusterrolebinding -A | grep system:anonymous</span><br><span class="line">kubectl delete clusterrolebinding system:anonymous</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ul>
<li>CKS çœŸé¢˜<ul>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/638db1b2dacf622b8df8c678.html">2022å¹´11æœˆæœ€æ–°CKSè®¤è¯é¢˜åº“</a></li>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/638db1a8dacf622b8df8c643.html?spm=1001.2101.3001.6650.5&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~activity-5-126962402-blog-123994683.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~activity-5-126962402-blog-123994683.pc_relevant_default&utm_relevant_index=6">2022.10 CKSè€ƒè¯•é¢˜åº“v1.24</a></li>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/638db200dacf622b8df8c7f0.html?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2~default~YuanLiJiHua~activity-3-127131284-blog-123994683.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~YuanLiJiHua~activity-3-127131284-blog-123994683.pc_relevant_default&utm_relevant_index=4">2022.10 CKS 1.24çœŸé¢˜è§£æ</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/cloud_engineer/article/details/125709403?spm=1001.2101.3001.6650.7&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-7-125709403-blog-123994683.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-7-125709403-blog-123994683.pc_relevant_default&utm_relevant_index=8">2022.8 kubernets CKSå†…å®¹åŠé¢˜åº“</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zfw_666666/article/details/125185751">2022.6 CKSè®¤è¯è€ƒé¢˜+è§£æ</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/april_4?type=blog">2022.3 CKS 1.23 çœŸé¢˜</a></li>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/63311d5fd3efff3090b52a1e.html?spm=1001.2101.3001.6650.9&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~activity-9-122525427-blog-123994683.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~activity-9-122525427-blog-123994683.pc_relevant_default&utm_relevant_index=10">2022.1 cks è¯•é¢˜</a></li>
<li><a target="_blank" rel="noopener" href="https://huaweicloud.csdn.net/638db4efdacf622b8df8cc95.html">2021.12 Kubernetes CKS 1.20 - çœŸé¢˜ 15é“é¢˜</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/itsaka/category_11111851.html">2021 Kubernetes CKS 1.20 - çœŸé¢˜ 15é“é¢˜</a></li>
</ul>
</li>
<li>CKSå…¶ä»–<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011127242/article/details/125822057">CKSè€ƒè¯•çŸ¥è¯†ç‚¹é“¾æ¥</a></li>
</ul>
</li>
</ul>
<p>From: <a target="_blank" rel="noopener" href="http://liyuankun.top/Kubernates-Certified%20Kubernetes%20Security%20Specialist-CKS.html">http://liyuankun.top/Kubernates-Certified%20Kubernetes%20Security%20Specialist-CKS.html</a></p>
<hr>
<h1 id="çœŸé¢˜â‘¢åŸºäº1-22ç‰ˆæœ¬"><a href="#çœŸé¢˜â‘¢åŸºäº1-22ç‰ˆæœ¬" class="headerlink" title="çœŸé¢˜â‘¢åŸºäº1.22ç‰ˆæœ¬"></a>çœŸé¢˜â‘¢åŸºäº1.22ç‰ˆæœ¬</h1><p>1ã€Pod æŒ‡å®š ServiceAccount</p>
<p>Task </p>
<ol>
<li>åœ¨ç°æœ‰ namespace qa ä¸­åˆ›å»ºä¸€ä¸ªåä¸º backend-sa çš„æ–° ServiceAccountï¼Œ ç¡®ä¿æ­¤<br>ServiceAccount ä¸è‡ªåŠ¨æŒ‚è½½ API å‡­æ®ã€‚ </li>
<li>ä½¿ç”¨ /cks/sa/pod1.yaml ä¸­çš„æ¸…å•æ–‡ä»¶æ¥åˆ›å»ºä¸€ä¸ª Podã€‚</li>
<li>æœ€åï¼Œæ¸…ç† namespace qa ä¸­ä»»ä½•æœªä½¿ç”¨çš„ ServiceAccountã€‚</li>
</ol>
<p>2ã€RBAC - RoleBinding<br>Context ç»‘å®šåˆ° Pod çš„ ServiceAccount çš„ Role æˆäºˆè¿‡åº¦å®½æ¾çš„æƒé™ã€‚å®Œæˆä»¥ä¸‹é¡¹ç›®ä»¥å‡å°‘æƒé™é›†ã€‚ </p>
<p>Task</p>
<p>ä¸€ä¸ªåä¸º web-pod çš„ç°æœ‰ Pod å·²åœ¨ namespace db ä¸­è¿è¡Œã€‚ ç¼–è¾‘ç»‘å®šåˆ° Pod çš„ ServiceAccount service-account-web çš„ç°æœ‰ Roleï¼Œ ä»…å…è®¸åªå¯¹ services ç±»å‹çš„èµ„æº æ‰§è¡Œ get æ“ä½œã€‚ åœ¨namespace db ä¸­åˆ›å»ºä¸€ä¸ªåä¸º role-2 ï¼Œå¹¶ä»…å…è®¸åªå¯¹ namespaces ç±»å‹çš„èµ„æºæ‰§è¡Œ delete æ“ä½œçš„æ–°Roleã€‚ åˆ›å»ºä¸€ä¸ªåä¸º role-2-binding çš„æ–° RoleBindingï¼Œå°†æ–°åˆ›å»ºçš„ Role ç»‘å®šåˆ° Pod çš„ServiceAccountã€‚ æ³¨æ„ï¼šè¯·å‹¿åˆ é™¤ç°æœ‰çš„ RoleBindingã€‚</p>
<p>3ã€å¯ç”¨ API server è®¤è¯<br>Context ç”± kubeadm åˆ›å»ºçš„ cluster çš„ Kubernetes API æœåŠ¡å™¨ï¼Œå‡ºäºæµ‹è¯•ç›®çš„ï¼Œä¸´æ—¶é…ç½®å…è®¸æœªç»èº«ä»½éªŒè¯å’Œæœªç»æˆæƒçš„è®¿é—®ï¼ŒæˆäºˆåŒ¿åç”¨æˆ· cluster-admin çš„è®¿é—®æƒé™. </p>
<p>Task </p>
<p>é‡æ–°é…ç½® cluster çš„Kubernetes APl æœåŠ¡å™¨ï¼Œä»¥ç¡®ä¿åªå…è®¸ç»è¿‡èº«ä»½éªŒè¯å’Œæˆæƒçš„ REST è¯·æ±‚ã€‚ ä½¿ç”¨æˆæƒæ¨¡å¼ Node,RBAC å’Œå‡†å…¥æ§åˆ¶å™¨<br>NodeRestrictionã€‚ åˆ é™¤ç”¨æˆ· system:anonymous çš„ ClusterRoleBinding æ¥è¿›è¡Œæ¸…ç†ã€‚</p>
<p>æ³¨æ„ï¼šæ‰€æœ‰ kubectl é…ç½®ç¯å¢ƒ/æ–‡ä»¶ä¹Ÿè¢«é…ç½®ä½¿ç”¨æœªç»èº«ä»½éªŒè¯å’Œæœªç»æˆæƒçš„è®¿é—®ã€‚ ä½ ä¸å¿…æ›´æ”¹å®ƒï¼Œä½†è¯·æ³¨æ„ï¼Œä¸€æ—¦å®Œæˆ cluster<br>çš„å®‰å…¨åŠ å›ºï¼Œ kubectl çš„é…ç½®å°†æ— æ³•å·¥ä½œã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ä½äº cluster çš„ master èŠ‚ç‚¹ä¸Šï¼Œcluster åŸæœ¬çš„kubectl é…ç½®æ–‡ä»¶ /etc/kubernetes/admin.conf ï¼Œä»¥ç¡®ä¿ç»è¿‡èº«ä»½éªŒè¯çš„æˆæƒçš„è¯·æ±‚ä»ç„¶è¢«å…è®¸ã€‚</p>
<p>4ã€Sysdig &amp; falco<br>Taskï¼š </p>
<p>ä½¿ç”¨è¿è¡Œæ—¶æ£€æµ‹å·¥å…·æ¥æ£€æµ‹ Pod tomcat å•ä¸ªå®¹å™¨ä¸­é¢‘å‘ç”Ÿæˆå’Œæ‰§è¡Œçš„å¼‚å¸¸è¿›ç¨‹ã€‚ æœ‰ä¸¤ç§å·¥å…·å¯ä¾›ä½¿ç”¨ï¼š</p>
<p>âš« sysdig<br>âš« falco </p>
<p>æ³¨ï¼š è¿™äº›å·¥å…·åªé¢„è£…åœ¨ cluster çš„å·¥ä½œèŠ‚ç‚¹ï¼Œä¸åœ¨ master èŠ‚ç‚¹ã€‚ ä½¿ç”¨å·¥å…·è‡³å°‘åˆ†æ 30 ç§’ï¼Œä½¿ç”¨è¿‡æ»¤å™¨æ£€æŸ¥ç”Ÿæˆå’Œæ‰§è¡Œçš„è¿›ç¨‹ï¼Œå°†äº‹ä»¶å†™åˆ° /opt/KSR00101/incidents/summary æ–‡ä»¶ä¸­ï¼Œå…¶ä¸­åŒ…å«æ£€æµ‹çš„äº‹ä»¶ï¼Œ æ ¼å¼å¦‚ä¸‹ï¼š [timestamp],[uid],[processName] ä¿æŒå·¥å…·çš„åŸå§‹æ—¶é—´æˆ³æ ¼å¼ä¸å˜ã€‚ </p>
<p>æ³¨ï¼šç¡®ä¿äº‹ä»¶æ–‡ä»¶å­˜å‚¨åœ¨é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ä¸Šã€‚</p>
<p>5ã€ å®¹å™¨å®‰å…¨ï¼Œåˆ é™¤ç‰¹æƒ Pod<br>Task</p>
<p>æ£€æŸ¥åœ¨ namespace production ä¸­è¿è¡Œçš„ Podï¼Œå¹¶åˆ é™¤ä»»ä½•éæ— çŠ¶æ€æˆ–éä¸å¯å˜çš„ Podã€‚<br>ä½¿ç”¨ä»¥ä¸‹å¯¹æ— çŠ¶æ€å’Œä¸å¯å˜çš„ä¸¥æ ¼è§£é‡Šï¼š </p>
<p>âš« èƒ½å¤Ÿåœ¨å®¹å™¨å†…å­˜å‚¨æ•°æ®çš„ Pod çš„å®¹å™¨å¿…é¡»è¢«è§†ä¸ºéæ— çŠ¶æ€çš„ã€‚<br>æ³¨æ„ï¼šä½ ä¸å¿…æ‹…å¿ƒæ•°æ®æ˜¯å¦å®é™…ä¸Šå·²ç»å­˜å‚¨åœ¨å®¹å™¨ä¸­ã€‚ </p>
<p>âš« è¢«é…ç½®ä¸ºä»»ä½•å½¢å¼çš„ç‰¹æƒ Pod å¿…é¡»è¢«è§†ä¸ºå¯èƒ½æ˜¯éæ— çŠ¶æ€å’Œéä¸å¯å˜çš„ã€‚</p>
<p>6ã€æ²™ç®±è¿è¡Œå®¹å™¨ gVisor<br>Context è¯¥ cluster ä½¿ç”¨ containerd ä½œä¸º CRI è¿è¡Œæ—¶ã€‚containerd çš„é»˜è®¤è¿è¡Œæ—¶å¤„ç†ç¨‹åºæ˜¯runcã€‚ containerd å·²å‡†å¤‡å¥½æ”¯æŒé¢å¤–çš„è¿è¡Œæ—¶å¤„ç†ç¨‹åº runsc (gVisor)ã€‚ Task ä½¿ç”¨åä¸º runscçš„ç°æœ‰è¿è¡Œæ—¶å¤„ç†ç¨‹åºï¼Œåˆ›å»ºä¸€ä¸ªåä¸º untrusted çš„ RuntimeClassã€‚ æ›´æ–° namespace server ä¸­çš„æ‰€æœ‰Pod ä»¥åœ¨ gVisor ä¸Šè¿è¡Œã€‚ </p>
<p>æ‚¨å¯ä»¥åœ¨ /cks/gVisor/rc.yaml ä¸­æ‰¾åˆ°ä¸€ä¸ªæ¨¡ç‰ˆæ¸…å•</p>
<p>7ã€Pod å®‰å…¨ç­–ç•¥-PSP<br>Context PodSecurityPolicy åº”é˜²åœ¨ç‰¹å®š namespace ä¸­ç‰¹æƒ Pod çš„åˆ›å»ºã€‚ Task åˆ›å»ºä¸€ä¸ªåä¸ºrestrict-policy çš„æ–°çš„PodSecurityPolicyï¼Œä»¥é˜²æ­¢ç‰¹æƒ Pod çš„åˆ›å»ºã€‚ åˆ›å»ºä¸€ä¸ªåä¸ºrestrict-access-role å¹¶ä½¿ç”¨æ–°åˆ›å»ºçš„ PodSecurityPolicy restrict-policy çš„ClusterRoleã€‚ åœ¨ç°æœ‰çš„ namespace staging ä¸­åˆ›å»ºä¸€ä¸ªåä¸º psp-denial-sa çš„æ–°ServiceAccount ã€‚æœ€åï¼Œåˆ›å»ºä¸€ä¸ªåä¸º dany-access-bind çš„ ClusterRoleBinding ï¼Œå°†æ–°åˆ›å»ºçš„ ClusterRole restrict-access-role ç»‘å®šåˆ°æ–°åˆ›å»ºçš„ ServiceAccount psp-denial-saã€‚ </p>
<p>ä½ å¯ä»¥åœ¨ä¸€ä¸‹ä½ç½®æ‰¾åˆ°æ¨¡ç‰ˆæ¸…å•æ–‡ä»¶ï¼š /cks/psp/psp.yaml</p>
<p>8ã€åˆ›å»º Secret<br>Task</p>
<p>åœ¨ namespace istio-system ä¸­è·å–åä¸º db1-test çš„ç°æœ‰ secret çš„å†…å®¹ å°† usernameå­—æ®µå­˜å‚¨åœ¨åä¸º /cks/sec/user.txt çš„æ–‡ä»¶ä¸­ï¼Œå¹¶å°† password å­—æ®µå­˜å‚¨åœ¨åä¸º /cks/sec/pass.txt çš„æ–‡ä»¶ ä¸­ã€‚æ³¨æ„ï¼šä½ å¿…é¡»åˆ›å»ºä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶ï¼Œä»–ä»¬è¿˜ä¸å­˜åœ¨ã€‚ æ³¨æ„ï¼šä¸è¦åœ¨ä»¥ä¸‹æ­¥éª¤ä¸­ä½¿ç”¨/ä¿®æ”¹å…ˆå‰åˆ›å»ºçš„æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„ä¸´æ—¶æ–‡ä»¶ã€‚</p>
<p>åœ¨ istio-system namespace ä¸­åˆ›å»ºä¸€ä¸ªåä¸º db2-test çš„æ–° secretï¼Œå†…å®¹å¦‚ä¸‹ï¼š </p>
<p>username : production-instance</p>
<p>password : KvLftKgs4aVH</p>
<p>æœ€åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Podï¼Œå®ƒå¯ä»¥é€šè¿‡å·è®¿é—® secret db2-test ï¼š </p>
<p>Pod åç§° secret-pod </p>
<p>Namespace istio-system </p>
<p>å®¹å™¨å dev-container</p>
<p>é•œåƒ nginx </p>
<p>å·å secret-volume </p>
<p>æŒ‚è½½è·¯å¾„ /etc/secret</p>
<p>9ã€AppArmor<br>Context</p>
<p>APPArmor å·²åœ¨ cluster çš„å·¥ä½œèŠ‚ç‚¹ä¸Šè¢«å¯ç”¨ã€‚ä¸€ä¸ª APPArmor é…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œä½†å°šæœªè¢«å®æ–½</p>
<p>Task<br>åœ¨ cluster çš„å·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œå®æ–½ä½äº /etc/apparmor.d/nginx_apparmor çš„ç°æœ‰ APPArmoré…ç½®æ–‡ä»¶ã€‚ ç¼–è¾‘ä½äº /home/candidate/KSSH00401/nginx-deploy.yaml çš„ç°æœ‰æ¸…å•æ–‡ä»¶ä»¥åº”ç”¨ AppArmor é…ç½®æ–‡ä»¶ã€‚ æœ€åï¼Œåº”ç”¨æ¸…å•æ–‡ä»¶å¹¶åˆ›å»ºå…¶ä¸­æŒ‡å®šçš„ Pod ã€‚</p>
<p>10ã€kube-bench ä¿®å¤ä¸å®‰å…¨é¡¹<br>Context é’ˆå¯¹ kubeadm åˆ›å»ºçš„ cluster è¿è¡Œ CIS åŸºå‡†æµ‹è¯•å·¥å…·æ—¶ï¼Œ å‘ç°äº†å¤šä¸ªå¿…é¡»ç«‹å³è§£å†³çš„é—®é¢˜ã€‚ </p>
<p>Task<br>é€šè¿‡é…ç½®ä¿®å¤æ‰€æœ‰é—®é¢˜å¹¶é‡æ–°å¯åŠ¨å—å½±å“çš„ç»„ä»¶ä»¥ç¡®ä¿æ–°çš„è®¾ç½®ç”Ÿæ•ˆã€‚ </p>
<p>ä¿®å¤é’ˆå¯¹ API æœåŠ¡å™¨å‘ç°çš„æ‰€æœ‰ä»¥ä¸‹è¿è§„è¡Œä¸ºï¼š </p>
<p>1.2.7 Ensure that the â€“authorization-mode argument is not set to AlwaysAllow </p>
<p>1.2.8 Ensure that the â€“authorization-mode argument includes Node</p>
<p>1.2.9 Ensure that the â€“authorization-mode argument includes RBAC</p>
<p>1.2.18 Ensure that the â€“insecure-bind-address argument is not set </p>
<p>1.2.19 Ensure that the â€“insecure-port argument is set to 0 </p>
<p>FAIL FAIL FAIL FAIL FAIL </p>
<p>ä¿®å¤é’ˆå¯¹ kubelet å‘ç°çš„æ‰€æœ‰ä»¥ä¸‹è¿è§„è¡Œä¸ºï¼š </p>
<p>Fix all of the following violations that were found against the kubelet: 4.2.1 </p>
<p>Ensure that the anonymous-auth argument is set to false 4.2.2 </p>
<p>Ensure that the â€“authorization-mode argument is not set to AlwaysAllow </p>
<p>FAIL FAIL</p>
<p>æ³¨æ„ï¼šå°½å¯èƒ½ä½¿ç”¨ Webhook èº«ä»½éªŒè¯/æˆæƒã€‚ </p>
<p>ä¿®å¤é’ˆå¯¹ etcd å‘ç°çš„æ‰€æœ‰ä»¥ä¸‹è¿è§„è¡Œä¸ºï¼š </p>
<p>Fix all of the following violations that were found against etcd: </p>
<p>2.2 Ensure that the â€“client-cert-auth argument is set to true FAIL</p>
<p>11ã€ç½‘ç»œç­–ç•¥ NetworkPolicy<br>Task</p>
<p>åˆ›å»ºä¸€ä¸ªåä¸º pod-restriction çš„ NetworkPolicy æ¥é™åˆ¶å¯¹åœ¨ namespace dev-team ä¸­è¿è¡Œçš„ Pod products-service çš„è®¿é—®ã€‚ åªå…è®¸ä»¥ä¸‹ Pod è¿æ¥åˆ° Pod products-service </p>
<p>âš« namespace qa ä¸­çš„ Pod </p>
<p>âš« ä½äºä»»ä½• namespaceï¼Œå¸¦æœ‰æ ‡ç­¾ environment: testing çš„ Pod</p>
<p>æ³¨æ„ï¼šç¡®ä¿åº”ç”¨ NetworkPolicyã€‚ ä½ å¯ä»¥åœ¨/cks/net/po.yaml æ‰¾åˆ°ä¸€ä¸ªæ¨¡æ¿æ¸…å•æ–‡ä»¶ã€‚</p>
<p>12ã€Dockerfile æ£€æµ‹<br>Task </p>
<p>åˆ†æå’Œç¼–è¾‘ç»™å®šçš„ Dockerfile /cks/docker/Dockerfileï¼ˆåŸºäº ubuntu:16.04 é•œåƒï¼‰ï¼Œ<br>å¹¶ä¿®å¤åœ¨æ–‡ä»¶ä¸­æ‹¥æœ‰çš„çªå‡ºçš„å®‰å…¨/æœ€ä½³å®è·µé—®é¢˜çš„ä¸¤ä¸ªæŒ‡ä»¤ã€‚ åˆ†æå’Œç¼–è¾‘ç»™å®šçš„æ¸…å•æ–‡ä»¶ /cks/docker/deployment.yaml<br>ï¼Œ å¹¶ä¿®å¤åœ¨æ–‡ä»¶ä¸­æ‹¥æœ‰çªå‡ºçš„å®‰å…¨/æœ€ä½³å®è·µé—®é¢˜çš„ä¸¤ä¸ªå­—æ®µã€‚<br>æ³¨æ„ï¼šè¯·å‹¿æ·»åŠ æˆ–åˆ é™¤é…ç½®è®¾ç½®ï¼›åªéœ€ä¿®æ”¹ç°æœ‰çš„é…ç½®è®¾ç½®è®©ä»¥ä¸Šä¸¤ä¸ªé…ç½®è®¾ç½®éƒ½ä¸å†æœ‰å®‰å…¨/æœ€ä½³å®è·µé—®é¢˜ã€‚<br>æ³¨æ„ï¼šå¦‚æœæ‚¨éœ€è¦éç‰¹æƒç”¨æˆ·æ¥æ‰§è¡Œä»»ä½•é¡¹ç›®ï¼Œè¯·ä½¿ç”¨ç”¨æˆ· ID 65535 çš„ç”¨æˆ· nobody ã€‚ ç­”é¢˜ï¼š æ³¨æ„ï¼Œæœ¬æ¬¡çš„ Dockerfile<br>å’Œ deployment.yaml ä»…ä¿®æ”¹å³å¯ï¼Œæ— éœ€éƒ¨ç½²ã€‚</p>
<p>13ã€ImagePolicyWebhook å®¹å™¨é•œåƒæ‰«æ<br>Context</p>
<p>cluster ä¸Šè®¾ç½®äº†å®¹å™¨é•œåƒæ‰«æå™¨ï¼Œä½†å°šæœªå®Œå…¨é›†æˆåˆ° cluster çš„é…ç½®ä¸­ã€‚å®Œæˆåï¼Œå®¹å™¨é•œåƒæ‰«æå™¨åº”æ‰«æå¹¶æ‹’ç»æ˜“å—æ”»å‡»çš„é•œåƒçš„ä½¿ç”¨ã€‚ </p>
<p>Task</p>
<p>æ³¨æ„ï¼šä½ å¿…é¡»åœ¨ cluster çš„ master èŠ‚ç‚¹ä¸Šå®Œæˆæ•´ä¸ªè€ƒé¢˜ï¼Œæ‰€æœ‰æœåŠ¡å’Œæ–‡ä»¶éƒ½å·²è¢«å‡†å¤‡å¥½å¹¶æ”¾ç½®åœ¨è¯¥èŠ‚ç‚¹ä¸Šã€‚ </p>
<p>ç»™å®šä¸€ä¸ªç›®å½• /etc/kubernetes/epconfig ä¸­ä¸å®Œæ•´çš„é…ç½®ä»¥åŠå…·æœ‰ HTTPS ç«¯ç‚¹ <a target="_blank" rel="noopener" href="https://acme.local:8082/image_policy">https://acme.local:8082/image_policy</a> çš„åŠŸèƒ½æ€§å®¹å™¨é•œåƒæ‰«æå™¨ï¼š</p>
<ol>
<li><p>å¯ç”¨å¿…è¦çš„æ’ä»¶æ¥åˆ›å»ºé•œåƒç­–ç•¥ </p>
</li>
<li><p>æ ¡éªŒæ§åˆ¶é…ç½®å¹¶å°†å…¶æ›´æ”¹ä¸ºéšå¼æ‹’ç»ï¼ˆimplicit denyï¼‰</p>
</li>
<li><p>ç¼–è¾‘é…ç½®ä»¥æ­£ç¡®æŒ‡å‘æä¾›çš„ HTTPS ç«¯ç‚¹</p>
</li>
<li><p>æœ€åï¼Œé€šè¿‡å°è¯•éƒ¨ç½²æ˜“å—æ”»å‡»çš„èµ„æº /cks/img/web1.yaml æ¥æµ‹è¯•é…ç½®æ˜¯å¦æœ‰æ•ˆã€‚ </p>
</li>
</ol>
<p>ä½ å¯ä»¥åœ¨ /var/log/imagepolicy/roadrunner.log æ‰¾åˆ°å®¹å™¨é•œåƒæ‰«æä»ªçš„æ—¥å¿—æ–‡ä»¶ã€‚</p>
<p>14ã€Trivy æ‰«æé•œåƒå®‰å…¨æ¼æ´<br>Task</p>
<p>ä½¿ç”¨ Trivy å¼€æºå®¹å™¨æ‰«æå™¨æ£€æµ‹ namespace kamino ä¸­ Pod ä½¿ç”¨çš„å…·æœ‰ä¸¥é‡æ¼æ´çš„é•œåƒã€‚ æŸ¥æ‰¾å…·æœ‰ High æˆ– Critical ä¸¥é‡æ€§æ¼æ´çš„é•œåƒï¼Œå¹¶åˆ é™¤ä½¿ç”¨è¿™äº›é•œåƒçš„ Podã€‚ </p>
<p>æ³¨æ„ï¼šTrivy ä»…å®‰è£…åœ¨ cluster çš„ master èŠ‚ç‚¹ä¸Šï¼Œ åœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šä¸å¯ä½¿ç”¨ã€‚ ä½ å¿…é¡»åˆ‡æ¢åˆ° cluster çš„ master èŠ‚ç‚¹æ‰èƒ½ä½¿ç”¨ Trivy</p>
<p>15ã€é»˜è®¤ç½‘ç»œç­–ç•¥<br>Context </p>
<p>ä¸€ä¸ªé»˜è®¤æ‹’ç»ï¼ˆdefault-denyï¼‰çš„ NetworkPolicy å¯é¿å…åœ¨æœªå®šä¹‰ä»»ä½•å…¶ä»– NetworkPolicy çš„ namespace ä¸­ æ„å¤–å…¬å¼€ Podã€‚</p>
<p> Task</p>
<p>ä¸ºæ‰€æœ‰ç±»å‹ä¸º Ingress+Egress çš„æµé‡åœ¨ namespace testing ä¸­åˆ›å»ºä¸€ä¸ªåä¸º denypolicy çš„æ–°é»˜è®¤æ‹’ç» NetworkPolicyã€‚ æ­¤æ–°çš„ NetworkPolicy å¿…é¡»æ‹’ç» namespace testing ä¸­çš„æ‰€æœ‰çš„ Ingress + Egress æµé‡ã€‚ å°†æ–°åˆ›å»ºçš„é»˜è®¤æ‹’ç» NetworkPolicy åº”ç”¨ä¸åœ¨ namespace testing ä¸­è¿è¡Œçš„æ‰€æœ‰ Podã€‚ </p>
<p>ä½ å¯ä»¥åœ¨ /cks/net/p1.yaml æ‰¾åˆ°ä¸€ä¸ªæ¨¡æ¿æ¸…å•æ–‡ä»¶ã€‚</p>
<p>16ã€æ—¥å¿—å®¡è®¡ log audit<br>Task</p>
<p>åœ¨ cluster ä¸­å¯ç”¨å®¡è®¡æ—¥å¿—ã€‚ä¸ºæ­¤ï¼Œè¯·å¯ç”¨æ—¥å¿—åç«¯ï¼Œå¹¶ç¡®ä¿ï¼š<br>âš« æ—¥å¿—å­˜å‚¨åœ¨ <code>/var/log/kubernetes/audit-logs.txt</code><br>âš« æ—¥å¿—æ–‡ä»¶èƒ½ä¿ç•™ 10 å¤©<br>âš« æœ€å¤šä¿ç•™ 2 ä¸ªæ—§å®¡è®¡æ—¥å¿—æ–‡ä»¶<br>/etc/kubernetes/logpolicy/sample-policy.yaml æä¾›äº†åŸºæœ¬ç­–ç•¥ã€‚å®ƒä»…æŒ‡å®šä¸è®°å½•çš„å†…å®¹ã€‚<br>æ³¨æ„ï¼šåŸºæœ¬ç­–ç•¥ä½äº cluster çš„ master èŠ‚ç‚¹ä¸Šã€‚ ç¼–è¾‘å’Œæ‰©å±•åŸºæœ¬ç­–ç•¥ä»¥è®°å½•ï¼š<br>âš« RequestResponse çº§åˆ«çš„<br>cronjobs æ›´æ”¹<br>âš« namespace front-apps ä¸­ deployment æ›´æ”¹çš„è¯·æ±‚ä½“<br>âš« Metadataçº§åˆ«çš„æ‰€æœ‰ namespace ä¸­çš„ ConfigMap å’Œ Secret çš„æ›´æ”¹ æ­¤å¤–ï¼Œæ·»åŠ ä¸€ä¸ªå…¨æ–¹ä½çš„è§„åˆ™ä»¥åœ¨ Metadata<br>çº§åˆ«è®°å½•æ‰€æœ‰å…¶ä»–è¯·æ±‚ã€‚ æ³¨æ„ï¼šä¸è¦å¿˜è®°åº”ç”¨ä¿®æ”¹åçš„ç­–ç•¥</p>
<hr>
<h1 id="çœŸé¢˜â‘£åŸºäº1-22ç‰ˆæœ¬"><a href="#çœŸé¢˜â‘£åŸºäº1-22ç‰ˆæœ¬" class="headerlink" title="çœŸé¢˜â‘£åŸºäº1.22ç‰ˆæœ¬"></a>çœŸé¢˜â‘£åŸºäº1.22ç‰ˆæœ¬</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/alwaysbefine/article/details/128689488">äº‘åŸç”Ÿ|kubernetes|2022å¹´åº•cksçœŸé¢˜è§£æï¼ˆ1-10ï¼‰_cksè¯•é¢˜_æ™šé£_ENDçš„åšå®¢-CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/alwaysbefine/article/details/128717226">äº‘åŸç”Ÿ|kubernetes|2022å¹´åº•cksçœŸé¢˜è§£æï¼ˆ11-16ï¼‰_æ™šé£_ENDçš„åšå®¢-CSDNåšå®¢</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>å‘è¡¨</span><span class="level-item"><time dateTime="2024-12-08T16:00:00.000Z" title="12/9/2024, 12:00:00 AM">2024-12-09</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/AI/">AI</a></span><span class="level-item">1 åˆ†é’Ÿè¯»å®Œ (å¤§çº¦123ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/12/09/b0874d97f2ec.html">01.AIæ¦‚è§ˆ</a></h1><div class="content"><h2 id="Top-10-AI-Frameworks-for-2024"><a href="#Top-10-AI-Frameworks-for-2024" class="headerlink" title="Top 10 AI Frameworks for 2024"></a>Top 10 AI Frameworks for 2024</h2><p>Here are theÂ <strong><em>top 10 Artificial Intelligence Framework</em></strong>Â to Explore in 2024:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#1-tensorflow">TensorFlow</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#2-pytorch">PyTorch</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#3-theano">Theano</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#4-microsoft-cntk">Microsoft CNTK</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#5-scikitlearn">Scikit-learn</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#6-apache-mahout">Apache Mahout</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#7-amazon-machine-learning">Amazon Machine Learning</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#8-paddlepaddle">PaddlePaddle</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#9-jax">Jax</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/top-artificial-intelligence-frameworks/#10-caffe">Caffe</a></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-02-21T02:20:08.000Z" title="2/21/2024, 10:20:08 AM">2024-02-21</time>å‘è¡¨</span><span class="level-item"><time dateTime="2024-12-09T02:30:24.789Z" title="12/9/2024, 10:30:24 AM">2024-12-09</time>æ›´æ–°</span><span class="level-item">å‡ ç§’è¯»å®Œ (å¤§çº¦72ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/21/84ee50d29e8e.html">Google Pixel 7aç©æœºæ”»ç•¥</a></h1><div class="content"><h2 id="è·å–rootæƒé™"><a href="#è·å–rootæƒé™" class="headerlink" title="è·å–rootæƒé™"></a>è·å–rootæƒé™</h2><p>è§£é”bootloader</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb reboot bootloader</span><br><span class="line">fastboot flashing unlock</span><br></pre></td></tr></table></figure>

<p>åˆ·å¸¦magiskçš„init_boot.img</p>
<p>è¦è§£é” ADB é”å±ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>adb shell input keyevent 26</code>ï¼Œè¿™å°†æ¨¡æ‹Ÿè®¾å¤‡ä¸Šçš„ç”µæºé”®æŒ‰ä¸‹ï¼Œä»è€Œè§£é”å±å¹•ã€‚</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://sspai.com/post/76276">https://sspai.com/post/76276</a></p>
<p><a target="_blank" rel="noopener" href="https://developers.google.com/android/images">https://developers.google.com/android/images</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-01-30T06:39:01.000Z" title="1/30/2024, 2:39:01 PM">2024-01-30</time>å‘è¡¨</span><span class="level-item"><time dateTime="2024-12-09T02:31:40.606Z" title="12/9/2024, 10:31:40 AM">2024-12-09</time>æ›´æ–°</span><span class="level-item">38 åˆ†é’Ÿè¯»å®Œ (å¤§çº¦5691ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/01/30/64634917304d.html">2024å¹´CKSè€ƒè¯•å‡†å¤‡</a></h1><div class="content"><blockquote>
<p>Start : 2024.1.15</p>
<p>DDL1ï¼š2024.2.3 15:00 (Rescheduled)</p>
<p>DDL2ï¼š2024.2.8 20:00 (Failed)</p>
<p>DDL3:  2024.2.23 23:30 (Success)</p>
</blockquote>
<h2 id="å­¦ä¹ ç¯å¢ƒæ­å»º"><a href="#å­¦ä¹ ç¯å¢ƒæ­å»º" class="headerlink" title="å­¦ä¹ ç¯å¢ƒæ­å»º"></a>å­¦ä¹ ç¯å¢ƒæ­å»º</h2><p><a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">Install Calico CNI</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Other prerequisites</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">swap,br_netfilter....</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Configure containerd</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">containerd config default | sed <span class="string">&#x27;s|SystemdCgroup = false|SystemdCgroup = true|g&#x27;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/containerd/config.toml &gt; /dev/null</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> systemctl restart containerd &amp;&amp; systemctl status containerd</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Hosts</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;127.0.0.1 kube.multipass.local&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/hosts &gt; /dev/null</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Initialize Kubernetes cluster</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubeadm init --pod-network-cidr=10.244.0.0/16 --control-plane-endpoint kube.multipass.local</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">untaint master node</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get node --no-headers | grep control-plane | awk <span class="string">&#x27;&#123;cmd=&quot;kubectl taint node &quot;$1&quot; node-role.kubernetes.io/control-plane-&quot;;system(cmd)&#125;&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Install Calico CNI <span class="built_in">which</span> supports Network Policy</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml | sed <span class="string">&#x27;s|192.168|10.244|g&#x27;</span> | kubectl apply -f -</span></span><br></pre></td></tr></table></figure>

<p>There may be lots of impediments to setting up this kubernetes cluster successfully due to network conditions or some misconfigurations, but those above can be solved step by step. Finally, node(s) is(are) ready as follows:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get node</span></span><br><span class="line">NAME          STATUS   ROLES           AGE   VERSION</span><br><span class="line">kube-master   Ready    control-plane   21m   v1.28.3</span><br></pre></td></tr></table></figure>

<h2 id="åšé¢˜å·¥å…·"><a href="#åšé¢˜å·¥å…·" class="headerlink" title="åšé¢˜å·¥å…·"></a>åšé¢˜å·¥å…·</h2><h3 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alias k=kubectl                         # will already be pre-configured</span><br><span class="line">export do=&quot;--dry-run=client -o yaml&quot;    # k create deploy nginx --image=nginx $do</span><br><span class="line">export now=&quot;--force --grace-period 0&quot;   # k delete pod x $now</span><br></pre></td></tr></table></figure>

<h3 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set tabstop=2</span><br><span class="line">set expandtab</span><br><span class="line">set shiftwidth=2</span><br></pre></td></tr></table></figure>

<h3 id="jsonpath"><a href="#jsonpath" class="headerlink" title="jsonpath"></a>jsonpath</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/jsonpath/">https://kubernetes.io/docs/reference/kubectl/jsonpath/</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
<th>Example</th>
<th>Result</th>
</tr>
</thead>
<tbody><tr>
<td><code>text</code></td>
<td>the plain text</td>
<td><code>kind is &#123;.kind&#125;</code></td>
<td><code>kind is List</code></td>
</tr>
<tr>
<td><code>@</code></td>
<td>the current object</td>
<td><code>&#123;@&#125;</code></td>
<td>the same as input</td>
</tr>
<tr>
<td><code>.</code> or <code>[]</code></td>
<td>child operator</td>
<td><code>&#123;.kind&#125;</code>, <code>&#123;[&#39;kind&#39;]&#125;</code> or <code>&#123;[&#39;name\.type&#39;]&#125;</code></td>
<td><code>List</code></td>
</tr>
<tr>
<td><code>..</code></td>
<td>recursive descent</td>
<td><code>&#123;..name&#125;</code></td>
<td><code>127.0.0.1 127.0.0.2 myself e2e</code></td>
</tr>
<tr>
<td><code>*</code></td>
<td>wildcard. Get all objects</td>
<td><code>&#123;.items[*].metadata.name&#125;</code></td>
<td><code>[127.0.0.1 127.0.0.2]</code></td>
</tr>
<tr>
<td><code>[start:end:step]</code></td>
<td>subscript operator</td>
<td><code>&#123;.users[0].name&#125;</code></td>
<td><code>myself</code></td>
</tr>
<tr>
<td><code>[,]</code></td>
<td>union operator</td>
<td><code>&#123;.items[*][&#39;metadata.name&#39;, &#39;status.capacity&#39;]&#125;</code></td>
<td><code>127.0.0.1 127.0.0.2 map[cpu:4] map[cpu:8]</code></td>
</tr>
<tr>
<td><code>?()</code></td>
<td>filter</td>
<td><code>&#123;.users[?(@.name==&quot;e2e&quot;)].user.password&#125;</code></td>
<td><code>secret</code></td>
</tr>
<tr>
<td><code>range</code>, <code>end</code></td>
<td>iterate list</td>
<td><code>&#123;range .items[*]&#125;[&#123;.metadata.name&#125;, &#123;.status.capacity&#125;] &#123;end&#125;</code></td>
<td><code>[127.0.0.1, map[cpu:4]] [127.0.0.2, map[cpu:8]]</code></td>
</tr>
<tr>
<td><code>&#39;&#39;</code></td>
<td>quote interpreted string</td>
<td><code>&#123;range .items[*]&#125;&#123;.metadata.name&#125;&#123;&#39;\t&#39;&#125;&#123;end&#125;</code></td>
<td><code>127.0.0.1 127.0.0.2</code></td>
</tr>
<tr>
<td><code>\</code></td>
<td>escape termination character</td>
<td><code>&#123;.items[0].metadata.labels.kubernetes\.io/hostname&#125;</code></td>
<td><code>127.0.0.1</code></td>
</tr>
</tbody></table>
<p>Examples using <code>kubectl</code> and JSONPath expressions:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o json</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;@&#125;&#x27;</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;.items[0]&#125;&#x27;</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span><br><span class="line">kubectl get pods -o=jsonpath=&quot;&#123;.items[*][&#x27;metadata.name&#x27;, &#x27;status.capacity&#x27;]&#125;&quot;</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;range .items[*]&#125;&#123;.metadata.name&#125;&#123;&quot;\t&quot;&#125;&#123;.status.startTime&#125;&#123;&quot;\n&quot;&#125;&#123;end&#125;&#x27;</span><br><span class="line">kubectl get pods -o=jsonpath=&#x27;&#123;.items[0].metadata.labels.kubernetes\.io/hostname&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="yq"><a href="#yq" class="headerlink" title="yq"></a>yq</h3><p>examples</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Read a value</span></span><br><span class="line">yq &#x27;.a.b[0].c&#x27; file.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Pipe from STDIN</span></span><br><span class="line">yq &#x27;.a.b[0].c&#x27; &lt; file.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Update a yaml file, <span class="keyword">in</span> place</span></span><br><span class="line">yq -i &#x27;.a.b[0].c = &quot;cool&quot;&#x27; file.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Find and update an item <span class="keyword">in</span> an array</span></span><br><span class="line">yq &#x27;(.[] | select(.name == &quot;foo&quot;) | .address) = &quot;12 cat st&quot;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>jq</li>
<li>tr</li>
<li>truncate</li>
<li>crictl</li>
<li>cut</li>
</ul>
<h3 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h3><p>å¸¸è§„ä½¿ç”¨</p>
<p>ç»„è£…å‘½ä»¤å¹¶æ‰§è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc | awk &#x27;&#123;cmd=&quot;kubectl get svc &quot;$1&quot; -oyaml&quot;;system(cmd)&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>sed</li>
<li>sha512sum</li>
<li>podman(to build image)</li>
</ul>
<h3 id="æ—¥å¿—æŸ¥çœ‹"><a href="#æ—¥å¿—æŸ¥çœ‹" class="headerlink" title="æ—¥å¿—æŸ¥çœ‹"></a>æ—¥å¿—æŸ¥çœ‹</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/cluster-administration/logging/#system-component-logs">https://kubernetes.io/docs/concepts/cluster-administration/logging/#system-component-logs</a></p>
</blockquote>
<ul>
<li><p>å¯¹ kubelet ç»„ä»¶ï¼š<code>journalctl -xefu kubelet</code></p>
</li>
<li><p>å¯¹ä»¥å®¹å™¨å½¢å¼å¯åŠ¨çš„ kubernetes ç»„ä»¶ï¼šåœ¨<code>/var/log/pods</code>ä¸‹ï¼ˆå½“æŠŠkube-apiserverçš„yamlå¼„åèµ·ä¸æ¥ä¹‹åï¼Œåº”è¯¥å¯ä»¥åœ¨è¿™ä¸ªç›®å½•ä¸‹æŸ¥çœ‹å¯åŠ¨å¤±è´¥çš„åŸå› ï¼‰</p>
</li>
</ul>
<h3 id="groupç¼©å†™é—®é¢˜"><a href="#groupç¼©å†™é—®é¢˜" class="headerlink" title="groupç¼©å†™é—®é¢˜"></a>groupç¼©å†™é—®é¢˜</h3><p>groupä¸ºç©ºæ—¶è¡¨ç¤º<code>core</code> groupï¼Œæ­¤æ—¶çš„ gv ç¼©å†™åªæœ‰ vï¼Œå³</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl api-resources --api-group=<span class="string">&#x27;&#x27;</span></span></span><br><span class="line">NAME                     SHORTNAMES   APIVERSION   NAMESPACED   KIND</span><br><span class="line">bindings                              v1           true         Binding</span><br><span class="line">componentstatuses        cs           v1           false        ComponentStatus</span><br><span class="line">configmaps               cm           v1           true         ConfigMap</span><br><span class="line">endpoints                ep           v1           true         Endpoints</span><br><span class="line">events                   ev           v1           true         Event</span><br><span class="line">limitranges              limits       v1           true         LimitRange</span><br><span class="line">namespaces               ns           v1           false        Namespace</span><br><span class="line">nodes                    no           v1           false        Node</span><br><span class="line">persistentvolumeclaims   pvc          v1           true         PersistentVolumeClaim</span><br><span class="line">persistentvolumes        pv           v1           false        PersistentVolume</span><br><span class="line">pods                     po           v1           true         Pod</span><br><span class="line">podtemplates                          v1           true         PodTemplate</span><br><span class="line">replicationcontrollers   rc           v1           true         ReplicationController</span><br><span class="line">resourcequotas           quota        v1           true         ResourceQuota</span><br><span class="line">secrets                               v1           true         Secret</span><br><span class="line">serviceaccounts          sa           v1           true         ServiceAccount</span><br><span class="line">services                 svc          v1           true         Service</span><br></pre></td></tr></table></figure>

<p>å¸¸è§çš„æ§åˆ¶å™¨èµ„æºåŸºæœ¬å±äº<code>apps</code> group</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                  SHORTNAMES   APIVERSION   NAMESPACED   KIND</span><br><span class="line">controllerrevisions                apps/v1      true         ControllerRevision</span><br><span class="line">daemonsets            ds           apps/v1      true         DaemonSet</span><br><span class="line">deployments           deploy       apps/v1      true         Deployment</span><br><span class="line">replicasets           rs           apps/v1      true         ReplicaSet</span><br><span class="line">statefulsets          sts          apps/v1      true         StatefulSet</span><br></pre></td></tr></table></figure>

<p>å¸¸è§çš„å‡ ç§éœ€è¦å¡«å……groupçš„åœ°æ–¹</p>
<ul>
<li><p>rbac</p>
<p><code>role.rules.apiGroups</code> åªéœ€è¦å¡«å†™group</p>
</li>
<li><p>audit policy</p>
<p><code>rules.resources.group</code> åªéœ€è¦å¡«å†™group</p>
</li>
</ul>
<h2 id="åšé¢˜æ–¹æ³•è®º"><a href="#åšé¢˜æ–¹æ³•è®º" class="headerlink" title="åšé¢˜æ–¹æ³•è®º"></a>åšé¢˜æ–¹æ³•è®º</h2><p>å®¢è§‚å±€é™</p>
<ol>
<li>ç½‘ç»œå¡é¡¿ï¼Œå¯¼è‡´åšé¢˜æ—¶åŠå…¶ä¸æµç•…ï¼›</li>
<li>é¢˜é‡å¤§ï¼Œæ€»å…±æœ‰<code>16</code>é“é¢˜ï¼Œéœ€è¦åœ¨<code>120</code>åˆ†é’Ÿå†…å®Œæˆï¼Œå®Œæˆä¸€é“é¢˜çš„å¹³å±€æ—¶é—´åº”è¯¥120/16=<code>7</code>åˆ†é’Ÿï¼›</li>
</ol>
<p>ä¸»è§‚å±€é™</p>
<ol>
<li>å¯¹å®‰å…¨ç›¸å…³çš„æ“ä½œä¸ç†Ÿç»ƒï¼›</li>
<li>æ— åšé¢˜ç­–ç•¥ï¼Œé€‰æ‹©æŒ‰é¡ºåºï¼Œä»å¤´åšåˆ°å°¾ï¼›</li>
<li>å¼€å§‹åšé¢˜å‰ï¼Œæœªå¯¹è¯¥é¢˜è¿›è¡Œè‡ªæˆ‘è¯„ä¼°ï¼Œä¸ç¡®å®šèƒ½å¦çŸ­æ—¶é—´å†…æå®šï¼Œåšäº†ä¸€åŠï¼Œå‘ç°æä¸å®šï¼Œéå¸¸æµªè´¹æ—¶é—´ï¼›</li>
</ol>
<p>æ”¹è¿›æªæ–½</p>
<ol>
<li>æ”¹ç”¨é¦™æ¸¯/æ¾³é—¨ç§»åŠ¨ç½‘ç»œæ¼«æ¸¸æ¥åšé¢˜ï¼ˆå¦‚æœè¿™æ¬¡è¿˜æ˜¯è€ƒä¸è¿‡ï¼Œæœ‰ç½‘ç»œå¡é¡¿çš„åŸå› ï¼Œä¸‹æ¬¡å¾—è‚‰èº«è·‘åˆ°é¦™æ¸¯å»äº†23333ï¼‰ï¼›</li>
<li>åŠæ ¼åˆ†æ•°éœ€è¦<code>67</code>ï¼Œç²—ç•¥ä¼°è®¡å–å¾—è¯ä¹¦ï¼Œéœ€è¦åšå®Œ<em>67/(100/16)</em>=<code>11</code>é“é¢˜ï¼Œå¯ä»¥å…è®¸<code>5</code>é“é¢˜ä¸åšï¼Œä½†æ¯é¢˜çš„å¹³å‡ç”¨æ—¶ä¸º<code>10</code>åˆ†é’Ÿå¤šä¸€ç‚¹ã€‚</li>
<li>åšé¢˜æ­¥éª¤<ol>
<li>èŠ±<code>1</code>åˆ†é’Ÿæµè§ˆå…¨é¢˜ï¼Œç†è§£é¢˜æ„ï¼Œå¹¶è¯„ä¼°æ˜¯å¦æœ‰æŠŠæ¡èƒ½å®Œæˆï¼›</li>
<li>æ²¡æŠŠæ¡çš„ç”¨flagæ ‡è®°ï¼Œè·³è¿‡ï¼Œä¸‹ä¸€é¢˜ï¼›</li>
</ol>
</li>
<li>ä¼˜å…ˆå»åšçš„é¢˜ç›®ç±»å‹<ol>
<li>audit policy</li>
<li><strong>apparmor</strong></li>
<li>pod security standard</li>
<li><strong>runtime class</strong></li>
<li>image policy webhook</li>
<li><strong>trivy</strong> &amp; kube-bench</li>
<li>rbac &amp; opa</li>
<li><strong>secret</strong></li>
<li><strong>security context</strong></li>
</ol>
</li>
</ol>
<h2 id="ä¸»é¢˜"><a href="#ä¸»é¢˜" class="headerlink" title="ä¸»é¢˜"></a>ä¸»é¢˜</h2><h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/docs/reference/access-authn-authz/rbac/</a></p>
</blockquote>
<p>åˆ›å»ºsaã€roleã€rolebinding</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create sa shs-sa</span><br><span class="line">kubectl create role shs-role --resource=pods,secrets --verb=*</span><br><span class="line">kubectl create rolebinding shs-rolebinding --role=shs-role --serviceaccount=default:shs-sa</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨è¯¥ServiceAccount</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;serviceAccountName&quot;:&quot;shs-saax&quot;,&quot;serviceAccount&quot;:&quot;shs-saax&quot;&#125;&#125;&#125;&#125;&#x27; deployment shs-dep</span><br></pre></td></tr></table></figure>

<p>Tips:</p>
<ol>
<li>å¦‚æœsaå¼‚å¸¸ï¼ˆå¦‚ï¼šä¸å­˜åœ¨ï¼‰ï¼Œåˆ™deploymentçš„podä¸ä¼šå»ºå‡ºæ¥ï¼Œå› ä¸ºrsæ§åˆ¶å™¨å·²ç»æ£€æµ‹åˆ°äº†å¼‚å¸¸ï¼Œæ‰€ä»¥æœªå»ºpodã€‚</li>
<li><code>deploy.spec.template.spec.serviceAccount</code> ä¸ <code>deploy.spec.template.spec.serviceAccountName</code> éƒ½éœ€è¦ä¿®æ”¹ã€‚</li>
</ol>
<h3 id="NetworkPolicy"><a href="#NetworkPolicy" class="headerlink" title="NetworkPolicy"></a>NetworkPolicy</h3><h4 id="Pod-Isolation"><a href="#Pod-Isolation" class="headerlink" title="Pod Isolation"></a>Pod Isolation</h4><ul>
<li>Egress, outbound connection from pod, non-isolated by default. If NetworkPolicy selects this pod and was <code>Egress</code> type, then only out connections mentioned in it allowed. If lots of NetworkPolicy select the same pod, then all connections mentoined in those list are allowed. Additive. </li>
<li>Ingress, inbound connection to pod, non-isolated by default. Effects are as the same as Egress. Only connections mentioned by NetworkPolicy can connect to this Pod successfully.<br>Examples</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># Indicates which pods this NetworkPolicy will apply to, selecting by pod&#x27;s label</span></span><br><span class="line">  <span class="comment"># podSelector: &#123;&#125; indicates this NetworkPolicy apply to all pods in default ns.</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="comment"># Defines which pod can connect to this pod.</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="comment"># both `from` and `port` rules are satitisfied, then allowed</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">        <span class="comment"># 1. IP CIDR, connections from pod whose IP in this CIDR are allowd to connect</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">            <span class="attr">cidr:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">            <span class="attr">except:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="number">172.17</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">        <span class="comment"># 2. Namespace, connection from pod whose namespace has following labels are allowed to connect</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">project:</span> <span class="string">myproject</span></span><br><span class="line">        <span class="comment"># 3. Pod, connections from pod which has following labels are allowed to connect</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">role:</span> <span class="string">frontend</span></span><br><span class="line">     <span class="comment"># Based on `from`, if the target port of those connection was 6379 and protocl was TCP, allowed.</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="comment"># Defines which pod can be connected by this pod</span></span><br><span class="line">  <span class="comment"># both `to` and `port` rules are satitisfied, then allowed</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">       <span class="comment"># 1. Connections from this pod can connect to this CIDR</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">            <span class="attr">cidr:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="comment"># Based on `to`, if the target port and protocol of this connection was 5978 and TCP, allowed.</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">5978</span></span><br></pre></td></tr></table></figure>

<p>parameters of <code>to</code> and <code>from</code> was the same, as follows(irrelevant informations are omitted):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl explain networkpolicy.spec.ingress</span></span><br><span class="line">  from	&lt;[]NetworkPolicyPeer&gt;</span><br><span class="line">  ports	&lt;[]NetworkPolicyPort&gt;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl explain networkpolicy.spec.egress</span></span><br><span class="line">   to	 &lt;[]NetworkPolicyPeer&gt;</span><br><span class="line">   ports &lt;[]NetworkPolicyPort&gt;</span><br></pre></td></tr></table></figure>

<p>details of <code>NetworkPolicyPeer</code> are as follows:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl explain networkpolicy.spec.egress.to</span></span><br><span class="line">  ipBlock	&lt;IPBlock&gt;</span><br><span class="line">  namespaceSelector	&lt;LabelSelector&gt;</span><br><span class="line">  podSelector	&lt;LabelSelector&gt;</span><br></pre></td></tr></table></figure>

<p>As for details of <code>IPBlock</code> and <code>LabelSelector</code>, just <code>kubectl explain</code> before coding yamls.</p>
<h4 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h4><ul>
<li><code>NetworkPolicy</code> was namespaced, and only works in the namespace to which it belongs.</li>
<li><code>NetworkPolicy</code> can define only allowed rules.</li>
<li><code>NetworkPolicy</code> selects pod by labels only.</li>
</ul>
<h4 id="Default-network-policy"><a href="#Default-network-policy" class="headerlink" title="Default network policy"></a>Default network policy</h4><p>Deny all in &amp; out bound traffics for a pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br></pre></td></tr></table></figure>

<h3 id="The-OPA-Open-Policy-Agent-Gatekeeper"><a href="#The-OPA-Open-Policy-Agent-Gatekeeper" class="headerlink" title="The OPA(Open Policy Agent) Gatekeeper"></a>The OPA(Open Policy Agent) Gatekeeper</h3><blockquote>
<p>Ref: <a target="_blank" rel="noopener" href="https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes">https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes</a></p>
</blockquote>
<p>gatekeeper admission controller æ‹¦æˆªæ‰€æœ‰èµ„æºçš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤è¯·æ±‚ï¼Œå¹¶é’ˆå¯¹ç›¸å…³èµ„æºï¼Œåšæ‰€é…ç½®çš„æ ¡éªŒã€‚</p>
<h4 id="å®šä¹‰æ ¡éªŒæ¨¡æ¿"><a href="#å®šä¹‰æ ¡éªŒæ¨¡æ¿" class="headerlink" title="å®šä¹‰æ ¡éªŒæ¨¡æ¿"></a>å®šä¹‰æ ¡éªŒæ¨¡æ¿</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">templates.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConstraintTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8srequiredlabels</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">crd:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">names:</span></span><br><span class="line">        <span class="attr">kind:</span> <span class="string">K8sRequiredLabels</span></span><br><span class="line">        <span class="attr">listKind:</span> <span class="string">K8sRequiredLabelsList</span></span><br><span class="line">        <span class="attr">plural:</span> <span class="string">k8srequiredlabels</span></span><br><span class="line">        <span class="attr">singular:</span> <span class="string">k8srequiredlabels</span></span><br><span class="line">      <span class="attr">validation:</span></span><br><span class="line">        <span class="comment"># Schema for the `parameters` field</span></span><br><span class="line">        <span class="attr">openAPIV3Schema:</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">              <span class="attr">items:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">targets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="string">admission.k8s.gatekeeper.sh</span></span><br><span class="line">      <span class="attr">rego:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        package k8srequiredlabels</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">        <span class="string">deny[&#123;&quot;msg&quot;:</span> <span class="string">msg,</span> <span class="attr">&quot;details&quot;:</span> &#123;<span class="attr">&quot;missing_labels&quot;:</span> <span class="string">missing</span>&#125;<span class="string">&#125;]</span> &#123;</span><br><span class="line">          <span class="string">provided</span> <span class="string">:=</span> &#123;<span class="string">label</span> <span class="string">|</span> <span class="string">input.review.object.metadata.labels</span>[<span class="string">label</span>]&#125;</span><br><span class="line">          <span class="string">required</span> <span class="string">:=</span> &#123;<span class="string">label</span> <span class="string">|</span> <span class="string">label</span> <span class="string">:=</span> <span class="string">input.parameters.labels</span>[<span class="string">_</span>]&#125;</span><br><span class="line">          <span class="string">missing</span> <span class="string">:=</span> <span class="string">required</span> <span class="bullet">-</span> <span class="string">provided</span></span><br><span class="line">          <span class="string">count(missing)</span> <span class="string">&gt;</span> <span class="number">0</span></span><br><span class="line">          <span class="string">msg</span> <span class="string">:=</span> <span class="string">sprintf(&quot;you</span> <span class="attr">must provide labels:</span> <span class="string">%v&quot;</span>, [<span class="string">missing</span>]<span class="string">)</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="åˆ›å»ºå…·ä½“çº¦æŸ"><a href="#åˆ›å»ºå…·ä½“çº¦æŸ" class="headerlink" title="åˆ›å»ºå…·ä½“çº¦æŸ"></a>åˆ›å»ºå…·ä½“çº¦æŸ</h4><p>æ¯ä¸ªå‘½åç©ºé—´éƒ½éœ€è¦ä¸€ä¸ªæ ‡ç­¾<code>hr</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">constraints.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">K8sRequiredLabels</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ns-must-have-hr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">match:</span></span><br><span class="line">    <span class="attr">kinds:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">        <span class="attr">kinds:</span> [<span class="string">&quot;Namespace&quot;</span>]</span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;hr&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="å®¡è®¡"><a href="#å®¡è®¡" class="headerlink" title="å®¡è®¡"></a>å®¡è®¡</h4><p>Gatekeeper stores audit results as <code>violations</code> listed in the <code>status</code> field of the relevant Constraint.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">constraints.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">K8sRequiredLabels</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ns-must-have-hr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">match:</span></span><br><span class="line">    <span class="attr">kinds:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">        <span class="attr">kinds:</span> [<span class="string">&quot;Namespace&quot;</span>]</span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;hr&quot;</span>]</span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="comment">#...</span></span><br><span class="line">  <span class="attr">violations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">enforcementAction:</span> <span class="string">deny</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;you must provide labels: &#123;&quot;hr&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">enforcementAction:</span> <span class="string">deny</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;you must provide labels: &#123;&quot;hr&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gatekeeper-system</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">enforcementAction:</span> <span class="string">deny</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;you must provide labels: &#123;&quot;hr&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-public</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">enforcementAction:</span> <span class="string">deny</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;you must provide labels: &#123;&quot;hr&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>

<h3 id="Apparmor"><a href="#Apparmor" class="headerlink" title="Apparmor"></a>Apparmor</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/security/apparmor/">https://kubernetes.io/docs/tutorials/security/apparmor/</a></p>
</blockquote>
<p>Confine programs or containers to limited set of resources, such as Linux capabilities, network access, file permissions, etc.</p>
<h4 id="Works-in-2-Modes"><a href="#Works-in-2-Modes" class="headerlink" title="Works in 2 Modes"></a>Works in 2 Modes</h4><ul>
<li>enforcing, blocks access</li>
<li>complain, only reports invalid access</li>
</ul>
<h4 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h4><ul>
<li>works on kubernetes v1.4 +</li>
<li>AppArmor kernel moduls enabled</li>
<li>Container Runtime supports AppArmor</li>
<li>Profile is loaded by kernel</li>
</ul>
<h4 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h4><p>Add annotations to pod which needed to be secured with key, name of container in Pod should be referred in key: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">container.apparmor.security.beta.kubernetes.io/&lt;container_name&gt;:</span> <span class="string">&lt;profile_ref&gt;</span></span><br><span class="line"><span class="string">container.apparmor.security.beta.kubernetes.io/&lt;container_name&gt;:</span> <span class="string">&lt;profile_ref&gt;</span></span><br></pre></td></tr></table></figure>

<p>The <code>profile_ref</code> can be one of:</p>
<ul>
<li><code>runtime/default</code> to apply the runtimeâ€™s default profile</li>
<li><code>localhost/&lt;profile_name&gt;</code> to apply the profile loaded on the host with the name <code>&lt;profile_name&gt;</code></li>
<li><code>unconfined</code> to indicate that no profiles will be loaded</li>
</ul>
<h4 id="Works"><a href="#Works" class="headerlink" title="Works"></a>Works</h4><ul>
<li>View Pod Events</li>
<li><code>kubectl exec &lt;pod_name&gt; -- cat /proc/1/attr/current</code></li>
</ul>
<h4 id="Helpful-commands"><a href="#Helpful-commands" class="headerlink" title="Helpful commands"></a>Helpful commands</h4><ul>
<li>Show AppArmor Status</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apparmor_status</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Load Profile to kernel</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apparmor_parser /etc/apparmor.d/nginx_apparmor</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> apparmor_parser -q &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">include &lt;tunables/global&gt;</span></span></span><br><span class="line"></span><br><span class="line">profile k8s-apparmor-example-deny-write flags=(attach_disconnected) &#123;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="string">include &lt;abstractions/base&gt;</span></span></span><br><span class="line"></span><br><span class="line">  file,</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"><span class="string">Deny all file writes.</span></span></span><br><span class="line">  deny /** w,</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="Audit-Policy"><a href="#Audit-Policy" class="headerlink" title="Audit Policy"></a>Audit Policy</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy">https://kubernetes.io/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/">Getting Started</a></p>
<h4 id="Stage"><a href="#Stage" class="headerlink" title="Stage"></a>Stage</h4><ul>
<li><code>RequestReceived</code> - Before handled by handler chain</li>
<li><code>ResponseStarted</code> - After response header sent, but before response body sent</li>
<li><code>ResponseComplete</code> - After response body sent</li>
<li><code>Panic</code> - After panic occurred.</li>
</ul>
<h4 id="Audit-Level"><a href="#Audit-Level" class="headerlink" title="Audit Level"></a>Audit Level</h4><ul>
<li><code>None</code> - donâ€™t log events that match this rule</li>
<li><code>Metadata</code> - log request metadata only(user, timestamp,resource,vert) but not request or response body.</li>
<li><code>Request</code> - log event metadata plus request body</li>
<li><code>RequestResponse</code> - log event metadata plus request, response bodies.</li>
</ul>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">omitStages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ResponseStarted</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ResponseComplete</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Panic</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>Configure it to kube-apiserver, see audit log. </p>
<h4 id="Tips-1"><a href="#Tips-1" class="headerlink" title="Tips"></a>Tips</h4><p>If the <code>Policy</code> doesnâ€™t work as expected, check kube-apiserver logs as below, make sure the <code>Policy</code> was loaded successfully. Since it seems to load a default <code>AuditPolicy</code> when failled to load the <code>AuditPolicy</code> passed in parameters of kube-apiserver. Logs are as below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">W0122 16:00:29.139016       1 reader.go:81] Audit policy contains errors, falling back to lenient decoding: strict decoding error: unknown field &quot;rules[0].resources[0].resource&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Pod-Security-Standard"><a href="#Pod-Security-Standard" class="headerlink" title="Pod Security Standard"></a>Pod Security Standard</h3><blockquote>
<p>Reference</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/pod-security-standards">https://kubernetes.io/docs/concepts/security/pod-security-standards</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/pod-security-admission">https://kubernetes.io/docs/concepts/security/pod-security-admission</a></li>
</ul>
</blockquote>
<h4 id="Policies"><a href="#Policies" class="headerlink" title="Policies"></a>Policies</h4><p>The Pod Security Standards define three different <em>policies</em> to broadly cover the security spectrum. These policies are <em>cumulative</em> and range from highly-permissive to highly-restrictive. This guide outlines the requirements of each policy.</p>
<p>3ç§ç­–ç•¥ï¼Œæ¯ç§ç­–ç•¥åªæ˜¯å®šä¹‰äº†æ£€æŸ¥ã€æ ¡éªŒå“ªäº›å­—æ®µã€å³æ ¡éªŒèŒƒå›´ã€‚æ­¤3ç§ç­–ç•¥ï¼Œä»ä¸Šè‡³ä¸‹ï¼Œæ ¡éªŒèŒƒå›´ä¾æ¬¡å¢å¤§ã€‚å…·ä½“æ ¡éªŒå†…å®¹ï¼Œå¯å‚è€ƒæ–‡æ¡£ã€‚</p>
<table>
<thead>
<tr>
<th>Profile</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Privileged</strong></td>
<td>Unrestricted policy, providing the widest possible level of permissions. This policy allows for known privilege escalations.</td>
</tr>
<tr>
<td><strong>Baseline</strong></td>
<td>Minimally restrictive policy which prevents known privilege escalations. Allows the default (minimally specified) Pod configuration.</td>
</tr>
<tr>
<td><strong>Restricted</strong></td>
<td>Heavily restricted policy, following current Pod hardening best practices.</td>
</tr>
</tbody></table>
<h4 id="Levels"><a href="#Levels" class="headerlink" title="Levels"></a>Levels</h4><p>æœ‰3ç§é’ˆå¯¹ä¸ç¬¦åˆä¸Šè¿°3ç§Policyçš„å¤„ç†æ–¹å¼ï¼Œå³<em>å¼ºåˆ¶è¦æ±‚ï¼ˆå¦åˆ™æ‹’ç»åˆ›å»ºï¼‰</em>ã€<em>è®°å½•åˆ°å®¡è®¡æ—¥å¿—ä¸­</em>ã€<em>ç”¨æˆ·å¯è§è­¦å‘Š</em>ã€‚</p>
<table>
<thead>
<tr>
<th align="left">Mode</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>enforce</strong></td>
<td align="left">Policy violations will cause the pod to be rejected.</td>
</tr>
<tr>
<td align="left"><strong>audit</strong></td>
<td align="left">Policy violations will trigger the addition of an audit annotation to the event recorded in the <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/">audit log</a>, but are otherwise allowed.</td>
</tr>
<tr>
<td align="left"><strong>warn</strong></td>
<td align="left">Policy violations will trigger a user-facing warning, but are otherwise allowed.</td>
</tr>
</tbody></table>
<h4 id="Usage-1"><a href="#Usage-1" class="headerlink" title="Usage"></a>Usage</h4><p>åœ¨å‘½åç©ºé—´ä¸Šæ‰“æ ‡ç­¾</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The per-mode level label indicates which policy level to apply for the mode.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># MODE must be one of `enforce`, `audit`, or `warn`.</span></span><br><span class="line"><span class="comment"># LEVEL must be one of `privileged`, `baseline`, or `restricted`.</span></span><br><span class="line"><span class="string">pod-security.kubernetes.io/&lt;MODE&gt;:</span> <span class="string">&lt;LEVEL&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional: per-mode version label that can be used to pin the policy to the</span></span><br><span class="line"><span class="comment"># version that shipped with a given Kubernetes minor version (for example v1.29).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># MODE must be one of `enforce`, `audit`, or `warn`.</span></span><br><span class="line"><span class="comment"># VERSION must be a valid Kubernetes minor version, or `latest`.</span></span><br><span class="line"><span class="string">pod-security.kubernetes.io/&lt;MODE&gt;-version:</span> <span class="string">&lt;VERSION&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="SecurityContext"><a href="#SecurityContext" class="headerlink" title="SecurityContext"></a>SecurityContext</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</a></p>
</blockquote>
<p>æ€»å…±æœ‰ä¸¤ä¸ªå®‰å…¨é…ç½®çš„åœ°æ–¹ï¼Œä½ç½®åˆ†åˆ«ä¸º</p>
<ul>
<li><code>pod.spec.securityContext</code> å±äº <code>PodSecurityContext</code> è¿™ä¸ªç»“æ„ä½“ï¼Œè¡¨ç¤ºpodä¸­æ‰€æœ‰çš„å®¹å™¨éƒ½ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼›</li>
<li><code>pod.spec[&quot;initContainers&quot;,&quot;containers&quot;].securityContext</code> å±äº <code>SecurityContext</code> è¿™ä¸ªç»“æ„ä½“ï¼Œåªé™äºå½“å‰å®¹å™¨ä½¿ç”¨æ­¤é…ç½®ï¼Œä¸”ä¼˜å…ˆçº§é«˜äºä¸Šé¢çš„é…ç½®ã€‚</li>
</ul>
<p>ä¸Šè¿°ä¸¤ç§ä¸åŒä½ç½®çš„å®‰å…¨é…ç½®ä¸­ï¼Œæœ‰çš„å­—æ®µæ˜¯é‡å¤çš„ï¼Œ<code>SecurityContext</code> çš„ä¼˜å…ˆçº§æ›´é«˜ã€‚ä¸¤è€…ä¹‹é—´å€¼çš„å·®å¼‚ï¼ˆéƒ½å­˜åœ¨çš„å­—æ®µå·²åŠ ç²—ï¼‰ï¼š</p>
<table>
<thead>
<tr>
<th>PodSecurityContext</th>
<th>SecurityContext</th>
</tr>
</thead>
<tbody><tr>
<td>fsGroup</td>
<td>allowPrivilegeEscalation</td>
</tr>
<tr>
<td>fsGroupChangePolicy</td>
<td>capabilities</td>
</tr>
<tr>
<td><strong>runAsGroup</strong></td>
<td>privileged</td>
</tr>
<tr>
<td><strong>runAsNonRoot</strong></td>
<td>procMount</td>
</tr>
<tr>
<td><strong>runAsUser</strong></td>
<td>readOnlyRootFilesystem</td>
</tr>
<tr>
<td><strong>seLinuxOptions</strong></td>
<td><strong>runAsGroup</strong></td>
</tr>
<tr>
<td><strong>seccompProfile</strong></td>
<td><strong>runAsNonRoot</strong></td>
</tr>
<tr>
<td>supplementalGroups</td>
<td><strong>runAsUser</strong></td>
</tr>
<tr>
<td>sysctls</td>
<td><strong>seLinuxOptions</strong></td>
</tr>
<tr>
<td><strong>windowsOptions</strong></td>
<td><strong>seccompProfile</strong></td>
</tr>
<tr>
<td></td>
<td><strong>windowsOptions</strong></td>
</tr>
</tbody></table>
<hr>
<blockquote>
<p>æ¥æºï¼š<a target="_blank" rel="noopener" href="https://www.mrdadong.com/archives/cks-securitycontext">https://www.mrdadong.com/archives/cks-securitycontext</a></p>
</blockquote>
<p><em>æŒ‰ç…§å¦‚ä¸‹è¦æ±‚ä¿®æ”¹ <code>sec-ns</code> å‘½åç©ºé—´é‡Œçš„ Deployment <code>secdep</code></em></p>
<p><em>ä¸€ã€ç”¨ ID ä¸º 30000 çš„ç”¨æˆ·å¯åŠ¨å®¹å™¨ï¼ˆè®¾ç½®ç”¨æˆ· ID ä¸º: 30000 <code>runAsUser</code>ï¼‰</em></p>
<p><em>äºŒã€ä¸å…è®¸è¿›ç¨‹è·å¾—è¶…å‡ºå…¶çˆ¶è¿›ç¨‹çš„ç‰¹æƒï¼ˆç¦æ­¢ <code>allowPrivilegeEscalation</code>ï¼‰</em></p>
<p><em>ä¸‰ã€ä»¥åªè¯»æ–¹å¼åŠ è½½å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆå¯¹æ ¹æ–‡ä»¶çš„åªè¯»æƒé™<code>readOnlyRootFilesystem</code>ï¼‰</em></p>
<p>æ³¨æ„ç‚¹ï¼š</p>
<ol>
<li> <code>readOnlyRootFilesystem</code> å’Œ <code>allowPrivilegeEscalation</code> åªå­˜åœ¨äº<code>SecurityContext</code>ä¸­ï¼Œå› æ­¤éœ€è¦ä¸ºå„ä¸ªå®¹å™¨éƒ½é…ç½®ä¸Šï¼Œéœ€æ³¨æ„å®¹å™¨æ•°é‡ï¼Œé¿å…æ¼é…ï¼›</li>
<li><code>runAsUser</code> å­˜åœ¨äº<code>PodSecurityContext</code> å’Œ<code>SecurityContext</code>ä¸­ï¼Œå¯åªé… <code>PodSecurityContext</code></li>
</ol>
<h3 id="RuntimeClass"><a href="#RuntimeClass" class="headerlink" title="RuntimeClass"></a>RuntimeClass</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/containers/runtime-class/">https://kubernetes.io/docs/concepts/containers/runtime-class/</a></p>
</blockquote>
<ul>
<li>Create <code>RuntimeClass</code></li>
<li>Specify created <code>RuntimeClass</code> in <code>pod.spec.runtimeClassName</code></li>
</ul>
<h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/secret">https://kubernetes.io/docs/concepts/configuration/secret</a></p>
</blockquote>
<ul>
<li>Secret Type</li>
<li>Mount to a pod</li>
</ul>
<hr>
<blockquote>
<p>ç»ƒæ‰‹é€Ÿ<a target="_blank" rel="noopener" href="https://www.mrdadong.com/archives/cks-Secret">ã€æ¥æºã€‘</a></p>
</blockquote>
<ol>
<li><p>åœ¨ namespace <code>istio-system</code> ä¸­è·å–åä¸º <code>db1-test</code> çš„ç°æœ‰ secret çš„å†…å®¹ã€‚å°† username å­—æ®µå­˜å‚¨åœ¨åä¸º <code>/cks/sec/user.txt</code> çš„æ–‡ä»¶ä¸­ï¼Œå¹¶å°† password å­—æ®µå­˜å‚¨åœ¨åä¸º <code>/cks/sec/pass.txt</code> çš„æ–‡ä»¶ä¸­ã€‚</p>
<p><strong>æ³¨æ„ï¼šä½ å¿…é¡»åˆ›å»ºä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶ï¼Œä»–ä»¬è¿˜ä¸å­˜åœ¨ã€‚</strong></p>
<p><strong>æ³¨æ„ï¼šä¸è¦åœ¨ä»¥ä¸‹æ­¥éª¤ä¸­ä½¿ç”¨/ä¿®æ”¹å…ˆå‰åˆ›å»ºçš„æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„ä¸´æ—¶æ–‡ä»¶ã€‚</strong></p>
</li>
<li><p>åœ¨<code>istio-system</code> namespace ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <code>db2-test</code> çš„æ–° secretï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
</li>
</ol>
<ul>
<li><p>username : <code>production-instance</code></p>
</li>
<li><p>password : <code>KvLftKgs4aVH</code></p>
</li>
</ul>
<ol start="3">
<li>æœ€åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Podï¼Œå®ƒå¯ä»¥é€šè¿‡å·è®¿é—® secret <code>db2-test</code> </li>
</ol>
<ul>
<li><p>Pod åç§° <code>secret-pod</code></p>
</li>
<li><p>Namespace <code>istio-system</code></p>
</li>
<li><p>å®¹å™¨å <code>dev-container</code></p>
</li>
<li><p>é•œåƒ <code>nginx</code></p>
</li>
<li><p>å·å <code>secret-volume</code></p>
</li>
<li><p>æŒ‚è½½è·¯å¾„ <code>/etc/secret</code></p>
</li>
</ul>
<h3 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/service-accounts/">https://kubernetes.io/docs/concepts/security/service-accounts/</a></p>
</blockquote>
<ul>
<li>Prevent kubernetes from injecting credentials for a pod</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl explain sa.automountServiceAccountToken</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl explain pod.spec.automountServiceAccountToken</span></span><br></pre></td></tr></table></figure>

<p>Set one of fields above to <code>false</code> to prevent auto injection for a pod.</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/service-accounts/#enforce-mountable-secrets">Restrict access to Secrets</a><br>Set annotation <code>kubernetes.io/enforce-mountable-secrets</code> to <code>true</code> for a <code>ServiceAccount</code>, then only secrets in the field of <code>sa.secrets</code> of this ServiceAccount was allowed to use in a pod, such as a secret <code>volume,</code>  <code>envFrom</code>, <code>imagePullSecrets</code>.</p>
</li>
<li><p>How to use ServiceAccount to connect to apiserver? <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/run-application/access-api-from-pod">reference</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt --header &quot;Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&quot; -X GET https://kubernetes.default.svc/api/v1/namespaces/default/secrets</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">curl -k -XGET --header &quot;Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&quot;  https://kubernetes.default.svc/api/v1/namespaces/default/secrets</span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªkubeAPIServeræä¾›äº†ä¸‰ç±»API Resourceæ¥å£ï¼š</p>
<ul>
<li>core groupï¼šä¸»è¦åœ¨ <code>/api/v1</code> ä¸‹ï¼›</li>
<li>named groupsï¼šå…¶ path ä¸º <code>/apis/$GROUP/$VERSION</code>ï¼›</li>
<li>ç³»ç»ŸçŠ¶æ€çš„ä¸€äº› APIï¼šå¦‚<code>/metrics</code> ã€<code>/version</code> ç­‰ï¼›</li>
</ul>
<p>è€ŒAPIçš„URLå¤§è‡´ä»¥ <code>/apis/&#123;group&#125;/&#123;version&#125;/namespaces/&#123;namespace&#125;/&#123;resources&#125;/&#123;name&#125;</code> ç»„æˆï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://img2020.cnblogs.com/other/2041406/202101/2041406-20210120094608734-1433747602.png" alt="https://img2020.cnblogs.com/other/2041406/202101/2041406-20210120094608734-1433747602.png"></p>
<p>Tips:</p>
<p>åœ¨apiserverçš„URLä¸­ï¼Œèµ„æºéœ€è¦ç”¨å¤æ•°å½¢å¼ï¼Œå¦‚ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -k -H &quot;Authorization: Bearer $(cat /run/secrets/kubernetes.io/serviceaccount/token)&quot; \</span><br><span class="line">https://kubernetes.default.svc/api/v1/namespaces/default/pods/shs-dep-b56c568d6-n8h6d</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h3><p>How to use <code>etcdctl</code> to get raw data from etcd?</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert=/etc/kubernetes/pki/etcd/peer.crt \</span><br><span class="line">--key=/etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">get /registry/secrets/default -w=json | jq .</span><br></pre></td></tr></table></figure>

<h3 id="Upgrade-kubernetes-version"><a href="#Upgrade-kubernetes-version" class="headerlink" title="Upgrade kubernetes version"></a>Upgrade kubernetes version</h3><p>Follow these steps:</p>
<h4 id="for-master"><a href="#for-master" class="headerlink" title="for master"></a>for master</h4><ol>
<li><code>k drain controller-plane</code></li>
<li><code>apt-mark unhold kubeadm</code></li>
<li><code>apt-mark hold kubelet kubectl</code></li>
<li><code>apt update &amp;&amp; apt upgrade -y</code></li>
<li><code>kubeadm upgrade plan</code></li>
<li><code>kubeadm upgrade apply v1.2x.x</code></li>
<li><code>kubeadm upgrade plan(for check purpose)</code></li>
<li><code>apt-mark hold kubeadm</code></li>
<li><code>apt-mark unhold kubelet kubectl</code></li>
<li><code>apt install kubectl=1.2x.x kubelet=1.2x.x</code></li>
<li><code>apt-mark hold kubelet kubectl</code></li>
<li><code>systemctl restart kubelet</code></li>
<li><code>systemctl status kubelet</code></li>
<li><code>k uncordon controller-plane</code></li>
</ol>
<h4 id="for-node"><a href="#for-node" class="headerlink" title="for node"></a>for node</h4><ol>
<li><code>k drain node</code></li>
<li><code>apt update</code></li>
<li><code>apt-mark unhold kubeadm</code></li>
<li><code>apt-mark hold kubectl kubelet</code></li>
<li><code>apt install kubeadm=1.2x.x</code></li>
<li><code>kubeadm upgrade plan</code></li>
<li><code>kubeadm upgrade node</code></li>
<li><code>apt-mark hold kubeadm</code></li>
<li><code>apt-mark unhold kubectl kubelet</code></li>
<li><code>apt install kubectl=1.2x.x kubelet=1.2x.x</code></li>
<li><code>systemctl restart kubelet</code></li>
<li><code>systemctl status kubelet</code></li>
<li><code>k uncordon kubelet</code></li>
</ol>
<h4 id="check-upgrade-result"><a href="#check-upgrade-result" class="headerlink" title="check upgrade result"></a>check upgrade result</h4><ol>
<li><code>k get node</code></li>
</ol>
<h3 id="ImagePolicyWebhook"><a href="#ImagePolicyWebhook" class="headerlink" title="ImagePolicyWebhook"></a>ImagePolicyWebhook</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook</a></p>
</blockquote>
<h2 id="å®‰å…¨å·¥å…·ä½¿ç”¨"><a href="#å®‰å…¨å·¥å…·ä½¿ç”¨" class="headerlink" title="å®‰å…¨å·¥å…·ä½¿ç”¨"></a>å®‰å…¨å·¥å…·ä½¿ç”¨</h2><h3 id="kube-bench"><a href="#kube-bench" class="headerlink" title="kube-bench"></a>kube-bench</h3><p>A tool to detect potential security issues and give the specific means to solve the issue.</p>
<blockquote>
<p>Reference:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-bench/blob/main/docs/running.md">Running Method</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-bench">https://github.com/aquasecurity/kube-bench</a></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Simple way <span class="keyword">in</span> a kubernetes cluster created by kubeadm</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply \</span></span><br><span class="line"><span class="language-bash">    -f https://raw.githubusercontent.com/aquasecurity/kube-bench/main/job.yaml</span></span><br></pre></td></tr></table></figure>

<p>Contents<br>Consists of the following topics:</p>
<ul>
<li>master</li>
<li>etcd</li>
<li>controlplane</li>
<li>node</li>
<li>policies</li>
</ul>
<p>Each topic starts with a list of items which was checked with checked status,  then a list of remediations to FAIL or WARN items given. You can fix those issues under the given instructions. At last,  check summary of this topic.</p>
<p>Here is a output example for topic <code>master</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[WARN] 1.1.9 Ensure that the Container Network Interface file permissions are set to 600 or more restrictive (Manual)</span><br><span class="line">[WARN] 1.1.10 Ensure that the Container Network Interface file ownership is set to root:root (Manual)</span><br><span class="line"></span><br><span class="line">== Remediations master ==</span><br><span class="line">1.1.9 Run the below command (based on the file location on your system) on the control plane node.</span><br><span class="line">For example, chmod 600 &lt;path/to/cni/files&gt;</span><br><span class="line">1.1.10 Run the below command (based on the file location on your system) on the control plane node.</span><br><span class="line">For example,</span><br><span class="line">chown root:root &lt;path/to/cni/files&gt;</span><br><span class="line"></span><br><span class="line">== Summary master ==</span><br><span class="line">38 checks PASS</span><br><span class="line">9 checks FAIL</span><br><span class="line">13 checks WARN</span><br><span class="line">0 checks INFO</span><br></pre></td></tr></table></figure>

<p>Full contexts can be touch by <a href="">this link</a></p>
<h3 id="trivy"><a href="#trivy" class="headerlink" title="trivy"></a>trivy</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://github.com/aquasecurity/trivy">https://github.com/aquasecurity/trivy</a></p>
</blockquote>
<p>Scan a docker image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trivy image --severity LOW,MEDIUM ghcr.io/feiyudev/shs:latest</span><br></pre></td></tr></table></figure>

<p>æ‰«ææŸå‘½åç©ºé—´ä¸‹æ‰€æœ‰podæ‰€ä½¿ç”¨çš„é•œåƒåŒ…å« <code>HIGH, CRITICAL</code> ç±»å‹æ¼æ´ï¼Œå¹¶åˆ é™¤è¯¥pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k get pod -A -ojsonpath=&quot;&#123;range .items[*]&#125;&#123;.spec[&#x27;initContainers&#x27;,&#x27;containers&#x27;][*].image&#125; &#123;.metadata.name&#125; &#123;&#x27;#&#x27;&#125; &#123;end&#125;&quot; | sed &#x27;s|#|\n|g&#x27; | sed &#x27;s|^ ||g&#x27; | sed &#x27;s| $||g&#x27; | awk &#x27;&#123;cmd=&quot;echo &quot;$2&quot;; trivy -q image &quot;$1&quot; --severity HIGH,CRITICAL | grep Total&quot;;system(cmd)&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‘½ä»¤çš„æ³¨æ„ç‚¹ï¼š</p>
<ul>
<li><code>jsonpath</code> range</li>
<li><code>awk</code> system(cmd)</li>
<li><code>sed</code> replace</li>
</ul>
<h3 id="sysdig"><a href="#sysdig" class="headerlink" title="sysdig"></a>sysdig</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://github.com/draios/sysdig">https://github.com/draios/sysdig</a></p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=UJ4wVrbP-Q8">Video</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linhaostudy/p/17017114.html">Usage</a></li>
</ul>
<h4 id="Installation-Based-on-Ubuntu-22-04"><a href="#Installation-Based-on-Ubuntu-22-04" class="headerlink" title="Installation(Based on Ubuntu 22.04)"></a>Installation(Based on Ubuntu 22.04)</h4><ul>
<li>Download <code>deb</code> from <a target="_blank" rel="noopener" href="https://github.com/draios/sysdig/releases">sysdig-release</a></li>
<li><code>sudo dpkg -i sysdig-0.34.1-x86_64.deb</code></li>
<li><code>sudo apt -f install</code></li>
</ul>
<h4 id="Output-format"><a href="#Output-format" class="headerlink" title="Output format"></a>Output format</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%evt.num %evt.outputtime %evt.cpu %proc.name (%thread.tid) %evt.dir %evt.type %evt.info</span><br><span class="line">173884 15:06:10.075401786 7 sudo (1453517.1453517) &gt; read fd=9(&lt;f&gt;/dev/ptmx) size=65536</span><br></pre></td></tr></table></figure>

<p>Notes: </p>
<ol>
<li><code>evt.dir</code> aka event direction, &lt; represents out, &gt; represents in.</li>
<li><code>evt.type</code> aka event type, perceiving it as a name of system call.</li>
</ol>
<h4 id="Chisels"><a href="#Chisels" class="headerlink" title="Chisels"></a>Chisels</h4><p>predefined function sets based on sysdig events, to implements complex situation. Locates in <code>/usr/share/sysdig/chisels</code> on Linux machine. </p>
<p>What are those chisels?</p>
<ol>
<li>To see chisels.</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysdig -cl</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">sysdig --list-chisels</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>To use a chisel</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">See HTTP <span class="built_in">log</span></span></span><br><span class="line">sysdig -c httplog</span><br><span class="line">2024-01-25 23:06:16.423272777 &lt; method=GET url=:8080/health response_code=200 latency=0ms size=2B</span><br><span class="line">2024-01-25 23:06:16.423299653 &gt; method=GET url=:8080/health response_code=200 latency=0ms size=2B</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">See CPU usage ranking</span></span><br><span class="line">sysdig -c topprocs_cpu</span><br><span class="line"><span class="meta prompt_">CPU% </span><span class="language-bash">               Process             PID</span></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">8.01%               kube-apiserver      39124</span><br><span class="line">3.00%               kubelet             25007</span><br><span class="line">3.00%               etcd                1613</span><br><span class="line">2.00%               sysdig              102489</span><br><span class="line">2.00%               kube-controller     38957</span><br><span class="line">2.00%               calico-node         4705</span><br><span class="line">1.00%               containerd          874</span><br><span class="line">1.00%               vmtoolsd            790</span><br><span class="line">1.00%               kube-scheduler      39017</span><br><span class="line">0.00%               svlogd              2505</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Advanced usage about a chisel</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sysdig -i spy_file</span></span><br><span class="line"></span><br><span class="line">Category: I/O</span><br><span class="line">-------------</span><br><span class="line">spy_file        Echo any read/write made by any process to all files. Optionall</span><br><span class="line">                y, you can provide the name of one file to only intercept reads</span><br><span class="line">                /writes to that file.</span><br><span class="line"></span><br><span class="line">This chisel intercepts all reads and writes to all files. Instead of all files,</span><br><span class="line"> you can limit interception to one file.</span><br><span class="line">Args:</span><br><span class="line">[string] read_or_write - Specify &#x27;R&#x27; to capture only read event</span><br><span class="line">                s; &#x27;W&#x27; to capture only write events; &#x27;RW&#x27; to capture read and w</span><br><span class="line">                rite events. By default both read and write events are captured</span><br><span class="line">                .</span><br><span class="line">[string] spy_on_file_name - The name of the file which the chis</span><br><span class="line">                el should spy on for all read and write activity.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sysdig -c spy_file <span class="string">&quot;RW /root/spy_file_test.txt&quot;</span></span></span><br><span class="line">23:53:25.592303985 date(112109) W 32B /root/spy_file_test.txt</span><br><span class="line">Thu Jan 25 11:53:25 PM HKT 2024</span><br><span class="line"></span><br><span class="line">23:53:43.333152845 cat(112206) R 32B /root/spy_file_test.txt</span><br><span class="line">Thu Jan 25 11:53:25 PM HKT 2024</span><br><span class="line"></span><br><span class="line">23:53:43.333166670 cat(112206) R 0B /root/spy_file_test.txt NULL</span><br><span class="line">23:53:51.856062624 date(112270) W 32B /root/spy_file_test.txt</span><br><span class="line">Thu Jan 25 11:53:51 PM HKT 2024</span><br><span class="line"></span><br><span class="line">23:53:56.965894638 cat(112307) R 64B /root/spy_file_test.txt</span><br><span class="line">Thu Jan 25 11:53:25 PM HKT 2024</span><br><span class="line">Thu Jan 25 11:53:51 PM HKT 2024</span><br><span class="line"></span><br><span class="line">23:53:56.965902094 cat(112307) R 0B /root/spy_file_test.txt NULL</span><br></pre></td></tr></table></figure>

<h4 id="Usage-2"><a href="#Usage-2" class="headerlink" title="Usage"></a>Usage</h4><ol>
<li>Save events to a file</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -w test.scap</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Read events from a file while analyzing (by chisels)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -r test.scap -c httptop</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Specify the format to be used when printing the events<br>-p <output_format>, â€“print=<output_format><br> Specify the format to be used when printing the events.<br> With -pc or -pcontainer will use a container-friendly format.<br> With -pk or -pkubernetes will use a kubernetes-friendly format.<br> With -pm or -pmesos will use a mesos-friendly format.<br> See the examples section below for more info.</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -r test.scap -c httptop -pc</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Specify the number of events Sysdig should capture by passing it the -n flag. Once Sysdig captures the specified number of events, itâ€™ll automatically exit:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -n 5000 -w test.scap</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>Use the -C flag to configure Sysdig so that it breaks the capture into smaller files of a specified size.<br>The following example continuously saves events to files &lt; 10MB:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -C 10 -w test.scap</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>Specify the maximum number of files Sysdig should keep with the -W flag. For example, you can combine the -C and -W flags like so:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -C 10 -W 4 -w test.scap</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>You can analyze the processes running in the WordPress container with:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysdig -pc -c topprocs_cpu container.name=wordpress-sysdig_wordpress_1</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>-M <num_seconds>   Stop collecting after <num_seconds> reached.</li>
</ol>
<h4 id="Help"><a href="#Help" class="headerlink" title="Help"></a>Help</h4><p>å…³äºfilterå¯ç”¨çš„å­—æ®µï¼Œå¯ä»¥é€šè¿‡<code>sysdig -l</code>æ¥æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„å­—æ®µã€‚ä¾‹å¦‚æŸ¥çœ‹å®¹å™¨ç›¸å…³çš„è¿‡æ»¤å­—æ®µï¼Œæœ‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@primary:~$ sysdig -l | grep &quot;^container.&quot;</span><br><span class="line">container.id                  The truncated container ID (first 12 characters), e.g. 3ad7b26ded6d is extracted from the</span><br><span class="line">container.full_id             The full container ID, e.g.</span><br><span class="line">container.name                The container name. In instances of userspace container engine lookup delays, this field</span><br><span class="line">container.image               The container image name (e.g. falcosecurity/falco:latest for docker). In instances of</span><br><span class="line">container.image.id            The container image id (e.g. 6f7e2741b66b). In instances of userspace container engine</span><br><span class="line">container.type                The container type, e.g. docker, cri-o, containerd etc.</span><br><span class="line">container.privileged          &#x27;true&#x27; for containers running as privileged, &#x27;false&#x27; otherwise. In instances of userspace</span><br><span class="line">container.mounts              A space-separated list of mount information. Each item in the list has the format</span><br><span class="line">container.mount               (ARG_REQUIRED) Information about a single mount, specified by number (e.g.</span><br><span class="line">container.mount.source        (ARG_REQUIRED) The mount source, specified by number (e.g. container.mount.source[0]) or</span><br><span class="line">container.mount.dest          (ARG_REQUIRED) The mount destination, specified by number (e.g. container.mount.dest[0])</span><br><span class="line">container.mount.mode          (ARG_REQUIRED) The mount mode, specified by number (e.g. container.mount.mode[0]) or</span><br><span class="line">container.mount.rdwr          (ARG_REQUIRED) The mount rdwr value, specified by number (e.g. container.mount.rdwr[0])</span><br><span class="line">container.mount.propagation   (ARG_REQUIRED) The mount propagation value, specified by number (e.g.</span><br><span class="line">container.image.repository    The container image repository (e.g. falcosecurity/falco). In instances of userspace</span><br><span class="line">container.image.tag           The container image tag (e.g. stable, latest). In instances of userspace container engine</span><br><span class="line">container.image.digest        The container image registry digest (e.g.</span><br><span class="line">container.healthcheck         The container&#x27;s health check. Will be the null value (&quot;N/A&quot;) if no healthcheck</span><br><span class="line">container.liveness_probe      The container&#x27;s liveness probe. Will be the null value (&quot;N/A&quot;) if no liveness probe</span><br><span class="line">container.readiness_probe     The container&#x27;s readiness probe. Will be the null value (&quot;N/A&quot;) if no readiness probe</span><br><span class="line">container.start_ts            Container start as epoch timestamp in nanoseconds based on proc.pidns_init_start_ts and</span><br><span class="line">container.duration            Number of nanoseconds since container.start_ts.</span><br><span class="line">container.ip                  The container&#x27;s / pod&#x27;s primary ip address as retrieved from the container engine. Only</span><br><span class="line">container.cni.json            The container&#x27;s / pod&#x27;s CNI result field from the respective pod status info. It contains</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œ<code>container.id</code>åªèƒ½å–å‰12ä¸ªå­—ç¬¦ï¼Œå¦å¤–ä¹Ÿå¯ä»¥ç”¨å®¹å™¨idçš„å…¨åï¼Œå³<code>container.full_id</code>ã€‚å¦å¤–k8så¯æ”¯æŒçš„å­—æ®µæœ‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@primary:~$ sysdig -l | grep &quot;^k8s.&quot;</span><br><span class="line">k8s.ns.name                   The Kubernetes namespace name. This field is extracted from the container runtime socket</span><br><span class="line">k8s.pod.name                  The Kubernetes pod name. This field is extracted from the container runtime socket</span><br><span class="line">k8s.pod.id                    [LEGACY] The Kubernetes pod UID, e.g. 3e41dc6b-08a8-44db-bc2a-3724b18ab19a. This legacy</span><br><span class="line">k8s.pod.uid                   The Kubernetes pod UID, e.g. 3e41dc6b-08a8-44db-bc2a-3724b18ab19a. Note that the pod UID</span><br><span class="line">k8s.pod.sandbox_id            The truncated Kubernetes pod sandbox ID (first 12 characters), e.g 63060edc2d3a. The</span><br><span class="line">k8s.pod.full_sandbox_id       The full Kubernetes pod / sandbox ID, e.g</span><br><span class="line">k8s.pod.label                 (ARG_REQUIRED) The Kubernetes pod label. The label can be accessed either with the</span><br><span class="line">k8s.pod.labels                The Kubernetes pod comma-separated key/value labels. E.g. &#x27;foo1:bar1,foo2:bar2&#x27;. This</span><br><span class="line">k8s.pod.ip                    The Kubernetes pod ip, same as container.ip field as each container in a pod shares the</span><br><span class="line">k8s.pod.cni.json              The Kubernetes pod CNI result field from the respective pod status info, same as</span><br></pre></td></tr></table></figure>

<h4 id="Traps"><a href="#Traps" class="headerlink" title="Traps"></a>Traps</h4><blockquote>
<p>æ­¤å¤„æœ‰å‘</p>
</blockquote>
<p>ä½¿ç”¨<code>container.id</code>è¿‡æ»¤æ—¶ï¼Œæ³¨æ„idçš„é•¿åº¦éœ€è¦ä¸º<code>12</code>ï¼Œä¸ç„¶æ•°æ®å‡ºä¸æ¥ã€‚é€šè¿‡<code>crictl ps</code>çœ‹åˆ°çš„<code>container id</code>æ˜¯<strong>13</strong>ä½çš„ï¼Œä½¿ç”¨sysdigæ—¶ï¼Œéœ€è¦æ³¨æ„é•¿åº¦ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@primary:~$ crictl ps | grep -v ^C | awk &#x27;&#123;print $1,$2,$6,$7&#125;&#x27;</span><br><span class="line">0fd88042f1ddf 848c5b919e8d3 Running calico-apiserver</span><br><span class="line">ad81cac0dbf9e 848c5b919e8d3 Running calico-apiserver</span><br><span class="line">f6d6b81c75f69 4e87edec0297d Running calico-kube-controllers</span><br><span class="line">87c4fbddeb123 d36ef67f7b24c Running csi-node-driver-registrar</span><br><span class="line">46095b3ea4bf6 91c1c91da7602 Running calico-csi</span><br><span class="line">51e65353815dc cbb01a7bd410d Running coredns</span><br><span class="line">7fc6f4ad4aafa cbb01a7bd410d Running coredns</span><br><span class="line">de42d610f5530 1843802b91be8 Running calico-node</span><br><span class="line">21ae9adf53e47 b33768e0da1f8 Running calico-typha</span><br><span class="line">a2f7701ceae6c 7bc79e0d3be4f Running tigera-operator</span><br><span class="line">d91edc95d2edf 9344fce2372f8 Running kube-proxy</span><br><span class="line">5f7d85179ade0 6fc5e6b7218c7 Running kube-scheduler</span><br><span class="line">d40dd28cc171c 138fb5a3a2e34 Running kube-controller-manager</span><br><span class="line">c71d33c5aea6e 8a9000f98a528 Running kube-apiserver</span><br><span class="line">0cdeff9542f15 a0eed15eed449 Running etcd</span><br></pre></td></tr></table></figure>

<h3 id="falco"><a href="#falco" class="headerlink" title="falco"></a>falco</h3><blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://falco.org/docs">https://falco.org/docs</a></p>
</blockquote>
<h3 id="strace"><a href="#strace" class="headerlink" title="strace"></a>strace</h3><p>ç›‘æ§<u>è¿›ç¨‹</u>çš„<strong>ç³»ç»Ÿè°ƒç”¨</strong>å’Œ<strong>ä¿¡å·é‡</strong>ï¼ŒåŸºç¡€çš„ä½¿ç”¨æ–¹å¼</p>
<ol>
<li>ç›‘å¬æŸä¸ªå·²å­˜åœ¨çš„è¿›ç¨‹ <code>strace -p &lt;pid&gt;</code></li>
<li>ç›´æ¥å¯åŠ¨ä¸€ä¸ªäºŒè¿›åˆ¶ <code>strace &lt;binary-name&gt;</code></li>
<li>å¯¹è¾“å‡ºç»“æœè¿›è¡Œè¿‡æ»¤ <code>strace -e trace=file</code></li>
</ol>
<h2 id="è€ƒè¯•è¯´æ˜ä¹¦"><a href="#è€ƒè¯•è¯´æ˜ä¹¦" class="headerlink" title="è€ƒè¯•è¯´æ˜ä¹¦"></a>è€ƒè¯•è¯´æ˜ä¹¦</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.linuxfoundation.org/tc-docs/certification/important-instructions-cks">Handbook of CKS exam</a></p>
</blockquote>
<p>Requirments of your computer, microphone, camera, speaker, etc.</p>
<blockquote>
<p>Donâ€™t use headphone, earbuds.</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://helpdesk.psionline.com/hc/en-gb/articles/4409608794260-PSI-Bridge-Platform-System-Requirements">[PSI Bridge FAQ] System Requirements</a> </li>
<li><a target="_blank" rel="noopener" href="https://docs.linuxfoundation.org/tc-docs/certification/important-instructions-cks#system-requirements-to-take-the-exam">System Requirements to take the exam</a></li>
<li>Browser recommand Google Chrome</li>
</ul>
<p>Exam Details</p>
<p>Online tests, <strong>15-20</strong> performance-based tasks, <strong>2 hours</strong> to complete the tasks.</p>
<p>Donâ€™t cheat, audio,camera,screen capture of the test will be reviewed.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-26T02:55:51.382Z" title="6/26/2023, 10:55:51 AM">2023-06-26</time>å‘è¡¨</span><span class="level-item"><time dateTime="2023-06-26T02:55:51.382Z" title="6/26/2023, 10:55:51 AM">2023-06-26</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/%E5%B7%A5%E5%85%B7/">å·¥å…·</a></span><span class="level-item">6 åˆ†é’Ÿè¯»å®Œ (å¤§çº¦910ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/26/dee71ca0ecee.html">åˆ©ç”¨OpenWrtä¸ºè™šæ‹Ÿæœºåšæµé‡ä»£ç†</a></h1><div class="content"><h2 id="å®‰è£…Openwrtè™šæ‹Ÿæœº"><a href="#å®‰è£…Openwrtè™šæ‹Ÿæœº" class="headerlink" title="å®‰è£…Openwrtè™šæ‹Ÿæœº"></a>å®‰è£…Openwrtè™šæ‹Ÿæœº</h2><p>ä¸‹è½½é•œåƒï¼š<a target="_blank" rel="noopener" href="https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/">Index of /releases/22.03.5/targets/x86/64/ (openwrt.org)</a></p>
<p>è½¬æ¢é•œåƒï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert -f raw -O vdi openwrt-22.03.5-x86-64-generic-ext4-combined-efi.img openwrt-22.03.5-x86-64-generic-ext4-combined-efi.img.vdi</span><br></pre></td></tr></table></figure>

<p>é…ç½®è™šæ‹Ÿæœºç½‘å¡ï¼š</p>
<ol>
<li><p>åœ¨VirtualBoxä¸­æ–°å»ºHostNetworkï¼ˆHost-Onlyç½‘ç»œï¼‰ï¼Œç½‘æ®µä¸º<code>192.168.56.0/24</code></p>
<p>  <img src="/images/pics/SbXZGH.png"></p>
</li>
<li><p>åœ¨openwrtè™šæ‹Ÿæœºçš„ç½‘ç»œé€‰é¡¹ä¸­è®¾ç½®ï¼š</p>
<p>  1ï¼‰å¯ç”¨<code>ç½‘å¡1</code>ï¼Œè¿æ¥æ–¹å¼é€‰<code>ä»…ä¸»æœºç½‘ç»œ</code>ï¼Œåç§°é€‰ä¸Šæ­¥åˆ›å»ºçš„<code>HostNetwork</code></p>
<p>  <img src="/images/pics/tsfpEu.png"></p>
<p>  2ï¼‰å¯ç”¨<code>ç½‘å¡2</code>ï¼Œè¿æ¥æ–¹å¼é€‰<code>æ¡¥æ¥</code>ç½‘å¡ï¼Œåç§°é€‰<code>æœ¬æœºä¸Šèƒ½è®¿é—®å¤–ç½‘çš„ç½‘å¡</code></p>
<p>  <img src="/images/pics/RiQaah.png"></p>
</li>
<li><p>  è¿›å…¥openwrtè™šæ‹Ÿæœºï¼Œä¸ºlanå£è®¾ç½®é™æ€IPåœ°å€ä¸º<code>HostNetwork</code>ä¸­çš„ä¸€ä¸ªIPï¼Œè¿™é‡Œç”¨ <code>192.168.56.2</code></p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># cat /etc/config/network</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;loopback&#x27;</span></span><br><span class="line">	option device <span class="string">&#x27;lo&#x27;</span></span><br><span class="line">	option proto <span class="string">&#x27;static&#x27;</span></span><br><span class="line">	option ipaddr <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">	option netmask <span class="string">&#x27;255.0.0.0&#x27;</span></span><br><span class="line"></span><br><span class="line">config globals <span class="string">&#x27;globals&#x27;</span></span><br><span class="line">	option ula_prefix <span class="string">&#x27;fdd4:bccc:9ebb::/48&#x27;</span></span><br><span class="line"></span><br><span class="line">config device</span><br><span class="line">	option name <span class="string">&#x27;br-lan&#x27;</span></span><br><span class="line">	option <span class="built_in">type</span> <span class="string">&#x27;bridge&#x27;</span></span><br><span class="line">	list ports <span class="string">&#x27;eth0&#x27;</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;lan&#x27;</span></span><br><span class="line">	option device <span class="string">&#x27;br-lan&#x27;</span></span><br><span class="line">	option proto <span class="string">&#x27;static&#x27;</span></span><br><span class="line">	option ipaddr <span class="string">&#x27;192.168.56.2&#x27;</span></span><br><span class="line">	option netmask <span class="string">&#x27;255.255.255.0&#x27;</span></span><br><span class="line">	option ip6assign <span class="string">&#x27;60&#x27;</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;wan&#x27;</span></span><br><span class="line">	option device <span class="string">&#x27;eth1&#x27;</span></span><br><span class="line">	option proto <span class="string">&#x27;dhcp&#x27;</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;wan6&#x27;</span></span><br><span class="line">	option device <span class="string">&#x27;eth1&#x27;</span></span><br><span class="line">	option proto <span class="string">&#x27;dhcpv6&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="OPENWRTå¼€å¯SFTPï¼Œå®ç°æ–‡ä»¶ä¸‹è½½ä¸Šä¼ "><a href="#OPENWRTå¼€å¯SFTPï¼Œå®ç°æ–‡ä»¶ä¸‹è½½ä¸Šä¼ " class="headerlink" title="OPENWRTå¼€å¯SFTPï¼Œå®ç°æ–‡ä»¶ä¸‹è½½ä¸Šä¼ "></a>OPENWRTå¼€å¯SFTPï¼Œå®ç°æ–‡ä»¶ä¸‹è½½ä¸Šä¼ </h2><p>åŒæ—¶ä¹Ÿèƒ½ä½¿ç”¨<code>scp</code>å‘½ä»¤è¿›è¡Œæ‹·è´</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install vsftpd openssh-sftp-server</span><br><span class="line">/etc/init.d/vsftpd enable</span><br><span class="line">/etc/init.d/vsftpd start</span><br></pre></td></tr></table></figure>

<h2 id="OpenClashå®‰è£…ä¸é…ç½®"><a href="#OpenClashå®‰è£…ä¸é…ç½®" class="headerlink" title="OpenClashå®‰è£…ä¸é…ç½®"></a>OpenClashå®‰è£…ä¸é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#iptables</span></span><br><span class="line">opkg update</span><br><span class="line">opkg install coreutils-nohup bash iptables dnsmasq-full curl ca-certificates ipset ip-full iptables-mod-tproxy iptables-mod-extra libcap libcap-bin ruby ruby-yaml kmod-tun kmod-inet-diag unzip luci-compat luci luci-base</span><br></pre></td></tr></table></figure>

<p>å¦‚æœéœ€è¦å¼ºåˆ¶å®‰è£…ï¼Œå¯ä»¥å…ˆ<code>opkg remove</code>ï¼Œå†<code>opkg install</code>ã€‚</p>
<p>åœ¨<a target="_blank" rel="noopener" href="https://github.com/vernesong/OpenClash/releases">Releases Â· vernesong/OpenClash (github.com)</a>é¡µé¢ï¼Œå°†openclashå®‰è£…åŒ…ä¸‹è½½åˆ°openwrtè™šæ‹Ÿæœºä¸­ï¼Œé€šè¿‡ <code>opkg install</code> å®‰è£…ã€‚</p>
<p>é…ç½®æ‰‹å†Œï¼š<a target="_blank" rel="noopener" href="https://github.com/vernesong/OpenClash/wiki">Home Â· vernesong/OpenClash Wiki (github.com)</a></p>
<h2 id="å…¶ä»–è™šæ‹Ÿæœºçš„æ—è·¯ç”±é…ç½®"><a href="#å…¶ä»–è™šæ‹Ÿæœºçš„æ—è·¯ç”±é…ç½®" class="headerlink" title="å…¶ä»–è™šæ‹Ÿæœºçš„æ—è·¯ç”±é…ç½®"></a>å…¶ä»–è™šæ‹Ÿæœºçš„æ—è·¯ç”±é…ç½®</h2><p>æ­¤å¤„ç”¨çš„æ˜¯ubuntu serverï¼Œå¯ä»¥åœ¨å®‰è£…ç•Œé¢æ—¶è®¾ç½®ï¼Œä¹Ÿå¯ä»¥ç­‰å®‰è£…å®Œæˆåï¼Œæ‰‹åŠ¨ä¿®æ”¹é…ç½®ã€‚æ‰‹åŠ¨ä¿®æ”¹çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/netplan/00-installer-config.yaml</span><br><span class="line"><span class="comment"># This is the network config written by &#x27;subiquity&#x27;</span></span><br><span class="line">network:</span><br><span class="line">  ethernets:</span><br><span class="line">    enp0s3:</span><br><span class="line">      addresses:</span><br><span class="line">      - 192.168.56.3/24</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses:</span><br><span class="line">        - 114.114.114.114</span><br><span class="line">        search: []</span><br><span class="line">      routes:</span><br><span class="line">      - to: default</span><br><span class="line">        via: 192.168.56.2</span><br><span class="line">  version: 2</span><br></pre></td></tr></table></figure>

<p>é…ç½®ä¿®æ”¹åï¼Œå¯ä»¥çœ‹åˆ°é»˜è®¤è·¯ç”±å·²å˜æˆ <code>192.168.56.2</code>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ip route</span><br><span class="line">default via 192.168.56.2 dev enp0s3 proto static</span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown</span><br><span class="line">192.168.56.0/24 dev enp0s3 proto kernel scope link src 192.168.56.3</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/peiyake/OpenWrt/blob/master/%E5%88%A9%E7%94%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%89%E8%A3%85X86%E4%B9%8BOpenWrt.md">OpenWrt/åˆ©ç”¨è™šæ‹Ÿæœºå®‰è£…X86ä¹‹OpenWrt.md at master Â· peiyake/OpenWrt Â· GitHub</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://blog.51cto.com/linhong/5732213?u_atoken=b1dfb976-4d17-480c-9e72-21b2e268125c&u_asession=01Zgb-7A1LJgNfIsZ6SBoHApYOmNdmMagWKG_cVkzggQ9OPfEANhgRG6KbJeehsF0OX0KNBwm7Lovlpxjd_P_q4JsKWYrT3W_NKPr8w6oU7K8JOUVx0zGHY3UZmuDw1M44z93Gv091IdoFlCkcaxHIZGBkFo3NEHBv0PZUm6pbxQU&u_asig=05jbnufJzzl_zFfBjk7-M9al3uZYxUoDisE7G6G1moNNOZrOVXjw99WcjSIUhuuZMv5_LWGHRaWbCZF__xR3I_uAb88AMVBRgUwJtOyAtv8P7E3Ot1Vul_NI1YtOGuqF2r3lI4pfoKRiCqpFymhSG6cTB9VaxOkhgX5yDVfv4JVwb9JS7q8ZD7Xtz2Ly-b0kmuyAKRFSVJkkdwVUnyHAIJzdU6bOLR3imc2qYkb7-r3jSGLAs8vppC-uwpaylREQ2jIZvi_fHA0gZ5NR9OtWDag-3h9VXwMyh6PgyDIVSG1W8_f_100H14AIJGfb4dxLkFj7fGLiguhfvrRmLpZQrmWsonxVoSsce7wLOWDU_1h8bOwtAvCqOJkmDhcbtBvzTdmWspDxyAEEo4kbsryBKb9Q&u_aref=4OwndGGPcd7GrKOKOYzCaiu7UwM=">VMware Workstationå®‰è£…è½¯è·¯ç”±OpenWrt_æ—é¸¿é£é‡‡çš„æŠ€æœ¯åšå®¢_51CTOåšå®¢</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/352119348">VirtualBoxè™šæ‹Ÿæœºå®‰è£…openwrtä¾›æœ¬æœºä½¿ç”¨ - çŸ¥ä¹ (zhihu.com)</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://blog.csdn.net/w946612410/article/details/113997146">VMwareå®‰è£…OpenWrtè®©å®¿ä¸»æœºä¸Šç½‘&amp;æ—è·¯ç”±ï¼ˆä¸¤ç§æ–¹æ¡ˆï¼‰_vmware openwrtæ—è·¯ç”±_agloçš„åšå®¢-CSDNåšå®¢</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/334419721">å¦‚ä½•åœ¨vmwareè™šæ‹Ÿæœºä¸­å®‰è£…OpenWrtç³»ç»Ÿï¼Ÿ - çŸ¥ä¹ (zhihu.com)</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://open.toutiao.com/a6951804532821115425/?utm_source=vivoliulanqi&utm_medium=webview&utm_campaign=open&label=related_news&item_id=6951804532821115425&gy=15d46571dc484c3e19063c7fcea60edb1164a6df680e4273fe3c93dc0a6be0bcb0ada9ce3d308ad36b9971e32292e6e8459cedbaf8be1611d2e7ea18469dbeb5b39eedea53b77527817f665ec4fb0653ea354af990a4802de57f2c70111b7028b593f4eff9ba863c654d354c2565d4b6fe4784a0e35ef371325958ec95f33&fr=normal&isRelated=1&isNews=1&req_id=202106161014310102121441550F4825EE&vivoRcdMark=1&from_gid=6945021964322980390&channel_id=88805669586">è½¯è·¯ç”±OpenWrt X86è½¯è·¯ç”±å®‰è£… (toutiao.com)</a></p>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-12T07:12:22.446Z" title="6/12/2023, 3:12:22 PM">2023-06-12</time>å‘è¡¨</span><span class="level-item"><time dateTime="2023-06-12T07:12:22.446Z" title="6/12/2023, 3:12:22 PM">2023-06-12</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/%E5%B7%A5%E5%85%B7/">å·¥å…·</a></span><span class="level-item">2 åˆ†é’Ÿè¯»å®Œ (å¤§çº¦229ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/12/916fff7d458d.html">Git æ“ä½œåŠåŸç†</a></h1><div class="content"><h2 id="Git-Diff-çš„å·¥ä½œåŸç†"><a href="#Git-Diff-çš„å·¥ä½œåŸç†" class="headerlink" title="Git Diff çš„å·¥ä½œåŸç†"></a>Git Diff çš„å·¥ä½œåŸç†</h2><p><a target="_blank" rel="noopener" href="https://chenshinan.github.io/2019/05/02/git%E7%94%9F%E6%88%90diff%E5%8E%9F%E7%90%86%EF%BC%9AMyers%E5%B7%AE%E5%88%86%E7%AE%97%E6%B3%95/">Myerså·®åˆ†ç®—æ³•</a></p>
<h2 id="åˆ›å»ºåŸºäºæŸä¸ª-commit-id-çš„åˆ†æ”¯"><a href="#åˆ›å»ºåŸºäºæŸä¸ª-commit-id-çš„åˆ†æ”¯" class="headerlink" title="åˆ›å»ºåŸºäºæŸä¸ª commit id çš„åˆ†æ”¯"></a>åˆ›å»ºåŸºäºæŸä¸ª commit id çš„åˆ†æ”¯</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b dev c99d6500</span><br></pre></td></tr></table></figure>

<h2 id="æŸ¥çœ‹æŒ‡å®šåˆ†æ”¯çš„æäº¤"><a href="#æŸ¥çœ‹æŒ‡å®šåˆ†æ”¯çš„æäº¤" class="headerlink" title="æŸ¥çœ‹æŒ‡å®šåˆ†æ”¯çš„æäº¤"></a>æŸ¥çœ‹æŒ‡å®šåˆ†æ”¯çš„æäº¤</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git log master</span><br><span class="line">git config --global alias.nicelog &quot;log --graph --abbrev-commit --pretty=format:&#x27;%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&#x27;&quot;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="/images/pics/seWuLx.png"></p>
<h2 id="git-å¦‚ä½•å­˜å‚¨"><a href="#git-å¦‚ä½•å­˜å‚¨" class="headerlink" title="git å¦‚ä½•å­˜å‚¨"></a>git å¦‚ä½•å­˜å‚¨</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tonybai.com/2020/04/07/illustrated-tale-of-git-internal-key-concepts/">å›¾è§£gitåŸç†çš„å‡ ä¸ªå…³é”®æ¦‚å¿µ</a></li>
</ul>
<h2 id="git-å¦‚ä½•-merge"><a href="#git-å¦‚ä½•-merge" class="headerlink" title="git å¦‚ä½• merge"></a>git å¦‚ä½• merge</h2><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000021712743">git mergeçš„åŸç†ï¼ˆé€’å½’ä¸‰è·¯åˆå¹¶ç®—æ³•ï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904175508127751">å½“æˆ‘ä»¬git-mergeçš„æ—¶å€™åˆ°åº•åœ¨mergeä»€ä¹ˆ.</a></li>
</ul>
<h2 id="git-å¦‚ä½•-rebase"><a href="#git-å¦‚ä½•-rebase" class="headerlink" title="git å¦‚ä½• rebase"></a>git å¦‚ä½• rebase</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/AhuntSun-blog/p/12732946.html">Gitåº”ç”¨è¯¦è§£ç¬¬ä¹è®²ï¼šGit cherry-pickä¸Git rebase</a></li>
</ul>
<h2 id="æ˜¯å¦èƒ½-cherry-pick-æ‰€æœ‰çš„-commit"><a href="#æ˜¯å¦èƒ½-cherry-pick-æ‰€æœ‰çš„-commit" class="headerlink" title="æ˜¯å¦èƒ½ cherry-pick æ‰€æœ‰çš„ commit"></a>æ˜¯å¦èƒ½ cherry-pick æ‰€æœ‰çš„ commit</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/AhuntSun-blog/p/12732946.html">Gitåº”ç”¨è¯¦è§£ç¬¬ä¹è®²ï¼šGit cherry-pickä¸Git rebase</a></li>
</ul>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">ä¸Šä¸€é¡µ</a></div><div class="pagination-next"><a href="/page/2/">ä¸‹ä¸€é¡µ</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/26/">26</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">å½’æ¡£</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">åäºŒæœˆ 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">äºŒæœˆ 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">ä¸€æœˆ 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">å…­æœˆ 2023</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">äºŒæœˆ 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">ä¸€æœˆ 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">åæœˆ 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">å…«æœˆ 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">ä¸ƒæœˆ 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">å…­æœˆ 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">äº”æœˆ 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">å››æœˆ 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">ä¸‰æœˆ 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">åæœˆ 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">å…«æœˆ 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">ä¸ƒæœˆ 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">å…­æœˆ 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">äº”æœˆ 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">å››æœˆ 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">åä¸€æœˆ 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">åæœˆ 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">ä¹æœˆ 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">å…«æœˆ 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">ä¸ƒæœˆ 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">å…­æœˆ 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">äº”æœˆ 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">å››æœˆ 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">ä¸‰æœˆ 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">äºŒæœˆ 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">ä¸€æœˆ 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">åäºŒæœˆ 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">åä¸€æœˆ 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">åæœˆ 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">å…«æœˆ 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">ä¸ƒæœˆ 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">å…­æœˆ 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">äº”æœˆ 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">å››æœˆ 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">ä¸‰æœˆ 2019</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">äºŒæœˆ 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">ä¸€æœˆ 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">åäºŒæœˆ 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">åä¸€æœˆ 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">ä¹æœˆ 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">å…«æœˆ 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">ä¸ƒæœˆ 2018</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">å…­æœˆ 2018</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">äº”æœˆ 2018</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">å››æœˆ 2018</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">ä¸‰æœˆ 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">äºŒæœˆ 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">ä¸€æœˆ 2018</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">åäºŒæœˆ 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">åæœˆ 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">ä¹æœˆ 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">ä¸‰æœˆ 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">ä¸€æœˆ 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">åäºŒæœˆ 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">æœ€æ–°æ–‡ç« </h3><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/249b2dc63505.html"><img src="/images/pics/5300c911560a8d2e0d745dcaf025d22f.jpg" alt="Mç³»åˆ—MacBookè¿æ¥l2tpæ—¶å¤±è´¥çš„é—®é¢˜ä¿®å¤"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/249b2dc63505.html">Mç³»åˆ—MacBookè¿æ¥l2tpæ—¶å¤±è´¥çš„é—®é¢˜ä¿®å¤</a></p><p class="categories"><a href="/categories/macOS/">macOS</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/e9036e8500f6.html"><img src="/images/thumbnails/rust-lang.png" alt="Rustå­¦ä¹ ç¬”è®°"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/e9036e8500f6.html">Rustå­¦ä¹ ç¬”è®°</a></p><p class="categories"><a href="/categories/Rust/">Rust</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/4948e86c1262.html"><img src="/images/pics/DrRvr9.jpg" alt="Calicoè¯ä¹¦å­¦ä¹ ç¬”è®°"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/4948e86c1262.html">Calicoè¯ä¹¦å­¦ä¹ ç¬”è®°</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/6dae87e31dc3.html"><img src="/images/pics/e9f22d889a230bfda8e24c0a981740a8.png" alt="å¦‚ä½•åœ¨YAMLæ–‡ä»¶ä¸­è¿›è¡Œä¼˜é›…åœ°æ¢è¡Œ"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/6dae87e31dc3.html">å¦‚ä½•åœ¨YAMLæ–‡ä»¶ä¸­è¿›è¡Œä¼˜é›…åœ°æ¢è¡Œ</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2024/12/09/25470f32f4bb.html"><img src="/images/pics/kubernetes-cka-color.svg" alt="CKSè¯ä¹¦å­¦ä¹ èµ„æ–™æ±‡ç¼–"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-12-08T16:00:00.000Z">2024-12-09</time></p><p class="title"><a href="/2024/12/09/25470f32f4bb.html">CKSè¯ä¹¦å­¦ä¹ èµ„æ–™æ±‡ç¼–</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">é“¾æ¥</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://crisfang.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Cris</span></span><span class="level-right"><span class="level-item tag">crisfang.com</span></span></a></li><li><a class="level is-mobile" href="https://sanyuesha.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">ä¸‰æœˆæ²™</span></span><span class="level-right"><span class="level-item tag">sanyuesha.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/pics/d261cdb6203e0da42ae1324dd3aae11f.png" alt="é‡å¯»ç¬”è®°" height="28"></a><p class="is-size-7"><span>&copy; 2024 é‡å¯»</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">å…±<span id="busuanzi_value_site_uv">0</span>ä¸ªè®¿å®¢</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="To Find Me" href="https://github.com/eucham"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/eucham"><i class="fab fa-linkedin"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="å›åˆ°é¡¶ç«¯" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ...","untitled":"(æ— æ ‡é¢˜)","posts":"æ–‡ç« ","pages":"é¡µé¢","categories":"åˆ†ç±»","tags":"æ ‡ç­¾"});
        });</script></body></html>